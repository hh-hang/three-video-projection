import{B as Xt,M as ie,l as ke,b as U,L as ne,m as pl,n as _e,T as hs,p as nA,D as El,R as Il,q as rA,s as Co,t as oA,u as aA,v as yl,w as lA,x as qe,y as tr,z as Cl,C as Sl,E as Tl,H as Bl,I as cA,J as hA,K as AA,Q as xl,U as Os,X as Us,Y as vl,Z as uA,$ as Ll,a0 as Dl,a1 as dA,G as Rl,a2 as fA,a3 as So,a4 as gA,a5 as mA,a6 as pA,a7 as EA,a8 as IA,a9 as yA,aa as CA,ab as SA,ac as TA,ad as bl,ae as Hi,af as wl,ag as To,ah as Bo,ai as er,aj as sr,ak as BA,al as xA,am as vA,an as LA,ao as xo,ap as vo,aq as ir,ar as An,as as ki,at as DA,au as RA,av as bA,aw as wA,ax as kl,ay as _l,az as nr,aA as Fs,aB as Qs,aC as ds,aD as et,aE as Ve,aF as Pl,aG as Fl,aH as Ns,aI as kA,aJ as _A,aK as PA,aL as Lo,aM as FA,aN as QA,aO as MA,aP as OA,d as UA,S as NA,o as GA,W as KA,aQ as $A,a as HA,O as VA,aR as YA,A as qA,V as WA,c as JA,e as jA,f as XA,g as zA,h as ft,aS as ZA,F as tu,r as eu,_ as su,j as iu,k as nu}from"./_plugin-vue_export-helper-C8mOoXWg.js";const K=Number.isFinite||function(o){return typeof o=="number"&&isFinite(o)},ru=Number.isSafeInteger||function(o){return typeof o=="number"&&Math.abs(o)<=ou},ou=Number.MAX_SAFE_INTEGER||9007199254740991;let V=(function(o){return o.NETWORK_ERROR="networkError",o.MEDIA_ERROR="mediaError",o.KEY_SYSTEM_ERROR="keySystemError",o.MUX_ERROR="muxError",o.OTHER_ERROR="otherError",o})({}),w=(function(o){return o.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",o.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",o.KEY_SYSTEM_NO_SESSION="keySystemNoSession",o.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",o.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",o.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",o.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",o.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",o.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",o.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",o.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",o.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",o.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",o.MANIFEST_LOAD_ERROR="manifestLoadError",o.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",o.MANIFEST_PARSING_ERROR="manifestParsingError",o.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",o.LEVEL_EMPTY_ERROR="levelEmptyError",o.LEVEL_LOAD_ERROR="levelLoadError",o.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",o.LEVEL_PARSING_ERROR="levelParsingError",o.LEVEL_SWITCH_ERROR="levelSwitchError",o.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",o.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",o.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",o.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",o.FRAG_LOAD_ERROR="fragLoadError",o.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",o.FRAG_DECRYPT_ERROR="fragDecryptError",o.FRAG_PARSING_ERROR="fragParsingError",o.FRAG_GAP="fragGap",o.REMUX_ALLOC_ERROR="remuxAllocError",o.KEY_LOAD_ERROR="keyLoadError",o.KEY_LOAD_TIMEOUT="keyLoadTimeOut",o.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",o.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",o.BUFFER_APPEND_ERROR="bufferAppendError",o.BUFFER_APPENDING_ERROR="bufferAppendingError",o.BUFFER_STALLED_ERROR="bufferStalledError",o.BUFFER_FULL_ERROR="bufferFullError",o.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",o.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",o.ASSET_LIST_LOAD_ERROR="assetListLoadError",o.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",o.ASSET_LIST_PARSING_ERROR="assetListParsingError",o.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",o.INTERNAL_EXCEPTION="internalException",o.INTERNAL_ABORTED="aborted",o.ATTACH_MEDIA_ERROR="attachMediaError",o.UNKNOWN="unknown",o})({}),y=(function(o){return o.MEDIA_ATTACHING="hlsMediaAttaching",o.MEDIA_ATTACHED="hlsMediaAttached",o.MEDIA_DETACHING="hlsMediaDetaching",o.MEDIA_DETACHED="hlsMediaDetached",o.MEDIA_ENDED="hlsMediaEnded",o.STALL_RESOLVED="hlsStallResolved",o.BUFFER_RESET="hlsBufferReset",o.BUFFER_CODECS="hlsBufferCodecs",o.BUFFER_CREATED="hlsBufferCreated",o.BUFFER_APPENDING="hlsBufferAppending",o.BUFFER_APPENDED="hlsBufferAppended",o.BUFFER_EOS="hlsBufferEos",o.BUFFERED_TO_END="hlsBufferedToEnd",o.BUFFER_FLUSHING="hlsBufferFlushing",o.BUFFER_FLUSHED="hlsBufferFlushed",o.MANIFEST_LOADING="hlsManifestLoading",o.MANIFEST_LOADED="hlsManifestLoaded",o.MANIFEST_PARSED="hlsManifestParsed",o.LEVEL_SWITCHING="hlsLevelSwitching",o.LEVEL_SWITCHED="hlsLevelSwitched",o.LEVEL_LOADING="hlsLevelLoading",o.LEVEL_LOADED="hlsLevelLoaded",o.LEVEL_UPDATED="hlsLevelUpdated",o.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",o.LEVELS_UPDATED="hlsLevelsUpdated",o.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",o.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",o.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",o.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",o.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",o.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",o.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",o.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",o.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",o.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",o.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",o.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",o.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",o.CUES_PARSED="hlsCuesParsed",o.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",o.INIT_PTS_FOUND="hlsInitPtsFound",o.FRAG_LOADING="hlsFragLoading",o.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",o.FRAG_LOADED="hlsFragLoaded",o.FRAG_DECRYPTED="hlsFragDecrypted",o.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",o.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",o.FRAG_PARSING_METADATA="hlsFragParsingMetadata",o.FRAG_PARSED="hlsFragParsed",o.FRAG_BUFFERED="hlsFragBuffered",o.FRAG_CHANGED="hlsFragChanged",o.FPS_DROP="hlsFpsDrop",o.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",o.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",o.ERROR="hlsError",o.DESTROYING="hlsDestroying",o.KEY_LOADING="hlsKeyLoading",o.KEY_LOADED="hlsKeyLoaded",o.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",o.BACK_BUFFER_REACHED="hlsBackBufferReached",o.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",o.ASSET_LIST_LOADING="hlsAssetListLoading",o.ASSET_LIST_LOADED="hlsAssetListLoaded",o.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",o.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",o.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",o.INTERSTITIAL_STARTED="hlsInterstitialStarted",o.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",o.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",o.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",o.INTERSTITIAL_ENDED="hlsInterstitialEnded",o.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",o.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",o.EVENT_CUE_ENTER="hlsEventCueEnter",o})({});var z={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},H={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};class je{constructor(t,e=0,s=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=t,this.alpha_=t?Math.exp(Math.log(.5)/t):0,this.estimate_=e,this.totalWeight_=s}sample(t,e){const s=Math.pow(this.alpha_,t);this.estimate_=e*(1-s)+s*this.estimate_,this.totalWeight_+=t}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const t=1-Math.pow(this.alpha_,this.totalWeight_);if(t)return this.estimate_/t}return this.estimate_}}class au{constructor(t,e,s,i=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=s,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new je(t),this.fast_=new je(e),this.defaultTTFB_=i,this.ttfb_=new je(t)}update(t,e){const{slow_:s,fast_:i,ttfb_:n}=this;s.halfLife!==t&&(this.slow_=new je(t,s.getEstimate(),s.getTotalWeight())),i.halfLife!==e&&(this.fast_=new je(e,i.getEstimate(),i.getTotalWeight())),n.halfLife!==t&&(this.ttfb_=new je(t,n.getEstimate(),n.getTotalWeight()))}sample(t,e){t=Math.max(t,this.minDelayMs_);const s=8*e,i=t/1e3,n=s/i;this.fast_.sample(i,n),this.slow_.sample(i,n)}sampleTTFB(t){const e=t/1e3,s=Math.sqrt(2)*Math.exp(-Math.pow(e,2)/2);this.ttfb_.sample(s,Math.max(t,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}}function lu(o,t,e){return(t=hu(t))in o?Object.defineProperty(o,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):o[t]=e,o}function rt(){return rt=Object.assign?Object.assign.bind():function(o){for(var t=1;t<arguments.length;t++){var e=arguments[t];for(var s in e)({}).hasOwnProperty.call(e,s)&&(o[s]=e[s])}return o},rt.apply(null,arguments)}function Do(o,t){var e=Object.keys(o);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(o);t&&(s=s.filter(function(i){return Object.getOwnPropertyDescriptor(o,i).enumerable})),e.push.apply(e,s)}return e}function it(o){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?Do(Object(e),!0).forEach(function(s){lu(o,s,e[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(e)):Do(Object(e)).forEach(function(s){Object.defineProperty(o,s,Object.getOwnPropertyDescriptor(e,s))})}return o}function cu(o,t){if(typeof o!="object"||!o)return o;var e=o[Symbol.toPrimitive];if(e!==void 0){var s=e.call(o,t);if(typeof s!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(o)}function hu(o){var t=cu(o,"string");return typeof t=="symbol"?t:t+""}class zt{constructor(t,e){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;const s=`[${t}]:`;this.trace=Le,this.debug=e.debug.bind(null,s),this.log=e.log.bind(null,s),this.warn=e.warn.bind(null,s),this.info=e.info.bind(null,s),this.error=e.error.bind(null,s)}}const Le=function(){},Au={trace:Le,debug:Le,log:Le,warn:Le,info:Le,error:Le};function rr(){return rt({},Au)}function uu(o,t){const e=self.console[o];return e?e.bind(self.console,`${t?"["+t+"] ":""}[${o}] >`):Le}function Ro(o,t,e){return t[o]?t[o].bind(t):uu(o,e)}const or=rr();function du(o,t,e){const s=rr();if(typeof console=="object"&&o===!0||typeof o=="object"){const i=["debug","log","info","warn","error"];i.forEach(n=>{s[n]=Ro(n,o,e)});try{s.log(`Debug logs enabled for "${t}" in hls.js version 1.6.15`)}catch{return rr()}i.forEach(n=>{or[n]=Ro(n,o)})}else rt(or,s);return s}const nt=or;function Pe(o=!0){return typeof self>"u"?void 0:(o||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function fu(o){return typeof self<"u"&&o===self.ManagedMediaSource}function Ql(o,t){const e=Object.keys(o),s=Object.keys(t),i=e.length,n=s.length;return!i||!n||i===n&&!e.some(r=>s.indexOf(r)===-1)}function $t(o,t=!1){if(typeof TextDecoder<"u"){const l=new TextDecoder("utf-8").decode(o);if(t){const h=l.indexOf("\0");return h!==-1?l.substring(0,h):l}return l.replace(/\0/g,"")}const e=o.length;let s,i,n,r="",a=0;for(;a<e;){if(s=o[a++],s===0&&t)return r;if(s===0||s===3)continue;switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:r+=String.fromCharCode(s);break;case 12:case 13:i=o[a++],r+=String.fromCharCode((s&31)<<6|i&63);break;case 14:i=o[a++],n=o[a++],r+=String.fromCharCode((s&15)<<12|(i&63)<<6|(n&63)<<0);break}}return r}function Lt(o){let t="";for(let e=0;e<o.length;e++){let s=o[e].toString(16);s.length<2&&(s="0"+s),t+=s}return t}function Ml(o){return Uint8Array.from(o.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}function gu(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var un={exports:{}},bo;function mu(){return bo||(bo=1,(function(o,t){(function(e){var s=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,i=/^(?=([^\/?#]*))\1([^]*)$/,n=/(?:\/|^)\.(?=\/)/g,r=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,a={buildAbsoluteURL:function(c,l,h){if(h=h||{},c=c.trim(),l=l.trim(),!l){if(!h.alwaysNormalize)return c;var A=a.parseURL(c);if(!A)throw new Error("Error trying to parse base URL.");return A.path=a.normalizePath(A.path),a.buildURLFromParts(A)}var u=a.parseURL(l);if(!u)throw new Error("Error trying to parse relative URL.");if(u.scheme)return h.alwaysNormalize?(u.path=a.normalizePath(u.path),a.buildURLFromParts(u)):l;var d=a.parseURL(c);if(!d)throw new Error("Error trying to parse base URL.");if(!d.netLoc&&d.path&&d.path[0]!=="/"){var f=i.exec(d.path);d.netLoc=f[1],d.path=f[2]}d.netLoc&&!d.path&&(d.path="/");var g={scheme:d.scheme,netLoc:u.netLoc,path:null,params:u.params,query:u.query,fragment:u.fragment};if(!u.netLoc&&(g.netLoc=d.netLoc,u.path[0]!=="/"))if(!u.path)g.path=d.path,u.params||(g.params=d.params,u.query||(g.query=d.query));else{var m=d.path,E=m.substring(0,m.lastIndexOf("/")+1)+u.path;g.path=a.normalizePath(E)}return g.path===null&&(g.path=h.alwaysNormalize?a.normalizePath(u.path):u.path),a.buildURLFromParts(g)},parseURL:function(c){var l=s.exec(c);return l?{scheme:l[1]||"",netLoc:l[2]||"",path:l[3]||"",params:l[4]||"",query:l[5]||"",fragment:l[6]||""}:null},normalizePath:function(c){for(c=c.split("").reverse().join("").replace(n,"");c.length!==(c=c.replace(r,"")).length;);return c.split("").reverse().join("")},buildURLFromParts:function(c){return c.scheme+c.netLoc+c.path+c.params+c.query+c.fragment}};o.exports=a})()})(un)),un.exports}var Mr=mu();class Or{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var ot={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class Ol{constructor(t){this._byteRange=null,this._url=null,this._stats=null,this._streams=null,this.base=void 0,this.relurl=void 0,typeof t=="string"&&(t={url:t}),this.base=t,Eu(this,"stats")}setByteRange(t,e){const s=t.split("@",2);let i;s.length===1?i=e?.byteRangeEndOffset||0:i=parseInt(s[1]),this._byteRange=[i,parseInt(s[0])+i]}get baseurl(){return this.base.url}get byteRange(){return this._byteRange===null?[]:this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get elementaryStreams(){return this._streams===null&&(this._streams={[ot.AUDIO]:null,[ot.VIDEO]:null,[ot.AUDIOVIDEO]:null}),this._streams}set elementaryStreams(t){this._streams=t}get hasStats(){return this._stats!==null}get hasStreams(){return this._streams!==null}get stats(){return this._stats===null&&(this._stats=new Or),this._stats}set stats(t){this._stats=t}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=Mr.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(t){this._url=t}clearElementaryStreamInfo(){const{elementaryStreams:t}=this;t[ot.AUDIO]=null,t[ot.VIDEO]=null,t[ot.AUDIOVIDEO]=null}}function dt(o){return o.sn!=="initSegment"}class dn extends Ol{constructor(t,e){super(e),this._decryptdata=null,this._programDateTime=null,this._ref=null,this._bitrate=void 0,this.rawProgramDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.playlistOffset=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=t}get byteLength(){if(this.hasStats){const t=this.stats.total;if(t)return t}if(this.byteRange.length){const t=this.byteRange[0],e=this.byteRange[1];if(K(t)&&K(e))return e-t}return null}get bitrate(){return this.byteLength?this.byteLength*8/this.duration:this._bitrate?this._bitrate:null}set bitrate(t){this._bitrate=t}get decryptdata(){var t;const{levelkeys:e}=this;if(!e||e.NONE)return null;if(e.identity)this._decryptdata||(this._decryptdata=e.identity.getDecryptData(this.sn));else if(!((t=this._decryptdata)!=null&&t.keyId)){const s=Object.keys(e);if(s.length===1){const i=this._decryptdata=e[s[0]]||null;i&&(this._decryptdata=i.getDecryptData(this.sn,e))}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null)return null;const t=K(this.duration)?this.duration:0;return this.programDateTime+t*1e3}get encrypted(){var t;if((t=this._decryptdata)!=null&&t.encrypted)return!0;if(this.levelkeys){var e;const s=Object.keys(this.levelkeys),i=s.length;if(i>1||i===1&&(e=this.levelkeys[s[0]])!=null&&e.encrypted)return!0}return!1}get programDateTime(){return this._programDateTime===null&&this.rawProgramDateTime&&(this.programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime}set programDateTime(t){if(!K(t)){this._programDateTime=this.rawProgramDateTime=null;return}this._programDateTime=t}get ref(){return dt(this)?(this._ref||(this._ref={base:this.base,start:this.start,duration:this.duration,sn:this.sn,programDateTime:this.programDateTime}),this._ref):null}addStart(t){this.setStart(this.start+t)}setStart(t){this.start=t,this._ref&&(this._ref.start=t)}setDuration(t){this.duration=t,this._ref&&(this._ref.duration=t)}setKeyFormat(t){const e=this.levelkeys;if(e){var s;const i=e[t];i&&!((s=this._decryptdata)!=null&&s.keyId)&&(this._decryptdata=i.getDecryptData(this.sn,e))}}abortRequests(){var t,e;(t=this.loader)==null||t.abort(),(e=this.keyLoader)==null||e.abort()}setElementaryStreamInfo(t,e,s,i,n,r=!1){const{elementaryStreams:a}=this,c=a[t];if(!c){a[t]={startPTS:e,endPTS:s,startDTS:i,endDTS:n,partial:r};return}c.startPTS=Math.min(c.startPTS,e),c.endPTS=Math.max(c.endPTS,s),c.startDTS=Math.min(c.startDTS,i),c.endDTS=Math.max(c.endDTS,n)}}class pu extends Ol{constructor(t,e,s,i,n){super(s),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.duration=t.decimalFloatingPoint("DURATION"),this.gap=t.bool("GAP"),this.independent=t.bool("INDEPENDENT"),this.relurl=t.enumeratedString("URI"),this.fragment=e,this.index=i;const r=t.enumeratedString("BYTERANGE");r&&this.setByteRange(r,n),n&&(this.fragOffset=n.fragOffset+n.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:t}=this;return!!(t.audio||t.video||t.audiovideo)}}function Ul(o,t){const e=Object.getPrototypeOf(o);if(e){const s=Object.getOwnPropertyDescriptor(e,t);return s||Ul(e,t)}}function Eu(o,t){const e=Ul(o,t);e&&(e.enumerable=!0,Object.defineProperty(o,t,e))}const wo=Math.pow(2,32)-1,Iu=[].push,Nl={video:1,audio:2,id3:3,text:4};function pt(o){return String.fromCharCode.apply(null,o)}function Gl(o,t){const e=o[t]<<8|o[t+1];return e<0?65536+e:e}function W(o,t){const e=Kl(o,t);return e<0?4294967296+e:e}function ko(o,t){let e=W(o,t);return e*=Math.pow(2,32),e+=W(o,t+4),e}function Kl(o,t){return o[t]<<24|o[t+1]<<16|o[t+2]<<8|o[t+3]}function yu(o){const t=o.byteLength;for(let e=0;e<t;){const s=W(o,e);if(s>8&&o[e+4]===109&&o[e+5]===111&&o[e+6]===111&&o[e+7]===102)return!0;e=s>1?e+s:t}return!1}function X(o,t){const e=[];if(!t.length)return e;const s=o.byteLength;for(let i=0;i<s;){const n=W(o,i),r=pt(o.subarray(i+4,i+8)),a=n>1?i+n:s;if(r===t[0])if(t.length===1)e.push(o.subarray(i+8,a));else{const c=X(o.subarray(i+8,a),t.slice(1));c.length&&Iu.apply(e,c)}i=a}return e}function Cu(o){const t=[],e=o[0];let s=8;const i=W(o,s);s+=4;let n=0,r=0;e===0?(n=W(o,s),r=W(o,s+4),s+=8):(n=ko(o,s),r=ko(o,s+8),s+=16),s+=2;let a=o.length+r;const c=Gl(o,s);s+=2;for(let l=0;l<c;l++){let h=s;const A=W(o,h);h+=4;const u=A&2147483647;if((A&2147483648)>>>31===1)return nt.warn("SIDX has hierarchical references (not supported)"),null;const f=W(o,h);h+=4,t.push({referenceSize:u,subsegmentDuration:f,info:{duration:f/i,start:a,end:a+u-1}}),a+=u,h+=4,s=h}return{earliestPresentationTime:n,timescale:i,version:e,referencesCount:c,references:t}}function $l(o){const t=[],e=X(o,["moov","trak"]);for(let i=0;i<e.length;i++){const n=e[i],r=X(n,["tkhd"])[0];if(r){let a=r[0];const c=W(r,a===0?12:20),l=X(n,["mdia","mdhd"])[0];if(l){a=l[0];const h=W(l,a===0?12:20),A=X(n,["mdia","hdlr"])[0];if(A){const u=pt(A.subarray(8,12)),d={soun:ot.AUDIO,vide:ot.VIDEO}[u],f=X(n,["mdia","minf","stbl","stsd"])[0],g=Su(f);d?(t[c]={timescale:h,type:d,stsd:g},t[d]=it({timescale:h,id:c},g)):t[c]={timescale:h,type:u,stsd:g}}}}}return X(o,["moov","mvex","trex"]).forEach(i=>{const n=W(i,4),r=t[n];r&&(r.default={duration:W(i,12),flags:W(i,20)})}),t}function Su(o){const t=o.subarray(8),e=t.subarray(86),s=pt(t.subarray(4,8));let i=s,n;const r=s==="enca"||s==="encv";if(r){const l=X(t,[s])[0].subarray(s==="enca"?28:78);X(l,["sinf"]).forEach(A=>{const u=X(A,["schm"])[0];if(u){const d=pt(u.subarray(4,8));if(d==="cbcs"||d==="cenc"){const f=X(A,["frma"])[0];f&&(i=pt(f))}}})}const a=i;switch(i){case"avc1":case"avc2":case"avc3":case"avc4":{const c=X(e,["avcC"])[0];c&&c.length>3&&(i+="."+si(c[1])+si(c[2])+si(c[3]),n=ei(a==="avc1"?"dva1":"dvav",e));break}case"mp4a":{const c=X(t,[s])[0],l=X(c.subarray(28),["esds"])[0];if(l&&l.length>7){let h=4;if(l[h++]!==3)break;h=fn(l,h),h+=2;const A=l[h++];if(A&128&&(h+=2),A&64&&(h+=l[h++]),l[h++]!==4)break;h=fn(l,h);const u=l[h++];if(u===64)i+="."+si(u);else break;if(h+=12,l[h++]!==5)break;h=fn(l,h);const d=l[h++];let f=(d&248)>>3;f===31&&(f+=1+((d&7)<<3)+((l[h]&224)>>5)),i+="."+f}break}case"hvc1":case"hev1":{const c=X(e,["hvcC"])[0];if(c&&c.length>12){const l=c[1],h=["","A","B","C"][l>>6],A=l&31,u=W(c,2),d=(l&32)>>5?"H":"L",f=c[12],g=c.subarray(6,12);i+="."+h+A,i+="."+Tu(u).toString(16).toUpperCase(),i+="."+d+f;let m="";for(let E=g.length;E--;){const p=g[E];(p||m)&&(m="."+p.toString(16).toUpperCase()+m)}i+=m}n=ei(a=="hev1"?"dvhe":"dvh1",e);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":{i=ei(i,e)||i;break}case"vp09":{const c=X(e,["vpcC"])[0];if(c&&c.length>6){const l=c[4],h=c[5],A=c[6]>>4&15;i+="."+le(l)+"."+le(h)+"."+le(A)}break}case"av01":{const c=X(e,["av1C"])[0];if(c&&c.length>2){const l=c[1]>>>5,h=c[1]&31,A=c[2]>>>7?"H":"M",u=(c[2]&64)>>6,d=(c[2]&32)>>5,f=l===2&&u?d?12:10:u?10:8,g=(c[2]&16)>>4,m=(c[2]&8)>>3,E=(c[2]&4)>>2,p=c[2]&3;i+="."+l+"."+le(h)+A+"."+le(f)+"."+g+"."+m+E+p+"."+le(1)+"."+le(1)+"."+le(1)+"."+0,n=ei("dav1",e)}break}}return{codec:i,encrypted:r,supplemental:n}}function ei(o,t){const e=X(t,["dvvC"]),s=e.length?e[0]:X(t,["dvcC"])[0];if(s){const i=s[2]>>1&127,n=s[2]<<5&32|s[3]>>3&31;return o+"."+le(i)+"."+le(n)}}function Tu(o){let t=0;for(let e=0;e<32;e++)t|=(o>>e&1)<<31-e;return t>>>0}function fn(o,t){const e=t+5;for(;o[t++]&128&&t<e;);return t}function si(o){return("0"+o.toString(16).toUpperCase()).slice(-2)}function le(o){return(o<10?"0":"")+o}function Bu(o,t){if(!o||!t)return;const e=t.keyId;e&&t.isCommonEncryption&&Hl(o,(s,i)=>{const n=s.subarray(8,24);n.some(r=>r!==0)||(nt.log(`[eme] Patching keyId in 'enc${i?"a":"v"}>sinf>>tenc' box: ${Lt(n)} -> ${Lt(e)}`),s.set(e,8))})}function xu(o){const t=[];return Hl(o,e=>t.push(e.subarray(8,24))),t}function Hl(o,t){X(o,["moov","trak"]).forEach(s=>{const i=X(s,["mdia","minf","stbl","stsd"])[0];if(!i)return;const n=i.subarray(8);let r=X(n,["enca"]);const a=r.length>0;a||(r=X(n,["encv"])),r.forEach(c=>{const l=a?c.subarray(28):c.subarray(78);X(l,["sinf"]).forEach(A=>{const u=Vl(A);u&&t(u,a)})})})}function Vl(o){const t=X(o,["schm"])[0];if(t){const e=pt(t.subarray(4,8));if(e==="cbcs"||e==="cenc"){const s=X(o,["schi","tenc"])[0];if(s)return s}}}function vu(o,t,e){const s={},i=X(o,["moof","traf"]);for(let n=0;n<i.length;n++){const r=i[n],a=X(r,["tfhd"])[0],c=W(a,4),l=t[c];if(!l)continue;s[c]||(s[c]={start:NaN,duration:0,sampleCount:0,timescale:l.timescale,type:l.type});const h=s[c],A=X(r,["tfdt"])[0];if(A){const I=A[0];let C=W(A,4);I===1&&(C===wo?e.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"):(C*=wo+1,C+=W(A,8))),K(C)&&(!K(h.start)||C<h.start)&&(h.start=C)}const u=l.default,d=W(a,0)|u?.flags;let f=u?.duration||0;d&8&&(d&2?f=W(a,12):f=W(a,8));const g=X(r,["trun"]);let m=h.start||0,E=0,p=f;for(let I=0;I<g.length;I++){const C=g[I],S=W(C,4),v=h.sampleCount;h.sampleCount+=S;const T=C[3]&1,x=C[3]&4,L=C[2]&1,B=C[2]&2,D=C[2]&4,R=C[2]&8;let k=8,_=S;for(T&&(k+=4),x&&S&&(!(C[k+1]&1)&&h.keyFrameIndex===void 0&&(h.keyFrameIndex=v),k+=4,L?(p=W(C,k),k+=4):p=f,B&&(k+=4),R&&(k+=4),m+=p,E+=p,_--);_--;)L?(p=W(C,k),k+=4):p=f,B&&(k+=4),D&&(C[k+1]&1||h.keyFrameIndex===void 0&&(h.keyFrameIndex=h.sampleCount-(_+1),h.keyFrameStart=m),k+=4),R&&(k+=4),m+=p,E+=p;!E&&f&&(E+=f*S)}h.duration+=E}if(!Object.keys(s).some(n=>s[n].duration)){let n=1/0,r=0;const a=X(o,["sidx"]);for(let c=0;c<a.length;c++){const l=Cu(a[c]);if(l!=null&&l.references){n=Math.min(n,l.earliestPresentationTime/l.timescale);const h=l.references.reduce((A,u)=>A+u.info.duration||0,0);r=Math.max(r,h+l.earliestPresentationTime/l.timescale)}}r&&K(r)&&Object.keys(s).forEach(c=>{s[c].duration||(s[c].duration=r*s[c].timescale-s[c].start)})}return s}function Lu(o){const t={valid:null,remainder:null},e=X(o,["moof"]);if(e.length<2)return t.remainder=o,t;const s=e[e.length-1];return t.valid=o.slice(0,s.byteOffset-8),t.remainder=o.slice(s.byteOffset-8),t}function jt(o,t){const e=new Uint8Array(o.length+t.length);return e.set(o),e.set(t,o.length),e}function _o(o,t){const e=[],s=t.samples,i=t.timescale,n=t.id;let r=!1;return X(s,["moof"]).map(c=>{const l=c.byteOffset-8;X(c,["traf"]).map(A=>{const u=X(A,["tfdt"]).map(d=>{const f=d[0];let g=W(d,4);return f===1&&(g*=Math.pow(2,32),g+=W(d,8)),g/i})[0];return u!==void 0&&(o=u),X(A,["tfhd"]).map(d=>{const f=W(d,4),g=W(d,0)&16777215,m=(g&1)!==0,E=(g&2)!==0,p=(g&8)!==0;let I=0;const C=(g&16)!==0;let S=0;const v=(g&32)!==0;let T=8;f===n&&(m&&(T+=8),E&&(T+=4),p&&(I=W(d,T),T+=4),C&&(S=W(d,T),T+=4),v&&(T+=4),t.type==="video"&&(r=nn(t.codec)),X(A,["trun"]).map(x=>{const L=x[0],B=W(x,0)&16777215,D=(B&1)!==0;let R=0;const k=(B&4)!==0,_=(B&256)!==0;let Q=0;const F=(B&512)!==0;let G=0;const N=(B&1024)!==0,$=(B&2048)!==0;let Y=0;const M=W(x,4);let O=8;D&&(R=W(x,O),O+=4),k&&(O+=4);let q=R+l;for(let tt=0;tt<M;tt++){if(_?(Q=W(x,O),O+=4):Q=I,F?(G=W(x,O),O+=4):G=S,N&&(O+=4),$&&(L===0?Y=W(x,O):Y=Kl(x,O),O+=4),t.type===ot.VIDEO){let J=0;for(;J<G;){const Z=W(s,q);if(q+=4,Du(r,s[q])){const Ct=s.subarray(q,q+Z);Ur(Ct,r?2:1,o+Y/i,e)}q+=Z,J+=Z+4}}o+=Q/i}}))})})}),e}function nn(o){if(!o)return!1;const t=o.substring(0,4);return t==="hvc1"||t==="hev1"||t==="dvh1"||t==="dvhe"}function Du(o,t){if(o){const e=t>>1&63;return e===39||e===40}else return(t&31)===6}function Ur(o,t,e,s){const i=Yl(o);let n=0;n+=t;let r=0,a=0,c=0;for(;n<i.length;){r=0;do{if(n>=i.length)break;c=i[n++],r+=c}while(c===255);a=0;do{if(n>=i.length)break;c=i[n++],a+=c}while(c===255);const l=i.length-n;let h=n;if(a<l)n+=a;else if(a>l){nt.error(`Malformed SEI payload. ${a} is too small, only ${l} bytes left to parse.`);break}if(r===4){if(i[h++]===181){const u=Gl(i,h);if(h+=2,u===49){const d=W(i,h);if(h+=4,d===1195456820){const f=i[h++];if(f===3){const g=i[h++],m=31&g,E=64&g,p=E?2+m*3:0,I=new Uint8Array(p);if(E){I[0]=g;for(let C=1;C<p;C++)I[C]=i[h++]}s.push({type:f,payloadType:r,pts:e,bytes:I})}}}}}else if(r===5&&a>16){const A=[];for(let f=0;f<16;f++){const g=i[h++].toString(16);A.push(g.length==1?"0"+g:g),(f===3||f===5||f===7||f===9)&&A.push("-")}const u=a-16,d=new Uint8Array(u);for(let f=0;f<u;f++)d[f]=i[h++];s.push({payloadType:r,pts:e,uuid:A.join(""),userData:$t(d),userDataBytes:d})}}}function Yl(o){const t=o.byteLength,e=[];let s=1;for(;s<t-2;)o[s]===0&&o[s+1]===0&&o[s+2]===3?(e.push(s+2),s+=2):s++;if(e.length===0)return o;const i=t-e.length,n=new Uint8Array(i);let r=0;for(s=0;s<i;r++,s++)r===e[0]&&(r++,e.shift()),n[s]=o[r];return n}function Ru(o){const t=o[0];let e="",s="",i=0,n=0,r=0,a=0,c=0,l=0;if(t===0){for(;pt(o.subarray(l,l+1))!=="\0";)e+=pt(o.subarray(l,l+1)),l+=1;for(e+=pt(o.subarray(l,l+1)),l+=1;pt(o.subarray(l,l+1))!=="\0";)s+=pt(o.subarray(l,l+1)),l+=1;s+=pt(o.subarray(l,l+1)),l+=1,i=W(o,12),n=W(o,16),a=W(o,20),c=W(o,24),l=28}else if(t===1){l+=4,i=W(o,l),l+=4;const A=W(o,l);l+=4;const u=W(o,l);for(l+=4,r=2**32*A+u,ru(r)||(r=Number.MAX_SAFE_INTEGER,nt.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),a=W(o,l),l+=4,c=W(o,l),l+=4;pt(o.subarray(l,l+1))!=="\0";)e+=pt(o.subarray(l,l+1)),l+=1;for(e+=pt(o.subarray(l,l+1)),l+=1;pt(o.subarray(l,l+1))!=="\0";)s+=pt(o.subarray(l,l+1)),l+=1;s+=pt(o.subarray(l,l+1)),l+=1}const h=o.subarray(l,o.byteLength);return{schemeIdUri:e,value:s,timeScale:i,presentationTime:r,presentationTimeDelta:n,eventDuration:a,id:c,payload:h}}function bu(o,...t){const e=t.length;let s=8,i=e;for(;i--;)s+=t[i].byteLength;const n=new Uint8Array(s);for(n[0]=s>>24&255,n[1]=s>>16&255,n[2]=s>>8&255,n[3]=s&255,n.set(o,4),i=0,s=8;i<e;i++)n.set(t[i],s),s+=t[i].byteLength;return n}function wu(o,t,e){if(o.byteLength!==16)throw new RangeError("Invalid system id");let s,i;s=0,i=new Uint8Array;let n;s>0?(n=new Uint8Array(4),t.length>0&&new DataView(n.buffer).setUint32(0,t.length,!1)):n=new Uint8Array;const r=new Uint8Array(4);return e.byteLength>0&&new DataView(r.buffer).setUint32(0,e.byteLength,!1),bu([112,115,115,104],new Uint8Array([s,0,0,0]),o,n,i,r,e)}function ku(o){const t=[];if(o instanceof ArrayBuffer){const e=o.byteLength;let s=0;for(;s+32<e;){const i=new DataView(o,s),n=_u(i);t.push(n),s+=n.size}}return t}function _u(o){const t=o.getUint32(0),e=o.byteOffset,s=o.byteLength;if(s<t)return{offset:e,size:s};if(o.getUint32(4)!==1886614376)return{offset:e,size:t};const n=o.getUint32(8)>>>24;if(n!==0&&n!==1)return{offset:e,size:t};const r=o.buffer,a=Lt(new Uint8Array(r,e+12,16));let c=null,l=null,h=0;if(n===0)h=28;else{const u=o.getUint32(28);if(!u||s<32+u*16)return{offset:e,size:t};c=[];for(let d=0;d<u;d++)c.push(new Uint8Array(r,e+32+d*16,16));h=32+u*16}if(!h)return{offset:e,size:t};const A=o.getUint32(h);return t-32<A?{offset:e,size:t}:(l=new Uint8Array(r,e+h+4,A),{version:n,systemId:a,kids:c,data:l,offset:e,size:t})}const ql=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),ys={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function Nr(o,t){const e=ys[t];return!!e&&!!e[o.slice(0,4)]}function Ys(o,t,e=!0){return!o.split(",").some(s=>!Gr(s,t,e))}function Gr(o,t,e=!0){var s;const i=Pe(e);return(s=i?.isTypeSupported(qs(o,t)))!=null?s:!1}function qs(o,t){return`${t}/mp4;codecs=${o}`}function Po(o){if(o){const t=o.substring(0,4);return ys.video[t]}return 2}function Vi(o){const t=ql();return o.split(",").reduce((e,s)=>{const n=t&&nn(s)?9:ys.video[s];return n?(n*2+e)/(e?3:2):(ys.audio[s]+e)/(e?2:1)},0)}const gn={};function Pu(o,t=!0){if(gn[o])return gn[o];const e={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[o];for(let i=0;i<e.length;i++){var s;if(Gr(e[i],"audio",t))return gn[o]=e[i],e[i];if(e[i]==="mp3"&&(s=Pe(t))!=null&&s.isTypeSupported("audio/mpeg"))return""}return o}const Fu=/flac|opus|mp4a\.40\.34/i;function Yi(o,t=!0){return o.replace(Fu,e=>Pu(e.toLowerCase(),t))}function Qu(o,t){const e=[];if(o){const s=o.split(",");for(let i=0;i<s.length;i++)Nr(s[i],"video")||e.push(s[i])}return t&&e.push(t),e.join(",")}function _i(o,t){if(o&&(o.length>4||["ac-3","ec-3","alac","fLaC","Opus"].indexOf(o)!==-1)&&(Fo(o,"audio")||Fo(o,"video")))return o;if(t){const e=t.split(",");if(e.length>1){if(o){for(let s=e.length;s--;)if(e[s].substring(0,4)===o.substring(0,4))return e[s]}return e[0]}}return t||o}function Fo(o,t){return Nr(o,t)&&Gr(o,t)}function Mu(o){const t=o.split(",");for(let e=0;e<t.length;e++){const s=t[e].split(".");s.length>2&&s[0]==="avc1"&&(t[e]=`avc1.${parseInt(s[1]).toString(16)}${("000"+parseInt(s[2]).toString(16)).slice(-4)}`)}return t.join(",")}function Ou(o){if(o.startsWith("av01.")){const t=o.split("."),e=["0","111","01","01","01","0"];for(let s=t.length;s>4&&s<10;s++)t[s]=e[s-4];return t.join(".")}return o}function Qo(o){const t=Pe(o)||{isTypeSupported:()=>!1};return{mpeg:t.isTypeSupported("audio/mpeg"),mp3:t.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:t.isTypeSupported('audio/mp4; codecs="ac-3"')}}function ar(o){return o.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}const Uu={supported:!0,powerEfficient:!0,smooth:!0},Nu={supported:!1,smooth:!1,powerEfficient:!1},Wl={supported:!0,configurations:[],decodingInfoResults:[Uu]};function Jl(o,t){return{supported:!1,configurations:t,decodingInfoResults:[Nu],error:o}}function Gu(o,t,e,s,i,n){const r=o.videoCodec,a=o.audioCodec?o.audioGroups:null,c=n?.audioCodec,l=n?.channels,h=l?parseInt(l):c?1/0:2;let A=null;if(a!=null&&a.length)try{a.length===1&&a[0]?A=t.groups[a[0]].channels:A=a.reduce((u,d)=>{if(d){const f=t.groups[d];if(!f)throw new Error(`Audio track group ${d} not found`);Object.keys(f.channels).forEach(g=>{u[g]=(u[g]||0)+f.channels[g]})}return u},{2:0})}catch{return!0}return r!==void 0&&(r.split(",").some(u=>nn(u))||o.width>1920&&o.height>1088||o.height>1920&&o.width>1088||o.frameRate>Math.max(s,30)||o.videoRange!=="SDR"&&o.videoRange!==e||o.bitrate>Math.max(i,8e6))||!!A&&K(h)&&Object.keys(A).some(u=>parseInt(u)>h)}function jl(o,t,e,s={}){const i=o.videoCodec;if(!i&&!o.audioCodec||!e)return Promise.resolve(Wl);const n=[],r=Ku(o),a=r.length,c=$u(o,t,a>0),l=c.length;for(let h=a||1*l||1;h--;){const A={type:"media-source"};if(a&&(A.video=r[h%a]),l){A.audio=c[h%l];const u=A.audio.bitrate;A.video&&u&&(A.video.bitrate-=u)}n.push(A)}if(i){const h=navigator.userAgent;if(i.split(",").some(A=>nn(A))&&ql())return Promise.resolve(Jl(new Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent string: (${h})`),n))}return Promise.all(n.map(h=>{const A=Vu(h);return s[A]||(s[A]=e.decodingInfo(h))})).then(h=>({supported:!h.some(A=>!A.supported),configurations:n,decodingInfoResults:h})).catch(h=>({supported:!1,configurations:n,decodingInfoResults:[],error:h}))}function Ku(o){var t;const e=(t=o.videoCodec)==null?void 0:t.split(","),s=Xl(o),i=o.width||640,n=o.height||480,r=o.frameRate||30,a=o.videoRange.toLowerCase();return e?e.map(c=>{const l={contentType:qs(Ou(c),"video"),width:i,height:n,bitrate:s,framerate:r};return a!=="sdr"&&(l.transferFunction=a),l}):[]}function $u(o,t,e){var s;const i=(s=o.audioCodec)==null?void 0:s.split(","),n=Xl(o);return i&&o.audioGroups?o.audioGroups.reduce((r,a)=>{var c;const l=a?(c=t.groups[a])==null?void 0:c.tracks:null;return l?l.reduce((h,A)=>{if(A.groupId===a){const u=parseFloat(A.channels||"");i.forEach(d=>{const f={contentType:qs(d,"audio"),bitrate:e?Hu(d,n):n};u&&(f.channels=""+u),h.push(f)})}return h},r):r},[]):[]}function Hu(o,t){if(t<=1)return 1;let e=128e3;return o==="ec-3"?e=768e3:o==="ac-3"&&(e=64e4),Math.min(t/2,e)}function Xl(o){return Math.ceil(Math.max(o.bitrate*.9,o.averageBitrate)/1e3)*1e3||1}function Vu(o){let t="";const{audio:e,video:s}=o;if(s){const i=ar(s.contentType);t+=`${i}_r${s.height}x${s.width}f${Math.ceil(s.framerate)}${s.transferFunction||"sd"}_${Math.ceil(s.bitrate/1e5)}`}if(e){const i=ar(e.contentType);t+=`${s?"_":""}${i}_c${e.channels}`}return t}const lr=["NONE","TYPE-0","TYPE-1",null];function Yu(o){return lr.indexOf(o)>-1}const qi=["SDR","PQ","HLG"];function qu(o){return!!o&&qi.indexOf(o)>-1}var Pi={No:"",Yes:"YES",v2:"v2"};function Mo(o){const{canSkipUntil:t,canSkipDateRanges:e,age:s}=o,i=s<t/2;return t&&i?e?Pi.v2:Pi.Yes:Pi.No}class Oo{constructor(t,e,s){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=t,this.part=e,this.skip=s}addDirectives(t){const e=new self.URL(t);return this.msn!==void 0&&e.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&e.searchParams.set("_HLS_part",this.part.toString()),this.skip&&e.searchParams.set("_HLS_skip",this.skip),e.href}}class Ws{constructor(t){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[t.url],this._attrs=[t.attrs],this.bitrate=t.bitrate,t.details&&(this.details=t.details),this.id=t.id||0,this.name=t.name,this.width=t.width||0,this.height=t.height||0,this.frameRate=t.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=t.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=t.audioCodec,this.videoCodec=t.videoCodec,this.codecSet=[t.videoCodec,t.audioCodec].filter(s=>!!s).map(s=>s.substring(0,4)).join(","),"supplemental"in t){var e;this.supplemental=t.supplemental;const s=(e=t.supplemental)==null?void 0:e.videoCodec;s&&s!==t.videoCodec&&(this.codecSet+=`,${s.substring(0,4)}`)}this.addGroupId("audio",t.attrs.AUDIO),this.addGroupId("text",t.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(t){return Uo(this._audioGroups,t)}hasSubtitleGroup(t){return Uo(this._subtitleGroups,t)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(t,e){if(e){if(t==="audio"){let s=this._audioGroups;s||(s=this._audioGroups=[]),s.indexOf(e)===-1&&s.push(e)}else if(t==="text"){let s=this._subtitleGroups;s||(s=this._subtitleGroups=[]),s.indexOf(e)===-1&&s.push(e)}}}get urlId(){return 0}set urlId(t){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var t;return(t=this.audioGroups)==null?void 0:t[0]}get textGroupId(){var t;return(t=this.subtitleGroups)==null?void 0:t[0]}addFallback(){}}function Uo(o,t){return!t||!o?!1:o.indexOf(t)!==-1}function Wu(){if(typeof matchMedia=="function"){const o=matchMedia("(dynamic-range: high)"),t=matchMedia("bad query");if(o.media!==t.media)return o.matches===!0}return!1}function Ju(o,t){let e=!1,s=[];if(o&&(e=o!=="SDR",s=[o]),t){s=t.allowedVideoRanges||qi.slice(0);const i=s.join("")!=="SDR"&&!t.videoCodec;e=t.preferHDR!==void 0?t.preferHDR:i&&Wu(),e||(s=["SDR"])}return{preferHDR:e,allowedVideoRanges:s}}const ju=o=>{const t=new WeakSet;return(e,s)=>{if(o&&(s=o(e,s)),typeof s=="object"&&s!==null){if(t.has(s))return;t.add(s)}return s}},at=(o,t)=>JSON.stringify(o,ju(t));function Xu(o,t,e,s,i){const n=Object.keys(o),r=s?.channels,a=s?.audioCodec,c=i?.videoCodec,l=r&&parseInt(r)===2;let h=!1,A=!1,u=1/0,d=1/0,f=1/0,g=1/0,m=0,E=[];const{preferHDR:p,allowedVideoRanges:I}=Ju(t,i);for(let x=n.length;x--;){const L=o[n[x]];h||(h=L.channels[2]>0),u=Math.min(u,L.minHeight),d=Math.min(d,L.minFramerate),f=Math.min(f,L.minBitrate),I.filter(D=>L.videoRanges[D]>0).length>0&&(A=!0)}u=K(u)?u:0,d=K(d)?d:0;const C=Math.max(1080,u),S=Math.max(30,d);f=K(f)?f:e,e=Math.max(f,e),A||(t=void 0);const v=n.length>1;return{codecSet:n.reduce((x,L)=>{const B=o[L];if(L===x)return x;if(E=A?I.filter(D=>B.videoRanges[D]>0):[],v){if(B.minBitrate>e)return oe(L,`min bitrate of ${B.minBitrate} > current estimate of ${e}`),x;if(!B.hasDefaultAudio)return oe(L,"no renditions with default or auto-select sound found"),x;if(a&&L.indexOf(a.substring(0,4))%5!==0)return oe(L,`audio codec preference "${a}" not found`),x;if(r&&!l){if(!B.channels[r])return oe(L,`no renditions with ${r} channel sound found (channels options: ${Object.keys(B.channels)})`),x}else if((!a||l)&&h&&B.channels[2]===0)return oe(L,"no renditions with stereo sound found"),x;if(B.minHeight>C)return oe(L,`min resolution of ${B.minHeight} > maximum of ${C}`),x;if(B.minFramerate>S)return oe(L,`min framerate of ${B.minFramerate} > maximum of ${S}`),x;if(!E.some(D=>B.videoRanges[D]>0))return oe(L,`no variants with VIDEO-RANGE of ${at(E)} found`),x;if(c&&L.indexOf(c.substring(0,4))%5!==0)return oe(L,`video codec preference "${c}" not found`),x;if(B.maxScore<m)return oe(L,`max score of ${B.maxScore} < selected max of ${m}`),x}return x&&(Vi(L)>=Vi(x)||B.fragmentError>o[x].fragmentError)?x:(g=B.minIndex,m=B.maxScore,L)},void 0),videoRanges:E,preferHDR:p,minFramerate:d,minBitrate:f,minIndex:g}}function oe(o,t){nt.log(`[abr] start candidates with "${o}" ignored because ${t}`)}function zl(o){return o.reduce((t,e)=>{let s=t.groups[e.groupId];s||(s=t.groups[e.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),s.tracks.push(e);const i=e.channels||"2";return s.channels[i]=(s.channels[i]||0)+1,s.hasDefault=s.hasDefault||e.default,s.hasAutoSelect=s.hasAutoSelect||e.autoselect,s.hasDefault&&(t.hasDefaultAudio=!0),s.hasAutoSelect&&(t.hasAutoSelectAudio=!0),t},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function zu(o,t,e,s){return o.slice(e,s+1).reduce((i,n,r)=>{if(!n.codecSet)return i;const a=n.audioGroups;let c=i[n.codecSet];c||(i[n.codecSet]=c={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:r,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!a,fragmentError:0}),c.minBitrate=Math.min(c.minBitrate,n.bitrate);const l=Math.min(n.height,n.width);return c.minHeight=Math.min(c.minHeight,l),c.minFramerate=Math.min(c.minFramerate,n.frameRate),c.minIndex=Math.min(c.minIndex,r),c.maxScore=Math.max(c.maxScore,n.score),c.fragmentError+=n.fragmentError,c.videoRanges[n.videoRange]=(c.videoRanges[n.videoRange]||0)+1,a&&a.forEach(h=>{if(!h)return;const A=t.groups[h];A&&(c.hasDefaultAudio=c.hasDefaultAudio||t.hasDefaultAudio?A.hasDefault:A.hasAutoSelect||!t.hasDefaultAudio&&!t.hasAutoSelectAudio,Object.keys(A.channels).forEach(u=>{c.channels[u]=(c.channels[u]||0)+A.channels[u]}))}),i},{})}function No(o){if(!o)return o;const{lang:t,assocLang:e,characteristics:s,channels:i,audioCodec:n}=o;return{lang:t,assocLang:e,characteristics:s,channels:i,audioCodec:n}}function Ae(o,t,e){if("attrs"in o){const s=t.indexOf(o);if(s!==-1)return s}for(let s=0;s<t.length;s++){const i=t[s];if(Ye(o,i,e))return s}return-1}function Ye(o,t,e){const{groupId:s,name:i,lang:n,assocLang:r,default:a}=o,c=o.forced;return(s===void 0||t.groupId===s)&&(i===void 0||t.name===i)&&(n===void 0||Zu(n,t.lang))&&(n===void 0||t.assocLang===r)&&(a===void 0||t.default===a)&&(c===void 0||t.forced===c)&&(!("characteristics"in o)||td(o.characteristics||"",t.characteristics))&&(e===void 0||e(o,t))}function Zu(o,t="--"){return o.length===t.length?o===t:o.startsWith(t)||t.startsWith(o)}function td(o,t=""){const e=o.split(","),s=t.split(",");return e.length===s.length&&!e.some(i=>s.indexOf(i)===-1)}function He(o,t){const{audioCodec:e,channels:s}=o;return(e===void 0||(t.audioCodec||"").substring(0,4)===e.substring(0,4))&&(s===void 0||s===(t.channels||"2"))}function ed(o,t,e,s,i){const n=t[s],a=t.reduce((u,d,f)=>{const g=d.uri;return(u[g]||(u[g]=[])).push(f),u},{})[n.uri];a.length>1&&(s=Math.max.apply(Math,a));const c=n.videoRange,l=n.frameRate,h=n.codecSet.substring(0,4),A=Go(t,s,u=>{if(u.videoRange!==c||u.frameRate!==l||u.codecSet.substring(0,4)!==h)return!1;const d=u.audioGroups,f=e.filter(g=>!d||d.indexOf(g.groupId)!==-1);return Ae(o,f,i)>-1});return A>-1?A:Go(t,s,u=>{const d=u.audioGroups,f=e.filter(g=>!d||d.indexOf(g.groupId)!==-1);return Ae(o,f,i)>-1})}function Go(o,t,e){for(let s=t;s>-1;s--)if(e(o[s]))return s;for(let s=t+1;s<o.length;s++)if(e(o[s]))return s;return-1}function Wi(o,t){var e;return!!o&&o!==((e=t.loadLevelObj)==null?void 0:e.uri)}class sd extends zt{constructor(t){super("abr",t.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.supportedCache={},this.bwEstimator=void 0,this._abandonRulesCheck=e=>{var s;const{fragCurrent:i,partCurrent:n,hls:r}=this,{autoLevelEnabled:a,media:c}=r;if(!i||!c)return;const l=performance.now(),h=n?n.stats:i.stats,A=n?n.duration:i.duration,u=l-h.loading.start,d=r.minAutoLevel,f=i.level,g=this._nextAutoLevel;if(h.aborted||h.loaded&&h.loaded===h.total||f<=d){this.clearTimer(),this._nextAutoLevel=-1;return}if(!a)return;const m=g>-1&&g!==f,E=!!e||m;if(!E&&(c.paused||!c.playbackRate||!c.readyState))return;const p=r.mainForwardBufferInfo;if(!E&&p===null)return;const I=this.bwEstimator.getEstimateTTFB(),C=Math.abs(c.playbackRate);if(u<=Math.max(I,1e3*(A/(C*2))))return;const S=p?p.len/C:0,v=h.loading.first?h.loading.first-h.loading.start:-1,T=h.loaded&&v>-1,x=this.getBwEstimate(),L=r.levels,B=L[f],D=Math.max(h.loaded,Math.round(A*(i.bitrate||B.averageBitrate)/8));let R=T?u-v:u;R<1&&T&&(R=Math.min(u,h.loaded*8/x));const k=T?h.loaded*1e3/R:0,_=I/1e3,Q=k?(D-h.loaded)/k:D*8/x+_;if(Q<=S)return;const F=k?k*8:x,G=((s=e?.details||this.hls.latestLevelDetails)==null?void 0:s.live)===!0,N=this.hls.config.abrBandWidthUpFactor;let $=Number.POSITIVE_INFINITY,Y;for(Y=f-1;Y>d;Y--){const tt=L[Y].maxBitrate,J=!L[Y].details||G;if($=this.getTimeToLoadFrag(_,F,A*tt,J),$<Math.min(S,A+_))break}if($>=Q||$>A*10)return;T?this.bwEstimator.sample(u-Math.min(I,v),h.loaded):this.bwEstimator.sampleTTFB(u);const M=L[Y].maxBitrate;this.getBwEstimate()*N>M&&this.resetEstimator(M);const O=this.findBestLevel(M,d,Y,0,S,1,1);O>-1&&(Y=O),this.warn(`Fragment ${i.sn}${n?" part "+n.index:""} of level ${f} is loading too slowly;
      Fragment duration: ${i.duration.toFixed(3)}
      Time to underbuffer: ${S.toFixed(3)} s
      Estimated load time for current fragment: ${Q.toFixed(3)} s
      Estimated load time for down switch fragment: ${$.toFixed(3)} s
      TTFB estimate: ${v|0} ms
      Current BW estimate: ${K(x)?x|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${Y} @ ${M|0} bps`),r.nextLoadLevel=r.nextAutoLevel=Y,this.clearTimer();const q=()=>{if(this.clearTimer(),this.fragCurrent===i&&this.hls.loadLevel===Y&&Y>0){const tt=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${Y>0?"and switching down":""}
      Fragment duration: ${i.duration.toFixed(3)} s
      Time to underbuffer: ${tt.toFixed(3)} s`),i.abortRequests(),this.fragCurrent=this.partCurrent=null,Y>d){let J=this.findBestLevel(this.hls.levels[d].bitrate,d,Y,0,tt,1,1);J===-1&&(J=d),this.hls.nextLoadLevel=this.hls.nextAutoLevel=J,this.resetEstimator(this.hls.levels[J].bitrate)}}};m||Q>$*2?q():this.timer=self.setInterval(q,$*1e3),r.trigger(y.FRAG_LOAD_EMERGENCY_ABORTED,{frag:i,part:n,stats:h})},this.hls=t,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(t){t&&(this.log(`setting initial bwe to ${t}`),this.hls.config.abrEwmaDefaultEstimate=t),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const t=this.hls.config;return new au(t.abrEwmaSlowVoD,t.abrEwmaFastVoD,t.abrEwmaDefaultEstimate)}registerListeners(){const{hls:t}=this;t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.FRAG_LOADING,this.onFragLoading,this),t.on(y.FRAG_LOADED,this.onFragLoaded,this),t.on(y.FRAG_BUFFERED,this.onFragBuffered,this),t.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(y.LEVEL_LOADED,this.onLevelLoaded,this),t.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(y.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),t.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:t}=this;t&&(t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.FRAG_LOADING,this.onFragLoading,this),t.off(y.FRAG_LOADED,this.onFragLoaded,this),t.off(y.FRAG_BUFFERED,this.onFragBuffered,this),t.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(y.LEVEL_LOADED,this.onLevelLoaded,this),t.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(y.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),t.off(y.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=this.supportedCache=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(t,e){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.supportedCache={},this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(t,e){const s=e.frag;if(!this.ignoreFragment(s)){if(!s.bitrateTest){var i;this.fragCurrent=s,this.partCurrent=(i=e.part)!=null?i:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(t,e){this.clearTimer()}onError(t,e){if(!e.fatal)switch(e.details){case w.BUFFER_ADD_CODEC_ERROR:case w.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case w.FRAG_LOAD_TIMEOUT:{const s=e.frag,{fragCurrent:i,partCurrent:n}=this;if(s&&i&&s.sn===i.sn&&s.level===i.level){const r=performance.now(),a=n?n.stats:s.stats,c=r-a.loading.start,l=a.loading.first?a.loading.first-a.loading.start:-1;if(a.loaded&&l>-1){const A=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(c-Math.min(A,l),a.loaded)}else this.bwEstimator.sampleTTFB(c)}break}}}getTimeToLoadFrag(t,e,s,i){const n=t+s/e,r=i?t+this.lastLevelLoadSec:0;return n+r}onLevelLoaded(t,e){const s=this.hls.config,{loading:i}=e.stats,n=i.end-i.first;K(n)&&(this.lastLevelLoadSec=n/1e3),e.details.live?this.bwEstimator.update(s.abrEwmaSlowLive,s.abrEwmaFastLive):this.bwEstimator.update(s.abrEwmaSlowVoD,s.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(e.levelInfo)}onFragLoaded(t,{frag:e,part:s}){const i=s?s.stats:e.stats;if(e.type===H.MAIN&&this.bwEstimator.sampleTTFB(i.loading.first-i.loading.start),!this.ignoreFragment(e)){if(this.clearTimer(),e.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const n=s?s.duration:e.duration,r=this.hls.levels[e.level],a=(r.loaded?r.loaded.bytes:0)+i.loaded,c=(r.loaded?r.loaded.duration:0)+n;r.loaded={bytes:a,duration:c},r.realBitrate=Math.round(8*a/c)}if(e.bitrateTest){const n={stats:i,frag:e,part:s,id:e.type};this.onFragBuffered(y.FRAG_BUFFERED,n),e.bitrateTest=!1}else this.lastLoadedFragLevel=e.level}}onFragBuffered(t,e){const{frag:s,part:i}=e,n=i!=null&&i.stats.loaded?i.stats:s.stats;if(n.aborted||this.ignoreFragment(s))return;const r=n.parsing.end-n.loading.start-Math.min(n.loading.first-n.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(r,n.loaded),n.bwEstimate=this.getBwEstimate(),s.bitrateTest?this.bitrateTestDelay=r/1e3:this.bitrateTestDelay=0}ignoreFragment(t){return t.type!==H.MAIN||t.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:t,minAutoLevel:e}=this.hls,s=this.getBwEstimate(),i=this.hls.config.maxStarvationDelay,n=this.findBestLevel(s,e,t,0,i,1,1);if(n>-1)return n;const r=this.hls.firstLevel,a=Math.min(Math.max(r,e),t);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${r} clamped to ${a}`),a}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const t=this.forcedAutoLevel,s=this.bwEstimator.canEstimate(),i=this.lastLoadedFragLevel>-1;if(t!==-1&&(!s||!i||this.nextAutoLevelKey===this.getAutoLevelKey()))return t;const n=s&&i?this.getNextABRAutoLevel():this.firstAutoLevel;if(t!==-1){const r=this.hls.levels;if(r.length>Math.max(t,n)&&r[t].loadError<=r[n].loadError)return t}return this._nextAutoLevel=n,this.nextAutoLevelKey=this.getAutoLevelKey(),n}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:t,partCurrent:e,hls:s}=this;if(s.levels.length<=1)return s.loadLevel;const{maxAutoLevel:i,config:n,minAutoLevel:r}=s,a=e?e.duration:t?t.duration:0,c=this.getBwEstimate(),l=this.getStarvationDelay();let h=n.abrBandWidthFactor,A=n.abrBandWidthUpFactor;if(l){const m=this.findBestLevel(c,r,i,l,0,h,A);if(m>=0)return this.rebufferNotice=-1,m}let u=a?Math.min(a,n.maxStarvationDelay):n.maxStarvationDelay;if(!l){const m=this.bitrateTestDelay;m&&(u=(a?Math.min(a,n.maxLoadingDelay):n.maxLoadingDelay)-m,this.info(`bitrate test took ${Math.round(1e3*m)}ms, set first fragment max fetchDuration to ${Math.round(1e3*u)} ms`),h=A=1)}const d=this.findBestLevel(c,r,i,l,u,h,A);if(this.rebufferNotice!==d&&(this.rebufferNotice=d,this.info(`${l?"rebuffering expected":"buffer is empty"}, optimal quality level ${d}`)),d>-1)return d;const f=s.levels[r],g=s.loadLevelObj;return g&&f?.bitrate<g.bitrate?r:s.loadLevel}getStarvationDelay(){const t=this.hls,e=t.media;if(!e)return 1/0;const s=e&&e.playbackRate!==0?Math.abs(e.playbackRate):1,i=t.mainForwardBufferInfo;return(i?i.len:0)/s}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(t,e,s,i,n,r,a){var c;const l=i+n,h=this.lastLoadedFragLevel,A=h===-1?this.hls.firstLevel:h,{fragCurrent:u,partCurrent:d}=this,{levels:f,allAudioTracks:g,loadLevel:m,config:E}=this.hls;if(f.length===1)return 0;const p=f[A],I=!!((c=this.hls.latestLevelDetails)!=null&&c.live),C=m===-1||h===-1;let S,v="SDR",T=p?.frameRate||0;const{audioPreference:x,videoPreference:L}=E,B=this.audioTracksByGroup||(this.audioTracksByGroup=zl(g));let D=-1;if(C){if(this.firstSelection!==-1)return this.firstSelection;const F=this.codecTiers||(this.codecTiers=zu(f,B,e,s)),G=Xu(F,v,t,x,L),{codecSet:N,videoRanges:$,minFramerate:Y,minBitrate:M,minIndex:O,preferHDR:q}=G;D=O,S=N,v=q?$[$.length-1]:$[0],T=Y,t=Math.max(t,M),this.log(`picked start tier ${at(G)}`)}else S=p?.codecSet,v=p?.videoRange;const R=d?d.duration:u?u.duration:0,k=this.bwEstimator.getEstimateTTFB()/1e3,_=[];for(let F=s;F>=e;F--){var Q;const G=f[F],N=F>A;if(!G)continue;if(E.useMediaCapabilities&&!G.supportedResult&&!G.supportedPromise){const J=navigator.mediaCapabilities;typeof J?.decodingInfo=="function"&&Gu(G,B,v,T,t,x)?(G.supportedPromise=jl(G,B,J,this.supportedCache),G.supportedPromise.then(Z=>{if(!this.hls)return;G.supportedResult=Z;const Ct=this.hls.levels,mt=Ct.indexOf(G);Z.error?this.warn(`MediaCapabilities decodingInfo error: "${Z.error}" for level ${mt} ${at(Z)}`):Z.supported?Z.decodingInfoResults.some(Qt=>Qt.smooth===!1||Qt.powerEfficient===!1)&&this.log(`MediaCapabilities decodingInfo for level ${mt} not smooth or powerEfficient: ${at(Z)}`):(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${mt} ${at(Z)}`),mt>-1&&Ct.length>1&&(this.log(`Removing unsupported level ${mt}`),this.hls.removeLevel(mt),this.hls.loadLevel===-1&&(this.hls.nextLoadLevel=0)))}).catch(Z=>{this.warn(`Error handling MediaCapabilities decodingInfo: ${Z}`)})):G.supportedResult=Wl}if((S&&G.codecSet!==S||v&&G.videoRange!==v||N&&T>G.frameRate||!N&&T>0&&T<G.frameRate||(Q=G.supportedResult)!=null&&(Q=Q.decodingInfoResults)!=null&&Q.some(J=>J.smooth===!1))&&(!C||F!==D)){_.push(F);continue}const $=G.details,Y=(d?$?.partTarget:$?.averagetargetduration)||R;let M;N?M=a*t:M=r*t;const O=R&&i>=R*2&&n===0?G.averageBitrate:G.maxBitrate,q=this.getTimeToLoadFrag(k,M,O*Y,$===void 0);if(M>=O&&(F===h||G.loadError===0&&G.fragmentError===0)&&(q<=k||!K(q)||I&&!this.bitrateTestDelay||q<l)){const J=this.forcedAutoLevel;return F!==m&&(J===-1||J!==m)&&(_.length&&this.trace(`Skipped level(s) ${_.join(",")} of ${s} max with CODECS and VIDEO-RANGE:"${f[_[0]].codecs}" ${f[_[0]].videoRange}; not compatible with "${S}" ${v}`),this.info(`switch candidate:${A}->${F} adjustedbw(${Math.round(M)})-bitrate=${Math.round(M-O)} ttfb:${k.toFixed(1)} avgDuration:${Y.toFixed(1)} maxFetchDuration:${l.toFixed(1)} fetchDuration:${q.toFixed(1)} firstSelection:${C} codecSet:${G.codecSet} videoRange:${G.videoRange} hls.loadLevel:${m}`)),C&&(this.firstSelection=F),F}}return-1}set nextAutoLevel(t){const e=this.deriveNextAutoLevel(t);this._nextAutoLevel!==e&&(this.nextAutoLevelKey="",this._nextAutoLevel=e)}deriveNextAutoLevel(t){const{maxAutoLevel:e,minAutoLevel:s}=this.hls;return Math.min(Math.max(t,s),e)}}const Zl={search:function(o,t){let e=0,s=o.length-1,i=null,n=null;for(;e<=s;){i=(e+s)/2|0,n=o[i];const r=t(n);if(r>0)e=i+1;else if(r<0)s=i-1;else return n}return null}};function id(o,t,e){if(t===null||!Array.isArray(o)||!o.length||!K(t))return null;const s=o[0].programDateTime;if(t<(s||0))return null;const i=o[o.length-1].endProgramDateTime;if(t>=(i||0))return null;for(let n=0;n<o.length;++n){const r=o[n];if(rd(t,e,r))return r}return null}function We(o,t,e=0,s=0,i=.005){let n=null;if(o){n=t[1+o.sn-t[0].sn]||null;const a=o.endDTS-e;a>0&&a<15e-7&&(e+=15e-7),n&&o.level!==n.level&&n.end<=o.end&&(n=t[2+o.sn-t[0].sn]||null)}else e===0&&t[0].start===0&&(n=t[0]);if(n&&((!o||o.level===n.level)&&Ko(e,s,n)===0||nd(n,o,Math.min(i,s))))return n;const r=Zl.search(t,Ko.bind(null,e,s));return r&&(r!==o||!n)?r:n}function nd(o,t,e){if(t&&t.start===0&&t.level<o.level&&(t.endPTS||0)>0){const s=t.tagList.reduce((i,n)=>(n[0]==="INF"&&(i+=parseFloat(n[1])),i),e);return o.start<=s}return!1}function Ko(o=0,t=0,e){if(e.start<=o&&e.start+e.duration>o)return 0;const s=Math.min(t,e.duration+(e.deltaPTS?e.deltaPTS:0));return e.start+e.duration-s<=o?1:e.start-s>o&&e.start?-1:0}function rd(o,t,e){const s=Math.min(t,e.duration+(e.deltaPTS?e.deltaPTS:0))*1e3;return(e.endProgramDateTime||0)-s>o}function tc(o,t,e){if(o&&o.startCC<=t&&o.endCC>=t){let s=o.fragments;const{fragmentHint:i}=o;i&&(s=s.concat(i));let n;return Zl.search(s,r=>r.cc<t?1:r.cc>t?-1:(n=r,r.end<=e?1:r.start>e?-1:0)),n||null}return null}function Ji(o){switch(o.details){case w.FRAG_LOAD_TIMEOUT:case w.KEY_LOAD_TIMEOUT:case w.LEVEL_LOAD_TIMEOUT:case w.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function ec(o){return o.details.startsWith("key")}function sc(o){return ec(o)&&!!o.frag&&!o.frag.decryptdata}function $o(o,t){const e=Ji(t);return o.default[`${e?"timeout":"error"}Retry`]}function Kr(o,t){const e=o.backoff==="linear"?1:Math.pow(2,t);return Math.min(e*o.retryDelayMs,o.maxRetryDelayMs)}function Ho(o){return it(it({},o),{errorRetry:null,timeoutRetry:null})}function ji(o,t,e,s){if(!o)return!1;const i=s?.code,n=t<o.maxNumRetry&&(od(i)||!!e);return o.shouldRetry?o.shouldRetry(o,t,e,s,n):n}function od(o){return cr(o)||!!o&&(o<400||o>499)}function cr(o){return o===0&&navigator.onLine===!1}var vt={DoNothing:0,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,RetryRequest:5},Nt={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,MoveAllAlternatesMatchingKey:4};class ad extends zt{constructor(t){super("error-controller",t.logger),this.hls=void 0,this.playlistError=0,this.hls=t,this.registerListeners()}registerListeners(){const t=this.hls;t.on(y.ERROR,this.onError,this),t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const t=this.hls;t&&(t.off(y.ERROR,this.onError,this),t.off(y.ERROR,this.onErrorOut,this),t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null}startLoad(t){}stopLoad(){this.playlistError=0}getVariantLevelIndex(t){return t?.type===H.MAIN?t.level:this.getVariantIndex()}getVariantIndex(){var t;const e=this.hls,s=e.currentLevel;return(t=e.loadLevelObj)!=null&&t.details||s===-1?e.loadLevel:s}variantHasKey(t,e){if(t){var s;if((s=t.details)!=null&&s.hasKey(e))return!0;const i=t.audioGroups;if(i)return this.hls.allAudioTracks.filter(r=>i.indexOf(r.groupId)>=0).some(r=>{var a;return(a=r.details)==null?void 0:a.hasKey(e)})}return!1}onManifestLoading(){this.playlistError=0}onLevelUpdated(){this.playlistError=0}onError(t,e){var s;if(e.fatal)return;const i=this.hls,n=e.context;switch(e.details){case w.FRAG_LOAD_ERROR:case w.FRAG_LOAD_TIMEOUT:case w.KEY_LOAD_ERROR:case w.KEY_LOAD_TIMEOUT:e.errorAction=this.getFragRetryOrSwitchAction(e);return;case w.FRAG_PARSING_ERROR:if((s=e.frag)!=null&&s.gap){e.errorAction=ms();return}case w.FRAG_GAP:case w.FRAG_DECRYPT_ERROR:{e.errorAction=this.getFragRetryOrSwitchAction(e),e.errorAction.action=vt.SendAlternateToPenaltyBox;return}case w.LEVEL_EMPTY_ERROR:case w.LEVEL_PARSING_ERROR:{var r;const c=e.parent===H.MAIN?e.level:i.loadLevel;e.details===w.LEVEL_EMPTY_ERROR&&((r=e.context)!=null&&(r=r.levelDetails)!=null&&r.live)?e.errorAction=this.getPlaylistRetryOrSwitchAction(e,c):(e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,c))}return;case w.LEVEL_LOAD_ERROR:case w.LEVEL_LOAD_TIMEOUT:typeof n?.level=="number"&&(e.errorAction=this.getPlaylistRetryOrSwitchAction(e,n.level));return;case w.AUDIO_TRACK_LOAD_ERROR:case w.AUDIO_TRACK_LOAD_TIMEOUT:case w.SUBTITLE_LOAD_ERROR:case w.SUBTITLE_TRACK_LOAD_TIMEOUT:if(n){const c=i.loadLevelObj;if(c&&(n.type===z.AUDIO_TRACK&&c.hasAudioGroup(n.groupId)||n.type===z.SUBTITLE_TRACK&&c.hasSubtitleGroup(n.groupId))){e.errorAction=this.getPlaylistRetryOrSwitchAction(e,i.loadLevel),e.errorAction.action=vt.SendAlternateToPenaltyBox,e.errorAction.flags=Nt.MoveAllAlternatesMatchingHost;return}}return;case w.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:e.errorAction={action:vt.SendAlternateToPenaltyBox,flags:Nt.MoveAllAlternatesMatchingHDCP};return;case w.KEY_SYSTEM_SESSION_UPDATE_FAILED:case w.KEY_SYSTEM_STATUS_INTERNAL_ERROR:case w.KEY_SYSTEM_NO_SESSION:e.errorAction={action:vt.SendAlternateToPenaltyBox,flags:Nt.MoveAllAlternatesMatchingKey};return;case w.BUFFER_ADD_CODEC_ERROR:case w.REMUX_ALLOC_ERROR:case w.BUFFER_APPEND_ERROR:if(!e.errorAction){var a;e.errorAction=this.getLevelSwitchAction(e,(a=e.level)!=null?a:i.loadLevel)}return;case w.INTERNAL_EXCEPTION:case w.BUFFER_APPENDING_ERROR:case w.BUFFER_FULL_ERROR:case w.LEVEL_SWITCH_ERROR:case w.BUFFER_STALLED_ERROR:case w.BUFFER_SEEK_OVER_HOLE:case w.BUFFER_NUDGE_ON_STALL:e.errorAction=ms();return}e.type===V.KEY_SYSTEM_ERROR&&(e.levelRetry=!1,e.errorAction=ms())}getPlaylistRetryOrSwitchAction(t,e){const s=this.hls,i=$o(s.config.playlistLoadPolicy,t),n=this.playlistError++;if(ji(i,n,Ji(t),t.response))return{action:vt.RetryRequest,flags:Nt.None,retryConfig:i,retryCount:n};const a=this.getLevelSwitchAction(t,e);return i&&(a.retryConfig=i,a.retryCount=n),a}getFragRetryOrSwitchAction(t){const e=this.hls,s=this.getVariantLevelIndex(t.frag),i=e.levels[s],{fragLoadPolicy:n,keyLoadPolicy:r}=e.config,a=$o(ec(t)?r:n,t),c=e.levels.reduce((h,A)=>h+A.fragmentError,0);if(i&&(t.details!==w.FRAG_GAP&&i.fragmentError++,!sc(t)&&ji(a,c,Ji(t),t.response)))return{action:vt.RetryRequest,flags:Nt.None,retryConfig:a,retryCount:c};const l=this.getLevelSwitchAction(t,s);return a&&(l.retryConfig=a,l.retryCount=c),l}getLevelSwitchAction(t,e){const s=this.hls;e==null&&(e=s.loadLevel);const i=this.hls.levels[e];if(i){var n,r;const l=t.details;i.loadError++,l===w.BUFFER_APPEND_ERROR&&i.fragmentError++;let h=-1;const{levels:A,loadLevel:u,minAutoLevel:d,maxAutoLevel:f}=s;!s.autoLevelEnabled&&!s.config.preserveManualLevelOnError&&(s.loadLevel=-1);const g=(n=t.frag)==null?void 0:n.type,E=(g===H.AUDIO&&l===w.FRAG_PARSING_ERROR||t.sourceBufferName==="audio"&&(l===w.BUFFER_ADD_CODEC_ERROR||l===w.BUFFER_APPEND_ERROR))&&A.some(({audioCodec:v})=>i.audioCodec!==v),I=t.sourceBufferName==="video"&&(l===w.BUFFER_ADD_CODEC_ERROR||l===w.BUFFER_APPEND_ERROR)&&A.some(({codecSet:v,audioCodec:T})=>i.codecSet!==v&&i.audioCodec===T),{type:C,groupId:S}=(r=t.context)!=null?r:{};for(let v=A.length;v--;){const T=(v+u)%A.length;if(T!==u&&T>=d&&T<=f&&A[T].loadError===0){var a,c;const x=A[T];if(l===w.FRAG_GAP&&g===H.MAIN&&t.frag){const L=A[T].details;if(L){const B=We(t.frag,L.fragments,t.frag.start);if(B!=null&&B.gap)continue}}else{if(C===z.AUDIO_TRACK&&x.hasAudioGroup(S)||C===z.SUBTITLE_TRACK&&x.hasSubtitleGroup(S))continue;if(g===H.AUDIO&&(a=i.audioGroups)!=null&&a.some(L=>x.hasAudioGroup(L))||g===H.SUBTITLE&&(c=i.subtitleGroups)!=null&&c.some(L=>x.hasSubtitleGroup(L))||E&&i.audioCodec===x.audioCodec||I&&i.codecSet===x.codecSet||!E&&i.codecSet!==x.codecSet)continue}h=T;break}}if(h>-1&&s.loadLevel!==h)return t.levelRetry=!0,this.playlistError=0,{action:vt.SendAlternateToPenaltyBox,flags:Nt.None,nextAutoLevel:h}}return{action:vt.SendAlternateToPenaltyBox,flags:Nt.MoveAllAlternatesMatchingHost}}onErrorOut(t,e){var s;switch((s=e.errorAction)==null?void 0:s.action){case vt.DoNothing:break;case vt.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(e),!e.errorAction.resolved&&e.details!==w.FRAG_GAP?e.fatal=!0:/MediaSource readyState: ended/.test(e.error.message)&&(this.warn(`MediaSource ended after "${e.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break}if(e.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(t){const e=this.hls,s=t.errorAction;if(!s)return;const{flags:i}=s,n=s.nextAutoLevel;switch(i){case Nt.None:this.switchLevel(t,n);break;case Nt.MoveAllAlternatesMatchingHDCP:{const c=this.getVariantLevelIndex(t.frag),l=e.levels[c],h=l?.attrs["HDCP-LEVEL"];if(s.hdcpLevel=h,h==="NONE")this.warn("HDCP policy resticted output with HDCP-LEVEL=NONE");else if(h){e.maxHdcpLevel=lr[lr.indexOf(h)-1],s.resolved=!0,this.warn(`Restricting playback to HDCP-LEVEL of "${e.maxHdcpLevel}" or lower`);break}}case Nt.MoveAllAlternatesMatchingKey:{const c=t.decryptdata;if(c){const l=this.hls.levels,h=l.length;for(let u=h;u--;)if(this.variantHasKey(l[u],c)){var r,a;this.log(`Banned key found in level ${u} (${l[u].bitrate}bps) or audio group "${(r=l[u].audioGroups)==null?void 0:r.join(",")}" (${(a=t.frag)==null?void 0:a.type} fragment) ${Lt(c.keyId||[])}`),l[u].fragmentError++,l[u].loadError++,this.log(`Removing level ${u} with key error (${t.error})`),this.hls.removeLevel(u)}const A=t.frag;if(this.hls.levels.length<h)s.resolved=!0;else if(A&&A.type!==H.MAIN){const u=A.decryptdata;u&&!c.matches(u)&&(s.resolved=!0)}}break}}s.resolved||this.switchLevel(t,n)}switchLevel(t,e){if(e!==void 0&&t.errorAction&&(this.warn(`switching to level ${e} after ${t.details}`),this.hls.nextAutoLevel=e,t.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,t.details===w.BUFFER_ADD_CODEC_ERROR&&t.mimeType&&t.sourceBufferName!=="audiovideo")){const s=ar(t.mimeType),i=this.hls.levels;for(let n=i.length;n--;)i[n][`${t.sourceBufferName}Codec`]===s&&(this.log(`Removing level ${n} for ${t.details} ("${s}" not supported)`),this.hls.removeLevel(n))}}}function ms(o){const t={action:vt.DoNothing,flags:Nt.None};return o&&(t.resolved=!0),t}var Et={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class ld{constructor(t){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=t,this._registerListeners()}_registerListeners(){const{hls:t}=this;t&&(t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.BUFFER_APPENDED,this.onBufferAppended,this),t.on(y.FRAG_BUFFERED,this.onFragBuffered,this),t.on(y.FRAG_LOADED,this.onFragLoaded,this))}_unregisterListeners(){const{hls:t}=this;t&&(t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.BUFFER_APPENDED,this.onBufferAppended,this),t.off(y.FRAG_BUFFERED,this.onFragBuffered,this),t.off(y.FRAG_LOADED,this.onFragLoaded,this))}destroy(){this._unregisterListeners(),this.hls=this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(t,e){const s=this.activePartLists[e];if(s)for(let i=s.length;i--;){const n=s[i];if(!n)break;if(n.start<=t&&t<=n.end&&n.loaded)return n}return this.getBufferedFrag(t,e)}getBufferedFrag(t,e){return this.getFragAtPos(t,e,!0)}getFragAtPos(t,e,s){const{fragments:i}=this,n=Object.keys(i);for(let r=n.length;r--;){const a=i[n[r]];if(a?.body.type===e&&(!s||a.buffered)){const c=a.body;if(c.start<=t&&t<=c.end)return c}}return null}detectEvictedFragments(t,e,s,i,n){this.timeRanges&&(this.timeRanges[t]=e);const r=i?.fragment.sn||-1;Object.keys(this.fragments).forEach(a=>{const c=this.fragments[a];if(!c||r>=c.body.sn)return;if(!c.buffered&&(!c.loaded||n)){c.body.type===s&&this.removeFragment(c.body);return}const l=c.range[t];if(l){if(l.time.length===0){this.removeFragment(c.body);return}l.time.some(h=>{const A=!this.isTimeBuffered(h.startPTS,h.endPTS,e);return A&&this.removeFragment(c.body),A})}})}detectPartialFragments(t){const e=this.timeRanges;if(!e||t.frag.sn==="initSegment")return;const s=t.frag,i=Xe(s),n=this.fragments[i];if(!n||n.buffered&&s.gap)return;const r=!s.relurl;Object.keys(e).forEach(a=>{const c=s.elementaryStreams[a];if(!c)return;const l=e[a],h=r||c.partial===!0;n.range[a]=this.getBufferedTimes(s,t.part,h,l)}),n.loaded=null,Object.keys(n.range).length?(this.bufferedEnd(n,s),ii(n)||this.removeParts(s.sn-1,s.type)):this.removeFragment(n.body)}bufferedEnd(t,e){t.buffered=!0,(t.body.endList=e.endList||t.body.endList)&&(this.endListFragments[t.body.type]=t)}removeParts(t,e){const s=this.activePartLists[e];s&&(this.activePartLists[e]=Vo(s,i=>i.fragment.sn>=t))}fragBuffered(t,e){const s=Xe(t);let i=this.fragments[s];!i&&e&&(i=this.fragments[s]={body:t,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},t.gap&&(this.hasGaps=!0)),i&&(i.loaded=null,this.bufferedEnd(i,t))}getBufferedTimes(t,e,s,i){const n={time:[],partial:s},r=t.start,a=t.end,c=t.minEndPTS||a,l=t.maxStartPTS||r;for(let h=0;h<i.length;h++){const A=i.start(h)-this.bufferPadding,u=i.end(h)+this.bufferPadding;if(l>=A&&c<=u){n.time.push({startPTS:Math.max(r,i.start(h)),endPTS:Math.min(a,i.end(h))});break}else if(r<u&&a>A){const d=Math.max(r,i.start(h)),f=Math.min(a,i.end(h));f>d&&(n.partial=!0,n.time.push({startPTS:d,endPTS:f}))}else if(a<=A)break}return n}getPartialFragment(t){let e=null,s,i,n,r=0;const{bufferPadding:a,fragments:c}=this;return Object.keys(c).forEach(l=>{const h=c[l];h&&ii(h)&&(i=h.body.start-a,n=h.body.end+a,t>=i&&t<=n&&(s=Math.min(t-i,n-t),r<=s&&(e=h.body,r=s)))}),e}isEndListAppended(t){const e=this.endListFragments[t];return e!==void 0&&(e.buffered||ii(e))}getState(t){const e=Xe(t),s=this.fragments[e];return s?s.buffered?ii(s)?Et.PARTIAL:Et.OK:Et.APPENDING:Et.NOT_LOADED}isTimeBuffered(t,e,s){let i,n;for(let r=0;r<s.length;r++){if(i=s.start(r)-this.bufferPadding,n=s.end(r)+this.bufferPadding,t>=i&&e<=n)return!0;if(e<=i)return!1}return!1}onManifestLoading(){this.removeAllFragments()}onFragLoaded(t,e){if(e.frag.sn==="initSegment"||e.frag.bitrateTest)return;const s=e.frag,i=e.part?null:e,n=Xe(s);this.fragments[n]={body:s,appendedPTS:null,loaded:i,buffered:!1,range:Object.create(null)}}onBufferAppended(t,e){const{frag:s,part:i,timeRanges:n,type:r}=e;if(s.sn==="initSegment")return;const a=s.type;if(i){let l=this.activePartLists[a];l||(this.activePartLists[a]=l=[]),l.push(i)}this.timeRanges=n;const c=n[r];this.detectEvictedFragments(r,c,a,i)}onFragBuffered(t,e){this.detectPartialFragments(e)}hasFragment(t){const e=Xe(t);return!!this.fragments[e]}hasFragments(t){const{fragments:e}=this,s=Object.keys(e);if(!t)return s.length>0;for(let i=s.length;i--;){const n=e[s[i]];if(n?.body.type===t)return!0}return!1}hasParts(t){var e;return!!((e=this.activePartLists[t])!=null&&e.length)}removeFragmentsInRange(t,e,s,i,n){i&&!this.hasGaps||Object.keys(this.fragments).forEach(r=>{const a=this.fragments[r];if(!a)return;const c=a.body;c.type!==s||i&&!c.gap||c.start<e&&c.end>t&&(a.buffered||n)&&this.removeFragment(c)})}removeFragment(t){const e=Xe(t);t.clearElementaryStreamInfo();const s=this.activePartLists[t.type];if(s){const i=t.sn;this.activePartLists[t.type]=Vo(s,n=>n.fragment.sn!==i)}delete this.fragments[e],t.endList&&delete this.endListFragments[t.type]}removeAllFragments(){var t;this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1;const e=(t=this.hls)==null||(t=t.latestLevelDetails)==null?void 0:t.partList;e&&e.forEach(s=>s.clearElementaryStreamInfo())}}function ii(o){var t,e,s;return o.buffered&&!!(o.body.gap||(t=o.range.video)!=null&&t.partial||(e=o.range.audio)!=null&&e.partial||(s=o.range.audiovideo)!=null&&s.partial)}function Xe(o){return`${o.type}_${o.level}_${o.sn}`}function Vo(o,t){return o.filter(e=>{const s=t(e);return s||e.clearElementaryStreamInfo(),s})}var Fe={cbc:0,ctr:1};class cd{constructor(t,e,s){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=t,this.aesIV=e,this.aesMode=s}decrypt(t,e){switch(this.aesMode){case Fe.cbc:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},e,t);case Fe.ctr:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},e,t);default:throw new Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}}function hd(o){const t=o.byteLength,e=t&&new DataView(o.buffer).getUint8(t-1);return e?o.slice(0,t-e):o}class Ad{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(t){const e=new DataView(t),s=new Uint32Array(4);for(let i=0;i<4;i++)s[i]=e.getUint32(i*4);return s}initTable(){const t=this.sBox,e=this.invSBox,s=this.subMix,i=s[0],n=s[1],r=s[2],a=s[3],c=this.invSubMix,l=c[0],h=c[1],A=c[2],u=c[3],d=new Uint32Array(256);let f=0,g=0,m=0;for(m=0;m<256;m++)m<128?d[m]=m<<1:d[m]=m<<1^283;for(m=0;m<256;m++){let E=g^g<<1^g<<2^g<<3^g<<4;E=E>>>8^E&255^99,t[f]=E,e[E]=f;const p=d[f],I=d[p],C=d[I];let S=d[E]*257^E*16843008;i[f]=S<<24|S>>>8,n[f]=S<<16|S>>>16,r[f]=S<<8|S>>>24,a[f]=S,S=C*16843009^I*65537^p*257^f*16843008,l[E]=S<<24|S>>>8,h[E]=S<<16|S>>>16,A[E]=S<<8|S>>>24,u[E]=S,f?(f=p^d[d[d[C^p]]],g^=d[d[g]]):f=g=1}}expandKey(t){const e=this.uint8ArrayToUint32Array_(t);let s=!0,i=0;for(;i<e.length&&s;)s=e[i]===this.key[i],i++;if(s)return;this.key=e;const n=this.keySize=e.length;if(n!==4&&n!==6&&n!==8)throw new Error("Invalid aes key size="+n);const r=this.ksRows=(n+6+1)*4;let a,c;const l=this.keySchedule=new Uint32Array(r),h=this.invKeySchedule=new Uint32Array(r),A=this.sBox,u=this.rcon,d=this.invSubMix,f=d[0],g=d[1],m=d[2],E=d[3];let p,I;for(a=0;a<r;a++){if(a<n){p=l[a]=e[a];continue}I=p,a%n===0?(I=I<<8|I>>>24,I=A[I>>>24]<<24|A[I>>>16&255]<<16|A[I>>>8&255]<<8|A[I&255],I^=u[a/n|0]<<24):n>6&&a%n===4&&(I=A[I>>>24]<<24|A[I>>>16&255]<<16|A[I>>>8&255]<<8|A[I&255]),l[a]=p=(l[a-n]^I)>>>0}for(c=0;c<r;c++)a=r-c,c&3?I=l[a]:I=l[a-4],c<4||a<=4?h[c]=I:h[c]=f[A[I>>>24]]^g[A[I>>>16&255]]^m[A[I>>>8&255]]^E[A[I&255]],h[c]=h[c]>>>0}networkToHostOrderSwap(t){return t<<24|(t&65280)<<8|(t&16711680)>>8|t>>>24}decrypt(t,e,s){const i=this.keySize+6,n=this.invKeySchedule,r=this.invSBox,a=this.invSubMix,c=a[0],l=a[1],h=a[2],A=a[3],u=this.uint8ArrayToUint32Array_(s);let d=u[0],f=u[1],g=u[2],m=u[3];const E=new Int32Array(t),p=new Int32Array(E.length);let I,C,S,v,T,x,L,B,D,R,k,_,Q,F;const G=this.networkToHostOrderSwap;for(;e<E.length;){for(D=G(E[e]),R=G(E[e+1]),k=G(E[e+2]),_=G(E[e+3]),T=D^n[0],x=_^n[1],L=k^n[2],B=R^n[3],Q=4,F=1;F<i;F++)I=c[T>>>24]^l[x>>16&255]^h[L>>8&255]^A[B&255]^n[Q],C=c[x>>>24]^l[L>>16&255]^h[B>>8&255]^A[T&255]^n[Q+1],S=c[L>>>24]^l[B>>16&255]^h[T>>8&255]^A[x&255]^n[Q+2],v=c[B>>>24]^l[T>>16&255]^h[x>>8&255]^A[L&255]^n[Q+3],T=I,x=C,L=S,B=v,Q=Q+4;I=r[T>>>24]<<24^r[x>>16&255]<<16^r[L>>8&255]<<8^r[B&255]^n[Q],C=r[x>>>24]<<24^r[L>>16&255]<<16^r[B>>8&255]<<8^r[T&255]^n[Q+1],S=r[L>>>24]<<24^r[B>>16&255]<<16^r[T>>8&255]<<8^r[x&255]^n[Q+2],v=r[B>>>24]<<24^r[T>>16&255]<<16^r[x>>8&255]<<8^r[L&255]^n[Q+3],p[e]=G(I^d),p[e+1]=G(v^f),p[e+2]=G(S^g),p[e+3]=G(C^m),d=D,f=R,g=k,m=_,e=e+4}return p.buffer}}class ud{constructor(t,e,s){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=t,this.key=e,this.aesMode=s}expandKey(){const t=dd(this.aesMode);return this.subtle.importKey("raw",this.key,{name:t},!1,["encrypt","decrypt"])}}function dd(o){switch(o){case Fe.cbc:return"AES-CBC";case Fe.ctr:return"AES-CTR";default:throw new Error(`[FastAESKey] invalid aes mode ${o}`)}}const fd=16;class $r{constructor(t,{removePKCS7Padding:e=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=t.enableSoftwareAES,this.removePKCS7Padding=e,e)try{const s=self.crypto;s&&(this.subtle=s.subtle||s.webkitSubtle)}catch{}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:t,remainderData:e}=this;if(!t||e)return this.reset(),null;const s=new Uint8Array(t);return this.reset(),this.removePKCS7Padding?hd(s):s}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(t,e,s,i){return this.useSoftware?new Promise((n,r)=>{const a=ArrayBuffer.isView(t)?t:new Uint8Array(t);this.softwareDecrypt(a,e,s,i);const c=this.flush();c?n(c.buffer):r(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(t),e,s,i)}softwareDecrypt(t,e,s,i){const{currentIV:n,currentResult:r,remainderData:a}=this;if(i!==Fe.cbc||e.byteLength!==16)return nt.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),a&&(t=jt(a,t),this.remainderData=null);const c=this.getValidChunk(t);if(!c.length)return null;n&&(s=n);let l=this.softwareDecrypter;l||(l=this.softwareDecrypter=new Ad),l.expandKey(e);const h=r;return this.currentResult=l.decrypt(c.buffer,0,s),this.currentIV=c.slice(-16).buffer,h||null}webCryptoDecrypt(t,e,s,i){if(this.key!==e||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(t,e,s,i));this.key=e,this.fastAesKey=new ud(this.subtle,e,i)}return this.fastAesKey.expandKey().then(n=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new cd(this.subtle,new Uint8Array(s),i).decrypt(t.buffer,n)):Promise.reject(new Error("web crypto not initialized"))).catch(n=>(nt.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${n.name}: ${n.message}`),this.onWebCryptoError(t,e,s,i)))}onWebCryptoError(t,e,s,i){const n=this.enableSoftwareAES;if(n){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(t,e,s,i);const r=this.flush();if(r)return r.buffer}throw new Error("WebCrypto"+(n?" and softwareDecrypt":"")+": failed to decrypt data")}getValidChunk(t){let e=t;const s=t.length-t.length%fd;return s!==t.length&&(e=t.slice(0,s),this.remainderData=t.slice(s)),e}logOnce(t){this.logEnabled&&(nt.log(`[decrypter]: ${t}`),this.logEnabled=!1)}}const Yo=Math.pow(2,17);class gd{constructor(t){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=t}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(t,e){const s=t.url;if(!s)return Promise.reject(new ye({type:V.NETWORK_ERROR,details:w.FRAG_LOAD_ERROR,fatal:!1,frag:t,error:new Error(`Fragment does not have a ${s?"part list":"url"}`),networkDetails:null}));this.abort();const i=this.config,n=i.fLoader,r=i.loader;return new Promise((a,c)=>{if(this.loader&&this.loader.destroy(),t.gap)if(t.tagList.some(f=>f[0]==="GAP")){c(Wo(t));return}else t.gap=!1;const l=this.loader=n?new n(i):new r(i),h=qo(t);t.loader=l;const A=Ho(i.fragLoadPolicy.default),u={loadPolicy:A,timeout:A.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:t.sn==="initSegment"?1/0:Yo};t.stats=l.stats;const d={onSuccess:(f,g,m,E)=>{this.resetLoader(t,l);let p=f.data;m.resetIV&&t.decryptdata&&(t.decryptdata.iv=new Uint8Array(p.slice(0,16)),p=p.slice(16)),a({frag:t,part:null,payload:p,networkDetails:E})},onError:(f,g,m,E)=>{this.resetLoader(t,l),c(new ye({type:V.NETWORK_ERROR,details:w.FRAG_LOAD_ERROR,fatal:!1,frag:t,response:it({url:s,data:void 0},f),error:new Error(`HTTP Error ${f.code} ${f.text}`),networkDetails:m,stats:E}))},onAbort:(f,g,m)=>{this.resetLoader(t,l),c(new ye({type:V.NETWORK_ERROR,details:w.INTERNAL_ABORTED,fatal:!1,frag:t,error:new Error("Aborted"),networkDetails:m,stats:f}))},onTimeout:(f,g,m)=>{this.resetLoader(t,l),c(new ye({type:V.NETWORK_ERROR,details:w.FRAG_LOAD_TIMEOUT,fatal:!1,frag:t,error:new Error(`Timeout after ${u.timeout}ms`),networkDetails:m,stats:f}))}};e&&(d.onProgress=(f,g,m,E)=>e({frag:t,part:null,payload:m,networkDetails:E})),l.load(h,u,d)})}loadPart(t,e,s){this.abort();const i=this.config,n=i.fLoader,r=i.loader;return new Promise((a,c)=>{if(this.loader&&this.loader.destroy(),t.gap||e.gap){c(Wo(t,e));return}const l=this.loader=n?new n(i):new r(i),h=qo(t,e);t.loader=l;const A=Ho(i.fragLoadPolicy.default),u={loadPolicy:A,timeout:A.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:Yo};e.stats=l.stats,l.load(h,u,{onSuccess:(d,f,g,m)=>{this.resetLoader(t,l),this.updateStatsFromPart(t,e);const E={frag:t,part:e,payload:d.data,networkDetails:m};s(E),a(E)},onError:(d,f,g,m)=>{this.resetLoader(t,l),c(new ye({type:V.NETWORK_ERROR,details:w.FRAG_LOAD_ERROR,fatal:!1,frag:t,part:e,response:it({url:h.url,data:void 0},d),error:new Error(`HTTP Error ${d.code} ${d.text}`),networkDetails:g,stats:m}))},onAbort:(d,f,g)=>{t.stats.aborted=e.stats.aborted,this.resetLoader(t,l),c(new ye({type:V.NETWORK_ERROR,details:w.INTERNAL_ABORTED,fatal:!1,frag:t,part:e,error:new Error("Aborted"),networkDetails:g,stats:d}))},onTimeout:(d,f,g)=>{this.resetLoader(t,l),c(new ye({type:V.NETWORK_ERROR,details:w.FRAG_LOAD_TIMEOUT,fatal:!1,frag:t,part:e,error:new Error(`Timeout after ${u.timeout}ms`),networkDetails:g,stats:d}))}})})}updateStatsFromPart(t,e){const s=t.stats,i=e.stats,n=i.total;if(s.loaded+=i.loaded,n){const c=Math.round(t.duration/e.duration),l=Math.min(Math.round(s.loaded/n),c),A=(c-l)*Math.round(s.loaded/l);s.total=s.loaded+A}else s.total=Math.max(s.loaded,s.total);const r=s.loading,a=i.loading;r.start?r.first+=a.first-a.start:(r.start=a.start,r.first=a.first),r.end=a.end}resetLoader(t,e){t.loader=null,this.loader===e&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),e.destroy()}}function qo(o,t=null){const e=t||o,s={frag:o,part:t,responseType:"arraybuffer",url:e.url,headers:{},rangeStart:0,rangeEnd:0},i=e.byteRangeStartOffset,n=e.byteRangeEndOffset;if(K(i)&&K(n)){var r;let a=i,c=n;if(o.sn==="initSegment"&&md((r=o.decryptdata)==null?void 0:r.method)){const l=n-i;l%16&&(c=n+(16-l%16)),i!==0&&(s.resetIV=!0,a=i-16)}s.rangeStart=a,s.rangeEnd=c}return s}function Wo(o,t){const e=new Error(`GAP ${o.gap?"tag":"attribute"} found`),s={type:V.MEDIA_ERROR,details:w.FRAG_GAP,fatal:!1,frag:o,error:e,networkDetails:null};return t&&(s.part=t),(t||o).stats.aborted=!0,new ye(s)}function md(o){return o==="AES-128"||o==="AES-256"}class ye extends Error{constructor(t){super(t.error.message),this.data=void 0,this.data=t}}class ic extends zt{constructor(t,e){super(t,e),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(t){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,t),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}class Hr{constructor(t,e,s,i=0,n=-1,r=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=ni(),this.buffering={audio:ni(),video:ni(),audiovideo:ni()},this.level=t,this.sn=e,this.id=s,this.size=i,this.part=n,this.partial=r}}function ni(){return{start:0,executeStart:0,executeEnd:0,end:0}}const Jo={length:0,start:()=>0,end:()=>0};class j{static isBuffered(t,e){if(t){const s=j.getBuffered(t);for(let i=s.length;i--;)if(e>=s.start(i)&&e<=s.end(i))return!0}return!1}static bufferedRanges(t){if(t){const e=j.getBuffered(t);return j.timeRangesToArray(e)}return[]}static timeRangesToArray(t){const e=[];for(let s=0;s<t.length;s++)e.push({start:t.start(s),end:t.end(s)});return e}static bufferInfo(t,e,s){if(t){const i=j.bufferedRanges(t);if(i.length)return j.bufferedInfo(i,e,s)}return{len:0,start:e,end:e,bufferedIndex:-1}}static bufferedInfo(t,e,s){e=Math.max(0,e),t.length>1&&t.sort((h,A)=>h.start-A.start||A.end-h.end);let i=-1,n=[];if(s)for(let h=0;h<t.length;h++){e>=t[h].start&&e<=t[h].end&&(i=h);const A=n.length;if(A){const u=n[A-1].end;t[h].start-u<s?t[h].end>u&&(n[A-1].end=t[h].end):n.push(t[h])}else n.push(t[h])}else n=t;let r=0,a,c=e,l=e;for(let h=0;h<n.length;h++){const A=n[h].start,u=n[h].end;if(i===-1&&e>=A&&e<=u&&(i=h),e+s>=A&&e<u)c=A,l=u,r=l-e;else if(e+s<A){a=A;break}}return{len:r,start:c||0,end:l||0,nextStart:a,buffered:t,bufferedIndex:i}}static getBuffered(t){try{return t.buffered||Jo}catch(e){return nt.log("failed to get media.buffered",e),Jo}}}const nc=/\{\$([a-zA-Z0-9-_]+)\}/g;function jo(o){return nc.test(o)}function hr(o,t){if(o.variableList!==null||o.hasVariableRefs){const e=o.variableList;return t.replace(nc,s=>{const i=s.substring(2,s.length-1),n=e?.[i];return n===void 0?(o.playlistParsingError||(o.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${i}"`)),s):n})}return t}function Xo(o,t,e){let s=o.variableList;s||(o.variableList=s={});let i,n;if("QUERYPARAM"in t){i=t.QUERYPARAM;try{const r=new self.URL(e).searchParams;if(r.has(i))n=r.get(i);else throw new Error(`"${i}" does not match any query parameter in URI: "${e}"`)}catch(r){o.playlistParsingError||(o.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${r.message}`))}}else i=t.NAME,n=t.VALUE;i in s?o.playlistParsingError||(o.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${i}"`)):s[i]=n||""}function pd(o,t,e){const s=t.IMPORT;if(e&&s in e){let i=o.variableList;i||(o.variableList=i={}),i[s]=e[s]}else o.playlistParsingError||(o.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${s}"`))}const Ed=/^(\d+)x(\d+)$/,zo=/(.+?)=(".*?"|.*?)(?:,|$)/g;class ct{constructor(t,e){typeof t=="string"&&(t=ct.parseAttrList(t,e)),rt(this,t)}get clientAttrs(){return Object.keys(this).filter(t=>t.substring(0,2)==="X-")}decimalInteger(t){const e=parseInt(this[t],10);return e>Number.MAX_SAFE_INTEGER?1/0:e}hexadecimalInteger(t){if(this[t]){let e=(this[t]||"0x").slice(2);e=(e.length&1?"0":"")+e;const s=new Uint8Array(e.length/2);for(let i=0;i<e.length/2;i++)s[i]=parseInt(e.slice(i*2,i*2+2),16);return s}return null}hexadecimalIntegerAsNumber(t){const e=parseInt(this[t],16);return e>Number.MAX_SAFE_INTEGER?1/0:e}decimalFloatingPoint(t){return parseFloat(this[t])}optionalFloat(t,e){const s=this[t];return s?parseFloat(s):e}enumeratedString(t){return this[t]}enumeratedStringList(t,e){const s=this[t];return(s?s.split(/[ ,]+/):[]).reduce((i,n)=>(i[n.toLowerCase()]=!0,i),e)}bool(t){return this[t]==="YES"}decimalResolution(t){const e=Ed.exec(this[t]);if(e!==null)return{width:parseInt(e[1],10),height:parseInt(e[2],10)}}static parseAttrList(t,e){let s;const i={};for(zo.lastIndex=0;(s=zo.exec(t))!==null;){const r=s[1].trim();let a=s[2];const c=a.indexOf('"')===0&&a.lastIndexOf('"')===a.length-1;let l=!1;if(c)a=a.slice(1,-1);else switch(r){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":l=!0}if(e&&(c||l))a=hr(e,a);else if(!l&&!c)switch(r){case"CLOSED-CAPTIONS":if(a==="NONE")break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":nt.warn(`${t}: attribute ${r} is missing quotes`)}i[r]=a}return i}}const Id="com.apple.hls.interstitial";function yd(o){return o!=="ID"&&o!=="CLASS"&&o!=="CUE"&&o!=="START-DATE"&&o!=="DURATION"&&o!=="END-DATE"&&o!=="END-ON-NEXT"}function Cd(o){return o==="SCTE35-OUT"||o==="SCTE35-IN"||o==="SCTE35-CMD"}class rc{constructor(t,e,s=0){var i;if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=e?.tagAnchor||null,this.tagOrder=(i=e?.tagOrder)!=null?i:s,e){const n=e.attr;for(const r in n)if(Object.prototype.hasOwnProperty.call(t,r)&&t[r]!==n[r]){nt.warn(`DATERANGE tag attribute: "${r}" does not match for tags with ID: "${t.ID}"`),this._badValueForSameId=r;break}t=rt(new ct({}),n,t)}if(this.attr=t,e?(this._startDate=e._startDate,this._cue=e._cue,this._endDate=e._endDate,this._dateAtEnd=e._dateAtEnd):this._startDate=new Date(t["START-DATE"]),"END-DATE"in this.attr){const n=e?.endDate||new Date(this.attr["END-DATE"]);K(n.getTime())&&(this._endDate=n)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){const t=this._cue;return t===void 0?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):t}get startTime(){const{tagAnchor:t}=this;return t===null||t.programDateTime===null?(nt.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${t}`),NaN):t.start+(this.startDate.getTime()-t.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){const t=this._endDate||this._dateAtEnd;if(t)return t;const e=this.duration;return e!==null?this._dateAtEnd=new Date(this._startDate.getTime()+e*1e3):null}get duration(){if("DURATION"in this.attr){const t=this.attr.decimalFloatingPoint("DURATION");if(K(t))return t}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isInterstitial(){return this.class===Id}get isValid(){return!!this.id&&!this._badValueForSameId&&K(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}const Sd=10;class Td{constructor(t){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.dateRangeTagCount=0,this.live=!0,this.requestScheduled=-1,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.appliedTimelineOffset=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=t}reloaded(t){if(!t){this.advanced=!0,this.updated=!0;return}const e=this.lastPartSn-t.lastPartSn,s=this.lastPartIndex-t.lastPartIndex;this.updated=this.endSN!==t.endSN||!!s||!!e||!this.live,this.advanced=this.endSN>t.endSN||e>0||e===0&&s>0,this.updated||this.advanced?this.misses=Math.floor(t.misses*.6):this.misses=t.misses+1}hasKey(t){return this.encryptedFragments.some(e=>{let s=e.decryptdata;return s||(e.setKeyFormat(t.keyFormat),s=e.decryptdata),!!s&&t.matches(s)})}get hasProgramDateTime(){return this.fragments.length?K(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||Sd}get drift(){const t=this.driftEndTime-this.driftStartTime;return t>0?(this.driftEnd-this.driftStart)*1e3/t:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var t;return(t=this.partList)!=null&&t.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){return this.fragments.length?this.fragments[this.fragments.length-1].end:0}get fragmentStart(){return this.fragments.length?this.fragments[0].start:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var t;return(t=this.partList)!=null&&t.length?this.partList[this.partList.length-1].index:-1}get maxPartIndex(){const t=this.partList;if(t){const e=this.lastPartIndex;if(e!==-1){for(let s=t.length;s--;)if(t[s].index>e)return t[s].index;return e}}return 0}get lastPartSn(){var t;return(t=this.partList)!=null&&t.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}get expired(){if(this.live&&this.age&&this.misses<3){const t=this.partEnd-this.fragmentStart;return this.age>Math.max(t,this.totalduration)+this.levelTargetDuration}return!1}}function Xi(o,t){return o.length===t.length?!o.some((e,s)=>e!==t[s]):!1}function Zo(o,t){return!o&&!t?!0:!o||!t?!1:Xi(o,t)}function ps(o){return o==="AES-128"||o==="AES-256"||o==="AES-256-CTR"}function Vr(o){switch(o){case"AES-128":case"AES-256":return Fe.cbc;case"AES-256-CTR":return Fe.ctr;default:throw new Error(`invalid full segment method ${o}`)}}function Yr(o){return Uint8Array.from(atob(o),t=>t.charCodeAt(0))}function Ar(o){return Uint8Array.from(unescape(encodeURIComponent(o)),t=>t.charCodeAt(0))}function Bd(o){const t=Ar(o).subarray(0,16),e=new Uint8Array(16);return e.set(t,16-t.length),e}function oc(o){const t=function(s,i,n){const r=s[i];s[i]=s[n],s[n]=r};t(o,0,3),t(o,1,2),t(o,4,5),t(o,6,7)}function ac(o){const t=o.split(":");let e=null;if(t[0]==="data"&&t.length===2){const s=t[1].split(";"),i=s[s.length-1].split(",");if(i.length===2){const n=i[0]==="base64",r=i[1];n?(s.splice(-1,1),e=Yr(r)):e=Bd(r)}}return e}const zi=typeof self<"u"?self:void 0;var At={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},Dt={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function Fi(o){switch(o){case Dt.FAIRPLAY:return At.FAIRPLAY;case Dt.PLAYREADY:return At.PLAYREADY;case Dt.WIDEVINE:return At.WIDEVINE;case Dt.CLEARKEY:return At.CLEARKEY}}function mn(o){switch(o){case At.FAIRPLAY:return Dt.FAIRPLAY;case At.PLAYREADY:return Dt.PLAYREADY;case At.WIDEVINE:return Dt.WIDEVINE;case At.CLEARKEY:return Dt.CLEARKEY}}function Ms(o){const{drmSystems:t,widevineLicenseUrl:e}=o,s=t?[At.FAIRPLAY,At.WIDEVINE,At.PLAYREADY,At.CLEARKEY].filter(i=>!!t[i]):[];return!s[At.WIDEVINE]&&e&&s.push(At.WIDEVINE),s}const lc=(function(o){return zi!=null&&(o=zi.navigator)!=null&&o.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null})();function xd(o,t,e,s){let i;switch(o){case At.FAIRPLAY:i=["cenc","sinf"];break;case At.WIDEVINE:case At.PLAYREADY:i=["cenc"];break;case At.CLEARKEY:i=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${o}`)}return vd(i,t,e,s)}function vd(o,t,e,s){return[{initDataTypes:o,persistentState:s.persistentState||"optional",distinctiveIdentifier:s.distinctiveIdentifier||"optional",sessionTypes:s.sessionTypes||[s.sessionType||"temporary"],audioCapabilities:t.map(n=>({contentType:`audio/mp4; codecs=${n}`,robustness:s.audioRobustness||"",encryptionScheme:s.audioEncryptionScheme||null})),videoCapabilities:e.map(n=>({contentType:`video/mp4; codecs=${n}`,robustness:s.videoRobustness||"",encryptionScheme:s.videoEncryptionScheme||null}))}]}function Ld(o){var t;return!!o&&(o.sessionType==="persistent-license"||!!((t=o.sessionTypes)!=null&&t.some(e=>e==="persistent-license")))}function cc(o){const t=new Uint16Array(o.buffer,o.byteOffset,o.byteLength/2),e=String.fromCharCode.apply(null,Array.from(t)),s=e.substring(e.indexOf("<"),e.length),r=new DOMParser().parseFromString(s,"text/xml").getElementsByTagName("KID")[0];if(r){const a=r.childNodes[0]?r.childNodes[0].nodeValue:r.getAttribute("VALUE");if(a){const c=Yr(a).subarray(0,16);return oc(c),c}}return null}let ze={};class we{static clearKeyUriToKeyIdMap(){ze={}}static setKeyIdForUri(t,e){ze[t]=e}static addKeyIdForUri(t){const e=Object.keys(ze).length%Number.MAX_SAFE_INTEGER,s=new Uint8Array(16);return new DataView(s.buffer,12,4).setUint32(0,e),ze[t]=s,s}constructor(t,e,s,i=[1],n=null,r){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=t,this.uri=e,this.keyFormat=s,this.keyFormatVersions=i,this.iv=n,this.encrypted=t?t!=="NONE":!1,this.isCommonEncryption=this.encrypted&&!ps(t),r!=null&&r.startsWith("0x")&&(this.keyId=new Uint8Array(Ml(r)))}matches(t){return t.uri===this.uri&&t.method===this.method&&t.encrypted===this.encrypted&&t.keyFormat===this.keyFormat&&Xi(t.keyFormatVersions,this.keyFormatVersions)&&Zo(t.iv,this.iv)&&Zo(t.keyId,this.keyId)}isSupported(){if(this.method){if(ps(this.method)||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case Dt.FAIRPLAY:case Dt.WIDEVINE:case Dt.PLAYREADY:case Dt.CLEARKEY:return["SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(t,e){if(!this.encrypted||!this.uri)return null;if(ps(this.method)){let n=this.iv;return n||(typeof t!="number"&&(nt.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),t=0),n=Rd(t)),new we(this.method,this.uri,"identity",this.keyFormatVersions,n)}if(this.keyId){const n=ze[this.uri];if(n&&!Xi(this.keyId,n)&&we.setKeyIdForUri(this.uri,this.keyId),this.pssh)return this}const s=ac(this.uri);if(s)switch(this.keyFormat){case Dt.WIDEVINE:if(this.pssh=s,!this.keyId){const n=ku(s.buffer);if(n.length){var i;const r=n[0];this.keyId=(i=r.kids)!=null&&i.length?r.kids[0]:null}}this.keyId||(this.keyId=ta(e));break;case Dt.PLAYREADY:{const n=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=wu(n,null,s),this.keyId=cc(s);break}default:{let n=s.subarray(0,16);if(n.length!==16){const r=new Uint8Array(16);r.set(n,16-n.length),n=r}this.keyId=n;break}}if(!this.keyId||this.keyId.byteLength!==16){let n;n=Dd(e),n||(n=ta(e),n||(n=ze[this.uri])),n&&(this.keyId=n,we.setKeyIdForUri(this.uri,n))}return this}}function Dd(o){const t=o?.[Dt.WIDEVINE];return t?t.keyId:null}function ta(o){const t=o?.[Dt.PLAYREADY];if(t){const e=ac(t.uri);if(e)return cc(e)}return null}function Rd(o){const t=new Uint8Array(16);for(let e=12;e<16;e++)t[e]=o>>8*(15-e)&255;return t}const ea=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,sa=/#EXT-X-MEDIA:(.*)/g,bd=/^#EXT(?:INF|-X-TARGETDURATION):/m,pn=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#.*/.source].join("|"),"g"),wd=new RegExp([/#EXT-X-(PROGRAM-DATE-TIME|BYTERANGE|DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class ue{static findGroup(t,e){for(let s=0;s<t.length;s++){const i=t[s];if(i.id===e)return i}}static resolve(t,e){return Mr.buildAbsoluteURL(e,t,{alwaysNormalize:!0})}static isMediaPlaylist(t){return bd.test(t)}static parseMasterPlaylist(t,e){const s=jo(t),i={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:s},n=[];if(ea.lastIndex=0,!t.startsWith("#EXTM3U"))return i.playlistParsingError=new Error("no EXTM3U delimiter"),i;let r;for(;(r=ea.exec(t))!=null;)if(r[1]){var a;const l=new ct(r[1],i),h=hr(i,r[2]),A={attrs:l,bitrate:l.decimalInteger("BANDWIDTH")||l.decimalInteger("AVERAGE-BANDWIDTH"),name:l.NAME,url:ue.resolve(h,e)},u=l.decimalResolution("RESOLUTION");u&&(A.width=u.width,A.height=u.height),ra(l.CODECS,A);const d=l["SUPPLEMENTAL-CODECS"];d&&(A.supplemental={},ra(d,A.supplemental)),(a=A.unknownCodecs)!=null&&a.length||n.push(A),i.levels.push(A)}else if(r[3]){const l=r[3],h=r[4];switch(l){case"SESSION-DATA":{const A=new ct(h,i),u=A["DATA-ID"];u&&(i.sessionData===null&&(i.sessionData={}),i.sessionData[u]=A);break}case"SESSION-KEY":{const A=ia(h,e,i);A.encrypted&&A.isSupported()?(i.sessionKeys===null&&(i.sessionKeys=[]),i.sessionKeys.push(A)):nt.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${h}"`);break}case"DEFINE":{{const A=new ct(h,i);Xo(i,A,e)}break}case"CONTENT-STEERING":{const A=new ct(h,i);i.contentSteering={uri:ue.resolve(A["SERVER-URI"],e),pathwayId:A["PATHWAY-ID"]||"."};break}case"START":{i.startTimeOffset=na(h);break}}}const c=n.length>0&&n.length<i.levels.length;return i.levels=c?n:i.levels,i.levels.length===0&&(i.playlistParsingError=new Error("no levels found in manifest")),i}static parseMasterPlaylistMedia(t,e,s){let i;const n={},r=s.levels,a={AUDIO:r.map(l=>({id:l.attrs.AUDIO,audioCodec:l.audioCodec})),SUBTITLES:r.map(l=>({id:l.attrs.SUBTITLES,textCodec:l.textCodec})),"CLOSED-CAPTIONS":[]};let c=0;for(sa.lastIndex=0;(i=sa.exec(t))!==null;){const l=new ct(i[1],s),h=l.TYPE;if(h){const A=a[h],u=n[h]||[];n[h]=u;const d=l.LANGUAGE,f=l["ASSOC-LANGUAGE"],g=l.CHANNELS,m=l.CHARACTERISTICS,E=l["INSTREAM-ID"],p={attrs:l,bitrate:0,id:c++,groupId:l["GROUP-ID"]||"",name:l.NAME||d||"",type:h,default:l.bool("DEFAULT"),autoselect:l.bool("AUTOSELECT"),forced:l.bool("FORCED"),lang:d,url:l.URI?ue.resolve(l.URI,e):""};if(f&&(p.assocLang=f),g&&(p.channels=g),m&&(p.characteristics=m),E&&(p.instreamId=E),A!=null&&A.length){const I=ue.findGroup(A,p.groupId)||A[0];oa(p,I,"audioCodec"),oa(p,I,"textCodec")}u.push(p)}}return n}static parseLevelPlaylist(t,e,s,i,n,r){var a;const c={url:e},l=new Td(e),h=l.fragments,A=[];let u=null,d=0,f=0,g=0,m=0,E=0,p=null,I=new dn(i,c),C,S,v,T=-1,x=!1,L=null,B;if(pn.lastIndex=0,l.m3u8=t,l.hasVariableRefs=jo(t),((a=pn.exec(t))==null?void 0:a[0])!=="#EXTM3U")return l.playlistParsingError=new Error("Missing format identifier #EXTM3U"),l;for(;(C=pn.exec(t))!==null;){x&&(x=!1,I=new dn(i,c),I.playlistOffset=g,I.setStart(g),I.sn=d,I.cc=m,E&&(I.bitrate=E),I.level=s,u&&(I.initSegment=u,u.rawProgramDateTime&&(I.rawProgramDateTime=u.rawProgramDateTime,u.rawProgramDateTime=null),L&&(I.setByteRange(L),L=null)));const _=C[1];if(_){I.duration=parseFloat(_);const Q=(" "+C[2]).slice(1);I.title=Q||null,I.tagList.push(Q?["INF",_,Q]:["INF",_])}else if(C[3]){if(K(I.duration)){I.playlistOffset=g,I.setStart(g),v&&la(I,v,l),I.sn=d,I.level=s,I.cc=m,h.push(I);const Q=(" "+C[3]).slice(1);I.relurl=hr(l,Q),ur(I,p,A),p=I,g+=I.duration,d++,f=0,x=!0}}else{if(C=C[0].match(wd),!C){nt.warn("No matches on slow regex match for level playlist!");continue}for(S=1;S<C.length&&C[S]===void 0;S++);const Q=(" "+C[S]).slice(1),F=(" "+C[S+1]).slice(1),G=C[S+2]?(" "+C[S+2]).slice(1):null;switch(Q){case"BYTERANGE":p?I.setByteRange(F,p):I.setByteRange(F);break;case"PROGRAM-DATE-TIME":I.rawProgramDateTime=F,I.tagList.push(["PROGRAM-DATE-TIME",F]),T===-1&&(T=h.length);break;case"PLAYLIST-TYPE":l.type&&me(l,Q,C),l.type=F.toUpperCase();break;case"MEDIA-SEQUENCE":l.startSN!==0?me(l,Q,C):h.length>0&&ca(l,Q,C),d=l.startSN=parseInt(F);break;case"SKIP":{l.skippedSegments&&me(l,Q,C);const N=new ct(F,l),$=N.decimalInteger("SKIPPED-SEGMENTS");if(K($)){l.skippedSegments+=$;for(let M=$;M--;)h.push(null);d+=$}const Y=N.enumeratedString("RECENTLY-REMOVED-DATERANGES");Y&&(l.recentlyRemovedDateranges=(l.recentlyRemovedDateranges||[]).concat(Y.split("	")));break}case"TARGETDURATION":l.targetduration!==0&&me(l,Q,C),l.targetduration=Math.max(parseInt(F),1);break;case"VERSION":l.version!==null&&me(l,Q,C),l.version=parseInt(F);break;case"INDEPENDENT-SEGMENTS":break;case"ENDLIST":l.live||me(l,Q,C),l.live=!1;break;case"#":(F||G)&&I.tagList.push(G?[F,G]:[F]);break;case"DISCONTINUITY":m++,I.tagList.push(["DIS"]);break;case"GAP":I.gap=!0,I.tagList.push([Q]);break;case"BITRATE":I.tagList.push([Q,F]),E=parseInt(F)*1e3,K(E)?I.bitrate=E:E=0;break;case"DATERANGE":{const N=new ct(F,l),$=new rc(N,l.dateRanges[N.ID],l.dateRangeTagCount);l.dateRangeTagCount++,$.isValid||l.skippedSegments?l.dateRanges[$.id]=$:nt.warn(`Ignoring invalid DATERANGE tag: "${F}"`),I.tagList.push(["EXT-X-DATERANGE",F]);break}case"DEFINE":{{const N=new ct(F,l);"IMPORT"in N?pd(l,N,r):Xo(l,N,e)}break}case"DISCONTINUITY-SEQUENCE":l.startCC!==0?me(l,Q,C):h.length>0&&ca(l,Q,C),l.startCC=m=parseInt(F);break;case"KEY":{const N=ia(F,e,l);if(N.isSupported()){if(N.method==="NONE"){v=void 0;break}v||(v={});const $=v[N.keyFormat];$!=null&&$.matches(N)||($&&(v=rt({},v)),v[N.keyFormat]=N)}else nt.warn(`[Keys] Ignoring unsupported EXT-X-KEY tag: "${F}"`);break}case"START":l.startTimeOffset=na(F);break;case"MAP":{const N=new ct(F,l);if(I.duration){const $=new dn(i,c);aa($,N,s,v),u=$,I.initSegment=u,u.rawProgramDateTime&&!I.rawProgramDateTime&&(I.rawProgramDateTime=u.rawProgramDateTime)}else{const $=I.byteRangeEndOffset;if($){const Y=I.byteRangeStartOffset;L=`${$-Y}@${Y}`}else L=null;aa(I,N,s,v),u=I,x=!0}u.cc=m;break}case"SERVER-CONTROL":{B&&me(l,Q,C),B=new ct(F),l.canBlockReload=B.bool("CAN-BLOCK-RELOAD"),l.canSkipUntil=B.optionalFloat("CAN-SKIP-UNTIL",0),l.canSkipDateRanges=l.canSkipUntil>0&&B.bool("CAN-SKIP-DATERANGES"),l.partHoldBack=B.optionalFloat("PART-HOLD-BACK",0),l.holdBack=B.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{l.partTarget&&me(l,Q,C);const N=new ct(F);l.partTarget=N.decimalFloatingPoint("PART-TARGET");break}case"PART":{let N=l.partList;N||(N=l.partList=[]);const $=f>0?N[N.length-1]:void 0,Y=f++,M=new ct(F,l),O=new pu(M,I,c,Y,$);N.push(O),I.duration+=O.duration;break}case"PRELOAD-HINT":{const N=new ct(F,l);l.preloadHint=N;break}case"RENDITION-REPORT":{const N=new ct(F,l);l.renditionReports=l.renditionReports||[],l.renditionReports.push(N);break}default:nt.warn(`line parsed but not handled: ${C}`);break}}}p&&!p.relurl?(h.pop(),g-=p.duration,l.partList&&(l.fragmentHint=p)):l.partList&&(ur(I,p,A),I.cc=m,l.fragmentHint=I,v&&la(I,v,l)),l.targetduration||(l.playlistParsingError=new Error("Missing Target Duration"));const D=h.length,R=h[0],k=h[D-1];if(g+=l.skippedSegments*l.targetduration,g>0&&D&&k){l.averagetargetduration=g/D;const _=k.sn;l.endSN=_!=="initSegment"?_:0,l.live||(k.endList=!0),T>0&&(_d(h,T),R&&A.unshift(R))}return l.fragmentHint&&(g+=l.fragmentHint.duration),l.totalduration=g,A.length&&l.dateRangeTagCount&&R&&hc(A,l),l.endCC=m,l}}function hc(o,t){let e=o.length;if(!e)if(t.hasProgramDateTime){const a=t.fragments[t.fragments.length-1];o.push(a),e++}else return;const s=o[e-1],i=t.live?1/0:t.totalduration,n=Object.keys(t.dateRanges);for(let a=n.length;a--;){const c=t.dateRanges[n[a]],l=c.startDate.getTime();c.tagAnchor=s.ref;for(let h=e;h--;){var r;if(((r=o[h])==null?void 0:r.sn)<t.startSN)break;const A=kd(t,l,o,h,i);if(A!==-1){c.tagAnchor=t.fragments[A].ref;break}}}}function kd(o,t,e,s,i){const n=e[s];if(n){const a=n.programDateTime;if(t>=a||s===0){var r;const c=(((r=e[s+1])==null?void 0:r.start)||i)-n.start;if(t<=a+c*1e3){const l=e[s].sn-o.startSN;if(l<0)return-1;const h=o.fragments;if(h.length>e.length){const u=(e[s+1]||h[h.length-1]).sn-o.startSN;for(let d=u;d>l;d--){const f=h[d].programDateTime;if(t>=f&&t<f+h[d].duration*1e3)return d}}return l}}}return-1}function ia(o,t,e){var s,i;const n=new ct(o,e),r=(s=n.METHOD)!=null?s:"",a=n.URI,c=n.hexadecimalInteger("IV"),l=n.KEYFORMATVERSIONS,h=(i=n.KEYFORMAT)!=null?i:"identity";a&&n.IV&&!c&&nt.error(`Invalid IV: ${n.IV}`);const A=a?ue.resolve(a,t):"",u=(l||"1").split("/").map(Number).filter(Number.isFinite);return new we(r,A,h,u,c,n.KEYID)}function na(o){const e=new ct(o).decimalFloatingPoint("TIME-OFFSET");return K(e)?e:null}function ra(o,t){let e=(o||"").split(/[ ,]+/).filter(s=>s);["video","audio","text"].forEach(s=>{const i=e.filter(n=>Nr(n,s));i.length&&(t[`${s}Codec`]=i.map(n=>n.split("/")[0]).join(","),e=e.filter(n=>i.indexOf(n)===-1))}),t.unknownCodecs=e}function oa(o,t,e){const s=t[e];s&&(o[e]=s)}function _d(o,t){let e=o[t];for(let s=t;s--;){const i=o[s];if(!i)return;i.programDateTime=e.programDateTime-i.duration*1e3,e=i}}function ur(o,t,e){o.rawProgramDateTime?e.push(o):t!=null&&t.programDateTime&&(o.programDateTime=t.endProgramDateTime)}function aa(o,t,e,s){o.relurl=t.URI,t.BYTERANGE&&o.setByteRange(t.BYTERANGE),o.level=e,o.sn="initSegment",s&&(o.levelkeys=s),o.initSegment=null}function la(o,t,e){o.levelkeys=t;const{encryptedFragments:s}=e;(!s.length||s[s.length-1].levelkeys!==t)&&Object.keys(t).some(i=>t[i].isCommonEncryption)&&s.push(o)}function me(o,t,e){o.playlistParsingError=new Error(`#EXT-X-${t} must not appear more than once (${e[0]})`)}function ca(o,t,e){o.playlistParsingError=new Error(`#EXT-X-${t} must appear before the first Media Segment (${e[0]})`)}function En(o,t){const e=t.startPTS;if(K(e)){let s=0,i;t.sn>o.sn?(s=e-o.start,i=o):(s=o.start-e,i=t),i.duration!==s&&i.setDuration(s)}else t.sn>o.sn?o.cc===t.cc&&o.minEndPTS?t.setStart(o.start+(o.minEndPTS-o.start)):t.setStart(o.start+o.duration):t.setStart(Math.max(o.start-t.duration,0))}function Ac(o,t,e,s,i,n,r){s-e<=0&&(r.warn("Fragment should have a positive duration",t),s=e+t.duration,n=i+t.duration);let c=e,l=s;const h=t.startPTS,A=t.endPTS;if(K(h)){const E=Math.abs(h-e);o&&E>o.totalduration?r.warn(`media timestamps and playlist times differ by ${E}s for level ${t.level} ${o.url}`):K(t.deltaPTS)?t.deltaPTS=Math.max(E,t.deltaPTS):t.deltaPTS=E,c=Math.max(e,h),e=Math.min(e,h),i=t.startDTS!==void 0?Math.min(i,t.startDTS):i,l=Math.min(s,A),s=Math.max(s,A),n=t.endDTS!==void 0?Math.max(n,t.endDTS):n}const u=e-t.start;t.start!==0&&t.setStart(e),t.setDuration(s-t.start),t.startPTS=e,t.maxStartPTS=c,t.startDTS=i,t.endPTS=s,t.minEndPTS=l,t.endDTS=n;const d=t.sn;if(!o||d<o.startSN||d>o.endSN)return 0;let f;const g=d-o.startSN,m=o.fragments;for(m[g]=t,f=g;f>0;f--)En(m[f],m[f-1]);for(f=g;f<m.length-1;f++)En(m[f],m[f+1]);return o.fragmentHint&&En(m[m.length-1],o.fragmentHint),o.PTSKnown=o.alignedSliding=!0,u}function Pd(o,t,e){if(o===t)return;let s=null;const i=o.fragments;for(let h=i.length-1;h>=0;h--){const A=i[h].initSegment;if(A){s=A;break}}o.fragmentHint&&delete o.fragmentHint.endPTS;let n;Md(o,t,(h,A,u,d)=>{if((!t.startCC||t.skippedSegments)&&A.cc!==h.cc){const f=h.cc-A.cc;for(let g=u;g<d.length;g++)d[g].cc+=f;t.endCC=d[d.length-1].cc}K(h.startPTS)&&K(h.endPTS)&&(A.setStart(A.startPTS=h.startPTS),A.startDTS=h.startDTS,A.maxStartPTS=h.maxStartPTS,A.endPTS=h.endPTS,A.endDTS=h.endDTS,A.minEndPTS=h.minEndPTS,A.setDuration(h.endPTS-h.startPTS),A.duration&&(n=A),t.PTSKnown=t.alignedSliding=!0),h.hasStreams&&(A.elementaryStreams=h.elementaryStreams),A.loader=h.loader,h.hasStats&&(A.stats=h.stats),h.initSegment&&(A.initSegment=h.initSegment,s=h.initSegment)});const r=t.fragments,a=t.fragmentHint?r.concat(t.fragmentHint):r;if(s&&a.forEach(h=>{var A;h&&(!h.initSegment||h.initSegment.relurl===((A=s)==null?void 0:A.relurl))&&(h.initSegment=s)}),t.skippedSegments){if(t.deltaUpdateFailed=r.some(h=>!h),t.deltaUpdateFailed){e.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let h=t.skippedSegments;h--;)r.shift();t.startSN=r[0].sn}else{t.canSkipDateRanges&&(t.dateRanges=Fd(o.dateRanges,t,e));const h=o.fragments.filter(A=>A.rawProgramDateTime);if(o.hasProgramDateTime&&!t.hasProgramDateTime)for(let A=1;A<a.length;A++)a[A].programDateTime===null&&ur(a[A],a[A-1],h);hc(h,t)}t.endCC=r[r.length-1].cc}if(!t.startCC){var c;const h=fc(o,t.startSN-1);t.startCC=(c=h?.cc)!=null?c:r[0].cc}Qd(o.partList,t.partList,(h,A)=>{A.elementaryStreams=h.elementaryStreams,A.stats=h.stats}),n?Ac(t,n,n.startPTS,n.endPTS,n.startDTS,n.endDTS,e):uc(o,t),r.length&&(t.totalduration=t.edge-r[0].start),t.driftStartTime=o.driftStartTime,t.driftStart=o.driftStart;const l=t.advancedDateTime;if(t.advanced&&l){const h=t.edge;t.driftStart||(t.driftStartTime=l,t.driftStart=h),t.driftEndTime=l,t.driftEnd=h}else t.driftEndTime=o.driftEndTime,t.driftEnd=o.driftEnd,t.advancedDateTime=o.advancedDateTime;t.requestScheduled===-1&&(t.requestScheduled=o.requestScheduled)}function Fd(o,t,e){const{dateRanges:s,recentlyRemovedDateranges:i}=t,n=rt({},o);i&&i.forEach(c=>{delete n[c]});const a=Object.keys(n).length;return a?(Object.keys(s).forEach(c=>{const l=n[c],h=new rc(s[c].attr,l);h.isValid?(n[c]=h,l||(h.tagOrder+=a)):e.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${at(s[c].attr)}"`)}),n):s}function Qd(o,t,e){if(o&&t){let s=0;for(let i=0,n=o.length;i<=n;i++){const r=o[i],a=t[i+s];r&&a&&r.index===a.index&&r.fragment.sn===a.fragment.sn?e(r,a):s--}}}function Md(o,t,e){const s=t.skippedSegments,i=Math.max(o.startSN,t.startSN)-t.startSN,n=(o.fragmentHint?1:0)+(s?t.endSN:Math.min(o.endSN,t.endSN))-t.startSN,r=t.startSN-o.startSN,a=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,c=o.fragmentHint?o.fragments.concat(o.fragmentHint):o.fragments;for(let l=i;l<=n;l++){const h=c[r+l];let A=a[l];if(s&&!A&&h&&(A=t.fragments[l]=h),h&&A){e(h,A,l,a);const u=h.relurl,d=A.relurl;if(u&&Od(u,d)){t.playlistParsingError=ha(`media sequence mismatch ${A.sn}:`,o,t,h,A);return}else if(h.cc!==A.cc){t.playlistParsingError=ha(`discontinuity sequence mismatch (${h.cc}!=${A.cc})`,o,t,h,A);return}}}}function ha(o,t,e,s,i){return new Error(`${o} ${i.url}
Playlist starting @${t.startSN}
${t.m3u8}

Playlist starting @${e.startSN}
${e.m3u8}`)}function uc(o,t,e=!0){const s=t.startSN+t.skippedSegments-o.startSN,i=o.fragments,n=s>=0;let r=0;if(n&&s<i.length)r=i[s].start;else if(n&&t.startSN===o.endSN+1)r=o.fragmentEnd;else if(n&&e)r=o.fragmentStart+s*t.levelTargetDuration;else if(!t.skippedSegments&&t.fragmentStart===0)r=o.fragmentStart;else return;dr(t,r)}function dr(o,t){if(t){const e=o.fragments;for(let s=o.skippedSegments;s<e.length;s++)e[s].addStart(t);o.fragmentHint&&o.fragmentHint.addStart(t)}}function dc(o,t=1/0){let e=1e3*o.targetduration;if(o.updated){const s=o.fragments;if(s.length&&e*4>t){const n=s[s.length-1].duration*1e3;n<e&&(e=n)}}else e/=2;return Math.round(e)}function fc(o,t,e){if(!o)return null;let s=o.fragments[t-o.startSN];return s||(s=o.fragmentHint,s&&s.sn===t)?s:t<o.startSN&&e&&e.sn===t?e:null}function Aa(o,t,e){return o?gc(o.partList,t,e):null}function gc(o,t,e){if(o)for(let s=o.length;s--;){const i=o[s];if(i.index===e&&i.fragment.sn===t)return i}return null}function mc(o){o.forEach((t,e)=>{var s;(s=t.details)==null||s.fragments.forEach(i=>{i.level=e,i.initSegment&&(i.initSegment.level=e)})})}function Od(o,t){return o!==t&&t?ua(o)!==ua(t):!1}function ua(o){return o.replace(/\?[^?]*$/,"")}function Gs(o,t){for(let s=0,i=o.length;s<i;s++){var e;if(((e=o[s])==null?void 0:e.cc)===t)return o[s]}return null}function Ud(o,t){return!!(o&&t.startCC<o.endCC&&t.endCC>o.startCC)}function da(o,t){const e=o.start+t;o.startPTS=e,o.setStart(e),o.endPTS=e+o.duration}function pc(o,t){const e=t.fragments;for(let s=0,i=e.length;s<i;s++)da(e[s],o);t.fragmentHint&&da(t.fragmentHint,o),t.alignedSliding=!0}function Nd(o,t){o&&(Ec(t,o),t.alignedSliding||Zi(t,o),!t.alignedSliding&&!t.skippedSegments&&uc(o,t,!1))}function Ec(o,t){if(!Ud(t,o))return;const e=Math.min(t.endCC,o.endCC),s=Gs(t.fragments,e),i=Gs(o.fragments,e);if(!s||!i)return;nt.log(`Aligning playlist at start of dicontinuity sequence ${e}`);const n=s.start-i.start;pc(n,o)}function Zi(o,t){if(!o.hasProgramDateTime||!t.hasProgramDateTime)return;const e=o.fragments,s=t.fragments;if(!e.length||!s.length)return;let i,n;const r=Math.min(t.endCC,o.endCC);t.startCC<r&&o.startCC<r&&(i=Gs(s,r),n=Gs(e,r)),(!i||!n)&&(i=s[Math.floor(s.length/2)],n=Gs(e,i.cc)||e[Math.floor(e.length/2)]);const a=i.programDateTime,c=n.programDateTime;if(!a||!c)return;const l=(c-a)/1e3-(n.start-i.start);pc(l,o)}function _t(o,t,e){Ot(o,t,e),o.addEventListener(t,e)}function Ot(o,t,e){o.removeEventListener(t,e)}const Gd={toString:function(o){let t="";const e=o.length;for(let s=0;s<e;s++)t+=`[${o.start(s).toFixed(3)}-${o.end(s).toFixed(3)}]`;return t}},P={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class qr extends ic{constructor(t,e,s,i,n){super(i,t.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=P.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.loadingParts=!1,this.loopSn=void 0,this.onMediaSeeking=()=>{const{config:r,fragCurrent:a,media:c,mediaBuffer:l,state:h}=this,A=c?c.currentTime:0,u=j.bufferInfo(l||c,A,r.maxBufferHole),d=!u.len;if(this.log(`Media seeking to ${K(A)?A.toFixed(3):A}, state: ${h}, ${d?"out of":"in"} buffer`),this.state===P.ENDED)this.resetLoadingState();else if(a){const f=r.maxFragLookUpTolerance,g=a.start-f,m=a.start+a.duration+f;if(d||m<u.start||g>u.end){const E=A>m;(A<g||E)&&(E&&a.loader&&(this.log(`Cancelling fragment load for seek (sn: ${a.sn})`),a.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}if(c){this.fragmentTracker.removeFragmentsInRange(A,1/0,this.playlistType,!0);const f=this.lastCurrentTime;if(A>f&&(this.lastCurrentTime=A),!this.loadingParts){const g=Math.max(u.end,A),m=this.shouldLoadParts(this.getLevelDetails(),g);m&&(this.log(`LL-Part loading ON after seeking to ${A.toFixed(2)} with buffer @${g.toFixed(2)}`),this.loadingParts=m)}}this.hls.hasEnoughToStart||(this.log(`Setting ${d?"startPosition":"nextLoadPosition"} to ${A} for seek without enough to start`),this.nextLoadPosition=A,d&&(this.startPosition=A)),d&&this.state===P.IDLE&&this.tickImmediate()},this.onMediaEnded=()=>{this.log("setting startPosition to 0 because media ended"),this.startPosition=this.lastCurrentTime=0},this.playlistType=n,this.hls=t,this.fragmentLoader=new gd(t.config),this.keyLoader=s,this.fragmentTracker=e,this.config=t.config,this.decrypter=new $r(t.config)}registerListeners(){const{hls:t}=this;t.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:t}=this;t.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(y.ERROR,this.onError,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(t){}stopLoad(){if(this.state===P.STOPPED)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const t=this.fragCurrent;t!=null&&t.loader&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=P.STOPPED}get startPositionValue(){const{nextLoadPosition:t,startPosition:e}=this;return e===-1&&t?t:e}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}get inFlightFrag(){return{frag:this.fragCurrent,state:this.state}}_streamEnded(t,e){if(e.live||!this.media)return!1;const s=t.end||0,i=this.config.timelineOffset||0;if(s<=i)return!1;const n=t.buffered;this.config.maxBufferHole&&n&&n.length>1&&(t=j.bufferedInfo(n,t.start,0));const r=t.nextStart;if(r&&r>i&&r<e.edge||this.media.currentTime<t.start)return!1;const c=e.partList;if(c!=null&&c.length){const h=c[c.length-1];return j.isBuffered(this.media,h.start+h.duration/2)}const l=e.fragments[e.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(l)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null)return this.levelLastLoaded.details}get timelineOffset(){const t=this.config.timelineOffset;if(t){var e;return((e=this.getLevelDetails())==null?void 0:e.appliedTimelineOffset)||t}return 0}onMediaAttached(t,e){const s=this.media=this.mediaBuffer=e.media;_t(s,"seeking",this.onMediaSeeking),_t(s,"ended",this.onMediaEnded);const i=this.config;this.levels&&i.autoStartLoad&&this.state===P.STOPPED&&this.startLoad(i.startPosition)}onMediaDetaching(t,e){const s=!!e.transferMedia,i=this.media;if(i!==null){if(i.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),Ot(i,"seeking",this.onMediaSeeking),Ot(i,"ended",this.onMediaEnded),this.keyLoader&&!s&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,s){this.resetLoadingState(),this.resetTransmuxer();return}this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1}onError(t,e){}onManifestLoaded(t,e){this.startTimeOffset=e.startTimeOffset}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null}onHandlerDestroyed(){this.state=P.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(t,e,s){this.startFragRequested=!0,this._loadFragForPlayback(t,e,s)}_loadFragForPlayback(t,e,s){const i=n=>{const r=n.frag;if(this.fragContextChanged(r)){this.warn(`${r.type} sn: ${r.sn}${n.part?" part: "+n.part.index:""} of ${this.fragInfo(r,!1,n.part)}) was dropped during download.`),this.fragmentTracker.removeFragment(r);return}r.stats.chunkCount++,this._handleFragmentLoadProgress(n)};this._doFragLoad(t,e,s,i).then(n=>{if(!n)return;const r=this.state,a=n.frag;if(this.fragContextChanged(a)){(r===P.FRAG_LOADING||!this.fragCurrent&&r===P.PARSING)&&(this.fragmentTracker.removeFragment(a),this.state=P.IDLE);return}"payload"in n&&(this.log(`Loaded ${a.type} sn: ${a.sn} of ${this.playlistLabel()} ${a.level}`),this.hls.trigger(y.FRAG_LOADED,n)),this._handleFragmentLoadComplete(n)}).catch(n=>{this.state===P.STOPPED||this.state===P.ERROR||(this.warn(`Frag error: ${n?.message||n}`),this.resetFragmentLoading(t))})}clearTrackerIfNeeded(t){var e;const{fragmentTracker:s}=this;if(s.getState(t)===Et.APPENDING){const n=t.type,r=this.getFwdBufferInfo(this.mediaBuffer,n),a=Math.max(t.duration,r?r.len:this.config.maxBufferLength),c=this.backtrackFragment;((c?t.sn-c.sn:0)===1||this.reduceMaxBufferLength(a,t.duration))&&s.removeFragment(t)}else((e=this.mediaBuffer)==null?void 0:e.buffered.length)===0?s.removeAllFragments():s.hasParts(t.type)&&(s.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type}),s.getState(t)===Et.PARTIAL&&s.removeFragment(t))}checkLiveUpdate(t){if(t.updated&&!t.live){const e=t.fragments[t.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type})}t.fragments[0]||(t.deltaUpdateFailed=!0)}waitForLive(t){const e=t.details;return e?.live&&e.type!=="EVENT"&&(this.levelLastLoaded!==t||e.expired)}flushMainBuffer(t,e,s=null){if(!(t-e))return;const i={startOffset:t,endOffset:e,type:s};this.hls.trigger(y.BUFFER_FLUSHING,i)}_loadInitSegment(t,e){this._doFragLoad(t,e).then(s=>{const i=s?.frag;if(!i||this.fragContextChanged(i)||!this.levels)throw new Error("init load aborted");return s}).then(s=>{const{hls:i}=this,{frag:n,payload:r}=s,a=n.decryptdata;if(r&&r.byteLength>0&&a!=null&&a.key&&a.iv&&ps(a.method)){const c=self.performance.now();return this.decrypter.decrypt(new Uint8Array(r),a.key.buffer,a.iv.buffer,Vr(a.method)).catch(l=>{throw i.trigger(y.ERROR,{type:V.MEDIA_ERROR,details:w.FRAG_DECRYPT_ERROR,fatal:!1,error:l,reason:l.message,frag:n}),l}).then(l=>{const h=self.performance.now();return i.trigger(y.FRAG_DECRYPTED,{frag:n,payload:l,stats:{tstart:c,tdecrypt:h}}),s.payload=l,this.completeInitSegmentLoad(s)})}return this.completeInitSegmentLoad(s)}).catch(s=>{this.state===P.STOPPED||this.state===P.ERROR||(this.warn(s),this.resetFragmentLoading(t))})}completeInitSegmentLoad(t){const{levels:e}=this;if(!e)throw new Error("init load aborted, missing levels");const s=t.frag.stats;this.state!==P.STOPPED&&(this.state=P.IDLE),t.frag.data=new Uint8Array(t.payload),s.parsing.start=s.buffering.start=self.performance.now(),s.parsing.end=s.buffering.end=self.performance.now(),this.tick()}unhandledEncryptionError(t,e){var s,i;const n=t.tracks;if(n&&!e.encrypted&&((s=n.audio)!=null&&s.encrypted||(i=n.video)!=null&&i.encrypted)&&(!this.config.emeEnabled||!this.keyLoader.emeController)){const r=this.media,a=new Error(`Encrypted track with no key in ${this.fragInfo(e)} (media ${r?"attached mediaKeys: "+r.mediaKeys:"detached"})`);return this.warn(a.message),!r||r.mediaKeys?!1:(this.hls.trigger(y.ERROR,{type:V.KEY_SYSTEM_ERROR,details:w.KEY_SYSTEM_NO_KEYS,fatal:!1,error:a,frag:e}),this.resetTransmuxer(),!0)}return!1}fragContextChanged(t){const{fragCurrent:e}=this;return!t||!e||t.sn!==e.sn||t.level!==e.level}fragBufferedComplete(t,e){const s=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${t.type} sn: ${t.sn}${e?" part: "+e.index:""} of ${this.fragInfo(t,!1,e)} > buffer:${s?Gd.toString(j.getBuffered(s)):"(detached)"})`),dt(t)){var i;if(t.type!==H.SUBTITLE){const r=t.elementaryStreams;if(!Object.keys(r).some(a=>!!r[a])){this.state=P.IDLE;return}}const n=(i=this.levels)==null?void 0:i[t.level];n!=null&&n.fragmentError&&(this.log(`Resetting level fragment error count of ${n.fragmentError} on frag buffered`),n.fragmentError=0)}this.state=P.IDLE}_handleFragmentLoadComplete(t){const{transmuxer:e}=this;if(!e)return;const{frag:s,part:i,partsLoaded:n}=t,r=!n||n.length===0||n.some(c=>!c),a=new Hr(s.level,s.sn,s.stats.chunkCount+1,0,i?i.index:-1,!r);e.flush(a)}_handleFragmentLoadProgress(t){}_doFragLoad(t,e,s=null,i){var n;this.fragCurrent=t;const r=e.details;if(!this.levels||!r)throw new Error(`frag load aborted, missing level${r?"":" detail"}s`);let a=null;if(t.encrypted&&!((n=t.decryptdata)!=null&&n.key)){if(this.log(`Loading key for ${t.sn} of [${r.startSN}-${r.endSN}], ${this.playlistLabel()} ${t.level}`),this.state=P.KEY_LOADING,this.fragCurrent=t,a=this.keyLoader.load(t).then(u=>{if(!this.fragContextChanged(u.frag))return this.hls.trigger(y.KEY_LOADED,u),this.state===P.KEY_LOADING&&(this.state=P.IDLE),u}),this.hls.trigger(y.KEY_LOADING,{frag:t}),this.fragCurrent===null)return this.log("context changed in KEY_LOADING"),Promise.resolve(null)}else t.encrypted||(a=this.keyLoader.loadClear(t,r.encryptedFragments,this.startFragRequested),a&&this.log("[eme] blocking frag load until media-keys acquired"));const c=this.fragPrevious;if(dt(t)&&(!c||t.sn!==c.sn)){const u=this.shouldLoadParts(e.details,t.end);u!==this.loadingParts&&(this.log(`LL-Part loading ${u?"ON":"OFF"} loading sn ${c?.sn}->${t.sn}`),this.loadingParts=u)}if(s=Math.max(t.start,s||0),this.loadingParts&&dt(t)){const u=r.partList;if(u&&i){s>r.fragmentEnd&&r.fragmentHint&&(t=r.fragmentHint);const d=this.getNextPart(u,t,s);if(d>-1){const f=u[d];t=this.fragCurrent=f.fragment,this.log(`Loading ${t.type} sn: ${t.sn} part: ${f.index} (${d}/${u.length-1}) of ${this.fragInfo(t,!1,f)}) cc: ${t.cc} [${r.startSN}-${r.endSN}], target: ${parseFloat(s.toFixed(3))}`),this.nextLoadPosition=f.start+f.duration,this.state=P.FRAG_LOADING;let g;return a?g=a.then(m=>!m||this.fragContextChanged(m.frag)?null:this.doFragPartsLoad(t,f,e,i)).catch(m=>this.handleFragLoadError(m)):g=this.doFragPartsLoad(t,f,e,i).catch(m=>this.handleFragLoadError(m)),this.hls.trigger(y.FRAG_LOADING,{frag:t,part:f,targetBufferTime:s}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):g}else if(!t.url||this.loadedEndOfParts(u,s))return Promise.resolve(null)}}if(dt(t)&&this.loadingParts){var l;this.log(`LL-Part loading OFF after next part miss @${s.toFixed(2)} Check buffer at sn: ${t.sn} loaded parts: ${(l=r.partList)==null?void 0:l.filter(u=>u.loaded).map(u=>`[${u.start}-${u.end}]`)}`),this.loadingParts=!1}else if(!t.url)return Promise.resolve(null);this.log(`Loading ${t.type} sn: ${t.sn} of ${this.fragInfo(t,!1)}) cc: ${t.cc} ${"["+r.startSN+"-"+r.endSN+"]"}, target: ${parseFloat(s.toFixed(3))}`),K(t.sn)&&!this.bitrateTest&&(this.nextLoadPosition=t.start+t.duration),this.state=P.FRAG_LOADING;const h=this.config.progressive&&t.type!==H.SUBTITLE;let A;return h&&a?A=a.then(u=>!u||this.fragContextChanged(u.frag)?null:this.fragmentLoader.load(t,i)).catch(u=>this.handleFragLoadError(u)):A=Promise.all([this.fragmentLoader.load(t,h?i:void 0),a]).then(([u])=>(!h&&i&&i(u),u)).catch(u=>this.handleFragLoadError(u)),this.hls.trigger(y.FRAG_LOADING,{frag:t,targetBufferTime:s}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):A}doFragPartsLoad(t,e,s,i){return new Promise((n,r)=>{var a;const c=[],l=(a=s.details)==null?void 0:a.partList,h=A=>{this.fragmentLoader.loadPart(t,A,i).then(u=>{c[A.index]=u;const d=u.part;this.hls.trigger(y.FRAG_LOADED,u);const f=Aa(s.details,t.sn,A.index+1)||gc(l,t.sn,A.index+1);if(f)h(f);else return n({frag:t,part:d,partsLoaded:c})}).catch(r)};h(e)})}handleFragLoadError(t){if("data"in t){const e=t.data;e.frag&&e.details===w.INTERNAL_ABORTED?this.handleFragLoadAborted(e.frag,e.part):e.frag&&e.type===V.KEY_SYSTEM_ERROR?(e.frag.abortRequests(),this.resetStartWhenNotLoaded(),this.resetFragmentLoading(e.frag)):this.hls.trigger(y.ERROR,e)}else this.hls.trigger(y.ERROR,{type:V.OTHER_ERROR,details:w.INTERNAL_EXCEPTION,err:t,error:t,fatal:!0});return null}_handleTransmuxerFlush(t){const e=this.getCurrentContext(t);if(!e||this.state!==P.PARSING){!this.fragCurrent&&this.state!==P.STOPPED&&this.state!==P.ERROR&&(this.state=P.IDLE);return}const{frag:s,part:i,level:n}=e,r=self.performance.now();s.stats.parsing.end=r,i&&(i.stats.parsing.end=r);const a=this.getLevelDetails(),l=a&&s.sn>a.endSN||this.shouldLoadParts(a,s.end);l!==this.loadingParts&&(this.log(`LL-Part loading ${l?"ON":"OFF"} after parsing segment ending @${s.end.toFixed(2)}`),this.loadingParts=l),this.updateLevelTiming(s,i,n,t.partial)}shouldLoadParts(t,e){if(this.config.lowLatencyMode){if(!t)return this.loadingParts;if(t.partList){var s;const n=t.partList[0];if(n.fragment.type===H.SUBTITLE)return!1;const r=n.end+(((s=t.fragmentHint)==null?void 0:s.duration)||0);if(e>=r){var i;if((this.hls.hasEnoughToStart?((i=this.media)==null?void 0:i.currentTime)||this.lastCurrentTime:this.getLoadPosition())>n.start-n.fragment.duration)return!0}}}return!1}getCurrentContext(t){const{levels:e,fragCurrent:s}=this,{level:i,sn:n,part:r}=t;if(!(e!=null&&e[i]))return this.warn(`Levels object was unset while buffering fragment ${n} of ${this.playlistLabel()} ${i}. The current chunk will not be buffered.`),null;const a=e[i],c=a.details,l=r>-1?Aa(c,n,r):null,h=l?l.fragment:fc(c,n,s);return h?(s&&s!==h&&(h.stats=s.stats),{frag:h,part:l,level:a}):null}bufferFragmentData(t,e,s,i,n){if(this.state!==P.PARSING)return;const{data1:r,data2:a}=t;let c=r;if(a&&(c=jt(r,a)),!c.length)return;const l=this.initPTS[e.cc],h=l?-l.baseTime/l.timescale:void 0,A={type:t.type,frag:e,part:s,chunkMeta:i,offset:h,parent:e.type,data:c};if(this.hls.trigger(y.BUFFER_APPENDING,A),t.dropped&&t.independent&&!s){if(n)return;this.flushBufferGap(e)}}flushBufferGap(t){const e=this.media;if(!e)return;if(!j.isBuffered(e,e.currentTime)){this.flushMainBuffer(0,t.start);return}const s=e.currentTime,i=j.bufferInfo(e,s,0),n=t.duration,r=Math.min(this.config.maxFragLookUpTolerance*2,n*.25),a=Math.max(Math.min(t.start-r,i.end-r),s+r);t.start-a>r&&this.flushMainBuffer(a,t.start)}getFwdBufferInfo(t,e){var s;const i=this.getLoadPosition();if(!K(i))return null;const r=this.lastCurrentTime>i||(s=this.media)!=null&&s.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(t,i,e,r)}getFwdBufferInfoAtPos(t,e,s,i){const n=j.bufferInfo(t,e,i);if(n.len===0&&n.nextStart!==void 0){const r=this.fragmentTracker.getBufferedFrag(e,s);if(r&&(n.nextStart<=r.end||r.gap)){const a=Math.max(Math.min(n.nextStart,r.end)-e,i);return j.bufferInfo(t,e,a)}}return n}getMaxBufferLength(t){const{config:e}=this;let s;return t?s=Math.max(8*e.maxBufferSize/t,e.maxBufferLength):s=e.maxBufferLength,Math.min(s,e.maxMaxBufferLength)}reduceMaxBufferLength(t,e){const s=this.config,i=Math.max(Math.min(t-e,s.maxBufferLength),e),n=Math.max(t-e*3,s.maxMaxBufferLength/2,i);return n>=i?(s.maxMaxBufferLength=n,this.warn(`Reduce max buffer length to ${n}s`),!0):!1}getAppendedFrag(t,e=H.MAIN){const s=this.fragmentTracker?this.fragmentTracker.getAppendedFrag(t,e):null;return s&&"fragment"in s?s.fragment:s}getNextFragment(t,e){const s=e.fragments,i=s.length;if(!i)return null;const{config:n}=this,r=s[0].start,a=n.lowLatencyMode&&!!e.partList;let c=null;if(e.live){const A=n.initialLiveManifestSize;if(i<A)return this.warn(`Not enough fragments to start playback (have: ${i}, need: ${A})`),null;if(!e.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||t<r){var l;a&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),c=this.getInitialLiveFragment(e);const u=this.hls.startPosition,d=this.hls.liveSyncPosition,f=c?(u!==-1&&u>=r?u:d)||c.start:t;this.log(`Setting startPosition to ${f} to match start frag at live edge. mainStart: ${u} liveSyncPosition: ${d} frag.start: ${(l=c)==null?void 0:l.start}`),this.startPosition=this.nextLoadPosition=f}}else t<=r&&(c=s[0]);if(!c){const A=this.loadingParts?e.partEnd:e.fragmentEnd;c=this.getFragmentAtPosition(t,A,e)}let h=this.filterReplacedPrimary(c,e);if(!h&&c){const A=c.sn-e.startSN;h=this.filterReplacedPrimary(s[A+1]||null,e)}return this.mapToInitFragWhenRequired(h)}isLoopLoading(t,e){const s=this.fragmentTracker.getState(t);return(s===Et.OK||s===Et.PARTIAL&&!!t.gap)&&this.nextLoadPosition>e}getNextFragmentLoopLoading(t,e,s,i,n){let r=null;if(t.gap&&(r=this.getNextFragment(this.nextLoadPosition,e),r&&!r.gap&&s.nextStart)){const a=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,s.nextStart,i,0);if(a!==null&&s.len+a.len>=n){const c=r.sn;return this.loopSn!==c&&(this.log(`buffer full after gaps in "${i}" playlist starting at sn: ${c}`),this.loopSn=c),null}}return this.loopSn=void 0,r}get primaryPrefetch(){if(fa(this.config)){var t;if((t=this.hls.interstitialsManager)==null||(t=t.playingItem)==null?void 0:t.event)return!0}return!1}filterReplacedPrimary(t,e){if(!t)return t;if(fa(this.config)&&t.type!==H.SUBTITLE){const s=this.hls.interstitialsManager,i=s?.bufferingItem;if(i){const r=i.event;if(r){if(r.appendInPlace||Math.abs(t.start-i.start)>1||i.start===0)return null}else if(t.end<=i.start&&e?.live===!1||t.start>i.end&&i.nextEvent&&(i.nextEvent.appendInPlace||t.start-i.end>1))return null}const n=s?.playerQueue;if(n)for(let r=n.length;r--;){const a=n[r].interstitial;if(a.appendInPlace&&t.start>=a.startTime&&t.end<=a.resumeTime)return null}}return t}mapToInitFragWhenRequired(t){return t!=null&&t.initSegment&&!t.initSegment.data&&!this.bitrateTest?t.initSegment:t}getNextPart(t,e,s){let i=-1,n=!1,r=!0;for(let a=0,c=t.length;a<c;a++){const l=t[a];if(r=r&&!l.independent,i>-1&&s<l.start)break;const h=l.loaded;h?i=-1:(n||(l.independent||r)&&l.fragment===e)&&(l.fragment!==e&&this.warn(`Need buffer at ${s} but next unloaded part starts at ${l.start}`),i=a),n=h}return i}loadedEndOfParts(t,e){let s;for(let i=t.length;i--;){if(s=t[i],!s.loaded)return!1;if(e>s.start)return!0}return!1}getInitialLiveFragment(t){const e=t.fragments,s=this.fragPrevious;let i=null;if(s){if(t.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${s.programDateTime}`),i=id(e,s.endProgramDateTime,this.config.maxFragLookUpTolerance)),!i){const n=s.sn+1;if(n>=t.startSN&&n<=t.endSN){const r=e[n-t.startSN];s.cc===r.cc&&(i=r,this.log(`Live playlist, switching playlist, load frag with next SN: ${i.sn}`))}i||(i=tc(t,s.cc,s.end),i&&this.log(`Live playlist, switching playlist, load frag with same CC: ${i.sn}`))}}else{const n=this.hls.liveSyncPosition;n!==null&&(i=this.getFragmentAtPosition(n,this.bitrateTest?t.fragmentEnd:t.edge,t))}return i}getFragmentAtPosition(t,e,s){const{config:i}=this;let{fragPrevious:n}=this,{fragments:r,endSN:a}=s;const{fragmentHint:c}=s,{maxFragLookUpTolerance:l}=i,h=s.partList,A=!!(this.loadingParts&&h!=null&&h.length&&c);A&&!this.bitrateTest&&h[h.length-1].fragment.sn===c.sn&&(r=r.concat(c),a=c.sn);let u;if(t<e){var d;const g=t<this.lastCurrentTime||t>e-l||(d=this.media)!=null&&d.paused||!this.startFragRequested?0:l;u=We(n,r,t,g)}else u=r[r.length-1];if(u){const f=u.sn-s.startSN,g=this.fragmentTracker.getState(u);if((g===Et.OK||g===Et.PARTIAL&&u.gap)&&(n=u),n&&u.sn===n.sn&&(!A||h[0].fragment.sn>u.sn||!s.live)&&u.level===n.level){const E=r[f+1];u.sn<a&&this.fragmentTracker.getState(E)!==Et.OK?u=E:u=null}}return u}alignPlaylists(t,e,s){const i=t.fragments.length;if(!i)return this.warn("No fragments in live playlist"),0;const n=t.fragmentStart,r=!e,a=t.alignedSliding&&K(n);if(r||!a&&!n){Nd(s,t);const c=t.fragmentStart;return this.log(`Live playlist sliding: ${c.toFixed(2)} start-sn: ${e?e.startSN:"na"}->${t.startSN} fragments: ${i}`),c}return n}waitForCdnTuneIn(t){return t.live&&t.canBlockReload&&t.partTarget&&t.tuneInGoal>Math.max(t.partHoldBack,t.partTarget*3)}setStartPosition(t,e){let s=this.startPosition;s<e&&(s=-1);const i=this.timelineOffset;if(s===-1){const n=this.startTimeOffset!==null,r=n?this.startTimeOffset:t.startTimeOffset;r!==null&&K(r)?(s=e+r,r<0&&(s+=t.edge),s=Math.min(Math.max(e,s),e+t.totalduration),this.log(`Setting startPosition to ${s} for start time offset ${r} found in ${n?"multivariant":"media"} playlist`),this.startPosition=s):t.live?(s=this.hls.liveSyncPosition||e,this.log(`Setting startPosition to -1 to start at live edge ${s}`),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=s=0),this.lastCurrentTime=s+i}this.nextLoadPosition=s+i}getLoadPosition(){var t;const{media:e}=this;let s=0;return(t=this.hls)!=null&&t.hasEnoughToStart&&e?s=e.currentTime:this.nextLoadPosition>=0&&(s=this.nextLoadPosition),s}handleFragLoadAborted(t,e){this.transmuxer&&t.type===this.playlistType&&dt(t)&&t.stats.aborted&&(this.log(`Fragment ${t.sn}${e?" part "+e.index:""} of ${this.playlistLabel()} ${t.level} was aborted`),this.resetFragmentLoading(t))}resetFragmentLoading(t){(!this.fragCurrent||!this.fragContextChanged(t)&&this.state!==P.FRAG_LOADING_WAITING_RETRY)&&(this.state=P.IDLE)}onFragmentOrKeyLoadError(t,e){var s;if(e.chunkMeta&&!e.frag){const E=this.getCurrentContext(e.chunkMeta);E&&(e.frag=E.frag)}const i=e.frag;if(!i||i.type!==t||!this.levels)return;if(this.fragContextChanged(i)){var n;this.warn(`Frag load error must match current frag to retry ${i.url} > ${(n=this.fragCurrent)==null?void 0:n.url}`);return}const r=e.details===w.FRAG_GAP;r&&this.fragmentTracker.fragBuffered(i,!0);const a=e.errorAction;if(!a){this.state=P.ERROR;return}const{action:c,flags:l,retryCount:h=0,retryConfig:A}=a,u=!!A,d=u&&c===vt.RetryRequest,f=u&&!a.resolved&&l===Nt.MoveAllAlternatesMatchingHost,g=(s=this.hls.latestLevelDetails)==null?void 0:s.live;if(!d&&f&&dt(i)&&!i.endList&&g&&!sc(e))this.resetFragmentErrors(t),this.treatAsGap(i),a.resolved=!0;else if((d||f)&&h<A.maxNumRetry){var m;const E=cr((m=e.response)==null?void 0:m.code),p=Kr(A,h);if(this.resetStartWhenNotLoaded(),this.retryDate=self.performance.now()+p,this.state=P.FRAG_LOADING_WAITING_RETRY,a.resolved=!0,E){this.log("Waiting for connection (offline)"),this.retryDate=1/0,e.reason="offline";return}this.warn(`Fragment ${i.sn} of ${t} ${i.level} errored with ${e.details}, retrying loading ${h+1}/${A.maxNumRetry} in ${p}ms`)}else if(A)if(this.resetFragmentErrors(t),h<A.maxNumRetry)!r&&c!==vt.RemoveAlternatePermanently&&(a.resolved=!0);else{this.warn(`${e.details} reached or exceeded max retry (${h})`);return}else c===vt.SendAlternateToPenaltyBox?this.state=P.WAITING_LEVEL:this.state=P.ERROR;this.tickImmediate()}checkRetryDate(){const t=self.performance.now(),e=this.retryDate,s=e===1/0;(!e||t>=e||s&&!cr(0))&&(s&&this.log("Connection restored (online)"),this.resetStartWhenNotLoaded(),this.state=P.IDLE)}reduceLengthAndFlushBuffer(t){if(this.state===P.PARSING||this.state===P.PARSED){const e=t.frag,s=t.parent,i=this.getFwdBufferInfo(this.mediaBuffer,s),n=i&&i.len>.5;n&&this.reduceMaxBufferLength(i.len,e?.duration||10);const r=!n;return r&&this.warn(`Buffer full error while media.currentTime (${this.getLoadPosition()}) is not buffered, flush ${s} buffer`),e&&(this.fragmentTracker.removeFragment(e),this.nextLoadPosition=e.start),this.resetLoadingState(),r}return!1}resetFragmentErrors(t){t===H.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==P.STOPPED&&(this.state=P.IDLE)}afterBufferFlushed(t,e,s){if(!t)return;const i=j.getBuffered(t);this.fragmentTracker.detectEvictedFragments(e,i,s),this.state===P.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==P.STOPPED&&(this.state=P.IDLE)}resetStartWhenNotLoaded(){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;const t=this.levelLastLoaded,e=t?t.details:null;e!=null&&e.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(e,e.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(t){this.log(`Loading context changed while buffering sn ${t.sn} of ${this.playlistLabel()} ${t.level===-1?"<removed>":t.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(),this.resetLoadingState()}removeUnbufferedFrags(t=0){this.fragmentTracker.removeFragmentsInRange(t,1/0,this.playlistType,!1,!0)}updateLevelTiming(t,e,s,i){const n=s.details;if(!n){this.warn("level.details undefined");return}if(!Object.keys(t.elementaryStreams).reduce((c,l)=>{const h=t.elementaryStreams[l];if(h){const A=h.endPTS-h.startPTS;if(A<=0)return this.warn(`Could not parse fragment ${t.sn} ${l} duration reliably (${A})`),c||!1;const u=i?0:Ac(n,t,h.startPTS,h.endPTS,h.startDTS,h.endDTS,this);return this.hls.trigger(y.LEVEL_PTS_UPDATED,{details:n,level:s,drift:u,type:l,frag:t,start:h.startPTS,end:h.endPTS}),!0}return c},!1)){var a;const c=((a=this.transmuxer)==null?void 0:a.error)===null;if((s.fragmentError===0||c&&(s.fragmentError<2||t.endList))&&this.treatAsGap(t,s),c){const l=new Error(`Found no media in fragment ${t.sn} of ${this.playlistLabel()} ${t.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(l.message),this.hls.trigger(y.ERROR,{type:V.MEDIA_ERROR,details:w.FRAG_PARSING_ERROR,fatal:!1,error:l,frag:t,reason:`Found no media in msn ${t.sn} of ${this.playlistLabel()} "${s.url}"`}),!this.hls)return;this.resetTransmuxer()}}this.state=P.PARSED,this.log(`Parsed ${t.type} sn: ${t.sn}${e?" part: "+e.index:""} of ${this.fragInfo(t,!1,e)})`),this.hls.trigger(y.FRAG_PARSED,{frag:t,part:e})}playlistLabel(){return this.playlistType===H.MAIN?"level":"track"}fragInfo(t,e=!0,s){var i,n;return`${this.playlistLabel()} ${t.level} (${s?"part":"frag"}:[${((i=e&&!s?t.startPTS:(s||t).start)!=null?i:NaN).toFixed(3)}-${((n=e&&!s?t.endPTS:(s||t).end)!=null?n:NaN).toFixed(3)}]${s&&t.type==="main"?"INDEPENDENT="+(s.independent?"YES":"NO"):""}`}treatAsGap(t,e){e&&e.fragmentError++,t.gap=!0,this.fragmentTracker.removeFragment(t),this.fragmentTracker.fragBuffered(t,!0)}resetTransmuxer(){var t;(t=this.transmuxer)==null||t.reset()}recoverWorkerError(t){t.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(),this.resetLoadingState())}set state(t){const e=this._state;e!==t&&(this._state=t,this.log(`${e}->${t}`))}get state(){return this._state}}function fa(o){return!!o.interstitialsController&&o.enableInterstitialPlayback!==!1}class Ic{constructor(){this.chunks=[],this.dataLength=0}push(t){this.chunks.push(t),this.dataLength+=t.length}flush(){const{chunks:t,dataLength:e}=this;let s;if(t.length)t.length===1?s=t[0]:s=Kd(t,e);else return new Uint8Array(0);return this.reset(),s}reset(){this.chunks.length=0,this.dataLength=0}}function Kd(o,t){const e=new Uint8Array(t);let s=0;for(let i=0;i<o.length;i++){const n=o[i];e.set(n,s),s+=n.length}return e}var In={exports:{}},ga;function $d(){return ga||(ga=1,(function(o){var t=Object.prototype.hasOwnProperty,e="~";function s(){}Object.create&&(s.prototype=Object.create(null),new s().__proto__||(e=!1));function i(c,l,h){this.fn=c,this.context=l,this.once=h||!1}function n(c,l,h,A,u){if(typeof h!="function")throw new TypeError("The listener must be a function");var d=new i(h,A||c,u),f=e?e+l:l;return c._events[f]?c._events[f].fn?c._events[f]=[c._events[f],d]:c._events[f].push(d):(c._events[f]=d,c._eventsCount++),c}function r(c,l){--c._eventsCount===0?c._events=new s:delete c._events[l]}function a(){this._events=new s,this._eventsCount=0}a.prototype.eventNames=function(){var l=[],h,A;if(this._eventsCount===0)return l;for(A in h=this._events)t.call(h,A)&&l.push(e?A.slice(1):A);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(h)):l},a.prototype.listeners=function(l){var h=e?e+l:l,A=this._events[h];if(!A)return[];if(A.fn)return[A.fn];for(var u=0,d=A.length,f=new Array(d);u<d;u++)f[u]=A[u].fn;return f},a.prototype.listenerCount=function(l){var h=e?e+l:l,A=this._events[h];return A?A.fn?1:A.length:0},a.prototype.emit=function(l,h,A,u,d,f){var g=e?e+l:l;if(!this._events[g])return!1;var m=this._events[g],E=arguments.length,p,I;if(m.fn){switch(m.once&&this.removeListener(l,m.fn,void 0,!0),E){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,h),!0;case 3:return m.fn.call(m.context,h,A),!0;case 4:return m.fn.call(m.context,h,A,u),!0;case 5:return m.fn.call(m.context,h,A,u,d),!0;case 6:return m.fn.call(m.context,h,A,u,d,f),!0}for(I=1,p=new Array(E-1);I<E;I++)p[I-1]=arguments[I];m.fn.apply(m.context,p)}else{var C=m.length,S;for(I=0;I<C;I++)switch(m[I].once&&this.removeListener(l,m[I].fn,void 0,!0),E){case 1:m[I].fn.call(m[I].context);break;case 2:m[I].fn.call(m[I].context,h);break;case 3:m[I].fn.call(m[I].context,h,A);break;case 4:m[I].fn.call(m[I].context,h,A,u);break;default:if(!p)for(S=1,p=new Array(E-1);S<E;S++)p[S-1]=arguments[S];m[I].fn.apply(m[I].context,p)}}return!0},a.prototype.on=function(l,h,A){return n(this,l,h,A,!1)},a.prototype.once=function(l,h,A){return n(this,l,h,A,!0)},a.prototype.removeListener=function(l,h,A,u){var d=e?e+l:l;if(!this._events[d])return this;if(!h)return r(this,d),this;var f=this._events[d];if(f.fn)f.fn===h&&(!u||f.once)&&(!A||f.context===A)&&r(this,d);else{for(var g=0,m=[],E=f.length;g<E;g++)(f[g].fn!==h||u&&!f[g].once||A&&f[g].context!==A)&&m.push(f[g]);m.length?this._events[d]=m.length===1?m[0]:m:r(this,d)}return this},a.prototype.removeAllListeners=function(l){var h;return l?(h=e?e+l:l,this._events[h]&&r(this,h)):(this._events=new s,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=e,a.EventEmitter=a,o.exports=a})(In)),In.exports}var Hd=$d(),Wr=gu(Hd);const Js="1.6.15",Cs={};function Vd(){return typeof __HLS_WORKER_BUNDLE__=="function"}function Yd(){const o=Cs[Js];if(o)return o.clientCount++,o;const t=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),e=self.URL.createObjectURL(t),i={worker:new self.Worker(e),objectURL:e,clientCount:1};return Cs[Js]=i,i}function qd(o){const t=Cs[o];if(t)return t.clientCount++,t;const e=new self.URL(o,self.location.href).href,i={worker:new self.Worker(e),scriptURL:e,clientCount:1};return Cs[o]=i,i}function Wd(o){const t=Cs[o||Js];if(t&&t.clientCount--===1){const{worker:s,objectURL:i}=t;delete Cs[o||Js],i&&self.URL.revokeObjectURL(i),s.terminate()}}function yc(o,t){return t+10<=o.length&&o[t]===51&&o[t+1]===68&&o[t+2]===73&&o[t+3]<255&&o[t+4]<255&&o[t+6]<128&&o[t+7]<128&&o[t+8]<128&&o[t+9]<128}function Jr(o,t){return t+10<=o.length&&o[t]===73&&o[t+1]===68&&o[t+2]===51&&o[t+3]<255&&o[t+4]<255&&o[t+6]<128&&o[t+7]<128&&o[t+8]<128&&o[t+9]<128}function rn(o,t){let e=0;return e=(o[t]&127)<<21,e|=(o[t+1]&127)<<14,e|=(o[t+2]&127)<<7,e|=o[t+3]&127,e}function js(o,t){const e=t;let s=0;for(;Jr(o,t);){s+=10;const i=rn(o,t+6);s+=i,yc(o,t+10)&&(s+=10),t+=s}if(s>0)return o.subarray(e,e+s)}function Jd(o,t,e,s){const i=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],n=t[e+2],r=n>>2&15;if(r>12){const d=new Error(`invalid ADTS sampling index:${r}`);o.emit(y.ERROR,y.ERROR,{type:V.MEDIA_ERROR,details:w.FRAG_PARSING_ERROR,fatal:!0,error:d,reason:d.message});return}const a=(n>>6&3)+1,c=t[e+3]>>6&3|(n&1)<<2,l="mp4a.40."+a,h=i[r];let A=r;(a===5||a===29)&&(A-=3);const u=[a<<3|(A&14)>>1,(A&1)<<7|c<<3];return nt.log(`manifest codec:${s}, parsed codec:${l}, channels:${c}, rate:${h} (ADTS object type:${a} sampling index:${r})`),{config:u,samplerate:h,channelCount:c,codec:l,parsedCodec:l,manifestCodec:s}}function Cc(o,t){return o[t]===255&&(o[t+1]&246)===240}function Sc(o,t){return o[t+1]&1?7:9}function jr(o,t){return(o[t+3]&3)<<11|o[t+4]<<3|(o[t+5]&224)>>>5}function jd(o,t){return t+5<o.length}function tn(o,t){return t+1<o.length&&Cc(o,t)}function Xd(o,t){return jd(o,t)&&Cc(o,t)&&jr(o,t)<=o.length-t}function zd(o,t){if(tn(o,t)){const e=Sc(o,t);if(t+e>=o.length)return!1;const s=jr(o,t);if(s<=e)return!1;const i=t+s;return i===o.length||tn(o,i)}return!1}function Tc(o,t,e,s,i){if(!o.samplerate){const n=Jd(t,e,s,i);if(!n)return;rt(o,n)}}function Bc(o){return 1024*9e4/o}function Zd(o,t){const e=Sc(o,t);if(t+e<=o.length){const s=jr(o,t)-e;if(s>0)return{headerLength:e,frameLength:s}}}function xc(o,t,e,s,i){const n=Bc(o.samplerate),r=s+i*n,a=Zd(t,e);let c;if(a){const{frameLength:A,headerLength:u}=a,d=u+A,f=Math.max(0,e+d-t.length);f?(c=new Uint8Array(d-u),c.set(t.subarray(e+u,t.length),0)):c=t.subarray(e+u,e+d);const g={unit:c,pts:r};return f||o.samples.push(g),{sample:g,length:d,missing:f}}const l=t.length-e;return c=new Uint8Array(l),c.set(t.subarray(e,t.length),0),{sample:{unit:c,pts:r},length:l,missing:-1}}function tf(o,t){return Jr(o,t)&&rn(o,t+6)+10<=o.length-t}function ef(o){return o instanceof ArrayBuffer?o:o.byteOffset==0&&o.byteLength==o.buffer.byteLength?o.buffer:new Uint8Array(o).buffer}function yn(o,t=0,e=1/0){return sf(o,t,e,Uint8Array)}function sf(o,t,e,s){const i=nf(o);let n=1;"BYTES_PER_ELEMENT"in s&&(n=s.BYTES_PER_ELEMENT);const r=rf(o)?o.byteOffset:0,a=(r+o.byteLength)/n,c=(r+t)/n,l=Math.floor(Math.max(0,Math.min(c,a))),h=Math.floor(Math.min(l+Math.max(e,0),a));return new s(i,l,h-l)}function nf(o){return o instanceof ArrayBuffer?o:o.buffer}function rf(o){return o&&o.buffer instanceof ArrayBuffer&&o.byteLength!==void 0&&o.byteOffset!==void 0}function of(o){const t={key:o.type,description:"",data:"",mimeType:null,pictureType:null},e=3;if(o.size<2)return;if(o.data[0]!==e){console.log("Ignore frame with unrecognized character encoding");return}const s=o.data.subarray(1).indexOf(0);if(s===-1)return;const i=$t(yn(o.data,1,s)),n=o.data[2+s],r=o.data.subarray(3+s).indexOf(0);if(r===-1)return;const a=$t(yn(o.data,3+s,r));let c;return i==="-->"?c=$t(yn(o.data,4+s+r)):c=ef(o.data.subarray(4+s+r)),t.mimeType=i,t.pictureType=n,t.description=a,t.data=c,t}function af(o){if(o.size<2)return;const t=$t(o.data,!0),e=new Uint8Array(o.data.subarray(t.length+1));return{key:o.type,info:t,data:e.buffer}}function lf(o){if(o.size<2)return;if(o.type==="TXXX"){let e=1;const s=$t(o.data.subarray(e),!0);e+=s.length+1;const i=$t(o.data.subarray(e));return{key:o.type,info:s,data:i}}const t=$t(o.data.subarray(1));return{key:o.type,info:"",data:t}}function cf(o){if(o.type==="WXXX"){if(o.size<2)return;let e=1;const s=$t(o.data.subarray(e),!0);e+=s.length+1;const i=$t(o.data.subarray(e));return{key:o.type,info:s,data:i}}const t=$t(o.data);return{key:o.type,info:"",data:t}}function hf(o){return o.type==="PRIV"?af(o):o.type[0]==="W"?cf(o):o.type==="APIC"?of(o):lf(o)}function Af(o){const t=String.fromCharCode(o[0],o[1],o[2],o[3]),e=rn(o,4),s=10;return{type:t,size:e,data:o.subarray(s,s+e)}}const ri=10,uf=10;function vc(o){let t=0;const e=[];for(;Jr(o,t);){const s=rn(o,t+6);o[t+5]>>6&1&&(t+=ri),t+=ri;const i=t+s;for(;t+uf<i;){const n=Af(o.subarray(t)),r=hf(n);r&&e.push(r),t+=n.size+ri}yc(o,t)&&(t+=ri)}return e}function Lc(o){return o&&o.key==="PRIV"&&o.info==="com.apple.streaming.transportStreamTimestamp"}function df(o){if(o.data.byteLength===8){const t=new Uint8Array(o.data),e=t[3]&1;let s=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return s/=45,e&&(s+=4772185884e-2),Math.round(s)}}function Xr(o){const t=vc(o);for(let e=0;e<t.length;e++){const s=t[e];if(Lc(s))return df(s)}}let Kt=(function(o){return o.audioId3="org.id3",o.dateRange="com.apple.quicktime.HLS",o.emsg="https://aomedia.org/emsg/ID3",o.misbklv="urn:misb:KLV:bin:1910.1",o})({});function ce(o="",t=9e4){return{type:o,id:-1,pid:-1,inputTimeScale:t,sequenceNumber:-1,samples:[],dropped:0}}class zr{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(t,e,s,i){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(t){this.initPTS=t,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(t,e){return!1}appendFrame(t,e,s){}demux(t,e){this.cachedData&&(t=jt(this.cachedData,t),this.cachedData=null);let s=js(t,0),i=s?s.length:0,n;const r=this._audioTrack,a=this._id3Track,c=s?Xr(s):void 0,l=t.length;for((this.basePTS===null||this.frameIndex===0&&K(c))&&(this.basePTS=ff(c,e,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),s&&s.length>0&&a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:s,type:Kt.audioId3,duration:Number.POSITIVE_INFINITY});i<l;){if(this.canParse(t,i)){const h=this.appendFrame(r,t,i);h?(this.frameIndex++,this.lastPTS=h.sample.pts,i+=h.length,n=i):i=l}else tf(t,i)?(s=js(t,i),a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:s,type:Kt.audioId3,duration:Number.POSITIVE_INFINITY}),i+=s.length,n=i):i++;if(i===l&&n!==l){const h=t.slice(n);this.cachedData?this.cachedData=jt(this.cachedData,h):this.cachedData=h}}return{audioTrack:r,videoTrack:ce(),id3Track:a,textTrack:ce()}}demuxSampleAes(t,e,s){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(t){const e=this.cachedData;return e&&(this.cachedData=null,this.demux(e,0)),{audioTrack:this._audioTrack,videoTrack:ce(),id3Track:this._id3Track,textTrack:ce()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0}}const ff=(o,t,e)=>{if(K(o))return o*90;const s=e?e.baseTime*9e4/e.timescale:0;return t*9e4+s};let oi=null;const gf=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],mf=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],pf=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],Ef=[0,1,1,4];function Dc(o,t,e,s,i){if(e+24>t.length)return;const n=Rc(t,e);if(n&&e+n.frameLength<=t.length){const r=n.samplesPerFrame*9e4/n.sampleRate,a=s+i*r,c={unit:t.subarray(e,e+n.frameLength),pts:a,dts:a};return o.config=[],o.channelCount=n.channelCount,o.samplerate=n.sampleRate,o.samples.push(c),{sample:c,length:n.frameLength,missing:0}}}function Rc(o,t){const e=o[t+1]>>3&3,s=o[t+1]>>1&3,i=o[t+2]>>4&15,n=o[t+2]>>2&3;if(e!==1&&i!==0&&i!==15&&n!==3){const r=o[t+2]>>1&1,a=o[t+3]>>6,c=e===3?3-s:s===3?3:4,l=gf[c*14+i-1]*1e3,A=mf[(e===3?0:e===2?1:2)*3+n],u=a===3?1:2,d=pf[e][s],f=Ef[s],g=d*8*f,m=Math.floor(d*l/A+r)*f;if(oi===null){const I=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);oi=I?parseInt(I[1]):0}return oi&&oi<=87&&s===2&&l>=224e3&&a===0&&(o[t+3]=o[t+3]|128),{sampleRate:A,channelCount:u,frameLength:m,samplesPerFrame:g}}}function Zr(o,t){return o[t]===255&&(o[t+1]&224)===224&&(o[t+1]&6)!==0}function bc(o,t){return t+1<o.length&&Zr(o,t)}function If(o,t){return Zr(o,t)&&4<=o.length-t}function wc(o,t){if(t+1<o.length&&Zr(o,t)){const s=Rc(o,t);let i=4;s!=null&&s.frameLength&&(i=s.frameLength);const n=t+i;return n===o.length||bc(o,n)}return!1}class yf extends zr{constructor(t,e){super(),this.observer=void 0,this.config=void 0,this.observer=t,this.config=e}resetInitSegment(t,e,s,i){super.resetInitSegment(t,e,s,i),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:e,duration:i,inputTimeScale:9e4,dropped:0}}static probe(t,e){if(!t)return!1;const s=js(t,0);let i=s?.length||0;if(wc(t,i))return!1;for(let n=t.length;i<n;i++)if(zd(t,i))return e.log("ADTS sync word found !"),!0;return!1}canParse(t,e){return Xd(t,e)}appendFrame(t,e,s){Tc(t,this.observer,e,s,t.manifestCodec);const i=xc(t,e,s,this.basePTS,this.frameIndex);if(i&&i.missing===0)return i}}const kc=(o,t)=>{let e=0,s=5;t+=s;const i=new Uint32Array(1),n=new Uint32Array(1),r=new Uint8Array(1);for(;s>0;){r[0]=o[t];const a=Math.min(s,8),c=8-a;n[0]=4278190080>>>24+c<<c,i[0]=(r[0]&n[0])>>c,e=e?e<<a|i[0]:i[0],t+=1,s-=a}return e};class Cf extends zr{constructor(t){super(),this.observer=void 0,this.observer=t}resetInitSegment(t,e,s,i){super.resetInitSegment(t,e,s,i),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:e,duration:i,inputTimeScale:9e4,dropped:0}}canParse(t,e){return e+64<t.length}appendFrame(t,e,s){const i=_c(t,e,s,this.basePTS,this.frameIndex);if(i!==-1)return{sample:t.samples[t.samples.length-1],length:i,missing:0}}static probe(t){if(!t)return!1;const e=js(t,0);if(!e)return!1;const s=e.length;return t[s]===11&&t[s+1]===119&&Xr(e)!==void 0&&kc(t,s)<16}}function _c(o,t,e,s,i){if(e+8>t.length||t[e]!==11||t[e+1]!==119)return-1;const n=t[e+4]>>6;if(n>=3)return-1;const a=[48e3,44100,32e3][n],c=t[e+4]&63,h=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][c*3+n]*2;if(e+h>t.length)return-1;const A=t[e+6]>>5;let u=0;A===2?u+=2:(A&1&&A!==1&&(u+=2),A&4&&(u+=2));const d=(t[e+6]<<8|t[e+7])>>12-u&1,g=[2,1,2,3,3,4,4,5][A]+d,m=t[e+5]>>3,E=t[e+5]&7,p=new Uint8Array([n<<6|m<<1|E>>2,(E&3)<<6|A<<3|d<<2|c>>4,c<<4&224]),I=1536/a*9e4,C=s+i*I,S=t.subarray(e,e+h);return o.config=p,o.channelCount=g,o.samplerate=a,o.samples.push({unit:S,pts:C}),h}class Sf extends zr{resetInitSegment(t,e,s,i){super.resetInitSegment(t,e,s,i),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:e,duration:i,inputTimeScale:9e4,dropped:0}}static probe(t){if(!t)return!1;const e=js(t,0);let s=e?.length||0;if(e&&t[s]===11&&t[s+1]===119&&Xr(e)!==void 0&&kc(t,s)<=16)return!1;for(let i=t.length;s<i;s++)if(wc(t,s))return nt.log("MPEG Audio sync word found !"),!0;return!1}canParse(t,e){return If(t,e)}appendFrame(t,e,s){if(this.basePTS!==null)return Dc(t,e,s,this.basePTS,this.frameIndex)}}const Tf=/\/emsg[-/]ID3/i;class Bf{constructor(t,e){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=e}resetTimeStamp(){}resetInitSegment(t,e,s,i){const n=this.videoTrack=ce("video",1),r=this.audioTrack=ce("audio",1),a=this.txtTrack=ce("text",1);if(this.id3Track=ce("id3",1),this.timeOffset=0,!(t!=null&&t.byteLength))return;const c=$l(t);if(c.video){const{id:l,timescale:h,codec:A,supplemental:u}=c.video;n.id=l,n.timescale=a.timescale=h,n.codec=A,n.supplemental=u}if(c.audio){const{id:l,timescale:h,codec:A}=c.audio;r.id=l,r.timescale=h,r.codec=A}a.id=Nl.text,n.sampleDuration=0,n.duration=r.duration=i}resetContiguity(){this.remainderData=null}static probe(t){return yu(t)}demux(t,e){this.timeOffset=e;let s=t;const i=this.videoTrack,n=this.txtTrack;if(this.config.progressive){this.remainderData&&(s=jt(this.remainderData,t));const a=Lu(s);this.remainderData=a.remainder,i.samples=a.valid||new Uint8Array}else i.samples=s;const r=this.extractID3Track(i,e);return n.samples=_o(e,i),{videoTrack:i,audioTrack:this.audioTrack,id3Track:r,textTrack:this.txtTrack}}flush(){const t=this.timeOffset,e=this.videoTrack,s=this.txtTrack;e.samples=this.remainderData||new Uint8Array,this.remainderData=null;const i=this.extractID3Track(e,this.timeOffset);return s.samples=_o(t,e),{videoTrack:e,audioTrack:ce(),id3Track:i,textTrack:ce()}}extractID3Track(t,e){const s=this.id3Track;if(t.samples.length){const i=X(t.samples,["emsg"]);i&&i.forEach(n=>{const r=Ru(n);if(Tf.test(r.schemeIdUri)){const a=ma(r,e);let c=r.eventDuration===4294967295?Number.POSITIVE_INFINITY:r.eventDuration/r.timeScale;c<=.001&&(c=Number.POSITIVE_INFINITY);const l=r.payload;s.samples.push({data:l,len:l.byteLength,dts:a,pts:a,type:Kt.emsg,duration:c})}else if(this.config.enableEmsgKLVMetadata&&r.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){const a=ma(r,e);s.samples.push({data:r.payload,len:r.payload.byteLength,dts:a,pts:a,type:Kt.misbklv,duration:Number.POSITIVE_INFINITY})}})}return s}demuxSampleAes(t,e,s){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0}}function ma(o,t){return K(o.presentationTime)?o.presentationTime/o.timeScale:t+o.presentationTimeDelta/o.timeScale}class xf{constructor(t,e,s){this.keyData=void 0,this.decrypter=void 0,this.keyData=s,this.decrypter=new $r(e,{removePKCS7Padding:!1})}decryptBuffer(t){return this.decrypter.decrypt(t,this.keyData.key.buffer,this.keyData.iv.buffer,Fe.cbc)}decryptAacSample(t,e,s){const i=t[e].unit;if(i.length<=16)return;const n=i.subarray(16,i.length-i.length%16),r=n.buffer.slice(n.byteOffset,n.byteOffset+n.length);this.decryptBuffer(r).then(a=>{const c=new Uint8Array(a);i.set(c,16),this.decrypter.isSync()||this.decryptAacSamples(t,e+1,s)}).catch(s)}decryptAacSamples(t,e,s){for(;;e++){if(e>=t.length){s();return}if(!(t[e].unit.length<32)&&(this.decryptAacSample(t,e,s),!this.decrypter.isSync()))return}}getAvcEncryptedData(t){const e=Math.floor((t.length-48)/160)*16+16,s=new Int8Array(e);let i=0;for(let n=32;n<t.length-16;n+=160,i+=16)s.set(t.subarray(n,n+16),i);return s}getAvcDecryptedUnit(t,e){const s=new Uint8Array(e);let i=0;for(let n=32;n<t.length-16;n+=160,i+=16)t.set(s.subarray(i,i+16),n);return t}decryptAvcSample(t,e,s,i,n){const r=Yl(n.data),a=this.getAvcEncryptedData(r);this.decryptBuffer(a.buffer).then(c=>{n.data=this.getAvcDecryptedUnit(r,c),this.decrypter.isSync()||this.decryptAvcSamples(t,e,s+1,i)}).catch(i)}decryptAvcSamples(t,e,s,i){if(t instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;e++,s=0){if(e>=t.length){i();return}const n=t[e].units;for(;!(s>=n.length);s++){const r=n[s];if(!(r.data.length<=48||r.type!==1&&r.type!==5)&&(this.decryptAvcSample(t,e,s,i,r),!this.decrypter.isSync()))return}}}}class Pc{constructor(){this.VideoSample=null}createVideoSample(t,e,s){return{key:t,frame:!1,pts:e,dts:s,units:[],length:0}}getLastNalUnit(t){var e;let s=this.VideoSample,i;if((!s||s.units.length===0)&&(s=t[t.length-1]),(e=s)!=null&&e.units){const n=s.units;i=n[n.length-1]}return i}pushAccessUnit(t,e){if(t.units.length&&t.frame){if(t.pts===void 0){const s=e.samples,i=s.length;if(i){const n=s[i-1];t.pts=n.pts,t.dts=n.dts}else{e.dropped++;return}}e.samples.push(t)}}parseNALu(t,e,s){const i=e.byteLength;let n=t.naluState||0;const r=n,a=[];let c=0,l,h,A,u=-1,d=0;for(n===-1&&(u=0,d=this.getNALuType(e,0),n=0,c=1);c<i;){if(l=e[c++],!n){n=l?0:1;continue}if(n===1){n=l?0:2;continue}if(!l)n=3;else if(l===1){if(h=c-n-1,u>=0){const f={data:e.subarray(u,h),type:d};a.push(f)}else{const f=this.getLastNalUnit(t.samples);f&&(r&&c<=4-r&&f.state&&(f.data=f.data.subarray(0,f.data.byteLength-r)),h>0&&(f.data=jt(f.data,e.subarray(0,h)),f.state=0))}c<i?(A=this.getNALuType(e,c),u=c,d=A,n=0):n=-1}else n=0}if(u>=0&&n>=0){const f={data:e.subarray(u,i),type:d,state:n};a.push(f)}if(a.length===0){const f=this.getLastNalUnit(t.samples);f&&(f.data=jt(f.data,e))}return t.naluState=n,a}}class Ks{constructor(t){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=t,this.bytesAvailable=t.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const t=this.data,e=this.bytesAvailable,s=t.byteLength-e,i=new Uint8Array(4),n=Math.min(4,e);if(n===0)throw new Error("no bytes available");i.set(t.subarray(s,s+n)),this.word=new DataView(i.buffer).getUint32(0),this.bitsAvailable=n*8,this.bytesAvailable-=n}skipBits(t){let e;t=Math.min(t,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>t?(this.word<<=t,this.bitsAvailable-=t):(t-=this.bitsAvailable,e=t>>3,t-=e<<3,this.bytesAvailable-=e,this.loadWord(),this.word<<=t,this.bitsAvailable-=t)}readBits(t){let e=Math.min(this.bitsAvailable,t);const s=this.word>>>32-e;if(t>32&&nt.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=e,this.bitsAvailable>0)this.word<<=e;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return e=t-e,e>0&&this.bitsAvailable?s<<e|this.readBits(e):s}skipLZ(){let t;for(t=0;t<this.bitsAvailable;++t)if((this.word&2147483648>>>t)!==0)return this.word<<=t,this.bitsAvailable-=t,t;return this.loadWord(),t+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const t=this.skipLZ();return this.readBits(t+1)-1}readEG(){const t=this.readUEG();return 1&t?1+t>>>1:-1*(t>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}class vf extends Pc{parsePES(t,e,s,i){const n=this.parseNALu(t,s.data,i);let r=this.VideoSample,a,c=!1;s.data=null,r&&n.length&&!t.audFound&&(this.pushAccessUnit(r,t),r=this.VideoSample=this.createVideoSample(!1,s.pts,s.dts)),n.forEach(l=>{var h,A;switch(l.type){case 1:{let g=!1;a=!0;const m=l.data;if(c&&m.length>4){const E=this.readSliceType(m);(E===2||E===4||E===7||E===9)&&(g=!0)}if(g){var u;(u=r)!=null&&u.frame&&!r.key&&(this.pushAccessUnit(r,t),r=this.VideoSample=null)}r||(r=this.VideoSample=this.createVideoSample(!0,s.pts,s.dts)),r.frame=!0,r.key=g;break}case 5:a=!0,(h=r)!=null&&h.frame&&!r.key&&(this.pushAccessUnit(r,t),r=this.VideoSample=null),r||(r=this.VideoSample=this.createVideoSample(!0,s.pts,s.dts)),r.key=!0,r.frame=!0;break;case 6:{a=!0,Ur(l.data,1,s.pts,e.samples);break}case 7:{var d,f;a=!0,c=!0;const g=l.data,m=this.readSPS(g);if(!t.sps||t.width!==m.width||t.height!==m.height||((d=t.pixelRatio)==null?void 0:d[0])!==m.pixelRatio[0]||((f=t.pixelRatio)==null?void 0:f[1])!==m.pixelRatio[1]){t.width=m.width,t.height=m.height,t.pixelRatio=m.pixelRatio,t.sps=[g];const E=g.subarray(1,4);let p="avc1.";for(let I=0;I<3;I++){let C=E[I].toString(16);C.length<2&&(C="0"+C),p+=C}t.codec=p}break}case 8:a=!0,t.pps=[l.data];break;case 9:a=!0,t.audFound=!0,(A=r)!=null&&A.frame&&(this.pushAccessUnit(r,t),r=null),r||(r=this.VideoSample=this.createVideoSample(!1,s.pts,s.dts));break;case 12:a=!0;break;default:a=!1;break}r&&a&&r.units.push(l)}),i&&r&&(this.pushAccessUnit(r,t),this.VideoSample=null)}getNALuType(t,e){return t[e]&31}readSliceType(t){const e=new Ks(t);return e.readUByte(),e.readUEG(),e.readUEG()}skipScalingList(t,e){let s=8,i=8,n;for(let r=0;r<t;r++)i!==0&&(n=e.readEG(),i=(s+n+256)%256),s=i===0?s:i}readSPS(t){const e=new Ks(t);let s=0,i=0,n=0,r=0,a,c,l;const h=e.readUByte.bind(e),A=e.readBits.bind(e),u=e.readUEG.bind(e),d=e.readBoolean.bind(e),f=e.skipBits.bind(e),g=e.skipEG.bind(e),m=e.skipUEG.bind(e),E=this.skipScalingList.bind(this);h();const p=h();if(A(5),f(3),h(),m(),p===100||p===110||p===122||p===244||p===44||p===83||p===86||p===118||p===128){const x=u();if(x===3&&f(1),m(),m(),f(1),d())for(c=x!==3?8:12,l=0;l<c;l++)d()&&(l<6?E(16,e):E(64,e))}m();const I=u();if(I===0)u();else if(I===1)for(f(1),g(),g(),a=u(),l=0;l<a;l++)g();m(),f(1);const C=u(),S=u(),v=A(1);v===0&&f(1),f(1),d()&&(s=u(),i=u(),n=u(),r=u());let T=[1,1];if(d()&&d())switch(h()){case 1:T=[1,1];break;case 2:T=[12,11];break;case 3:T=[10,11];break;case 4:T=[16,11];break;case 5:T=[40,33];break;case 6:T=[24,11];break;case 7:T=[20,11];break;case 8:T=[32,11];break;case 9:T=[80,33];break;case 10:T=[18,11];break;case 11:T=[15,11];break;case 12:T=[64,33];break;case 13:T=[160,99];break;case 14:T=[4,3];break;case 15:T=[3,2];break;case 16:T=[2,1];break;case 255:{T=[h()<<8|h(),h()<<8|h()];break}}return{width:Math.ceil((C+1)*16-s*2-i*2),height:(2-v)*(S+1)*16-(v?2:4)*(n+r),pixelRatio:T}}}class Lf extends Pc{constructor(...t){super(...t),this.initVPS=null}parsePES(t,e,s,i){const n=this.parseNALu(t,s.data,i);let r=this.VideoSample,a,c=!1;s.data=null,r&&n.length&&!t.audFound&&(this.pushAccessUnit(r,t),r=this.VideoSample=this.createVideoSample(!1,s.pts,s.dts)),n.forEach(l=>{var h,A;switch(l.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:r||(r=this.VideoSample=this.createVideoSample(!1,s.pts,s.dts)),r.frame=!0,a=!0;break;case 16:case 17:case 18:case 21:if(a=!0,c){var u;(u=r)!=null&&u.frame&&!r.key&&(this.pushAccessUnit(r,t),r=this.VideoSample=null)}r||(r=this.VideoSample=this.createVideoSample(!0,s.pts,s.dts)),r.key=!0,r.frame=!0;break;case 19:case 20:a=!0,(h=r)!=null&&h.frame&&!r.key&&(this.pushAccessUnit(r,t),r=this.VideoSample=null),r||(r=this.VideoSample=this.createVideoSample(!0,s.pts,s.dts)),r.key=!0,r.frame=!0;break;case 39:a=!0,Ur(l.data,2,s.pts,e.samples);break;case 32:a=!0,t.vps||(typeof t.params!="object"&&(t.params={}),t.params=rt(t.params,this.readVPS(l.data)),this.initVPS=l.data),t.vps=[l.data];break;case 33:if(a=!0,c=!0,t.vps!==void 0&&t.vps[0]!==this.initVPS&&t.sps!==void 0&&!this.matchSPS(t.sps[0],l.data)&&(this.initVPS=t.vps[0],t.sps=t.pps=void 0),!t.sps){const d=this.readSPS(l.data);t.width=d.width,t.height=d.height,t.pixelRatio=d.pixelRatio,t.codec=d.codecString,t.sps=[],typeof t.params!="object"&&(t.params={});for(const f in d.params)t.params[f]=d.params[f]}this.pushParameterSet(t.sps,l.data,t.vps),r||(r=this.VideoSample=this.createVideoSample(!0,s.pts,s.dts)),r.key=!0;break;case 34:if(a=!0,typeof t.params=="object"){if(!t.pps){t.pps=[];const d=this.readPPS(l.data);for(const f in d)t.params[f]=d[f]}this.pushParameterSet(t.pps,l.data,t.vps)}break;case 35:a=!0,t.audFound=!0,(A=r)!=null&&A.frame&&(this.pushAccessUnit(r,t),r=null),r||(r=this.VideoSample=this.createVideoSample(!1,s.pts,s.dts));break;default:a=!1;break}r&&a&&r.units.push(l)}),i&&r&&(this.pushAccessUnit(r,t),this.VideoSample=null)}pushParameterSet(t,e,s){(s&&s[0]===this.initVPS||!s&&!t.length)&&t.push(e)}getNALuType(t,e){return(t[e]&126)>>>1}ebsp2rbsp(t){const e=new Uint8Array(t.byteLength);let s=0;for(let i=0;i<t.byteLength;i++)i>=2&&t[i]===3&&t[i-1]===0&&t[i-2]===0||(e[s]=t[i],s++);return new Uint8Array(e.buffer,0,s)}pushAccessUnit(t,e){super.pushAccessUnit(t,e),this.initVPS&&(this.initVPS=null)}readVPS(t){const e=new Ks(t);e.readUByte(),e.readUByte(),e.readBits(4),e.skipBits(2),e.readBits(6);const s=e.readBits(3),i=e.readBoolean();return{numTemporalLayers:s+1,temporalIdNested:i}}readSPS(t){const e=new Ks(this.ebsp2rbsp(t));e.readUByte(),e.readUByte(),e.readBits(4);const s=e.readBits(3);e.readBoolean();const i=e.readBits(2),n=e.readBoolean(),r=e.readBits(5),a=e.readUByte(),c=e.readUByte(),l=e.readUByte(),h=e.readUByte(),A=e.readUByte(),u=e.readUByte(),d=e.readUByte(),f=e.readUByte(),g=e.readUByte(),m=e.readUByte(),E=e.readUByte(),p=[],I=[];for(let st=0;st<s;st++)p.push(e.readBoolean()),I.push(e.readBoolean());if(s>0)for(let st=s;st<8;st++)e.readBits(2);for(let st=0;st<s;st++)p[st]&&(e.readUByte(),e.readUByte(),e.readUByte(),e.readUByte(),e.readUByte(),e.readUByte(),e.readUByte(),e.readUByte(),e.readUByte(),e.readUByte(),e.readUByte()),I[st]&&e.readUByte();e.readUEG();const C=e.readUEG();C==3&&e.skipBits(1);const S=e.readUEG(),v=e.readUEG(),T=e.readBoolean();let x=0,L=0,B=0,D=0;T&&(x+=e.readUEG(),L+=e.readUEG(),B+=e.readUEG(),D+=e.readUEG());const R=e.readUEG(),k=e.readUEG(),_=e.readUEG(),Q=e.readBoolean();for(let st=Q?0:s;st<=s;st++)e.skipUEG(),e.skipUEG(),e.skipUEG();if(e.skipUEG(),e.skipUEG(),e.skipUEG(),e.skipUEG(),e.skipUEG(),e.skipUEG(),e.readBoolean()&&e.readBoolean())for(let Rt=0;Rt<4;Rt++)for(let Vt=0;Vt<(Rt===3?2:6);Vt++)if(!e.readBoolean())e.readUEG();else{const Zt=Math.min(64,1<<4+(Rt<<1));Rt>1&&e.readEG();for(let Je=0;Je<Zt;Je++)e.readEG()}e.readBoolean(),e.readBoolean(),e.readBoolean()&&(e.readUByte(),e.skipUEG(),e.skipUEG(),e.readBoolean());const N=e.readUEG();let $=0;for(let st=0;st<N;st++){let Rt=!1;if(st!==0&&(Rt=e.readBoolean()),Rt){st===N&&e.readUEG(),e.readBoolean(),e.readUEG();let Vt=0;for(let Me=0;Me<=$;Me++){const Zt=e.readBoolean();let Je=!1;Zt||(Je=e.readBoolean()),(Zt||Je)&&Vt++}$=Vt}else{const Vt=e.readUEG(),Me=e.readUEG();$=Vt+Me;for(let Zt=0;Zt<Vt;Zt++)e.readUEG(),e.readBoolean();for(let Zt=0;Zt<Me;Zt++)e.readUEG(),e.readBoolean()}}if(e.readBoolean()){const st=e.readUEG();for(let Rt=0;Rt<st;Rt++){for(let Vt=0;Vt<_+4;Vt++)e.readBits(1);e.readBits(1)}}let M=0,O=1,q=1,tt=!0,J=1,Z=0;e.readBoolean(),e.readBoolean();let Ct=!1;if(e.readBoolean()){if(e.readBoolean()){const Oe=e.readUByte(),mo=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],ti=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];Oe>0&&Oe<16?(O=mo[Oe-1],q=ti[Oe-1]):Oe===255&&(O=e.readBits(16),q=e.readBits(16))}if(e.readBoolean()&&e.readBoolean(),e.readBoolean()&&(e.readBits(3),e.readBoolean(),e.readBoolean()&&(e.readUByte(),e.readUByte(),e.readUByte())),e.readBoolean()&&(e.readUEG(),e.readUEG()),e.readBoolean(),e.readBoolean(),e.readBoolean(),Ct=e.readBoolean(),Ct&&(e.skipUEG(),e.skipUEG(),e.skipUEG(),e.skipUEG()),e.readBoolean()&&(J=e.readBits(32),Z=e.readBits(32),e.readBoolean()&&e.readUEG(),e.readBoolean())){const ti=e.readBoolean(),po=e.readBoolean();let Ts=!1;(ti||po)&&(Ts=e.readBoolean(),Ts&&(e.readUByte(),e.readBits(5),e.readBoolean(),e.readBits(5)),e.readBits(4),e.readBits(4),Ts&&e.readBits(4),e.readBits(5),e.readBits(5),e.readBits(5));for(let Eo=0;Eo<=s;Eo++){tt=e.readBoolean();const iA=tt||e.readBoolean();let Io=!1;iA?e.readEG():Io=e.readBoolean();const yo=Io?1:e.readUEG()+1;if(ti)for(let Bs=0;Bs<yo;Bs++)e.readUEG(),e.readUEG(),Ts&&(e.readUEG(),e.readUEG()),e.skipBits(1);if(po)for(let Bs=0;Bs<yo;Bs++)e.readUEG(),e.readUEG(),Ts&&(e.readUEG(),e.readUEG()),e.skipBits(1)}}e.readBoolean()&&(e.readBoolean(),e.readBoolean(),e.readBoolean(),M=e.readUEG())}let Qt=S,Ht=v;if(T){let st=1,Rt=1;C===1?st=Rt=2:C==2&&(st=2),Qt=S-st*L-st*x,Ht=v-Rt*D-Rt*B}const ge=i?["A","B","C"][i]:"",Ss=a<<24|c<<16|l<<8|h;let cn=0;for(let st=0;st<32;st++)cn=(cn|(Ss>>st&1)<<31-st)>>>0;let hn=cn.toString(16);return r===1&&hn==="2"&&(hn="6"),{codecString:`hvc1.${ge}${r}.${hn}.${n?"H":"L"}${E}.B0`,params:{general_tier_flag:n,general_profile_idc:r,general_profile_space:i,general_profile_compatibility_flags:[a,c,l,h],general_constraint_indicator_flags:[A,u,d,f,g,m],general_level_idc:E,bit_depth:R+8,bit_depth_luma_minus8:R,bit_depth_chroma_minus8:k,min_spatial_segmentation_idc:M,chroma_format_idc:C,frame_rate:{fixed:tt,fps:Z/J}},width:Qt,height:Ht,pixelRatio:[O,q]}}readPPS(t){const e=new Ks(this.ebsp2rbsp(t));e.readUByte(),e.readUByte(),e.skipUEG(),e.skipUEG(),e.skipBits(2),e.skipBits(3),e.skipBits(2),e.skipUEG(),e.skipUEG(),e.skipEG(),e.skipBits(2),e.readBoolean()&&e.skipUEG(),e.skipEG(),e.skipEG(),e.skipBits(4);const i=e.readBoolean(),n=e.readBoolean();let r=1;return n&&i?r=0:n?r=3:i&&(r=2),{parallelismType:r}}matchSPS(t,e){return String.fromCharCode.apply(null,t).substr(3)===String.fromCharCode.apply(null,e).substr(3)}}const St=188;class De{constructor(t,e,s,i){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=t,this.config=e,this.typeSupported=s,this.logger=i,this.videoParser=null}static probe(t,e){const s=De.syncOffset(t);return s>0&&e.warn(`MPEG2-TS detected but first sync word found @ offset ${s}`),s!==-1}static syncOffset(t){const e=t.length;let s=Math.min(St*5,e-St)+1,i=0;for(;i<s;){let n=!1,r=-1,a=0;for(let c=i;c<e;c+=St)if(t[c]===71&&(e-c===St||t[c+St]===71)){if(a++,r===-1&&(r=c,r!==0&&(s=Math.min(r+St*99,t.length-St)+1)),n||(n=fr(t,c)===0),n&&a>1&&(r===0&&a>2||c+St>s))return r}else{if(a)return-1;break}i++}return-1}static createTrack(t,e){return{container:t==="video"||t==="audio"?"video/mp2t":void 0,type:t,id:Nl[t],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:t==="audio"?e:void 0}}resetInitSegment(t,e,s,i){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=De.createTrack("video"),this._videoTrack.duration=i,this._audioTrack=De.createTrack("audio",i),this._id3Track=De.createTrack("id3"),this._txtTrack=De.createTrack("text"),this._audioTrack.segmentCodec="aac",this.videoParser=null,this.aacOverFlow=null,this.remainderData=null,this.audioCodec=e,this.videoCodec=s}resetTimeStamp(){}resetContiguity(){const{_audioTrack:t,_videoTrack:e,_id3Track:s}=this;t&&(t.pesData=null),e&&(e.pesData=null),s&&(s.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(t,e,s=!1,i=!1){s||(this.sampleAes=null);let n;const r=this._videoTrack,a=this._audioTrack,c=this._id3Track,l=this._txtTrack;let h=r.pid,A=r.pesData,u=a.pid,d=c.pid,f=a.pesData,g=c.pesData,m=null,E=this.pmtParsed,p=this._pmtId,I=t.length;if(this.remainderData&&(t=jt(this.remainderData,t),I=t.length,this.remainderData=null),I<St&&!i)return this.remainderData=t,{audioTrack:a,videoTrack:r,id3Track:c,textTrack:l};const C=Math.max(0,De.syncOffset(t));I-=(I-C)%St,I<t.byteLength&&!i&&(this.remainderData=new Uint8Array(t.buffer,I,t.buffer.byteLength-I));let S=0;for(let T=C;T<I;T+=St)if(t[T]===71){const x=!!(t[T+1]&64),L=fr(t,T),B=(t[T+3]&48)>>4;let D;if(B>1){if(D=T+5+t[T+4],D===T+St)continue}else D=T+4;switch(L){case h:x&&(A&&(n=Ze(A,this.logger))&&(this.readyVideoParser(r.segmentCodec),this.videoParser!==null&&this.videoParser.parsePES(r,l,n,!1)),A={data:[],size:0}),A&&(A.data.push(t.subarray(D,T+St)),A.size+=T+St-D);break;case u:if(x){if(f&&(n=Ze(f,this.logger)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,n);break;case"mp3":this.parseMPEGPES(a,n);break;case"ac3":this.parseAC3PES(a,n);break}f={data:[],size:0}}f&&(f.data.push(t.subarray(D,T+St)),f.size+=T+St-D);break;case d:x&&(g&&(n=Ze(g,this.logger))&&this.parseID3PES(c,n),g={data:[],size:0}),g&&(g.data.push(t.subarray(D,T+St)),g.size+=T+St-D);break;case 0:x&&(D+=t[D]+1),p=this._pmtId=Df(t,D);break;case p:{x&&(D+=t[D]+1);const R=Rf(t,D,this.typeSupported,s,this.observer,this.logger);h=R.videoPid,h>0&&(r.pid=h,r.segmentCodec=R.segmentVideoCodec),u=R.audioPid,u>0&&(a.pid=u,a.segmentCodec=R.segmentAudioCodec),d=R.id3Pid,d>0&&(c.pid=d),m!==null&&!E&&(this.logger.warn(`MPEG-TS PMT found at ${T} after unknown PID '${m}'. Backtracking to sync byte @${C} to parse all TS packets.`),m=null,T=C-188),E=this.pmtParsed=!0;break}case 17:case 8191:break;default:m=L;break}}else S++;S>0&&gr(this.observer,new Error(`Found ${S} TS packet/s that do not start with 0x47`),void 0,this.logger),r.pesData=A,a.pesData=f,c.pesData=g;const v={audioTrack:a,videoTrack:r,id3Track:c,textTrack:l};return i&&this.extractRemainingSamples(v),v}flush(){const{remainderData:t}=this;this.remainderData=null;let e;return t?e=this.demux(t,-1,!1,!0):e={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(e),this.sampleAes?this.decrypt(e,this.sampleAes):e}extractRemainingSamples(t){const{audioTrack:e,videoTrack:s,id3Track:i,textTrack:n}=t,r=s.pesData,a=e.pesData,c=i.pesData;let l;if(r&&(l=Ze(r,this.logger))?(this.readyVideoParser(s.segmentCodec),this.videoParser!==null&&(this.videoParser.parsePES(s,n,l,!0),s.pesData=null)):s.pesData=r,a&&(l=Ze(a,this.logger))){switch(e.segmentCodec){case"aac":this.parseAACPES(e,l);break;case"mp3":this.parseMPEGPES(e,l);break;case"ac3":this.parseAC3PES(e,l);break}e.pesData=null}else a!=null&&a.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),e.pesData=a;c&&(l=Ze(c,this.logger))?(this.parseID3PES(i,l),i.pesData=null):i.pesData=c}demuxSampleAes(t,e,s){const i=this.demux(t,s,!0,!this.config.progressive),n=this.sampleAes=new xf(this.observer,this.config,e);return this.decrypt(i,n)}readyVideoParser(t){this.videoParser===null&&(t==="avc"?this.videoParser=new vf:t==="hevc"&&(this.videoParser=new Lf))}decrypt(t,e){return new Promise(s=>{const{audioTrack:i,videoTrack:n}=t;i.samples&&i.segmentCodec==="aac"?e.decryptAacSamples(i.samples,0,()=>{n.samples?e.decryptAvcSamples(n.samples,0,0,()=>{s(t)}):s(t)}):n.samples&&e.decryptAvcSamples(n.samples,0,0,()=>{s(t)})})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0}parseAACPES(t,e){let s=0;const i=this.aacOverFlow;let n=e.data;if(i){this.aacOverFlow=null;const A=i.missing,u=i.sample.unit.byteLength;if(A===-1)n=jt(i.sample.unit,n);else{const d=u-A;i.sample.unit.set(n.subarray(0,A),d),t.samples.push(i.sample),s=i.missing}}let r,a;for(r=s,a=n.length;r<a-1&&!tn(n,r);r++);if(r!==s){let A;const u=r<a-1;if(u?A=`AAC PES did not start with ADTS header,offset:${r}`:A="No ADTS header found in AAC PES",gr(this.observer,new Error(A),u,this.logger),!u)return}Tc(t,this.observer,n,r,this.audioCodec);let c;if(e.pts!==void 0)c=e.pts;else if(i){const A=Bc(t.samplerate);c=i.sample.pts+A}else{this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}let l=0,h;for(;r<a;)if(h=xc(t,n,r,c,l),r+=h.length,h.missing){this.aacOverFlow=h;break}else for(l++;r<a-1&&!tn(n,r);r++);}parseMPEGPES(t,e){const s=e.data,i=s.length;let n=0,r=0;const a=e.pts;if(a===void 0){this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;r<i;)if(bc(s,r)){const c=Dc(t,s,r,a,n);if(c)r+=c.length,n++;else break}else r++}parseAC3PES(t,e){{const s=e.data,i=e.pts;if(i===void 0){this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");return}const n=s.length;let r=0,a=0,c;for(;a<n&&(c=_c(t,s,a,i,r++))>0;)a+=c}}parseID3PES(t,e){if(e.pts===void 0){this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const s=rt({},e,{type:this._videoTrack?Kt.emsg:Kt.audioId3,duration:Number.POSITIVE_INFINITY});t.samples.push(s)}}function fr(o,t){return((o[t+1]&31)<<8)+o[t+2]}function Df(o,t){return(o[t+10]&31)<<8|o[t+11]}function Rf(o,t,e,s,i,n){const r={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},a=(o[t+1]&15)<<8|o[t+2],c=t+3+a-4,l=(o[t+10]&15)<<8|o[t+11];for(t+=12+l;t<c;){const h=fr(o,t),A=(o[t+3]&15)<<8|o[t+4];switch(o[t]){case 207:if(!s){Cn("ADTS AAC",n);break}case 15:r.audioPid===-1&&(r.audioPid=h);break;case 21:r.id3Pid===-1&&(r.id3Pid=h);break;case 219:if(!s){Cn("H.264",n);break}case 27:r.videoPid===-1&&(r.videoPid=h);break;case 3:case 4:!e.mpeg&&!e.mp3?n.log("MPEG audio found, not supported in this browser"):r.audioPid===-1&&(r.audioPid=h,r.segmentAudioCodec="mp3");break;case 193:if(!s){Cn("AC-3",n);break}case 129:e.ac3?r.audioPid===-1&&(r.audioPid=h,r.segmentAudioCodec="ac3"):n.log("AC-3 audio found, not supported in this browser");break;case 6:if(r.audioPid===-1&&A>0){let u=t+5,d=A;for(;d>2;){o[u]===106&&(e.ac3!==!0?n.log("AC-3 audio found, not supported in this browser for now"):(r.audioPid=h,r.segmentAudioCodec="ac3"));const g=o[u+1]+2;u+=g,d-=g}}break;case 194:case 135:return gr(i,new Error("Unsupported EC-3 in M2TS found"),void 0,n),r;case 36:r.videoPid===-1&&(r.videoPid=h,r.segmentVideoCodec="hevc",n.log("HEVC in M2TS found"));break}t+=A+5}return r}function gr(o,t,e,s){s.warn(`parsing error: ${t.message}`),o.emit(y.ERROR,y.ERROR,{type:V.MEDIA_ERROR,details:w.FRAG_PARSING_ERROR,fatal:!1,levelRetry:e,error:t,reason:t.message})}function Cn(o,t){t.log(`${o} with AES-128-CBC encryption found in unencrypted stream`)}function Ze(o,t){let e=0,s,i,n,r,a;const c=o.data;if(!o||o.size===0)return null;for(;c[0].length<19&&c.length>1;)c[0]=jt(c[0],c[1]),c.splice(1,1);if(s=c[0],(s[0]<<16)+(s[1]<<8)+s[2]===1){if(i=(s[4]<<8)+s[5],i&&i>o.size-6)return null;const h=s[7];h&192&&(r=(s[9]&14)*536870912+(s[10]&255)*4194304+(s[11]&254)*16384+(s[12]&255)*128+(s[13]&254)/2,h&64?(a=(s[14]&14)*536870912+(s[15]&255)*4194304+(s[16]&254)*16384+(s[17]&255)*128+(s[18]&254)/2,r-a>60*9e4&&(t.warn(`${Math.round((r-a)/9e4)}s delta between PTS and DTS, align them`),r=a)):a=r),n=s[8];let A=n+9;if(o.size<=A)return null;o.size-=A;const u=new Uint8Array(o.size);for(let d=0,f=c.length;d<f;d++){s=c[d];let g=s.byteLength;if(A)if(A>g){A-=g;continue}else s=s.subarray(A),g-=A,A=0;u.set(s,e),e+=g}return i&&(i-=n+3),{data:u,pts:r,dts:a,len:i}}return null}class bf{static getSilentFrame(t,e){switch(t){case"mp4a.40.2":if(e===1)return new Uint8Array([0,200,0,128,35,128]);if(e===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(e===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(e===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(e===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(e===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(e===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(e===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(e===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const Be=Math.pow(2,32)-1;class b{static init(){b.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let t;for(t in b.types)b.types.hasOwnProperty(t)&&(b.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);const e=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),s=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);b.HDLR_TYPES={video:e,audio:s};const i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),n=new Uint8Array([0,0,0,0,0,0,0,0]);b.STTS=b.STSC=b.STCO=n,b.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),b.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),b.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),b.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const r=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),c=new Uint8Array([0,0,0,1]);b.FTYP=b.box(b.types.ftyp,r,c,r,a),b.DINF=b.box(b.types.dinf,b.box(b.types.dref,i))}static box(t,...e){let s=8,i=e.length;const n=i;for(;i--;)s+=e[i].byteLength;const r=new Uint8Array(s);for(r[0]=s>>24&255,r[1]=s>>16&255,r[2]=s>>8&255,r[3]=s&255,r.set(t,4),i=0,s=8;i<n;i++)r.set(e[i],s),s+=e[i].byteLength;return r}static hdlr(t){return b.box(b.types.hdlr,b.HDLR_TYPES[t])}static mdat(t){return b.box(b.types.mdat,t)}static mdhd(t,e){e*=t;const s=Math.floor(e/(Be+1)),i=Math.floor(e%(Be+1));return b.box(b.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,s>>24,s>>16&255,s>>8&255,s&255,i>>24,i>>16&255,i>>8&255,i&255,85,196,0,0]))}static mdia(t){return b.box(b.types.mdia,b.mdhd(t.timescale||0,t.duration||0),b.hdlr(t.type),b.minf(t))}static mfhd(t){return b.box(b.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]))}static minf(t){return t.type==="audio"?b.box(b.types.minf,b.box(b.types.smhd,b.SMHD),b.DINF,b.stbl(t)):b.box(b.types.minf,b.box(b.types.vmhd,b.VMHD),b.DINF,b.stbl(t))}static moof(t,e,s){return b.box(b.types.moof,b.mfhd(t),b.traf(s,e))}static moov(t){let e=t.length;const s=[];for(;e--;)s[e]=b.trak(t[e]);return b.box.apply(null,[b.types.moov,b.mvhd(t[0].timescale||0,t[0].duration||0)].concat(s).concat(b.mvex(t)))}static mvex(t){let e=t.length;const s=[];for(;e--;)s[e]=b.trex(t[e]);return b.box.apply(null,[b.types.mvex,...s])}static mvhd(t,e){e*=t;const s=Math.floor(e/(Be+1)),i=Math.floor(e%(Be+1)),n=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,s>>24,s>>16&255,s>>8&255,s&255,i>>24,i>>16&255,i>>8&255,i&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return b.box(b.types.mvhd,n)}static sdtp(t){const e=t.samples||[],s=new Uint8Array(4+e.length);let i,n;for(i=0;i<e.length;i++)n=e[i].flags,s[i+4]=n.dependsOn<<4|n.isDependedOn<<2|n.hasRedundancy;return b.box(b.types.sdtp,s)}static stbl(t){return b.box(b.types.stbl,b.stsd(t),b.box(b.types.stts,b.STTS),b.box(b.types.stsc,b.STSC),b.box(b.types.stsz,b.STSZ),b.box(b.types.stco,b.STCO))}static avc1(t){let e=[],s=[],i,n,r;for(i=0;i<t.sps.length;i++)n=t.sps[i],r=n.byteLength,e.push(r>>>8&255),e.push(r&255),e=e.concat(Array.prototype.slice.call(n));for(i=0;i<t.pps.length;i++)n=t.pps[i],r=n.byteLength,s.push(r>>>8&255),s.push(r&255),s=s.concat(Array.prototype.slice.call(n));const a=b.box(b.types.avcC,new Uint8Array([1,e[3],e[4],e[5],255,224|t.sps.length].concat(e).concat([t.pps.length]).concat(s))),c=t.width,l=t.height,h=t.pixelRatio[0],A=t.pixelRatio[1];return b.box(b.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,c>>8&255,c&255,l>>8&255,l&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,b.box(b.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),b.box(b.types.pasp,new Uint8Array([h>>24,h>>16&255,h>>8&255,h&255,A>>24,A>>16&255,A>>8&255,A&255])))}static esds(t){const e=t.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...e,6,1,2])}static audioStsd(t){const e=t.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount||0,0,16,0,0,0,0,e>>8&255,e&255,0,0])}static mp4a(t){return b.box(b.types.mp4a,b.audioStsd(t),b.box(b.types.esds,b.esds(t)))}static mp3(t){return b.box(b.types[".mp3"],b.audioStsd(t))}static ac3(t){return b.box(b.types["ac-3"],b.audioStsd(t),b.box(b.types.dac3,t.config))}static stsd(t){const{segmentCodec:e}=t;if(t.type==="audio"){if(e==="aac")return b.box(b.types.stsd,b.STSD,b.mp4a(t));if(e==="ac3"&&t.config)return b.box(b.types.stsd,b.STSD,b.ac3(t));if(e==="mp3"&&t.codec==="mp3")return b.box(b.types.stsd,b.STSD,b.mp3(t))}else if(t.pps&&t.sps){if(e==="avc")return b.box(b.types.stsd,b.STSD,b.avc1(t));if(e==="hevc"&&t.vps)return b.box(b.types.stsd,b.STSD,b.hvc1(t))}else throw new Error("video track missing pps or sps");throw new Error(`unsupported ${t.type} segment codec (${e}/${t.codec})`)}static tkhd(t){const e=t.id,s=(t.duration||0)*(t.timescale||0),i=t.width||0,n=t.height||0,r=Math.floor(s/(Be+1)),a=Math.floor(s%(Be+1));return b.box(b.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,0,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,a>>24,a>>16&255,a>>8&255,a&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,i>>8&255,i&255,0,0,n>>8&255,n&255,0,0]))}static traf(t,e){const s=b.sdtp(t),i=t.id,n=Math.floor(e/(Be+1)),r=Math.floor(e%(Be+1));return b.box(b.types.traf,b.box(b.types.tfhd,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,i&255])),b.box(b.types.tfdt,new Uint8Array([1,0,0,0,n>>24,n>>16&255,n>>8&255,n&255,r>>24,r>>16&255,r>>8&255,r&255])),b.trun(t,s.length+16+20+8+16+8+8),s)}static trak(t){return t.duration=t.duration||4294967295,b.box(b.types.trak,b.tkhd(t),b.mdia(t))}static trex(t){const e=t.id;return b.box(b.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(t,e){const s=t.samples||[],i=s.length,n=12+16*i,r=new Uint8Array(n);let a,c,l,h,A,u;for(e+=8+n,r.set([t.type==="video"?1:0,0,15,1,i>>>24&255,i>>>16&255,i>>>8&255,i&255,e>>>24&255,e>>>16&255,e>>>8&255,e&255],0),a=0;a<i;a++)c=s[a],l=c.duration,h=c.size,A=c.flags,u=c.cts,r.set([l>>>24&255,l>>>16&255,l>>>8&255,l&255,h>>>24&255,h>>>16&255,h>>>8&255,h&255,A.isLeading<<2|A.dependsOn,A.isDependedOn<<6|A.hasRedundancy<<4|A.paddingValue<<1|A.isNonSync,A.degradPrio&61440,A.degradPrio&15,u>>>24&255,u>>>16&255,u>>>8&255,u&255],12+16*a);return b.box(b.types.trun,r)}static initSegment(t){b.types||b.init();const e=b.moov(t);return jt(b.FTYP,e)}static hvc1(t){const e=t.params,s=[t.vps,t.sps,t.pps],i=4,n=new Uint8Array([1,e.general_profile_space<<6|(e.general_tier_flag?32:0)|e.general_profile_idc,e.general_profile_compatibility_flags[0],e.general_profile_compatibility_flags[1],e.general_profile_compatibility_flags[2],e.general_profile_compatibility_flags[3],e.general_constraint_indicator_flags[0],e.general_constraint_indicator_flags[1],e.general_constraint_indicator_flags[2],e.general_constraint_indicator_flags[3],e.general_constraint_indicator_flags[4],e.general_constraint_indicator_flags[5],e.general_level_idc,240|e.min_spatial_segmentation_idc>>8,255&e.min_spatial_segmentation_idc,252|e.parallelismType,252|e.chroma_format_idc,248|e.bit_depth_luma_minus8,248|e.bit_depth_chroma_minus8,0,parseInt(e.frame_rate.fps),i-1|e.temporal_id_nested<<2|e.num_temporal_layers<<3|(e.frame_rate.fixed?64:0),s.length]);let r=n.length;for(let f=0;f<s.length;f+=1){r+=3;for(let g=0;g<s[f].length;g+=1)r+=2+s[f][g].length}const a=new Uint8Array(r);a.set(n,0),r=n.length;const c=s.length-1;for(let f=0;f<s.length;f+=1){a.set(new Uint8Array([32+f|(f===c?128:0),0,s[f].length]),r),r+=3;for(let g=0;g<s[f].length;g+=1)a.set(new Uint8Array([s[f][g].length>>8,s[f][g].length&255]),r),r+=2,a.set(s[f][g],r),r+=s[f][g].length}const l=b.box(b.types.hvcC,a),h=t.width,A=t.height,u=t.pixelRatio[0],d=t.pixelRatio[1];return b.box(b.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,h>>8&255,h&255,A>>8&255,A&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l,b.box(b.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),b.box(b.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,u&255,d>>24,d>>16&255,d>>8&255,d&255])))}}b.types=void 0;b.HDLR_TYPES=void 0;b.STTS=void 0;b.STSC=void 0;b.STCO=void 0;b.STSZ=void 0;b.VMHD=void 0;b.SMHD=void 0;b.STSD=void 0;b.FTYP=void 0;b.DINF=void 0;const Fc=9e4;function to(o,t,e=1,s=!1){const i=o*t*e;return s?Math.round(i):i}function wf(o,t,e=1,s=!1){return to(o,t,1/e,s)}function xs(o,t=!1){return to(o,1e3,1/Fc,t)}function kf(o,t=1){return to(o,Fc,1/t)}function pa(o){const{baseTime:t,timescale:e,trackId:s}=o;return`${t/e} (${t}/${e}) trackId: ${s}`}const _f=10*1e3,Pf=1024,Ff=1152,Qf=1536;let ts=null,Sn=null;function Ea(o,t,e,s){return{duration:t,size:e,cts:s,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:o?2:1,isNonSync:o?0:1}}}class Qi extends zt{constructor(t,e,s,i){if(super("mp4-remuxer",i),this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextVideoTs=null,this.nextAudioTs=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=t,this.config=e,this.typeSupported=s,this.ISGenerated=!1,ts===null){const r=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);ts=r?parseInt(r[1]):0}if(Sn===null){const n=navigator.userAgent.match(/Safari\/(\d+)/i);Sn=n?parseInt(n[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(t){const e=this._initPTS;(!e||!t||t.trackId!==e.trackId||t.baseTime!==e.baseTime||t.timescale!==e.timescale)&&this.log(`Reset initPTS: ${e&&pa(e)} > ${t&&pa(t)}`),this._initPTS=this._initDTS=t}resetNextTimestamp(){this.log("reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){this.log("ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(t){let e=!1;const s=t[0].pts,i=t.reduce((n,r)=>{let a=r.pts,c=a-n;return c<-4294967296&&(e=!0,a=Gt(a,s),c=a-n),c>0?n:a},s);return e&&this.debug("PTS rollover detected"),i}remux(t,e,s,i,n,r,a,c){let l,h,A,u,d,f,g=n,m=n;const E=t.pid>-1,p=e.pid>-1,I=e.samples.length,C=t.samples.length>0,S=a&&I>0||I>1;if((!E||C)&&(!p||S)||this.ISGenerated||a){if(this.ISGenerated){var T,x,L,B;const _=this.videoTrackConfig;(_&&(e.width!==_.width||e.height!==_.height||((T=e.pixelRatio)==null?void 0:T[0])!==((x=_.pixelRatio)==null?void 0:x[0])||((L=e.pixelRatio)==null?void 0:L[1])!==((B=_.pixelRatio)==null?void 0:B[1]))||!_&&S||this.nextAudioTs===null&&C)&&this.resetInitSegment()}this.ISGenerated||(A=this.generateIS(t,e,n,r));const D=this.isVideoContiguous;let R=-1,k;if(S&&(R=Mf(e.samples),!D&&this.config.forceKeyFrameOnDiscontinuity))if(f=!0,R>0){this.warn(`Dropped ${R} out of ${I} video samples due to a missing keyframe`);const _=this.getVideoStartPts(e.samples);e.samples=e.samples.slice(R),e.dropped+=R,m+=(e.samples[0].pts-_)/e.inputTimeScale,k=m}else R===-1&&(this.warn(`No keyframe found out of ${I} video samples`),f=!1);if(this.ISGenerated){if(C&&S){const _=this.getVideoStartPts(e.samples),F=(Gt(t.samples[0].pts,_)-_)/e.inputTimeScale;g+=Math.max(0,F),m+=Math.max(0,-F)}if(C){if(t.samplerate||(this.warn("regenerate InitSegment as audio detected"),A=this.generateIS(t,e,n,r)),h=this.remuxAudio(t,g,this.isAudioContiguous,r,p||S||c===H.AUDIO?m:void 0),S){const _=h?h.endPTS-h.startPTS:0;e.inputTimeScale||(this.warn("regenerate InitSegment as video detected"),A=this.generateIS(t,e,n,r)),l=this.remuxVideo(e,m,D,_)}}else S&&(l=this.remuxVideo(e,m,D,0));l&&(l.firstKeyFrame=R,l.independent=R!==-1,l.firstKeyFramePTS=k)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(s.samples.length&&(d=Qc(s,n,this._initPTS,this._initDTS)),i.samples.length&&(u=Mc(i,n,this._initPTS))),{audio:h,video:l,initSegment:A,independent:f,text:u,id3:d}}computeInitPts(t,e,s,i){const n=Math.round(s*e);let r=Gt(t,n);if(r<n+e)for(this.log(`Adjusting PTS for rollover in timeline near ${(n-r)/e} ${i}`);r<n+e;)r+=8589934592;return r-n}generateIS(t,e,s,i){const n=t.samples,r=e.samples,a=this.typeSupported,c={},l=this._initPTS;let h=!l||i,A="audio/mp4",u,d,f,g=-1;if(h&&(u=d=1/0),t.config&&n.length){switch(t.timescale=t.samplerate,t.segmentCodec){case"mp3":a.mpeg?(A="audio/mpeg",t.codec=""):a.mp3&&(t.codec="mp3");break;case"ac3":t.codec="ac-3";break}c.audio={id:"audio",container:A,codec:t.codec,initSegment:t.segmentCodec==="mp3"&&a.mpeg?new Uint8Array(0):b.initSegment([t]),metadata:{channelCount:t.channelCount}},h&&(g=t.id,f=t.inputTimeScale,!l||f!==l.timescale?u=d=this.computeInitPts(n[0].pts,f,s,"audio"):h=!1)}if(e.sps&&e.pps&&r.length){if(e.timescale=e.inputTimeScale,c.video={id:"main",container:"video/mp4",codec:e.codec,initSegment:b.initSegment([e]),metadata:{width:e.width,height:e.height}},h)if(g=e.id,f=e.inputTimeScale,!l||f!==l.timescale){const m=this.getVideoStartPts(r),E=Gt(r[0].dts,m),p=this.computeInitPts(E,f,s,"video"),I=this.computeInitPts(m,f,s,"video");d=Math.min(d,p),u=Math.min(u,I)}else h=!1;this.videoTrackConfig={width:e.width,height:e.height,pixelRatio:e.pixelRatio}}if(Object.keys(c).length)return this.ISGenerated=!0,h?(l&&this.warn(`Timestamps at playlist time: ${i?"":"~"}${s} ${u/f} != initPTS: ${l.baseTime/l.timescale} (${l.baseTime}/${l.timescale}) trackId: ${l.trackId}`),this.log(`Found initPTS at playlist time: ${s} offset: ${u/f} (${u}/${f}) trackId: ${g}`),this._initPTS={baseTime:u,timescale:f,trackId:g},this._initDTS={baseTime:d,timescale:f,trackId:g}):u=f=void 0,{tracks:c,initPTS:u,timescale:f,trackId:g}}remuxVideo(t,e,s,i){const n=t.inputTimeScale,r=t.samples,a=[],c=r.length,l=this._initPTS,h=l.baseTime*n/l.timescale;let A=this.nextVideoTs,u=8,d=this.videoSampleDuration,f,g,m=Number.POSITIVE_INFINITY,E=Number.NEGATIVE_INFINITY,p=!1;if(!s||A===null){const M=h+e*n,O=r[0].pts-Gt(r[0].dts,r[0].pts);ts&&A!==null&&Math.abs(M-O-(A+h))<15e3?s=!0:A=M-O-h}const I=A+h;for(let M=0;M<c;M++){const O=r[M];O.pts=Gt(O.pts,I),O.dts=Gt(O.dts,I),O.dts<r[M>0?M-1:M].dts&&(p=!0)}p&&r.sort(function(M,O){const q=M.dts-O.dts,tt=M.pts-O.pts;return q||tt}),f=r[0].dts,g=r[r.length-1].dts;const C=g-f,S=C?Math.round(C/(c-1)):d||t.inputTimeScale/30;if(s){const M=f-I,O=M>S,q=M<-1;if((O||q)&&(O?this.warn(`${(t.segmentCodec||"").toUpperCase()}: ${xs(M,!0)} ms (${M}dts) hole between fragments detected at ${e.toFixed(3)}`):this.warn(`${(t.segmentCodec||"").toUpperCase()}: ${xs(-M,!0)} ms (${M}dts) overlapping between fragments detected at ${e.toFixed(3)}`),!q||I>=r[0].pts||ts)){f=I;const tt=r[0].pts-M;if(O)r[0].dts=f,r[0].pts=tt;else{let J=!0;for(let Z=0;Z<r.length&&!(r[Z].dts>tt&&J);Z++){const Ct=r[Z].pts;if(r[Z].dts-=M,r[Z].pts-=M,Z<r.length-1){const mt=r[Z+1].pts,Qt=r[Z].pts,Ht=mt<=Qt,ge=mt<=Ct;J=Ht==ge}}}this.log(`Video: Initial PTS/DTS adjusted: ${xs(tt,!0)}/${xs(f,!0)}, delta: ${xs(M,!0)} ms`)}}f=Math.max(0,f);let v=0,T=0,x=f;for(let M=0;M<c;M++){const O=r[M],q=O.units,tt=q.length;let J=0;for(let Z=0;Z<tt;Z++)J+=q[Z].data.length;T+=J,v+=tt,O.length=J,O.dts<x?(O.dts=x,x+=S/4|0||1):x=O.dts,m=Math.min(O.pts,m),E=Math.max(O.pts,E)}g=r[c-1].dts;const L=T+4*v+8;let B;try{B=new Uint8Array(L)}catch(M){this.observer.emit(y.ERROR,y.ERROR,{type:V.MUX_ERROR,details:w.REMUX_ALLOC_ERROR,fatal:!1,error:M,bytes:L,reason:`fail allocating video mdat ${L}`});return}const D=new DataView(B.buffer);D.setUint32(0,L),B.set(b.types.mdat,4);let R=!1,k=Number.POSITIVE_INFINITY,_=Number.POSITIVE_INFINITY,Q=Number.NEGATIVE_INFINITY,F=Number.NEGATIVE_INFINITY;for(let M=0;M<c;M++){const O=r[M],q=O.units;let tt=0;for(let Ct=0,mt=q.length;Ct<mt;Ct++){const Qt=q[Ct],Ht=Qt.data,ge=Qt.data.byteLength;D.setUint32(u,ge),u+=4,B.set(Ht,u),u+=ge,tt+=4+ge}let J;if(M<c-1)d=r[M+1].dts-O.dts,J=r[M+1].pts-O.pts;else{const Ct=this.config,mt=M>0?O.dts-r[M-1].dts:S;if(J=M>0?O.pts-r[M-1].pts:S,Ct.stretchShortVideoTrack&&this.nextAudioTs!==null){const Qt=Math.floor(Ct.maxBufferHole*n),Ht=(i?m+i*n:this.nextAudioTs+h)-O.pts;Ht>Qt?(d=Ht-mt,d<0?d=mt:R=!0,this.log(`It is approximately ${Ht/90} ms to the next segment; using duration ${d/90} ms for the last video frame.`)):d=mt}else d=mt}const Z=Math.round(O.pts-O.dts);k=Math.min(k,d),Q=Math.max(Q,d),_=Math.min(_,J),F=Math.max(F,J),a.push(Ea(O.key,d,tt,Z))}if(a.length){if(ts){if(ts<70){const M=a[0].flags;M.dependsOn=2,M.isNonSync=0}}else if(Sn&&F-_<Q-k&&S/Q<.025&&a[0].cts===0){this.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let M=f;for(let O=0,q=a.length;O<q;O++){const tt=M+a[O].duration,J=M+a[O].cts;if(O<q-1){const Z=tt+a[O+1].cts;a[O].duration=Z-J}else a[O].duration=O?a[O-1].duration:S;a[O].cts=0,M=tt}}}d=R||!d?S:d;const G=g+d;this.nextVideoTs=A=G-h,this.videoSampleDuration=d,this.isVideoContiguous=!0;const Y={data1:b.moof(t.sequenceNumber++,f,rt(t,{samples:a})),data2:B,startPTS:(m-h)/n,endPTS:(E+d-h)/n,startDTS:(f-h)/n,endDTS:A/n,type:"video",hasAudio:!1,hasVideo:!0,nb:a.length,dropped:t.dropped};return t.samples=[],t.dropped=0,Y}getSamplesPerFrame(t){switch(t.segmentCodec){case"mp3":return Ff;case"ac3":return Qf;default:return Pf}}remuxAudio(t,e,s,i,n){const r=t.inputTimeScale,a=t.samplerate?t.samplerate:r,c=r/a,l=this.getSamplesPerFrame(t),h=l*c,A=this._initPTS,u=t.segmentCodec==="mp3"&&this.typeSupported.mpeg,d=[],f=n!==void 0;let g=t.samples,m=u?0:8,E=this.nextAudioTs||-1;const p=A.baseTime*r/A.timescale,I=p+e*r;if(this.isAudioContiguous=s=s||g.length&&E>0&&(i&&Math.abs(I-(E+p))<9e3||Math.abs(Gt(g[0].pts,I)-(E+p))<20*h),g.forEach(function(F){F.pts=Gt(F.pts,I)}),!s||E<0){const F=g.length;if(g=g.filter(G=>G.pts>=0),F!==g.length&&this.warn(`Removed ${g.length-F} of ${F} samples (initPTS ${p} / ${r})`),!g.length)return;n===0?E=0:i&&!f?E=Math.max(0,I-p):E=g[0].pts-p}if(t.segmentCodec==="aac"){const F=this.config.maxAudioFramesDrift;for(let G=0,N=E+p;G<g.length;G++){const $=g[G],Y=$.pts,M=Y-N,O=Math.abs(1e3*M/r);if(M<=-F*h&&f)G===0&&(this.warn(`Audio frame @ ${(Y/r).toFixed(3)}s overlaps marker by ${Math.round(1e3*M/r)} ms.`),this.nextAudioTs=E=Y-p,N=Y);else if(M>=F*h&&O<_f&&f){let q=Math.round(M/h);for(N=Y-q*h;N<0&&q&&h;)q--,N+=h;G===0&&(this.nextAudioTs=E=N-p),this.warn(`Injecting ${q} audio frames @ ${((N-p)/r).toFixed(3)}s due to ${Math.round(1e3*M/r)} ms gap.`);for(let tt=0;tt<q;tt++){let J=bf.getSilentFrame(t.parsedCodec||t.manifestCodec||t.codec,t.channelCount);J||(this.log("Unable to get silent frame for given audio codec; duplicating last frame instead."),J=$.unit.subarray()),g.splice(G,0,{unit:J,pts:N}),N+=h,G++}}$.pts=N,N+=h}}let C=null,S=null,v,T=0,x=g.length;for(;x--;)T+=g[x].unit.byteLength;for(let F=0,G=g.length;F<G;F++){const N=g[F],$=N.unit;let Y=N.pts;if(S!==null){const O=d[F-1];O.duration=Math.round((Y-S)/c)}else if(s&&t.segmentCodec==="aac"&&(Y=E+p),C=Y,T>0){T+=m;try{v=new Uint8Array(T)}catch(O){this.observer.emit(y.ERROR,y.ERROR,{type:V.MUX_ERROR,details:w.REMUX_ALLOC_ERROR,fatal:!1,error:O,bytes:T,reason:`fail allocating audio mdat ${T}`});return}u||(new DataView(v.buffer).setUint32(0,T),v.set(b.types.mdat,4))}else return;v.set($,m);const M=$.byteLength;m+=M,d.push(Ea(!0,l,M,0)),S=Y}const L=d.length;if(!L)return;const B=d[d.length-1];E=S-p,this.nextAudioTs=E+c*B.duration;const D=u?new Uint8Array(0):b.moof(t.sequenceNumber++,C/c,rt({},t,{samples:d}));t.samples=[];const R=(C-p)/r,k=this.nextAudioTs/r,Q={data1:D,data2:v,startPTS:R,endPTS:k,startDTS:R,endDTS:k,type:"audio",hasAudio:!0,hasVideo:!1,nb:L};return this.isAudioContiguous=!0,Q}}function Gt(o,t){let e;if(t===null)return o;for(t<o?e=-8589934592:e=8589934592;Math.abs(o-t)>4294967296;)o+=e;return o}function Mf(o){for(let t=0;t<o.length;t++)if(o[t].key)return t;return-1}function Qc(o,t,e,s){const i=o.samples.length;if(!i)return;const n=o.inputTimeScale;for(let a=0;a<i;a++){const c=o.samples[a];c.pts=Gt(c.pts-e.baseTime*n/e.timescale,t*n)/n,c.dts=Gt(c.dts-s.baseTime*n/s.timescale,t*n)/n}const r=o.samples;return o.samples=[],{samples:r}}function Mc(o,t,e){const s=o.samples.length;if(!s)return;const i=o.inputTimeScale;for(let r=0;r<s;r++){const a=o.samples[r];a.pts=Gt(a.pts-e.baseTime*i/e.timescale,t*i)/i}o.samples.sort((r,a)=>r.pts-a.pts);const n=o.samples;return o.samples=[],{samples:n}}class Of extends zt{constructor(t,e,s,i){super("passthrough-remuxer",i),this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.isVideoContiguous=!1}destroy(){}resetTimeStamp(t){this.lastEndTime=null;const e=this.initPTS;e&&t&&e.baseTime===t.baseTime&&e.timescale===t.timescale||(this.initPTS=t)}resetNextTimestamp(){this.isVideoContiguous=!1,this.lastEndTime=null}resetInitSegment(t,e,s,i){this.audioCodec=e,this.videoCodec=s,this.generateInitSegment(t,i),this.emitInitSegment=!0}generateInitSegment(t,e){let{audioCodec:s,videoCodec:i}=this;if(!(t!=null&&t.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const{audio:n,video:r}=this.initData=$l(t);if(e)Bu(t,e);else{const c=n||r;c!=null&&c.encrypted&&this.warn(`Init segment with encrypted track with has no key ("${c.codec}")!`)}n&&(s=Ia(n,ot.AUDIO,this)),r&&(i=Ia(r,ot.VIDEO,this));const a={};n&&r?a.audiovideo={container:"video/mp4",codec:s+","+i,supplemental:r.supplemental,encrypted:r.encrypted,initSegment:t,id:"main"}:n?a.audio={container:"audio/mp4",codec:s,encrypted:n.encrypted,initSegment:t,id:"audio"}:r?a.video={container:"video/mp4",codec:i,supplemental:r.supplemental,encrypted:r.encrypted,initSegment:t,id:"main"}:this.warn("initSegment does not contain moov or trak boxes."),this.initTracks=a}remux(t,e,s,i,n,r){var a,c;let{initPTS:l,lastEndTime:h}=this;const A={audio:void 0,video:void 0,text:i,id3:s,initSegment:void 0};K(h)||(h=this.lastEndTime=n||0);const u=e.samples;if(!u.length)return A;const d={initPTS:void 0,timescale:void 0,trackId:void 0};let f=this.initData;if((a=f)!=null&&a.length||(this.generateInitSegment(u),f=this.initData),!((c=f)!=null&&c.length))return this.warn("Failed to generate initSegment."),A;this.emitInitSegment&&(d.tracks=this.initTracks,this.emitInitSegment=!1);const g=vu(u,f,this),m=f.audio?g[f.audio.id]:null,E=f.video?g[f.video.id]:null,p=ai(E,1/0),I=ai(m,1/0),C=ai(E,0,!0),S=ai(m,0,!0);let v=n,T=0;const x=m&&(!E||!l&&I<p||l&&l.trackId===f.audio.id),L=x?m:E;if(L){const N=L.timescale,$=L.start-n*N,Y=x?f.audio.id:f.video.id;v=L.start/N,T=x?S-I:C-p,(r||!l)&&(Uf(l,v,n,T)||N!==l.timescale)&&(l&&this.warn(`Timestamps at playlist time: ${r?"":"~"}${n} ${$/N} != initPTS: ${l.baseTime/l.timescale} (${l.baseTime}/${l.timescale}) trackId: ${l.trackId}`),this.log(`Found initPTS at playlist time: ${n} offset: ${v-n} (${$}/${N}) trackId: ${Y}`),l=null,d.initPTS=$,d.timescale=N,d.trackId=Y)}else this.warn(`No audio or video samples found for initPTS at playlist time: ${n}`);l?(d.initPTS=l.baseTime,d.timescale=l.timescale,d.trackId=l.trackId):((!d.timescale||d.trackId===void 0||d.initPTS===void 0)&&(this.warn("Could not set initPTS"),d.initPTS=v,d.timescale=1,d.trackId=-1),this.initPTS=l={baseTime:d.initPTS,timescale:d.timescale,trackId:d.trackId});const B=v-l.baseTime/l.timescale,D=B+T;T>0?this.lastEndTime=D:(this.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const R=!!f.audio,k=!!f.video;let _="";R&&(_+="audio"),k&&(_+="video");const Q=(f.audio?f.audio.encrypted:!1)||(f.video?f.video.encrypted:!1),F={data1:u,startPTS:B,startDTS:B,endPTS:D,endDTS:D,type:_,hasAudio:R,hasVideo:k,nb:1,dropped:0,encrypted:Q};A.audio=R&&!k?F:void 0,A.video=k?F:void 0;const G=E?.sampleCount;if(G){const N=E.keyFrameIndex,$=N!==-1;F.nb=G,F.dropped=N===0||this.isVideoContiguous?0:$?N:G,F.independent=$,F.firstKeyFrame=N,$&&E.keyFrameStart&&(F.firstKeyFramePTS=(E.keyFrameStart-l.baseTime)/l.timescale),this.isVideoContiguous||(A.independent=$),this.isVideoContiguous||(this.isVideoContiguous=$),F.dropped&&this.warn(`fmp4 does not start with IDR: firstIDR ${N}/${G} dropped: ${F.dropped} start: ${F.firstKeyFramePTS||"NA"}`)}return A.initSegment=d,A.id3=Qc(s,n,l,l),i.samples.length&&(A.text=Mc(i,n,l)),A}}function ai(o,t,e=!1){return o?.start!==void 0?(o.start+(e?o.duration:0))/o.timescale:t}function Uf(o,t,e,s){if(o===null)return!0;const i=Math.max(s,1),n=t-o.baseTime/o.timescale;return Math.abs(n-e)>i}function Ia(o,t,e){const s=o.codec;return s&&s.length>4?s:t===ot.AUDIO?s==="ec-3"||s==="ac-3"||s==="alac"?s:s==="fLaC"||s==="Opus"?Yi(s,!1):(e.warn(`Unhandled audio codec "${s}" in mp4 MAP`),s||"mp4a"):(e.warn(`Unhandled video codec "${s}" in mp4 MAP`),s||"avc1")}let Ce;try{Ce=self.performance.now.bind(self.performance)}catch{Ce=Date.now}const Mi=[{demux:Bf,remux:Of},{demux:De,remux:Qi},{demux:yf,remux:Qi},{demux:Sf,remux:Qi}];Mi.splice(2,0,{demux:Cf,remux:Qi});class ya{constructor(t,e,s,i,n,r){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=t,this.typeSupported=e,this.config=s,this.id=n,this.logger=r}configure(t){this.transmuxConfig=t,this.decrypter&&this.decrypter.reset()}push(t,e,s,i){const n=s.transmuxing;n.executeStart=Ce();let r=new Uint8Array(t);const{currentTransmuxState:a,transmuxConfig:c}=this;i&&(this.currentTransmuxState=i);const{contiguous:l,discontinuity:h,trackSwitch:A,accurateTimeOffset:u,timeOffset:d,initSegmentChange:f}=i||a,{audioCodec:g,videoCodec:m,defaultInitPts:E,duration:p,initSegmentData:I}=c,C=Nf(r,e);if(C&&ps(C.method)){const x=this.getDecrypter(),L=Vr(C.method);if(x.isSync()){let B=x.softwareDecrypt(r,C.key.buffer,C.iv.buffer,L);if(s.part>-1){const R=x.flush();B=R&&R.buffer}if(!B)return n.executeEnd=Ce(),Tn(s);r=new Uint8Array(B)}else return this.asyncResult=!0,this.decryptionPromise=x.webCryptoDecrypt(r,C.key.buffer,C.iv.buffer,L).then(B=>{const D=this.push(B,null,s);return this.decryptionPromise=null,D}),this.decryptionPromise}const S=this.needsProbing(h,A);if(S){const x=this.configureTransmuxer(r);if(x)return this.logger.warn(`[transmuxer] ${x.message}`),this.observer.emit(y.ERROR,y.ERROR,{type:V.MEDIA_ERROR,details:w.FRAG_PARSING_ERROR,fatal:!1,error:x,reason:x.message}),n.executeEnd=Ce(),Tn(s)}(h||A||f||S)&&this.resetInitSegment(I,g,m,p,e),(h||f||S)&&this.resetInitialTimestamp(E),l||this.resetContiguity();const v=this.transmux(r,C,d,u,s);this.asyncResult=Xs(v);const T=this.currentTransmuxState;return T.contiguous=!0,T.discontinuity=!1,T.trackSwitch=!1,n.executeEnd=Ce(),v}flush(t){const e=t.transmuxing;e.executeStart=Ce();const{decrypter:s,currentTransmuxState:i,decryptionPromise:n}=this;if(n)return this.asyncResult=!0,n.then(()=>this.flush(t));const r=[],{timeOffset:a}=i;if(s){const A=s.flush();A&&r.push(this.push(A.buffer,null,t))}const{demuxer:c,remuxer:l}=this;if(!c||!l){e.executeEnd=Ce();const A=[Tn(t)];return this.asyncResult?Promise.resolve(A):A}const h=c.flush(a);return Xs(h)?(this.asyncResult=!0,h.then(A=>(this.flushRemux(r,A,t),r))):(this.flushRemux(r,h,t),this.asyncResult?Promise.resolve(r):r)}flushRemux(t,e,s){const{audioTrack:i,videoTrack:n,id3Track:r,textTrack:a}=e,{accurateTimeOffset:c,timeOffset:l}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${s.sn}${s.part>-1?" part: "+s.part:""} of ${this.id===H.MAIN?"level":"track"} ${s.level}`);const h=this.remuxer.remux(i,n,r,a,l,c,!0,this.id);t.push({remuxResult:h,chunkMeta:s}),s.transmuxing.executeEnd=Ce()}resetInitialTimestamp(t){const{demuxer:e,remuxer:s}=this;!e||!s||(e.resetTimeStamp(t),s.resetTimeStamp(t))}resetContiguity(){const{demuxer:t,remuxer:e}=this;!t||!e||(t.resetContiguity(),e.resetNextTimestamp())}resetInitSegment(t,e,s,i,n){const{demuxer:r,remuxer:a}=this;!r||!a||(r.resetInitSegment(t,e,s,i),a.resetInitSegment(t,e,s,n))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(t,e,s,i,n){let r;return e&&e.method==="SAMPLE-AES"?r=this.transmuxSampleAes(t,e,s,i,n):r=this.transmuxUnencrypted(t,s,i,n),r}transmuxUnencrypted(t,e,s,i){const{audioTrack:n,videoTrack:r,id3Track:a,textTrack:c}=this.demuxer.demux(t,e,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(n,r,a,c,e,s,!1,this.id),chunkMeta:i}}transmuxSampleAes(t,e,s,i,n){return this.demuxer.demuxSampleAes(t,e,s).then(r=>({remuxResult:this.remuxer.remux(r.audioTrack,r.videoTrack,r.id3Track,r.textTrack,s,i,!1,this.id),chunkMeta:n}))}configureTransmuxer(t){const{config:e,observer:s,typeSupported:i}=this;let n;for(let A=0,u=Mi.length;A<u;A++){var r;if((r=Mi[A].demux)!=null&&r.probe(t,this.logger)){n=Mi[A];break}}if(!n)return new Error("Failed to find demuxer by probing fragment data");const a=this.demuxer,c=this.remuxer,l=n.remux,h=n.demux;(!c||!(c instanceof l))&&(this.remuxer=new l(s,e,i,this.logger)),(!a||!(a instanceof h))&&(this.demuxer=new h(s,e,i,this.logger),this.probe=h.probe)}needsProbing(t,e){return!this.demuxer||!this.remuxer||t||e}getDecrypter(){let t=this.decrypter;return t||(t=this.decrypter=new $r(this.config)),t}}function Nf(o,t){let e=null;return o.byteLength>0&&t?.key!=null&&t.iv!==null&&t.method!=null&&(e=t),e}const Tn=o=>({remuxResult:{},chunkMeta:o});function Xs(o){return"then"in o&&o.then instanceof Function}class Gf{constructor(t,e,s,i,n){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=t,this.videoCodec=e,this.initSegmentData=s,this.duration=i,this.defaultInitPts=n||null}}class Kf{constructor(t,e,s,i,n,r){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=t,this.contiguous=e,this.accurateTimeOffset=s,this.trackSwitch=i,this.timeOffset=n,this.initSegmentChange=r}}let Ca=0;class Oc{constructor(t,e,s,i){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=Ca++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=c=>{const l=c.data,h=this.hls;if(!(!h||!(l!=null&&l.event)||l.instanceNo!==this.instanceNo))switch(l.event){case"init":{var A;const u=(A=this.workerContext)==null?void 0:A.objectURL;u&&self.URL.revokeObjectURL(u);break}case"transmuxComplete":{this.handleTransmuxComplete(l.data);break}case"flush":{this.onFlush(l.data);break}case"workerLog":{h.logger[l.data.logType]&&h.logger[l.data.logType](l.data.message);break}default:{l.data=l.data||{},l.data.frag=this.frag,l.data.part=this.part,l.data.id=this.id,h.trigger(l.event,l.data);break}}},this.onWorkerError=c=>{if(!this.hls)return;const l=new Error(`${c.message}  (${c.filename}:${c.lineno})`);this.hls.config.enableWorker=!1,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(y.ERROR,{type:V.OTHER_ERROR,details:w.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:l})};const n=t.config;this.hls=t,this.id=e,this.useWorker=!!n.enableWorker,this.onTransmuxComplete=s,this.onFlush=i;const r=(c,l)=>{l=l||{},l.frag=this.frag||void 0,c===y.ERROR&&(l=l,l.parent=this.id,l.part=this.part,this.error=l.error),this.hls.trigger(c,l)};this.observer=new Wr,this.observer.on(y.FRAG_DECRYPTED,r),this.observer.on(y.ERROR,r);const a=Qo(n.preferManagedMediaSource);if(this.useWorker&&typeof Worker<"u"){const c=this.hls.logger;if(n.workerPath||Vd()){try{n.workerPath?(c.log(`loading Web Worker ${n.workerPath} for "${e}"`),this.workerContext=qd(n.workerPath)):(c.log(`injecting Web Worker for "${e}"`),this.workerContext=Yd());const{worker:h}=this.workerContext;h.addEventListener("message",this.onWorkerMessage),h.addEventListener("error",this.onWorkerError),h.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:a,id:e,config:at(n)})}catch(h){c.warn(`Error setting up "${e}" Web Worker, fallback to inline`,h),this.terminateWorker(),this.error=null,this.transmuxer=new ya(this.observer,a,n,"",e,t.logger)}return}}this.transmuxer=new ya(this.observer,a,n,"",e,t.logger)}reset(){if(this.frag=null,this.part=null,this.workerContext){const t=this.instanceNo;this.instanceNo=Ca++;const e=this.hls.config,s=Qo(e.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:t,typeSupported:s,id:this.id,config:at(e)})}}terminateWorker(){if(this.workerContext){const{worker:t}=this.workerContext;this.workerContext=null,t.removeEventListener("message",this.onWorkerMessage),t.removeEventListener("error",this.onWorkerError),Wd(this.hls.config.workerPath)}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{const e=this.transmuxer;e&&(e.destroy(),this.transmuxer=null)}const t=this.observer;t&&t.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null}push(t,e,s,i,n,r,a,c,l,h){var A,u;l.transmuxing.start=self.performance.now();const{instanceNo:d,transmuxer:f}=this,g=r?r.start:n.start,m=n.decryptdata,E=this.frag,p=!(E&&n.cc===E.cc),I=!(E&&l.level===E.level),C=E?l.sn-E.sn:-1,S=this.part?l.part-this.part.index:-1,v=C===0&&l.id>1&&l.id===E?.stats.chunkCount,T=!I&&(C===1||C===0&&(S===1||v&&S<=0)),x=self.performance.now();(I||C||n.stats.parsing.start===0)&&(n.stats.parsing.start=x),r&&(S||!T)&&(r.stats.parsing.start=x);const L=!(E&&((A=n.initSegment)==null?void 0:A.url)===((u=E.initSegment)==null?void 0:u.url)),B=new Kf(p,T,c,I,g,L);if(!T||p||L){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${n.type} sn: ${l.sn}${l.part>-1?" part: "+l.part:""} ${this.id===H.MAIN?"level":"track"}: ${l.level} id: ${l.id}
        discontinuity: ${p}
        trackSwitch: ${I}
        contiguous: ${T}
        accurateTimeOffset: ${c}
        timeOffset: ${g}
        initSegmentChange: ${L}`);const D=new Gf(s,i,e,a,h);this.configureTransmuxer(D)}if(this.frag=n,this.part=r,this.workerContext)this.workerContext.worker.postMessage({instanceNo:d,cmd:"demux",data:t,decryptdata:m,chunkMeta:l,state:B},t instanceof ArrayBuffer?[t]:[]);else if(f){const D=f.push(t,m,l,B);Xs(D)?D.then(R=>{this.handleTransmuxComplete(R)}).catch(R=>{this.transmuxerError(R,l,"transmuxer-interface push error")}):this.handleTransmuxComplete(D)}}flush(t){t.transmuxing.start=self.performance.now();const{instanceNo:e,transmuxer:s}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:e,cmd:"flush",chunkMeta:t});else if(s){const i=s.flush(t);Xs(i)?i.then(n=>{this.handleFlushResult(n,t)}).catch(n=>{this.transmuxerError(n,t,"transmuxer-interface flush error")}):this.handleFlushResult(i,t)}}transmuxerError(t,e,s){this.hls&&(this.error=t,this.hls.trigger(y.ERROR,{type:V.MEDIA_ERROR,details:w.FRAG_PARSING_ERROR,chunkMeta:e,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:t,err:t,reason:s}))}handleFlushResult(t,e){t.forEach(s=>{this.handleTransmuxComplete(s)}),this.onFlush(e)}configureTransmuxer(t){const{instanceNo:e,transmuxer:s}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:e,cmd:"configure",config:t}):s&&s.configure(t)}handleTransmuxComplete(t){t.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(t)}}const Sa=100;class $f extends qr{constructor(t,e,s){super(t,e,s,"audio-stream-controller",H.AUDIO),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=!1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem()}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null}registerListeners(){super.registerListeners();const{hls:t}=this;t.on(y.LEVEL_LOADED,this.onLevelLoaded,this),t.on(y.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.on(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(y.BUFFER_RESET,this.onBufferReset,this),t.on(y.BUFFER_CREATED,this.onBufferCreated,this),t.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(y.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(y.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(y.FRAG_LOADING,this.onFragLoading,this),t.on(y.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){const{hls:t}=this;t&&(super.unregisterListeners(),t.off(y.LEVEL_LOADED,this.onLevelLoaded,this),t.off(y.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.off(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(y.BUFFER_RESET,this.onBufferReset,this),t.off(y.BUFFER_CREATED,this.onBufferCreated,this),t.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(y.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(y.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(y.FRAG_LOADING,this.onFragLoading,this),t.off(y.FRAG_BUFFERED,this.onFragBuffered,this))}onInitPtsFound(t,{frag:e,id:s,initPTS:i,timescale:n,trackId:r}){if(s===H.MAIN){const a=e.cc,c=this.fragCurrent;if(this.initPTS[a]={baseTime:i,timescale:n,trackId:r},this.log(`InitPTS for cc: ${a} found from main: ${i/n} (${i}/${n}) trackId: ${r}`),this.mainAnchor=e,this.state===P.WAITING_INIT_PTS){const l=this.waitingData;(!l&&!this.loadingParts||l&&l.frag.cc!==a)&&this.syncWithAnchor(e,l?.frag)}else!this.hls.hasEnoughToStart&&c&&c.cc!==a?(c.abortRequests(),this.syncWithAnchor(e,c)):this.state===P.IDLE&&this.tick()}}getLoadPosition(){return!this.startFragRequested&&this.nextLoadPosition>=0?this.nextLoadPosition:super.getLoadPosition()}syncWithAnchor(t,e){var s;const i=((s=this.mainFragLoading)==null?void 0:s.frag)||null;if(e&&i?.cc===e.cc)return;const n=(i||t).cc,r=this.getLevelDetails(),a=this.getLoadPosition(),c=tc(r,n,a);c&&(this.log(`Syncing with main frag at ${c.start} cc ${c.cc}`),this.startFragRequested=!1,this.nextLoadPosition=c.start,this.resetLoadingState(),this.state===P.IDLE&&this.doTickIdle())}startLoad(t,e){if(!this.levels){this.startPosition=t,this.state=P.STOPPED;return}const s=this.lastCurrentTime;this.stopLoad(),this.setInterval(Sa),s>0&&t===-1?(this.log(`Override startPosition with lastCurrentTime @${s.toFixed(3)}`),t=s,this.state=P.IDLE):this.state=P.WAITING_TRACK,this.nextLoadPosition=this.lastCurrentTime=t+this.timelineOffset,this.startPosition=e?-1:t,this.tick()}doTick(){switch(this.state){case P.IDLE:this.doTickIdle();break;case P.WAITING_TRACK:{const{levels:t,trackId:e}=this,s=t?.[e],i=s?.details;if(i&&!this.waitForLive(s)){if(this.waitForCdnTuneIn(i))break;this.state=P.WAITING_INIT_PTS}break}case P.FRAG_LOADING_WAITING_RETRY:{this.checkRetryDate();break}case P.WAITING_INIT_PTS:{const t=this.waitingData;if(t){const{frag:e,part:s,cache:i,complete:n}=t,r=this.mainAnchor;if(this.initPTS[e.cc]!==void 0){this.waitingData=null,this.state=P.FRAG_LOADING;const a=i.flush().buffer,c={frag:e,part:s,payload:a,networkDetails:null};this._handleFragmentLoadProgress(c),n&&super._handleFragmentLoadComplete(c)}else r&&r.cc!==t.frag.cc&&this.syncWithAnchor(r,t.frag)}else this.state=P.IDLE}}this.onTickEnd()}resetLoadingState(){const t=this.waitingData;t&&(this.fragmentTracker.removeFragment(t.frag),this.waitingData=null),super.resetLoadingState()}onTickEnd(){const{media:t}=this;t!=null&&t.readyState&&(this.lastCurrentTime=t.currentTime)}doTickIdle(){var t;const{hls:e,levels:s,media:i,trackId:n}=this,r=e.config;if(!this.buffering||!i&&!this.primaryPrefetch&&(this.startFragRequested||!r.startFragPrefetch)||!(s!=null&&s[n]))return;const a=s[n],c=a.details;if(!c||this.waitForLive(a)||this.waitForCdnTuneIn(c)){this.state=P.WAITING_TRACK,this.startFragRequested=!1;return}const l=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&l&&(this.bufferFlushed=!1,this.afterBufferFlushed(l,ot.AUDIO,H.AUDIO));const h=this.getFwdBufferInfo(l,H.AUDIO);if(h===null)return;if(!this.switchingTrack&&this._streamEnded(h,c)){e.trigger(y.BUFFER_EOS,{type:"audio"}),this.state=P.ENDED;return}const A=h.len,u=e.maxBufferLength,d=c.fragments,f=d[0].start,g=this.getLoadPosition(),m=this.flushing?g:h.end;if(this.switchingTrack&&i){const I=g;c.PTSKnown&&I<f&&(h.end>f||h.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),i.currentTime=f+.05)}if(A>=u&&!this.switchingTrack&&m<d[d.length-1].start)return;let E=this.getNextFragment(m,c);if(E&&this.isLoopLoading(E,m)&&(E=this.getNextFragmentLoopLoading(E,c,h,H.MAIN,u)),!E){this.bufferFlushed=!0;return}let p=((t=this.mainFragLoading)==null?void 0:t.frag)||null;if(!this.audioOnly&&this.startFragRequested&&p&&dt(E)&&!E.endList&&(!c.live||!this.loadingParts&&m<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(p)===Et.OK&&(this.mainFragLoading=p=null),p&&dt(p))){if(E.start>p.end){const C=this.fragmentTracker.getFragAtPos(m,H.MAIN);C&&C.end>p.end&&(p=C,this.mainFragLoading={frag:C,targetBufferTime:null})}if(E.start>p.end)return}this.loadFragment(E,a,m)}onMediaDetaching(t,e){this.bufferFlushed=this.flushing=!1,super.onMediaDetaching(t,e)}onAudioTracksUpdated(t,{audioTracks:e}){this.resetTransmuxer(),this.levels=e.map(s=>new Ws(s))}onAudioTrackSwitching(t,e){const s=!!e.url;this.trackId=e.id;const{fragCurrent:i}=this;i&&(i.abortRequests(),this.removeUnbufferedFrags(i.start)),this.resetLoadingState(),s?(this.switchingTrack=e,this.flushAudioIfNeeded(e),this.state!==P.STOPPED&&(this.setInterval(Sa),this.state=P.IDLE,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=e,this.clearInterval())}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1}onLevelLoaded(t,e){this.mainDetails=e.details;const s=this.cachedTrackLoadedData;s&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(y.AUDIO_TRACK_LOADED,s))}onAudioTrackLoaded(t,e){var s;const{levels:i}=this,{details:n,id:r,groupId:a,track:c}=e;if(!i){this.warn(`Audio tracks reset while loading track ${r} "${c.name}" of "${a}"`);return}const l=this.mainDetails;if(!l||n.endCC>l.endCC||l.expired){this.cachedTrackLoadedData=e,this.state!==P.STOPPED&&(this.state=P.WAITING_TRACK);return}this.cachedTrackLoadedData=null,this.log(`Audio track ${r} "${c.name}" of "${a}" loaded [${n.startSN},${n.endSN}]${n.lastPartSn?`[part-${n.lastPartSn}-${n.lastPartIndex}]`:""},duration:${n.totalduration}`);const h=i[r];let A=0;if(n.live||(s=h.details)!=null&&s.live){if(this.checkLiveUpdate(n),n.deltaUpdateFailed)return;if(h.details){var u;A=this.alignPlaylists(n,h.details,(u=this.levelLastLoaded)==null?void 0:u.details)}n.alignedSliding||(Ec(n,l),n.alignedSliding||Zi(n,l),A=n.fragmentStart)}h.details=n,this.levelLastLoaded=h,this.startFragRequested||this.setStartPosition(l,A),this.hls.trigger(y.AUDIO_TRACK_UPDATED,{details:n,id:r,groupId:e.groupId}),this.state===P.WAITING_TRACK&&!this.waitForCdnTuneIn(n)&&(this.state=P.IDLE),this.tick()}_handleFragmentLoadProgress(t){var e;const s=t.frag,{part:i,payload:n}=t,{config:r,trackId:a,levels:c}=this;if(!c){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${s.sn} of level ${s.level} will not be buffered`);return}const l=c[a];if(!l){this.warn("Audio track is undefined on fragment load progress");return}const h=l.details;if(!h){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(s.start);return}const A=r.defaultAudioCodec||l.audioCodec||"mp4a.40.2";let u=this.transmuxer;u||(u=this.transmuxer=new Oc(this.hls,H.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const d=this.initPTS[s.cc],f=(e=s.initSegment)==null?void 0:e.data;if(d!==void 0){const m=i?i.index:-1,E=m!==-1,p=new Hr(s.level,s.sn,s.stats.chunkCount,n.byteLength,m,E);u.push(n,f,A,"",s,i,h.totalduration,!1,p,d)}else{this.log(`Unknown video PTS for cc ${s.cc}, waiting for video PTS before demuxing audio frag ${s.sn} of [${h.startSN} ,${h.endSN}],track ${a}`);const{cache:g}=this.waitingData=this.waitingData||{frag:s,part:i,cache:new Ic,complete:!1};g.push(new Uint8Array(n)),this.state!==P.STOPPED&&(this.state=P.WAITING_INIT_PTS)}}_handleFragmentLoadComplete(t){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(t)}onBufferReset(){this.mediaBuffer=null}onBufferCreated(t,e){this.bufferFlushed=this.flushing=!1;const s=e.tracks.audio;s&&(this.mediaBuffer=s.buffer||null)}onFragLoading(t,e){!this.audioOnly&&e.frag.type===H.MAIN&&dt(e.frag)&&(this.mainFragLoading=e,this.state===P.IDLE&&this.tick())}onFragBuffered(t,e){const{frag:s,part:i}=e;if(s.type!==H.AUDIO){!this.audioOnly&&s.type===H.MAIN&&!s.elementaryStreams.video&&!s.elementaryStreams.audiovideo&&(this.audioOnly=!0,this.mainFragLoading=null);return}if(this.fragContextChanged(s)){this.warn(`Fragment ${s.sn}${i?" p: "+i.index:""} of level ${s.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(dt(s)){this.fragPrevious=s;const n=this.switchingTrack;n&&(this.bufferedTrack=n,this.switchingTrack=null,this.hls.trigger(y.AUDIO_TRACK_SWITCHED,it({},n)))}this.fragBufferedComplete(s,i),this.media&&this.tick()}onError(t,e){var s;if(e.fatal){this.state=P.ERROR;return}switch(e.details){case w.FRAG_GAP:case w.FRAG_PARSING_ERROR:case w.FRAG_DECRYPT_ERROR:case w.FRAG_LOAD_ERROR:case w.FRAG_LOAD_TIMEOUT:case w.KEY_LOAD_ERROR:case w.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(H.AUDIO,e);break;case w.AUDIO_TRACK_LOAD_ERROR:case w.AUDIO_TRACK_LOAD_TIMEOUT:case w.LEVEL_PARSING_ERROR:!e.levelRetry&&this.state===P.WAITING_TRACK&&((s=e.context)==null?void 0:s.type)===z.AUDIO_TRACK&&(this.state=P.IDLE);break;case w.BUFFER_ADD_CODEC_ERROR:case w.BUFFER_APPEND_ERROR:if(e.parent!=="audio")return;this.reduceLengthAndFlushBuffer(e)||this.resetLoadingState();break;case w.BUFFER_FULL_ERROR:if(e.parent!=="audio")return;this.reduceLengthAndFlushBuffer(e)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case w.INTERNAL_EXCEPTION:this.recoverWorkerError(e);break}}onBufferFlushing(t,{type:e}){e!==ot.VIDEO&&(this.flushing=!0)}onBufferFlushed(t,{type:e}){if(e!==ot.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===P.ENDED&&(this.state=P.IDLE);const s=this.mediaBuffer||this.media;s&&(this.afterBufferFlushed(s,e,H.AUDIO),this.tick())}}_handleTransmuxComplete(t){var e;const s="audio",{hls:i}=this,{remuxResult:n,chunkMeta:r}=t,a=this.getCurrentContext(r);if(!a){this.resetWhenMissingContext(r);return}const{frag:c,part:l,level:h}=a,{details:A}=h,{audio:u,text:d,id3:f,initSegment:g}=n;if(this.fragContextChanged(c)||!A){this.fragmentTracker.removeFragment(c);return}if(this.state=P.PARSING,this.switchingTrack&&u&&this.completeAudioSwitch(this.switchingTrack),g!=null&&g.tracks){const m=c.initSegment||c;if(this.unhandledEncryptionError(g,c))return;this._bufferInitSegment(h,g.tracks,m,r),i.trigger(y.FRAG_PARSING_INIT_SEGMENT,{frag:m,id:s,tracks:g.tracks})}if(u){const{startPTS:m,endPTS:E,startDTS:p,endDTS:I}=u;l&&(l.elementaryStreams[ot.AUDIO]={startPTS:m,endPTS:E,startDTS:p,endDTS:I}),c.setElementaryStreamInfo(ot.AUDIO,m,E,p,I),this.bufferFragmentData(u,c,l,r)}if(f!=null&&(e=f.samples)!=null&&e.length){const m=rt({id:s,frag:c,details:A},f);i.trigger(y.FRAG_PARSING_METADATA,m)}if(d){const m=rt({id:s,frag:c,details:A},d);i.trigger(y.FRAG_PARSING_USERDATA,m)}}_bufferInitSegment(t,e,s,i){if(this.state!==P.PARSING||(e.video&&delete e.video,e.audiovideo&&delete e.audiovideo,!e.audio))return;const n=e.audio;n.id=H.AUDIO;const r=t.audioCodec;this.log(`Init audio buffer, container:${n.container}, codecs[level/parsed]=[${r}/${n.codec}]`),r&&r.split(",").length===1&&(n.levelCodec=r),this.hls.trigger(y.BUFFER_CODECS,e);const a=n.initSegment;if(a!=null&&a.byteLength){const c={type:"audio",frag:s,part:null,chunkMeta:i,parent:s.type,data:a};this.hls.trigger(y.BUFFER_APPENDING,c)}this.tickImmediate()}loadFragment(t,e,s){const i=this.fragmentTracker.getState(t);if(this.switchingTrack||i===Et.NOT_LOADED||i===Et.PARTIAL){var n;if(!dt(t))this._loadInitSegment(t,e);else if((n=e.details)!=null&&n.live&&!this.initPTS[t.cc]){this.log(`Waiting for video PTS in continuity counter ${t.cc} of live stream before loading audio fragment ${t.sn} of level ${this.trackId}`),this.state=P.WAITING_INIT_PTS;const r=this.mainDetails;r&&r.fragmentStart!==e.details.fragmentStart&&Zi(e.details,r)}else super.loadFragment(t,e,s)}else this.clearTrackerIfNeeded(t)}flushAudioIfNeeded(t){if(this.media&&this.bufferedTrack){const{name:e,lang:s,assocLang:i,characteristics:n,audioCodec:r,channels:a}=this.bufferedTrack;Ye({name:e,lang:s,assocLang:i,characteristics:n,audioCodec:r,channels:a},t,He)||(Wi(t.url,this.hls)?(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=t)}}completeAudioSwitch(t){const{hls:e}=this;this.flushAudioIfNeeded(t),this.bufferedTrack=t,this.switchingTrack=null,e.trigger(y.AUDIO_TRACK_SWITCHED,it({},t))}}class eo extends zt{constructor(t,e){super(e,t.logger),this.hls=void 0,this.canLoad=!1,this.timer=-1,this.hls=t}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(t,e,s){const i=e?.renditionReports;if(i){let n=-1;for(let r=0;r<i.length;r++){const a=i[r];let c;try{c=new self.URL(a.URI,e.url).href}catch(l){this.warn(`Could not construct new URL for Rendition Report: ${l}`),c=a.URI||""}if(c===t){n=r;break}else c===t.substring(0,c.length)&&(n=r)}if(n!==-1){const r=i[n],a=parseInt(r["LAST-MSN"])||e.lastPartSn;let c=parseInt(r["LAST-PART"])||e.lastPartIndex;if(this.hls.config.lowLatencyMode){const h=Math.min(e.age-e.partTarget,e.targetduration);c>=0&&h>e.partTarget&&(c+=1)}const l=s&&Mo(s);return new Oo(a,c>=0?c:void 0,l)}}}loadPlaylist(t){this.clearTimer()}loadingPlaylist(t,e){this.clearTimer()}shouldLoadPlaylist(t){return this.canLoad&&!!t&&!!t.url&&(!t.details||t.details.live)}getUrlWithDirectives(t,e){if(e)try{return e.addDirectives(t)}catch(s){this.warn(`Could not construct new URL with HLS Delivery Directives: ${s}`)}return t}playlistLoaded(t,e,s){const{details:i,stats:n}=e,r=self.performance.now(),a=n.loading.first?Math.max(0,r-n.loading.first):0;i.advancedDateTime=Date.now()-a;const c=this.hls.config.timelineOffset;if(c!==i.appliedTimelineOffset){const h=Math.max(c||0,0);i.appliedTimelineOffset=h,i.fragments.forEach(A=>{A.setStart(A.playlistOffset+h)})}if(i.live||s!=null&&s.live){const h="levelInfo"in e?e.levelInfo:e.track;if(i.reloaded(s),s&&i.fragments.length>0){Pd(s,i,this);const p=i.playlistParsingError;if(p){this.warn(p);const I=this.hls;if(!I.config.ignorePlaylistParsingErrors){var l;const{networkDetails:C}=e;I.trigger(y.ERROR,{type:V.NETWORK_ERROR,details:w.LEVEL_PARSING_ERROR,fatal:!1,url:i.url,error:p,reason:p.message,level:e.level||void 0,parent:(l=i.fragments[0])==null?void 0:l.type,networkDetails:C,stats:n});return}i.playlistParsingError=null}}i.requestScheduled===-1&&(i.requestScheduled=n.loading.start);const A=this.hls.mainForwardBufferInfo,u=A?A.end-A.len:0,d=(i.edge-u)*1e3,f=dc(i,d);if(i.requestScheduled+f<r?i.requestScheduled=r:i.requestScheduled+=f,this.log(`live playlist ${t} ${i.advanced?"REFRESHED "+i.lastPartSn+"-"+i.lastPartIndex:i.updated?"UPDATED":"MISSED"}`),!this.canLoad||!i.live)return;let g,m,E;if(i.canBlockReload&&i.endSN&&i.advanced){const p=this.hls.config.lowLatencyMode,I=i.lastPartSn,C=i.endSN,S=i.lastPartIndex,v=S!==-1,T=I===C;v?T?(m=C+1,E=p?0:S):(m=I,E=p?S+1:i.maxPartIndex):m=C+1;const x=i.age,L=x+i.ageHeader;let B=Math.min(L-i.partTarget,i.targetduration*1.5);if(B>0){if(L>i.targetduration*3)this.log(`Playlist last advanced ${x.toFixed(2)}s ago. Omitting segment and part directives.`),m=void 0,E=void 0;else if(s!=null&&s.tuneInGoal&&L-i.partTarget>s.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${s.tuneInGoal} to: ${B} with playlist age: ${i.age}`),B=0;else{const D=Math.floor(B/i.targetduration);if(m+=D,E!==void 0){const R=Math.round(B%i.targetduration/i.partTarget);E+=R}this.log(`CDN Tune-in age: ${i.ageHeader}s last advanced ${x.toFixed(2)}s goal: ${B} skip sn ${D} to part ${E}`)}i.tuneInGoal=B}if(g=this.getDeliveryDirectives(i,e.deliveryDirectives,m,E),p||!T){i.requestScheduled=r,this.loadingPlaylist(h,g);return}}else(i.canBlockReload||i.canSkipUntil)&&(g=this.getDeliveryDirectives(i,e.deliveryDirectives,m,E));g&&m!==void 0&&i.canBlockReload&&(i.requestScheduled=n.loading.first+Math.max(f-a*2,f/2)),this.scheduleLoading(h,g,i)}else this.clearTimer()}scheduleLoading(t,e,s){const i=s||t.details;if(!i){this.loadingPlaylist(t,e);return}const n=self.performance.now(),r=i.requestScheduled;if(n>=r){this.loadingPlaylist(t,e);return}const a=r-n;this.log(`reload live playlist ${t.name||t.bitrate+"bps"} in ${Math.round(a)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(t,e),a)}getDeliveryDirectives(t,e,s,i){let n=Mo(t);return e!=null&&e.skip&&t.deltaUpdateFailed&&(s=e.msn,i=e.part,n=Pi.No),new Oo(s,i,n)}checkRetry(t){const e=t.details,s=Ji(t),i=t.errorAction,{action:n,retryCount:r=0,retryConfig:a}=i||{},c=!!i&&!!a&&(n===vt.RetryRequest||!i.resolved&&n===vt.SendAlternateToPenaltyBox);if(c){var l;if(r>=a.maxNumRetry)return!1;if(s&&(l=t.context)!=null&&l.deliveryDirectives)this.warn(`Retrying playlist loading ${r+1}/${a.maxNumRetry} after "${e}" without delivery-directives`),this.loadPlaylist();else{const h=Kr(a,r);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),h),this.warn(`Retrying playlist loading ${r+1}/${a.maxNumRetry} after "${e}" in ${h}ms`)}t.levelRetry=!0,i.resolved=!0}return c}}function Uc(o,t){if(o.length!==t.length)return!1;for(let e=0;e<o.length;e++)if(!zs(o[e].attrs,t[e].attrs))return!1;return!0}function zs(o,t,e){const s=o["STABLE-RENDITION-ID"];return s&&!e?s===t["STABLE-RENDITION-ID"]:!(e||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(i=>o[i]!==t[i])}function mr(o,t){return t.label.toLowerCase()===o.name.toLowerCase()&&(!t.language||t.language.toLowerCase()===(o.lang||"").toLowerCase())}class Hf extends eo{constructor(t){super(t,"audio-track-controller"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:t}=this;t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.MANIFEST_PARSED,this.onManifestParsed,this),t.on(y.LEVEL_LOADING,this.onLevelLoading,this),t.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:t}=this;t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.MANIFEST_PARSED,this.onManifestParsed,this),t.off(y.LEVEL_LOADING,this.onLevelLoading,this),t.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(y.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(t,e){this.tracks=e.audioTracks||[]}onAudioTrackLoaded(t,e){const{id:s,groupId:i,details:n}=e,r=this.tracksInGroup[s];if(!r||r.groupId!==i){this.warn(`Audio track with id:${s} and group:${i} not found in active group ${r?.groupId}`);return}const a=r.details;r.details=e.details,this.log(`Audio track ${s} "${r.name}" lang:${r.lang} group:${i} loaded [${n.startSN}-${n.endSN}]`),s===this.trackId&&this.playlistLoaded(s,e,a)}onLevelLoading(t,e){this.switchLevel(e.level)}onLevelSwitching(t,e){this.switchLevel(e.level)}switchLevel(t){const e=this.hls.levels[t];if(!e)return;const s=e.audioGroups||null,i=this.groupIds;let n=this.currentTrack;if(!s||i?.length!==s?.length||s!=null&&s.some(a=>i?.indexOf(a)===-1)){this.groupIds=s,this.trackId=-1,this.currentTrack=null;const a=this.tracks.filter(u=>!s||s.indexOf(u.groupId)!==-1);if(a.length)this.selectDefaultTrack&&!a.some(u=>u.default)&&(this.selectDefaultTrack=!1),a.forEach((u,d)=>{u.id=d});else if(!n&&!this.tracksInGroup.length)return;this.tracksInGroup=a;const c=this.hls.config.audioPreference;if(!n&&c){const u=Ae(c,a,He);if(u>-1)n=a[u];else{const d=Ae(c,this.tracks);n=this.tracks[d]}}let l=this.findTrackId(n);l===-1&&n&&(l=this.findTrackId(null));const h={audioTracks:a};this.log(`Updating audio tracks, ${a.length} track(s) found in group(s): ${s?.join(",")}`),this.hls.trigger(y.AUDIO_TRACKS_UPDATED,h);const A=this.trackId;if(l!==-1&&A===-1)this.setAudioTrack(l);else if(a.length&&A===-1){var r;const u=new Error(`No audio track selected for current audio group-ID(s): ${(r=this.groupIds)==null?void 0:r.join(",")} track count: ${a.length}`);this.warn(u.message),this.hls.trigger(y.ERROR,{type:V.MEDIA_ERROR,details:w.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:u})}}}onError(t,e){e.fatal||!e.context||e.context.type===z.AUDIO_TRACK&&e.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(e.context.groupId)!==-1)&&this.checkRetry(e)}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(t){this.selectDefaultTrack=!1,this.setAudioTrack(t)}setAudioOption(t){const e=this.hls;if(e.config.audioPreference=t,t){const s=this.allAudioTracks;if(this.selectDefaultTrack=!1,s.length){const i=this.currentTrack;if(i&&Ye(t,i,He))return i;const n=Ae(t,this.tracksInGroup,He);if(n>-1){const r=this.tracksInGroup[n];return this.setAudioTrack(n),r}else if(i){let r=e.loadLevel;r===-1&&(r=e.firstAutoLevel);const a=ed(t,e.levels,s,r,He);if(a===-1)return null;e.nextLoadLevel=a}if(t.channels||t.audioCodec){const r=Ae(t,s);if(r>-1)return s[r]}}}return null}setAudioTrack(t){const e=this.tracksInGroup;if(t<0||t>=e.length){this.warn(`Invalid audio track id: ${t}`);return}this.selectDefaultTrack=!1;const s=this.currentTrack,i=e[t],n=i.details&&!i.details.live;if(t===this.trackId&&i===s&&n||(this.log(`Switching to audio-track ${t} "${i.name}" lang:${i.lang} group:${i.groupId} channels:${i.channels}`),this.trackId=t,this.currentTrack=i,this.hls.trigger(y.AUDIO_TRACK_SWITCHING,it({},i)),n))return;const r=this.switchParams(i.url,s?.details,i.details);this.loadPlaylist(r)}findTrackId(t){const e=this.tracksInGroup;for(let s=0;s<e.length;s++){const i=e[s];if(!(this.selectDefaultTrack&&!i.default)&&(!t||Ye(t,i,He)))return s}if(t){const{name:s,lang:i,assocLang:n,characteristics:r,audioCodec:a,channels:c}=t;for(let l=0;l<e.length;l++){const h=e[l];if(Ye({name:s,lang:i,assocLang:n,characteristics:r,audioCodec:a,channels:c},h,He))return l}for(let l=0;l<e.length;l++){const h=e[l];if(zs(t.attrs,h.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return l}for(let l=0;l<e.length;l++){const h=e[l];if(zs(t.attrs,h.attrs,["LANGUAGE"]))return l}}return-1}loadPlaylist(t){super.loadPlaylist();const e=this.currentTrack;this.shouldLoadPlaylist(e)&&Wi(e.url,this.hls)&&this.scheduleLoading(e,t)}loadingPlaylist(t,e){super.loadingPlaylist(t,e);const s=t.id,i=t.groupId,n=this.getUrlWithDirectives(t.url,e),r=t.details,a=r?.age;this.log(`Loading audio-track ${s} "${t.name}" lang:${t.lang} group:${i}${e?.msn!==void 0?" at sn "+e.msn+" part "+e.part:""}${a&&r.live?" age "+a.toFixed(1)+(r.type&&" "+r.type||""):""} ${n}`),this.hls.trigger(y.AUDIO_TRACK_LOADING,{url:n,id:s,groupId:i,deliveryDirectives:e||null,track:t})}}class Vf{constructor(t){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=t}destroy(){this.tracks=this.queues=null}append(t,e,s){if(this.queues===null||this.tracks===null)return;const i=this.queues[e];i.push(t),i.length===1&&!s&&this.executeNext(e)}appendBlocker(t){return new Promise(e=>{const s={label:"async-blocker",execute:e,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.append(s,t)})}prependBlocker(t){return new Promise(e=>{if(this.queues){const s={label:"async-blocker-prepend",execute:e,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.queues[t].unshift(s)}})}removeBlockers(){this.queues!==null&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(t=>{var e;const s=(e=t[0])==null?void 0:e.label;(s==="async-blocker"||s==="async-blocker-prepend")&&(t[0].execute(),t.splice(0,1))})}unblockAudio(t){if(this.queues===null)return;this.queues.audio[0]===t&&this.shiftAndExecuteNext("audio")}executeNext(t){if(this.queues===null||this.tracks===null)return;const e=this.queues[t];if(e.length){const i=e[0];try{i.execute()}catch(n){var s;if(i.onError(n),this.queues===null||this.tracks===null)return;const r=(s=this.tracks[t])==null?void 0:s.buffer;r!=null&&r.updating||this.shiftAndExecuteNext(t)}}}shiftAndExecuteNext(t){this.queues!==null&&(this.queues[t].shift(),this.executeNext(t))}current(t){var e;return((e=this.queues)==null?void 0:e[t][0])||null}toString(){const{queues:t,tracks:e}=this;return t===null||e===null?"<destroyed>":`
${this.list("video")}
${this.list("audio")}
${this.list("audiovideo")}}`}list(t){var e,s;return(e=this.queues)!=null&&e[t]||(s=this.tracks)!=null&&s[t]?`${t}: (${this.listSbInfo(t)}) ${this.listOps(t)}`:""}listSbInfo(t){var e;const s=(e=this.tracks)==null?void 0:e[t],i=s?.buffer;return i?`SourceBuffer${i.updating?" updating":""}${s.ended?" ended":""}${s.ending?" ending":""}`:"none"}listOps(t){var e;return((e=this.queues)==null?void 0:e[t].map(s=>s.label).join(", "))||""}}const Ta=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,Nc="HlsJsTrackRemovedError";class Yf extends Error{constructor(t){super(t),this.name=Nc}}class qf extends zt{constructor(t,e){super("buffer-controller",t.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=s=>{var i;this.hls&&((i=this.mediaSource)==null?void 0:i.readyState)==="open"&&this.hls.pauseBuffering()},this._onStartStreaming=s=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=s=>{const{media:i,mediaSource:n}=this;s&&this.log("Media source opened"),!(!i||!n)&&(n.removeEventListener("sourceopen",this._onMediaSourceOpen),i.removeEventListener("emptied",this._onMediaEmptied),this.updateDuration(),this.hls.trigger(y.MEDIA_ATTACHED,{media:i,mediaSource:n}),this.mediaSource!==null&&this.checkPendingTracks())},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:s,_objectUrl:i}=this;s!==i&&this.error(`Media element src was set while attaching MediaSource (${i} > ${s})`)},this.hls=t,this.fragmentTracker=e,this.appendSource=fu(Pe(t.config.preferManagedMediaSource)),this.initTracks(),this.registerListeners()}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null}registerListeners(){const{hls:t}=this;t.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.MANIFEST_PARSED,this.onManifestParsed,this),t.on(y.BUFFER_RESET,this.onBufferReset,this),t.on(y.BUFFER_APPENDING,this.onBufferAppending,this),t.on(y.BUFFER_CODECS,this.onBufferCodecs,this),t.on(y.BUFFER_EOS,this.onBufferEos,this),t.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(y.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(y.FRAG_PARSED,this.onFragParsed,this),t.on(y.FRAG_CHANGED,this.onFragChanged,this),t.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:t}=this;t.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.MANIFEST_PARSED,this.onManifestParsed,this),t.off(y.BUFFER_RESET,this.onBufferReset,this),t.off(y.BUFFER_APPENDING,this.onBufferAppending,this),t.off(y.BUFFER_CODECS,this.onBufferCodecs,this),t.off(y.BUFFER_EOS,this.onBufferEos,this),t.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(y.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(y.FRAG_PARSED,this.onFragParsed,this),t.off(y.FRAG_CHANGED,this.onFragChanged,this),t.off(y.ERROR,this.onError,this)}transferMedia(){const{media:t,mediaSource:e}=this;if(!t)return null;const s={};if(this.operationQueue){const n=this.isUpdating();n||this.operationQueue.removeBlockers();const r=this.isQueued();(n||r)&&this.warn(`Transfering MediaSource with${r?" operations in queue":""}${n?" updating SourceBuffer(s)":""} ${this.operationQueue}`),this.operationQueue.destroy()}const i=this.transferData;return!this.sourceBufferCount&&i&&i.mediaSource===e?rt(s,i.tracks):this.sourceBuffers.forEach(n=>{const[r]=n;r&&(s[r]=rt({},this.tracks[r]),this.removeBuffer(r)),n[0]=n[1]=null}),{media:t,mediaSource:e,tracks:s}}initTracks(){const t={};this.sourceBuffers=[[null,null],[null,null]],this.tracks=t,this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null}onManifestParsed(t,e){var s;let i=2;(e.audio&&!e.video||!e.altAudio)&&(i=1),this.bufferCodecEventsTotal=i,this.log(`${i} bufferCodec event(s) expected.`),(s=this.transferData)!=null&&s.mediaSource&&this.sourceBufferCount&&i&&this.bufferCreated()}onMediaAttaching(t,e){const s=this.media=e.media;this.transferData=this.overrides=void 0;const i=Pe(this.appendSource);if(i){const n=!!e.mediaSource;(n||e.overrides)&&(this.transferData=e,this.overrides=e.overrides);const r=this.mediaSource=e.mediaSource||new i;if(this.assignMediaSource(r),n)this._objectUrl=s.src,this.attachTransferred();else{const a=this._objectUrl=self.URL.createObjectURL(r);if(this.appendSource)try{s.removeAttribute("src");const c=self.ManagedMediaSource;s.disableRemotePlayback=s.disableRemotePlayback||c&&r instanceof c,Ba(s),Wf(s,a),s.load()}catch{s.src=a}else s.src=a}s.addEventListener("emptied",this._onMediaEmptied)}}assignMediaSource(t){var e,s;this.log(`${((e=this.transferData)==null?void 0:e.mediaSource)===t?"transferred":"created"} media source: ${(s=t.constructor)==null?void 0:s.name}`),t.addEventListener("sourceopen",this._onMediaSourceOpen),t.addEventListener("sourceended",this._onMediaSourceEnded),t.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(t.addEventListener("startstreaming",this._onStartStreaming),t.addEventListener("endstreaming",this._onEndStreaming))}attachTransferred(){const t=this.media,e=this.transferData;if(!e||!t)return;const s=this.tracks,i=e.tracks,n=i?Object.keys(i):null,r=n?n.length:0,a=()=>{Promise.resolve().then(()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen()})};if(i&&n&&r){if(!this.tracksReady){this.hls.config.startFragPrefetch=!0,this.log("attachTransferred: waiting for SourceBuffer track info");return}if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})
required tracks: ${at(s,(c,l)=>c==="initSegment"?void 0:l)};
transfer tracks: ${at(i,(c,l)=>c==="initSegment"?void 0:l)}}`),!Ql(i,s)){e.mediaSource=null,e.tracks=void 0;const c=t.currentTime,l=this.details,h=Math.max(c,l?.fragments[0].start||0);if(h-c>1){this.log(`attachTransferred: waiting for playback to reach new tracks start time ${c} -> ${h}`);return}this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(i)}"->"${Object.keys(s)}") start time: ${h} currentTime: ${c}`),this.onMediaDetaching(y.MEDIA_DETACHING,{}),this.onMediaAttaching(y.MEDIA_ATTACHING,e),t.currentTime=h;return}this.transferData=void 0,n.forEach(c=>{const l=c,h=i[l];if(h){const A=h.buffer;if(A){const u=this.fragmentTracker,d=h.id;if(u.hasFragments(d)||u.hasParts(d)){const m=j.getBuffered(A);u.detectEvictedFragments(l,m,d,null,!0)}const f=Bn(l),g=[l,A];this.sourceBuffers[f]=g,A.updating&&this.operationQueue&&this.operationQueue.prependBlocker(l),this.trackSourceBuffer(l,h)}}}),a(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),a()}get mediaSourceOpenOrEnded(){var t;const e=(t=this.mediaSource)==null?void 0:t.readyState;return e==="open"||e==="ended"}onMediaDetaching(t,e){const s=!!e.transferMedia;this.transferData=this.overrides=void 0;const{media:i,mediaSource:n,_objectUrl:r}=this;if(n){if(this.log(`media source ${s?"transferring":"detaching"}`),s)this.sourceBuffers.forEach(([a])=>{a&&this.removeBuffer(a)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){const a=n.readyState==="open";try{const c=n.sourceBuffers;for(let l=c.length;l--;)a&&c[l].abort(),n.removeSourceBuffer(c[l]);a&&n.endOfStream()}catch(c){this.warn(`onMediaDetaching: ${c.message} while calling endOfStream`)}}this.sourceBufferCount&&this.onBufferReset()}n.removeEventListener("sourceopen",this._onMediaSourceOpen),n.removeEventListener("sourceended",this._onMediaSourceEnded),n.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(n.removeEventListener("startstreaming",this._onStartStreaming),n.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}i&&(i.removeEventListener("emptied",this._onMediaEmptied),s||(r&&self.URL.revokeObjectURL(r),this.mediaSrc===r?(i.removeAttribute("src"),this.appendSource&&Ba(i),i.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(y.MEDIA_DETACHED,e)}onBufferReset(){this.sourceBuffers.forEach(([t])=>{t&&this.resetBuffer(t)}),this.initTracks()}resetBuffer(t){var e;const s=(e=this.tracks[t])==null?void 0:e.buffer;if(this.removeBuffer(t),s)try{var i;(i=this.mediaSource)!=null&&i.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(s)}catch(n){this.warn(`onBufferReset ${t}`,n)}delete this.tracks[t]}removeBuffer(t){this.removeBufferListeners(t),this.sourceBuffers[Bn(t)]=[null,null];const e=this.tracks[t];e&&(e.buffer=void 0)}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new Vf(this.tracks)}onBufferCodecs(t,e){var s;const i=this.tracks,n=Object.keys(e);this.log(`BUFFER_CODECS: "${n}" (current SB count ${this.sourceBufferCount})`);const r="audiovideo"in e&&(i.audio||i.video)||i.audiovideo&&("audio"in e||"video"in e),a=!r&&this.sourceBufferCount&&this.media&&n.some(c=>!i[c]);if(r||a){this.warn(`Unsupported transition between "${Object.keys(i)}" and "${n}" SourceBuffers`);return}n.forEach(c=>{var l,h;const A=e[c],{id:u,codec:d,levelCodec:f,container:g,metadata:m,supplemental:E}=A;let p=i[c];const I=(l=this.transferData)==null||(l=l.tracks)==null?void 0:l[c],C=I!=null&&I.buffer?I:p,S=C?.pendingCodec||C?.codec,v=C?.levelCodec;p||(p=i[c]={buffer:void 0,listeners:[],codec:d,supplemental:E,container:g,levelCodec:f,metadata:m,id:u});const T=_i(S,v),x=T?.replace(Ta,"$1");let L=_i(d,f);const B=(h=L)==null?void 0:h.replace(Ta,"$1");L&&T&&x!==B&&(c.slice(0,5)==="audio"&&(L=Yi(L,this.appendSource)),this.log(`switching codec ${S} to ${L}`),L!==(p.pendingCodec||p.codec)&&(p.pendingCodec=L),p.container=g,this.appendChangeType(c,g,L))}),(this.tracksReady||this.sourceBufferCount)&&(e.tracks=this.sourceBufferTracks),!this.sourceBufferCount&&(this.bufferCodecEventsTotal>1&&!this.tracks.video&&!e.video&&((s=e.audio)==null?void 0:s.id)==="main"&&(this.log("Main audio-only"),this.bufferCodecEventsTotal=1),this.mediaSourceOpenOrEnded&&this.checkPendingTracks())}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((t,e)=>{const s=this.tracks[e];return t[e]={id:s.id,container:s.container,codec:s.codec,levelCodec:s.levelCodec},t},{})}appendChangeType(t,e,s){const i=`${e};codecs=${s}`,n={label:`change-type=${i}`,execute:()=>{const r=this.tracks[t];if(r){const a=r.buffer;a!=null&&a.changeType&&(this.log(`changing ${t} sourceBuffer type to ${i}`),a.changeType(i),r.codec=s,r.container=e)}this.shiftAndExecuteNext(t)},onStart:()=>{},onComplete:()=>{},onError:r=>{this.warn(`Failed to change ${t} SourceBuffer type`,r)}};this.append(n,t,this.isPending(this.tracks[t]))}blockAudio(t){var e;const s=t.start,i=s+t.duration*.05;if(((e=this.fragmentTracker.getAppendedFrag(s,H.MAIN))==null?void 0:e.gap)===!0)return;const r={label:"block-audio",execute:()=>{var a;const c=this.tracks.video;(this.lastVideoAppendEnd>i||c!=null&&c.buffer&&j.isBuffered(c.buffer,i)||((a=this.fragmentTracker.getAppendedFrag(i,H.MAIN))==null?void 0:a.gap)===!0)&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext("audio"))},onStart:()=>{},onComplete:()=>{},onError:a=>{this.warn("Error executing block-audio operation",a)}};this.blockedAudioAppend={op:r,frag:t},this.append(r,"audio",!0)}unblockAudio(){const{blockedAudioAppend:t,operationQueue:e}=this;t&&e&&(this.blockedAudioAppend=null,e.unblockAudio(t.op))}onBufferAppending(t,e){const{tracks:s}=this,{data:i,type:n,parent:r,frag:a,part:c,chunkMeta:l,offset:h}=e,A=l.buffering[n],{sn:u,cc:d}=a,f=self.performance.now();A.start=f;const g=a.stats.buffering,m=c?c.stats.buffering:null;g.start===0&&(g.start=f),m&&m.start===0&&(m.start=f);const E=s.audio;let p=!1;n==="audio"&&E?.container==="audio/mpeg"&&(p=!this.lastMpegAudioChunk||l.id===1||this.lastMpegAudioChunk.sn!==l.sn,this.lastMpegAudioChunk=l);const I=s.video,C=I?.buffer;if(C&&u!=="initSegment"){const T=c||a,x=this.blockedAudioAppend;if(n==="audio"&&r!=="main"&&!this.blockedAudioAppend&&!(I.ending||I.ended)){const B=T.start+T.duration*.05,D=C.buffered,R=this.currentOp("video");!D.length&&!R?this.blockAudio(T):!R&&!j.isBuffered(C,B)&&this.lastVideoAppendEnd<B&&this.blockAudio(T)}else if(n==="video"){const L=T.end;if(x){const B=x.frag.start;(L>B||L<this.lastVideoAppendEnd||j.isBuffered(C,B))&&this.unblockAudio()}this.lastVideoAppendEnd=L}}const S=(c||a).start,v={label:`append-${n}`,execute:()=>{var T;A.executeStart=self.performance.now();const x=(T=this.tracks[n])==null?void 0:T.buffer;x&&(p?this.updateTimestampOffset(x,S,.1,n,u,d):h!==void 0&&K(h)&&this.updateTimestampOffset(x,h,1e-6,n,u,d)),this.appendExecutor(i,n)},onStart:()=>{},onComplete:()=>{const T=self.performance.now();A.executeEnd=A.end=T,g.first===0&&(g.first=T),m&&m.first===0&&(m.first=T);const x={};this.sourceBuffers.forEach(([L,B])=>{L&&(x[L]=j.getBuffered(B))}),this.appendErrors[n]=0,n==="audio"||n==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(y.BUFFER_APPENDED,{type:n,frag:a,part:c,chunkMeta:l,parent:a.type,timeRanges:x})},onError:T=>{var x;const L={type:V.MEDIA_ERROR,parent:a.type,details:w.BUFFER_APPEND_ERROR,sourceBufferName:n,frag:a,part:c,chunkMeta:l,error:T,err:T,fatal:!1},B=(x=this.media)==null?void 0:x.error;if(T.code===DOMException.QUOTA_EXCEEDED_ERR||T.name=="QuotaExceededError"||"quota"in T)L.details=w.BUFFER_FULL_ERROR;else if(T.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!B)L.errorAction=ms(!0);else if(T.name===Nc&&this.sourceBufferCount===0)L.errorAction=ms(!0);else{const D=++this.appendErrors[n];this.warn(`Failed ${D}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${n}" sourceBuffer (${B||"no media error"})`),(D>=this.hls.config.appendErrorMaxRetry||B)&&(L.fatal=!0)}this.hls.trigger(y.ERROR,L)}};this.log(`queuing "${n}" append sn: ${u}${c?" p: "+c.index:""} of ${a.type===H.MAIN?"level":"track"} ${a.level} cc: ${d}`),this.append(v,n,this.isPending(this.tracks[n]))}getFlushOp(t,e,s){return this.log(`queuing "${t}" remove ${e}-${s}`),{label:"remove",execute:()=>{this.removeExecutor(t,e,s)},onStart:()=>{},onComplete:()=>{this.hls.trigger(y.BUFFER_FLUSHED,{type:t})},onError:i=>{this.warn(`Failed to remove ${e}-${s} from "${t}" SourceBuffer`,i)}}}onBufferFlushing(t,e){const{type:s,startOffset:i,endOffset:n}=e;s?this.append(this.getFlushOp(s,i,n),s):this.sourceBuffers.forEach(([r])=>{r&&this.append(this.getFlushOp(r,i,n),r)})}onFragParsed(t,e){const{frag:s,part:i}=e,n=[],r=i?i.elementaryStreams:s.elementaryStreams;r[ot.AUDIOVIDEO]?n.push("audiovideo"):(r[ot.AUDIO]&&n.push("audio"),r[ot.VIDEO]&&n.push("video"));const a=()=>{const c=self.performance.now();s.stats.buffering.end=c,i&&(i.stats.buffering.end=c);const l=i?i.stats:s.stats;this.hls.trigger(y.FRAG_BUFFERED,{frag:s,part:i,stats:l,id:s.type})};n.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${s.type} level: ${s.level} sn: ${s.sn}`),this.blockBuffers(a,n).catch(c=>{this.warn(`Fragment buffered callback ${c}`),this.stepOperationQueue(this.sourceBufferTypes)})}onFragChanged(t,e){this.trimBuffers()}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([t])=>{if(t){const e=this.tracks[t];if(e)return!e.ended||e.ending}return!1})}onBufferEos(t,e){var s;this.sourceBuffers.forEach(([r])=>{if(r){const a=this.tracks[r];(!e.type||e.type===r)&&(a.ending=!0,a.ended||(a.ended=!0,this.log(`${r} buffer reached EOS`)))}});const i=((s=this.overrides)==null?void 0:s.endOfStream)!==!1;this.sourceBufferCount>0&&!this.sourceBuffers.some(([r])=>{var a;return r&&!((a=this.tracks[r])!=null&&a.ended)})?i?(this.log("Queueing EOS"),this.blockUntilOpen(()=>{this.tracksEnded();const{mediaSource:r}=this;if(!r||r.readyState!=="open"){r&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${r.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),r.endOfStream(),this.hls.trigger(y.BUFFERED_TO_END,void 0)})):(this.tracksEnded(),this.hls.trigger(y.BUFFERED_TO_END,void 0)):e.type==="video"&&this.unblockAudio()}tracksEnded(){this.sourceBuffers.forEach(([t])=>{if(t!==null){const e=this.tracks[t];e&&(e.ending=!1)}})}onLevelUpdated(t,{details:e}){e.fragments.length&&(this.details=e,this.updateDuration())}updateDuration(){this.blockUntilOpen(()=>{const t=this.getDurationAndRange();t&&this.updateMediaSource(t)})}onError(t,e){if(e.details===w.BUFFER_APPEND_ERROR&&e.frag){var s;const i=(s=e.errorAction)==null?void 0:s.nextAutoLevel;K(i)&&i!==e.frag.level&&this.resetAppendErrors()}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0}}trimBuffers(){const{hls:t,details:e,media:s}=this;if(!s||e===null||!this.sourceBufferCount)return;const i=t.config,n=s.currentTime,r=e.levelTargetDuration,a=e.live&&i.liveBackBufferLength!==null?i.liveBackBufferLength:i.backBufferLength;if(K(a)&&a>=0){const l=Math.max(a,r),h=Math.floor(n/r)*r-l;this.flushBackBuffer(n,r,h)}const c=i.frontBufferFlushThreshold;if(K(c)&&c>0){const l=Math.max(i.maxBufferLength,c),h=Math.max(l,r),A=Math.floor(n/r)*r+h;this.flushFrontBuffer(n,r,A)}}flushBackBuffer(t,e,s){this.sourceBuffers.forEach(([i,n])=>{if(n){const a=j.getBuffered(n);if(a.length>0&&s>a.start(0)){var r;this.hls.trigger(y.BACK_BUFFER_REACHED,{bufferEnd:s});const c=this.tracks[i];if((r=this.details)!=null&&r.live)this.hls.trigger(y.LIVE_BACK_BUFFER_REACHED,{bufferEnd:s});else if(c!=null&&c.ended){this.log(`Cannot flush ${i} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(y.BUFFER_FLUSHING,{startOffset:0,endOffset:s,type:i})}}})}flushFrontBuffer(t,e,s){this.sourceBuffers.forEach(([i,n])=>{if(n){const r=j.getBuffered(n),a=r.length;if(a<2)return;const c=r.start(a-1),l=r.end(a-1);if(s>c||t>=c&&t<=l)return;this.hls.trigger(y.BUFFER_FLUSHING,{startOffset:c,endOffset:1/0,type:i})}})}getDurationAndRange(){var t;const{details:e,mediaSource:s}=this;if(!e||!this.media||s?.readyState!=="open")return null;const i=e.edge;if(e.live&&this.hls.config.liveDurationInfinity){if(e.fragments.length&&s.setLiveSeekableRange){const l=Math.max(0,e.fragmentStart),h=Math.max(l,i);return{duration:1/0,start:l,end:h}}return{duration:1/0}}const n=(t=this.overrides)==null?void 0:t.duration;if(n)return K(n)?{duration:n}:null;const r=this.media.duration,a=K(s.duration)?s.duration:0;return i>a&&i>r||!K(r)?{duration:i}:null}updateMediaSource({duration:t,start:e,end:s}){const i=this.mediaSource;!this.media||!i||i.readyState!=="open"||(i.duration!==t&&(K(t)&&this.log(`Updating MediaSource duration to ${t.toFixed(3)}`),i.duration=t),e!==void 0&&s!==void 0&&(this.log(`MediaSource duration is set to ${i.duration}. Setting seekable range to ${e}-${s}.`),i.setLiveSeekableRange(e,s)))}get tracksReady(){const t=this.pendingTrackCount;return t>0&&(t>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){const{bufferCodecEventsTotal:t,pendingTrackCount:e,tracks:s}=this;if(this.log(`checkPendingTracks (pending: ${e} codec events expected: ${t}) ${at(s)}`),this.tracksReady){var i;const n=(i=this.transferData)==null?void 0:i.tracks;n&&Object.keys(n).length?this.attachTransferred():this.createSourceBuffers()}}bufferCreated(){if(this.sourceBufferCount){const t={};this.sourceBuffers.forEach(([e,s])=>{if(e){const i=this.tracks[e];t[e]={buffer:s,container:i.container,codec:i.codec,supplemental:i.supplemental,levelCodec:i.levelCodec,id:i.id,metadata:i.metadata}}}),this.hls.trigger(y.BUFFER_CREATED,{tracks:t}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([e])=>{this.executeNext(e)})}else{const t=new Error("could not create source buffer for media codec(s)");this.hls.trigger(y.ERROR,{type:V.MEDIA_ERROR,details:w.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:t,reason:t.message})}}createSourceBuffers(){const{tracks:t,sourceBuffers:e,mediaSource:s}=this;if(!s)throw new Error("createSourceBuffers called when mediaSource was null");for(const n in t){const r=n,a=t[r];if(this.isPending(a)){const c=this.getTrackCodec(a,r),l=`${a.container};codecs=${c}`;a.codec=c,this.log(`creating sourceBuffer(${l})${this.currentOp(r)?" Queued":""} ${at(a)}`);try{const h=s.addSourceBuffer(l),A=Bn(r),u=[r,h];e[A]=u,a.buffer=h}catch(h){var i;this.error(`error while trying to add sourceBuffer: ${h.message}`),this.shiftAndExecuteNext(r),(i=this.operationQueue)==null||i.removeBlockers(),delete this.tracks[r],this.hls.trigger(y.ERROR,{type:V.MEDIA_ERROR,details:w.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:h,sourceBufferName:r,mimeType:l,parent:a.id});return}this.trackSourceBuffer(r,a)}}this.bufferCreated()}getTrackCodec(t,e){const s=t.supplemental;let i=t.codec;s&&(e==="video"||e==="audiovideo")&&Ys(s,"video")&&(i=Qu(i,s));const n=_i(i,t.levelCodec);return n?e.slice(0,5)==="audio"?Yi(n,this.appendSource):n:""}trackSourceBuffer(t,e){const s=e.buffer;if(!s)return;const i=this.getTrackCodec(e,t);this.tracks[t]={buffer:s,codec:i,container:e.container,levelCodec:e.levelCodec,supplemental:e.supplemental,metadata:e.metadata,id:e.id,listeners:[]},this.removeBufferListeners(t),this.addBufferListener(t,"updatestart",this.onSBUpdateStart),this.addBufferListener(t,"updateend",this.onSBUpdateEnd),this.addBufferListener(t,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(t,"bufferedchange",(n,r)=>{const a=r.removedRanges;a!=null&&a.length&&this.hls.trigger(y.BUFFER_FLUSHED,{type:n})})}get mediaSrc(){var t,e;const s=((t=this.media)==null||(e=t.querySelector)==null?void 0:e.call(t,"source"))||this.media;return s?.src}onSBUpdateStart(t){const e=this.currentOp(t);e&&e.onStart()}onSBUpdateEnd(t){var e;if(((e=this.mediaSource)==null?void 0:e.readyState)==="closed"){this.resetBuffer(t);return}const s=this.currentOp(t);s&&(s.onComplete(),this.shiftAndExecuteNext(t))}onSBUpdateError(t,e){var s;const i=new Error(`${t} SourceBuffer error. MediaSource readyState: ${(s=this.mediaSource)==null?void 0:s.readyState}`);this.error(`${i}`,e),this.hls.trigger(y.ERROR,{type:V.MEDIA_ERROR,details:w.BUFFER_APPENDING_ERROR,sourceBufferName:t,error:i,fatal:!1});const n=this.currentOp(t);n&&n.onError(i)}updateTimestampOffset(t,e,s,i,n,r){const a=e-t.timestampOffset;Math.abs(a)>=s&&(this.log(`Updating ${i} SourceBuffer timestampOffset to ${e} (sn: ${n} cc: ${r})`),t.timestampOffset=e)}removeExecutor(t,e,s){const{media:i,mediaSource:n}=this,r=this.tracks[t],a=r?.buffer;if(!i||!n||!a){this.warn(`Attempting to remove from the ${t} SourceBuffer, but it does not exist`),this.shiftAndExecuteNext(t);return}const c=K(i.duration)?i.duration:1/0,l=K(n.duration)?n.duration:1/0,h=Math.max(0,e),A=Math.min(s,c,l);A>h&&(!r.ending||r.ended)?(r.ended=!1,this.log(`Removing [${h},${A}] from the ${t} SourceBuffer`),a.remove(h,A)):this.shiftAndExecuteNext(t)}appendExecutor(t,e){const s=this.tracks[e],i=s?.buffer;if(!i)throw new Yf(`Attempting to append to the ${e} SourceBuffer, but it does not exist`);s.ending=!1,s.ended=!1,i.appendBuffer(t)}blockUntilOpen(t){if(this.isUpdating()||this.isQueued())this.blockBuffers(t).catch(e=>{this.warn(`SourceBuffer blocked callback ${e}`),this.stepOperationQueue(this.sourceBufferTypes)});else try{t()}catch(e){this.warn(`Callback run without blocking ${this.operationQueue} ${e}`)}}isUpdating(){return this.sourceBuffers.some(([t,e])=>t&&e.updating)}isQueued(){return this.sourceBuffers.some(([t])=>t&&!!this.currentOp(t))}isPending(t){return!!t&&!t.buffer}blockBuffers(t,e=this.sourceBufferTypes){if(!e.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(t);const{operationQueue:s}=this,i=e.map(r=>this.appendBlocker(r));return e.length>1&&this.blockedAudioAppend&&this.unblockAudio(),Promise.all(i).then(r=>{s===this.operationQueue&&(t(),this.stepOperationQueue(this.sourceBufferTypes))})}stepOperationQueue(t){t.forEach(e=>{var s;const i=(s=this.tracks[e])==null?void 0:s.buffer;!i||i.updating||this.shiftAndExecuteNext(e)})}append(t,e,s){this.operationQueue&&this.operationQueue.append(t,e,s)}appendBlocker(t){if(this.operationQueue)return this.operationQueue.appendBlocker(t)}currentOp(t){return this.operationQueue?this.operationQueue.current(t):null}executeNext(t){t&&this.operationQueue&&this.operationQueue.executeNext(t)}shiftAndExecuteNext(t){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(t)}get pendingTrackCount(){return Object.keys(this.tracks).reduce((t,e)=>t+(this.isPending(this.tracks[e])?1:0),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((t,[e])=>t+(e?1:0),0)}get sourceBufferTypes(){return this.sourceBuffers.map(([t])=>t).filter(t=>!!t)}addBufferListener(t,e,s){const i=this.tracks[t];if(!i)return;const n=i.buffer;if(!n)return;const r=s.bind(this,t);i.listeners.push({event:e,listener:r}),n.addEventListener(e,r)}removeBufferListeners(t){const e=this.tracks[t];if(!e)return;const s=e.buffer;s&&(e.listeners.forEach(i=>{s.removeEventListener(i.event,i.listener)}),e.listeners.length=0)}}function Ba(o){const t=o.querySelectorAll("source");[].slice.call(t).forEach(e=>{o.removeChild(e)})}function Wf(o,t){const e=self.document.createElement("source");e.type="video/mp4",e.src=t,o.appendChild(e)}function Bn(o){return o==="audio"?1:0}class so{constructor(t){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=t,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(t){this.streamController=t}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:t}=this;t.on(y.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(y.MANIFEST_PARSED,this.onManifestParsed,this),t.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(y.BUFFER_CODECS,this.onBufferCodecs,this),t.on(y.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:t}=this;t.off(y.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(y.MANIFEST_PARSED,this.onManifestParsed,this),t.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(y.BUFFER_CODECS,this.onBufferCodecs,this),t.off(y.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(t,e){const s=this.hls.levels[e.droppedLevel];this.isLevelAllowed(s)&&this.restrictedLevels.push({bitrate:s.bitrate,height:s.height,width:s.width})}onMediaAttaching(t,e){this.media=e.media instanceof HTMLVideoElement?e.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(t,e){const s=this.hls;this.restrictedLevels=[],this.firstLevel=e.firstLevel,s.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onLevelsUpdated(t,e){this.timer&&K(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(t,e){this.hls.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onMediaDetaching(){this.stopCapping(),this.media=null}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const t=this.hls.levels;if(t.length){const e=this.hls,s=this.getMaxLevel(t.length-1);s!==this.autoLevelCapping&&e.logger.log(`Setting autoLevelCapping to ${s}: ${t[s].height}p@${t[s].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),e.autoLevelCapping=s,e.autoLevelEnabled&&e.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=e.autoLevelCapping}}}getMaxLevel(t){const e=this.hls.levels;if(!e.length)return-1;const s=e.filter((i,n)=>this.isLevelAllowed(i)&&n<=t);return this.clientRect=null,so.getMaxLevelByMediaSize(s,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const t=this.media,e={width:0,height:0};if(t){const s=t.getBoundingClientRect();e.width=s.width,e.height=s.height,!e.width&&!e.height&&(e.width=s.right-s.left||t.width||0,e.height=s.bottom-s.top||t.height||0)}return this.clientRect=e,e}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let t=1;if(!this.hls.config.ignoreDevicePixelRatio)try{t=self.devicePixelRatio}catch{}return Math.min(t,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(t){return!this.restrictedLevels.some(s=>t.bitrate===s.bitrate&&t.width===s.width&&t.height===s.height)}static getMaxLevelByMediaSize(t,e,s){if(!(t!=null&&t.length))return-1;const i=(a,c)=>c?a.width!==c.width||a.height!==c.height:!0;let n=t.length-1;const r=Math.max(e,s);for(let a=0;a<t.length;a+=1){const c=t[a];if((c.width>=r||c.height>=r)&&i(c,t[a+1])){n=a;break}}return n}}const Jf={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},Mt=Jf,jf={HLS:"h"},Xf=jf;class de{constructor(t,e){Array.isArray(t)&&(t=t.map(s=>s instanceof de?s:new de(s))),this.value=t,this.params=e}}const zf="Dict";function Zf(o){return Array.isArray(o)?JSON.stringify(o):o instanceof Map?"Map{}":o instanceof Set?"Set{}":typeof o=="object"?JSON.stringify(o):String(o)}function tg(o,t,e,s){return new Error(`failed to ${o} "${Zf(t)}" as ${e}`,{cause:s})}function fe(o,t,e){return tg("serialize",o,t,e)}class Gc{constructor(t){this.description=t}}const xa="Bare Item",eg="Boolean";function sg(o){if(typeof o!="boolean")throw fe(o,eg);return o?"?1":"?0"}function ig(o){return btoa(String.fromCharCode(...o))}const ng="Byte Sequence";function rg(o){if(ArrayBuffer.isView(o)===!1)throw fe(o,ng);return`:${ig(o)}:`}const og="Integer";function ag(o){return o<-999999999999999||999999999999999<o}function Kc(o){if(ag(o))throw fe(o,og);return o.toString()}function lg(o){return`@${Kc(o.getTime()/1e3)}`}function $c(o,t){if(o<0)return-$c(-o,t);const e=Math.pow(10,t);if(Math.abs(o*e%1-.5)<Number.EPSILON){const i=Math.floor(o*e);return(i%2===0?i:i+1)/e}else return Math.round(o*e)/e}const cg="Decimal";function hg(o){const t=$c(o,3);if(Math.floor(Math.abs(t)).toString().length>12)throw fe(o,cg);const e=t.toString();return e.includes(".")?e:`${e}.0`}const Ag="String",ug=/[\x00-\x1f\x7f]+/;function dg(o){if(ug.test(o))throw fe(o,Ag);return`"${o.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function fg(o){return o.description||o.toString().slice(7,-1)}const gg="Token";function va(o){const t=fg(o);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(t)===!1)throw fe(t,gg);return t}function pr(o){switch(typeof o){case"number":if(!K(o))throw fe(o,xa);return Number.isInteger(o)?Kc(o):hg(o);case"string":return dg(o);case"symbol":return va(o);case"boolean":return sg(o);case"object":if(o instanceof Date)return lg(o);if(o instanceof Uint8Array)return rg(o);if(o instanceof Gc)return va(o);default:throw fe(o,xa)}}const mg="Key";function Er(o){if(/^[a-z*][a-z0-9\-_.*]*$/.test(o)===!1)throw fe(o,mg);return o}function io(o){return o==null?"":Object.entries(o).map(([t,e])=>e===!0?`;${Er(t)}`:`;${Er(t)}=${pr(e)}`).join("")}function Hc(o){return o instanceof de?`${pr(o.value)}${io(o.params)}`:pr(o)}function pg(o){return`(${o.value.map(Hc).join(" ")})${io(o.params)}`}function Eg(o,t={whitespace:!0}){if(typeof o!="object"||o==null)throw fe(o,zf);const e=o instanceof Map?o.entries():Object.entries(o),s=t?.whitespace?" ":"";return Array.from(e).map(([i,n])=>{n instanceof de||(n=new de(n));let r=Er(i);return n.value===!0?r+=io(n.params):(r+="=",Array.isArray(n.value)?r+=pg(n):r+=Hc(n)),r}).join(`,${s}`)}function Vc(o,t){return Eg(o,t)}const ae="CMCD-Object",ut="CMCD-Request",Ue="CMCD-Session",xe="CMCD-Status",Ig={br:ae,ab:ae,d:ae,ot:ae,tb:ae,tpb:ae,lb:ae,tab:ae,lab:ae,url:ae,pb:ut,bl:ut,tbl:ut,dl:ut,ltc:ut,mtp:ut,nor:ut,nrr:ut,rc:ut,sn:ut,sta:ut,su:ut,ttfb:ut,ttfbb:ut,ttlb:ut,cmsdd:ut,cmsds:ut,smrt:ut,df:ut,cs:ut,ts:ut,cid:Ue,pr:Ue,sf:Ue,sid:Ue,st:Ue,v:Ue,msd:Ue,bs:xe,bsd:xe,cdn:xe,rtp:xe,bg:xe,pt:xe,ec:xe,e:xe},yg={REQUEST:ut};function Cg(o){return Object.keys(o).reduce((t,e)=>{var s;return(s=o[e])===null||s===void 0||s.forEach(i=>t[i]=e),t},{})}function Sg(o,t){const e={};if(!o)return e;const s=Object.keys(o),i=t?Cg(t):{};return s.reduce((n,r)=>{var a;const c=Ig[r]||i[r]||yg.REQUEST,l=(a=n[c])!==null&&a!==void 0?a:n[c]={};return l[r]=o[r],n},e)}function Tg(o){return["ot","sf","st","e","sta"].includes(o)}function Bg(o){return typeof o=="number"?K(o):o!=null&&o!==""&&o!==!1}const Yc="event";function xg(o,t){const e=new URL(o),s=new URL(t);if(e.origin!==s.origin)return o;const i=e.pathname.split("/").slice(1),n=s.pathname.split("/").slice(1,-1);for(;i[0]===n[0];)i.shift(),n.shift();for(;n.length;)n.shift(),i.unshift("..");return i.join("/")+e.search+e.hash}const Oi=o=>Math.round(o),Ir=(o,t)=>Array.isArray(o)?o.map(e=>Ir(e,t)):o instanceof de&&typeof o.value=="string"?new de(Ir(o.value,t),o.params):(t.baseUrl&&(o=xg(o,t.baseUrl)),t.version===1?encodeURIComponent(o):o),li=o=>Oi(o/100)*100,vg=(o,t)=>{let e=o;return t.version>=2&&(o instanceof de&&typeof o.value=="string"?e=new de([o]):typeof o=="string"&&(e=[o])),Ir(e,t)},Lg={br:Oi,d:Oi,bl:li,dl:li,mtp:li,nor:vg,rtp:li,tb:Oi},qc="request",Wc="response",no=["ab","bg","bl","br","bs","bsd","cdn","cid","cs","df","ec","lab","lb","ltc","msd","mtp","pb","pr","pt","sf","sid","sn","st","sta","tab","tb","tbl","tpb","ts","v"],Dg=["e"],Rg=/^[a-zA-Z0-9-.]+-[a-zA-Z0-9-.]+$/;function on(o){return Rg.test(o)}function bg(o){return no.includes(o)||Dg.includes(o)||on(o)}const Jc=["d","dl","nor","ot","rtp","su"];function wg(o){return no.includes(o)||Jc.includes(o)||on(o)}const kg=["cmsdd","cmsds","rc","smrt","ttfb","ttfbb","ttlb","url"];function _g(o){return no.includes(o)||Jc.includes(o)||kg.includes(o)||on(o)}const Pg=["bl","br","bs","cid","d","dl","mtp","nor","nrr","ot","pr","rtp","sf","sid","st","su","tb","v"];function Fg(o){return Pg.includes(o)||on(o)}const Qg={[Wc]:_g,[Yc]:bg,[qc]:wg};function jc(o,t={}){const e={};if(o==null||typeof o!="object")return e;const s=t.version||o.v||1,i=t.reportingMode||qc,n=s===1?Fg:Qg[i];let r=Object.keys(o).filter(n);const a=t.filter;typeof a=="function"&&(r=r.filter(a));const c=i===Wc||i===Yc;c&&!r.includes("ts")&&r.push("ts"),s>1&&!r.includes("v")&&r.push("v");const l=rt({},Lg,t.formatters),h={version:s,reportingMode:i,baseUrl:t.baseUrl};return r.sort().forEach(A=>{let u=o[A];const d=l[A];if(typeof d=="function"&&(u=d(u,h)),A==="v"){if(s===1)return;u=s}A=="pr"&&u===1||(c&&A==="ts"&&!K(u)&&(u=Date.now()),Bg(u)&&(Tg(A)&&typeof u=="string"&&(u=new Gc(u)),e[A]=u))}),e}function Mg(o,t={}){const e={};if(!o)return e;const s=jc(o,t),i=Sg(s,t?.customHeaderMap);return Object.entries(i).reduce((n,[r,a])=>{const c=Vc(a,{whitespace:!1});return c&&(n[r]=c),n},e)}function Og(o,t,e){return rt(o,Mg(t,e))}const Ug="CMCD";function Ng(o,t={}){return o?Vc(jc(o,t),{whitespace:!1}):""}function Gg(o,t={}){if(!o)return"";const e=Ng(o,t);return encodeURIComponent(e)}function Kg(o,t={}){if(!o)return"";const e=Gg(o,t);return`${Ug}=${e}`}const La=/CMCD=[^&#]+/;function $g(o,t,e){const s=Kg(t,e);if(!s)return o;if(La.test(o))return o.replace(La,s);const i=o.includes("?")?"&":"?";return`${o}${i}${s}`}class Hg{constructor(t){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=i=>{try{this.apply(i,{ot:Mt.MANIFEST,su:!this.initialized})}catch(n){this.hls.logger.warn("Could not generate manifest CMCD data.",n)}},this.applyFragmentData=i=>{try{const{frag:n,part:r}=i,a=this.hls.levels[n.level],c=this.getObjectType(n),l={d:(r||n).duration*1e3,ot:c};(c===Mt.VIDEO||c===Mt.AUDIO||c==Mt.MUXED)&&(l.br=a.bitrate/1e3,l.tb=this.getTopBandwidth(c)/1e3,l.bl=this.getBufferLength(c));const h=r?this.getNextPart(r):this.getNextFrag(n);h!=null&&h.url&&h.url!==n.url&&(l.nor=h.url),this.apply(i,l)}catch(n){this.hls.logger.warn("Could not generate segment CMCD data.",n)}},this.hls=t;const e=this.config=t.config,{cmcd:s}=e;s!=null&&(e.pLoader=this.createPlaylistLoader(),e.fLoader=this.createFragmentLoader(),this.sid=s.sessionId||t.sessionId,this.cid=s.contentId,this.useHeaders=s.useHeaders===!0,this.includeKeys=s.includeKeys,this.registerListeners())}registerListeners(){const t=this.hls;t.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(y.MEDIA_DETACHED,this.onMediaDetached,this),t.on(y.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const t=this.hls;t.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(y.MEDIA_DETACHED,this.onMediaDetached,this),t.off(y.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null}onMediaAttached(t,e){this.media=e.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(t,e){var s,i;this.audioBuffer=(s=e.tracks.audio)==null?void 0:s.buffer,this.videoBuffer=(i=e.tracks.video)==null?void 0:i.buffer}createData(){var t;return{v:1,sf:Xf.HLS,sid:this.sid,cid:this.cid,pr:(t=this.media)==null?void 0:t.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(t,e={}){rt(e,this.createData());const s=e.ot===Mt.INIT||e.ot===Mt.VIDEO||e.ot===Mt.MUXED;this.starved&&s&&(e.bs=!0,e.su=!0,this.starved=!1),e.su==null&&(e.su=this.buffering);const{includeKeys:i}=this;i&&(e=Object.keys(e).reduce((r,a)=>(i.includes(a)&&(r[a]=e[a]),r),{}));const n={baseUrl:t.url};this.useHeaders?(t.headers||(t.headers={}),Og(t.headers,e,n)):t.url=$g(t.url,e,n)}getNextFrag(t){var e;const s=(e=this.hls.levels[t.level])==null?void 0:e.details;if(s){const i=t.sn-s.startSN;return s.fragments[i+1]}}getNextPart(t){var e;const{index:s,fragment:i}=t,n=(e=this.hls.levels[i.level])==null||(e=e.details)==null?void 0:e.partList;if(n){const{sn:r}=i;for(let a=n.length-1;a>=0;a--){const c=n[a];if(c.index===s&&c.fragment.sn===r)return n[a+1]}}}getObjectType(t){const{type:e}=t;if(e==="subtitle")return Mt.TIMED_TEXT;if(t.sn==="initSegment")return Mt.INIT;if(e==="audio")return Mt.AUDIO;if(e==="main")return this.hls.audioTracks.length?Mt.VIDEO:Mt.MUXED}getTopBandwidth(t){let e=0,s;const i=this.hls;if(t===Mt.AUDIO)s=i.audioTracks;else{const n=i.maxAutoLevel,r=n>-1?n+1:i.levels.length;s=i.levels.slice(0,r)}return s.forEach(n=>{n.bitrate>e&&(e=n.bitrate)}),e>0?e:NaN}getBufferLength(t){const e=this.media,s=t===Mt.AUDIO?this.audioBuffer:this.videoBuffer;return!s||!e?NaN:j.bufferInfo(s,e.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:t}=this.config,e=this.applyPlaylistData,s=t||this.config.loader;return class{constructor(n){this.loader=void 0,this.loader=new s(n)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(n,r,a){e(n),this.loader.load(n,r,a)}}}createFragmentLoader(){const{fLoader:t}=this.config,e=this.applyFragmentData,s=t||this.config.loader;return class{constructor(n){this.loader=void 0,this.loader=new s(n)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(n,r,a){e(n),this.loader.load(n,r,a)}}}}const Vg=3e5;class Yg extends zt{constructor(t){super("content-steering",t.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=t,this.registerListeners()}registerListeners(){const t=this.hls;t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(y.MANIFEST_PARSED,this.onManifestParsed,this),t.on(y.ERROR,this.onError,this)}unregisterListeners(){const t=this.hls;t&&(t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(y.MANIFEST_PARSED,this.onManifestParsed,this),t.off(y.ERROR,this.onError,this))}pathways(){return(this.levels||[]).reduce((t,e)=>(t.indexOf(e.pathwayId)===-1&&t.push(e.pathwayId),t),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(t){this.updatePathwayPriority(t)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const t=this.timeToLoad*1e3-(performance.now()-this.updated);if(t>0){this.scheduleRefresh(this.uri,t);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(t){const e=this.levels;e&&(this.levels=e.filter(s=>s!==t))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(t,e){const{contentSteering:s}=e;s!==null&&(this.pathwayId=s.pathwayId,this.uri=s.uri,this.started&&this.startLoad())}onManifestParsed(t,e){this.audioTracks=e.audioTracks,this.subtitleTracks=e.subtitleTracks}onError(t,e){const{errorAction:s}=e;if(s?.action===vt.SendAlternateToPenaltyBox&&s.flags===Nt.MoveAllAlternatesMatchingHost){const i=this.levels;let n=this._pathwayPriority,r=this.pathwayId;if(e.context){const{groupId:a,pathwayId:c,type:l}=e.context;a&&i?r=this.getPathwayForGroupId(a,l,r):c&&(r=c)}r in this.penalizedPathways||(this.penalizedPathways[r]=performance.now()),!n&&i&&(n=this.pathways()),n&&n.length>1&&(this.updatePathwayPriority(n),s.resolved=this.pathwayId!==r),e.details===w.BUFFER_APPEND_ERROR&&!e.fatal?s.resolved=!0:s.resolved||this.warn(`Could not resolve ${e.details} ("${e.error.message}") with content-steering for Pathway: ${r} levels: ${i&&i.length} priorities: ${at(n)} penalized: ${at(this.penalizedPathways)}`)}}filterParsedLevels(t){this.levels=t;let e=this.getLevelsForPathway(this.pathwayId);if(e.length===0){const s=t[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${s}"`),e=this.getLevelsForPathway(s),this.pathwayId=s}return e.length!==t.length&&this.log(`Found ${e.length}/${t.length} levels in Pathway "${this.pathwayId}"`),e}getLevelsForPathway(t){return this.levels===null?[]:this.levels.filter(e=>t===e.pathwayId)}updatePathwayPriority(t){this._pathwayPriority=t;let e;const s=this.penalizedPathways,i=performance.now();Object.keys(s).forEach(n=>{i-s[n]>Vg&&delete s[n]});for(let n=0;n<t.length;n++){const r=t[n];if(r in s)continue;if(r===this.pathwayId)return;const a=this.hls.nextLoadLevel,c=this.hls.levels[a];if(e=this.getLevelsForPathway(r),e.length>0){this.log(`Setting Pathway to "${r}"`),this.pathwayId=r,mc(e),this.hls.trigger(y.LEVELS_UPDATED,{levels:e});const l=this.hls.levels[a];c&&l&&this.levels&&(l.attrs["STABLE-VARIANT-ID"]!==c.attrs["STABLE-VARIANT-ID"]&&l.bitrate!==c.bitrate&&this.log(`Unstable Pathways change from bitrate ${c.bitrate} to ${l.bitrate}`),this.hls.nextLoadLevel=a);break}}}getPathwayForGroupId(t,e,s){const i=this.getLevelsForPathway(s).concat(this.levels||[]);for(let n=0;n<i.length;n++)if(e===z.AUDIO_TRACK&&i[n].hasAudioGroup(t)||e===z.SUBTITLE_TRACK&&i[n].hasSubtitleGroup(t))return i[n].pathwayId;return s}clonePathways(t){const e=this.levels;if(!e)return;const s={},i={};t.forEach(n=>{const{ID:r,"BASE-ID":a,"URI-REPLACEMENT":c}=n;if(e.some(h=>h.pathwayId===r))return;const l=this.getLevelsForPathway(a).map(h=>{const A=new ct(h.attrs);A["PATHWAY-ID"]=r;const u=A.AUDIO&&`${A.AUDIO}_clone_${r}`,d=A.SUBTITLES&&`${A.SUBTITLES}_clone_${r}`;u&&(s[A.AUDIO]=u,A.AUDIO=u),d&&(i[A.SUBTITLES]=d,A.SUBTITLES=d);const f=Xc(h.uri,A["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",c),g=new Ws({attrs:A,audioCodec:h.audioCodec,bitrate:h.bitrate,height:h.height,name:h.name,url:f,videoCodec:h.videoCodec,width:h.width});if(h.audioGroups)for(let m=1;m<h.audioGroups.length;m++)g.addGroupId("audio",`${h.audioGroups[m]}_clone_${r}`);if(h.subtitleGroups)for(let m=1;m<h.subtitleGroups.length;m++)g.addGroupId("text",`${h.subtitleGroups[m]}_clone_${r}`);return g});e.push(...l),Da(this.audioTracks,s,c,r),Da(this.subtitleTracks,i,c,r)})}loadSteeringManifest(t){const e=this.hls.config,s=e.loader;this.loader&&this.loader.destroy(),this.loader=new s(e);let i;try{i=new self.URL(t)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${t}`);return}if(i.protocol!=="data:"){const h=(this.hls.bandwidthEstimate||e.abrEwmaDefaultEstimate)|0;i.searchParams.set("_HLS_pathway",this.pathwayId),i.searchParams.set("_HLS_throughput",""+h)}const n={responseType:"json",url:i.href},r=e.steeringManifestLoadPolicy.default,a=r.errorRetry||r.timeoutRetry||{},c={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(h,A,u,d)=>{this.log(`Loaded steering manifest: "${i}"`);const f=h.data;if(f?.VERSION!==1){this.log(`Steering VERSION ${f.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=f.TTL;const{"RELOAD-URI":g,"PATHWAY-CLONES":m,"PATHWAY-PRIORITY":E}=f;if(g)try{this.uri=new self.URL(g,i).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${g}`);return}this.scheduleRefresh(this.uri||u.url),m&&this.clonePathways(m);const p={steeringManifest:f,url:i.toString()};this.hls.trigger(y.STEERING_MANIFEST_LOADED,p),E&&this.updatePathwayPriority(E)},onError:(h,A,u,d)=>{if(this.log(`Error loading steering manifest: ${h.code} ${h.text} (${A.url})`),this.stopLoad(),h.code===410){this.enabled=!1,this.log(`Steering manifest ${A.url} no longer available`);return}let f=this.timeToLoad*1e3;if(h.code===429){const g=this.loader;if(typeof g?.getResponseHeader=="function"){const m=g.getResponseHeader("Retry-After");m&&(f=parseFloat(m)*1e3)}this.log(`Steering manifest ${A.url} rate limited`);return}this.scheduleRefresh(this.uri||A.url,f)},onTimeout:(h,A,u)=>{this.log(`Timeout loading steering manifest (${A.url})`),this.scheduleRefresh(this.uri||A.url)}};this.log(`Requesting steering manifest: ${i}`),this.loader.load(n,c,l)}scheduleRefresh(t,e=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var s;const i=(s=this.hls)==null?void 0:s.media;if(i&&!i.ended){this.loadSteeringManifest(t);return}this.scheduleRefresh(t,this.timeToLoad*1e3)},e)}}function Da(o,t,e,s){o&&Object.keys(t).forEach(i=>{const n=o.filter(r=>r.groupId===i).map(r=>{const a=rt({},r);return a.details=void 0,a.attrs=new ct(a.attrs),a.url=a.attrs.URI=Xc(r.url,r.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",e),a.groupId=a.attrs["GROUP-ID"]=t[i],a.attrs["PATHWAY-ID"]=s,a});o.push(...n)})}function Xc(o,t,e,s){const{HOST:i,PARAMS:n,[e]:r}=s;let a;t&&(a=r?.[t],a&&(o=a));const c=new self.URL(o);return i&&!a&&(c.host=i),n&&Object.keys(n).sort().forEach(l=>{l&&c.searchParams.set(l,n[l])}),c.href}class Es extends zt{constructor(t){super("eme",t.logger),this.hls=void 0,this.config=void 0,this.media=null,this.mediaResolved=void 0,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.mediaKeys=null,this.setMediaKeysQueue=Es.CDMCleanupPromise?[Es.CDMCleanupPromise]:[],this.bannedKeyIds={},this.onMediaEncrypted=e=>{const{initDataType:s,initData:i}=e,n=`"${e.type}" event: init data type: "${s}"`;if(this.debug(n),i!==null){if(!this.keyFormatPromise){let r=Object.keys(this.keySystemAccessPromises);r.length||(r=Ms(this.config));const a=r.map(mn).filter(c=>!!c);this.keyFormatPromise=this.getKeyFormatPromise(a)}this.keyFormatPromise.then(r=>{const a=Fi(r);if(s!=="sinf"||a!==At.FAIRPLAY){this.log(`Ignoring "${e.type}" event with init data type: "${s}" for selected key-system ${a}`);return}let c;try{const d=pt(new Uint8Array(i)),f=Yr(JSON.parse(d).sinf),g=Vl(f);if(!g)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");c=new Uint8Array(g.subarray(8,24))}catch(d){this.warn(`${n} Failed to parse sinf: ${d}`);return}const l=Lt(c),{keyIdToKeySessionPromise:h,mediaKeySessions:A}=this;let u=h[l];for(let d=0;d<A.length;d++){const f=A[d],g=f.decryptdata;if(!g.keyId)continue;const m=Lt(g.keyId);if(Xi(c,g.keyId)||g.uri.replace(/-/g,"").indexOf(l)!==-1){if(u=h[m],!u)continue;if(g.pssh)break;delete h[m],g.pssh=new Uint8Array(i),g.keyId=c,u=h[l]=u.then(()=>this.generateRequestWithPreferredKeySession(f,s,i,"encrypted-event-key-match")),u.catch(E=>this.handleError(E));break}}u||this.handleError(new Error(`Key ID ${l} not encountered in playlist. Key-system sessions ${A.length}.`))}).catch(r=>this.handleError(r))}},this.onWaitingForKey=e=>{this.log(`"${e.type}" event`)},this.hls=t,this.config=t.config,this.registerListeners()}destroy(){this.onDestroying(),this.onMediaDetached();const t=this.config;t.requestMediaKeySystemAccessFunc=null,t.licenseXhrSetup=t.licenseResponseCallback=void 0,t.drmSystems=t.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null}registerListeners(){this.hls.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(y.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.on(y.DESTROYING,this.onDestroying,this)}unregisterListeners(){this.hls.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(y.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.off(y.DESTROYING,this.onDestroying,this)}getLicenseServerUrl(t){const{drmSystems:e,widevineLicenseUrl:s}=this.config,i=e?.[t];if(i)return i.licenseUrl;if(t===At.WIDEVINE&&s)return s}getLicenseServerUrlOrThrow(t){const e=this.getLicenseServerUrl(t);if(e===void 0)throw new Error(`no license server URL configured for key-system "${t}"`);return e}getServerCertificateUrl(t){const{drmSystems:e}=this.config,s=e?.[t];if(s)return s.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${t}"]`)}attemptKeySystemAccess(t){const e=this.hls.levels,s=(r,a,c)=>!!r&&c.indexOf(r)===a,i=e.map(r=>r.audioCodec).filter(s),n=e.map(r=>r.videoCodec).filter(s);return i.length+n.length===0&&n.push("avc1.42e01e"),new Promise((r,a)=>{const c=l=>{const h=l.shift();this.getMediaKeysPromise(h,i,n).then(A=>r({keySystem:h,mediaKeys:A})).catch(A=>{l.length?c(l):A instanceof Ut?a(A):a(new Ut({type:V.KEY_SYSTEM_ERROR,details:w.KEY_SYSTEM_NO_ACCESS,error:A,fatal:!0},A.message))})};c(t)})}requestMediaKeySystemAccess(t,e){const{requestMediaKeySystemAccessFunc:s}=this.config;if(typeof s!="function"){let i=`Configured requestMediaKeySystemAccess is not a function ${s}`;return lc===null&&self.location.protocol==="http:"&&(i=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(i))}return s(t,e)}getMediaKeysPromise(t,e,s){var i;const n=xd(t,e,s,this.config.drmSystemOptions||{});let r=this.keySystemAccessPromises[t],a=(i=r)==null?void 0:i.keySystemAccess;if(!a){this.log(`Requesting encrypted media "${t}" key-system access with config: ${at(n)}`),a=this.requestMediaKeySystemAccess(t,n);const c=r=this.keySystemAccessPromises[t]={keySystemAccess:a};return a.catch(l=>{this.log(`Failed to obtain access to key-system "${t}": ${l}`)}),a.then(l=>{this.log(`Access for key-system "${l.keySystem}" obtained`);const h=this.fetchServerCertificate(t);this.log(`Create media-keys for "${t}"`);const A=c.mediaKeys=l.createMediaKeys().then(u=>(this.log(`Media-keys created for "${t}"`),c.hasMediaKeys=!0,h.then(d=>d?this.setMediaKeysServerCertificate(u,t,d):u)));return A.catch(u=>{this.error(`Failed to create media-keys for "${t}"}: ${u}`)}),A})}return a.then(()=>r.mediaKeys)}createMediaKeySessionContext({decryptdata:t,keySystem:e,mediaKeys:s}){this.log(`Creating key-system session "${e}" keyId: ${Lt(t.keyId||[])} keyUri: ${t.uri}`);const i=s.createSession(),n={decryptdata:t,keySystem:e,mediaKeys:s,mediaKeysSession:i,keyStatus:"status-pending"};return this.mediaKeySessions.push(n),n}renewKeySession(t){const e=t.decryptdata;if(e.pssh){const s=this.createMediaKeySessionContext(t),i=ci(e),n="cenc";this.keyIdToKeySessionPromise[i]=this.generateRequestWithPreferredKeySession(s,n,e.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(t)}updateKeySession(t,e){const s=t.mediaKeysSession;return this.log(`Updating key-session "${s.sessionId}" for keyId ${Lt(t.decryptdata.keyId||[])}
      } (data length: ${e.byteLength})`),s.update(e)}getSelectedKeySystemFormats(){return Object.keys(this.keySystemAccessPromises).map(t=>({keySystem:t,hasMediaKeys:this.keySystemAccessPromises[t].hasMediaKeys})).filter(({hasMediaKeys:t})=>!!t).map(({keySystem:t})=>mn(t)).filter(t=>!!t)}getKeySystemAccess(t){return this.getKeySystemSelectionPromise(t).then(({keySystem:e,mediaKeys:s})=>this.attemptSetMediaKeys(e,s))}selectKeySystem(t){return new Promise((e,s)=>{this.getKeySystemSelectionPromise(t).then(({keySystem:i})=>{const n=mn(i);n?e(n):s(new Error(`Unable to find format for key-system "${i}"`))}).catch(s)})}selectKeySystemFormat(t){const e=Object.keys(t.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${t.sn} ${t.type}: ${t.level}) key formats ${e.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(e)),this.keyFormatPromise}getKeyFormatPromise(t){const e=Ms(this.config),s=t.map(Fi).filter(i=>!!i&&e.indexOf(i)!==-1);return this.selectKeySystem(s)}getKeyStatus(t){const{mediaKeySessions:e}=this;for(let s=0;s<e.length;s++){const i=qg(t,e[s]);if(i)return i}}loadKey(t){const e=t.keyInfo.decryptdata,s=ci(e),i=this.bannedKeyIds[s];if(i||this.getKeyStatus(e)==="internal-error"){const a=Ra(i||"internal-error",e);return this.handleError(a,t.frag),Promise.reject(a)}const n=`(keyId: ${s} format: "${e.keyFormat}" method: ${e.method} uri: ${e.uri})`;this.log(`Starting session for key ${n}`);const r=this.keyIdToKeySessionPromise[s];if(!r){const a=this.getKeySystemForKeyPromise(e).then(({keySystem:c,mediaKeys:l})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${t.frag.sn} ${t.frag.type}: ${t.frag.level} using key ${n}`),this.attemptSetMediaKeys(c,l).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:c,mediaKeys:l,decryptdata:e}))))).then(c=>{const l="cenc",h=e.pssh?e.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(c,l,h,"playlist-key")});return a.catch(c=>this.handleError(c,t.frag)),this.keyIdToKeySessionPromise[s]=a,a}return r.catch(a=>{if(a instanceof Ut){const c=it({},a.data);this.getKeyStatus(e)==="internal-error"&&(c.decryptdata=e);const l=new Ut(c,a.message);this.handleError(l,t.frag)}}),r}throwIfDestroyed(t="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(t,e){if(this.hls)if(t instanceof Ut){e&&(t.data.frag=e);const s=t.data.decryptdata;this.error(`${t.message}${s?` (${Lt(s.keyId||[])})`:""}`),this.hls.trigger(y.ERROR,t.data)}else this.error(t.message),this.hls.trigger(y.ERROR,{type:V.KEY_SYSTEM_ERROR,details:w.KEY_SYSTEM_NO_KEYS,error:t,fatal:!0})}getKeySystemForKeyPromise(t){const e=ci(t),s=this.keyIdToKeySessionPromise[e];if(!s){const i=Fi(t.keyFormat),n=i?[i]:Ms(this.config);return this.attemptKeySystemAccess(n)}return s}getKeySystemSelectionPromise(t){if(t.length||(t=Ms(this.config)),t.length===0)throw new Ut({type:V.KEY_SYSTEM_ERROR,details:w.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${at({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(t)}attemptSetMediaKeys(t,e){if(this.mediaResolved=void 0,this.mediaKeys===e)return Promise.resolve();const s=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${t}"`);const i=Promise.all(s).then(()=>this.media?this.media.setMediaKeys(e):new Promise((n,r)=>{this.mediaResolved=()=>{if(this.mediaResolved=void 0,!this.media)return r(new Error("Attempted to set mediaKeys without media element attached"));this.mediaKeys=e,this.media.setMediaKeys(e).then(n).catch(r)}}));return this.mediaKeys=e,this.setMediaKeysQueue.push(i),i.then(()=>{this.log(`Media-keys set for "${t}"`),s.push(i),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(n=>s.indexOf(n)===-1)})}generateRequestWithPreferredKeySession(t,e,s,i){var n;const r=(n=this.config.drmSystems)==null||(n=n[t.keySystem])==null?void 0:n.generateRequest;if(r)try{const f=r.call(this.hls,e,s,t);if(!f)throw new Error("Invalid response from configured generateRequest filter");e=f.initDataType,s=f.initData?f.initData:null,t.decryptdata.pssh=s?new Uint8Array(s):null}catch(f){if(this.warn(f.message),this.hls&&this.hls.config.debug)throw f}if(s===null)return this.log(`Skipping key-session request for "${i}" (no initData)`),Promise.resolve(t);const a=ci(t.decryptdata),c=t.decryptdata.uri;this.log(`Generating key-session request for "${i}" keyId: ${a} URI: ${c} (init data type: ${e} length: ${s.byteLength})`);const l=new Wr,h=t._onmessage=f=>{const g=t.mediaKeysSession;if(!g){l.emit("error",new Error("invalid state"));return}const{messageType:m,message:E}=f;this.log(`"${m}" message event for session "${g.sessionId}" message size: ${E.byteLength}`),m==="license-request"||m==="license-renewal"?this.renewLicense(t,E).catch(p=>{l.eventNames().length?l.emit("error",p):this.handleError(p)}):m==="license-release"?t.keySystem===At.FAIRPLAY&&this.updateKeySession(t,Ar("acknowledged")).then(()=>this.removeSession(t)).catch(p=>this.handleError(p)):this.warn(`unhandled media key message type "${m}"`)},A=(f,g)=>{g.keyStatus=f;let m;f.startsWith("usable")?l.emit("resolved"):f==="internal-error"||f==="output-restricted"||f==="output-downscaled"?m=Ra(f,g.decryptdata):f==="expired"?m=new Error(`key expired (keyId: ${a})`):f==="released"?m=new Error("key released"):f==="status-pending"||this.warn(`unhandled key status change "${f}" (keyId: ${a})`),m&&(l.eventNames().length?l.emit("error",m):this.handleError(m))},u=t._onkeystatuseschange=f=>{if(!t.mediaKeysSession){l.emit("error",new Error("invalid state"));return}const m=this.getKeyStatuses(t);if(!Object.keys(m).some(C=>m[C]!=="status-pending"))return;if(m[a]==="expired"){this.log(`Expired key ${at(m)} in key-session "${t.mediaKeysSession.sessionId}"`),this.renewKeySession(t);return}let p=m[a];if(p)A(p,t);else{var I;t.keyStatusTimeouts||(t.keyStatusTimeouts={}),(I=t.keyStatusTimeouts)[a]||(I[a]=self.setTimeout(()=>{if(!t.mediaKeysSession||!this.mediaKeys)return;const S=this.getKeyStatus(t.decryptdata);if(S&&S!=="status-pending")return this.log(`No status for keyId ${a} in key-session "${t.mediaKeysSession.sessionId}". Using session key-status ${S} from other session.`),A(S,t);this.log(`key status for ${a} in key-session "${t.mediaKeysSession.sessionId}" timed out after 1000ms`),p="internal-error",A(p,t)},1e3)),this.log(`No status for keyId ${a} (${at(m)}).`)}};_t(t.mediaKeysSession,"message",h),_t(t.mediaKeysSession,"keystatuseschange",u);const d=new Promise((f,g)=>{l.on("error",g),l.on("resolved",f)});return t.mediaKeysSession.generateRequest(e,s).then(()=>{this.log(`Request generated for key-session "${t.mediaKeysSession.sessionId}" keyId: ${a} URI: ${c}`)}).catch(f=>{throw new Ut({type:V.KEY_SYSTEM_ERROR,details:w.KEY_SYSTEM_NO_SESSION,error:f,decryptdata:t.decryptdata,fatal:!1},`Error generating key-session request: ${f}`)}).then(()=>d).catch(f=>(l.removeAllListeners(),this.removeSession(t).then(()=>{throw f}))).then(()=>(l.removeAllListeners(),t))}getKeyStatuses(t){const e={};return t.mediaKeysSession.keyStatuses.forEach((s,i)=>{if(typeof i=="string"&&typeof s=="object"){const a=i;i=s,s=a}const n="buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i);if(t.keySystem===At.PLAYREADY&&n.length===16){const a=Lt(n);e[a]=s,oc(n)}const r=Lt(n);s==="internal-error"&&(this.bannedKeyIds[r]=s),this.log(`key status change "${s}" for keyStatuses keyId: ${r} key-session "${t.mediaKeysSession.sessionId}"`),e[r]=s}),e}fetchServerCertificate(t){const e=this.config,s=e.loader,i=new s(e),n=this.getServerCertificateUrl(t);return n?(this.log(`Fetching server certificate for "${t}"`),new Promise((r,a)=>{const c={responseType:"arraybuffer",url:n},l=e.certLoadPolicy.default,h={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},A={onSuccess:(u,d,f,g)=>{r(u.data)},onError:(u,d,f,g)=>{a(new Ut({type:V.KEY_SYSTEM_ERROR,details:w.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:f,response:it({url:c.url,data:void 0},u)},`"${t}" certificate request failed (${n}). Status: ${u.code} (${u.text})`))},onTimeout:(u,d,f)=>{a(new Ut({type:V.KEY_SYSTEM_ERROR,details:w.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:f,response:{url:c.url,data:void 0}},`"${t}" certificate request timed out (${n})`))},onAbort:(u,d,f)=>{a(new Error("aborted"))}};i.load(c,h,A)})):Promise.resolve()}setMediaKeysServerCertificate(t,e,s){return new Promise((i,n)=>{t.setServerCertificate(s).then(r=>{this.log(`setServerCertificate ${r?"success":"not supported by CDM"} (${s.byteLength}) on "${e}"`),i(t)}).catch(r=>{n(new Ut({type:V.KEY_SYSTEM_ERROR,details:w.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:r,fatal:!0},r.message))})})}renewLicense(t,e){return this.requestLicense(t,new Uint8Array(e)).then(s=>this.updateKeySession(t,new Uint8Array(s)).catch(i=>{throw new Ut({type:V.KEY_SYSTEM_ERROR,details:w.KEY_SYSTEM_SESSION_UPDATE_FAILED,decryptdata:t.decryptdata,error:i,fatal:!1},i.message)}))}unpackPlayReadyKeyMessage(t,e){const s=String.fromCharCode.apply(null,new Uint16Array(e.buffer));if(!s.includes("PlayReadyKeyMessage"))return t.setRequestHeader("Content-Type","text/xml; charset=utf-8"),e;const i=new DOMParser().parseFromString(s,"application/xml"),n=i.querySelectorAll("HttpHeader");if(n.length>0){let h;for(let A=0,u=n.length;A<u;A++){var r,a;h=n[A];const d=(r=h.querySelector("name"))==null?void 0:r.textContent,f=(a=h.querySelector("value"))==null?void 0:a.textContent;d&&f&&t.setRequestHeader(d,f)}}const c=i.querySelector("Challenge"),l=c?.textContent;if(!l)throw new Error("Cannot find <Challenge> in key message");return Ar(atob(l))}setupLicenseXHR(t,e,s,i){const n=this.config.licenseXhrSetup;return n?Promise.resolve().then(()=>{if(!s.decryptdata)throw new Error("Key removed");return n.call(this.hls,t,e,s,i)}).catch(r=>{if(!s.decryptdata)throw r;return t.open("POST",e,!0),n.call(this.hls,t,e,s,i)}).then(r=>(t.readyState||t.open("POST",e,!0),{xhr:t,licenseChallenge:r||i})):(t.open("POST",e,!0),Promise.resolve({xhr:t,licenseChallenge:i}))}requestLicense(t,e){const s=this.config.keyLoadPolicy.default;return new Promise((i,n)=>{const r=this.getLicenseServerUrlOrThrow(t.keySystem);this.log(`Sending license request to URL: ${r}`);const a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=()=>{if(!this.hls||!t.mediaKeysSession)return n(new Error("invalid state"));if(a.readyState===4)if(a.status===200){this._requestLicenseFailureCount=0;let c=a.response;this.log(`License received ${c instanceof ArrayBuffer?c.byteLength:c}`);const l=this.config.licenseResponseCallback;if(l)try{c=l.call(this.hls,a,r,t)}catch(h){this.error(h)}i(c)}else{const c=s.errorRetry,l=c?c.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>l||a.status>=400&&a.status<500)n(new Ut({type:V.KEY_SYSTEM_ERROR,details:w.KEY_SYSTEM_LICENSE_REQUEST_FAILED,decryptdata:t.decryptdata,fatal:!0,networkDetails:a,response:{url:r,data:void 0,code:a.status,text:a.statusText}},`License Request XHR failed (${r}). Status: ${a.status} (${a.statusText})`));else{const h=l-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${h} attempts left`),this.requestLicense(t,e).then(i,n)}}},t.licenseXhr&&t.licenseXhr.readyState!==XMLHttpRequest.DONE&&t.licenseXhr.abort(),t.licenseXhr=a,this.setupLicenseXHR(a,r,t,e).then(({xhr:c,licenseChallenge:l})=>{t.keySystem==At.PLAYREADY&&(l=this.unpackPlayReadyKeyMessage(c,l)),c.send(l)}).catch(n)})}onDestroying(){this.unregisterListeners(),this._clear()}onMediaAttached(t,e){if(!this.config.emeEnabled)return;const s=e.media;this.media=s,_t(s,"encrypted",this.onMediaEncrypted),_t(s,"waitingforkey",this.onWaitingForKey);const i=this.mediaResolved;i?i():this.mediaKeys=s.mediaKeys}onMediaDetached(){const t=this.media;t&&(Ot(t,"encrypted",this.onMediaEncrypted),Ot(t,"waitingforkey",this.onWaitingForKey),this.media=null,this.mediaKeys=null)}_clear(){var t;this._requestLicenseFailureCount=0,this.keyIdToKeySessionPromise={},this.bannedKeyIds={};const e=this.mediaResolved;if(e&&e(),!this.mediaKeys&&!this.mediaKeySessions.length)return;const s=this.media,i=this.mediaKeySessions.slice();this.mediaKeySessions=[],this.mediaKeys=null,we.clearKeyUriToKeyIdMap();const n=i.length;Es.CDMCleanupPromise=Promise.all(i.map(r=>this.removeSession(r)).concat((s==null||(t=s.setMediaKeys(null))==null?void 0:t.catch(r=>{this.log(`Could not clear media keys: ${r}`),this.hls&&this.hls.trigger(y.ERROR,{type:V.OTHER_ERROR,details:w.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:new Error(`Could not clear media keys: ${r}`)})}))||Promise.resolve())).catch(r=>{this.log(`Could not close sessions and clear media keys: ${r}`),this.hls&&this.hls.trigger(y.ERROR,{type:V.OTHER_ERROR,details:w.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close sessions and clear media keys: ${r}`)})}).then(()=>{n&&this.log("finished closing key sessions and clearing media keys")})}onManifestLoading(){this._clear()}onManifestLoaded(t,{sessionKeys:e}){if(!(!e||!this.config.emeEnabled)&&!this.keyFormatPromise){const s=e.reduce((i,n)=>(i.indexOf(n.keyFormat)===-1&&i.push(n.keyFormat),i),[]);this.log(`Selecting key-system from session-keys ${s.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(s)}}removeSession(t){const{mediaKeysSession:e,licenseXhr:s,decryptdata:i}=t;if(e){this.log(`Remove licenses and keys and close session "${e.sessionId}" keyId: ${Lt(i?.keyId||[])}`),t._onmessage&&(e.removeEventListener("message",t._onmessage),t._onmessage=void 0),t._onkeystatuseschange&&(e.removeEventListener("keystatuseschange",t._onkeystatuseschange),t._onkeystatuseschange=void 0),s&&s.readyState!==XMLHttpRequest.DONE&&s.abort(),t.mediaKeysSession=t.decryptdata=t.licenseXhr=void 0;const n=this.mediaKeySessions.indexOf(t);n>-1&&this.mediaKeySessions.splice(n,1);const{keyStatusTimeouts:r}=t;r&&Object.keys(r).forEach(l=>self.clearTimeout(r[l]));const{drmSystemOptions:a}=this.config;return(Ld(a)?new Promise((l,h)=>{self.setTimeout(()=>h(new Error("MediaKeySession.remove() timeout")),8e3),e.remove().then(l).catch(h)}):Promise.resolve()).catch(l=>{this.log(`Could not remove session: ${l}`),this.hls&&this.hls.trigger(y.ERROR,{type:V.OTHER_ERROR,details:w.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:new Error(`Could not remove session: ${l}`)})}).then(()=>e.close()).catch(l=>{this.log(`Could not close session: ${l}`),this.hls&&this.hls.trigger(y.ERROR,{type:V.OTHER_ERROR,details:w.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close session: ${l}`)})})}return Promise.resolve()}}Es.CDMCleanupPromise=void 0;function ci(o){if(!o)throw new Error("Could not read keyId of undefined decryptdata");if(o.keyId===null)throw new Error("keyId is null");return Lt(o.keyId)}function qg(o,t){if(o.keyId&&t.mediaKeysSession.keyStatuses.has(o.keyId))return t.mediaKeysSession.keyStatuses.get(o.keyId);if(o.matches(t.decryptdata))return t.keyStatus}class Ut extends Error{constructor(t,e){super(e),this.data=void 0,t.error||(t.error=new Error(e)),this.data=t,t.err=t.error}}function Ra(o,t){const e=o==="output-restricted",s=e?w.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:w.KEY_SYSTEM_STATUS_INTERNAL_ERROR;return new Ut({type:V.KEY_SYSTEM_ERROR,details:s,fatal:!1,decryptdata:t},e?"HDCP level output restricted":`key status changed to "${o}"`)}class Wg{constructor(t){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=t,this.registerListeners()}setStreamController(t){this.streamController=t}registerListeners(){this.hls.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(y.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListeners(){this.hls.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(y.MEDIA_DETACHING,this.onMediaDetaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(t,e){const s=this.hls.config;if(s.capLevelOnFPSDrop){const i=e.media instanceof self.HTMLVideoElement?e.media:null;this.media=i,i&&typeof i.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),s.fpsDroppedMonitoringPeriod)}}onMediaDetaching(){this.media=null}checkFPS(t,e,s){const i=performance.now();if(e){if(this.lastTime){const n=i-this.lastTime,r=s-this.lastDroppedFrames,a=e-this.lastDecodedFrames,c=1e3*r/n,l=this.hls;if(l.trigger(y.FPS_DROP,{currentDropped:r,currentDecoded:a,totalDroppedFrames:s}),c>0&&r>l.config.fpsDroppedMonitoringThreshold*a){let h=l.currentLevel;l.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+h),h>0&&(l.autoLevelCapping===-1||l.autoLevelCapping>=h)&&(h=h-1,l.trigger(y.FPS_DROP_LEVEL_CAPPING,{level:h,droppedLevel:l.currentLevel}),l.autoLevelCapping=h,this.streamController.nextLevelSwitch())}}this.lastTime=i,this.lastDroppedFrames=s,this.lastDecodedFrames=e}}checkFPSInterval(){const t=this.media;if(t)if(this.isVideoPlaybackQualityAvailable){const e=t.getVideoPlaybackQuality();this.checkFPS(t,e.totalVideoFrames,e.droppedVideoFrames)}else this.checkFPS(t,t.webkitDecodedFrameCount,t.webkitDroppedFrameCount)}}function zc(o,t){let e;try{e=new Event("addtrack")}catch{e=document.createEvent("Event"),e.initEvent("addtrack",!1,!1)}e.track=o,t.dispatchEvent(e)}function Zc(o,t){const e=o.mode;if(e==="disabled"&&(o.mode="hidden"),o.cues&&!o.cues.getCueById(t.id))try{if(o.addCue(t),!o.cues.getCueById(t.id))throw new Error(`addCue is failed for: ${t}`)}catch(s){nt.debug(`[texttrack-utils]: ${s}`);try{const i=new self.TextTrackCue(t.startTime,t.endTime,t.text);i.id=t.id,o.addCue(i)}catch(i){nt.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${i}`)}}e==="disabled"&&(o.mode=e)}function fs(o,t){const e=o.mode;if(e==="disabled"&&(o.mode="hidden"),o.cues)for(let s=o.cues.length;s--;)t&&o.cues[s].removeEventListener("enter",t),o.removeCue(o.cues[s]);e==="disabled"&&(o.mode=e)}function yr(o,t,e,s){const i=o.mode;if(i==="disabled"&&(o.mode="hidden"),o.cues&&o.cues.length>0){const n=jg(o.cues,t,e);for(let r=0;r<n.length;r++)(!s||s(n[r]))&&o.removeCue(n[r])}i==="disabled"&&(o.mode=i)}function Jg(o,t){if(t<=o[0].startTime)return 0;const e=o.length-1;if(t>o[e].endTime)return-1;let s=0,i=e,n;for(;s<=i;)if(n=Math.floor((i+s)/2),t<o[n].startTime)i=n-1;else if(t>o[n].startTime&&s<e)s=n+1;else return n;return o[s].startTime-t<t-o[i].startTime?s:i}function jg(o,t,e){const s=[],i=Jg(o,t);if(i>-1)for(let n=i,r=o.length;n<r;n++){const a=o[n];if(a.startTime>=t&&a.endTime<=e)s.push(a);else if(a.startTime>e)return s}return s}function Ui(o){const t=[];for(let e=0;e<o.length;e++){const s=o[e];(s.kind==="subtitles"||s.kind==="captions")&&s.label&&t.push(o[e])}return t}class Xg extends eo{constructor(t){super(t,"subtitle-track-controller"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let e=null;const s=Ui(this.media.textTracks);for(let n=0;n<s.length;n++)if(s[n].mode==="hidden")e=s[n];else if(s[n].mode==="showing"){e=s[n];break}const i=this.findTrackForTextTrack(e);this.subtitleTrack!==i&&this.setSubtitleTrack(i)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(t){this._subtitleDisplay=t,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:t}=this;t.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.MANIFEST_PARSED,this.onManifestParsed,this),t.on(y.LEVEL_LOADING,this.onLevelLoading,this),t.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:t}=this;t.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.MANIFEST_PARSED,this.onManifestParsed,this),t.off(y.LEVEL_LOADING,this.onLevelLoading,this),t.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(y.ERROR,this.onError,this)}onMediaAttached(t,e){this.media=e.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(t){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,t)}onMediaDetaching(t,e){const s=this.media;if(!s)return;const i=!!e.transferMedia;if(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||s.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,i)return;Ui(s.textTracks).forEach(r=>{fs(r)})}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(t,e){this.tracks=e.subtitleTracks}onSubtitleTrackLoaded(t,e){const{id:s,groupId:i,details:n}=e,r=this.tracksInGroup[s];if(!r||r.groupId!==i){this.warn(`Subtitle track with id:${s} and group:${i} not found in active group ${r?.groupId}`);return}const a=r.details;r.details=e.details,this.log(`Subtitle track ${s} "${r.name}" lang:${r.lang} group:${i} loaded [${n.startSN}-${n.endSN}]`),s===this.trackId&&this.playlistLoaded(s,e,a)}onLevelLoading(t,e){this.switchLevel(e.level)}onLevelSwitching(t,e){this.switchLevel(e.level)}switchLevel(t){const e=this.hls.levels[t];if(!e)return;const s=e.subtitleGroups||null,i=this.groupIds;let n=this.currentTrack;if(!s||i?.length!==s?.length||s!=null&&s.some(r=>i?.indexOf(r)===-1)){this.groupIds=s,this.trackId=-1,this.currentTrack=null;const r=this.tracks.filter(h=>!s||s.indexOf(h.groupId)!==-1);if(r.length)this.selectDefaultTrack&&!r.some(h=>h.default)&&(this.selectDefaultTrack=!1),r.forEach((h,A)=>{h.id=A});else if(!n&&!this.tracksInGroup.length)return;this.tracksInGroup=r;const a=this.hls.config.subtitlePreference;if(!n&&a){this.selectDefaultTrack=!1;const h=Ae(a,r);if(h>-1)n=r[h];else{const A=Ae(a,this.tracks);n=this.tracks[A]}}let c=this.findTrackId(n);c===-1&&n&&(c=this.findTrackId(null));const l={subtitleTracks:r};this.log(`Updating subtitle tracks, ${r.length} track(s) found in "${s?.join(",")}" group-id`),this.hls.trigger(y.SUBTITLE_TRACKS_UPDATED,l),c!==-1&&this.trackId===-1&&this.setSubtitleTrack(c)}}findTrackId(t){const e=this.tracksInGroup,s=this.selectDefaultTrack;for(let i=0;i<e.length;i++){const n=e[i];if(!(s&&!n.default||!s&&!t)&&(!t||Ye(n,t)))return i}if(t){for(let i=0;i<e.length;i++){const n=e[i];if(zs(t.attrs,n.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return i}for(let i=0;i<e.length;i++){const n=e[i];if(zs(t.attrs,n.attrs,["LANGUAGE"]))return i}}return-1}findTrackForTextTrack(t){if(t){const e=this.tracksInGroup;for(let s=0;s<e.length;s++){const i=e[s];if(mr(i,t))return s}}return-1}onError(t,e){e.fatal||!e.context||e.context.type===z.SUBTITLE_TRACK&&e.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(e.context.groupId)!==-1)&&this.checkRetry(e)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(t){this.selectDefaultTrack=!1,this.setSubtitleTrack(t)}setSubtitleOption(t){if(this.hls.config.subtitlePreference=t,t){if(t.id===-1)return this.setSubtitleTrack(-1),null;const e=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,e.length){const s=this.currentTrack;if(s&&Ye(t,s))return s;const i=Ae(t,this.tracksInGroup);if(i>-1){const n=this.tracksInGroup[i];return this.setSubtitleTrack(i),n}else{if(s)return null;{const n=Ae(t,e);if(n>-1)return e[n]}}}}return null}loadPlaylist(t){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,t)}loadingPlaylist(t,e){super.loadingPlaylist(t,e);const s=t.id,i=t.groupId,n=this.getUrlWithDirectives(t.url,e),r=t.details,a=r?.age;this.log(`Loading subtitle ${s} "${t.name}" lang:${t.lang} group:${i}${e?.msn!==void 0?" at sn "+e.msn+" part "+e.part:""}${a&&r.live?" age "+a.toFixed(1)+(r.type&&" "+r.type||""):""} ${n}`),this.hls.trigger(y.SUBTITLE_TRACK_LOADING,{url:n,id:s,groupId:i,deliveryDirectives:e||null,track:t})}toggleTrackModes(){const{media:t}=this;if(!t)return;const e=Ui(t.textTracks),s=this.currentTrack;let i;if(s&&(i=e.filter(n=>mr(s,n))[0],i||this.warn(`Unable to find subtitle TextTrack with name "${s.name}" and language "${s.lang}"`)),[].slice.call(e).forEach(n=>{n.mode!=="disabled"&&n!==i&&(n.mode="disabled")}),i){const n=this.subtitleDisplay?"showing":"hidden";i.mode!==n&&(i.mode=n)}}setSubtitleTrack(t){const e=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=t;return}if(t<-1||t>=e.length||!K(t)){this.warn(`Invalid subtitle track id: ${t}`);return}this.selectDefaultTrack=!1;const s=this.currentTrack,i=e[t]||null;if(this.trackId=t,this.currentTrack=i,this.toggleTrackModes(),!i){this.hls.trigger(y.SUBTITLE_TRACK_SWITCH,{id:t});return}const n=!!i.details&&!i.details.live;if(t===this.trackId&&i===s&&n)return;this.log(`Switching to subtitle-track ${t}`+(i?` "${i.name}" lang:${i.lang} group:${i.groupId}`:""));const{id:r,groupId:a="",name:c,type:l,url:h}=i;this.hls.trigger(y.SUBTITLE_TRACK_SWITCH,{id:r,groupId:a,name:c,type:l,url:h});const A=this.switchParams(i.url,s?.details,i.details);this.loadPlaylist(A)}}function zg(){try{return crypto.randomUUID()}catch{try{const t=URL.createObjectURL(new Blob),e=t.toString();return URL.revokeObjectURL(t),e.slice(e.lastIndexOf("/")+1)}catch{let e=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,i=>{const n=(e+Math.random()*16)%16|0;return e=Math.floor(e/16),(i=="x"?n:n&3|8).toString(16)})}}}function $s(o){let t=5381,e=o.length;for(;e;)t=t*33^o.charCodeAt(--e);return(t>>>0).toString()}const Is=.025;let en=(function(o){return o[o.Point=0]="Point",o[o.Range=1]="Range",o})({});function Zg(o,t,e){return`${o.identifier}-${e+1}-${$s(t)}`}class tm{constructor(t,e){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=e,this.dateRange=t,this.setDateRange(t)}setDateRange(t){this.dateRange=t,this.resumeOffset=t.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=t.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=t.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=t.attr.enumeratedStringList("X-SNAP",this.snapOptions)}reset(){var t;this.appendInPlaceStarted=!1,(t=this.assetListLoader)==null||t.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)}isAssetPastPlayoutLimit(t){var e;if(t>0&&t>=this.assetList.length)return!0;const s=this.playoutLimit;return t<=0||isNaN(s)?!1:s===0?!0:(((e=this.assetList[t])==null?void 0:e.startOffset)||0)>s}findAssetIndex(t){return this.assetList.indexOf(t)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){const t=this.dateRange.startTime;if(this.snapOptions.out){const e=this.dateRange.tagAnchor;if(e)return xn(t,e)}return t}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(this.startTime===0||this.snapOptions.out)return!0;const t=this.dateRange.tagAnchor;if(t){const e=this.dateRange.startTime,s=xn(e,t);return e-s<.1}return!1}get resumptionOffset(){const t=this.resumeOffset,e=K(t)?t:this.duration;return this.cumulativeDuration+e}get resumeTime(){const t=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){const e=this.resumeAnchor;if(e)return xn(t,e)}return t}get appendInPlace(){return this.appendInPlaceStarted?!0:this.appendInPlaceDisabled?!1:!!(!this.cue.once&&!this.cue.pre&&this.startIsAligned&&(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<Is))}set appendInPlace(t){if(this.appendInPlaceStarted){this.resetOnResume=!t;return}this.appendInPlaceDisabled=!t}get timelineStart(){return this._timelineStart!==null?this._timelineStart:this.startTime}set timelineStart(t){this._timelineStart=t}get duration(){const t=this.playoutLimit;let e;return this._duration!==null?e=this._duration:this.dateRange.duration?e=this.dateRange.duration:e=this.dateRange.plannedDuration||0,!isNaN(t)&&t<e&&(e=t),e}set duration(t){this._duration=t}get cue(){return this.dateRange.cue}get timelineOccupancy(){return this.dateRange.attr["X-TIMELINE-OCCUPIES"]==="RANGE"?en.Range:en.Point}get supplementsPrimary(){return this.dateRange.attr["X-TIMELINE-STYLE"]==="PRIMARY"}get contentMayVary(){return this.dateRange.attr["X-CONTENT-MAY-VARY"]!=="NO"}get assetUrl(){return this.dateRange.attr["X-ASSET-URI"]}get assetListUrl(){return this.dateRange.attr["X-ASSET-LIST"]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||this.assetListResponse!==null}toString(){return em(this)}}function xn(o,t){return o-t.start<t.duration/2&&!(Math.abs(o-(t.start+t.duration))<Is)?t.start:t.start+t.duration}function th(o,t,e){const s=new self.URL(o,e);return s.protocol!=="data:"&&s.searchParams.set("_HLS_primary_id",t),s}function vn(o,t){for(;(e=o.assetList[++t])!=null&&e.error;)var e;return t}function em(o){return`["${o.identifier}" ${o.cue.pre?"<pre>":o.cue.post?"<post>":""}${o.timelineStart.toFixed(2)}-${o.resumeTime.toFixed(2)}]`}function As(o){const t=o.timelineStart,e=o.duration||0;return`["${o.identifier}" ${t.toFixed(2)}-${(t+e).toFixed(2)}]`}class sm{constructor(t,e,s,i){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{this.reachedPlayout(this.currentTime)&&this.hls&&this.hls.trigger(y.PLAYOUT_LIMIT_REACHED,{})};const n=this.hls=new t(e);this.interstitial=s,this.assetItem=i;const r=()=>{this.hasDetails=!0};n.once(y.LEVEL_LOADED,r),n.once(y.AUDIO_TRACK_LOADED,r),n.once(y.SUBTITLE_TRACK_LOADED,r),n.on(y.MEDIA_ATTACHING,(a,{media:c})=>{this.removeMediaListeners(),this.mediaAttached=c,this.interstitial.playoutLimit&&(c.addEventListener("timeupdate",this.checkPlayout),this.appendInPlace&&n.on(y.BUFFER_APPENDED,()=>{const h=this.bufferedEnd;this.reachedPlayout(h)&&(this._bufferedEosTime=h,n.trigger(y.BUFFERED_TO_END,void 0))}))})}get appendInPlace(){return this.interstitial.appendInPlace}loadSource(){const t=this.hls;if(t)if(t.url)t.levels.length&&!t.started&&t.startLoad(-1,!0);else{let e=this.assetItem.uri;try{e=th(e,t.config.primarySessionId||"").href}catch{}t.loadSource(e)}}bufferedInPlaceToEnd(t){var e;if(!this.appendInPlace)return!1;if((e=this.hls)!=null&&e.bufferedToEnd)return!0;if(!t)return!1;const s=Math.min(this._bufferedEosTime||1/0,this.duration),i=this.timelineOffset,n=j.bufferInfo(t,i,0);return this.getAssetTime(n.end)>=s-.02}reachedPlayout(t){const s=this.interstitial.playoutLimit;return this.startOffset+t>=s}get destroyed(){var t;return!((t=this.hls)!=null&&t.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){var t;return((t=this.hls)==null?void 0:t.media)||null}get bufferedEnd(){const t=this.media||this.mediaAttached;if(!t)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;const e=j.bufferInfo(t,t.currentTime,.001);return this.getAssetTime(e.end)}get currentTime(){const t=this.media||this.mediaAttached;return t?this.getAssetTime(t.currentTime):this._currentTime||0}get duration(){const t=this.assetItem.duration;if(!t)return 0;const e=this.interstitial.playoutLimit;if(e){const s=e-this.startOffset;if(s>0&&s<t)return s}return t}get remaining(){const t=this.duration;return t?Math.max(0,t-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){var t;return((t=this.hls)==null?void 0:t.config.timelineOffset)||0}set timelineOffset(t){const e=this.timelineOffset;if(t!==e){const s=t-e;if(Math.abs(s)>1/9e4&&this.hls){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=t}}}getAssetTime(t){const e=this.timelineOffset,s=this.duration;return Math.min(Math.max(0,t-e),s)}removeMediaListeners(){const t=this.mediaAttached;t&&(this._currentTime=t.currentTime,this.bufferSnapShot(),t.removeEventListener("timeupdate",this.checkPlayout))}bufferSnapShot(){if(this.mediaAttached){var t;(t=this.hls)!=null&&t.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd)}}destroy(){this.removeMediaListeners(),this.hls&&this.hls.destroy(),this.hls=null,this.tracks=this.mediaAttached=this.checkPlayout=null}attachMedia(t){var e;this.loadSource(),(e=this.hls)==null||e.attachMedia(t)}detachMedia(){var t;this.removeMediaListeners(),this.mediaAttached=null,(t=this.hls)==null||t.detachMedia()}resumeBuffering(){var t;(t=this.hls)==null||t.resumeBuffering()}pauseBuffering(){var t;(t=this.hls)==null||t.pauseBuffering()}transferMedia(){var t;return this.bufferSnapShot(),((t=this.hls)==null?void 0:t.transferMedia())||null}resetDetails(){const t=this.hls;if(t&&this.hasDetails){t.stopLoad();const e=s=>delete s.details;t.levels.forEach(e),t.allAudioTracks.forEach(e),t.allSubtitleTracks.forEach(e),this.hasDetails=!1}}on(t,e,s){var i;(i=this.hls)==null||i.on(t,e)}once(t,e,s){var i;(i=this.hls)==null||i.once(t,e)}off(t,e,s){var i;(i=this.hls)==null||i.off(t,e)}toString(){var t;return`HlsAssetPlayer: ${As(this.assetItem)} ${(t=this.hls)==null?void 0:t.sessionId} ${this.appendInPlace?"append-in-place":""}`}}const ba=.033;class im extends zt{constructor(t,e){super("interstitials-sched",e),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=t}destroy(){this.reset(),this.onScheduleUpdate=null}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(t=>t.reset()),this.events=this.items=null}resetErrorsInRange(t,e){return this.events?this.events.reduce((s,i)=>t<=i.startOffset&&e>i.startOffset?(delete i.error,s+1):s,0):0}get duration(){const t=this.items;return t?t[t.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(t){return t&&this.eventMap[t]||null}hasEvent(t){return t in this.eventMap}findItemIndex(t,e){if(t.event)return this.findEventIndex(t.event.identifier);let s=-1;t.nextEvent?s=this.findEventIndex(t.nextEvent.identifier)-1:t.previousEvent&&(s=this.findEventIndex(t.previousEvent.identifier)+1);const i=this.items;if(i)for(i[s]||(e===void 0&&(e=t.start),s=this.findItemIndexAtTime(e));s>=0&&(n=i[s])!=null&&n.event;){var n;s--}return s}findItemIndexAtTime(t,e){const s=this.items;if(s)for(let i=0;i<s.length;i++){let n=s[i];if(e&&e!=="primary"&&(n=n[e]),t===n.start||t>n.start&&t<n.end)return i}return-1}findJumpRestrictedIndex(t,e){const s=this.items;if(s)for(let i=t;i<=e&&s[i];i++){const n=s[i].event;if(n!=null&&n.restrictions.jump&&!n.appendInPlace)return i}return-1}findEventIndex(t){const e=this.items;if(e)for(let i=e.length;i--;){var s;if(((s=e[i].event)==null?void 0:s.identifier)===t)return i}return-1}findAssetIndex(t,e){const s=t.assetList,i=s.length;if(i>1)for(let n=0;n<i;n++){const r=s[n];if(!r.error){const a=r.timelineStart;if(e===a||e>a&&(e<a+(r.duration||0)||n===i-1))return n}}return 0}get assetIdAtEnd(){var t;const e=(t=this.items)==null||(t=t[this.length-1])==null?void 0:t.event;if(e){const s=e.assetList,i=s[s.length-1];if(i)return i.identifier}return null}parseInterstitialDateRanges(t,e){const s=t.main.details,{dateRanges:i}=s,n=this.events,r=this.parseDateRanges(i,{url:s.url},e),a=Object.keys(i),c=n?n.filter(l=>!a.includes(l.identifier)):[];r.length&&r.sort((l,h)=>{const A=l.cue.pre,u=l.cue.post,d=h.cue.pre,f=h.cue.post;if(A&&!d)return-1;if(d&&!A||u&&!f)return 1;if(f&&!u)return-1;if(!A&&!d&&!u&&!f){const g=l.startTime,m=h.startTime;if(g!==m)return g-m}return l.dateRange.tagOrder-h.dateRange.tagOrder}),this.events=r,c.forEach(l=>{this.removeEvent(l)}),this.updateSchedule(t,c)}updateSchedule(t,e=[],s=!1){const i=this.events||[];if(i.length||e.length||this.length<2){const n=this.items,r=this.parseSchedule(i,t);(s||e.length||n?.length!==r.length||r.some((c,l)=>Math.abs(c.playout.start-n[l].playout.start)>.005||Math.abs(c.playout.end-n[l].playout.end)>.005))&&(this.items=r,this.onScheduleUpdate(e,n))}}parseDateRanges(t,e,s){const i=[],n=Object.keys(t);for(let r=0;r<n.length;r++){const a=n[r],c=t[a];if(c.isInterstitial){let l=this.eventMap[a];l?l.setDateRange(c):(l=new tm(c,e),this.eventMap[a]=l,s===!1&&(l.appendInPlace=s)),i.push(l)}}return i}parseSchedule(t,e){const s=[],i=e.main.details,n=i.live?1/0:i.edge;let r=0;if(t=t.filter(c=>!c.error&&!(c.cue.once&&c.hasPlayed)),t.length){this.resolveOffsets(t,e);let c=0,l=0;if(t.forEach((h,A)=>{const u=h.cue.pre,d=h.cue.post,f=t[A-1]||null,g=h.appendInPlace,m=d?n:h.startOffset,E=h.duration,p=h.timelineOccupancy===en.Range?E:0,I=h.resumptionOffset,C=f?.startTime===m,S=m+h.cumulativeDuration;let v=g?S+E:m+I;if(u||!d&&m<=0){const x=l;l+=p,h.timelineStart=S;const L=r;r+=E,s.push({event:h,start:S,end:v,playout:{start:L,end:r},integrated:{start:x,end:l}})}else if(m<=n){if(!C){const B=m-c;if(B>ba){const D=c,R=l;l+=B;const k=r;r+=B;const _={previousEvent:t[A-1]||null,nextEvent:h,start:D,end:D+B,playout:{start:k,end:r},integrated:{start:R,end:l}};s.push(_)}else B>0&&f&&(f.cumulativeDuration+=B,s[s.length-1].end=m)}d&&(v=S),h.timelineStart=S;const x=l;l+=p;const L=r;r+=E,s.push({event:h,start:S,end:v,playout:{start:L,end:r},integrated:{start:x,end:l}})}else return;const T=h.resumeTime;d||T>n?c=n:c=T}),c<n){var a;const h=c,A=l,u=n-c;l+=u;const d=r;r+=u,s.push({previousEvent:((a=s[s.length-1])==null?void 0:a.event)||null,nextEvent:null,start:c,end:h+u,playout:{start:d,end:r},integrated:{start:A,end:l}})}this.setDurations(n,r,l)}else s.push({previousEvent:null,nextEvent:null,start:0,end:n,playout:{start:0,end:n},integrated:{start:0,end:n}}),this.setDurations(n,n,n);return s}setDurations(t,e,s){this.durations={primary:t,playout:e,integrated:s}}resolveOffsets(t,e){const s=e.main.details,i=s.live?1/0:s.edge;let n=0,r=-1;t.forEach((a,c)=>{const l=a.cue.pre,h=a.cue.post,A=l?0:h?i:a.startTime;this.updateAssetDurations(a),r===A?a.cumulativeDuration=n:(n=0,r=A),!h&&a.snapOptions.in&&(a.resumeAnchor=We(null,s.fragments,a.startOffset+a.resumptionOffset,0,0)||void 0),a.appendInPlace&&!a.appendInPlaceStarted&&(this.primaryCanResumeInPlaceAt(a,e)||(a.appendInPlace=!1)),!a.appendInPlace&&c+1<t.length&&t[c+1].startTime-t[c].resumeTime<ba&&(t[c+1].appendInPlace=!1,t[c+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${a}`));const d=K(a.resumeOffset)?a.resumeOffset:a.duration;n+=d})}primaryCanResumeInPlaceAt(t,e){const s=t.resumeTime,i=t.startTime+t.resumptionOffset;return Math.abs(s-i)>Is?(this.log(`"${t.identifier}" resumption ${s} not aligned with estimated timeline end ${i}`),!1):!Object.keys(e).some(r=>{const a=e[r].details,c=a.edge;if(s>=c)return this.log(`"${t.identifier}" resumption ${s} past ${r} playlist end ${c}`),!1;const l=We(null,a.fragments,s);if(!l)return this.log(`"${t.identifier}" resumption ${s} does not align with any fragments in ${r} playlist (${a.fragStart}-${a.fragmentEnd})`),!0;const h=r==="audio"?.175:0;return Math.abs(l.start-s)<Is+h||Math.abs(l.end-s)<Is+h?!1:(this.log(`"${t.identifier}" resumption ${s} not aligned with ${r} fragment bounds (${l.start}-${l.end} sn: ${l.sn} cc: ${l.cc})`),!0)})}updateAssetDurations(t){if(!t.assetListLoaded)return;const e=t.timelineStart;let s=0,i=!1,n=!1;for(let r=0;r<t.assetList.length;r++){const a=t.assetList[r],c=e+s;a.startOffset=s,a.timelineStart=c,i||(i=a.duration===null),n||(n=!!a.error);const l=a.error?0:a.duration||0;s+=l}i&&!n?t.duration=Math.max(s,t.duration):t.duration=s}removeEvent(t){t.reset(),delete this.eventMap[t.identifier]}}function te(o){return`[${o.event?'"'+o.event.identifier+'"':"primary"}: ${o.start.toFixed(2)}-${o.end.toFixed(2)}]`}class nm{constructor(t){this.hls=void 0,this.hls=t}destroy(){this.hls=null}loadAssetList(t,e){const s=t.assetListUrl;let i;try{i=th(s,this.hls.sessionId,t.baseUrl)}catch(u){const d=this.assignAssetListError(t,w.ASSET_LIST_LOAD_ERROR,u,s);this.hls.trigger(y.ERROR,d);return}e&&i.protocol!=="data:"&&i.searchParams.set("_HLS_start_offset",""+e);const n=this.hls.config,r=n.loader,a=new r(n),c={responseType:"json",url:i.href},l=n.interstitialAssetListLoadPolicy.default,h={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},A={onSuccess:(u,d,f,g)=>{const m=u.data,E=m?.ASSETS;if(!Array.isArray(E)){const p=this.assignAssetListError(t,w.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),f.url,d,g);this.hls.trigger(y.ERROR,p);return}t.assetListResponse=m,this.hls.trigger(y.ASSET_LIST_LOADED,{event:t,assetListResponse:m,networkDetails:g})},onError:(u,d,f,g)=>{const m=this.assignAssetListError(t,w.ASSET_LIST_LOAD_ERROR,new Error(`Error loading X-ASSET-LIST: HTTP status ${u.code} ${u.text} (${d.url})`),d.url,g,f);this.hls.trigger(y.ERROR,m)},onTimeout:(u,d,f)=>{const g=this.assignAssetListError(t,w.ASSET_LIST_LOAD_TIMEOUT,new Error(`Timeout loading X-ASSET-LIST (${d.url})`),d.url,u,f);this.hls.trigger(y.ERROR,g)}};return a.load(c,h,A),this.hls.trigger(y.ASSET_LIST_LOADING,{event:t}),a}assignAssetListError(t,e,s,i,n,r){return t.error=s,{type:V.NETWORK_ERROR,details:e,fatal:!1,interstitial:t,url:i,error:s,networkDetails:r,stats:n}}}function wa(o){var t;o==null||(t=o.play())==null||t.catch(()=>{})}function hi(o,t){return`[${o}] Advancing timeline position to ${t}`}class rm extends zt{constructor(t,e){super("interstitials",t.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=!1,this.onPlay=()=>{this.shouldPlay=!0},this.onPause=()=>{this.shouldPlay=!1},this.onSeeking=()=>{const s=this.currentTime;if(s===void 0||this.playbackDisabled||!this.schedule)return;const i=s-this.timelinePos;if(Math.abs(i)<1/7056e5)return;const r=i<=-.01;this.timelinePos=s,this.bufferedPos=s;const a=this.playingItem;if(!a){this.checkBuffer();return}if(r&&this.schedule.resetErrorsInRange(s,s-i)&&this.updateSchedule(!0),this.checkBuffer(),r&&s<a.start||s>=a.end){var c;const d=this.findItemIndex(a);let f=this.schedule.findItemIndexAtTime(s);if(f===-1&&(f=d+(r?-1:1),this.log(`seeked ${r?"back ":""}to position not covered by schedule ${s} (resolving from ${d} to ${f})`)),!this.isInterstitial(a)&&(c=this.media)!=null&&c.paused&&(this.shouldPlay=!1),!r&&f>d){const g=this.schedule.findJumpRestrictedIndex(d+1,f);if(g>d){this.setSchedulePosition(g);return}}this.setSchedulePosition(f);return}const l=this.playingAsset;if(!l){if(this.playingLastItem&&this.isInterstitial(a)){const d=a.event.assetList[0];d&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(s,d))}return}const h=l.timelineStart,A=l.duration||0;if(r&&s<h||s>=h+A){var u;(u=a.event)!=null&&u.appendInPlace&&(this.clearAssetPlayers(a.event,a),this.flushFrontBuffer(s)),this.setScheduleToAssetAtTime(s,l)}},this.onTimeupdate=()=>{const s=this.currentTime;if(s===void 0||this.playbackDisabled)return;if(s>this.timelinePos)this.timelinePos=s,s>this.bufferedPos&&this.checkBuffer();else return;const i=this.playingItem;if(!i||this.playingLastItem)return;if(s>=i.end){this.timelinePos=i.end;const a=this.findItemIndex(i);this.setSchedulePosition(a+1)}const n=this.playingAsset;if(!n)return;const r=n.timelineStart+(n.duration||0);s>=r&&this.setScheduleToAssetAtTime(s,n)},this.onScheduleUpdate=(s,i)=>{const n=this.schedule;if(!n)return;const r=this.playingItem,a=n.events||[],c=n.items||[],l=n.durations,h=s.map(g=>g.identifier),A=!!(a.length||h.length);(A||i)&&this.log(`INTERSTITIALS_UPDATED (${a.length}): ${a}
Schedule: ${c.map(g=>te(g))} pos: ${this.timelinePos}`),h.length&&this.log(`Removed events ${h}`);let u=null,d=null;r&&(u=this.updateItem(r,this.timelinePos),this.itemsMatch(r,u)?this.playingItem=u:this.waitingItem=this.endedItem=null),this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);const f=this.bufferingItem;if(f&&(d=this.updateItem(f,this.bufferedPos),this.itemsMatch(f,d)?this.bufferingItem=d:f.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(f.event,null))),s.forEach(g=>{g.assetList.forEach(m=>{this.clearAssetPlayer(m.identifier,null)})}),this.playerQueue.forEach(g=>{if(g.interstitial.appendInPlace){const m=g.assetItem.timelineStart,E=g.timelineOffset-m;if(E)try{g.timelineOffset=m}catch(p){Math.abs(E)>Is&&this.warn(`${p} ("${g.assetId}" ${g.timelineOffset}->${m})`)}}}),A||i){if(this.hls.trigger(y.INTERSTITIALS_UPDATED,{events:a.slice(0),schedule:c.slice(0),durations:l,removedIds:h}),this.isInterstitial(r)&&h.includes(r.event.identifier)){this.warn(`Interstitial "${r.event.identifier}" removed while playing`),this.primaryFallback(r.event);return}r&&this.trimInPlace(u,r),f&&d!==u&&this.trimInPlace(d,f),this.checkBuffer()}},this.hls=t,this.HlsPlayerClass=e,this.assetListLoader=new nm(t),this.schedule=new im(this.onScheduleUpdate,t.logger),this.registerListeners()}registerListeners(){const t=this.hls;t&&(t.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(y.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),t.on(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.on(y.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),t.on(y.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),t.on(y.ASSET_LIST_LOADED,this.onAssetListLoaded,this),t.on(y.BUFFER_APPENDED,this.onBufferAppended,this),t.on(y.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(y.BUFFERED_TO_END,this.onBufferedToEnd,this),t.on(y.MEDIA_ENDED,this.onMediaEnded,this),t.on(y.ERROR,this.onError,this),t.on(y.DESTROYING,this.onDestroying,this))}unregisterListeners(){const t=this.hls;t&&(t.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(y.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),t.off(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.off(y.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),t.off(y.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),t.off(y.ASSET_LIST_LOADED,this.onAssetListLoaded,this),t.off(y.BUFFER_CODECS,this.onBufferCodecs,this),t.off(y.BUFFER_APPENDED,this.onBufferAppended,this),t.off(y.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(y.BUFFERED_TO_END,this.onBufferedToEnd,this),t.off(y.MEDIA_ENDED,this.onMediaEnded,this),t.off(y.ERROR,this.onError,this),t.off(y.DESTROYING,this.onDestroying,this))}startLoad(){this.resumeBuffering()}stopLoad(){this.pauseBuffering()}resumeBuffering(){var t;(t=this.getBufferingPlayer())==null||t.resumeBuffering()}pauseBuffering(){var t;(t=this.getBufferingPlayer())==null||t.pauseBuffering()}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.schedule=this.manager=null,this.hls=this.HlsPlayerClass=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null}onDestroying(){const t=this.primaryMedia||this.media;t&&this.removeMediaListeners(t)}removeMediaListeners(t){Ot(t,"play",this.onPlay),Ot(t,"pause",this.onPause),Ot(t,"seeking",this.onSeeking),Ot(t,"timeupdate",this.onTimeupdate)}onMediaAttaching(t,e){const s=this.media=e.media;_t(s,"seeking",this.onSeeking),_t(s,"timeupdate",this.onTimeupdate),_t(s,"play",this.onPlay),_t(s,"pause",this.onPause)}onMediaAttached(t,e){const s=this.effectivePlayingItem,i=this.detachedData;if(this.detachedData=null,s===null)this.checkStart();else if(!i){this.clearScheduleState();const n=this.findItemIndex(s);this.setSchedulePosition(n)}}clearScheduleState(){this.log("clear schedule state"),this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null}onMediaDetaching(t,e){const s=!!e.transferMedia,i=this.media;if(this.media=null,!s&&(i&&this.removeMediaListeners(i),this.detachedData)){const n=this.getBufferingPlayer();n&&(this.log(`Removing schedule state for detachedData and ${n}`),this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,n.detachMedia()),this.shouldPlay=!1}}get interstitialsManager(){if(!this.hls)return null;if(this.manager)return this.manager;const t=this,e=()=>t.bufferingItem||t.waitingItem,s=A=>A&&t.getAssetPlayer(A.identifier),i=(A,u,d,f,g)=>{if(A){let m=A[u].start;const E=A.event;if(E){if(u==="playout"||E.timelineOccupancy!==en.Point){const p=s(d);p?.interstitial===E&&(m+=p.assetItem.startOffset+p[g])}}else{const p=f==="bufferedPos"?r():t[f];m+=p-A.start}return m}return 0},n=(A,u)=>{var d;if(A!==0&&u!=="primary"&&(d=t.schedule)!=null&&d.length){var f;const g=t.schedule.findItemIndexAtTime(A),m=(f=t.schedule.items)==null?void 0:f[g];if(m){const E=m[u].start-m.start;return A+E}}return A},r=()=>{const A=t.bufferedPos;return A===Number.MAX_VALUE?a("primary"):Math.max(A,0)},a=A=>{var u,d;return(u=t.primaryDetails)!=null&&u.live?t.primaryDetails.edge:((d=t.schedule)==null?void 0:d.durations[A])||0},c=(A,u)=>{var d,f;const g=t.effectivePlayingItem;if(g!=null&&(d=g.event)!=null&&d.restrictions.skip||!t.schedule)return;t.log(`seek to ${A} "${u}"`);const m=t.effectivePlayingItem,E=t.schedule.findItemIndexAtTime(A,u),p=(f=t.schedule.items)==null?void 0:f[E],I=t.getBufferingPlayer(),C=I?.interstitial,S=C?.appendInPlace,v=m&&t.itemsMatch(m,p);if(m&&(S||v)){const T=s(t.playingAsset),x=T?.media||t.primaryMedia;if(x){const L=u==="primary"?x.currentTime:i(m,u,t.playingAsset,"timelinePos","currentTime"),B=A-L,D=(S?L:x.currentTime)+B;if(D>=0&&(!T||S||D<=T.duration)){x.currentTime=D;return}}}if(p){let T=A;if(u!=="primary"){const L=p[u].start,B=A-L;T=p.start+B}const x=!t.isInterstitial(p);if((!t.isInterstitial(m)||m.event.appendInPlace)&&(x||p.event.appendInPlace)){const L=t.media||(S?I?.media:null);L&&(L.currentTime=T)}else if(m){const L=t.findItemIndex(m);if(E>L){const D=t.schedule.findJumpRestrictedIndex(L+1,E);if(D>L){t.setSchedulePosition(D);return}}let B=0;if(x)t.timelinePos=T,t.checkBuffer();else{const D=p.event.assetList,R=A-(p[u]||p).start;for(let k=D.length;k--;){const _=D[k];if(_.duration&&R>=_.startOffset&&R<_.startOffset+_.duration){B=k;break}}}t.setSchedulePosition(E,B)}}},l=()=>{const A=t.effectivePlayingItem;if(t.isInterstitial(A))return A;const u=e();return t.isInterstitial(u)?u:null},h={get bufferedEnd(){const A=e(),u=t.bufferingItem;if(u&&u===A){var d;return i(u,"playout",t.bufferingAsset,"bufferedPos","bufferedEnd")-u.playout.start||((d=t.bufferingAsset)==null?void 0:d.startOffset)||0}return 0},get currentTime(){const A=l(),u=t.effectivePlayingItem;return u&&u===A?i(u,"playout",t.effectivePlayingAsset,"timelinePos","currentTime")-u.playout.start:0},set currentTime(A){const u=l(),d=t.effectivePlayingItem;d&&d===u&&c(A+d.playout.start,"playout")},get duration(){const A=l();return A?A.playout.end-A.playout.start:0},get assetPlayers(){var A;const u=(A=l())==null?void 0:A.event.assetList;return u?u.map(d=>t.getAssetPlayer(d.identifier)):[]},get playingIndex(){var A;const u=(A=l())==null?void 0:A.event;return u&&t.effectivePlayingAsset?u.findAssetIndex(t.effectivePlayingAsset):-1},get scheduleItem(){return l()}};return this.manager={get events(){var A;return((A=t.schedule)==null||(A=A.events)==null?void 0:A.slice(0))||[]},get schedule(){var A;return((A=t.schedule)==null||(A=A.items)==null?void 0:A.slice(0))||[]},get interstitialPlayer(){return l()?h:null},get playerQueue(){return t.playerQueue.slice(0)},get bufferingAsset(){return t.bufferingAsset},get bufferingItem(){return e()},get bufferingIndex(){const A=e();return t.findItemIndex(A)},get playingAsset(){return t.effectivePlayingAsset},get playingItem(){return t.effectivePlayingItem},get playingIndex(){const A=t.effectivePlayingItem;return t.findItemIndex(A)},primary:{get bufferedEnd(){return r()},get currentTime(){const A=t.timelinePos;return A>0?A:0},set currentTime(A){c(A,"primary")},get duration(){return a("primary")},get seekableStart(){var A;return((A=t.primaryDetails)==null?void 0:A.fragmentStart)||0}},integrated:{get bufferedEnd(){return i(e(),"integrated",t.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return i(t.effectivePlayingItem,"integrated",t.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(A){c(A,"integrated")},get duration(){return a("integrated")},get seekableStart(){var A;return n(((A=t.primaryDetails)==null?void 0:A.fragmentStart)||0,"integrated")}},skip:()=>{const A=t.effectivePlayingItem,u=A?.event;if(u&&!u.restrictions.skip){const d=t.findItemIndex(A);if(u.appendInPlace){const f=A.playout.start+A.event.duration;c(f+.001,"playout")}else t.advanceAfterAssetEnded(u,d,1/0)}}}}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){var t;const e=this.playingItem,s=(t=this.schedule)==null?void 0:t.items;return!this.playbackStarted||!e||!s?!1:this.findItemIndex(e)===s.length-1}get playbackStarted(){return this.effectivePlayingItem!==null}get currentTime(){var t,e;if(this.mediaSelection===null)return;const s=this.waitingItem||this.playingItem;if(this.isInterstitial(s)&&!s.event.appendInPlace)return;let i=this.media;!i&&(t=this.bufferingItem)!=null&&(t=t.event)!=null&&t.appendInPlace&&(i=this.primaryMedia);const n=(e=i)==null?void 0:e.currentTime;if(!(n===void 0||!K(n)))return n}get primaryMedia(){var t;return this.media||((t=this.detachedData)==null?void 0:t.media)||null}isInterstitial(t){return!!(t!=null&&t.event)}retreiveMediaSource(t,e){const s=this.getAssetPlayer(t);s&&this.transferMediaFromPlayer(s,e)}transferMediaFromPlayer(t,e){const s=t.interstitial.appendInPlace,i=t.media;if(s&&i===this.primaryMedia){if(this.bufferingAsset=null,(!e||this.isInterstitial(e)&&!e.event.appendInPlace)&&e&&i){this.detachedData={media:i};return}const n=t.transferMedia();this.log(`transfer MediaSource from ${t} ${at(n)}`),this.detachedData=n}else e&&i&&(this.shouldPlay||(this.shouldPlay=!i.paused))}transferMediaTo(t,e){var s,i;if(t.media===e)return;let n=null;const r=this.hls,a=t!==r,c=a&&t.interstitial.appendInPlace,l=(s=this.detachedData)==null?void 0:s.mediaSource;let h;if(r.media)c&&(n=r.transferMedia(),this.detachedData=n),h="Primary";else if(l){const f=this.getBufferingPlayer();f?(n=f.transferMedia(),h=`${f}`):h="detached MediaSource"}else h="detached media";if(!n){if(l)n=this.detachedData,this.log(`using detachedData: MediaSource ${at(n)}`);else if(!this.detachedData||r.media===e){const f=this.playerQueue;f.length>1&&f.forEach(g=>{if(a&&g.interstitial.appendInPlace!==c){const m=g.interstitial;this.clearInterstitial(g.interstitial,null),m.appendInPlace=!1,m.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${m}`)}}),this.hls.detachMedia(),this.detachedData={media:e}}}const A=n&&"mediaSource"in n&&((i=n.mediaSource)==null?void 0:i.readyState)!=="closed",u=A&&n?n:e;this.log(`${A?"transfering MediaSource":"attaching media"} to ${a?t:"Primary"} from ${h} (media.currentTime: ${e.currentTime})`);const d=this.schedule;if(u===n&&d){const f=a&&t.assetId===d.assetIdAtEnd;u.overrides={duration:d.duration,endOfStream:!a||f,cueRemoval:!a}}t.attachMedia(u)}onInterstitialCueEnter(){this.onTimeupdate()}checkStart(){const t=this.schedule,e=t?.events;if(!e||this.playbackDisabled||!this.media)return;this.bufferedPos===-1&&(this.bufferedPos=0);const s=this.timelinePos,i=this.effectivePlayingItem;if(s===-1){const n=this.hls.startPosition;if(this.log(hi("checkStart",n)),this.timelinePos=n,e.length&&e[0].cue.pre){const r=t.findEventIndex(e[0].identifier);this.setSchedulePosition(r)}else if(n>=0||!this.primaryLive){const r=this.timelinePos=n>0?n:0,a=t.findItemIndexAtTime(r);this.setSchedulePosition(a)}}else if(i&&!this.playingItem){const n=t.findItemIndex(i);this.setSchedulePosition(n)}}advanceAssetBuffering(t,e){const s=t.event,i=s.findAssetIndex(e),n=vn(s,i);if(!s.isAssetPastPlayoutLimit(n))this.bufferedToEvent(t,n);else if(this.schedule){var r;const a=(r=this.schedule.items)==null?void 0:r[this.findItemIndex(t)+1];a&&this.bufferedToItem(a)}}advanceAfterAssetEnded(t,e,s){const i=vn(t,s);if(t.isAssetPastPlayoutLimit(i)){if(this.schedule){const n=this.schedule.items;if(n){const r=e+1,a=n.length;if(r>=a){this.setSchedulePosition(-1);return}const c=t.resumeTime;this.timelinePos<c&&(this.log(hi("advanceAfterAssetEnded",c)),this.timelinePos=c,t.appendInPlace&&this.advanceInPlace(c),this.checkBuffer(this.bufferedPos<c)),this.setSchedulePosition(r)}}}else{if(t.appendInPlace){const n=t.assetList[i];n&&this.advanceInPlace(n.timelineStart)}this.setSchedulePosition(e,i)}}setScheduleToAssetAtTime(t,e){const s=this.schedule;if(!s)return;const i=e.parentIdentifier,n=s.getEvent(i);if(n){const r=s.findEventIndex(i),a=s.findAssetIndex(n,t);this.advanceAfterAssetEnded(n,r,a-1)}}setSchedulePosition(t,e){var s;const i=(s=this.schedule)==null?void 0:s.items;if(!i||this.playbackDisabled)return;const n=t>=0?i[t]:null;this.log(`setSchedulePosition ${t}, ${e} (${n&&te(n)}) pos: ${this.timelinePos}`);const r=this.waitingItem||this.playingItem,a=this.playingLastItem;if(this.isInterstitial(r)){const h=r.event,A=this.playingAsset,u=A?.identifier,d=u?this.getAssetPlayer(u):null;if(d&&u&&(!this.eventItemsMatch(r,n)||e!==void 0&&u!==h.assetList[e].identifier)){var c;const f=h.findAssetIndex(A);if(this.log(`INTERSTITIAL_ASSET_ENDED ${f+1}/${h.assetList.length} ${As(A)}`),this.endedAsset=A,this.playingAsset=null,this.hls.trigger(y.INTERSTITIAL_ASSET_ENDED,{asset:A,assetListIndex:f,event:h,schedule:i.slice(0),scheduleIndex:t,player:d}),r!==this.playingItem){this.itemsMatch(r,this.playingItem)&&!this.playingAsset&&this.advanceAfterAssetEnded(h,this.findItemIndex(this.playingItem),f);return}this.retreiveMediaSource(u,n),d.media&&!((c=this.detachedData)!=null&&c.mediaSource)&&d.detachMedia()}if(!this.eventItemsMatch(r,n)&&(this.endedItem=r,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${h} ${te(r)}`),h.hasPlayed=!0,this.hls.trigger(y.INTERSTITIAL_ENDED,{event:h,schedule:i.slice(0),scheduleIndex:t}),h.cue.once)){var l;this.updateSchedule();const f=(l=this.schedule)==null?void 0:l.items;if(n&&f){const g=this.findItemIndex(n);this.advanceSchedule(g,f,e,r,a)}return}}this.advanceSchedule(t,i,e,r,a)}advanceSchedule(t,e,s,i,n){const r=this.schedule;if(!r)return;const a=e[t]||null,c=this.primaryMedia,l=this.playerQueue;if(l.length&&l.forEach(h=>{const A=h.interstitial,u=r.findEventIndex(A.identifier);(u<t||u>t+1)&&this.clearInterstitial(A,a)}),this.isInterstitial(a)){this.timelinePos=Math.min(Math.max(this.timelinePos,a.start),a.end);const h=a.event;if(s===void 0){s=r.findAssetIndex(h,this.timelinePos);const f=vn(h,s-1);if(h.isAssetPastPlayoutLimit(f)||h.appendInPlace&&this.timelinePos===a.end){this.advanceAfterAssetEnded(h,t,s);return}s=f}const A=this.waitingItem;this.assetsBuffered(a,c)||this.setBufferingItem(a);let u=this.preloadAssets(h,s);if(this.eventItemsMatch(a,A||i)||(this.waitingItem=a,this.log(`INTERSTITIAL_STARTED ${te(a)} ${h.appendInPlace?"append in place":""}`),this.hls.trigger(y.INTERSTITIAL_STARTED,{event:h,schedule:e.slice(0),scheduleIndex:t})),!h.assetListLoaded){this.log(`Waiting for ASSET-LIST to complete loading ${h}`);return}if(h.assetListLoader&&(h.assetListLoader.destroy(),h.assetListLoader=void 0),!c){this.log(`Waiting for attachMedia to start Interstitial ${h}`);return}this.waitingItem=this.endedItem=null,this.playingItem=a;const d=h.assetList[s];if(!d){this.advanceAfterAssetEnded(h,t,s||0);return}if(u||(u=this.getAssetPlayer(d.identifier)),u===null||u.destroyed){const f=h.assetList.length;this.warn(`asset ${s+1}/${f} player destroyed ${h}`),u=this.createAssetPlayer(h,d,s),u.loadSource()}if(!this.eventItemsMatch(a,this.bufferingItem)&&h.appendInPlace&&this.isAssetBuffered(d))return;this.startAssetPlayer(u,s,e,t,c),this.shouldPlay&&wa(u.media)}else a?(this.resumePrimary(a,t,i),this.shouldPlay&&wa(this.hls.media)):n&&this.isInterstitial(i)&&(this.endedItem=null,this.playingItem=i,i.event.appendInPlace||this.attachPrimary(r.durations.primary,null))}get playbackDisabled(){return this.hls.config.enableInterstitialPlayback===!1}get primaryDetails(){var t;return(t=this.mediaSelection)==null?void 0:t.main.details}get primaryLive(){var t;return!!((t=this.primaryDetails)!=null&&t.live)}resumePrimary(t,e,s){var i,n;if(this.playingItem=t,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(t),this.log(`resuming ${te(t)}`),!((i=this.detachedData)!=null&&i.mediaSource)){let a=this.timelinePos;(a<t.start||a>=t.end)&&(a=this.getPrimaryResumption(t,e),this.log(hi("resumePrimary",a)),this.timelinePos=a),this.attachPrimary(a,t)}if(!s)return;const r=(n=this.schedule)==null?void 0:n.items;r&&(this.log(`INTERSTITIALS_PRIMARY_RESUMED ${te(t)}`),this.hls.trigger(y.INTERSTITIALS_PRIMARY_RESUMED,{schedule:r.slice(0),scheduleIndex:e}),this.checkBuffer())}getPrimaryResumption(t,e){const s=t.start;if(this.primaryLive){const i=this.primaryDetails;if(e===0)return this.hls.startPosition;if(i&&(s<i.fragmentStart||s>i.edge))return this.hls.liveSyncPosition||-1}return s}isAssetBuffered(t){const e=this.getAssetPlayer(t.identifier);return e!=null&&e.hls?e.hls.bufferedToEnd:j.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=t.timelineStart+(t.duration||0)}attachPrimary(t,e,s){e?this.setBufferingItem(e):this.bufferingItem=this.playingItem,this.bufferingAsset=null;const i=this.primaryMedia;if(!i)return;const n=this.hls;n.media?this.checkBuffer():(this.transferMediaTo(n,i),s&&this.startLoadingPrimaryAt(t,s)),s||(this.log(hi("attachPrimary",t)),this.timelinePos=t,this.startLoadingPrimaryAt(t,s))}startLoadingPrimaryAt(t,e){var s;const i=this.hls;!i.loadingEnabled||!i.media||Math.abs((((s=i.mainForwardBufferInfo)==null?void 0:s.start)||i.media.currentTime)-t)>.5?i.startLoad(t,e):i.bufferingEnabled||i.resumeBuffering()}onManifestLoading(){var t;this.stopLoad(),(t=this.schedule)==null||t.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(y.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(y.BUFFER_CODECS,this.onBufferCodecs,this)}onLevelUpdated(t,e){if(e.level===-1||!this.schedule)return;const s=this.hls.levels[e.level];if(!s.details)return;const i=it(it({},this.mediaSelection||this.altSelection),{},{main:s});this.mediaSelection=i,this.schedule.parseInterstitialDateRanges(i,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}onAudioTrackUpdated(t,e){const s=this.hls.audioTracks[e.id],i=this.mediaSelection;if(!i){this.altSelection=it(it({},this.altSelection),{},{audio:s});return}const n=it(it({},i),{},{audio:s});this.mediaSelection=n}onSubtitleTrackUpdated(t,e){const s=this.hls.subtitleTracks[e.id],i=this.mediaSelection;if(!i){this.altSelection=it(it({},this.altSelection),{},{subtitles:s});return}const n=it(it({},i),{},{subtitles:s});this.mediaSelection=n}onAudioTrackSwitching(t,e){const s=No(e);this.playerQueue.forEach(({hls:i})=>i&&(i.setAudioOption(e)||i.setAudioOption(s)))}onSubtitleTrackSwitch(t,e){const s=No(e);this.playerQueue.forEach(({hls:i})=>i&&(i.setSubtitleOption(e)||e.id!==-1&&i.setSubtitleOption(s)))}onBufferCodecs(t,e){const s=e.tracks;s&&(this.requiredTracks=s)}onBufferAppended(t,e){this.checkBuffer()}onBufferFlushed(t,e){const s=this.playingItem;if(s&&!this.itemsMatch(s,this.bufferingItem)&&!this.isInterstitial(s)){const i=this.timelinePos;this.bufferedPos=i,this.checkBuffer()}}onBufferedToEnd(t){if(!this.schedule)return;const e=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&e){for(let i=0;i<e.length;i++){const n=e[i];if(n.cue.post){var s;const r=this.schedule.findEventIndex(n.identifier),a=(s=this.schedule.items)==null?void 0:s[r];this.isInterstitial(a)&&this.eventItemsMatch(a,this.bufferingItem)&&this.bufferedToItem(a,0);break}}this.bufferedPos=Number.MAX_VALUE}}onMediaEnded(t){const e=this.playingItem;if(!this.playingLastItem&&e){const s=this.findItemIndex(e);this.setSchedulePosition(s+1)}else this.shouldPlay=!1}updateItem(t,e){var s;const i=(s=this.schedule)==null?void 0:s.items;if(t&&i){const n=this.findItemIndex(t,e);return i[n]||null}return null}trimInPlace(t,e){if(this.isInterstitial(t)&&t.event.appendInPlace&&e.end-t.end>.25){t.event.assetList.forEach((n,r)=>{t.event.isAssetPastPlayoutLimit(r)&&this.clearAssetPlayer(n.identifier,null)});const s=t.end+.25,i=j.bufferInfo(this.primaryMedia,s,0);(i.end>s||(i.nextStart||0)>s)&&(this.log(`trim buffered interstitial ${te(t)} (was ${te(e)})`),this.attachPrimary(s,null,!0),this.flushFrontBuffer(s))}}itemsMatch(t,e){return!!e&&(t===e||t.event&&e.event&&this.eventItemsMatch(t,e)||!t.event&&!e.event&&this.findItemIndex(t)===this.findItemIndex(e))}eventItemsMatch(t,e){var s;return!!e&&(t===e||t.event.identifier===((s=e.event)==null?void 0:s.identifier))}findItemIndex(t,e){return t&&this.schedule?this.schedule.findItemIndex(t,e):-1}updateSchedule(t=!1){var e;const s=this.mediaSelection;s&&((e=this.schedule)==null||e.updateSchedule(s,[],t))}checkBuffer(t){var e;const s=(e=this.schedule)==null?void 0:e.items;if(!s)return;const i=j.bufferInfo(this.primaryMedia,this.timelinePos,0);t&&(this.bufferedPos=this.timelinePos),t||(t=i.len<1),this.updateBufferedPos(i.end,s,t)}updateBufferedPos(t,e,s){const i=this.schedule,n=this.bufferingItem;if(this.bufferedPos>t||!i)return;if(e.length===1&&this.itemsMatch(e[0],n)){this.bufferedPos=t;return}const r=this.playingItem,a=this.findItemIndex(r);let c=i.findItemIndexAtTime(t);if(this.bufferedPos<t){var l;const h=this.findItemIndex(n),A=Math.min(h+1,e.length-1),u=e[A];if((c===-1&&n&&t>=n.end||(l=u.event)!=null&&l.appendInPlace&&t+.01>=u.start)&&(c=A),this.isInterstitial(n)){const d=n.event;if(A-a>1&&d.appendInPlace===!1||d.assetList.length===0&&d.assetListLoader)return}if(this.bufferedPos=t,c>h&&c>a)this.bufferedToItem(u);else{const d=this.primaryDetails;this.primaryLive&&d&&t>d.edge-d.targetduration&&u.start<d.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(u)&&this.preloadAssets(u.event,0)}}else s&&r&&!this.itemsMatch(r,n)&&(c===a?this.bufferedToItem(r):c===a+1&&this.bufferedToItem(e[c]))}assetsBuffered(t,e){return t.event.assetList.length===0?!1:!t.event.assetList.some(i=>{const n=this.getAssetPlayer(i.identifier);return!(n!=null&&n.bufferedInPlaceToEnd(e))})}setBufferingItem(t){const e=this.bufferingItem,s=this.schedule;if(!this.itemsMatch(t,e)&&s){const{items:i,events:n}=s;if(!i||!n)return e;const r=this.isInterstitial(t),a=this.getBufferingPlayer();this.bufferingItem=t,this.bufferedPos=Math.max(t.start,Math.min(t.end,this.timelinePos));const c=a?a.remaining:e?e.end-this.timelinePos:0;if(this.log(`INTERSTITIALS_BUFFERED_TO_BOUNDARY ${te(t)}`+(e?` (${c.toFixed(2)} remaining)`:"")),!this.playbackDisabled)if(r){const l=s.findAssetIndex(t.event,this.bufferedPos);t.event.assetList.forEach((h,A)=>{const u=this.getAssetPlayer(h.identifier);u&&(A===l&&u.loadSource(),u.resumeBuffering())})}else this.hls.resumeBuffering(),this.playerQueue.forEach(l=>l.pauseBuffering());this.hls.trigger(y.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:n.slice(0),schedule:i.slice(0),bufferingIndex:this.findItemIndex(t),playingIndex:this.findItemIndex(this.playingItem)})}else this.bufferingItem!==t&&(this.bufferingItem=t);return e}bufferedToItem(t,e=0){const s=this.setBufferingItem(t);if(!this.playbackDisabled){if(this.isInterstitial(t))this.bufferedToEvent(t,e);else if(s!==null){this.bufferingAsset=null;const i=this.detachedData;i?i.mediaSource?this.attachPrimary(t.start,t,!0):this.preloadPrimary(t):this.preloadPrimary(t)}}}preloadPrimary(t){const e=this.findItemIndex(t),s=this.getPrimaryResumption(t,e);this.startLoadingPrimaryAt(s)}bufferedToEvent(t,e){const s=t.event,i=s.assetList.length===0&&!s.assetListLoader,n=s.cue.once;if(i||!n){const r=this.preloadAssets(s,e);if(r!=null&&r.interstitial.appendInPlace){const a=this.primaryMedia;a&&this.bufferAssetPlayer(r,a)}}}preloadAssets(t,e){const s=t.assetUrl,i=t.assetList.length,n=i===0&&!t.assetListLoader,r=t.cue.once;if(n){const c=t.timelineStart;if(t.appendInPlace){var a;const u=this.playingItem;!this.isInterstitial(u)&&(u==null||(a=u.nextEvent)==null?void 0:a.identifier)===t.identifier&&this.flushFrontBuffer(c+.25)}let l,h=0;if(!this.playingItem&&this.primaryLive&&(h=this.hls.startPosition,h===-1&&(h=this.hls.liveSyncPosition||0)),h&&!(t.cue.pre||t.cue.post)){const u=h-c;u>0&&(l=Math.round(u*1e3)/1e3)}if(this.log(`Load interstitial asset ${e+1}/${s?1:i} ${t}${l?` live-start: ${h} start-offset: ${l}`:""}`),s)return this.createAsset(t,0,0,c,t.duration,s);const A=this.assetListLoader.loadAssetList(t,l);A&&(t.assetListLoader=A)}else if(!r&&i){for(let l=e;l<i;l++){const h=t.assetList[l],A=this.getAssetPlayerQueueIndex(h.identifier);(A===-1||this.playerQueue[A].destroyed)&&!h.error&&this.createAssetPlayer(t,h,l)}const c=t.assetList[e];if(c){const l=this.getAssetPlayer(c.identifier);return l&&l.loadSource(),l}}return null}flushFrontBuffer(t){const e=this.requiredTracks;if(!e)return;this.log(`Removing front buffer starting at ${t}`),Object.keys(e).forEach(i=>{this.hls.trigger(y.BUFFER_FLUSHING,{startOffset:t,endOffset:1/0,type:i})})}getAssetPlayerQueueIndex(t){const e=this.playerQueue;for(let s=0;s<e.length;s++)if(t===e[s].assetId)return s;return-1}getAssetPlayer(t){const e=this.getAssetPlayerQueueIndex(t);return this.playerQueue[e]||null}getBufferingPlayer(){const{playerQueue:t,primaryMedia:e}=this;if(e){for(let s=0;s<t.length;s++)if(t[s].media===e)return t[s]}return null}createAsset(t,e,s,i,n,r){const a={parentIdentifier:t.identifier,identifier:Zg(t,r,e),duration:n,startOffset:s,timelineStart:i,uri:r};return this.createAssetPlayer(t,a,e)}createAssetPlayer(t,e,s){const i=this.hls,n=i.userConfig;let r=n.videoPreference;const a=i.loadLevelObj||i.levels[i.currentLevel];(r||a)&&(r=rt({},r),a.videoCodec&&(r.videoCodec=a.videoCodec),a.videoRange&&(r.allowedVideoRanges=[a.videoRange]));const c=i.audioTracks[i.audioTrack],l=i.subtitleTracks[i.subtitleTrack];let h=0;if(this.primaryLive||t.appendInPlace){const C=this.timelinePos-e.timelineStart;if(C>1){const S=e.duration;S&&C<S&&(h=C)}}const A=e.identifier,u=it(it({},n),{},{maxMaxBufferLength:Math.min(180,i.config.maxMaxBufferLength),autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:i.sessionId,assetPlayerId:A,abrEwmaDefaultEstimate:i.bandwidthEstimate,interstitialsController:void 0,startPosition:h,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:r,audioPreference:c||n.audioPreference,subtitlePreference:l||n.subtitlePreference});t.appendInPlace&&(t.appendInPlaceStarted=!0,e.timelineStart&&(u.timelineOffset=e.timelineStart));const d=u.cmcd;d!=null&&d.sessionId&&d.contentId&&(u.cmcd=rt({},d,{contentId:$s(e.uri)})),this.getAssetPlayer(A)&&this.warn(`Duplicate date range identifier ${t} and asset ${A}`);const f=new sm(this.HlsPlayerClass,u,t,e);this.playerQueue.push(f),t.assetList[s]=e;let g=!0;const m=C=>{if(C.live){var S;const x=new Error(`Interstitials MUST be VOD assets ${t}`),L={fatal:!0,type:V.OTHER_ERROR,details:w.INTERSTITIAL_ASSET_ITEM_ERROR,error:x},B=((S=this.schedule)==null?void 0:S.findEventIndex(t.identifier))||-1;this.handleAssetItemError(L,t,B,s,x.message);return}const v=C.edge-C.fragmentStart,T=e.duration;(g||T===null||v>T)&&(g=!1,this.log(`Interstitial asset "${A}" duration change ${T} > ${v}`),e.duration=v,this.updateSchedule())};f.on(y.LEVEL_UPDATED,(C,{details:S})=>m(S)),f.on(y.LEVEL_PTS_UPDATED,(C,{details:S})=>m(S)),f.on(y.EVENT_CUE_ENTER,()=>this.onInterstitialCueEnter());const E=(C,S)=>{const v=this.getAssetPlayer(A);if(v&&S.tracks){v.off(y.BUFFER_CODECS,E),v.tracks=S.tracks;const T=this.primaryMedia;this.bufferingAsset===v.assetItem&&T&&!v.media&&this.bufferAssetPlayer(v,T)}};f.on(y.BUFFER_CODECS,E);const p=()=>{var C;const S=this.getAssetPlayer(A);if(this.log(`buffered to end of asset ${S}`),!S||!this.schedule)return;const v=this.schedule.findEventIndex(t.identifier),T=(C=this.schedule.items)==null?void 0:C[v];this.isInterstitial(T)&&this.advanceAssetBuffering(T,e)};f.on(y.BUFFERED_TO_END,p);const I=C=>()=>{if(!this.getAssetPlayer(A)||!this.schedule)return;this.shouldPlay=!0;const v=this.schedule.findEventIndex(t.identifier);this.advanceAfterAssetEnded(t,v,C)};return f.once(y.MEDIA_ENDED,I(s)),f.once(y.PLAYOUT_LIMIT_REACHED,I(1/0)),f.on(y.ERROR,(C,S)=>{if(!this.schedule)return;const v=this.getAssetPlayer(A);if(S.details===w.BUFFER_STALLED_ERROR){if(v!=null&&v.appendInPlace){this.handleInPlaceStall(t);return}this.onTimeupdate(),this.checkBuffer(!0);return}this.handleAssetItemError(S,t,this.schedule.findEventIndex(t.identifier),s,`Asset player error ${S.error} ${t}`)}),f.on(y.DESTROYING,()=>{if(!this.getAssetPlayer(A)||!this.schedule)return;const S=new Error(`Asset player destroyed unexpectedly ${A}`),v={fatal:!0,type:V.OTHER_ERROR,details:w.INTERSTITIAL_ASSET_ITEM_ERROR,error:S};this.handleAssetItemError(v,t,this.schedule.findEventIndex(t.identifier),s,S.message)}),this.log(`INTERSTITIAL_ASSET_PLAYER_CREATED ${As(e)}`),this.hls.trigger(y.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:e,assetListIndex:s,event:t,player:f}),f}clearInterstitial(t,e){this.clearAssetPlayers(t,e),t.reset()}clearAssetPlayers(t,e){t.assetList.forEach(s=>{this.clearAssetPlayer(s.identifier,e)})}resetAssetPlayer(t){const e=this.getAssetPlayerQueueIndex(t);if(e!==-1){this.log(`reset asset player "${t}" after error`);const s=this.playerQueue[e];this.transferMediaFromPlayer(s,null),s.resetDetails()}}clearAssetPlayer(t,e){const s=this.getAssetPlayerQueueIndex(t);if(s!==-1){const i=this.playerQueue[s];this.log(`clear ${i} toSegment: ${e&&te(e)}`),this.transferMediaFromPlayer(i,e),this.playerQueue.splice(s,1),i.destroy()}}emptyPlayerQueue(){let t;for(;t=this.playerQueue.pop();)t.destroy();this.playerQueue=[]}startAssetPlayer(t,e,s,i,n){const{interstitial:r,assetItem:a,assetId:c}=t,l=r.assetList.length,h=this.playingAsset;this.endedAsset=null,this.playingAsset=a,(!h||h.identifier!==c)&&(h&&(this.clearAssetPlayer(h.identifier,s[i]),delete h.error),this.log(`INTERSTITIAL_ASSET_STARTED ${e+1}/${l} ${As(a)}`),this.hls.trigger(y.INTERSTITIAL_ASSET_STARTED,{asset:a,assetListIndex:e,event:r,schedule:s.slice(0),scheduleIndex:i,player:t})),this.bufferAssetPlayer(t,n)}bufferAssetPlayer(t,e){var s,i;if(!this.schedule)return;const{interstitial:n,assetItem:r}=t,a=this.schedule.findEventIndex(n.identifier),c=(s=this.schedule.items)==null?void 0:s[a];if(!c)return;t.loadSource(),this.setBufferingItem(c),this.bufferingAsset=r;const l=this.getBufferingPlayer();if(l===t)return;const h=n.appendInPlace;if(h&&l?.interstitial.appendInPlace===!1)return;const A=l?.tracks||((i=this.detachedData)==null?void 0:i.tracks)||this.requiredTracks;if(h&&r!==this.playingAsset){if(!t.tracks){this.log(`Waiting for track info before buffering ${t}`);return}if(A&&!Ql(A,t.tracks)){const u=new Error(`Asset ${As(r)} SourceBuffer tracks ('${Object.keys(t.tracks)}') are not compatible with primary content tracks ('${Object.keys(A)}')`),d={fatal:!0,type:V.OTHER_ERROR,details:w.INTERSTITIAL_ASSET_ITEM_ERROR,error:u},f=n.findAssetIndex(r);this.handleAssetItemError(d,n,a,f,u.message);return}}this.transferMediaTo(t,e)}handleInPlaceStall(t){const e=this.schedule,s=this.primaryMedia;if(!e||!s)return;const i=s.currentTime,n=e.findAssetIndex(t,i),r=t.assetList[n];if(r){const a=this.getAssetPlayer(r.identifier);if(a){const c=a.currentTime||i-r.timelineStart,l=a.duration-c;if(this.warn(`Stalled at ${c} of ${c+l} in ${a} ${t} (media.currentTime: ${i})`),c&&(l/s.playbackRate<.5||a.bufferedInPlaceToEnd(s))&&a.hls){const h=e.findEventIndex(t.identifier);this.advanceAfterAssetEnded(t,h,n)}}}}advanceInPlace(t){const e=this.primaryMedia;e&&e.currentTime<t&&(e.currentTime=t)}handleAssetItemError(t,e,s,i,n){if(t.details===w.BUFFER_STALLED_ERROR)return;const r=e.assetList[i]||null;if(this.warn(`INTERSTITIAL_ASSET_ERROR ${r&&As(r)} ${t.error}`),!this.schedule)return;const a=r?.identifier||"",c=this.getAssetPlayerQueueIndex(a),l=this.playerQueue[c]||null,h=this.schedule.items,A=rt({},t,{fatal:!1,errorAction:ms(!0),asset:r,assetListIndex:i,event:e,schedule:h,scheduleIndex:s,player:l});if(this.hls.trigger(y.INTERSTITIAL_ASSET_ERROR,A),!t.fatal)return;const u=this.playingAsset,d=this.bufferingAsset,f=new Error(n);if(r&&(this.clearAssetPlayer(a,null),r.error=f),!e.assetList.some(g=>!g.error))e.error=f;else for(let g=i;g<e.assetList.length;g++)this.resetAssetPlayer(e.assetList[g].identifier);this.updateSchedule(!0),e.error?this.primaryFallback(e):u&&u.identifier===a?this.advanceAfterAssetEnded(e,s,i):d&&d.identifier===a&&this.isInterstitial(this.bufferingItem)&&this.advanceAssetBuffering(this.bufferingItem,d)}primaryFallback(t){const e=t.timelineStart,s=this.effectivePlayingItem;let i=this.timelinePos;if(s){this.log(`Fallback to primary from event "${t.identifier}" start: ${e} pos: ${i} playing: ${te(s)} error: ${t.error}`),i===-1&&(i=this.hls.startPosition);const r=this.updateItem(s,i);this.itemsMatch(s,r)&&this.clearInterstitial(t,null),t.appendInPlace&&(this.attachPrimary(e,null),this.flushFrontBuffer(e))}else if(i===-1){this.checkStart();return}if(!this.schedule)return;const n=this.schedule.findItemIndexAtTime(i);this.setSchedulePosition(n)}onAssetListLoaded(t,e){var s,i;const n=e.event,r=n.identifier,a=e.assetListResponse.ASSETS;if(!((s=this.schedule)!=null&&s.hasEvent(r)))return;const c=n.timelineStart,l=n.duration;let h=0;a.forEach((g,m)=>{const E=parseFloat(g.DURATION);this.createAsset(n,m,h,c+h,E,g.URI),h+=E}),n.duration=h,this.log(`Loaded asset-list with duration: ${h} (was: ${l}) ${n}`);const A=this.waitingItem,u=A?.event.identifier===r;this.updateSchedule();const d=(i=this.bufferingItem)==null?void 0:i.event;if(u){var f;const g=this.schedule.findEventIndex(r),m=(f=this.schedule.items)==null?void 0:f[g];if(m){if(!this.playingItem&&this.timelinePos>m.end&&this.schedule.findItemIndexAtTime(this.timelinePos)!==g){n.error=new Error(`Interstitial ${a.length?"no longer within playback range":"asset-list is empty"} ${this.timelinePos} ${n}`),this.log(n.error.message),this.updateSchedule(!0),this.primaryFallback(n);return}this.setBufferingItem(m)}this.setSchedulePosition(g)}else if(d?.identifier===r){const g=n.assetList[0];if(g){const m=this.getAssetPlayer(g.identifier);if(d.appendInPlace){const E=this.primaryMedia;m&&E&&this.bufferAssetPlayer(m,E)}else m&&m.loadSource()}}}onError(t,e){if(this.schedule)switch(e.details){case w.ASSET_LIST_PARSING_ERROR:case w.ASSET_LIST_LOAD_ERROR:case w.ASSET_LIST_LOAD_TIMEOUT:{const s=e.interstitial;s&&(this.updateSchedule(!0),this.primaryFallback(s));break}case w.BUFFER_STALLED_ERROR:{const s=this.endedItem||this.waitingItem||this.playingItem;if(this.isInterstitial(s)&&s.event.appendInPlace){this.handleInPlaceStall(s.event);return}this.log(`Primary player stall @${this.timelinePos} bufferedPos: ${this.bufferedPos}`),this.onTimeupdate(),this.checkBuffer(!0);break}}}}const ka=500;class om extends qr{constructor(t,e,s){super(t,e,s,"subtitle-stream-controller",H.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}registerListeners(){super.registerListeners();const{hls:t}=this;t.on(y.LEVEL_LOADED,this.onLevelLoaded,this),t.on(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.on(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(y.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this)}unregisterListeners(){super.unregisterListeners();const{hls:t}=this;t.off(y.LEVEL_LOADED,this.onLevelLoaded,this),t.off(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.off(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.off(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(y.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(t,e){this.stopLoad(),this.state=P.IDLE,this.setInterval(ka),this.nextLoadPosition=this.lastCurrentTime=t+this.timelineOffset,this.startPosition=e?-1:t,this.tick()}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null}onMediaDetaching(t,e){this.tracksBuffered=[],super.onMediaDetaching(t,e)}onLevelLoaded(t,e){this.mainDetails=e.details}onSubtitleFragProcessed(t,e){const{frag:s,success:i}=e;if(this.fragContextChanged(s)||(dt(s)&&(this.fragPrevious=s),this.state=P.IDLE),!i)return;const n=this.tracksBuffered[this.currentTrackId];if(!n)return;let r;const a=s.start;for(let l=0;l<n.length;l++)if(a>=n[l].start&&a<=n[l].end){r=n[l];break}const c=s.start+s.duration;r?r.end=c:(r={start:a,end:c},n.push(r)),this.fragmentTracker.fragBuffered(s),this.fragBufferedComplete(s,null),this.media&&this.tick()}onBufferFlushing(t,e){const{startOffset:s,endOffset:i}=e;if(s===0&&i!==Number.POSITIVE_INFINITY){const n=i-1;if(n<=0)return;e.endOffsetSubtitles=Math.max(0,n),this.tracksBuffered.forEach(r=>{for(let a=0;a<r.length;){if(r[a].end<=n){r.shift();continue}else if(r[a].start<n)r[a].start=n;else break;a++}}),this.fragmentTracker.removeFragmentsInRange(s,n,H.SUBTITLE)}}onError(t,e){const s=e.frag;s?.type===H.SUBTITLE&&(e.details===w.FRAG_GAP&&this.fragmentTracker.fragBuffered(s,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==P.STOPPED&&(this.state=P.IDLE))}onSubtitleTracksUpdated(t,{subtitleTracks:e}){if(this.levels&&Uc(this.levels,e)){this.levels=e.map(s=>new Ws(s));return}this.tracksBuffered=[],this.levels=e.map(s=>{const i=new Ws(s);return this.tracksBuffered[i.id]=[],i}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,H.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(t,e){var s;if(this.currentTrackId=e.id,!((s=this.levels)!=null&&s.length)||this.currentTrackId===-1){this.clearInterval();return}const i=this.levels[this.currentTrackId];i!=null&&i.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,i&&this.state!==P.STOPPED&&this.setInterval(ka)}onSubtitleTrackLoaded(t,e){var s;const{currentTrackId:i,levels:n}=this,{details:r,id:a}=e;if(!n){this.warn(`Subtitle tracks were reset while loading level ${a}`);return}const c=n[a];if(a>=n.length||!c)return;this.log(`Subtitle track ${a} loaded [${r.startSN},${r.endSN}]${r.lastPartSn?`[part-${r.lastPartSn}-${r.lastPartIndex}]`:""},duration:${r.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let l=0;if(r.live||(s=c.details)!=null&&s.live){if(r.deltaUpdateFailed)return;const A=this.mainDetails;if(!A){this.startFragRequested=!1;return}const u=A.fragments[0];if(!c.details)r.hasProgramDateTime&&A.hasProgramDateTime?(Zi(r,A),l=r.fragmentStart):u&&(l=u.start,dr(r,l));else{var h;l=this.alignPlaylists(r,c.details,(h=this.levelLastLoaded)==null?void 0:h.details),l===0&&u&&(l=u.start,dr(r,l))}A&&!this.startFragRequested&&this.setStartPosition(A,l)}c.details=r,this.levelLastLoaded=c,a===i&&(this.hls.trigger(y.SUBTITLE_TRACK_UPDATED,{details:r,id:a,groupId:e.groupId}),this.tick(),r.live&&!this.fragCurrent&&this.media&&this.state===P.IDLE&&(We(null,r.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),c.details=void 0)))}_handleFragmentLoadComplete(t){const{frag:e,payload:s}=t,i=e.decryptdata,n=this.hls;if(!this.fragContextChanged(e)&&s&&s.byteLength>0&&i!=null&&i.key&&i.iv&&ps(i.method)){const r=performance.now();this.decrypter.decrypt(new Uint8Array(s),i.key.buffer,i.iv.buffer,Vr(i.method)).catch(a=>{throw n.trigger(y.ERROR,{type:V.MEDIA_ERROR,details:w.FRAG_DECRYPT_ERROR,fatal:!1,error:a,reason:a.message,frag:e}),a}).then(a=>{const c=performance.now();n.trigger(y.FRAG_DECRYPTED,{frag:e,payload:a,stats:{tstart:r,tdecrypt:c}})}).catch(a=>{this.warn(`${a.name}: ${a.message}`),this.state=P.IDLE})}}doTick(){if(!this.media){this.state=P.IDLE;return}if(this.state===P.IDLE){const{currentTrackId:t,levels:e}=this,s=e?.[t];if(!s||!e.length||!s.details||this.waitForLive(s))return;const{config:i}=this,n=this.getLoadPosition(),r=j.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],n,i.maxBufferHole),{end:a,len:c}=r,l=s.details,h=this.hls.maxBufferLength+l.levelTargetDuration;if(c>h)return;const A=l.fragments,u=A.length,d=l.edge;let f=null;const g=this.fragPrevious;if(a<d){const p=i.maxFragLookUpTolerance,I=a>d-p?0:p;f=We(g,A,Math.max(A[0].start,a),I),!f&&g&&g.start<A[0].start&&(f=A[0])}else f=A[u-1];if(f=this.filterReplacedPrimary(f,s.details),!f)return;const m=f.sn-l.startSN,E=A[m-1];if(E&&E.cc===f.cc&&this.fragmentTracker.getState(E)===Et.NOT_LOADED&&(f=E),this.fragmentTracker.getState(f)===Et.NOT_LOADED){const p=this.mapToInitFragWhenRequired(f);p&&this.loadFragment(p,s,a)}}}loadFragment(t,e,s){dt(t)?super.loadFragment(t,e,s):this._loadInitSegment(t,e)}get mediaBufferTimeRanges(){return new am(this.tracksBuffered[this.currentTrackId]||[])}}class am{constructor(t){this.buffered=void 0;const e=(s,i,n)=>{if(i=i>>>0,i>n-1)throw new DOMException(`Failed to execute '${s}' on 'TimeRanges': The index provided (${i}) is greater than the maximum bound (${n})`);return t[i][s]};this.buffered={get length(){return t.length},end(s){return e("end",s,t.length)},start(s){return e("start",s,t.length)}}}}const lm={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},eh=o=>String.fromCharCode(lm[o]||o),se=15,pe=100,cm={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},hm={17:2,18:4,21:6,22:8,23:10,19:13,20:15},Am={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},um={25:2,26:4,29:6,30:8,31:10,27:13,28:15},dm=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class fm{constructor(){this.time=null,this.verboseLevel=0}log(t,e){if(this.verboseLevel>=t){const s=typeof e=="function"?e():e;nt.log(`${this.time} [${t}] ${s}`)}}}const Ne=function(t){const e=[];for(let s=0;s<t.length;s++)e.push(t[s].toString(16));return e};class sh{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(t){const e=["foreground","underline","italics","background","flash"];for(let s=0;s<e.length;s++){const i=e[s];t.hasOwnProperty(i)&&(this[i]=t[i])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(t){return this.foreground===t.foreground&&this.underline===t.underline&&this.italics===t.italics&&this.background===t.background&&this.flash===t.flash}copy(t){this.foreground=t.foreground,this.underline=t.underline,this.italics=t.italics,this.background=t.background,this.flash=t.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class gm{constructor(){this.uchar=" ",this.penState=new sh}reset(){this.uchar=" ",this.penState.reset()}setChar(t,e){this.uchar=t,this.penState.copy(e)}setPenState(t){this.penState.copy(t)}equals(t){return this.uchar===t.uchar&&this.penState.equals(t.penState)}copy(t){this.uchar=t.uchar,this.penState.copy(t.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class mm{constructor(t){this.chars=[],this.pos=0,this.currPenState=new sh,this.cueStartTime=null,this.logger=void 0;for(let e=0;e<pe;e++)this.chars.push(new gm);this.logger=t}equals(t){for(let e=0;e<pe;e++)if(!this.chars[e].equals(t.chars[e]))return!1;return!0}copy(t){for(let e=0;e<pe;e++)this.chars[e].copy(t.chars[e])}isEmpty(){let t=!0;for(let e=0;e<pe;e++)if(!this.chars[e].isEmpty()){t=!1;break}return t}setCursor(t){this.pos!==t&&(this.pos=t),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>pe&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=pe)}moveCursor(t){const e=this.pos+t;if(t>1)for(let s=this.pos+1;s<e+1;s++)this.chars[s].setPenState(this.currPenState);this.setCursor(e)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(t){t>=144&&this.backSpace();const e=eh(t);if(this.pos>=pe){this.logger.log(0,()=>"Cannot insert "+t.toString(16)+" ("+e+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(e,this.currPenState),this.moveCursor(1)}clearFromPos(t){let e;for(e=t;e<pe;e++)this.chars[e].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const t=[];let e=!0;for(let s=0;s<pe;s++){const i=this.chars[s].uchar;i!==" "&&(e=!1),t.push(i)}return e?"":t.join("")}setPenStyles(t){this.currPenState.setStyles(t),this.chars[this.pos].setPenState(this.currPenState)}}class Ln{constructor(t){this.rows=[],this.currRow=se-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let e=0;e<se;e++)this.rows.push(new mm(t));this.logger=t}reset(){for(let t=0;t<se;t++)this.rows[t].clear();this.currRow=se-1}equals(t){let e=!0;for(let s=0;s<se;s++)if(!this.rows[s].equals(t.rows[s])){e=!1;break}return e}copy(t){for(let e=0;e<se;e++)this.rows[e].copy(t.rows[e])}isEmpty(){let t=!0;for(let e=0;e<se;e++)if(!this.rows[e].isEmpty()){t=!1;break}return t}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(t){this.rows[this.currRow].insertChar(t)}setPen(t){this.rows[this.currRow].setPenStyles(t)}moveCursor(t){this.rows[this.currRow].moveCursor(t)}setCursor(t){this.logger.log(2,"setCursor: "+t),this.rows[this.currRow].setCursor(t)}setPAC(t){this.logger.log(2,()=>"pacData = "+at(t));let e=t.row-1;if(this.nrRollUpRows&&e<this.nrRollUpRows-1&&(e=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==e){for(let a=0;a<se;a++)this.rows[a].clear();const n=this.currRow+1-this.nrRollUpRows,r=this.lastOutputScreen;if(r){const a=r.rows[n].cueStartTime,c=this.logger.time;if(a!==null&&c!==null&&a<c)for(let l=0;l<this.nrRollUpRows;l++)this.rows[e-this.nrRollUpRows+l+1].copy(r.rows[n+l])}}this.currRow=e;const s=this.rows[this.currRow];if(t.indent!==null){const n=t.indent,r=Math.max(n-1,0);s.setCursor(t.indent),t.color=s.chars[r].penState.foreground}const i={foreground:t.color,underline:t.underline,italics:t.italics,background:"black",flash:!1};this.setPen(i)}setBkgData(t){this.logger.log(2,()=>"bkgData = "+at(t)),this.backSpace(),this.setPen(t),this.insertChar(32)}setRollUpRows(t){this.nrRollUpRows=t}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const t=this.currRow+1-this.nrRollUpRows,e=this.rows.splice(t,1)[0];e.clear(),this.rows.splice(this.currRow,0,e),this.logger.log(2,"Rolling up")}getDisplayText(t){t=t||!1;const e=[];let s="",i=-1;for(let n=0;n<se;n++){const r=this.rows[n].getTextString();r&&(i=n+1,t?e.push("Row "+i+": '"+r+"'"):e.push(r.trim()))}return e.length>0&&(t?s="["+e.join(" | ")+"]":s=e.join(`
`)),s}getTextAndFormat(){return this.rows}}class _a{constructor(t,e,s){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=t,this.outputFilter=e,this.mode=null,this.verbose=0,this.displayedMemory=new Ln(s),this.nonDisplayedMemory=new Ln(s),this.lastOutputScreen=new Ln(s),this.currRollUpRow=this.displayedMemory.rows[se-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=s}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[se-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(t){this.outputFilter=t}setPAC(t){this.writeScreen.setPAC(t)}setBkgData(t){this.writeScreen.setBkgData(t)}setMode(t){t!==this.mode&&(this.mode=t,this.logger.log(2,()=>"MODE="+t),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=t)}insertChars(t){for(let s=0;s<t.length;s++)this.writeScreen.insertChar(t[s]);const e=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>e+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(t){this.logger.log(2,"RU("+t+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(t)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const t=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=t,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(t){this.logger.log(2,"TO("+t+") - Tab Offset"),this.writeScreen.moveCursor(t)}ccMIDROW(t){const e={flash:!1};if(e.underline=t%2===1,e.italics=t>=46,e.italics)e.foreground="white";else{const s=Math.floor(t/2)-16,i=["white","green","blue","cyan","red","yellow","magenta"];e.foreground=i[s]}this.logger.log(2,"MIDROW: "+at(e)),this.writeScreen.setPen(e)}outputDataUpdate(t=!1){const e=this.logger.time;e!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=e:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,e,this.lastOutputScreen),t&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:e),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(t){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,t,this.displayedMemory),this.cueStartTime=t))}}class Pa{constructor(t,e,s){this.channels=void 0,this.currentChannel=0,this.cmdHistory=Em(),this.logger=void 0;const i=this.logger=new fm;this.channels=[null,new _a(t,e,i),new _a(t+1,s,i)]}getHandler(t){return this.channels[t].getHandler()}setHandler(t,e){this.channels[t].setHandler(e)}addData(t,e){this.logger.time=t;for(let s=0;s<e.length;s+=2){const i=e[s]&127,n=e[s+1]&127;let r=!1,a=null;if(i===0&&n===0)continue;this.logger.log(3,()=>"["+Ne([e[s],e[s+1]])+"] -> ("+Ne([i,n])+")");const c=this.cmdHistory;if(i>=16&&i<=31){if(pm(i,n,c)){Ai(null,null,c),this.logger.log(3,()=>"Repeated command ("+Ne([i,n])+") is dropped");continue}Ai(i,n,this.cmdHistory),r=this.parseCmd(i,n),r||(r=this.parseMidrow(i,n)),r||(r=this.parsePAC(i,n)),r||(r=this.parseBackgroundAttributes(i,n))}else Ai(null,null,c);if(!r&&(a=this.parseChars(i,n),a)){const h=this.currentChannel;h&&h>0?this.channels[h].insertChars(a):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!r&&!a&&this.logger.log(2,()=>"Couldn't parse cleaned data "+Ne([i,n])+" orig: "+Ne([e[s],e[s+1]]))}}parseCmd(t,e){const s=(t===20||t===28||t===21||t===29)&&e>=32&&e<=47,i=(t===23||t===31)&&e>=33&&e<=35;if(!(s||i))return!1;const n=t===20||t===21||t===23?1:2,r=this.channels[n];return t===20||t===21||t===28||t===29?e===32?r.ccRCL():e===33?r.ccBS():e===34?r.ccAOF():e===35?r.ccAON():e===36?r.ccDER():e===37?r.ccRU(2):e===38?r.ccRU(3):e===39?r.ccRU(4):e===40?r.ccFON():e===41?r.ccRDC():e===42?r.ccTR():e===43?r.ccRTD():e===44?r.ccEDM():e===45?r.ccCR():e===46?r.ccENM():e===47&&r.ccEOC():r.ccTO(e-32),this.currentChannel=n,!0}parseMidrow(t,e){let s=0;if((t===17||t===25)&&e>=32&&e<=47){if(t===17?s=1:s=2,s!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const i=this.channels[s];return i?(i.ccMIDROW(e),this.logger.log(3,()=>"MIDROW ("+Ne([t,e])+")"),!0):!1}return!1}parsePAC(t,e){let s;const i=(t>=17&&t<=23||t>=25&&t<=31)&&e>=64&&e<=127,n=(t===16||t===24)&&e>=64&&e<=95;if(!(i||n))return!1;const r=t<=23?1:2;e>=64&&e<=95?s=r===1?cm[t]:Am[t]:s=r===1?hm[t]:um[t];const a=this.channels[r];return a?(a.setPAC(this.interpretPAC(s,e)),this.currentChannel=r,!0):!1}interpretPAC(t,e){let s;const i={color:null,italics:!1,indent:null,underline:!1,row:t};return e>95?s=e-96:s=e-64,i.underline=(s&1)===1,s<=13?i.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(s/2)]:s<=15?(i.italics=!0,i.color="white"):i.indent=Math.floor((s-16)/2)*4,i}parseChars(t,e){let s,i=null,n=null;if(t>=25?(s=2,n=t-8):(s=1,n=t),n>=17&&n<=19){let r;n===17?r=e+80:n===18?r=e+112:r=e+144,this.logger.log(2,()=>"Special char '"+eh(r)+"' in channel "+s),i=[r]}else t>=32&&t<=127&&(i=e===0?[t]:[t,e]);return i&&this.logger.log(3,()=>"Char codes =  "+Ne(i).join(",")),i}parseBackgroundAttributes(t,e){const s=(t===16||t===24)&&e>=32&&e<=47,i=(t===23||t===31)&&e>=45&&e<=47;if(!(s||i))return!1;let n;const r={};t===16||t===24?(n=Math.floor((e-32)/2),r.background=dm[n],e%2===1&&(r.background=r.background+"_semi")):e===45?r.background="transparent":(r.foreground="black",e===47&&(r.underline=!0));const a=t<=23?1:2;return this.channels[a].setBkgData(r),!0}reset(){for(let t=0;t<Object.keys(this.channels).length;t++){const e=this.channels[t];e&&e.reset()}Ai(null,null,this.cmdHistory)}cueSplitAtTime(t){for(let e=0;e<this.channels.length;e++){const s=this.channels[e];s&&s.cueSplitAtTime(t)}}}function Ai(o,t,e){e.a=o,e.b=t}function pm(o,t,e){return e.a===o&&e.b===t}function Em(){return{a:null,b:null}}var ro=(function(){if(zi!=null&&zi.VTTCue)return self.VTTCue;const o=["","lr","rl"],t=["start","middle","end","left","right"];function e(a,c){if(typeof c!="string"||!Array.isArray(a))return!1;const l=c.toLowerCase();return~a.indexOf(l)?l:!1}function s(a){return e(o,a)}function i(a){return e(t,a)}function n(a,...c){let l=1;for(;l<arguments.length;l++){const h=arguments[l];for(const A in h)a[A]=h[A]}return a}function r(a,c,l){const h=this,A={enumerable:!0};h.hasBeenReset=!1;let u="",d=!1,f=a,g=c,m=l,E=null,p="",I=!0,C="auto",S="start",v=50,T="middle",x=50,L="middle";Object.defineProperty(h,"id",n({},A,{get:function(){return u},set:function(B){u=""+B}})),Object.defineProperty(h,"pauseOnExit",n({},A,{get:function(){return d},set:function(B){d=!!B}})),Object.defineProperty(h,"startTime",n({},A,{get:function(){return f},set:function(B){if(typeof B!="number")throw new TypeError("Start time must be set to a number.");f=B,this.hasBeenReset=!0}})),Object.defineProperty(h,"endTime",n({},A,{get:function(){return g},set:function(B){if(typeof B!="number")throw new TypeError("End time must be set to a number.");g=B,this.hasBeenReset=!0}})),Object.defineProperty(h,"text",n({},A,{get:function(){return m},set:function(B){m=""+B,this.hasBeenReset=!0}})),Object.defineProperty(h,"region",n({},A,{get:function(){return E},set:function(B){E=B,this.hasBeenReset=!0}})),Object.defineProperty(h,"vertical",n({},A,{get:function(){return p},set:function(B){const D=s(B);if(D===!1)throw new SyntaxError("An invalid or illegal string was specified.");p=D,this.hasBeenReset=!0}})),Object.defineProperty(h,"snapToLines",n({},A,{get:function(){return I},set:function(B){I=!!B,this.hasBeenReset=!0}})),Object.defineProperty(h,"line",n({},A,{get:function(){return C},set:function(B){if(typeof B!="number"&&B!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");C=B,this.hasBeenReset=!0}})),Object.defineProperty(h,"lineAlign",n({},A,{get:function(){return S},set:function(B){const D=i(B);if(!D)throw new SyntaxError("An invalid or illegal string was specified.");S=D,this.hasBeenReset=!0}})),Object.defineProperty(h,"position",n({},A,{get:function(){return v},set:function(B){if(B<0||B>100)throw new Error("Position must be between 0 and 100.");v=B,this.hasBeenReset=!0}})),Object.defineProperty(h,"positionAlign",n({},A,{get:function(){return T},set:function(B){const D=i(B);if(!D)throw new SyntaxError("An invalid or illegal string was specified.");T=D,this.hasBeenReset=!0}})),Object.defineProperty(h,"size",n({},A,{get:function(){return x},set:function(B){if(B<0||B>100)throw new Error("Size must be between 0 and 100.");x=B,this.hasBeenReset=!0}})),Object.defineProperty(h,"align",n({},A,{get:function(){return L},set:function(B){const D=i(B);if(!D)throw new SyntaxError("An invalid or illegal string was specified.");L=D,this.hasBeenReset=!0}})),h.displayState=void 0}return r.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},r})();class Im{decode(t,e){if(!t)return"";if(typeof t!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(t))}}function ih(o){function t(s,i,n,r){return(s|0)*3600+(i|0)*60+(n|0)+parseFloat(r||0)}const e=o.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return e?parseFloat(e[2])>59?t(e[2],e[3],0,e[4]):t(e[1],e[2],e[3],e[4]):null}class ym{constructor(){this.values=Object.create(null)}set(t,e){!this.get(t)&&e!==""&&(this.values[t]=e)}get(t,e,s){return s?this.has(t)?this.values[t]:e[s]:this.has(t)?this.values[t]:e}has(t){return t in this.values}alt(t,e,s){for(let i=0;i<s.length;++i)if(e===s[i]){this.set(t,e);break}}integer(t,e){/^-?\d+$/.test(e)&&this.set(t,parseInt(e,10))}percent(t,e){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(e)){const s=parseFloat(e);if(s>=0&&s<=100)return this.set(t,s),!0}return!1}}function nh(o,t,e,s){const i=s?o.split(s):[o];for(const n in i){if(typeof i[n]!="string")continue;const r=i[n].split(e);if(r.length!==2)continue;const a=r[0],c=r[1];t(a,c)}}const Cr=new ro(0,0,""),ui=Cr.align==="middle"?"middle":"center";function Cm(o,t,e){const s=o;function i(){const a=ih(o);if(a===null)throw new Error("Malformed timestamp: "+s);return o=o.replace(/^[^\sa-zA-Z-]+/,""),a}function n(a,c){const l=new ym;nh(a,function(u,d){let f;switch(u){case"region":for(let g=e.length-1;g>=0;g--)if(e[g].id===d){l.set(u,e[g].region);break}break;case"vertical":l.alt(u,d,["rl","lr"]);break;case"line":f=d.split(","),l.integer(u,f[0]),l.percent(u,f[0])&&l.set("snapToLines",!1),l.alt(u,f[0],["auto"]),f.length===2&&l.alt("lineAlign",f[1],["start",ui,"end"]);break;case"position":f=d.split(","),l.percent(u,f[0]),f.length===2&&l.alt("positionAlign",f[1],["start",ui,"end","line-left","line-right","auto"]);break;case"size":l.percent(u,d);break;case"align":l.alt(u,d,["start",ui,"end","left","right"]);break}},/:/,/\s/),c.region=l.get("region",null),c.vertical=l.get("vertical","");let h=l.get("line","auto");h==="auto"&&Cr.line===-1&&(h=-1),c.line=h,c.lineAlign=l.get("lineAlign","start"),c.snapToLines=l.get("snapToLines",!0),c.size=l.get("size",100),c.align=l.get("align",ui);let A=l.get("position","auto");A==="auto"&&Cr.position===50&&(A=c.align==="start"||c.align==="left"?0:c.align==="end"||c.align==="right"?100:50),c.position=A}function r(){o=o.replace(/^\s+/,"")}if(r(),t.startTime=i(),r(),o.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+s);o=o.slice(3),r(),t.endTime=i(),r(),n(o,t)}function rh(o){return o.replace(/<br(?: \/)?>/gi,`
`)}class Sm{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new Im,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(t){const e=this;t&&(e.buffer+=e.decoder.decode(t,{stream:!0}));function s(){let n=e.buffer,r=0;for(n=rh(n);r<n.length&&n[r]!=="\r"&&n[r]!==`
`;)++r;const a=n.slice(0,r);return n[r]==="\r"&&++r,n[r]===`
`&&++r,e.buffer=n.slice(r),a}function i(n){nh(n,function(r,a){},/:/)}try{let n="";if(e.state==="INITIAL"){if(!/\r\n|\n/.test(e.buffer))return this;n=s();const a=n.match(/^()?WEBVTT([ \t].*)?$/);if(!(a!=null&&a[0]))throw new Error("Malformed WebVTT signature.");e.state="HEADER"}let r=!1;for(;e.buffer;){if(!/\r\n|\n/.test(e.buffer))return this;switch(r?r=!1:n=s(),e.state){case"HEADER":/:/.test(n)?i(n):n||(e.state="ID");continue;case"NOTE":n||(e.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(n)){e.state="NOTE";break}if(!n)continue;if(e.cue=new ro(0,0,""),e.state="CUE",n.indexOf("-->")===-1){e.cue.id=n;continue}case"CUE":if(!e.cue){e.state="BADCUE";continue}try{Cm(n,e.cue,e.regionList)}catch{e.cue=null,e.state="BADCUE";continue}e.state="CUETEXT";continue;case"CUETEXT":{const a=n.indexOf("-->")!==-1;if(!n||a&&(r=!0)){e.oncue&&e.cue&&e.oncue(e.cue),e.cue=null,e.state="ID";continue}if(e.cue===null)continue;e.cue.text&&(e.cue.text+=`
`),e.cue.text+=n}continue;case"BADCUE":n||(e.state="ID")}}}catch{e.state==="CUETEXT"&&e.cue&&e.oncue&&e.oncue(e.cue),e.cue=null,e.state=e.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){const t=this;try{if((t.cue||t.state==="HEADER")&&(t.buffer+=`

`,t.parse()),t.state==="INITIAL"||t.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(e){t.onparsingerror&&t.onparsingerror(e)}return t.onflush&&t.onflush(),this}}const Tm=/\r\n|\n\r|\n|\r/g,Dn=function(t,e,s=0){return t.slice(s,s+e.length)===e},Bm=function(t){let e=parseInt(t.slice(-3));const s=parseInt(t.slice(-6,-4)),i=parseInt(t.slice(-9,-7)),n=t.length>9?parseInt(t.substring(0,t.indexOf(":"))):0;if(!K(e)||!K(s)||!K(i)||!K(n))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${t}`);return e+=1e3*s,e+=60*1e3*i,e+=3600*1e3*n,e};function oo(o,t,e){return $s(o.toString())+$s(t.toString())+$s(e)}const xm=function(t,e,s){let i=t[e],n=t[i.prevCC];if(!n||!n.new&&i.new){t.ccOffset=t.presentationOffset=i.start,i.new=!1;return}for(;(r=n)!=null&&r.new;){var r;t.ccOffset+=i.start-n.start,i.new=!1,i=n,n=t[i.prevCC]}t.presentationOffset=s};function vm(o,t,e,s,i,n,r){const a=new Sm,c=$t(new Uint8Array(o)).trim().replace(Tm,`
`).split(`
`),l=[],h=t?kf(t.baseTime,t.timescale):0;let A="00:00.000",u=0,d=0,f,g=!0;a.oncue=function(m){const E=e[s];let p=e.ccOffset;const I=(u-h)/9e4;if(E!=null&&E.new&&(d!==void 0?p=e.ccOffset=E.start:xm(e,s,I)),I){if(!t){f=new Error("Missing initPTS for VTT MPEGTS");return}p=I-e.presentationOffset}const C=m.endTime-m.startTime,S=Gt((m.startTime+p-d)*9e4,i*9e4)/9e4;m.startTime=Math.max(S,0),m.endTime=Math.max(S+C,0);const v=m.text.trim();m.text=decodeURIComponent(encodeURIComponent(v)),m.id||(m.id=oo(m.startTime,m.endTime,v)),m.endTime>0&&l.push(m)},a.onparsingerror=function(m){f=m},a.onflush=function(){if(f){r(f);return}n(l)},c.forEach(m=>{if(g)if(Dn(m,"X-TIMESTAMP-MAP=")){g=!1,m.slice(16).split(",").forEach(E=>{Dn(E,"LOCAL:")?A=E.slice(6):Dn(E,"MPEGTS:")&&(u=parseInt(E.slice(7)))});try{d=Bm(A)/1e3}catch(E){f=E}return}else m===""&&(g=!1);a.parse(m+`
`)}),a.flush()}const Rn="stpp.ttml.im1t",oh=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,ah=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,Lm={left:"start",center:"center",right:"end",start:"start",end:"end"};function Fa(o,t,e,s){const i=X(new Uint8Array(o),["mdat"]);if(i.length===0){s(new Error("Could not parse IMSC1 mdat"));return}const n=i.map(a=>$t(a)),r=wf(t.baseTime,1,t.timescale);try{n.forEach(a=>e(Dm(a,r)))}catch(a){s(a)}}function Dm(o,t){const i=new DOMParser().parseFromString(o,"text/xml").getElementsByTagName("tt")[0];if(!i)throw new Error("Invalid ttml");const n={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},r=Object.keys(n).reduce((A,u)=>(A[u]=i.getAttribute(`ttp:${u}`)||n[u],A),{}),a=i.getAttribute("xml:space")!=="preserve",c=Qa(bn(i,"styling","style")),l=Qa(bn(i,"layout","region")),h=bn(i,"body","[begin]");return[].map.call(h,A=>{const u=lh(A,a);if(!u||!A.hasAttribute("begin"))return null;const d=kn(A.getAttribute("begin"),r),f=kn(A.getAttribute("dur"),r);let g=kn(A.getAttribute("end"),r);if(d===null)throw Ma(A);if(g===null){if(f===null)throw Ma(A);g=d+f}const m=new ro(d-t,g-t,u);m.id=oo(m.startTime,m.endTime,m.text);const E=l[A.getAttribute("region")],p=c[A.getAttribute("style")],I=Rm(E,p,c),{textAlign:C}=I;if(C){const S=Lm[C];S&&(m.lineAlign=S),m.align=C}return rt(m,I),m}).filter(A=>A!==null)}function bn(o,t,e){const s=o.getElementsByTagName(t)[0];return s?[].slice.call(s.querySelectorAll(e)):[]}function Qa(o){return o.reduce((t,e)=>{const s=e.getAttribute("xml:id");return s&&(t[s]=e),t},{})}function lh(o,t){return[].slice.call(o.childNodes).reduce((e,s,i)=>{var n;return s.nodeName==="br"&&i?e+`
`:(n=s.childNodes)!=null&&n.length?lh(s,t):t?e+s.textContent.trim().replace(/\s+/g," "):e+s.textContent},"")}function Rm(o,t,e){const s="http://www.w3.org/ns/ttml#styling";let i=null;const n=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],r=o!=null&&o.hasAttribute("style")?o.getAttribute("style"):null;return r&&e.hasOwnProperty(r)&&(i=e[r]),n.reduce((a,c)=>{const l=wn(t,s,c)||wn(o,s,c)||wn(i,s,c);return l&&(a[c]=l),a},{})}function wn(o,t,e){return o&&o.hasAttributeNS(t,e)?o.getAttributeNS(t,e):null}function Ma(o){return new Error(`Could not parse ttml timestamp ${o}`)}function kn(o,t){if(!o)return null;let e=ih(o);return e===null&&(oh.test(o)?e=bm(o,t):ah.test(o)&&(e=wm(o,t))),e}function bm(o,t){const e=oh.exec(o),s=(e[4]|0)+(e[5]|0)/t.subFrameRate;return(e[1]|0)*3600+(e[2]|0)*60+(e[3]|0)+s/t.frameRate}function wm(o,t){const e=ah.exec(o),s=Number(e[1]);switch(e[2]){case"h":return s*3600;case"m":return s*60;case"ms":return s*1e3;case"f":return s/t.frameRate;case"t":return s/t.tickRate}return s}class di{constructor(t,e){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=t,this.trackName=e}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(t,e,s){(this.startTime===null||this.startTime>t)&&(this.startTime=t),this.endTime=e,this.screen=s,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}class km{constructor(t){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Ua(),this.captionsProperties=void 0,this.hls=t,this.config=t.config,this.Cues=t.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},t.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(y.FRAG_LOADING,this.onFragLoading,this),t.on(y.FRAG_LOADED,this.onFragLoaded,this),t.on(y.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),t.on(y.FRAG_DECRYPTED,this.onFragDecrypted,this),t.on(y.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(y.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),t.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:t}=this;t.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.off(y.FRAG_LOADING,this.onFragLoading,this),t.off(y.FRAG_LOADED,this.onFragLoaded,this),t.off(y.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),t.off(y.FRAG_DECRYPTED,this.onFragDecrypted,this),t.off(y.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(y.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),t.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){const t=new di(this,"textTrack1"),e=new di(this,"textTrack2"),s=new di(this,"textTrack3"),i=new di(this,"textTrack4");this.cea608Parser1=new Pa(1,t,e),this.cea608Parser2=new Pa(3,s,i)}addCues(t,e,s,i,n){let r=!1;for(let a=n.length;a--;){const c=n[a],l=_m(c[0],c[1],e,s);if(l>=0&&(c[0]=Math.min(c[0],e),c[1]=Math.max(c[1],s),r=!0,l/(s-e)>.5))return}if(r||n.push([e,s]),this.config.renderTextTracksNatively){const a=this.captionsTracks[t];this.Cues.newCue(a,e,s,i)}else{const a=this.Cues.newCue(null,e,s,i);this.hls.trigger(y.CUES_PARSED,{type:"captions",cues:a,track:t})}}onInitPtsFound(t,{frag:e,id:s,initPTS:i,timescale:n,trackId:r}){const{unparsedVttFrags:a}=this;s===H.MAIN&&(this.initPTS[e.cc]={baseTime:i,timescale:n,trackId:r}),a.length&&(this.unparsedVttFrags=[],a.forEach(c=>{this.initPTS[c.frag.cc]?this.onFragLoaded(y.FRAG_LOADED,c):this.hls.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:c.frag,error:new Error("Subtitle discontinuity domain does not match main")})}))}getExistingTrack(t,e){const{media:s}=this;if(s)for(let i=0;i<s.textTracks.length;i++){const n=s.textTracks[i];if(Oa(n,{name:t,lang:e,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return n}return null}createCaptionsTrack(t){this.config.renderTextTracksNatively?this.createNativeTrack(t):this.createNonNativeTrack(t)}createNativeTrack(t){if(this.captionsTracks[t])return;const{captionsProperties:e,captionsTracks:s,media:i}=this,{label:n,languageCode:r}=e[t],a=this.getExistingTrack(n,r);if(a)s[t]=a,fs(s[t]),zc(s[t],i);else{const c=this.createTextTrack("captions",n,r);c&&(c[t]=!0,s[t]=c)}}createNonNativeTrack(t){if(this.nonNativeCaptionsTracks[t])return;const e=this.captionsProperties[t];if(!e)return;const s=e.label,i={_id:t,label:s,kind:"captions",default:e.media?!!e.media.default:!1,closedCaptions:e.media};this.nonNativeCaptionsTracks[t]=i,this.hls.trigger(y.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[i]})}createTextTrack(t,e,s){const i=this.media;if(i)return i.addTextTrack(t,e,s)}onMediaAttaching(t,e){this.media=e.media,e.mediaSource||this._cleanTracks()}onMediaDetaching(t,e){const s=!!e.transferMedia;if(this.media=null,s)return;const{captionsTracks:i}=this;Object.keys(i).forEach(n=>{fs(i[n]),delete i[n]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Ua(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:t}=this;if(!t)return;const e=t.textTracks;if(e)for(let s=0;s<e.length;s++)fs(e[s])}onSubtitleTracksUpdated(t,e){const s=e.subtitleTracks||[],i=s.some(n=>n.textCodec===Rn);if(this.config.enableWebVTT||i&&this.config.enableIMSC1){if(Uc(this.tracks,s)){this.tracks=s;return}if(this.textTracks=[],this.tracks=s,this.config.renderTextTracksNatively){const r=this.media,a=r?Ui(r.textTracks):null;if(this.tracks.forEach((c,l)=>{let h;if(a){let A=null;for(let u=0;u<a.length;u++)if(a[u]&&Oa(a[u],c)){A=a[u],a[u]=null;break}A&&(h=A)}if(h)fs(h);else{const A=ch(c);h=this.createTextTrack(A,c.name,c.lang),h&&(h.mode="disabled")}h&&this.textTracks.push(h)}),a!=null&&a.length){const c=a.filter(l=>l!==null).map(l=>l.label);c.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${c.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const r=this.tracks.map(a=>({label:a.name,kind:a.type.toLowerCase(),default:a.default,subtitleTrack:a}));this.hls.trigger(y.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:r})}}}onManifestLoaded(t,e){this.config.enableCEA708Captions&&e.captions&&e.captions.forEach(s=>{const i=/(?:CC|SERVICE)([1-4])/.exec(s.instreamId);if(!i)return;const n=`textTrack${i[1]}`,r=this.captionsProperties[n];r&&(r.label=s.name,s.lang&&(r.languageCode=s.lang),r.media=s)})}closedCaptionsForLevel(t){const e=this.hls.levels[t.level];return e?.attrs["CLOSED-CAPTIONS"]}onFragLoading(t,e){if(this.enabled&&e.frag.type===H.MAIN){var s,i;const{cea608Parser1:n,cea608Parser2:r,lastSn:a}=this,{cc:c,sn:l}=e.frag,h=(s=(i=e.part)==null?void 0:i.index)!=null?s:-1;n&&r&&(l!==a+1||l===a&&h!==this.lastPartIndex+1||c!==this.lastCc)&&(n.reset(),r.reset()),this.lastCc=c,this.lastSn=l,this.lastPartIndex=h}}onFragLoaded(t,e){const{frag:s,payload:i}=e;if(s.type===H.SUBTITLE)if(i.byteLength){const n=s.decryptdata,r="stats"in e;if(n==null||!n.encrypted||r){const a=this.tracks[s.level],c=this.vttCCs;c[s.cc]||(c[s.cc]={start:s.start,prevCC:this.prevCC,new:!0},this.prevCC=s.cc),a&&a.textCodec===Rn?this._parseIMSC1(s,i):this._parseVTTs(e)}}else this.hls.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:s,error:new Error("Empty subtitle payload")})}_parseIMSC1(t,e){const s=this.hls;Fa(e,this.initPTS[t.cc],i=>{this._appendCues(i,t.level),s.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:t})},i=>{s.logger.log(`Failed to parse IMSC1: ${i}`),s.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t,error:i})})}_parseVTTs(t){var e;const{frag:s,payload:i}=t,{initPTS:n,unparsedVttFrags:r}=this,a=n.length-1;if(!n[s.cc]&&a===-1){r.push(t);return}const c=this.hls,l=(e=s.initSegment)!=null&&e.data?jt(s.initSegment.data,new Uint8Array(i)).buffer:i;vm(l,this.initPTS[s.cc],this.vttCCs,s.cc,s.start,h=>{this._appendCues(h,s.level),c.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:s})},h=>{const A=h.message==="Missing initPTS for VTT MPEGTS";A?r.push(t):this._fallbackToIMSC1(s,i),c.logger.log(`Failed to parse VTT cue: ${h}`),!(A&&a>s.cc)&&c.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:s,error:h})})}_fallbackToIMSC1(t,e){const s=this.tracks[t.level];s.textCodec||Fa(e,this.initPTS[t.cc],()=>{s.textCodec=Rn,this._parseIMSC1(t,e)},()=>{s.textCodec="wvtt"})}_appendCues(t,e){const s=this.hls;if(this.config.renderTextTracksNatively){const i=this.textTracks[e];if(!i||i.mode==="disabled")return;t.forEach(n=>Zc(i,n))}else{const i=this.tracks[e];if(!i)return;const n=i.default?"default":"subtitles"+e;s.trigger(y.CUES_PARSED,{type:"subtitles",cues:t,track:n})}}onFragDecrypted(t,e){const{frag:s}=e;s.type===H.SUBTITLE&&this.onFragLoaded(y.FRAG_LOADED,e)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(t,e){if(!this.enabled||!this.config.enableCEA708Captions)return;const{frag:s,samples:i}=e;if(!(s.type===H.MAIN&&this.closedCaptionsForLevel(s)==="NONE"))for(let n=0;n<i.length;n++){const r=i[n].bytes;if(r){this.cea608Parser1||this.initCea608Parsers();const a=this.extractCea608Data(r);this.cea608Parser1.addData(i[n].pts,a[0]),this.cea608Parser2.addData(i[n].pts,a[1])}}}onBufferFlushing(t,{startOffset:e,endOffset:s,endOffsetSubtitles:i,type:n}){const{media:r}=this;if(!(!r||r.currentTime<s)){if(!n||n==="video"){const{captionsTracks:a}=this;Object.keys(a).forEach(c=>yr(a[c],e,s))}if(this.config.renderTextTracksNatively&&e===0&&i!==void 0){const{textTracks:a}=this;Object.keys(a).forEach(c=>yr(a[c],e,i))}}}extractCea608Data(t){const e=[[],[]],s=t[0]&31;let i=2;for(let n=0;n<s;n++){const r=t[i++],a=127&t[i++],c=127&t[i++];if(a===0&&c===0)continue;if((4&r)!==0){const h=3&r;(h===0||h===1)&&(e[h].push(a),e[h].push(c))}}return e}}function ch(o){return o.characteristics&&/transcribes-spoken-dialog/gi.test(o.characteristics)&&/describes-music-and-sound/gi.test(o.characteristics)?"captions":"subtitles"}function Oa(o,t){return!!o&&o.kind===ch(t)&&mr(t,o)}function _m(o,t,e,s){return Math.min(t,s)-Math.max(o,e)}function Ua(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}const Pm=/\s/,Fm={newCue(o,t,e,s){const i=[];let n,r,a,c,l;const h=self.VTTCue||self.TextTrackCue;for(let u=0;u<s.rows.length;u++)if(n=s.rows[u],a=!0,c=0,l="",!n.isEmpty()){var A;for(let g=0;g<n.chars.length;g++)Pm.test(n.chars[g].uchar)&&a?c++:(l+=n.chars[g].uchar,a=!1);n.cueStartTime=t,t===e&&(e+=1e-4),c>=16?c--:c++;const d=rh(l.trim()),f=oo(t,e,d);o!=null&&(A=o.cues)!=null&&A.getCueById(f)||(r=new h(t,e,d),r.id=f,r.line=u+1,r.align="left",r.position=10+Math.min(80,Math.floor(c*8/32)*10),i.push(r))}return o&&i.length&&(i.sort((u,d)=>u.line==="auto"||d.line==="auto"?0:u.line>8&&d.line>8?d.line-u.line:u.line-d.line),i.forEach(u=>Zc(o,u))),i}};function Qm(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}const Mm=/(\d+)-(\d+)\/(\d+)/;class Na{constructor(t){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=t.fetchSetup||Gm,this.controller=new self.AbortController,this.stats=new Or}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var t;this.abortInternal(),(t=this.callbacks)!=null&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(t,e,s){const i=this.stats;if(i.loading.start)throw new Error("Loader can only be used once.");i.loading.start=self.performance.now();const n=Om(t,this.controller.signal),r=t.responseType==="arraybuffer",a=r?"byteLength":"length",{maxTimeToFirstByteMs:c,maxLoadTimeMs:l}=e.loadPolicy;this.context=t,this.config=e,this.callbacks=s,this.request=this.fetchSetup(t,n),self.clearTimeout(this.requestTimeout),e.timeout=c&&K(c)?c:l,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(i,t,this.response))},e.timeout),(Xs(this.request)?this.request.then(self.fetch):self.fetch(this.request)).then(A=>{var u;this.response=this.loader=A;const d=Math.max(self.performance.now(),i.loading.start);if(self.clearTimeout(this.requestTimeout),e.timeout=l,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(i,t,this.response))},l-(d-i.loading.start)),!A.ok){const{status:g,statusText:m}=A;throw new Km(m||"fetch, bad network response",g,A)}i.loading.first=d,i.total=Nm(A.headers)||i.total;const f=(u=this.callbacks)==null?void 0:u.onProgress;return f&&K(e.highWaterMark)?this.loadProgressively(A,i,t,e.highWaterMark,f):r?A.arrayBuffer():t.responseType==="json"?A.json():A.text()}).then(A=>{var u,d;const f=this.response;if(!f)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),i.loading.end=Math.max(self.performance.now(),i.loading.first);const g=A[a];g&&(i.loaded=i.total=g);const m={url:f.url,data:A,code:f.status},E=(u=this.callbacks)==null?void 0:u.onProgress;E&&!K(e.highWaterMark)&&E(i,t,A,f),(d=this.callbacks)==null||d.onSuccess(m,i,t,f)}).catch(A=>{var u;if(self.clearTimeout(this.requestTimeout),i.aborted)return;const d=A&&A.code||0,f=A?A.message:null;(u=this.callbacks)==null||u.onError({code:d,text:f},t,A?A.details:null,i)})}getCacheAge(){let t=null;if(this.response){const e=this.response.headers.get("age");t=e?parseFloat(e):null}return t}getResponseHeader(t){return this.response?this.response.headers.get(t):null}loadProgressively(t,e,s,i=0,n){const r=new Ic,a=t.body.getReader(),c=()=>a.read().then(l=>{if(l.done)return r.dataLength&&n(e,s,r.flush().buffer,t),Promise.resolve(new ArrayBuffer(0));const h=l.value,A=h.length;return e.loaded+=A,A<i||r.dataLength?(r.push(h),r.dataLength>=i&&n(e,s,r.flush().buffer,t)):n(e,s,h.buffer,t),c()}).catch(()=>Promise.reject());return c()}}function Om(o,t){const e={method:"GET",mode:"cors",credentials:"same-origin",signal:t,headers:new self.Headers(rt({},o.headers))};return o.rangeEnd&&e.headers.set("Range","bytes="+o.rangeStart+"-"+String(o.rangeEnd-1)),e}function Um(o){const t=Mm.exec(o);if(t)return parseInt(t[2])-parseInt(t[1])+1}function Nm(o){const t=o.get("Content-Range");if(t){const s=Um(t);if(K(s))return s}const e=o.get("Content-Length");if(e)return parseInt(e)}function Gm(o,t){return new self.Request(o.url,t)}class Km extends Error{constructor(t,e,s){super(t),this.code=void 0,this.details=void 0,this.code=e,this.details=s}}const $m=/^age:\s*[\d.]+\s*$/im;class hh{constructor(t){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=t&&t.xhrSetup||null,this.stats=new Or,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const t=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),t&&(t.onreadystatechange=null,t.onprogress=null,t.readyState!==4&&(this.stats.aborted=!0,t.abort()))}abort(){var t;this.abortInternal(),(t=this.callbacks)!=null&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(t,e,s){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=t,this.config=e,this.callbacks=s,this.loadInternal()}loadInternal(){const{config:t,context:e}=this;if(!t||!e)return;const s=this.loader=new self.XMLHttpRequest,i=this.stats;i.loading.first=0,i.loaded=0,i.aborted=!1;const n=this.xhrSetup;n?Promise.resolve().then(()=>{if(!(this.loader!==s||this.stats.aborted))return n(s,e.url)}).catch(r=>{if(!(this.loader!==s||this.stats.aborted))return s.open("GET",e.url,!0),n(s,e.url)}).then(()=>{this.loader!==s||this.stats.aborted||this.openAndSendXhr(s,e,t)}).catch(r=>{var a;(a=this.callbacks)==null||a.onError({code:s.status,text:r.message},e,s,i)}):this.openAndSendXhr(s,e,t)}openAndSendXhr(t,e,s){t.readyState||t.open("GET",e.url,!0);const i=e.headers,{maxTimeToFirstByteMs:n,maxLoadTimeMs:r}=s.loadPolicy;if(i)for(const a in i)t.setRequestHeader(a,i[a]);e.rangeEnd&&t.setRequestHeader("Range","bytes="+e.rangeStart+"-"+(e.rangeEnd-1)),t.onreadystatechange=this.readystatechange.bind(this),t.onprogress=this.loadprogress.bind(this),t.responseType=e.responseType,self.clearTimeout(this.requestTimeout),s.timeout=n&&K(n)?n:r,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),s.timeout),t.send()}readystatechange(){const{context:t,loader:e,stats:s}=this;if(!t||!e)return;const i=e.readyState,n=this.config;if(!s.aborted&&i>=2&&(s.loading.first===0&&(s.loading.first=Math.max(self.performance.now(),s.loading.start),n.timeout!==n.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),n.timeout=n.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),n.loadPolicy.maxLoadTimeMs-(s.loading.first-s.loading.start)))),i===4)){self.clearTimeout(this.requestTimeout),e.onreadystatechange=null,e.onprogress=null;const l=e.status,h=e.responseType==="text"?e.responseText:null;if(l>=200&&l<300){const f=h??e.response;if(f!=null){var r,a;s.loading.end=Math.max(self.performance.now(),s.loading.first);const g=e.responseType==="arraybuffer"?f.byteLength:f.length;s.loaded=s.total=g,s.bwEstimate=s.total*8e3/(s.loading.end-s.loading.first);const m=(r=this.callbacks)==null?void 0:r.onProgress;m&&m(s,t,f,e);const E={url:e.responseURL,data:f,code:l};(a=this.callbacks)==null||a.onSuccess(E,s,t,e);return}}const A=n.loadPolicy.errorRetry,u=s.retry,d={url:t.url,data:void 0,code:l};if(ji(A,u,!1,d))this.retry(A);else{var c;nt.error(`${l} while loading ${t.url}`),(c=this.callbacks)==null||c.onError({code:l,text:e.statusText},t,e,s)}}}loadtimeout(){if(!this.config)return;const t=this.config.loadPolicy.timeoutRetry,e=this.stats.retry;if(ji(t,e,!0))this.retry(t);else{var s;nt.warn(`timeout while loading ${(s=this.context)==null?void 0:s.url}`);const i=this.callbacks;i&&(this.abortInternal(),i.onTimeout(this.stats,this.context,this.loader))}}retry(t){const{context:e,stats:s}=this;this.retryDelay=Kr(t,s.retry),s.retry++,nt.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${e?.url}, retrying ${s.retry}/${t.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(t){const e=this.stats;e.loaded=t.loaded,t.lengthComputable&&(e.total=t.total)}getCacheAge(){let t=null;if(this.loader&&$m.test(this.loader.getAllResponseHeaders())){const e=this.loader.getResponseHeader("age");t=e?parseFloat(e):null}return t}getResponseHeader(t){return this.loader&&new RegExp(`^${t}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(t):null}}const Hm={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},Vm=it(it({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,startOnSegmentBoundary:!1,maxBufferSize:60*1e3*1e3,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncMode:"edge",liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:hh,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:sd,bufferController:qf,capLevelController:so,errorController:ad,fpsController:Wg,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:lc,requireKeySystemAccessOnStart:!1,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,preserveManualLevelOnError:!1,certLoadPolicy:{default:Hm},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},Ym()),{},{subtitleStreamController:om,subtitleTrackController:Xg,timelineController:km,audioStreamController:$f,audioTrackController:Hf,emeController:Es,cmcdController:Hg,contentSteeringController:Yg,interstitialsController:rm});function Ym(){return{cueHandler:Fm,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function qm(o,t,e){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(t.liveMaxLatencyDurationCount!==void 0&&(t.liveSyncDurationCount===void 0||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(t.liveMaxLatencyDuration!==void 0&&(t.liveSyncDuration===void 0||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const s=Sr(o),i=["manifest","level","frag"],n=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return i.forEach(r=>{const a=`${r==="level"?"playlist":r}LoadPolicy`,c=t[a]===void 0,l=[];n.forEach(h=>{const A=`${r}Loading${h}`,u=t[A];if(u!==void 0&&c){l.push(A);const d=s[a].default;switch(t[a]={default:d},h){case"TimeOut":d.maxLoadTimeMs=u,d.maxTimeToFirstByteMs=u;break;case"MaxRetry":d.errorRetry.maxNumRetry=u,d.timeoutRetry.maxNumRetry=u;break;case"RetryDelay":d.errorRetry.retryDelayMs=u,d.timeoutRetry.retryDelayMs=u;break;case"MaxRetryTimeout":d.errorRetry.maxRetryDelayMs=u,d.timeoutRetry.maxRetryDelayMs=u;break}}}),l.length&&e.warn(`hls.js config: "${l.join('", "')}" setting(s) are deprecated, use "${a}": ${at(t[a])}`)}),it(it({},s),t)}function Sr(o){return o&&typeof o=="object"?Array.isArray(o)?o.map(Sr):Object.keys(o).reduce((t,e)=>(t[e]=Sr(o[e]),t),{}):o}function Wm(o,t){const e=o.loader;e!==Na&&e!==hh?(t.log("[config]: Custom loader detected, cannot enable progressive streaming"),o.progressive=!1):Qm()&&(o.loader=Na,o.progressive=!0,o.enableSoftwareAES=!0,t.log("[config]: Progressive streaming enabled, using FetchLoader"))}const Ni=2,Jm=.1,jm=.05,Xm=100;class zm extends ic{constructor(t,e){super("gap-controller",t.logger),this.hls=void 0,this.fragmentTracker=void 0,this.media=null,this.mediaSource=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.buffered={},this.lastCurrentTime=0,this.ended=0,this.waiting=0,this.onMediaPlaying=()=>{this.ended=0,this.waiting=0},this.onMediaWaiting=()=>{var s;(s=this.media)!=null&&s.seeking||(this.waiting=self.performance.now(),this.tick())},this.onMediaEnded=()=>{if(this.hls){var s;this.ended=((s=this.media)==null?void 0:s.currentTime)||1,this.hls.trigger(y.MEDIA_ENDED,{stalled:!1})}},this.hls=t,this.fragmentTracker=e,this.registerListeners()}registerListeners(){const{hls:t}=this;t&&(t.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(y.BUFFER_APPENDED,this.onBufferAppended,this))}unregisterListeners(){const{hls:t}=this;t&&(t.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(y.BUFFER_APPENDED,this.onBufferAppended,this))}destroy(){super.destroy(),this.unregisterListeners(),this.media=this.hls=this.fragmentTracker=null,this.mediaSource=void 0}onMediaAttached(t,e){this.setInterval(Xm),this.mediaSource=e.mediaSource;const s=this.media=e.media;_t(s,"playing",this.onMediaPlaying),_t(s,"waiting",this.onMediaWaiting),_t(s,"ended",this.onMediaEnded)}onMediaDetaching(t,e){this.clearInterval();const{media:s}=this;s&&(Ot(s,"playing",this.onMediaPlaying),Ot(s,"waiting",this.onMediaWaiting),Ot(s,"ended",this.onMediaEnded),this.media=null),this.mediaSource=void 0}onBufferAppended(t,e){this.buffered=e.timeRanges}get hasBuffered(){return Object.keys(this.buffered).length>0}tick(){var t;if(!((t=this.media)!=null&&t.readyState)||!this.hasBuffered)return;const e=this.media.currentTime;this.poll(e,this.lastCurrentTime),this.lastCurrentTime=e}poll(t,e){var s,i;const n=(s=this.hls)==null?void 0:s.config;if(!n)return;const r=this.media;if(!r)return;const{seeking:a}=r,c=this.seeking&&!a,l=!this.seeking&&a,h=r.paused&&!a||r.ended||r.playbackRate===0;if(this.seeking=a,t!==e){e&&(this.ended=0),this.moved=!0,a||(this.nudgeRetry=0,n.nudgeOnVideoHole&&!h&&t>e&&this.nudgeOnVideoHole(t,e)),this.waiting===0&&this.stallResolved(t);return}if(l||c){c&&this.stallResolved(t);return}if(h){this.nudgeRetry=0,this.stallResolved(t),!this.ended&&r.ended&&this.hls&&(this.ended=t||1,this.hls.trigger(y.MEDIA_ENDED,{stalled:!1}));return}if(!j.getBuffered(r).length){this.nudgeRetry=0;return}const A=j.bufferInfo(r,t,0),u=A.nextStart||0,d=this.fragmentTracker;if(a&&d&&this.hls){const v=Ga(this.hls.inFlightFragments,t),T=A.len>Ni,x=!u||v||u-t>Ni&&!d.getPartialFragment(t);if(T||x)return;this.moved=!1}const f=(i=this.hls)==null?void 0:i.latestLevelDetails;if(!this.moved&&this.stalled!==null&&d){if(!(A.len>0)&&!u)return;const T=Math.max(u,A.start||0)-t,L=!!(f!=null&&f.live)?f.targetduration*2:Ni,B=fi(t,d);if(T>0&&(T<=L||B)){r.paused||this._trySkipBufferHole(B);return}}const g=n.detectStallWithCurrentTimeMs,m=self.performance.now(),E=this.waiting;let p=this.stalled;if(p===null)if(E>0&&m-E<g)p=this.stalled=E;else{this.stalled=m;return}const I=m-p;if(!a&&(I>=g||E)&&this.hls){var C;if(((C=this.mediaSource)==null?void 0:C.readyState)==="ended"&&!(f!=null&&f.live)&&Math.abs(t-(f?.edge||0))<1){if(this.ended)return;this.ended=t||1,this.hls.trigger(y.MEDIA_ENDED,{stalled:!0});return}if(this._reportStall(A),!this.media||!this.hls)return}const S=j.bufferInfo(r,t,n.maxBufferHole);this._tryFixBufferStall(S,I,t)}stallResolved(t){const e=this.stalled;if(e&&this.hls&&(this.stalled=null,this.stallReported)){const s=self.performance.now()-e;this.log(`playback not stuck anymore @${t}, after ${Math.round(s)}ms`),this.stallReported=!1,this.waiting=0,this.hls.trigger(y.STALL_RESOLVED,{})}}nudgeOnVideoHole(t,e){var s;const i=this.buffered.video;if(this.hls&&this.media&&this.fragmentTracker&&(s=this.buffered.audio)!=null&&s.length&&i&&i.length>1&&t>i.end(0)){const n=j.bufferedInfo(j.timeRangesToArray(this.buffered.audio),t,0);if(n.len>1&&e>=n.start){const r=j.timeRangesToArray(i),a=j.bufferedInfo(r,e,0).bufferedIndex;if(a>-1&&a<r.length-1){const c=j.bufferedInfo(r,t,0).bufferedIndex,l=r[a].end,h=r[a+1].start;if((c===-1||c>a)&&h-l<1&&t-l<2){const A=new Error(`nudging playhead to flush pipeline after video hole. currentTime: ${t} hole: ${l} -> ${h} buffered index: ${c}`);this.warn(A.message),this.media.currentTime+=1e-6;let u=fi(t,this.fragmentTracker);u&&"fragment"in u?u=u.fragment:u||(u=void 0);const d=j.bufferInfo(this.media,t,0);this.hls.trigger(y.ERROR,{type:V.MEDIA_ERROR,details:w.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:A,reason:A.message,frag:u,buffer:d.len,bufferInfo:d})}}}}}_tryFixBufferStall(t,e,s){var i,n;const{fragmentTracker:r,media:a}=this,c=(i=this.hls)==null?void 0:i.config;if(!a||!r||!c)return;const l=(n=this.hls)==null?void 0:n.latestLevelDetails,h=fi(s,r);if((h||l!=null&&l.live&&s<l.fragmentStart)&&(this._trySkipBufferHole(h)||!this.media))return;const A=t.buffered,u=this.adjacentTraversal(t,s);(A&&A.length>1&&t.len>c.maxBufferHole||t.nextStart&&(t.nextStart-s<c.maxBufferHole||u))&&(e>c.highBufferWatchdogPeriod*1e3||this.waiting)&&(this.warn("Trying to nudge playhead over buffer-hole"),this._tryNudgeBuffer(t))}adjacentTraversal(t,e){const s=this.fragmentTracker,i=t.nextStart;if(s&&i){const n=s.getFragAtPos(e,H.MAIN),r=s.getFragAtPos(i,H.MAIN);if(n&&r)return r.sn-n.sn<2}return!1}_reportStall(t){const{hls:e,media:s,stallReported:i,stalled:n}=this;if(!i&&n!==null&&s&&e){this.stallReported=!0;const r=new Error(`Playback stalling at @${s.currentTime} due to low buffer (${at(t)})`);this.warn(r.message),e.trigger(y.ERROR,{type:V.MEDIA_ERROR,details:w.BUFFER_STALLED_ERROR,fatal:!1,error:r,buffer:t.len,bufferInfo:t,stalled:{start:n}})}}_trySkipBufferHole(t){var e;const{fragmentTracker:s,media:i}=this,n=(e=this.hls)==null?void 0:e.config;if(!i||!s||!n)return 0;const r=i.currentTime,a=j.bufferInfo(i,r,0),c=r<a.start?a.start:a.nextStart;if(c&&this.hls){const h=a.len<=n.maxBufferHole,A=a.len>0&&a.len<1&&i.readyState<3,u=c-r;if(u>0&&(h||A)){if(u>n.maxBufferHole){let f=!1;if(r===0){const g=s.getAppendedFrag(0,H.MAIN);g&&c<g.end&&(f=!0)}if(!f&&t){var l;if(!((l=this.hls.loadLevelObj)!=null&&l.details)||Ga(this.hls.inFlightFragments,c))return 0;let m=!1,E=t.end;for(;E<c;){const p=fi(E,s);if(p)E+=p.duration;else{m=!0;break}}if(m)return 0}}const d=Math.max(c+jm,r+Jm);if(this.warn(`skipping hole, adjusting currentTime from ${r} to ${d}`),this.moved=!0,i.currentTime=d,!(t!=null&&t.gap)){const f=new Error(`fragment loaded with buffer holes, seeking from ${r} to ${d}`),g={type:V.MEDIA_ERROR,details:w.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:f,reason:f.message,buffer:a.len,bufferInfo:a};t&&("fragment"in t?g.part=t:g.frag=t),this.hls.trigger(y.ERROR,g)}return d}}return 0}_tryNudgeBuffer(t){const{hls:e,media:s,nudgeRetry:i}=this,n=e?.config;if(!s||!n)return 0;const r=s.currentTime;if(this.nudgeRetry++,i<n.nudgeMaxRetry){const a=r+(i+1)*n.nudgeOffset,c=new Error(`Nudging 'currentTime' from ${r} to ${a}`);this.warn(c.message),s.currentTime=a,e.trigger(y.ERROR,{type:V.MEDIA_ERROR,details:w.BUFFER_NUDGE_ON_STALL,error:c,fatal:!1,buffer:t.len,bufferInfo:t})}else{const a=new Error(`Playhead still not moving while enough data buffered @${r} after ${n.nudgeMaxRetry} nudges`);this.error(a.message),e.trigger(y.ERROR,{type:V.MEDIA_ERROR,details:w.BUFFER_STALLED_ERROR,error:a,fatal:!0,buffer:t.len,bufferInfo:t})}}}function Ga(o,t){const e=Ka(o.main);if(e&&e.start<=t)return e;const s=Ka(o.audio);return s&&s.start<=t?s:null}function Ka(o){if(!o)return null;switch(o.state){case P.IDLE:case P.STOPPED:case P.ENDED:case P.ERROR:return null}return o.frag}function fi(o,t){return t.getAppendedFrag(o,H.MAIN)||t.getPartialFragment(o)}const Zm=.25;function Tr(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function _n(o,t,e,s,i){let n=new o(t,e,"");try{n.value=s,i&&(n.type=i)}catch{n=new o(t,e,at(i?it({type:i},s):s))}return n}const gi=(()=>{const o=Tr();try{o&&new o(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();class tp{constructor(t){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.removeCues=!0,this.assetCue=void 0,this.onEventCueEnter=()=>{this.hls&&this.hls.trigger(y.EVENT_CUE_ENTER,{})},this.hls=t,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=this.onEventCueEnter=null}_registerListeners(){const{hls:t}=this;t&&(t.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(y.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(y.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this))}_unregisterListeners(){const{hls:t}=this;t&&(t.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(y.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(y.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this))}onMediaAttaching(t,e){var s;this.media=e.media,((s=e.overrides)==null?void 0:s.cueRemoval)===!1&&(this.removeCues=!1)}onMediaAttached(){var t;const e=(t=this.hls)==null?void 0:t.latestLevelDetails;e&&this.updateDateRangeCues(e)}onMediaDetaching(t,e){this.media=null,!e.transferMedia&&(this.id3Track&&(this.removeCues&&fs(this.id3Track,this.onEventCueEnter),this.id3Track=null),this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(t){const e=this.getID3Track(t.textTracks);return e.mode="hidden",e}getID3Track(t){if(this.media){for(let e=0;e<t.length;e++){const s=t[e];if(s.kind==="metadata"&&s.label==="id3")return zc(s,this.media),s}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(t,e){if(!this.media||!this.hls)return;const{enableEmsgMetadataCues:s,enableID3MetadataCues:i}=this.hls.config;if(!s&&!i)return;const{samples:n}=e;this.id3Track||(this.id3Track=this.createTrack(this.media));const r=Tr();if(r)for(let a=0;a<n.length;a++){const c=n[a].type;if(c===Kt.emsg&&!s||!i)continue;const l=vc(n[a].data),h=n[a].pts;let A=h+n[a].duration;A>gi&&(A=gi),A-h<=0&&(A=h+Zm);for(let d=0;d<l.length;d++){const f=l[d];if(!Lc(f)){this.updateId3CueEnds(h,c);const g=_n(r,h,A,f,c);g&&this.id3Track.addCue(g)}}}}updateId3CueEnds(t,e){var s;const i=(s=this.id3Track)==null?void 0:s.cues;if(i)for(let n=i.length;n--;){const r=i[n];r.type===e&&r.startTime<t&&r.endTime===gi&&(r.endTime=t)}}onBufferFlushing(t,{startOffset:e,endOffset:s,type:i}){const{id3Track:n,hls:r}=this;if(!r)return;const{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:c}}=r;if(n&&(a||c)){let l;i==="audio"?l=h=>h.type===Kt.audioId3&&c:i==="video"?l=h=>h.type===Kt.emsg&&a:l=h=>h.type===Kt.audioId3&&c||h.type===Kt.emsg&&a,yr(n,e,s,l)}}onLevelUpdated(t,{details:e}){this.updateDateRangeCues(e,!0)}onLevelPtsUpdated(t,e){Math.abs(e.drift)>.01&&this.updateDateRangeCues(e.details)}updateDateRangeCues(t,e){if(!this.hls||!this.media)return;const{assetPlayerId:s,timelineOffset:i,enableDateRangeMetadataCues:n,interstitialsController:r}=this.hls.config;if(!n)return;const a=Tr();if(s&&i&&!r){const{fragmentStart:g,fragmentEnd:m}=t;let E=this.assetCue;E?(E.startTime=g,E.endTime=m):a&&(E=this.assetCue=_n(a,g,m,{assetPlayerId:this.hls.config.assetPlayerId},"hlsjs.interstitial.asset"),E&&(E.id=s,this.id3Track||(this.id3Track=this.createTrack(this.media)),this.id3Track.addCue(E),E.addEventListener("enter",this.onEventCueEnter)))}if(!t.hasProgramDateTime)return;const{id3Track:c}=this,{dateRanges:l}=t,h=Object.keys(l);let A=this.dateRangeCuesAppended;if(c&&e){var u;if((u=c.cues)!=null&&u.length){const g=Object.keys(A).filter(m=>!h.includes(m));for(let m=g.length;m--;){var d;const E=g[m],p=(d=A[E])==null?void 0:d.cues;delete A[E],p&&Object.keys(p).forEach(I=>{const C=p[I];if(C){C.removeEventListener("enter",this.onEventCueEnter);try{c.removeCue(C)}catch{}}})}}else A=this.dateRangeCuesAppended={}}const f=t.fragments[t.fragments.length-1];if(!(h.length===0||!K(f?.programDateTime))){this.id3Track||(this.id3Track=this.createTrack(this.media));for(let g=0;g<h.length;g++){const m=h[g],E=l[m],p=E.startTime,I=A[m],C=I?.cues||{};let S=I?.durationKnown||!1,v=gi;const{duration:T,endDate:x}=E;if(x&&T!==null)v=p+T,S=!0;else if(E.endOnNext&&!S){const B=h.reduce((D,R)=>{if(R!==E.id){const k=l[R];if(k.class===E.class&&k.startDate>E.startDate&&(!D||E.startDate<D.startDate))return k}return D},null);B&&(v=B.startTime,S=!0)}const L=Object.keys(E.attr);for(let B=0;B<L.length;B++){const D=L[B];if(!yd(D))continue;const R=C[D];if(R)S&&!(I!=null&&I.durationKnown)?R.endTime=v:Math.abs(R.startTime-p)>.01&&(R.startTime=p,R.endTime=v);else if(a){let k=E.attr[D];Cd(D)&&(k=Ml(k));const Q=_n(a,p,v,{key:D,data:k},Kt.dateRange);Q&&(Q.id=m,this.id3Track.addCue(Q),C[D]=Q,r&&(D==="X-ASSET-LIST"||D==="X-ASSET-URL")&&Q.addEventListener("enter",this.onEventCueEnter))}}A[m]={cues:C,dateRange:E,durationKnown:S}}}}}class ep{constructor(t){this.hls=void 0,this.config=void 0,this.media=null,this.currentTime=0,this.stallCount=0,this._latency=null,this._targetLatencyUpdated=!1,this.onTimeupdate=()=>{const{media:e}=this,s=this.levelDetails;if(!e||!s)return;this.currentTime=e.currentTime;const i=this.computeLatency();if(i===null)return;this._latency=i;const{lowLatencyMode:n,maxLiveSyncPlaybackRate:r}=this.config;if(!n||r===1||!s.live)return;const a=this.targetLatency;if(a===null)return;const c=i-a,l=Math.min(this.maxLatency,a+s.targetduration);if(c<l&&c>.05&&this.forwardBufferLength>1){const A=Math.min(2,Math.max(1,r)),u=Math.round(2/(1+Math.exp(-.75*c-this.edgeStalled))*20)/20,d=Math.min(A,Math.max(1,u));this.changeMediaPlaybackRate(e,d)}else e.playbackRate!==1&&e.playbackRate!==0&&this.changeMediaPlaybackRate(e,1)},this.hls=t,this.config=t.config,this.registerListeners()}get levelDetails(){var t;return((t=this.hls)==null?void 0:t.latestLevelDetails)||null}get latency(){return this._latency||0}get maxLatency(){const{config:t}=this;if(t.liveMaxLatencyDuration!==void 0)return t.liveMaxLatencyDuration;const e=this.levelDetails;return e?t.liveMaxLatencyDurationCount*e.targetduration:0}get targetLatency(){const t=this.levelDetails;if(t===null||this.hls===null)return null;const{holdBack:e,partHoldBack:s,targetduration:i}=t,{liveSyncDuration:n,liveSyncDurationCount:r,lowLatencyMode:a}=this.config,c=this.hls.userConfig;let l=a&&s||e;(this._targetLatencyUpdated||c.liveSyncDuration||c.liveSyncDurationCount||l===0)&&(l=n!==void 0?n:r*i);const h=i;return l+Math.min(this.stallCount*this.config.liveSyncOnStallIncrease,h)}set targetLatency(t){this.stallCount=0,this.config.liveSyncDuration=t,this._targetLatencyUpdated=!0}get liveSyncPosition(){const t=this.estimateLiveEdge(),e=this.targetLatency;if(t===null||e===null)return null;const s=this.levelDetails;if(s===null)return null;const i=s.edge,n=t-e-this.edgeStalled,r=i-s.totalduration,a=i-(this.config.lowLatencyMode&&s.partTarget||s.targetduration);return Math.min(Math.max(r,n),a)}get drift(){const t=this.levelDetails;return t===null?1:t.drift}get edgeStalled(){const t=this.levelDetails;if(t===null)return 0;const e=(this.config.lowLatencyMode&&t.partTarget||t.targetduration)*3;return Math.max(t.age-e,0)}get forwardBufferLength(){const{media:t}=this,e=this.levelDetails;if(!t||!e)return 0;const s=t.buffered.length;return(s?t.buffered.end(s-1):e.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.hls=null}registerListeners(){const{hls:t}=this;t&&(t.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(y.ERROR,this.onError,this))}unregisterListeners(){const{hls:t}=this;t&&(t.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(y.ERROR,this.onError,this))}onMediaAttached(t,e){this.media=e.media,this.media.addEventListener("timeupdate",this.onTimeupdate)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.onTimeupdate),this.media=null)}onManifestLoading(){this._latency=null,this.stallCount=0}onLevelUpdated(t,{details:e}){e.advanced&&this.onTimeupdate(),!e.live&&this.media&&this.media.removeEventListener("timeupdate",this.onTimeupdate)}onError(t,e){var s;e.details===w.BUFFER_STALLED_ERROR&&(this.stallCount++,this.hls&&(s=this.levelDetails)!=null&&s.live&&this.hls.logger.warn("[latency-controller]: Stall detected, adjusting target latency"))}changeMediaPlaybackRate(t,e){var s,i;t.playbackRate!==e&&((s=this.hls)==null||s.logger.debug(`[latency-controller]: latency=${this.latency.toFixed(3)}, targetLatency=${(i=this.targetLatency)==null?void 0:i.toFixed(3)}, forwardBufferLength=${this.forwardBufferLength.toFixed(3)}: adjusting playback rate from ${t.playbackRate} to ${e}`),t.playbackRate=e)}estimateLiveEdge(){const t=this.levelDetails;return t===null?null:t.edge+t.age}computeLatency(){const t=this.estimateLiveEdge();return t===null?null:t-this.currentTime}}class sp extends eo{constructor(t,e){super(t,"level-controller"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=e,this._registerListeners()}_registerListeners(){const{hls:t}=this;t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(y.LEVEL_LOADED,this.onLevelLoaded,this),t.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(y.FRAG_BUFFERED,this.onFragBuffered,this),t.on(y.ERROR,this.onError,this)}_unregisterListeners(){const{hls:t}=this;t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(y.LEVEL_LOADED,this.onLevelLoaded,this),t.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(y.FRAG_BUFFERED,this.onFragBuffered,this),t.off(y.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(e=>{e.loadError=0,e.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(t,e){this.resetLevels()}onManifestLoaded(t,e){const s=this.hls.config.preferManagedMediaSource,i=[],n={},r={};let a=!1,c=!1,l=!1;e.levels.forEach(h=>{const A=h.attrs;let{audioCodec:u,videoCodec:d}=h;u&&(h.audioCodec=u=Yi(u,s)||void 0),d&&(d=h.videoCodec=Mu(d));const{width:f,height:g,unknownCodecs:m}=h,E=m?.length||0;if(a||(a=!!(f&&g)),c||(c=!!d),l||(l=!!u),E||u&&!this.isAudioSupported(u)||d&&!this.isVideoSupported(d)){this.log(`Some or all CODECS not supported "${A.CODECS}"`);return}const{CODECS:p,"FRAME-RATE":I,"HDCP-LEVEL":C,"PATHWAY-ID":S,RESOLUTION:v,"VIDEO-RANGE":T}=A,L=`${`${S||"."}-`}${h.bitrate}-${v}-${I}-${p}-${T}-${C}`;if(n[L])if(n[L].uri!==h.url&&!h.attrs["PATHWAY-ID"]){const B=r[L]+=1;h.attrs["PATHWAY-ID"]=new Array(B+1).join(".");const D=this.createLevel(h);n[L]=D,i.push(D)}else n[L].addGroupId("audio",A.AUDIO),n[L].addGroupId("text",A.SUBTITLES);else{const B=this.createLevel(h);n[L]=B,r[L]=1,i.push(B)}}),this.filterAndSortMediaOptions(i,e,a,c,l)}createLevel(t){const e=new Ws(t),s=t.supplemental;if(s!=null&&s.videoCodec&&!this.isVideoSupported(s.videoCodec)){const i=new Error(`SUPPLEMENTAL-CODECS not supported "${s.videoCodec}"`);this.log(i.message),e.supportedResult=Jl(i,[])}return e}isAudioSupported(t){return Ys(t,"audio",this.hls.config.preferManagedMediaSource)}isVideoSupported(t){return Ys(t,"video",this.hls.config.preferManagedMediaSource)}filterAndSortMediaOptions(t,e,s,i,n){var r;let a=[],c=[],l=t;const h=((r=e.stats)==null?void 0:r.parsing)||{};if((s||i)&&n&&(l=l.filter(({videoCodec:p,videoRange:I,width:C,height:S})=>(!!p||!!(C&&S))&&qu(I))),l.length===0){Promise.resolve().then(()=>{if(this.hls){let p="no level with compatible codecs found in manifest",I=p;e.levels.length&&(I=`one or more CODECS in variant not supported: ${at(e.levels.map(S=>S.attrs.CODECS).filter((S,v,T)=>T.indexOf(S)===v))}`,this.warn(I),p+=` (${I})`);const C=new Error(p);this.hls.trigger(y.ERROR,{type:V.MEDIA_ERROR,details:w.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:e.url,error:C,reason:I})}}),h.end=performance.now();return}e.audioTracks&&(a=e.audioTracks.filter(p=>!p.audioCodec||this.isAudioSupported(p.audioCodec)),$a(a)),e.subtitles&&(c=e.subtitles,$a(c));const A=l.slice(0);l.sort((p,I)=>{if(p.attrs["HDCP-LEVEL"]!==I.attrs["HDCP-LEVEL"])return(p.attrs["HDCP-LEVEL"]||"")>(I.attrs["HDCP-LEVEL"]||"")?1:-1;if(s&&p.height!==I.height)return p.height-I.height;if(p.frameRate!==I.frameRate)return p.frameRate-I.frameRate;if(p.videoRange!==I.videoRange)return qi.indexOf(p.videoRange)-qi.indexOf(I.videoRange);if(p.videoCodec!==I.videoCodec){const C=Po(p.videoCodec),S=Po(I.videoCodec);if(C!==S)return S-C}if(p.uri===I.uri&&p.codecSet!==I.codecSet){const C=Vi(p.codecSet),S=Vi(I.codecSet);if(C!==S)return S-C}return p.averageBitrate!==I.averageBitrate?p.averageBitrate-I.averageBitrate:0});let u=A[0];if(this.steering&&(l=this.steering.filterParsedLevels(l),l.length!==A.length)){for(let p=0;p<A.length;p++)if(A[p].pathwayId===l[0].pathwayId){u=A[p];break}}this._levels=l;for(let p=0;p<l.length;p++)if(l[p]===u){var d;this._firstLevel=p;const I=u.bitrate,C=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${l.length} level(s) found, first bitrate: ${I}`),((d=this.hls.userConfig)==null?void 0:d.abrEwmaDefaultEstimate)===void 0){const S=Math.min(I,this.hls.config.abrEwmaDefaultEstimateMax);S>C&&C===this.hls.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=S)}break}const f=n&&!i,g=this.hls.config,m=!!(g.audioStreamController&&g.audioTrackController),E={levels:l,audioTracks:a,subtitleTracks:c,sessionData:e.sessionData,sessionKeys:e.sessionKeys,firstLevel:this._firstLevel,stats:e.stats,audio:n,video:i,altAudio:m&&!f&&a.some(p=>!!p.url)};h.end=performance.now(),this.hls.trigger(y.MANIFEST_PARSED,E)}get levels(){return this._levels.length===0?null:this._levels}get loadLevelObj(){return this.currentLevel}get level(){return this.currentLevelIndex}set level(t){const e=this._levels;if(e.length===0)return;if(t<0||t>=e.length){const h=new Error("invalid level idx"),A=t<0;if(this.hls.trigger(y.ERROR,{type:V.OTHER_ERROR,details:w.LEVEL_SWITCH_ERROR,level:t,fatal:A,error:h,reason:h.message}),A)return;t=Math.min(t,e.length-1)}const s=this.currentLevelIndex,i=this.currentLevel,n=i?i.attrs["PATHWAY-ID"]:void 0,r=e[t],a=r.attrs["PATHWAY-ID"];if(this.currentLevelIndex=t,this.currentLevel=r,s===t&&i&&n===a)return;this.log(`Switching to level ${t} (${r.height?r.height+"p ":""}${r.videoRange?r.videoRange+" ":""}${r.codecSet?r.codecSet+" ":""}@${r.bitrate})${a?" with Pathway "+a:""} from level ${s}${n?" with Pathway "+n:""}`);const c={level:t,attrs:r.attrs,details:r.details,bitrate:r.bitrate,averageBitrate:r.averageBitrate,maxBitrate:r.maxBitrate,realBitrate:r.realBitrate,width:r.width,height:r.height,codecSet:r.codecSet,audioCodec:r.audioCodec,videoCodec:r.videoCodec,audioGroups:r.audioGroups,subtitleGroups:r.subtitleGroups,loaded:r.loaded,loadError:r.loadError,fragmentError:r.fragmentError,name:r.name,id:r.id,uri:r.uri,url:r.url,urlId:0,audioGroupIds:r.audioGroupIds,textGroupIds:r.textGroupIds};this.hls.trigger(y.LEVEL_SWITCHING,c);const l=r.details;if(!l||l.live){const h=this.switchParams(r.uri,i?.details,l);this.loadPlaylist(h)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(t){this.manualLevelIndex=t,this._startLevel===void 0&&(this._startLevel=t),t!==-1&&(this.level=t)}get firstLevel(){return this._firstLevel}set firstLevel(t){this._firstLevel=t}get startLevel(){if(this._startLevel===void 0){const t=this.hls.config.startLevel;return t!==void 0?t:this.hls.firstAutoLevel}return this._startLevel}set startLevel(t){this._startLevel=t}get pathways(){return this.steering?this.steering.pathways():[]}get pathwayPriority(){return this.steering?this.steering.pathwayPriority:null}set pathwayPriority(t){if(this.steering){const e=this.steering.pathways(),s=t.filter(i=>e.indexOf(i)!==-1);if(t.length<1){this.warn(`pathwayPriority ${t} should contain at least one pathway from list: ${e}`);return}this.steering.pathwayPriority=s}}onError(t,e){e.fatal||!e.context||e.context.type===z.LEVEL&&e.context.level===this.level&&this.checkRetry(e)}onFragBuffered(t,{frag:e}){if(e!==void 0&&e.type===H.MAIN){const s=e.elementaryStreams;if(!Object.keys(s).some(n=>!!s[n]))return;const i=this._levels[e.level];i!=null&&i.loadError&&(this.log(`Resetting level error count of ${i.loadError} on frag buffered`),i.loadError=0)}}onLevelLoaded(t,e){var s;const{level:i,details:n}=e,r=e.levelInfo;if(!r){var a;this.warn(`Invalid level index ${i}`),(a=e.deliveryDirectives)!=null&&a.skip&&(n.deltaUpdateFailed=!0);return}if(r===this.currentLevel||e.withoutMultiVariant){r.fragmentError===0&&(r.loadError=0);let c=r.details;c===e.details&&c.advanced&&(c=void 0),this.playlistLoaded(i,e,c)}else(s=e.deliveryDirectives)!=null&&s.skip&&(n.deltaUpdateFailed=!0)}loadPlaylist(t){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentLevel)&&this.scheduleLoading(this.currentLevel,t)}loadingPlaylist(t,e){super.loadingPlaylist(t,e);const s=this.getUrlWithDirectives(t.uri,e),i=this.currentLevelIndex,n=t.attrs["PATHWAY-ID"],r=t.details,a=r?.age;this.log(`Loading level index ${i}${e?.msn!==void 0?" at sn "+e.msn+" part "+e.part:""}${n?" Pathway "+n:""}${a&&r.live?" age "+a.toFixed(1)+(r.type&&" "+r.type||""):""} ${s}`),this.hls.trigger(y.LEVEL_LOADING,{url:s,level:i,levelInfo:t,pathwayId:t.attrs["PATHWAY-ID"],id:0,deliveryDirectives:e||null})}get nextLoadLevel(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(t){this.level=t,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=t)}removeLevel(t){var e;if(this._levels.length===1)return;const s=this._levels.filter((n,r)=>r!==t?!0:(this.steering&&this.steering.removeLevel(n),n===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,n.details&&n.details.fragments.forEach(a=>a.level=-1)),!1));mc(s),this._levels=s,this.currentLevelIndex>-1&&(e=this.currentLevel)!=null&&e.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.manualLevelIndex>-1&&(this.manualLevelIndex=this.currentLevelIndex);const i=s.length-1;this._firstLevel=Math.min(this._firstLevel,i),this._startLevel&&(this._startLevel=Math.min(this._startLevel,i)),this.hls.trigger(y.LEVELS_UPDATED,{levels:s})}onLevelsUpdated(t,{levels:e}){this._levels=e}checkMaxAutoUpdated(){const{autoLevelCapping:t,maxAutoLevel:e,maxHdcpLevel:s}=this.hls;this._maxAutoLevel!==e&&(this._maxAutoLevel=e,this.hls.trigger(y.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:t,levels:this.levels,maxAutoLevel:e,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:s}))}}function $a(o){const t={};o.forEach(e=>{const s=e.groupId||"";e.id=t[s]=t[s]||0,t[s]++})}function Ah(){return self.SourceBuffer||self.WebKitSourceBuffer}function uh(){if(!Pe())return!1;const t=Ah();return!t||t.prototype&&typeof t.prototype.appendBuffer=="function"&&typeof t.prototype.remove=="function"}function ip(){if(!uh())return!1;const o=Pe();return typeof o?.isTypeSupported=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(t=>o.isTypeSupported(qs(t,"video")))||["mp4a.40.2","fLaC"].some(t=>o.isTypeSupported(qs(t,"audio"))))}function np(){var o;const t=Ah();return typeof(t==null||(o=t.prototype)==null?void 0:o.changeType)=="function"}const rp=100;class op extends qr{constructor(t,e,s){super(t,e,s,"stream-controller",H.MAIN),this.audioCodecSwap=!1,this.level=-1,this._forceStartLoad=!1,this._hasEnoughToStart=!1,this.altAudio=0,this.audioOnly=!1,this.fragPlaying=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this.onMediaPlaying=()=>{this.tick()},this.onMediaSeeked=()=>{const i=this.media,n=i?i.currentTime:null;if(n===null||!K(n)||(this.log(`Media seeked to ${n.toFixed(3)}`),!this.getBufferedFrag(n)))return;const r=this.getFwdBufferInfoAtPos(i,n,H.MAIN,0);if(r===null||r.len===0){this.warn(`Main forward buffer length at ${n} on "seeked" event ${r?r.len:"empty"})`);return}this.tick()},this.registerListeners()}registerListeners(){super.registerListeners();const{hls:t}=this;t.on(y.MANIFEST_PARSED,this.onManifestParsed,this),t.on(y.LEVEL_LOADING,this.onLevelLoading,this),t.on(y.LEVEL_LOADED,this.onLevelLoaded,this),t.on(y.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.on(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(y.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.on(y.BUFFER_CREATED,this.onBufferCreated,this),t.on(y.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(y.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){super.unregisterListeners();const{hls:t}=this;t.off(y.MANIFEST_PARSED,this.onManifestParsed,this),t.off(y.LEVEL_LOADED,this.onLevelLoaded,this),t.off(y.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.off(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(y.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.off(y.BUFFER_CREATED,this.onBufferCreated,this),t.off(y.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(y.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this.onMediaPlaying=this.onMediaSeeked=null,this.unregisterListeners(),super.onHandlerDestroying()}startLoad(t,e){if(this.levels){const{lastCurrentTime:s,hls:i}=this;if(this.stopLoad(),this.setInterval(rp),this.level=-1,!this.startFragRequested){let n=i.startLevel;n===-1&&(i.config.testBandwidth&&this.levels.length>1?(n=0,this.bitrateTest=!0):n=i.firstAutoLevel),i.nextLoadLevel=n,this.level=i.loadLevel,this._hasEnoughToStart=!!e}s>0&&t===-1&&!e&&(this.log(`Override startPosition with lastCurrentTime @${s.toFixed(3)}`),t=s),this.state=P.IDLE,this.nextLoadPosition=this.lastCurrentTime=t+this.timelineOffset,this.startPosition=e?-1:t,this.tick()}else this._forceStartLoad=!0,this.state=P.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case P.WAITING_LEVEL:{const{levels:t,level:e}=this,s=t?.[e],i=s?.details;if(i&&(!i.live||this.levelLastLoaded===s&&!this.waitForLive(s))){if(this.waitForCdnTuneIn(i))break;this.state=P.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=P.IDLE;break}break}case P.FRAG_LOADING_WAITING_RETRY:this.checkRetryDate();break}this.state===P.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){var t;super.onTickEnd(),(t=this.media)!=null&&t.readyState&&this.media.seeking===!1&&(this.lastCurrentTime=this.media.currentTime),this.checkFragmentChanged()}doTickIdle(){const{hls:t,levelLastLoaded:e,levels:s,media:i}=this;if(e===null||!i&&!this.primaryPrefetch&&(this.startFragRequested||!t.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;const n=this.buffering?t.nextLoadLevel:t.loadLevel;if(!(s!=null&&s[n]))return;const r=s[n],a=this.getMainFwdBufferInfo();if(a===null)return;const c=this.getLevelDetails();if(c&&this._streamEnded(a,c)){const g={};this.altAudio===2&&(g.type="video"),this.hls.trigger(y.BUFFER_EOS,g),this.state=P.ENDED;return}if(!this.buffering)return;t.loadLevel!==n&&t.manualLevel===-1&&this.log(`Adapting to level ${n} from level ${this.level}`),this.level=t.nextLoadLevel=n;const l=r.details;if(!l||this.state===P.WAITING_LEVEL||this.waitForLive(r)){this.level=n,this.state=P.WAITING_LEVEL,this.startFragRequested=!1;return}const h=a.len,A=this.getMaxBufferLength(r.maxBitrate);if(h>=A)return;this.backtrackFragment&&this.backtrackFragment.start>a.end&&(this.backtrackFragment=null);const u=this.backtrackFragment?this.backtrackFragment.start:a.end;let d=this.getNextFragment(u,l);if(this.couldBacktrack&&!this.fragPrevious&&d&&dt(d)&&this.fragmentTracker.getState(d)!==Et.OK){var f;const m=((f=this.backtrackFragment)!=null?f:d).sn-l.startSN,E=l.fragments[m-1];E&&d.cc===E.cc&&(d=E,this.fragmentTracker.removeFragment(E))}else this.backtrackFragment&&a.len&&(this.backtrackFragment=null);if(d&&this.isLoopLoading(d,u)){if(!d.gap){const m=this.audioOnly&&!this.altAudio?ot.AUDIO:ot.VIDEO,E=(m===ot.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;E&&this.afterBufferFlushed(E,m,H.MAIN)}d=this.getNextFragmentLoopLoading(d,l,a,H.MAIN,A)}d&&(d.initSegment&&!d.initSegment.data&&!this.bitrateTest&&(d=d.initSegment),this.loadFragment(d,r,u))}loadFragment(t,e,s){const i=this.fragmentTracker.getState(t);i===Et.NOT_LOADED||i===Et.PARTIAL?dt(t)?this.bitrateTest?(this.log(`Fragment ${t.sn} of level ${t.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(t,e)):super.loadFragment(t,e,s):this._loadInitSegment(t,e):this.clearTrackerIfNeeded(t)}getBufferedFrag(t){return this.fragmentTracker.getBufferedFrag(t,H.MAIN)}followingBufferedFrag(t){return t?this.getBufferedFrag(t.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:t,media:e}=this;if(e!=null&&e.readyState){let s;const i=this.getAppendedFrag(e.currentTime);i&&i.start>1&&this.flushMainBuffer(0,i.start-1);const n=this.getLevelDetails();if(n!=null&&n.live){const a=this.getMainFwdBufferInfo();if(!a||a.len<n.targetduration*2)return}if(!e.paused&&t){const a=this.hls.nextLoadLevel,c=t[a],l=this.fragLastKbps;l&&this.fragCurrent?s=this.fragCurrent.duration*c.maxBitrate/(1e3*l)+1:s=0}else s=0;const r=this.getBufferedFrag(e.currentTime+s);if(r){const a=this.followingBufferedFrag(r);if(a){this.abortCurrentFrag();const c=a.maxStartPTS?a.maxStartPTS:a.start,l=a.duration,h=Math.max(r.end,c+Math.min(Math.max(l-this.config.maxFragLookUpTolerance,l*(this.couldBacktrack?.5:.125)),l*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(h,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const t=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,t&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.state){case P.KEY_LOADING:case P.FRAG_LOADING:case P.FRAG_LOADING_WAITING_RETRY:case P.PARSING:case P.PARSED:this.state=P.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(t,e){super.flushMainBuffer(t,e,this.altAudio===2?"video":null)}onMediaAttached(t,e){super.onMediaAttached(t,e);const s=e.media;_t(s,"playing",this.onMediaPlaying),_t(s,"seeked",this.onMediaSeeked)}onMediaDetaching(t,e){const{media:s}=this;s&&(Ot(s,"playing",this.onMediaPlaying),Ot(s,"seeked",this.onMediaSeeked)),this.videoBuffer=null,this.fragPlaying=null,super.onMediaDetaching(t,e),!e.transferMedia&&(this._hasEnoughToStart=!1)}onManifestLoading(){super.onManifestLoading(),this.log("Trigger BUFFER_RESET"),this.hls.trigger(y.BUFFER_RESET,void 0),this.couldBacktrack=!1,this.fragLastKbps=0,this.fragPlaying=this.backtrackFragment=null,this.altAudio=0,this.audioOnly=!1}onManifestParsed(t,e){let s=!1,i=!1;for(let n=0;n<e.levels.length;n++){const r=e.levels[n].audioCodec;r&&(s=s||r.indexOf("mp4a.40.2")!==-1,i=i||r.indexOf("mp4a.40.5")!==-1)}this.audioCodecSwitch=s&&i&&!np(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=e.levels,this.startFragRequested=!1}onLevelLoading(t,e){const{levels:s}=this;if(!s||this.state!==P.IDLE)return;const i=e.levelInfo;(!i.details||i.details.live&&(this.levelLastLoaded!==i||i.details.expired)||this.waitForCdnTuneIn(i.details))&&(this.state=P.WAITING_LEVEL)}onLevelLoaded(t,e){var s;const{levels:i,startFragRequested:n}=this,r=e.level,a=e.details,c=a.totalduration;if(!i){this.warn(`Levels were reset while loading level ${r}`);return}this.log(`Level ${r} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""}, cc [${a.startCC}, ${a.endCC}] duration:${c}`);const l=e.levelInfo,h=this.fragCurrent;h&&(this.state===P.FRAG_LOADING||this.state===P.FRAG_LOADING_WAITING_RETRY)&&h.level!==e.level&&h.loader&&this.abortCurrentFrag();let A=0;if(a.live||(s=l.details)!=null&&s.live){var u;if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;A=this.alignPlaylists(a,l.details,(u=this.levelLastLoaded)==null?void 0:u.details)}if(l.details=a,this.levelLastLoaded=l,n||this.setStartPosition(a,A),this.hls.trigger(y.LEVEL_UPDATED,{details:a,level:r}),this.state===P.WAITING_LEVEL){if(this.waitForCdnTuneIn(a))return;this.state=P.IDLE}n&&a.live&&this.synchronizeToLiveEdge(a),this.tick()}synchronizeToLiveEdge(t){const{config:e,media:s}=this;if(!s)return;const i=this.hls.liveSyncPosition,n=this.getLoadPosition(),r=t.fragmentStart,a=t.edge,c=n>=r-e.maxFragLookUpTolerance&&n<=a;if(i!==null&&s.duration>i&&(n<i||!c)){const h=e.liveMaxLatencyDuration!==void 0?e.liveMaxLatencyDuration:e.liveMaxLatencyDurationCount*t.targetduration;if((!c&&s.readyState<4||n<a-h)&&(this._hasEnoughToStart||(this.nextLoadPosition=i),s.readyState))if(this.warn(`Playback: ${n.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${i.toFixed(3)}`),this.config.liveSyncMode==="buffered"){var l;const A=j.bufferInfo(s,i,0);if(!((l=A.buffered)!=null&&l.length)){s.currentTime=i;return}if(A.start<=n){s.currentTime=i;return}const{nextStart:d}=j.bufferedInfo(A.buffered,n,0);d&&(s.currentTime=d)}else s.currentTime=i}}_handleFragmentLoadProgress(t){var e;const s=t.frag,{part:i,payload:n}=t,{levels:r}=this;if(!r){this.warn(`Levels were reset while fragment load was in progress. Fragment ${s.sn} of level ${s.level} will not be buffered`);return}const a=r[s.level];if(!a){this.warn(`Level ${s.level} not found on progress`);return}const c=a.details;if(!c){this.warn(`Dropping fragment ${s.sn} of level ${s.level} after level details were reset`),this.fragmentTracker.removeFragment(s);return}const l=a.videoCodec,h=c.PTSKnown||!c.live,A=(e=s.initSegment)==null?void 0:e.data,u=this._getAudioCodec(a),d=this.transmuxer=this.transmuxer||new Oc(this.hls,H.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),f=i?i.index:-1,g=f!==-1,m=new Hr(s.level,s.sn,s.stats.chunkCount,n.byteLength,f,g),E=this.initPTS[s.cc];d.push(n,A,u,l,s,i,c.totalduration,h,m,E)}onAudioTrackSwitching(t,e){const s=this.hls,i=this.altAudio!==0;if(Wi(e.url,s))this.altAudio=1;else{if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const r=this.fragCurrent;r&&(this.log("Switching to main audio track, cancel main fragment load"),r.abortRequests(),this.fragmentTracker.removeFragment(r)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();if(i){this.altAudio=0,this.fragmentTracker.removeAllFragments(),s.once(y.BUFFER_FLUSHED,()=>{this.hls&&this.hls.trigger(y.AUDIO_TRACK_SWITCHED,e)}),s.trigger(y.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null});return}s.trigger(y.AUDIO_TRACK_SWITCHED,e)}}onAudioTrackSwitched(t,e){const s=Wi(e.url,this.hls);if(s){const i=this.videoBuffer;i&&this.mediaBuffer!==i&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=i)}this.altAudio=s?2:0,this.tick()}onBufferCreated(t,e){const s=e.tracks;let i,n,r=!1;for(const a in s){const c=s[a];if(c.id==="main"){if(n=a,i=c,a==="video"){const l=s[a];l&&(this.videoBuffer=l.buffer)}}else r=!0}r&&i?(this.log(`Alternate track found, use ${n}.buffered to schedule main fragment loading`),this.mediaBuffer=i.buffer):this.mediaBuffer=this.media}onFragBuffered(t,e){const{frag:s,part:i}=e,n=s.type===H.MAIN;if(n){if(this.fragContextChanged(s)){this.warn(`Fragment ${s.sn}${i?" p: "+i.index:""} of level ${s.level} finished buffering, but was aborted. state: ${this.state}`),this.state===P.PARSED&&(this.state=P.IDLE);return}const a=i?i.stats:s.stats;this.fragLastKbps=Math.round(8*a.total/(a.buffering.end-a.loading.first)),dt(s)&&(this.fragPrevious=s),this.fragBufferedComplete(s,i)}const r=this.media;r&&(!this._hasEnoughToStart&&j.getBuffered(r).length&&(this._hasEnoughToStart=!0,this.seekToStartPos()),n&&this.tick())}get hasEnoughToStart(){return this._hasEnoughToStart}onError(t,e){var s;if(e.fatal){this.state=P.ERROR;return}switch(e.details){case w.FRAG_GAP:case w.FRAG_PARSING_ERROR:case w.FRAG_DECRYPT_ERROR:case w.FRAG_LOAD_ERROR:case w.FRAG_LOAD_TIMEOUT:case w.KEY_LOAD_ERROR:case w.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(H.MAIN,e);break;case w.LEVEL_LOAD_ERROR:case w.LEVEL_LOAD_TIMEOUT:case w.LEVEL_PARSING_ERROR:!e.levelRetry&&this.state===P.WAITING_LEVEL&&((s=e.context)==null?void 0:s.type)===z.LEVEL&&(this.state=P.IDLE);break;case w.BUFFER_ADD_CODEC_ERROR:case w.BUFFER_APPEND_ERROR:if(e.parent!=="main")return;this.reduceLengthAndFlushBuffer(e)&&this.resetLoadingState();break;case w.BUFFER_FULL_ERROR:if(e.parent!=="main")return;this.reduceLengthAndFlushBuffer(e)&&(!this.config.interstitialsController&&this.config.assetPlayerId?this._hasEnoughToStart=!0:this.flushMainBuffer(0,Number.POSITIVE_INFINITY));break;case w.INTERNAL_EXCEPTION:this.recoverWorkerError(e);break}}onFragLoadEmergencyAborted(){this.state=P.IDLE,this._hasEnoughToStart||(this.startFragRequested=!1,this.nextLoadPosition=this.lastCurrentTime),this.tickImmediate()}onBufferFlushed(t,{type:e}){if(e!==ot.AUDIO||!this.altAudio){const s=(e===ot.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;s&&(this.afterBufferFlushed(s,e,H.MAIN),this.tick())}}onLevelsUpdated(t,e){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level,this.level===-1&&this.resetWhenMissingContext(this.fragCurrent)),this.levels=e.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:t}=this;if(!t)return;const e=t.currentTime;let s=this.startPosition;if(s>=0&&e<s){if(t.seeking){this.log(`could not seek to ${s}, already seeking at ${e}`);return}const i=this.timelineOffset;i&&s&&(s+=i);const n=this.getLevelDetails(),r=j.getBuffered(t),a=r.length?r.start(0):0,c=a-s,l=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);(this.config.startOnSegmentBoundary||c>0&&(c<l||this.loadingParts&&c<2*(n?.partTarget||0)))&&(this.log(`adjusting start position by ${c} to match buffer start`),s+=c,this.startPosition=s),e<s&&(this.log(`seek to target start position ${s} from current time ${e} buffer start ${a}`),t.currentTime=s)}}_getAudioCodec(t){let e=this.config.defaultAudioCodec||t.audioCodec;return this.audioCodecSwap&&e&&(this.log("Swapping audio codec"),e.indexOf("mp4a.40.5")!==-1?e="mp4a.40.2":e="mp4a.40.5"),e}_loadBitrateTestFrag(t,e){t.bitrateTest=!0,this._doFragLoad(t,e).then(s=>{const{hls:i}=this,n=s?.frag;if(!n||this.fragContextChanged(n))return;e.fragmentError=0,this.state=P.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const r=n.stats;r.parsing.start=r.parsing.end=r.buffering.start=r.buffering.end=self.performance.now(),i.trigger(y.FRAG_LOADED,s),n.bitrateTest=!1}).catch(s=>{this.state===P.STOPPED||this.state===P.ERROR||(this.warn(s),this.resetFragmentLoading(t))})}_handleTransmuxComplete(t){const e=this.playlistType,{hls:s}=this,{remuxResult:i,chunkMeta:n}=t,r=this.getCurrentContext(n);if(!r){this.resetWhenMissingContext(n);return}const{frag:a,part:c,level:l}=r,{video:h,text:A,id3:u,initSegment:d}=i,{details:f}=l,g=this.altAudio?void 0:i.audio;if(this.fragContextChanged(a)){this.fragmentTracker.removeFragment(a);return}if(this.state=P.PARSING,d){const m=d.tracks;if(m){const C=a.initSegment||a;if(this.unhandledEncryptionError(d,a))return;this._bufferInitSegment(l,m,C,n),s.trigger(y.FRAG_PARSING_INIT_SEGMENT,{frag:C,id:e,tracks:m})}const E=d.initPTS,p=d.timescale,I=this.initPTS[a.cc];if(K(E)&&(!I||I.baseTime!==E||I.timescale!==p)){const C=d.trackId;this.initPTS[a.cc]={baseTime:E,timescale:p,trackId:C},s.trigger(y.INIT_PTS_FOUND,{frag:a,id:e,initPTS:E,timescale:p,trackId:C})}}if(h&&f){g&&h.type==="audiovideo"&&this.logMuxedErr(a);const m=f.fragments[a.sn-1-f.startSN],E=a.sn===f.startSN,p=!m||a.cc>m.cc;if(i.independent!==!1){const{startPTS:I,endPTS:C,startDTS:S,endDTS:v}=h;if(c)c.elementaryStreams[h.type]={startPTS:I,endPTS:C,startDTS:S,endDTS:v};else if(h.firstKeyFrame&&h.independent&&n.id===1&&!p&&(this.couldBacktrack=!0),h.dropped&&h.independent){const T=this.getMainFwdBufferInfo(),x=(T?T.end:this.getLoadPosition())+this.config.maxBufferHole,L=h.firstKeyFramePTS?h.firstKeyFramePTS:I;if(!E&&x<L-this.config.maxBufferHole&&!p){this.backtrack(a);return}else p&&(a.gap=!0);a.setElementaryStreamInfo(h.type,a.start,C,a.start,v,!0)}else E&&I-(f.appliedTimelineOffset||0)>Ni&&(a.gap=!0);a.setElementaryStreamInfo(h.type,I,C,S,v),this.backtrackFragment&&(this.backtrackFragment=a),this.bufferFragmentData(h,a,c,n,E||p)}else if(E||p)a.gap=!0;else{this.backtrack(a);return}}if(g){const{startPTS:m,endPTS:E,startDTS:p,endDTS:I}=g;c&&(c.elementaryStreams[ot.AUDIO]={startPTS:m,endPTS:E,startDTS:p,endDTS:I}),a.setElementaryStreamInfo(ot.AUDIO,m,E,p,I),this.bufferFragmentData(g,a,c,n)}if(f&&u!=null&&u.samples.length){const m={id:e,frag:a,details:f,samples:u.samples};s.trigger(y.FRAG_PARSING_METADATA,m)}if(f&&A){const m={id:e,frag:a,details:f,samples:A.samples};s.trigger(y.FRAG_PARSING_USERDATA,m)}}logMuxedErr(t){this.warn(`${dt(t)?"Media":"Init"} segment with muxed audiovideo where only video expected: ${t.url}`)}_bufferInitSegment(t,e,s,i){if(this.state!==P.PARSING)return;this.audioOnly=!!e.audio&&!e.video,this.altAudio&&!this.audioOnly&&(delete e.audio,e.audiovideo&&this.logMuxedErr(s));const{audio:n,video:r,audiovideo:a}=e;if(n){const l=t.audioCodec;let h=_i(n.codec,l);h==="mp4a"&&(h="mp4a.40.5");const A=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){h&&(h.indexOf("mp4a.40.5")!==-1?h="mp4a.40.2":h="mp4a.40.5");const u=n.metadata;u&&"channelCount"in u&&(u.channelCount||1)!==1&&A.indexOf("firefox")===-1&&(h="mp4a.40.5")}h&&h.indexOf("mp4a.40.5")!==-1&&A.indexOf("android")!==-1&&n.container!=="audio/mpeg"&&(h="mp4a.40.2",this.log(`Android: force audio codec to ${h}`)),l&&l!==h&&this.log(`Swapping manifest audio codec "${l}" for "${h}"`),n.levelCodec=h,n.id=H.MAIN,this.log(`Init audio buffer, container:${n.container}, codecs[selected/level/parsed]=[${h||""}/${l||""}/${n.codec}]`),delete e.audiovideo}if(r){r.levelCodec=t.videoCodec,r.id=H.MAIN;const l=r.codec;if(l?.length===4)switch(l){case"hvc1":case"hev1":r.codec="hvc1.1.6.L120.90";break;case"av01":r.codec="av01.0.04M.08";break;case"avc1":r.codec="avc1.42e01e";break}this.log(`Init video buffer, container:${r.container}, codecs[level/parsed]=[${t.videoCodec||""}/${l}]${r.codec!==l?" parsed-corrected="+r.codec:""}${r.supplemental?" supplemental="+r.supplemental:""}`),delete e.audiovideo}a&&(this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${t.codecs}/${a.codec}]`),delete e.video,delete e.audio);const c=Object.keys(e);if(c.length){if(this.hls.trigger(y.BUFFER_CODECS,e),!this.hls)return;c.forEach(l=>{const A=e[l].initSegment;A!=null&&A.byteLength&&this.hls.trigger(y.BUFFER_APPENDING,{type:l,data:A,frag:s,part:null,chunkMeta:i,parent:s.type})})}this.tickImmediate()}getMainFwdBufferInfo(){const t=this.mediaBuffer&&this.altAudio===2?this.mediaBuffer:this.media;return this.getFwdBufferInfo(t,H.MAIN)}get maxBufferLength(){const{levels:t,level:e}=this,s=t?.[e];return s?this.getMaxBufferLength(s.maxBitrate):this.config.maxBufferLength}backtrack(t){this.couldBacktrack=!0,this.backtrackFragment=t,this.resetTransmuxer(),this.flushBufferGap(t),this.fragmentTracker.removeFragment(t),this.fragPrevious=null,this.nextLoadPosition=t.start,this.state=P.IDLE}checkFragmentChanged(){const t=this.media;let e=null;if(t&&t.readyState>1&&t.seeking===!1){const s=t.currentTime;if(j.isBuffered(t,s)?e=this.getAppendedFrag(s):j.isBuffered(t,s+.1)&&(e=this.getAppendedFrag(s+.1)),e){this.backtrackFragment=null;const i=this.fragPlaying,n=e.level;(!i||e.sn!==i.sn||i.level!==n)&&(this.fragPlaying=e,this.hls.trigger(y.FRAG_CHANGED,{frag:e}),(!i||i.level!==n)&&this.hls.trigger(y.LEVEL_SWITCHED,{level:n}))}}}get nextLevel(){const t=this.nextBufferedFrag;return t?t.level:-1}get currentFrag(){var t;if(this.fragPlaying)return this.fragPlaying;const e=((t=this.media)==null?void 0:t.currentTime)||this.lastCurrentTime;return K(e)?this.getAppendedFrag(e):null}get currentProgramDateTime(){var t;const e=((t=this.media)==null?void 0:t.currentTime)||this.lastCurrentTime;if(K(e)){const s=this.getLevelDetails(),i=this.currentFrag||(s?We(null,s.fragments,e):null);if(i){const n=i.programDateTime;if(n!==null){const r=n+(e-i.start)*1e3;return new Date(r)}}}return null}get currentLevel(){const t=this.currentFrag;return t?t.level:-1}get nextBufferedFrag(){const t=this.currentFrag;return t?this.followingBufferedFrag(t):null}get forceStartLoad(){return this._forceStartLoad}}class ap extends zt{constructor(t,e){super("key-loader",e),this.config=void 0,this.keyIdToKeyInfo={},this.emeController=null,this.config=t}abort(t){for(const s in this.keyIdToKeyInfo){const i=this.keyIdToKeyInfo[s].loader;if(i){var e;if(t&&t!==((e=i.context)==null?void 0:e.frag.type))return;i.abort()}}}detach(){for(const t in this.keyIdToKeyInfo){const e=this.keyIdToKeyInfo[t];(e.mediaKeySessionContext||e.decryptdata.isCommonEncryption)&&delete this.keyIdToKeyInfo[t]}}destroy(){this.detach();for(const t in this.keyIdToKeyInfo){const e=this.keyIdToKeyInfo[t].loader;e&&e.destroy()}this.keyIdToKeyInfo={}}createKeyLoadError(t,e=w.KEY_LOAD_ERROR,s,i,n){return new ye({type:V.NETWORK_ERROR,details:e,fatal:!1,frag:t,response:n,error:s,networkDetails:i})}loadClear(t,e,s){if(this.emeController&&this.config.emeEnabled&&!this.emeController.getSelectedKeySystemFormats().length){if(e.length)for(let i=0,n=e.length;i<n;i++){const r=e[i];if(t.cc<=r.cc&&(!dt(t)||!dt(r)||t.sn<r.sn)||!s&&i==n-1)return this.emeController.selectKeySystemFormat(r).then(a=>{if(!this.emeController)return;r.setKeyFormat(a);const c=Fi(a);if(c)return this.emeController.getKeySystemAccess([c])})}if(this.config.requireKeySystemAccessOnStart){const i=Ms(this.config);if(i.length)return this.emeController.getKeySystemAccess(i)}}return null}load(t){return!t.decryptdata&&t.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(t).then(e=>this.loadInternal(t,e)):this.loadInternal(t)}loadInternal(t,e){var s,i;e&&t.setKeyFormat(e);const n=t.decryptdata;if(!n){const l=new Error(e?`Expected frag.decryptdata to be defined after setting format ${e}`:`Missing decryption data on fragment in onKeyLoading (emeEnabled with controller: ${this.emeController&&this.config.emeEnabled})`);return Promise.reject(this.createKeyLoadError(t,w.KEY_LOAD_ERROR,l))}const r=n.uri;if(!r)return Promise.reject(this.createKeyLoadError(t,w.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${r}"`)));const a=Pn(n);let c=this.keyIdToKeyInfo[a];if((s=c)!=null&&s.decryptdata.key)return n.key=c.decryptdata.key,Promise.resolve({frag:t,keyInfo:c});if(this.emeController&&(i=c)!=null&&i.keyLoadPromise)switch(this.emeController.getKeyStatus(c.decryptdata)){case"usable":case"usable-in-future":return c.keyLoadPromise.then(h=>{const{keyInfo:A}=h;return n.key=A.decryptdata.key,{frag:t,keyInfo:A}})}switch(this.log(`${this.keyIdToKeyInfo[a]?"Rel":"L"}oading${n.keyId?" keyId: "+Lt(n.keyId):""} URI: ${n.uri} from ${t.type} ${t.level}`),c=this.keyIdToKeyInfo[a]={decryptdata:n,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},n.method){case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return n.keyFormat==="identity"?this.loadKeyHTTP(c,t):this.loadKeyEME(c,t);case"AES-128":case"AES-256":case"AES-256-CTR":return this.loadKeyHTTP(c,t);default:return Promise.reject(this.createKeyLoadError(t,w.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${n.method}"`)))}}loadKeyEME(t,e){const s={frag:e,keyInfo:t};if(this.emeController&&this.config.emeEnabled){var i;if(!t.decryptdata.keyId&&(i=e.initSegment)!=null&&i.data){const r=xu(e.initSegment.data);if(r.length){let a=r[0];a.some(c=>c!==0)?(this.log(`Using keyId found in init segment ${Lt(a)}`),we.setKeyIdForUri(t.decryptdata.uri,a)):(a=we.addKeyIdForUri(t.decryptdata.uri),this.log(`Generating keyId to patch media ${Lt(a)}`)),t.decryptdata.keyId=a}}if(!t.decryptdata.keyId&&!dt(e))return Promise.resolve(s);const n=this.emeController.loadKey(s);return(t.keyLoadPromise=n.then(r=>(t.mediaKeySessionContext=r,s))).catch(r=>{throw t.keyLoadPromise=null,"data"in r&&(r.data.frag=e),r})}return Promise.resolve(s)}loadKeyHTTP(t,e){const s=this.config,i=s.loader,n=new i(s);return e.keyLoader=t.loader=n,t.keyLoadPromise=new Promise((r,a)=>{const c={keyInfo:t,frag:e,responseType:"arraybuffer",url:t.decryptdata.uri},l=s.keyLoadPolicy.default,h={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},A={onSuccess:(u,d,f,g)=>{const{frag:m,keyInfo:E}=f,p=Pn(E.decryptdata);if(!m.decryptdata||E!==this.keyIdToKeyInfo[p])return a(this.createKeyLoadError(m,w.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),g));E.decryptdata.key=m.decryptdata.key=new Uint8Array(u.data),m.keyLoader=null,E.loader=null,r({frag:m,keyInfo:E})},onError:(u,d,f,g)=>{this.resetLoader(d),a(this.createKeyLoadError(e,w.KEY_LOAD_ERROR,new Error(`HTTP Error ${u.code} loading key ${u.text}`),f,it({url:c.url,data:void 0},u)))},onTimeout:(u,d,f)=>{this.resetLoader(d),a(this.createKeyLoadError(e,w.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),f))},onAbort:(u,d,f)=>{this.resetLoader(d),a(this.createKeyLoadError(e,w.INTERNAL_ABORTED,new Error("key loading aborted"),f))}};n.load(c,h,A)})}resetLoader(t){const{frag:e,keyInfo:s,url:i}=t,n=s.loader;e.keyLoader===n&&(e.keyLoader=null,s.loader=null);const r=Pn(s.decryptdata)||i;delete this.keyIdToKeyInfo[r],n&&n.destroy()}}function Pn(o){if(o.keyFormat!==Dt.FAIRPLAY){const t=o.keyId;if(t)return Lt(t)}return o.uri}function Ha(o){const{type:t}=o;switch(t){case z.AUDIO_TRACK:return H.AUDIO;case z.SUBTITLE_TRACK:return H.SUBTITLE;default:return H.MAIN}}function Fn(o,t){let e=o.url;return(e===void 0||e.indexOf("data:")===0)&&(e=t.url),e}class lp{constructor(t){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.onManifestLoaded=this.checkAutostartLoad,this.hls=t,this.registerListeners()}startLoad(t){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:t}=this;t.on(y.MANIFEST_LOADING,this.onManifestLoading,this),t.on(y.LEVEL_LOADING,this.onLevelLoading,this),t.on(y.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.on(y.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),t.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this)}unregisterListeners(){const{hls:t}=this;t.off(y.MANIFEST_LOADING,this.onManifestLoading,this),t.off(y.LEVEL_LOADING,this.onLevelLoading,this),t.off(y.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.off(y.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),t.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this)}createInternalLoader(t){const e=this.hls.config,s=e.pLoader,i=e.loader,n=s||i,r=new n(e);return this.loaders[t.type]=r,r}getInternalLoader(t){return this.loaders[t.type]}resetInternalLoader(t){this.loaders[t]&&delete this.loaders[t]}destroyInternalLoaders(){for(const t in this.loaders){const e=this.loaders[t];e&&e.destroy(),this.resetInternalLoader(t)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(t,e){const{url:s}=e;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:z.MANIFEST,url:s,deliveryDirectives:null,levelOrTrack:null})}onLevelLoading(t,e){const{id:s,level:i,pathwayId:n,url:r,deliveryDirectives:a,levelInfo:c}=e;this.load({id:s,level:i,pathwayId:n,responseType:"text",type:z.LEVEL,url:r,deliveryDirectives:a,levelOrTrack:c})}onAudioTrackLoading(t,e){const{id:s,groupId:i,url:n,deliveryDirectives:r,track:a}=e;this.load({id:s,groupId:i,level:null,responseType:"text",type:z.AUDIO_TRACK,url:n,deliveryDirectives:r,levelOrTrack:a})}onSubtitleTrackLoading(t,e){const{id:s,groupId:i,url:n,deliveryDirectives:r,track:a}=e;this.load({id:s,groupId:i,level:null,responseType:"text",type:z.SUBTITLE_TRACK,url:n,deliveryDirectives:r,levelOrTrack:a})}onLevelsUpdated(t,e){const s=this.loaders[z.LEVEL];if(s){const i=s.context;i&&!e.levels.some(n=>n===i.levelOrTrack)&&(s.abort(),delete this.loaders[z.LEVEL])}}load(t){var e;const s=this.hls.config;let i=this.getInternalLoader(t);if(i){const l=this.hls.logger,h=i.context;if(h&&h.levelOrTrack===t.levelOrTrack&&(h.url===t.url||h.deliveryDirectives&&!t.deliveryDirectives)){h.url===t.url?l.log(`[playlist-loader]: ignore ${t.url} ongoing request`):l.log(`[playlist-loader]: ignore ${t.url} in favor of ${h.url}`);return}l.log(`[playlist-loader]: aborting previous loader for type: ${t.type}`),i.abort()}let n;if(t.type===z.MANIFEST?n=s.manifestLoadPolicy.default:n=rt({},s.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),i=this.createInternalLoader(t),K((e=t.deliveryDirectives)==null?void 0:e.part)){let l;if(t.type===z.LEVEL&&t.level!==null?l=this.hls.levels[t.level].details:t.type===z.AUDIO_TRACK&&t.id!==null?l=this.hls.audioTracks[t.id].details:t.type===z.SUBTITLE_TRACK&&t.id!==null&&(l=this.hls.subtitleTracks[t.id].details),l){const h=l.partTarget,A=l.targetduration;if(h&&A){const u=Math.max(h*3,A*.8)*1e3;n=rt({},n,{maxTimeToFirstByteMs:Math.min(u,n.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(u,n.maxTimeToFirstByteMs)})}}}const r=n.errorRetry||n.timeoutRetry||{},a={loadPolicy:n,timeout:n.maxLoadTimeMs,maxRetry:r.maxNumRetry||0,retryDelay:r.retryDelayMs||0,maxRetryDelay:r.maxRetryDelayMs||0},c={onSuccess:(l,h,A,u)=>{const d=this.getInternalLoader(A);this.resetInternalLoader(A.type);const f=l.data;h.parsing.start=performance.now(),ue.isMediaPlaylist(f)||A.type!==z.MANIFEST?this.handleTrackOrLevelPlaylist(l,h,A,u||null,d):this.handleMasterPlaylist(l,h,A,u)},onError:(l,h,A,u)=>{this.handleNetworkError(h,A,!1,l,u)},onTimeout:(l,h,A)=>{this.handleNetworkError(h,A,!0,void 0,l)}};i.load(t,a,c)}checkAutostartLoad(){if(!this.hls)return;const{config:{autoStartLoad:t,startPosition:e},forceStartLoad:s}=this.hls;(t||s)&&(this.hls.logger.log(`${t?"auto":"force"} startLoad with configured startPosition ${e}`),this.hls.startLoad(e))}handleMasterPlaylist(t,e,s,i){const n=this.hls,r=t.data,a=Fn(t,s),c=ue.parseMasterPlaylist(r,a);if(c.playlistParsingError){e.parsing.end=performance.now(),this.handleManifestParsingError(t,s,c.playlistParsingError,i,e);return}const{contentSteering:l,levels:h,sessionData:A,sessionKeys:u,startTimeOffset:d,variableList:f}=c;this.variableList=f,h.forEach(p=>{const{unknownCodecs:I}=p;if(I){const{preferManagedMediaSource:C}=this.hls.config;let{audioCodec:S,videoCodec:v}=p;for(let T=I.length;T--;){const x=I[T];Ys(x,"audio",C)?(p.audioCodec=S=S?`${S},${x}`:x,ys.audio[S.substring(0,4)]=2,I.splice(T,1)):Ys(x,"video",C)&&(p.videoCodec=v=v?`${v},${x}`:x,ys.video[v.substring(0,4)]=2,I.splice(T,1))}}});const{AUDIO:g=[],SUBTITLES:m,"CLOSED-CAPTIONS":E}=ue.parseMasterPlaylistMedia(r,a,c);g.length&&!g.some(I=>!I.url)&&h[0].audioCodec&&!h[0].attrs.AUDIO&&(this.hls.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),g.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new ct({}),bitrate:0,url:""})),n.trigger(y.MANIFEST_LOADED,{levels:h,audioTracks:g,subtitles:m,captions:E,contentSteering:l,url:a,stats:e,networkDetails:i,sessionData:A,sessionKeys:u,startTimeOffset:d,variableList:f})}handleTrackOrLevelPlaylist(t,e,s,i,n){const r=this.hls,{id:a,level:c,type:l}=s,h=Fn(t,s),A=K(c)?c:K(a)?a:0,u=Ha(s),d=ue.parseLevelPlaylist(t.data,h,A,u,0,this.variableList);if(l===z.MANIFEST){const f={attrs:new ct({}),bitrate:0,details:d,name:"",url:h};d.requestScheduled=e.loading.start+dc(d,0),r.trigger(y.MANIFEST_LOADED,{levels:[f],audioTracks:[],url:h,stats:e,networkDetails:i,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}e.parsing.end=performance.now(),s.levelDetails=d,this.handlePlaylistLoaded(d,t,e,s,i,n)}handleManifestParsingError(t,e,s,i,n){this.hls.trigger(y.ERROR,{type:V.NETWORK_ERROR,details:w.MANIFEST_PARSING_ERROR,fatal:e.type===z.MANIFEST,url:t.url,err:s,error:s,reason:s.message,response:t,context:e,networkDetails:i,stats:n})}handleNetworkError(t,e,s=!1,i,n){let r=`A network ${s?"timeout":"error"+(i?" (status "+i.code+")":"")} occurred while loading ${t.type}`;t.type===z.LEVEL?r+=`: ${t.level} id: ${t.id}`:(t.type===z.AUDIO_TRACK||t.type===z.SUBTITLE_TRACK)&&(r+=` id: ${t.id} group-id: "${t.groupId}"`);const a=new Error(r);this.hls.logger.warn(`[playlist-loader]: ${r}`);let c=w.UNKNOWN,l=!1;const h=this.getInternalLoader(t);switch(t.type){case z.MANIFEST:c=s?w.MANIFEST_LOAD_TIMEOUT:w.MANIFEST_LOAD_ERROR,l=!0;break;case z.LEVEL:c=s?w.LEVEL_LOAD_TIMEOUT:w.LEVEL_LOAD_ERROR,l=!1;break;case z.AUDIO_TRACK:c=s?w.AUDIO_TRACK_LOAD_TIMEOUT:w.AUDIO_TRACK_LOAD_ERROR,l=!1;break;case z.SUBTITLE_TRACK:c=s?w.SUBTITLE_TRACK_LOAD_TIMEOUT:w.SUBTITLE_LOAD_ERROR,l=!1;break}h&&this.resetInternalLoader(t.type);const A={type:V.NETWORK_ERROR,details:c,fatal:l,url:t.url,loader:h,context:t,error:a,networkDetails:e,stats:n};if(i){const u=e?.url||t.url;A.response=it({url:u,data:void 0},i)}this.hls.trigger(y.ERROR,A)}handlePlaylistLoaded(t,e,s,i,n,r){const a=this.hls,{type:c,level:l,levelOrTrack:h,id:A,groupId:u,deliveryDirectives:d}=i,f=Fn(e,i),g=Ha(i);let m=typeof i.level=="number"&&g===H.MAIN?l:void 0;const E=t.playlistParsingError;if(E){if(this.hls.logger.warn(`${E} ${t.url}`),!a.config.ignorePlaylistParsingErrors){a.trigger(y.ERROR,{type:V.NETWORK_ERROR,details:w.LEVEL_PARSING_ERROR,fatal:!1,url:f,error:E,reason:E.message,response:e,context:i,level:m,parent:g,networkDetails:n,stats:s});return}t.playlistParsingError=null}if(!t.fragments.length){const p=t.playlistParsingError=new Error("No Segments found in Playlist");a.trigger(y.ERROR,{type:V.NETWORK_ERROR,details:w.LEVEL_EMPTY_ERROR,fatal:!1,url:f,error:p,reason:p.message,response:e,context:i,level:m,parent:g,networkDetails:n,stats:s});return}switch(t.live&&r&&(r.getCacheAge&&(t.ageHeader=r.getCacheAge()||0),(!r.getCacheAge||isNaN(t.ageHeader))&&(t.ageHeader=0)),c){case z.MANIFEST:case z.LEVEL:if(m){if(!h)m=0;else if(h!==a.levels[m]){const p=a.levels.indexOf(h);p>-1&&(m=p)}}a.trigger(y.LEVEL_LOADED,{details:t,levelInfo:h||a.levels[0],level:m||0,id:A||0,stats:s,networkDetails:n,deliveryDirectives:d,withoutMultiVariant:c===z.MANIFEST});break;case z.AUDIO_TRACK:a.trigger(y.AUDIO_TRACK_LOADED,{details:t,track:h,id:A||0,groupId:u||"",stats:s,networkDetails:n,deliveryDirectives:d});break;case z.SUBTITLE_TRACK:a.trigger(y.SUBTITLE_TRACK_LOADED,{details:t,track:h,id:A||0,groupId:u||"",stats:s,networkDetails:n,deliveryDirectives:d});break}}}class he{static get version(){return Js}static isMSESupported(){return uh()}static isSupported(){return ip()}static getMediaSource(){return Pe()}static get Events(){return y}static get MetadataSchema(){return Kt}static get ErrorTypes(){return V}static get ErrorDetails(){return w}static get DefaultConfig(){return he.defaultConfig?he.defaultConfig:Vm}static set DefaultConfig(t){he.defaultConfig=t}constructor(t={}){this.config=void 0,this.userConfig=void 0,this.logger=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new Wr,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioStreamController=void 0,this.subtititleStreamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.interstitialsController=void 0,this.gapController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this._url=null,this._sessionId=void 0,this.triggeringException=void 0,this.started=!1;const e=this.logger=du(t.debug||!1,"Hls instance",t.assetPlayerId),s=this.config=qm(he.DefaultConfig,t,e);this.userConfig=t,s.progressive&&Wm(s,e);const{abrController:i,bufferController:n,capLevelController:r,errorController:a,fpsController:c}=s,l=new a(this),h=this.abrController=new i(this),A=new ld(this),u=s.interstitialsController,d=u?this.interstitialsController=new u(this,he):null,f=this.bufferController=new n(this,A),g=this.capLevelController=new r(this),m=new c(this),E=new lp(this),p=s.contentSteeringController,I=p?new p(this):null,C=this.levelController=new sp(this,I),S=new tp(this),v=new ap(this.config,this.logger),T=this.streamController=new op(this,A,v),x=this.gapController=new zm(this,A);g.setStreamController(T),m.setStreamController(T);const L=[E,C,T];d&&L.splice(1,0,d),I&&L.splice(1,0,I),this.networkControllers=L;const B=[h,f,x,g,m,S,A];this.audioTrackController=this.createController(s.audioTrackController,L);const D=s.audioStreamController;D&&L.push(this.audioStreamController=new D(this,A,v)),this.subtitleTrackController=this.createController(s.subtitleTrackController,L);const R=s.subtitleStreamController;R&&L.push(this.subtititleStreamController=new R(this,A,v)),this.createController(s.timelineController,B),v.emeController=this.emeController=this.createController(s.emeController,B),this.cmcdController=this.createController(s.cmcdController,B),this.latencyController=this.createController(ep,B),this.coreComponents=B,L.push(l);const k=l.onErrorOut;typeof k=="function"&&this.on(y.ERROR,k,l),this.on(y.MANIFEST_LOADED,E.onManifestLoaded,E)}createController(t,e){if(t){const s=new t(this);return e&&e.push(s),s}return null}on(t,e,s=this){this._emitter.on(t,e,s)}once(t,e,s=this){this._emitter.once(t,e,s)}removeAllListeners(t){this._emitter.removeAllListeners(t)}off(t,e,s=this,i){this._emitter.off(t,e,s,i)}listeners(t){return this._emitter.listeners(t)}emit(t,e,s){return this._emitter.emit(t,e,s)}trigger(t,e){if(this.config.debug)return this.emit(t,t,e);try{return this.emit(t,t,e)}catch(s){if(this.logger.error("An internal error happened while handling event "+t+'. Error message: "'+s.message+'". Here is a stacktrace:',s),!this.triggeringException){this.triggeringException=!0;const i=t===y.ERROR;this.trigger(y.ERROR,{type:V.OTHER_ERROR,details:w.INTERNAL_EXCEPTION,fatal:i,event:t,error:s}),this.triggeringException=!1}}return!1}listenerCount(t){return this._emitter.listenerCount(t)}destroy(){this.logger.log("destroy"),this.trigger(y.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this._url=null,this.networkControllers.forEach(e=>e.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(e=>e.destroy()),this.coreComponents.length=0;const t=this.config;t.xhrSetup=t.fetchSetup=void 0,this.userConfig=null}attachMedia(t){if(!t||"media"in t&&!t.media){const n=new Error(`attachMedia failed: invalid argument (${t})`);this.trigger(y.ERROR,{type:V.OTHER_ERROR,details:w.ATTACH_MEDIA_ERROR,fatal:!0,error:n});return}this.logger.log("attachMedia"),this._media&&(this.logger.warn("media must be detached before attaching"),this.detachMedia());const e="media"in t,s=e?t.media:t,i=e?t:{media:s};this._media=s,this.trigger(y.MEDIA_ATTACHING,i)}detachMedia(){this.logger.log("detachMedia"),this.trigger(y.MEDIA_DETACHING,{}),this._media=null}transferMedia(){this._media=null;const t=this.bufferController.transferMedia();return this.trigger(y.MEDIA_DETACHING,{transferMedia:t}),t}loadSource(t){this.stopLoad();const e=this.media,s=this._url,i=this._url=Mr.buildAbsoluteURL(self.location.href,t,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.logger.log(`loadSource:${i}`),e&&s&&(s!==i||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(e)),this.trigger(y.MANIFEST_LOADING,{url:t})}get url(){return this._url}get hasEnoughToStart(){return this.streamController.hasEnoughToStart}get startPosition(){return this.streamController.startPositionValue}startLoad(t=-1,e){this.logger.log(`startLoad(${t+(e?", <skip seek to start>":"")})`),this.started=!0,this.resumeBuffering();for(let s=0;s<this.networkControllers.length&&(this.networkControllers[s].startLoad(t,e),!(!this.started||!this.networkControllers));s++);}stopLoad(){this.logger.log("stopLoad"),this.started=!1;for(let t=0;t<this.networkControllers.length&&(this.networkControllers[t].stopLoad(),!(this.started||!this.networkControllers));t++);}get loadingEnabled(){return this.started}get bufferingEnabled(){return this.streamController.bufferingEnabled}resumeBuffering(){this.bufferingEnabled||(this.logger.log("resume buffering"),this.networkControllers.forEach(t=>{t.resumeBuffering&&t.resumeBuffering()}))}pauseBuffering(){this.bufferingEnabled&&(this.logger.log("pause buffering"),this.networkControllers.forEach(t=>{t.pauseBuffering&&t.pauseBuffering()}))}get inFlightFragments(){const t={[H.MAIN]:this.streamController.inFlightFrag};return this.audioStreamController&&(t[H.AUDIO]=this.audioStreamController.inFlightFrag),this.subtititleStreamController&&(t[H.SUBTITLE]=this.subtititleStreamController.inFlightFrag),t}swapAudioCodec(){this.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){this.logger.log("recoverMediaError");const t=this._media,e=t?.currentTime;this.detachMedia(),t&&(this.attachMedia(t),e&&this.startLoad(e))}removeLevel(t){this.levelController.removeLevel(t)}get sessionId(){let t=this._sessionId;return t||(t=this._sessionId=zg()),t}get levels(){const t=this.levelController.levels;return t||[]}get latestLevelDetails(){return this.streamController.getLevelDetails()||null}get loadLevelObj(){return this.levelController.loadLevelObj}get currentLevel(){return this.streamController.currentLevel}set currentLevel(t){this.logger.log(`set currentLevel:${t}`),this.levelController.manualLevel=t,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(t){this.logger.log(`set nextLevel:${t}`),this.levelController.manualLevel=t,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(t){this.logger.log(`set loadLevel:${t}`),this.levelController.manualLevel=t}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(t){this.levelController.nextLoadLevel=t}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(t){this.logger.log(`set firstLevel:${t}`),this.levelController.firstLevel=t}get startLevel(){const t=this.levelController.startLevel;return t===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:t}set startLevel(t){this.logger.log(`set startLevel:${t}`),t!==-1&&(t=Math.max(t,this.minAutoLevel)),this.levelController.startLevel=t}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(t){const e=!!t;e!==this.config.capLevelToPlayerSize&&(e?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=e)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:t}=this.abrController;return t?t.getEstimate():NaN}set bandwidthEstimate(t){this.abrController.resetEstimator(t)}get abrEwmaDefaultEstimate(){const{bwEstimator:t}=this.abrController;return t?t.defaultEstimate:NaN}get ttfbEstimate(){const{bwEstimator:t}=this.abrController;return t?t.getEstimateTTFB():NaN}set autoLevelCapping(t){this._autoLevelCapping!==t&&(this.logger.log(`set autoLevelCapping:${t}`),this._autoLevelCapping=t,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(t){Yu(t)&&this._maxHdcpLevel!==t&&(this._maxHdcpLevel=t,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:t,config:{minAutoBitrate:e}}=this;if(!t)return 0;const s=t.length;for(let i=0;i<s;i++)if(t[i].maxBitrate>=e)return i;return 0}get maxAutoLevel(){const{levels:t,autoLevelCapping:e,maxHdcpLevel:s}=this;let i;if(e===-1&&t!=null&&t.length?i=t.length-1:i=e,s)for(let n=i;n--;){const r=t[n].attrs["HDCP-LEVEL"];if(r&&r<=s)return n}return i}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(t){this.abrController.nextAutoLevel=t}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get maxBufferLength(){return this.streamController.maxBufferLength}setAudioOption(t){var e;return((e=this.audioTrackController)==null?void 0:e.setAudioOption(t))||null}setSubtitleOption(t){var e;return((e=this.subtitleTrackController)==null?void 0:e.setSubtitleOption(t))||null}get allAudioTracks(){const t=this.audioTrackController;return t?t.allAudioTracks:[]}get audioTracks(){const t=this.audioTrackController;return t?t.audioTracks:[]}get audioTrack(){const t=this.audioTrackController;return t?t.audioTrack:-1}set audioTrack(t){const e=this.audioTrackController;e&&(e.audioTrack=t)}get allSubtitleTracks(){const t=this.subtitleTrackController;return t?t.allSubtitleTracks:[]}get subtitleTracks(){const t=this.subtitleTrackController;return t?t.subtitleTracks:[]}get subtitleTrack(){const t=this.subtitleTrackController;return t?t.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(t){const e=this.subtitleTrackController;e&&(e.subtitleTrack=t)}get subtitleDisplay(){const t=this.subtitleTrackController;return t?t.subtitleDisplay:!1}set subtitleDisplay(t){const e=this.subtitleTrackController;e&&(e.subtitleDisplay=t)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(t){this.config.lowLatencyMode=t}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}set targetLatency(t){this.latencyController.targetLatency=t}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}get pathways(){return this.levelController.pathways}get pathwayPriority(){return this.levelController.pathwayPriority}set pathwayPriority(t){this.levelController.pathwayPriority=t}get bufferedToEnd(){var t;return!!((t=this.bufferController)!=null&&t.bufferedToEnd)}get interstitialsManager(){var t;return((t=this.interstitialsController)==null?void 0:t.interstitialsManager)||null}getMediaDecodingInfo(t,e=this.allAudioTracks){const s=zl(e);return jl(t,s,navigator.mediaCapabilities)}}he.defaultConfig=void 0;const cp="modulepreload",hp=function(o){return"/three-video-projection/"+o},Va={},Ap=function(t,e,s){let i=Promise.resolve();if(e&&e.length>0){let c=function(l){return Promise.all(l.map(h=>Promise.resolve(h).then(A=>({status:"fulfilled",value:A}),A=>({status:"rejected",reason:A}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),a=r?.nonce||r?.getAttribute("nonce");i=c(e.map(l=>{if(l=hp(l),l in Va)return;Va[l]=!0;const h=l.endsWith(".css"),A=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${A}`))return;const u=document.createElement("link");if(u.rel=h?"stylesheet":cp,h||(u.as="script"),u.crossOrigin="",u.href=l,a&&u.setAttribute("nonce",a),document.head.appendChild(u),h)return new Promise((d,f)=>{u.addEventListener("load",d),u.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${l}`)))})}))}function n(r){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=r,window.dispatchEvent(a),!a.defaultPrevented)throw r}return i.then(r=>{for(const a of r||[])a.status==="rejected"&&n(a.reason);return t().catch(n)})},dh=0,up=1,dp=2,Ya=2,Qn=1.25,qa=1,bt=32,It=bt/4,fh=65535,Gi=Math.pow(2,-24),ao=Symbol("SKIP_GENERATION"),gh={strategy:dh,maxDepth:40,maxLeafSize:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null,[ao]:!1};function ht(o,t,e){return e.min.x=t[o],e.min.y=t[o+1],e.min.z=t[o+2],e.max.x=t[o+3],e.max.y=t[o+4],e.max.z=t[o+5],e}function Wa(o){let t=-1,e=-1/0;for(let s=0;s<3;s++){const i=o[s+3]-o[s];i>e&&(e=i,t=s)}return t}function Ja(o,t){t.set(o)}function ja(o,t,e){let s,i;for(let n=0;n<3;n++){const r=n+3;s=o[n],i=t[n],e[n]=s<i?s:i,s=o[r],i=t[r],e[r]=s>i?s:i}}function mi(o,t,e){for(let s=0;s<3;s++){const i=t[o+2*s],n=t[o+2*s+1],r=i-n,a=i+n;r<e[s]&&(e[s]=r),a>e[s+3]&&(e[s+3]=a)}}function vs(o){const t=o[3]-o[0],e=o[4]-o[1],s=o[5]-o[2];return 2*(t*e+e*s+s*t)}function yt(o,t){return t[o+15]===fh}function wt(o,t){return t[o+6]}function Pt(o,t){return t[o+14]}function Tt(o){return o+It}function Bt(o,t){const e=t[o+6];return o+e*It}function lo(o,t){return t[o+7]}function Mn(o,t,e,s,i){let n=1/0,r=1/0,a=1/0,c=-1/0,l=-1/0,h=-1/0,A=1/0,u=1/0,d=1/0,f=-1/0,g=-1/0,m=-1/0;const E=o.offset||0;for(let p=(t-E)*6,I=(t+e-E)*6;p<I;p+=6){const C=o[p+0],S=o[p+1],v=C-S,T=C+S;v<n&&(n=v),T>c&&(c=T),C<A&&(A=C),C>f&&(f=C);const x=o[p+2],L=o[p+3],B=x-L,D=x+L;B<r&&(r=B),D>l&&(l=D),x<u&&(u=x),x>g&&(g=x);const R=o[p+4],k=o[p+5],_=R-k,Q=R+k;_<a&&(a=_),Q>h&&(h=Q),R<d&&(d=R),R>m&&(m=R)}s[0]=n,s[1]=r,s[2]=a,s[3]=c,s[4]=l,s[5]=h,i[0]=A,i[1]=u,i[2]=d,i[3]=f,i[4]=g,i[5]=m}const Ee=32,fp=(o,t)=>o.candidate-t.candidate,ve=new Array(Ee).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),pi=new Float32Array(6);function gp(o,t,e,s,i,n){let r=-1,a=0;if(n===dh)r=Wa(t),r!==-1&&(a=(t[r]+t[r+3])/2);else if(n===up)r=Wa(o),r!==-1&&(a=mp(e,s,i,r));else if(n===dp){const c=vs(o);let l=Qn*i;const h=e.offset||0,A=(s-h)*6,u=(s+i-h)*6;for(let d=0;d<3;d++){const f=t[d],E=(t[d+3]-f)/Ee;if(i<Ee/4){const p=[...ve];p.length=i;let I=0;for(let S=A;S<u;S+=6,I++){const v=p[I];v.candidate=e[S+2*d],v.count=0;const{bounds:T,leftCacheBounds:x,rightCacheBounds:L}=v;for(let B=0;B<3;B++)L[B]=1/0,L[B+3]=-1/0,x[B]=1/0,x[B+3]=-1/0,T[B]=1/0,T[B+3]=-1/0;mi(S,e,T)}p.sort(fp);let C=i;for(let S=0;S<C;S++){const v=p[S];for(;S+1<C&&p[S+1].candidate===v.candidate;)p.splice(S+1,1),C--}for(let S=A;S<u;S+=6){const v=e[S+2*d];for(let T=0;T<C;T++){const x=p[T];v>=x.candidate?mi(S,e,x.rightCacheBounds):(mi(S,e,x.leftCacheBounds),x.count++)}}for(let S=0;S<C;S++){const v=p[S],T=v.count,x=i-v.count,L=v.leftCacheBounds,B=v.rightCacheBounds;let D=0;T!==0&&(D=vs(L)/c);let R=0;x!==0&&(R=vs(B)/c);const k=qa+Qn*(D*T+R*x);k<l&&(r=d,l=k,a=v.candidate)}}else{for(let C=0;C<Ee;C++){const S=ve[C];S.count=0,S.candidate=f+E+C*E;const v=S.bounds;for(let T=0;T<3;T++)v[T]=1/0,v[T+3]=-1/0}for(let C=A;C<u;C+=6){let T=~~((e[C+2*d]-f)/E);T>=Ee&&(T=Ee-1);const x=ve[T];x.count++,mi(C,e,x.bounds)}const p=ve[Ee-1];Ja(p.bounds,p.rightCacheBounds);for(let C=Ee-2;C>=0;C--){const S=ve[C],v=ve[C+1];ja(S.bounds,v.rightCacheBounds,S.rightCacheBounds)}let I=0;for(let C=0;C<Ee-1;C++){const S=ve[C],v=S.count,T=S.bounds,L=ve[C+1].rightCacheBounds;v!==0&&(I===0?Ja(T,pi):ja(T,pi,pi)),I+=v;let B=0,D=0;I!==0&&(B=vs(pi)/c);const R=i-I;R!==0&&(D=vs(L)/c);const k=qa+Qn*(B*I+D*R);k<l&&(r=d,l=k,a=S.candidate)}}}}else console.warn(`BVH: Invalid build strategy value ${n} used.`);return{axis:r,pos:a}}function mp(o,t,e,s){let i=0;const n=o.offset;for(let r=t,a=t+e;r<a;r++)i+=o[(r-n)*6+s*2];return i/e}class On{constructor(){this.boundingData=new Float32Array(6)}}function pp(o,t,e,s,i,n){let r=s,a=s+i-1;const c=n.pos,l=n.axis*2,h=e.offset||0;for(;;){for(;r<=a&&e[(r-h)*6+l]<c;)r++;for(;r<=a&&e[(a-h)*6+l]>=c;)a--;if(r<a){for(let A=0;A<t;A++){let u=o[r*t+A];o[r*t+A]=o[a*t+A],o[a*t+A]=u}for(let A=0;A<6;A++){const u=r-h,d=a-h,f=e[u*6+A];e[u*6+A]=e[d*6+A],e[d*6+A]=f}r++,a--}else return r}}let mh,Ki,Br,ph;const Ep=Math.pow(2,32);function xr(o){return"count"in o?1:1+xr(o.left)+xr(o.right)}function Ip(o,t,e){return mh=new Float32Array(e),Ki=new Uint32Array(e),Br=new Uint16Array(e),ph=new Uint8Array(e),vr(o,t)}function vr(o,t){const e=o/4,s=o/2,i="count"in t,n=t.boundingData;for(let r=0;r<6;r++)mh[e+r]=n[r];if(i)return t.buffer?(ph.set(new Uint8Array(t.buffer),o),o+t.buffer.byteLength):(Ki[e+6]=t.offset,Br[s+14]=t.count,Br[s+15]=fh,o+bt);{const{left:r,right:a,splitAxis:c}=t,l=o+bt;let h=vr(l,r);const A=o/bt,d=h/bt-A;if(d>Ep)throw new Error("MeshBVH: Cannot store relative child node offset greater than 32 bits.");return Ki[e+6]=d,Ki[e+7]=c,vr(h,a)}}function yp(o,t,e,s,i){const{maxDepth:n,verbose:r,maxLeafSize:a,strategy:c,onProgress:l}=i,h=o.primitiveBuffer,A=o.primitiveBufferStride,u=new Float32Array(6);let d=!1;const f=new On;return Mn(t,e,s,f.boundingData,u),m(f,e,s,u),f;function g(E){l&&l(E/s)}function m(E,p,I,C=null,S=0){if(!d&&S>=n&&(d=!0,r&&console.warn(`BVH: Max depth of ${n} reached when generating BVH. Consider increasing maxDepth.`)),I<=a||S>=n)return g(p+I),E.offset=p,E.count=I,E;const v=gp(E.boundingData,C,t,p,I,c);if(v.axis===-1)return g(p+I),E.offset=p,E.count=I,E;const T=pp(h,A,t,p,I,v);if(T===p||T===p+I)g(p+I),E.offset=p,E.count=I;else{E.splitAxis=v.axis;const x=new On,L=p,B=T-p;E.left=x,Mn(t,L,B,x.boundingData,u),m(x,L,B,u,S+1);const D=new On,R=T,k=I-B;E.right=D,Mn(t,R,k,D.boundingData,u),m(D,R,k,u,S+1)}return E}}function Cp(o,t){const e=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,s=o.getRootRanges(t.range),i=s[0],n=s[s.length-1],r={offset:i.offset,count:n.offset+n.count-i.offset},a=new Float32Array(6*r.count);a.offset=r.offset,o.computePrimitiveBounds(r.offset,r.count,a),o._roots=s.map(c=>{const l=yp(o,a,c.offset,c.count,t),h=xr(l),A=new e(bt*h);return Ip(0,l,A),A})}class co{constructor(t){this._getNewPrimitive=t,this._primitives=[]}getPrimitive(){const t=this._primitives;return t.length===0?this._getNewPrimitive():t.pop()}releasePrimitive(t){this._primitives.push(t)}}class Sp{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const t=[];let e=null;this.setBuffer=s=>{e&&t.push(e),e=s,this.float32Array=new Float32Array(s),this.uint16Array=new Uint16Array(s),this.uint32Array=new Uint32Array(s)},this.clearBuffer=()=>{e=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,t.length!==0&&this.setBuffer(t.pop())}}}const lt=new Sp;let be,gs;const es=[],Ei=new co(()=>new Xt);function Tp(o,t,e,s,i,n){be=Ei.getPrimitive(),gs=Ei.getPrimitive(),es.push(be,gs),lt.setBuffer(o._roots[t]);const r=Lr(0,o.geometry,e,s,i,n);lt.clearBuffer(),Ei.releasePrimitive(be),Ei.releasePrimitive(gs),es.pop(),es.pop();const a=es.length;return a>0&&(gs=es[a-1],be=es[a-2]),r}function Lr(o,t,e,s,i=null,n=0,r=0){const{float32Array:a,uint16Array:c,uint32Array:l}=lt;let h=o*2;if(yt(h,c)){const u=wt(o,l),d=Pt(h,c);return ht(o,a,be),s(u,d,!1,r,n+o/It,be)}else{let B=function(R){const{uint16Array:k,uint32Array:_}=lt;let Q=R*2;for(;!yt(Q,k);)R=Tt(R),Q=R*2;return wt(R,_)},D=function(R){const{uint16Array:k,uint32Array:_}=lt;let Q=R*2;for(;!yt(Q,k);)R=Bt(R,_),Q=R*2;return wt(R,_)+Pt(Q,k)};const u=Tt(o),d=Bt(o,l);let f=u,g=d,m,E,p,I;if(i&&(p=be,I=gs,ht(f,a,p),ht(g,a,I),m=i(p),E=i(I),E<m)){f=d,g=u;const R=m;m=E,E=R,p=I}p||(p=be,ht(f,a,p));const C=yt(f*2,c),S=e(p,C,m,r+1,n+f/It);let v;if(S===Ya){const R=B(f),_=D(f)-R;v=s(R,_,!0,r+1,n+f/It,p)}else v=S&&Lr(f,t,e,s,i,n,r+1);if(v)return!0;I=gs,ht(g,a,I);const T=yt(g*2,c),x=e(I,T,E,r+1,n+g/It);let L;if(x===Ya){const R=B(g),_=D(g)-R;L=s(R,_,!0,r+1,n+g/It,I)}else L=x&&Lr(g,t,e,s,i,n,r+1);return!!L}}const Hs=new lt.constructor,sn=new lt.constructor,Re=new co(()=>new Xt),ss=new Xt,is=new Xt,Un=new Xt,Nn=new Xt;let Gn=!1;function Bp(o,t,e,s){if(Gn)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");Gn=!0;const i=o._roots,n=t._roots;let r,a=0,c=0;const l=new ie().copy(e).invert();for(let h=0,A=i.length;h<A;h++){Hs.setBuffer(i[h]),c=0;const u=Re.getPrimitive();ht(0,Hs.float32Array,u),u.applyMatrix4(l);for(let d=0,f=n.length;d<f&&(sn.setBuffer(n[d]),r=ee(0,0,e,l,s,a,c,0,0,u),sn.clearBuffer(),c+=n[d].byteLength/bt,!r);d++);if(Re.releasePrimitive(u),Hs.clearBuffer(),a+=i[h].byteLength/bt,r)break}return Gn=!1,r}function ee(o,t,e,s,i,n=0,r=0,a=0,c=0,l=null,h=!1){let A,u;h?(A=sn,u=Hs):(A=Hs,u=sn);const d=A.float32Array,f=A.uint32Array,g=A.uint16Array,m=u.float32Array,E=u.uint32Array,p=u.uint16Array,I=o*2,C=t*2,S=yt(I,g),v=yt(C,p);let T=!1;if(v&&S)h?T=i(wt(t,E),Pt(t*2,p),wt(o,f),Pt(o*2,g),c,r+t/It,a,n+o/It):T=i(wt(o,f),Pt(o*2,g),wt(t,E),Pt(t*2,p),a,n+o/It,c,r+t/It);else if(v){const x=Re.getPrimitive();ht(t,m,x),x.applyMatrix4(e);const L=Tt(o),B=Bt(o,f);ht(L,d,ss),ht(B,d,is);const D=x.intersectsBox(ss),R=x.intersectsBox(is);T=D&&ee(t,L,s,e,i,r,n,c,a+1,x,!h)||R&&ee(t,B,s,e,i,r,n,c,a+1,x,!h),Re.releasePrimitive(x)}else{const x=Tt(t),L=Bt(t,E);ht(x,m,Un),ht(L,m,Nn);const B=l.intersectsBox(Un),D=l.intersectsBox(Nn);if(B&&D)T=ee(o,x,e,s,i,n,r,a,c+1,l,h)||ee(o,L,e,s,i,n,r,a,c+1,l,h);else if(B)if(S)T=ee(o,x,e,s,i,n,r,a,c+1,l,h);else{const R=Re.getPrimitive();R.copy(Un).applyMatrix4(e);const k=Tt(o),_=Bt(o,f);ht(k,d,ss),ht(_,d,is);const Q=R.intersectsBox(ss),F=R.intersectsBox(is);T=Q&&ee(x,k,s,e,i,r,n,c,a+1,R,!h)||F&&ee(x,_,s,e,i,r,n,c,a+1,R,!h),Re.releasePrimitive(R)}else if(D)if(S)T=ee(o,L,e,s,i,n,r,a,c+1,l,h);else{const R=Re.getPrimitive();R.copy(Nn).applyMatrix4(e);const k=Tt(o),_=Bt(o,f);ht(k,d,ss),ht(_,d,is);const Q=R.intersectsBox(ss),F=R.intersectsBox(is);T=Q&&ee(L,k,s,e,i,r,n,c,a+1,R,!h)||F&&ee(L,_,s,e,i,r,n,c,a+1,R,!h),Re.releasePrimitive(R)}}return T}const Xa=new Xt,ns=new Float32Array(6);class xp{constructor(){this._roots=null,this.primitiveBuffer=null,this.primitiveBufferStride=null}init(t){t={...gh,...t},Cp(this,t)}getRootRanges(){throw new Error("BVH: getRootRanges() not implemented")}writePrimitiveBounds(){throw new Error("BVH: writePrimitiveBounds() not implemented")}writePrimitiveRangeBounds(t,e,s,i){let n=1/0,r=1/0,a=1/0,c=-1/0,l=-1/0,h=-1/0;for(let A=t,u=t+e;A<u;A++){this.writePrimitiveBounds(A,ns,0);const[d,f,g,m,E,p]=ns;d<n&&(n=d),m>c&&(c=m),f<r&&(r=f),E>l&&(l=E),g<a&&(a=g),p>h&&(h=p)}return s[i+0]=n,s[i+1]=r,s[i+2]=a,s[i+3]=c,s[i+4]=l,s[i+5]=h,s}computePrimitiveBounds(t,e,s){const i=s.offset||0;for(let n=t,r=t+e;n<r;n++){this.writePrimitiveBounds(n,ns,0);const[a,c,l,h,A,u]=ns,d=(a+h)/2,f=(c+A)/2,g=(l+u)/2,m=(h-a)/2,E=(A-c)/2,p=(u-l)/2,I=(n-i)*6;s[I+0]=d,s[I+1]=m+(Math.abs(d)+m)*Gi,s[I+2]=f,s[I+3]=E+(Math.abs(f)+E)*Gi,s[I+4]=g,s[I+5]=p+(Math.abs(g)+p)*Gi}return s}shiftPrimitiveOffsets(t){const e=this._indirectBuffer;if(e)for(let s=0,i=e.length;s<i;s++)e[s]+=t;else{const s=this._roots;for(let i=0;i<s.length;i++){const n=s[i],r=new Uint32Array(n),a=new Uint16Array(n),c=n.byteLength/bt;for(let l=0;l<c;l++){const h=It*l,A=2*h;yt(A,a)&&(r[h+6]+=t)}}}}traverse(t,e=0){const s=this._roots[e],i=new Uint32Array(s),n=new Uint16Array(s);r(0);function r(a,c=0){const l=a*2,h=yt(l,n);if(h){const A=i[a+6],u=n[l+14];t(c,h,new Float32Array(s,a*4,6),A,u)}else{const A=Tt(a),u=Bt(a,i),d=lo(a,i);t(c,h,new Float32Array(s,a*4,6),d)||(r(A,c+1),r(u,c+1))}}}refit(){const t=this._roots;for(let e=0,s=t.length;e<s;e++){const i=t[e],n=new Uint32Array(i),r=new Uint16Array(i),a=new Float32Array(i),c=i.byteLength/bt;for(let l=c-1;l>=0;l--){const h=l*It,A=h*2;if(yt(A,r)){const d=wt(h,n),f=Pt(A,r);this.writePrimitiveRangeBounds(d,f,ns,0),a.set(ns,h)}else{const d=Tt(h),f=Bt(h,n);for(let g=0;g<3;g++){const m=a[d+g],E=a[d+g+3],p=a[f+g],I=a[f+g+3];a[h+g]=m<p?m:p,a[h+g+3]=E>I?E:I}}}}}getBoundingBox(t){return t.makeEmpty(),this._roots.forEach(s=>{ht(0,new Float32Array(s),Xa),t.union(Xa)}),t}shapecast(t){let{boundsTraverseOrder:e,intersectsBounds:s,intersectsRange:i,intersectsPrimitive:n,scratchPrimitive:r,iterate:a}=t;if(i&&n){const A=i;i=(u,d,f,g,m)=>A(u,d,f,g,m)?!0:a(u,d,this,n,f,g,r)}else i||(n?i=(A,u,d,f)=>a(A,u,this,n,d,f,r):i=(A,u,d)=>d);let c=!1,l=0;const h=this._roots;for(let A=0,u=h.length;A<u;A++){const d=h[A];if(c=Tp(this,A,s,i,e,l),c)break;l+=d.byteLength/bt}return c}bvhcast(t,e,s){let{intersectsRanges:i}=s;return Bp(this,t,e,i)}}function vp(){return typeof SharedArrayBuffer<"u"}function ho(o){return o.index?o.index.count:o.attributes.position.count}function an(o){return ho(o)/3}function Lp(o,t=ArrayBuffer){return o>65535?new Uint32Array(new t(4*o)):new Uint16Array(new t(2*o))}function Dp(o,t){if(!o.index){const e=o.attributes.position.count,s=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,i=Lp(e,s);o.setIndex(new ke(i,1));for(let n=0;n<e;n++)i[n]=n}}function Rp(o,t,e){const s=ho(o)/e,i=t||o.drawRange,n=i.start/e,r=(i.start+i.count)/e,a=Math.max(0,n),c=Math.min(s,r)-a;return{offset:Math.floor(a),count:Math.floor(c)}}function bp(o,t){return o.groups.map(e=>({offset:e.start/t,count:e.count/t}))}function za(o,t,e){const s=Rp(o,t,e),i=bp(o,e);if(!i.length)return[s];const n=[],r=s.offset,a=s.offset+s.count,c=ho(o)/e,l=[];for(const u of i){const{offset:d,count:f}=u,g=d,m=isFinite(f)?f:c-d,E=d+m;g<a&&E>r&&(l.push({pos:Math.max(r,g),isStart:!0}),l.push({pos:Math.min(a,E),isStart:!1}))}l.sort((u,d)=>u.pos!==d.pos?u.pos-d.pos:u.type==="end"?-1:1);let h=0,A=null;for(const u of l){const d=u.pos;h!==0&&d!==A&&n.push({offset:A,count:d-A}),h+=u.isStart?1:-1,A=d}return n}function wp(o,t){const e=o[o.length-1],s=e.offset+e.count>2**16,i=o.reduce((l,h)=>l+h.count,0),n=s?4:2,r=t?new SharedArrayBuffer(i*n):new ArrayBuffer(i*n),a=s?new Uint32Array(r):new Uint16Array(r);let c=0;for(let l=0;l<o.length;l++){const{offset:h,count:A}=o[l];for(let u=0;u<A;u++)a[c+u]=h+u;c+=A}return a}class kp extends xp{get indirect(){return!!this._indirectBuffer}get primitiveStride(){return null}get primitiveBufferStride(){return this.indirect?1:this.primitiveStride}set primitiveBufferStride(t){}get primitiveBuffer(){return this.indirect?this._indirectBuffer:this.geometry.index.array}set primitiveBuffer(t){}constructor(t,e={}){if(t.isBufferGeometry){if(t.index&&t.index.isInterleavedBufferAttribute)throw new Error("BVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("BVH: Only BufferGeometries are supported.");if(e.useSharedArrayBuffer&&!vp())throw new Error("BVH: SharedArrayBuffer is not available.");super(),this.geometry=t,this.resolvePrimitiveIndex=e.indirect?s=>this._indirectBuffer[s]:s=>s,this.primitiveBuffer=null,this.primitiveBufferStride=null,this._indirectBuffer=null,e={...gh,...e},e[ao]||this.init(e)}init(t){const{geometry:e,primitiveStride:s}=this;if(t.indirect){const i=za(e,t.range,s),n=wp(i,t.useSharedArrayBuffer);this._indirectBuffer=n}else Dp(e,t);super.init(t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new Xt))}getRootRanges(t){return this.indirect?[{offset:0,count:this._indirectBuffer.length}]:za(this.geometry,t,this.primitiveStride)}raycastObject3D(){throw new Error("BVH: raycastObject3D() not implemented")}}class Te{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(t,e){let s=1/0,i=-1/0;for(let n=0,r=t.length;n<r;n++){const c=t[n][e];s=c<s?c:s,i=c>i?c:i}this.min=s,this.max=i}setFromPoints(t,e){let s=1/0,i=-1/0;for(let n=0,r=e.length;n<r;n++){const a=e[n],c=t.dot(a);s=c<s?c:s,i=c>i?c:i}this.min=s,this.max=i}isSeparated(t){return this.min>t.max||t.min>this.max}}Te.prototype.setFromBox=(function(){const o=new U;return function(e,s){const i=s.min,n=s.max;let r=1/0,a=-1/0;for(let c=0;c<=1;c++)for(let l=0;l<=1;l++)for(let h=0;h<=1;h++){o.x=i.x*c+n.x*(1-c),o.y=i.y*l+n.y*(1-l),o.z=i.z*h+n.z*(1-h);const A=e.dot(o);r=Math.min(A,r),a=Math.max(A,a)}this.min=r,this.max=a}})();const _p=(function(){const o=new U,t=new U,e=new U;return function(i,n,r){const a=i.start,c=o,l=n.start,h=t;e.subVectors(a,l),o.subVectors(i.end,i.start),t.subVectors(n.end,n.start);const A=e.dot(h),u=h.dot(c),d=h.dot(h),f=e.dot(c),m=c.dot(c)*d-u*u;let E,p;m!==0?E=(A*u-f*d)/m:E=0,p=(A+E*u)/d,r.x=E,r.y=p}})(),Ao=(function(){const o=new _e,t=new U,e=new U;return function(i,n,r,a){_p(i,n,o);let c=o.x,l=o.y;if(c>=0&&c<=1&&l>=0&&l<=1){i.at(c,r),n.at(l,a);return}else if(c>=0&&c<=1){l<0?n.at(0,a):n.at(1,a),i.closestPointToPoint(a,!0,r);return}else if(l>=0&&l<=1){c<0?i.at(0,r):i.at(1,r),n.closestPointToPoint(r,!0,a);return}else{let h;c<0?h=i.start:h=i.end;let A;l<0?A=n.start:A=n.end;const u=t,d=e;if(i.closestPointToPoint(A,!0,t),n.closestPointToPoint(h,!0,e),u.distanceToSquared(A)<=d.distanceToSquared(h)){r.copy(u),a.copy(A);return}else{r.copy(h),a.copy(d);return}}}})(),Pp=(function(){const o=new U,t=new U,e=new pl,s=new ne;return function(n,r){const{radius:a,center:c}=n,{a:l,b:h,c:A}=r;if(s.start=l,s.end=h,s.closestPointToPoint(c,!0,o).distanceTo(c)<=a||(s.start=l,s.end=A,s.closestPointToPoint(c,!0,o).distanceTo(c)<=a)||(s.start=h,s.end=A,s.closestPointToPoint(c,!0,o).distanceTo(c)<=a))return!0;const g=r.getPlane(e);if(Math.abs(g.distanceToPoint(c))<=a){const E=g.projectPoint(c,t);if(r.containsPoint(E))return!0}return!1}})(),Fp=["x","y","z"],Se=1e-15,Za=Se*Se;function Yt(o){return Math.abs(o)<Se}class re extends hs{constructor(...t){super(...t),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new U),this.satBounds=new Array(4).fill().map(()=>new Te),this.points=[this.a,this.b,this.c],this.plane=new pl,this.isDegenerateIntoSegment=!1,this.isDegenerateIntoPoint=!1,this.degenerateSegment=new ne,this.needsUpdate=!0}intersectsSphere(t){return Pp(t,this)}update(){const t=this.a,e=this.b,s=this.c,i=this.points,n=this.satAxes,r=this.satBounds,a=n[0],c=r[0];this.getNormal(a),c.setFromPoints(a,i);const l=n[1],h=r[1];l.subVectors(t,e),h.setFromPoints(l,i);const A=n[2],u=r[2];A.subVectors(e,s),u.setFromPoints(A,i);const d=n[3],f=r[3];d.subVectors(s,t),f.setFromPoints(d,i);const g=l.length(),m=A.length(),E=d.length();this.isDegenerateIntoPoint=!1,this.isDegenerateIntoSegment=!1,g<Se?m<Se||E<Se?this.isDegenerateIntoPoint=!0:(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(t),this.degenerateSegment.end.copy(s)):m<Se?E<Se?this.isDegenerateIntoPoint=!0:(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(e),this.degenerateSegment.end.copy(t)):E<Se&&(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(s),this.degenerateSegment.end.copy(e)),this.plane.setFromNormalAndCoplanarPoint(a,t),this.needsUpdate=!1}}re.prototype.closestPointToSegment=(function(){const o=new U,t=new U,e=new ne;return function(i,n=null,r=null){const{start:a,end:c}=i,l=this.points;let h,A=1/0;for(let u=0;u<3;u++){const d=(u+1)%3;e.start.copy(l[u]),e.end.copy(l[d]),Ao(e,i,o,t),h=o.distanceToSquared(t),h<A&&(A=h,n&&n.copy(o),r&&r.copy(t))}return this.closestPointToPoint(a,o),h=a.distanceToSquared(o),h<A&&(A=h,n&&n.copy(o),r&&r.copy(a)),this.closestPointToPoint(c,o),h=c.distanceToSquared(o),h<A&&(A=h,n&&n.copy(o),r&&r.copy(c)),Math.sqrt(A)}})();re.prototype.intersectsTriangle=(function(){const o=new re,t=new Te,e=new Te,s=new U,i=new U,n=new U,r=new U,a=new ne,c=new ne,l=new U,h=new _e,A=new _e;function u(I,C,S,v){const T=s;!I.isDegenerateIntoPoint&&!I.isDegenerateIntoSegment?T.copy(I.plane.normal):T.copy(C.plane.normal);const x=I.satBounds,L=I.satAxes;for(let R=1;R<4;R++){const k=x[R],_=L[R];if(t.setFromPoints(_,C.points),k.isSeparated(t)||(r.copy(T).cross(_),t.setFromPoints(r,I.points),e.setFromPoints(r,C.points),t.isSeparated(e)))return!1}const B=C.satBounds,D=C.satAxes;for(let R=1;R<4;R++){const k=B[R],_=D[R];if(t.setFromPoints(_,I.points),k.isSeparated(t)||(r.crossVectors(T,_),t.setFromPoints(r,I.points),e.setFromPoints(r,C.points),t.isSeparated(e)))return!1}return S&&(v||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),S.start.set(0,0,0),S.end.set(0,0,0)),!0}function d(I,C,S,v,T,x,L,B,D,R,k){let _=L/(L-B);R.x=v+(T-v)*_,k.start.subVectors(C,I).multiplyScalar(_).add(I),_=L/(L-D),R.y=v+(x-v)*_,k.end.subVectors(S,I).multiplyScalar(_).add(I)}function f(I,C,S,v,T,x,L,B,D,R,k){if(T>0)d(I.c,I.a,I.b,v,C,S,D,L,B,R,k);else if(x>0)d(I.b,I.a,I.c,S,C,v,B,L,D,R,k);else if(B*D>0||L!=0)d(I.a,I.b,I.c,C,S,v,L,B,D,R,k);else if(B!=0)d(I.b,I.a,I.c,S,C,v,B,L,D,R,k);else if(D!=0)d(I.c,I.a,I.b,v,C,S,D,L,B,R,k);else return!0;return!1}function g(I,C,S,v){const T=C.degenerateSegment,x=I.plane.distanceToPoint(T.start),L=I.plane.distanceToPoint(T.end);return Yt(x)?Yt(L)?u(I,C,S,v):(S&&(S.start.copy(T.start),S.end.copy(T.start)),I.containsPoint(T.start)):Yt(L)?(S&&(S.start.copy(T.end),S.end.copy(T.end)),I.containsPoint(T.end)):I.plane.intersectLine(T,s)!=null?(S&&(S.start.copy(s),S.end.copy(s)),I.containsPoint(s)):!1}function m(I,C,S){const v=C.a;return Yt(I.plane.distanceToPoint(v))&&I.containsPoint(v)?(S&&(S.start.copy(v),S.end.copy(v)),!0):!1}function E(I,C,S){const v=I.degenerateSegment,T=C.a;return v.closestPointToPoint(T,!0,s),T.distanceToSquared(s)<Za?(S&&(S.start.copy(T),S.end.copy(T)),!0):!1}function p(I,C,S,v){if(I.isDegenerateIntoSegment)if(C.isDegenerateIntoSegment){const T=I.degenerateSegment,x=C.degenerateSegment,L=i,B=n;T.delta(L),x.delta(B);const D=s.subVectors(x.start,T.start),R=L.x*B.y-L.y*B.x;if(Yt(R))return!1;const k=(D.x*B.y-D.y*B.x)/R,_=-(L.x*D.y-L.y*D.x)/R;if(k<0||k>1||_<0||_>1)return!1;const Q=T.start.z+L.z*k,F=x.start.z+B.z*_;return Yt(Q-F)?(S&&(S.start.copy(T.start).addScaledVector(L,k),S.end.copy(T.start).addScaledVector(L,k)),!0):!1}else return C.isDegenerateIntoPoint?E(I,C,S):g(C,I,S,v);else{if(I.isDegenerateIntoPoint)return C.isDegenerateIntoPoint?C.a.distanceToSquared(I.a)<Za?(S&&(S.start.copy(I.a),S.end.copy(I.a)),!0):!1:C.isDegenerateIntoSegment?E(C,I,S):m(C,I,S);if(C.isDegenerateIntoPoint)return m(I,C,S);if(C.isDegenerateIntoSegment)return g(I,C,S,v)}}return function(C,S=null,v=!1){this.needsUpdate&&this.update(),C.isExtendedTriangle?C.needsUpdate&&C.update():(o.copy(C),o.update(),C=o);const T=p(this,C,S,v);if(T!==void 0)return T;const x=this.plane,L=C.plane;let B=L.distanceToPoint(this.a),D=L.distanceToPoint(this.b),R=L.distanceToPoint(this.c);Yt(B)&&(B=0),Yt(D)&&(D=0),Yt(R)&&(R=0);const k=B*D,_=B*R;if(k>0&&_>0)return!1;let Q=x.distanceToPoint(C.a),F=x.distanceToPoint(C.b),G=x.distanceToPoint(C.c);Yt(Q)&&(Q=0),Yt(F)&&(F=0),Yt(G)&&(G=0);const N=Q*F,$=Q*G;if(N>0&&$>0)return!1;i.copy(x.normal),n.copy(L.normal);const Y=i.cross(n);let M=0,O=Math.abs(Y.x);const q=Math.abs(Y.y);q>O&&(O=q,M=1),Math.abs(Y.z)>O&&(M=2);const J=Fp[M],Z=this.a[J],Ct=this.b[J],mt=this.c[J],Qt=C.a[J],Ht=C.b[J],ge=C.c[J];if(f(this,Z,Ct,mt,k,_,B,D,R,h,a))return u(this,C,S,v);if(f(C,Qt,Ht,ge,N,$,Q,F,G,A,c))return u(this,C,S,v);if(h.y<h.x){const Ss=h.y;h.y=h.x,h.x=Ss,l.copy(a.start),a.start.copy(a.end),a.end.copy(l)}if(A.y<A.x){const Ss=A.y;A.y=A.x,A.x=Ss,l.copy(c.start),c.start.copy(c.end),c.end.copy(l)}return h.y<A.x||A.y<h.x?!1:(S&&(A.x>h.x?S.start.copy(c.start):S.start.copy(a.start),A.y<h.y?S.end.copy(c.end):S.end.copy(a.end)),!0)}})();re.prototype.distanceToPoint=(function(){const o=new U;return function(e){return this.closestPointToPoint(e,o),e.distanceTo(o)}})();re.prototype.distanceToTriangle=(function(){const o=new U,t=new U,e=["a","b","c"],s=new ne,i=new ne;return function(r,a=null,c=null){const l=a||c?s:null;if(this.intersectsTriangle(r,l))return(a||c)&&(a&&l.getCenter(a),c&&l.getCenter(c)),0;let h=1/0;for(let A=0;A<3;A++){let u;const d=e[A],f=r[d];this.closestPointToPoint(f,o),u=f.distanceToSquared(o),u<h&&(h=u,a&&a.copy(o),c&&c.copy(f));const g=this[d];r.closestPointToPoint(g,o),u=g.distanceToSquared(o),u<h&&(h=u,a&&a.copy(g),c&&c.copy(o))}for(let A=0;A<3;A++){const u=e[A],d=e[(A+1)%3];s.set(this[u],this[d]);for(let f=0;f<3;f++){const g=e[f],m=e[(f+1)%3];i.set(r[g],r[m]),Ao(s,i,o,t);const E=o.distanceToSquared(t);E<h&&(h=E,a&&a.copy(o),c&&c.copy(t))}}return Math.sqrt(h)}})();class Ft{constructor(t,e,s){this.isOrientedBox=!0,this.min=new U,this.max=new U,this.matrix=new ie,this.invMatrix=new ie,this.points=new Array(8).fill().map(()=>new U),this.satAxes=new Array(3).fill().map(()=>new U),this.satBounds=new Array(3).fill().map(()=>new Te),this.alignedSatBounds=new Array(3).fill().map(()=>new Te),this.needsUpdate=!1,t&&this.min.copy(t),e&&this.max.copy(e),s&&this.matrix.copy(s)}set(t,e,s){this.min.copy(t),this.max.copy(e),this.matrix.copy(s),this.needsUpdate=!0}copy(t){this.min.copy(t.min),this.max.copy(t.max),this.matrix.copy(t.matrix),this.needsUpdate=!0}}Ft.prototype.update=(function(){return function(){const t=this.matrix,e=this.min,s=this.max,i=this.points;for(let l=0;l<=1;l++)for(let h=0;h<=1;h++)for(let A=0;A<=1;A++){const u=1*l|2*h|4*A,d=i[u];d.x=l?s.x:e.x,d.y=h?s.y:e.y,d.z=A?s.z:e.z,d.applyMatrix4(t)}const n=this.satBounds,r=this.satAxes,a=i[0];for(let l=0;l<3;l++){const h=r[l],A=n[l],u=1<<l,d=i[u];h.subVectors(a,d),A.setFromPoints(h,i)}const c=this.alignedSatBounds;c[0].setFromPointsField(i,"x"),c[1].setFromPointsField(i,"y"),c[2].setFromPointsField(i,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}})();Ft.prototype.intersectsBox=(function(){const o=new Te;return function(e){this.needsUpdate&&this.update();const s=e.min,i=e.max,n=this.satBounds,r=this.satAxes,a=this.alignedSatBounds;if(o.min=s.x,o.max=i.x,a[0].isSeparated(o)||(o.min=s.y,o.max=i.y,a[1].isSeparated(o))||(o.min=s.z,o.max=i.z,a[2].isSeparated(o)))return!1;for(let c=0;c<3;c++){const l=r[c],h=n[c];if(o.setFromBox(l,e),h.isSeparated(o))return!1}return!0}})();Ft.prototype.intersectsTriangle=(function(){const o=new re,t=new Array(3),e=new Te,s=new Te,i=new U;return function(r){this.needsUpdate&&this.update(),r.isExtendedTriangle?r.needsUpdate&&r.update():(o.copy(r),o.update(),r=o);const a=this.satBounds,c=this.satAxes;t[0]=r.a,t[1]=r.b,t[2]=r.c;for(let u=0;u<3;u++){const d=a[u],f=c[u];if(e.setFromPoints(f,t),d.isSeparated(e))return!1}const l=r.satBounds,h=r.satAxes,A=this.points;for(let u=0;u<3;u++){const d=l[u],f=h[u];if(e.setFromPoints(f,A),d.isSeparated(e))return!1}for(let u=0;u<3;u++){const d=c[u];for(let f=0;f<4;f++){const g=h[f];if(i.crossVectors(d,g),e.setFromPoints(i,t),s.setFromPoints(i,A),e.isSeparated(s))return!1}}return!0}})();Ft.prototype.closestPointToPoint=(function(){return function(t,e){return this.needsUpdate&&this.update(),e.copy(t).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),e}})();Ft.prototype.distanceToPoint=(function(){const o=new U;return function(e){return this.closestPointToPoint(e,o),e.distanceTo(o)}})();Ft.prototype.distanceToBox=(function(){const o=["x","y","z"],t=new Array(12).fill().map(()=>new ne),e=new Array(12).fill().map(()=>new ne),s=new U,i=new U;return function(r,a=0,c=null,l=null){if(this.needsUpdate&&this.update(),this.intersectsBox(r))return(c||l)&&(r.getCenter(i),this.closestPointToPoint(i,s),r.closestPointToPoint(s,i),c&&c.copy(s),l&&l.copy(i)),0;const h=a*a,A=r.min,u=r.max,d=this.points;let f=1/0;for(let m=0;m<8;m++){const E=d[m];i.copy(E).clamp(A,u);const p=E.distanceToSquared(i);if(p<f&&(f=p,c&&c.copy(E),l&&l.copy(i),p<h))return Math.sqrt(p)}let g=0;for(let m=0;m<3;m++)for(let E=0;E<=1;E++)for(let p=0;p<=1;p++){const I=(m+1)%3,C=(m+2)%3,S=E<<I|p<<C,v=1<<m|E<<I|p<<C,T=d[S],x=d[v];t[g].set(T,x);const B=o[m],D=o[I],R=o[C],k=e[g],_=k.start,Q=k.end;_[B]=A[B],_[D]=E?A[D]:u[D],_[R]=p?A[R]:u[D],Q[B]=u[B],Q[D]=E?A[D]:u[D],Q[R]=p?A[R]:u[D],g++}for(let m=0;m<=1;m++)for(let E=0;E<=1;E++)for(let p=0;p<=1;p++){i.x=m?u.x:A.x,i.y=E?u.y:A.y,i.z=p?u.z:A.z,this.closestPointToPoint(i,s);const I=i.distanceToSquared(s);if(I<f&&(f=I,c&&c.copy(s),l&&l.copy(i),I<h))return Math.sqrt(I)}for(let m=0;m<12;m++){const E=t[m];for(let p=0;p<12;p++){const I=e[p];Ao(E,I,s,i);const C=s.distanceToSquared(i);if(C<f&&(f=C,c&&c.copy(s),l&&l.copy(i),C<h))return Math.sqrt(C)}}return Math.sqrt(f)}})();class Qp extends co{constructor(){super(()=>new re)}}const Jt=new Qp,Ls=new U,Kn=new U;function Mp(o,t,e={},s=0,i=1/0){const n=s*s,r=i*i;let a=1/0,c=null;if(o.shapecast({boundsTraverseOrder:h=>(Ls.copy(t).clamp(h.min,h.max),Ls.distanceToSquared(t)),intersectsBounds:(h,A,u)=>u<a&&u<r,intersectsTriangle:(h,A)=>{h.closestPointToPoint(t,Ls);const u=t.distanceToSquared(Ls);return u<a&&(Kn.copy(Ls),a=u,c=A),u<n}}),a===1/0)return null;const l=Math.sqrt(a);return e.point?e.point.copy(Kn):e.point=Kn.clone(),e.distance=l,e.faceIndex=c,e}const Ii=parseInt(Il)>=169,Op=parseInt(Il)<=161,Ge=new U,Ke=new U,$e=new U,yi=new _e,Ci=new _e,Si=new _e,tl=new U,el=new U,sl=new U,Ds=new U;function Up(o,t,e,s,i,n,r,a){let c;if(n===nA?c=o.intersectTriangle(s,e,t,!0,i):c=o.intersectTriangle(t,e,s,n!==El,i),c===null)return null;const l=o.origin.distanceTo(i);return l<r||l>a?null:{distance:l,point:i.clone()}}function il(o,t,e,s,i,n,r,a,c,l,h){Ge.fromBufferAttribute(t,n),Ke.fromBufferAttribute(t,r),$e.fromBufferAttribute(t,a);const A=Up(o,Ge,Ke,$e,Ds,c,l,h);if(A){if(s){yi.fromBufferAttribute(s,n),Ci.fromBufferAttribute(s,r),Si.fromBufferAttribute(s,a),A.uv=new _e;const d=hs.getInterpolation(Ds,Ge,Ke,$e,yi,Ci,Si,A.uv);Ii||(A.uv=d)}if(i){yi.fromBufferAttribute(i,n),Ci.fromBufferAttribute(i,r),Si.fromBufferAttribute(i,a),A.uv1=new _e;const d=hs.getInterpolation(Ds,Ge,Ke,$e,yi,Ci,Si,A.uv1);Ii||(A.uv1=d),Op&&(A.uv2=A.uv1)}if(e){tl.fromBufferAttribute(e,n),el.fromBufferAttribute(e,r),sl.fromBufferAttribute(e,a),A.normal=new U;const d=hs.getInterpolation(Ds,Ge,Ke,$e,tl,el,sl,A.normal);A.normal.dot(o.direction)>0&&A.normal.multiplyScalar(-1),Ii||(A.normal=d)}const u={a:n,b:r,c:a,normal:new U,materialIndex:0};if(hs.getNormal(Ge,Ke,$e,u.normal),A.face=u,A.faceIndex=n,Ii){const d=new U;hs.getBarycoord(Ds,Ge,Ke,$e,d),A.barycoord=d}}return A}function nl(o){return o&&o.isMaterial?o.side:o}function ln(o,t,e,s,i,n,r){const a=s*3;let c=a+0,l=a+1,h=a+2;const{index:A,groups:u}=o;o.index&&(c=A.getX(c),l=A.getX(l),h=A.getX(h));const{position:d,normal:f,uv:g,uv1:m}=o.attributes;if(Array.isArray(t)){const E=s*3;for(let p=0,I=u.length;p<I;p++){const{start:C,count:S,materialIndex:v}=u[p];if(E>=C&&E<C+S){const T=nl(t[v]),x=il(e,d,f,g,m,c,l,h,T,n,r);if(x)if(x.faceIndex=s,x.face.materialIndex=v,i)i.push(x);else return x}}}else{const E=nl(t),p=il(e,d,f,g,m,c,l,h,E,n,r);if(p)if(p.faceIndex=s,p.face.materialIndex=0,i)i.push(p);else return p}return null}function gt(o,t,e,s){const i=o.a,n=o.b,r=o.c;let a=t,c=t+1,l=t+2;e&&(a=e.getX(a),c=e.getX(c),l=e.getX(l)),i.x=s.getX(a),i.y=s.getY(a),i.z=s.getZ(a),n.x=s.getX(c),n.y=s.getY(c),n.z=s.getZ(c),r.x=s.getX(l),r.y=s.getY(l),r.z=s.getZ(l)}function Np(o,t,e,s,i,n,r,a){const{geometry:c,_indirectBuffer:l}=o;for(let h=s,A=s+i;h<A;h++)ln(c,t,e,h,n,r,a)}function Gp(o,t,e,s,i,n,r){const{geometry:a,_indirectBuffer:c}=o;let l=1/0,h=null;for(let A=s,u=s+i;A<u;A++){let d;d=ln(a,t,e,A,null,n,r),d&&d.distance<l&&(h=d,l=d.distance)}return h}function Kp(o,t,e,s,i,n,r){const{geometry:a}=e,{index:c}=a,l=a.attributes.position;for(let h=o,A=t+o;h<A;h++){let u;if(u=h,gt(r,u*3,c,l),r.needsUpdate=!0,s(r,u,i,n))return!0}return!1}function $p(o,t=null){t&&Array.isArray(t)&&(t=new Set(t));const e=o.geometry,s=e.index?e.index.array:null,i=e.attributes.position;let n,r,a,c,l=0;const h=o._roots;for(let u=0,d=h.length;u<d;u++)n=h[u],r=new Uint32Array(n),a=new Uint16Array(n),c=new Float32Array(n),A(0,l),l+=n.byteLength;function A(u,d,f=!1){const g=u*2;if(yt(g,a)){const m=wt(u,r),E=Pt(g,a);let p=1/0,I=1/0,C=1/0,S=-1/0,v=-1/0,T=-1/0;for(let x=3*m,L=3*(m+E);x<L;x++){let B=s[x];const D=i.getX(B),R=i.getY(B),k=i.getZ(B);D<p&&(p=D),D>S&&(S=D),R<I&&(I=R),R>v&&(v=R),k<C&&(C=k),k>T&&(T=k)}return c[u+0]!==p||c[u+1]!==I||c[u+2]!==C||c[u+3]!==S||c[u+4]!==v||c[u+5]!==T?(c[u+0]=p,c[u+1]=I,c[u+2]=C,c[u+3]=S,c[u+4]=v,c[u+5]=T,!0):!1}else{const m=Tt(u),E=Bt(u,r);let p=f,I=!1,C=!1;if(t){if(!p){const B=m/It+d/bt,D=E/It+d/bt;I=t.has(B),C=t.has(D),p=!I&&!C}}else I=!0,C=!0;const S=p||I,v=p||C;let T=!1;S&&(T=A(m,d,p));let x=!1;v&&(x=A(E,d,p));const L=T||x;if(L)for(let B=0;B<3;B++){const D=m+B,R=E+B,k=c[D],_=c[D+3],Q=c[R],F=c[R+3];c[u+B]=k<Q?k:Q,c[u+B+3]=_>F?_:F}return L}}}function Qe(o,t,e,s,i){let n,r,a,c,l,h;const A=1/e.direction.x,u=1/e.direction.y,d=1/e.direction.z,f=e.origin.x,g=e.origin.y,m=e.origin.z;let E=t[o],p=t[o+3],I=t[o+1],C=t[o+3+1],S=t[o+2],v=t[o+3+2];return A>=0?(n=(E-f)*A,r=(p-f)*A):(n=(p-f)*A,r=(E-f)*A),u>=0?(a=(I-g)*u,c=(C-g)*u):(a=(C-g)*u,c=(I-g)*u),n>c||a>r||((a>n||isNaN(n))&&(n=a),(c<r||isNaN(r))&&(r=c),d>=0?(l=(S-m)*d,h=(v-m)*d):(l=(v-m)*d,h=(S-m)*d),n>h||l>r)?!1:((l>n||n!==n)&&(n=l),(h<r||r!==r)&&(r=h),n<=i&&r>=s)}function Hp(o,t,e,s,i,n,r,a){const{geometry:c,_indirectBuffer:l}=o;for(let h=s,A=s+i;h<A;h++){let u=l?l[h]:h;ln(c,t,e,u,n,r,a)}}function Vp(o,t,e,s,i,n,r){const{geometry:a,_indirectBuffer:c}=o;let l=1/0,h=null;for(let A=s,u=s+i;A<u;A++){let d;d=ln(a,t,e,c?c[A]:A,null,n,r),d&&d.distance<l&&(h=d,l=d.distance)}return h}function Yp(o,t,e,s,i,n,r){const{geometry:a}=e,{index:c}=a,l=a.attributes.position;for(let h=o,A=t+o;h<A;h++){let u;if(u=e.resolveTriangleIndex(h),gt(r,u*3,c,l),r.needsUpdate=!0,s(r,u,i,n))return!0}return!1}function qp(o,t,e,s,i,n,r){lt.setBuffer(o._roots[t]),Dr(0,o,e,s,i,n,r),lt.clearBuffer()}function Dr(o,t,e,s,i,n,r){const{float32Array:a,uint16Array:c,uint32Array:l}=lt,h=o*2;if(yt(h,c)){const u=wt(o,l),d=Pt(h,c);Np(t,e,s,u,d,i,n,r)}else{const u=Tt(o);Qe(u,a,s,n,r)&&Dr(u,t,e,s,i,n,r);const d=Bt(o,l);Qe(d,a,s,n,r)&&Dr(d,t,e,s,i,n,r)}}const Wp=["x","y","z"];function Jp(o,t,e,s,i,n){lt.setBuffer(o._roots[t]);const r=Rr(0,o,e,s,i,n);return lt.clearBuffer(),r}function Rr(o,t,e,s,i,n){const{float32Array:r,uint16Array:a,uint32Array:c}=lt;let l=o*2;if(yt(l,a)){const A=wt(o,c),u=Pt(l,a);return Gp(t,e,s,A,u,i,n)}else{const A=lo(o,c),u=Wp[A],f=s.direction[u]>=0;let g,m;f?(g=Tt(o),m=Bt(o,c)):(g=Bt(o,c),m=Tt(o));const p=Qe(g,r,s,i,n)?Rr(g,t,e,s,i,n):null;if(p){const S=p.point[u];if(f?S<=r[m+A]:S>=r[m+A+3])return p}const C=Qe(m,r,s,i,n)?Rr(m,t,e,s,i,n):null;return p&&C?p.distance<=C.distance?p:C:p||C||null}}const Ti=new Xt,rs=new re,os=new re,Rs=new ie,rl=new Ft,Bi=new Ft;function jp(o,t,e,s){lt.setBuffer(o._roots[t]);const i=br(0,o,e,s);return lt.clearBuffer(),i}function br(o,t,e,s,i=null){const{float32Array:n,uint16Array:r,uint32Array:a}=lt;let c=o*2;if(i===null&&(e.boundingBox||e.computeBoundingBox(),rl.set(e.boundingBox.min,e.boundingBox.max,s),i=rl),yt(c,r)){const h=t.geometry,A=h.index,u=h.attributes.position,d=e.index,f=e.attributes.position,g=wt(o,a),m=Pt(c,r);if(Rs.copy(s).invert(),e.boundsTree)return ht(o,n,Bi),Bi.matrix.copy(Rs),Bi.needsUpdate=!0,e.boundsTree.shapecast({intersectsBounds:p=>Bi.intersectsBox(p),intersectsTriangle:p=>{p.a.applyMatrix4(s),p.b.applyMatrix4(s),p.c.applyMatrix4(s),p.needsUpdate=!0;for(let I=g*3,C=(m+g)*3;I<C;I+=3)if(gt(os,I,A,u),os.needsUpdate=!0,p.intersectsTriangle(os))return!0;return!1}});{const E=an(e);for(let p=g*3,I=(m+g)*3;p<I;p+=3){gt(rs,p,A,u),rs.a.applyMatrix4(Rs),rs.b.applyMatrix4(Rs),rs.c.applyMatrix4(Rs),rs.needsUpdate=!0;for(let C=0,S=E*3;C<S;C+=3)if(gt(os,C,d,f),os.needsUpdate=!0,rs.intersectsTriangle(os))return!0}}}else{const h=Tt(o),A=Bt(o,a);return ht(h,n,Ti),!!(i.intersectsBox(Ti)&&br(h,t,e,s,i)||(ht(A,n,Ti),i.intersectsBox(Ti)&&br(A,t,e,s,i)))}}const xi=new ie,$n=new Ft,bs=new Ft,Xp=new U,zp=new U,Zp=new U,t0=new U;function e0(o,t,e,s={},i={},n=0,r=1/0){t.boundingBox||t.computeBoundingBox(),$n.set(t.boundingBox.min,t.boundingBox.max,e),$n.needsUpdate=!0;const a=o.geometry,c=a.attributes.position,l=a.index,h=t.attributes.position,A=t.index,u=Jt.getPrimitive(),d=Jt.getPrimitive();let f=Xp,g=zp,m=null,E=null;i&&(m=Zp,E=t0);let p=1/0,I=null,C=null;return xi.copy(e).invert(),bs.matrix.copy(xi),o.shapecast({boundsTraverseOrder:S=>$n.distanceToBox(S),intersectsBounds:(S,v,T)=>T<p&&T<r?(v&&(bs.min.copy(S.min),bs.max.copy(S.max),bs.needsUpdate=!0),!0):!1,intersectsRange:(S,v)=>{if(t.boundsTree)return t.boundsTree.shapecast({boundsTraverseOrder:x=>bs.distanceToBox(x),intersectsBounds:(x,L,B)=>B<p&&B<r,intersectsRange:(x,L)=>{for(let B=x,D=x+L;B<D;B++){gt(d,3*B,A,h),d.a.applyMatrix4(e),d.b.applyMatrix4(e),d.c.applyMatrix4(e),d.needsUpdate=!0;for(let R=S,k=S+v;R<k;R++){gt(u,3*R,l,c),u.needsUpdate=!0;const _=u.distanceToTriangle(d,f,m);if(_<p&&(g.copy(f),E&&E.copy(m),p=_,I=R,C=B),_<n)return!0}}}});{const T=an(t);for(let x=0,L=T;x<L;x++){gt(d,3*x,A,h),d.a.applyMatrix4(e),d.b.applyMatrix4(e),d.c.applyMatrix4(e),d.needsUpdate=!0;for(let B=S,D=S+v;B<D;B++){gt(u,3*B,l,c),u.needsUpdate=!0;const R=u.distanceToTriangle(d,f,m);if(R<p&&(g.copy(f),E&&E.copy(m),p=R,I=B,C=x),R<n)return!0}}}}}),Jt.releasePrimitive(u),Jt.releasePrimitive(d),p===1/0?null:(s.point?s.point.copy(g):s.point=g.clone(),s.distance=p,s.faceIndex=I,i&&(i.point?i.point.copy(E):i.point=E.clone(),i.point.applyMatrix4(xi),g.applyMatrix4(xi),i.distance=g.sub(i.point).length(),i.faceIndex=C),s)}function s0(o,t=null){t&&Array.isArray(t)&&(t=new Set(t));const e=o.geometry,s=e.index?e.index.array:null,i=e.attributes.position;let n,r,a,c,l=0;const h=o._roots;for(let u=0,d=h.length;u<d;u++)n=h[u],r=new Uint32Array(n),a=new Uint16Array(n),c=new Float32Array(n),A(0,l),l+=n.byteLength;function A(u,d,f=!1){const g=u*2;if(yt(g,a)){const m=wt(u,r),E=Pt(g,a);let p=1/0,I=1/0,C=1/0,S=-1/0,v=-1/0,T=-1/0;for(let x=m,L=m+E;x<L;x++){const B=3*o.resolveTriangleIndex(x);for(let D=0;D<3;D++){let R=B+D;R=s?s[R]:R;const k=i.getX(R),_=i.getY(R),Q=i.getZ(R);k<p&&(p=k),k>S&&(S=k),_<I&&(I=_),_>v&&(v=_),Q<C&&(C=Q),Q>T&&(T=Q)}}return c[u+0]!==p||c[u+1]!==I||c[u+2]!==C||c[u+3]!==S||c[u+4]!==v||c[u+5]!==T?(c[u+0]=p,c[u+1]=I,c[u+2]=C,c[u+3]=S,c[u+4]=v,c[u+5]=T,!0):!1}else{const m=Tt(u),E=Bt(u,r);let p=f,I=!1,C=!1;if(t){if(!p){const B=m/It+d/bt,D=E/It+d/bt;I=t.has(B),C=t.has(D),p=!I&&!C}}else I=!0,C=!0;const S=p||I,v=p||C;let T=!1;S&&(T=A(m,d,p));let x=!1;v&&(x=A(E,d,p));const L=T||x;if(L)for(let B=0;B<3;B++){const D=m+B,R=E+B,k=c[D],_=c[D+3],Q=c[R],F=c[R+3];c[u+B]=k<Q?k:Q,c[u+B+3]=_>F?_:F}return L}}}function i0(o,t,e,s,i,n,r){lt.setBuffer(o._roots[t]),wr(0,o,e,s,i,n,r),lt.clearBuffer()}function wr(o,t,e,s,i,n,r){const{float32Array:a,uint16Array:c,uint32Array:l}=lt,h=o*2;if(yt(h,c)){const u=wt(o,l),d=Pt(h,c);Hp(t,e,s,u,d,i,n,r)}else{const u=Tt(o);Qe(u,a,s,n,r)&&wr(u,t,e,s,i,n,r);const d=Bt(o,l);Qe(d,a,s,n,r)&&wr(d,t,e,s,i,n,r)}}const n0=["x","y","z"];function r0(o,t,e,s,i,n){lt.setBuffer(o._roots[t]);const r=kr(0,o,e,s,i,n);return lt.clearBuffer(),r}function kr(o,t,e,s,i,n){const{float32Array:r,uint16Array:a,uint32Array:c}=lt;let l=o*2;if(yt(l,a)){const A=wt(o,c),u=Pt(l,a);return Vp(t,e,s,A,u,i,n)}else{const A=lo(o,c),u=n0[A],f=s.direction[u]>=0;let g,m;f?(g=Tt(o),m=Bt(o,c)):(g=Bt(o,c),m=Tt(o));const p=Qe(g,r,s,i,n)?kr(g,t,e,s,i,n):null;if(p){const S=p.point[u];if(f?S<=r[m+A]:S>=r[m+A+3])return p}const C=Qe(m,r,s,i,n)?kr(m,t,e,s,i,n):null;return p&&C?p.distance<=C.distance?p:C:p||C||null}}const vi=new Xt,as=new re,ls=new re,ws=new ie,ol=new Ft,Li=new Ft;function o0(o,t,e,s){lt.setBuffer(o._roots[t]);const i=_r(0,o,e,s);return lt.clearBuffer(),i}function _r(o,t,e,s,i=null){const{float32Array:n,uint16Array:r,uint32Array:a}=lt;let c=o*2;if(i===null&&(e.boundingBox||e.computeBoundingBox(),ol.set(e.boundingBox.min,e.boundingBox.max,s),i=ol),yt(c,r)){const h=t.geometry,A=h.index,u=h.attributes.position,d=e.index,f=e.attributes.position,g=wt(o,a),m=Pt(c,r);if(ws.copy(s).invert(),e.boundsTree)return ht(o,n,Li),Li.matrix.copy(ws),Li.needsUpdate=!0,e.boundsTree.shapecast({intersectsBounds:p=>Li.intersectsBox(p),intersectsTriangle:p=>{p.a.applyMatrix4(s),p.b.applyMatrix4(s),p.c.applyMatrix4(s),p.needsUpdate=!0;for(let I=g,C=m+g;I<C;I++)if(gt(ls,3*t.resolveTriangleIndex(I),A,u),ls.needsUpdate=!0,p.intersectsTriangle(ls))return!0;return!1}});{const E=an(e);for(let p=g,I=m+g;p<I;p++){const C=t.resolveTriangleIndex(p);gt(as,3*C,A,u),as.a.applyMatrix4(ws),as.b.applyMatrix4(ws),as.c.applyMatrix4(ws),as.needsUpdate=!0;for(let S=0,v=E*3;S<v;S+=3)if(gt(ls,S,d,f),ls.needsUpdate=!0,as.intersectsTriangle(ls))return!0}}}else{const h=Tt(o),A=Bt(o,a);return ht(h,n,vi),!!(i.intersectsBox(vi)&&_r(h,t,e,s,i)||(ht(A,n,vi),i.intersectsBox(vi)&&_r(A,t,e,s,i)))}}const Di=new ie,Hn=new Ft,ks=new Ft,a0=new U,l0=new U,c0=new U,h0=new U;function A0(o,t,e,s={},i={},n=0,r=1/0){t.boundingBox||t.computeBoundingBox(),Hn.set(t.boundingBox.min,t.boundingBox.max,e),Hn.needsUpdate=!0;const a=o.geometry,c=a.attributes.position,l=a.index,h=t.attributes.position,A=t.index,u=Jt.getPrimitive(),d=Jt.getPrimitive();let f=a0,g=l0,m=null,E=null;i&&(m=c0,E=h0);let p=1/0,I=null,C=null;return Di.copy(e).invert(),ks.matrix.copy(Di),o.shapecast({boundsTraverseOrder:S=>Hn.distanceToBox(S),intersectsBounds:(S,v,T)=>T<p&&T<r?(v&&(ks.min.copy(S.min),ks.max.copy(S.max),ks.needsUpdate=!0),!0):!1,intersectsRange:(S,v)=>{if(t.boundsTree){const T=t.boundsTree;return T.shapecast({boundsTraverseOrder:x=>ks.distanceToBox(x),intersectsBounds:(x,L,B)=>B<p&&B<r,intersectsRange:(x,L)=>{for(let B=x,D=x+L;B<D;B++){const R=T.resolveTriangleIndex(B);gt(d,3*R,A,h),d.a.applyMatrix4(e),d.b.applyMatrix4(e),d.c.applyMatrix4(e),d.needsUpdate=!0;for(let k=S,_=S+v;k<_;k++){const Q=o.resolveTriangleIndex(k);gt(u,3*Q,l,c),u.needsUpdate=!0;const F=u.distanceToTriangle(d,f,m);if(F<p&&(g.copy(f),E&&E.copy(m),p=F,I=k,C=B),F<n)return!0}}}})}else{const T=an(t);for(let x=0,L=T;x<L;x++){gt(d,3*x,A,h),d.a.applyMatrix4(e),d.b.applyMatrix4(e),d.c.applyMatrix4(e),d.needsUpdate=!0;for(let B=S,D=S+v;B<D;B++){const R=o.resolveTriangleIndex(B);gt(u,3*R,l,c),u.needsUpdate=!0;const k=u.distanceToTriangle(d,f,m);if(k<p&&(g.copy(f),E&&E.copy(m),p=k,I=B,C=x),k<n)return!0}}}}}),Jt.releasePrimitive(u),Jt.releasePrimitive(d),p===1/0?null:(s.point?s.point.copy(g):s.point=g.clone(),s.distance=p,s.faceIndex=I,i&&(i.point?i.point.copy(E):i.point=E.clone(),i.point.applyMatrix4(Di),g.applyMatrix4(Di),i.distance=g.sub(i.point).length(),i.faceIndex=C),s)}function al(o,t,e){return o===null?null:(o.point.applyMatrix4(t.matrixWorld),o.distance=o.point.distanceTo(e.ray.origin),o.object=t,o)}const Ri=new Ft,bi=new rA,ll=new U,cl=new ie,hl=new U,Vn=["getX","getY","getZ"];class Zs extends kp{static serialize(t,e={}){e={cloneBuffers:!0,...e};const s=t.geometry,i=t._roots,n=t._indirectBuffer,r=s.getIndex(),a={version:1,roots:null,index:null,indirectBuffer:null};return e.cloneBuffers?(a.roots=i.map(c=>c.slice()),a.index=r?r.array.slice():null,a.indirectBuffer=n?n.slice():null):(a.roots=i,a.index=r?r.array:null,a.indirectBuffer=n),a}static deserialize(t,e,s={}){s={setIndex:!0,indirect:!!t.indirectBuffer,...s};const{index:i,roots:n,indirectBuffer:r}=t;t.version||(console.warn("MeshBVH.deserialize: Serialization format has been changed and will be fixed up. It is recommended to regenerate any stored serialized data."),c(n));const a=new Zs(e,{...s,[ao]:!0});if(a._roots=n,a._indirectBuffer=r||null,s.setIndex){const l=e.getIndex();if(l===null){const h=new ke(t.index,1,!1);e.setIndex(h)}else l.array!==i&&(l.array.set(i),l.needsUpdate=!0)}return a;function c(l){for(let h=0;h<l.length;h++){const A=l[h],u=new Uint32Array(A),d=new Uint16Array(A);for(let f=0,g=A.byteLength/bt;f<g;f++){const m=It*f,E=2*m;yt(E,d)||(u[m+6]=u[m+6]/It-f)}}}}get primitiveStride(){return 3}get resolveTriangleIndex(){return this.resolvePrimitiveIndex}constructor(t,e={}){e.maxLeafTris&&(console.warn('MeshBVH: "maxLeafTris" option has been deprecated. Use maxLeafSize, instead.'),e={...e,maxLeafSize:e.maxLeafTris}),super(t,e)}shiftTriangleOffsets(t){return super.shiftPrimitiveOffsets(t)}writePrimitiveBounds(t,e,s){const i=this.geometry,n=this._indirectBuffer,r=i.attributes.position,a=i.index?i.index.array:null,l=(n?n[t]:t)*3;let h=l+0,A=l+1,u=l+2;a&&(h=a[h],A=a[A],u=a[u]);for(let d=0;d<3;d++){const f=r[Vn[d]](h),g=r[Vn[d]](A),m=r[Vn[d]](u);let E=f;g<E&&(E=g),m<E&&(E=m);let p=f;g>p&&(p=g),m>p&&(p=m),e[s+d]=E,e[s+d+3]=p}return e}computePrimitiveBounds(t,e,s){const i=this.geometry,n=this._indirectBuffer,r=i.attributes.position,a=i.index?i.index.array:null,c=r.normalized;if(t<0||e+t-s.offset>s.length/6)throw new Error("MeshBVH: compute triangle bounds range is invalid.");const l=r.array,h=r.offset||0;let A=3;r.isInterleavedBufferAttribute&&(A=r.data.stride);const u=["getX","getY","getZ"],d=s.offset;for(let f=t,g=t+e;f<g;f++){const E=(n?n[f]:f)*3,p=(f-d)*6;let I=E+0,C=E+1,S=E+2;a&&(I=a[I],C=a[C],S=a[S]),c||(I=I*A+h,C=C*A+h,S=S*A+h);for(let v=0;v<3;v++){let T,x,L;c?(T=r[u[v]](I),x=r[u[v]](C),L=r[u[v]](S)):(T=l[I+v],x=l[C+v],L=l[S+v]);let B=T;x<B&&(B=x),L<B&&(B=L);let D=T;x>D&&(D=x),L>D&&(D=L);const R=(D-B)/2,k=v*2;s[p+k+0]=B+R,s[p+k+1]=R+(Math.abs(B)+R)*Gi}}return s}raycastObject3D(t,e,s=[]){const{material:i}=t;if(i===void 0)return;cl.copy(t.matrixWorld).invert(),bi.copy(e.ray).applyMatrix4(cl),hl.setFromMatrixScale(t.matrixWorld),ll.copy(bi.direction).multiply(hl);const n=ll.length(),r=e.near/n,a=e.far/n;if(e.firstHitOnly===!0){let c=this.raycastFirst(bi,i,r,a);c=al(c,t,e),c&&s.push(c)}else{const c=this.raycast(bi,i,r,a);for(let l=0,h=c.length;l<h;l++){const A=al(c[l],t,e);A&&s.push(A)}}return s}refit(t=null){return(this.indirect?s0:$p)(this,t)}raycast(t,e=Co,s=0,i=1/0){const n=this._roots,r=[],a=this.indirect?i0:qp;for(let c=0,l=n.length;c<l;c++)a(this,c,e,t,r,s,i);return r}raycastFirst(t,e=Co,s=0,i=1/0){const n=this._roots;let r=null;const a=this.indirect?r0:Jp;for(let c=0,l=n.length;c<l;c++){const h=a(this,c,e,t,s,i);h!=null&&(r==null||h.distance<r.distance)&&(r=h)}return r}intersectsGeometry(t,e){let s=!1;const i=this._roots,n=this.indirect?o0:jp;for(let r=0,a=i.length;r<a&&(s=n(this,r,t,e),!s);r++);return s}shapecast(t){const e=Jt.getPrimitive(),s=super.shapecast({...t,intersectsPrimitive:t.intersectsTriangle,scratchPrimitive:e,iterate:this.indirect?Yp:Kp});return Jt.releasePrimitive(e),s}bvhcast(t,e,s){let{intersectsRanges:i,intersectsTriangles:n}=s;const r=Jt.getPrimitive(),a=this.geometry.index,c=this.geometry.attributes.position,l=this.indirect?f=>{const g=this.resolveTriangleIndex(f);gt(r,g*3,a,c)}:f=>{gt(r,f*3,a,c)},h=Jt.getPrimitive(),A=t.geometry.index,u=t.geometry.attributes.position,d=t.indirect?f=>{const g=t.resolveTriangleIndex(f);gt(h,g*3,A,u)}:f=>{gt(h,f*3,A,u)};if(n){if(!(t instanceof Zs))throw new Error('MeshBVH: "intersectsTriangles" callback can only be used with another MeshBVH.');const f=(g,m,E,p,I,C,S,v)=>{for(let T=E,x=E+p;T<x;T++){d(T),h.a.applyMatrix4(e),h.b.applyMatrix4(e),h.c.applyMatrix4(e),h.needsUpdate=!0;for(let L=g,B=g+m;L<B;L++)if(l(L),r.needsUpdate=!0,n(r,h,L,T,I,C,S,v))return!0}return!1};if(i){const g=i;i=function(m,E,p,I,C,S,v,T){return g(m,E,p,I,C,S,v,T)?!0:f(m,E,p,I,C,S,v,T)}}else i=f}return super.bvhcast(t,e,{intersectsRanges:i})}intersectsBox(t,e){return Ri.set(t.min,t.max,e),Ri.needsUpdate=!0,this.shapecast({intersectsBounds:s=>Ri.intersectsBox(s),intersectsTriangle:s=>Ri.intersectsTriangle(s)})}intersectsSphere(t){return this.shapecast({intersectsBounds:e=>t.intersectsBox(e),intersectsTriangle:e=>e.intersectsSphere(t)})}closestPointToGeometry(t,e,s={},i={},n=0,r=1/0){return(this.indirect?A0:e0)(this,t,e,s,i,n,r)}closestPointToPoint(t,e={},s=0,i=1/0){return Mp(this,t,e,s,i)}}const Al=new Xt,ul=new ie,Yn=new U;class u0 extends lA{get isMesh(){return!this.displayEdges}get isLineSegments(){return this.displayEdges}get isLine(){return this.displayEdges}getVertexPosition(...t){return qe.prototype.getVertexPosition.call(this,...t)}constructor(t,e,s=10,i=0){super(),this.material=e,this.geometry=new tr,this.name="BVHRootHelper",this.depth=s,this.displayParents=!1,this.bvh=t,this.displayEdges=!0,this._group=i}raycast(){}update(){const t=this.bvh;this.geometry.dispose(),this.visible=!1,t&&(this.geometry=this.getGeometry(t),this.visible=!0)}getGeometry(t){const e=this._group;let s=null;if(e!==-1)s=this.getBVHBoundPositions(t,e);else{const r=t._roots.map((l,h)=>this.getBVHBoundPositions(t,h)),a=r.reduce((l,h)=>l+h.length,0);s=new Float32Array(a);let c=0;r.forEach(l=>{s.set(l,c),c+=l.length})}const i=this.getBVHBoundIndices(s),n=new tr;return n.setIndex(new ke(i,1,!1)),n.setAttribute("position",new ke(s,3,!1)),n}getBVHBoundIndices(t){const e=t.length/24;let s,i;this.displayEdges?i=new Uint8Array([0,4,1,5,2,6,3,7,0,2,1,3,4,6,5,7,0,1,2,3,4,5,6,7]):i=new Uint8Array([0,1,2,2,1,3,4,6,5,6,7,5,1,4,5,0,4,1,2,3,6,3,7,6,0,2,4,2,6,4,1,5,3,3,5,7]),t.length>65535?s=new Uint32Array(i.length*e):s=new Uint16Array(i.length*e);const n=i.length;for(let r=0;r<e;r++){const a=r*8,c=r*n;for(let l=0;l<n;l++)s[c+l]=a+i[l]}return s}getBVHBoundPositions(t,e=0,s=null){const i=this.depth-1,n=this.displayParents;let r=0;t.traverse((l,h)=>{if(l>=i||h)return r++,!0;n&&r++},e);let a=0;const c=new Float32Array(24*r);return t.traverse((l,h,A)=>{const u=l>=i||h;if(u||n){ht(0,A,Al);const{min:d,max:f}=Al;for(let g=-1;g<=1;g+=2){const m=g<0?d.x:f.x;for(let E=-1;E<=1;E+=2){const p=E<0?d.y:f.y;for(let I=-1;I<=1;I+=2){const C=I<0?d.z:f.z;Yn.set(m,p,C),s&&Yn.applyMatrix4(s),Yn.toArray(c,a),a+=3}}}return u}},e),c}}class uo extends oA{get color(){return this.edgeMaterial.color}get opacity(){return this.edgeMaterial.opacity}set opacity(t){this.edgeMaterial.opacity=t,this.meshMaterial.opacity=t}get objectIndex(){return console.warn('BVHHelper: "objectIndex" has been renamed "instanceId".'),this.instanceId}set objectIndex(t){console.warn('BVHHelper: "objectIndex" has been renamed "instanceId".'),this.instanceId=t}constructor(t=null,e=null,s=10){t instanceof Zs&&(s=e||10,e=t,t=null),typeof e=="number"&&(s=e,e=null),super(),this.name="BVHHelper",this.depth=s,this.mesh=t,this.bvh=e,this.displayParents=!1,this.displayEdges=!0,this.instanceId=0,this._roots=[];const i=new aA({color:65416,transparent:!0,opacity:.3,depthWrite:!1}),n=new yl({color:65416,transparent:!0,opacity:.3,depthWrite:!1});n.color=i.color,this.edgeMaterial=i,this.meshMaterial=n,this.update()}update(){const t=this.mesh,e=this.instanceId;let s=this.bvh||t.geometry.boundsTree||null;if(t&&t.isBatchedMesh&&t.boundsTrees&&!s&&e>=0){const n=t._drawInfo[e];n&&(s=t.boundsTrees[n.geometryIndex]||s)}const i=s?s._roots.length:0;for(;this._roots.length>i;){const n=this._roots.pop();n.geometry.dispose(),this.remove(n)}for(let n=0;n<i;n++){const{depth:r,edgeMaterial:a,meshMaterial:c,displayParents:l,displayEdges:h}=this;if(n>=this._roots.length){const u=new u0(s,a,r,n);this.add(u),this._roots.push(u)}const A=this._roots[n];A.bvh=s,A.depth=r,A.displayParents=l,A.displayEdges=h,A.material=h?a:c,A.update()}}updateMatrixWorld(...t){const e=this.mesh,s=this.parent,i=this.instanceId;e!==null&&(e.updateWorldMatrix(!0,!1),s?this.matrix.copy(s.matrixWorld).invert().multiply(e.matrixWorld):this.matrix.copy(e.matrixWorld),(e.isInstancedMesh||e.isBatchedMesh)&&i>=0&&(e.getMatrixAt(i,ul),this.matrix.multiply(ul)),this.matrix.decompose(this.position,this.quaternion,this.scale)),super.updateMatrixWorld(...t)}copy(t){this.depth=t.depth,this.mesh=t.mesh,this.bvh=t.bvh,this.opacity=t.opacity,this.color.copy(t.color)}clone(){return new uo().copy(this)}dispose(){this.edgeMaterial.dispose(),this.meshMaterial.dispose();const t=this.children;for(let e=0,s=t.length;e<s;e++)t[e].geometry.dispose()}}class d0 extends uo{constructor(...t){console.warn("MeshBVHHelper: Class has been deprecated. Use BVHHelper instead."),super(...t)}}const us={Mesh:qe.prototype.raycast,Line:Tl.prototype.raycast,LineSegments:Cl.prototype.raycast,LineLoop:Sl.prototype.raycast,Points:Bl.prototype.raycast,BatchedMesh:hA.prototype.raycast},xt=new qe,wi=[];function f0(o,t){if(this.isBatchedMesh)g0.call(this,o,t);else{const{geometry:e}=this;if(e.boundsTree)e.boundsTree.raycastObject3D(this,o,t);else{let s;if(this instanceof qe)s=us.Mesh;else if(this instanceof Cl)s=us.LineSegments;else if(this instanceof Sl)s=us.LineLoop;else if(this instanceof Tl)s=us.Line;else if(this instanceof Bl)s=us.Points;else throw new Error("BVH: Fallback raycast function not found.");s.call(this,o,t)}}}function g0(o,t){if(this.boundsTrees){const e=this.boundsTrees,s=this._drawInfo||this._instanceInfo,i=this._drawRanges||this._geometryInfo,n=this.matrixWorld;xt.material=this.material,xt.geometry=this.geometry;const r=xt.geometry.boundsTree,a=xt.geometry.drawRange;xt.geometry.boundingSphere===null&&(xt.geometry.boundingSphere=new cA);for(let c=0,l=s.length;c<l;c++){if(!this.getVisibleAt(c))continue;const h=s[c].geometryIndex;if(xt.geometry.boundsTree=e[h],this.getMatrixAt(c,xt.matrixWorld).premultiply(n),!xt.geometry.boundsTree){this.getBoundingBoxAt(h,xt.geometry.boundingBox),this.getBoundingSphereAt(h,xt.geometry.boundingSphere);const A=i[h];xt.geometry.setDrawRange(A.start,A.count)}xt.raycast(o,wi);for(let A=0,u=wi.length;A<u;A++){const d=wi[A];d.object=this,d.batchId=c,t.push(d)}wi.length=0}xt.geometry.boundsTree=r,xt.geometry.drawRange=a,xt.material=null,xt.geometry=null}else us.BatchedMesh.call(this,o,t)}const _s=new U;function qt(o,t,e,s,i,n){const r=2*Math.PI*i/4,a=Math.max(n-2*i,0),c=Math.PI/4;_s.copy(t),_s[s]=0,_s.normalize();const l=.5*r/(r+a),h=1-_s.angleTo(o)/c;return Math.sign(_s[e])===1?h*l:a/(r+a)+l+l*(1-h)}class fo extends AA{constructor(t=1,e=1,s=1,i=2,n=.1){const r=i*2+1;if(n=Math.min(t/2,e/2,s/2,n),super(1,1,1,r,r,r),this.type="RoundedBoxGeometry",this.parameters={width:t,height:e,depth:s,segments:i,radius:n},r===1)return;const a=this.toNonIndexed();this.index=null,this.attributes.position=a.attributes.position,this.attributes.normal=a.attributes.normal,this.attributes.uv=a.attributes.uv;const c=new U,l=new U,h=new U(t,e,s).divideScalar(2).subScalar(n),A=this.attributes.position.array,u=this.attributes.normal.array,d=this.attributes.uv.array,f=A.length/6,g=new U,m=.5/r;for(let E=0,p=0;E<A.length;E+=3,p+=2)switch(c.fromArray(A,E),l.copy(c),l.x-=Math.sign(l.x)*m,l.y-=Math.sign(l.y)*m,l.z-=Math.sign(l.z)*m,l.normalize(),A[E+0]=h.x*Math.sign(c.x)+l.x*n,A[E+1]=h.y*Math.sign(c.y)+l.y*n,A[E+2]=h.z*Math.sign(c.z)+l.z*n,u[E+0]=l.x,u[E+1]=l.y,u[E+2]=l.z,Math.floor(E/f)){case 0:g.set(1,0,0),d[p+0]=qt(g,l,"z","y",n,s),d[p+1]=1-qt(g,l,"y","z",n,e);break;case 1:g.set(-1,0,0),d[p+0]=1-qt(g,l,"z","y",n,s),d[p+1]=1-qt(g,l,"y","z",n,e);break;case 2:g.set(0,1,0),d[p+0]=1-qt(g,l,"x","z",n,t),d[p+1]=qt(g,l,"z","x",n,s);break;case 3:g.set(0,-1,0),d[p+0]=1-qt(g,l,"x","z",n,t),d[p+1]=1-qt(g,l,"z","x",n,s);break;case 4:g.set(0,0,1),d[p+0]=1-qt(g,l,"x","y",n,t),d[p+1]=1-qt(g,l,"y","x",n,e);break;case 5:g.set(0,0,-1),d[p+0]=qt(g,l,"x","y",n,t),d[p+1]=1-qt(g,l,"y","x",n,e);break}}static fromJSON(t){return new fo(t.width,t.height,t.depth,t.segments,t.radius)}}const qn=new WeakMap;class Eh extends xl{constructor(t){super(t),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(t){return this.decoderPath=t,this}setDecoderConfig(t){return this.decoderConfig=t,this}setWorkerLimit(t){return this.workerLimit=t,this}load(t,e,s,i){const n=new Os(this.manager);n.setPath(this.path),n.setResponseType("arraybuffer"),n.setRequestHeader(this.requestHeader),n.setWithCredentials(this.withCredentials),n.load(t,r=>{this.parse(r,e,i)},s,i)}parse(t,e,s=()=>{}){this.decodeDracoFile(t,e,null,null,Us,s).catch(s)}decodeDracoFile(t,e,s,i,n=vl,r=()=>{}){const a={attributeIDs:s||this.defaultAttributeIDs,attributeTypes:i||this.defaultAttributeTypes,useUniqueIDs:!!s,vertexColorSpace:n};return this.decodeGeometry(t,a).then(e).catch(r)}decodeGeometry(t,e){const s=JSON.stringify(e);if(qn.has(t)){const c=qn.get(t);if(c.key===s)return c.promise;if(t.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let i;const n=this.workerNextTaskID++,r=t.byteLength,a=this._getWorker(n,r).then(c=>(i=c,new Promise((l,h)=>{i._callbacks[n]={resolve:l,reject:h},i.postMessage({type:"decode",id:n,taskConfig:e,buffer:t},[t])}))).then(c=>this._createGeometry(c.geometry));return a.catch(()=>!0).then(()=>{i&&n&&this._releaseTask(i,n)}),qn.set(t,{key:s,promise:a}),a}_createGeometry(t){const e=new tr;t.index&&e.setIndex(new ke(t.index.array,1));for(let s=0;s<t.attributes.length;s++){const{name:i,array:n,itemSize:r,stride:a,vertexColorSpace:c}=t.attributes[s];let l;if(r===a)l=new ke(n,r);else{const h=new uA(n,a);l=new dA(h,r,0)}i==="color"&&(this._assignVertexColorSpace(l,c),l.normalized=!(n instanceof Float32Array)),e.setAttribute(i,l)}return e}_assignVertexColorSpace(t,e){if(e!==Us)return;const s=new Ll;for(let i=0,n=t.count;i<n;i++)s.fromBufferAttribute(t,i),Dl.colorSpaceToWorking(s,Us),t.setXYZ(i,s.r,s.g,s.b)}_loadLibrary(t,e){const s=new Os(this.manager);return s.setPath(this.decoderPath),s.setResponseType(e),s.setWithCredentials(this.withCredentials),new Promise((i,n)=>{s.load(t,i,void 0,n)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const t=typeof WebAssembly!="object"||this.decoderConfig.type==="js",e=[];return t?e.push(this._loadLibrary("draco_decoder.js","text")):(e.push(this._loadLibrary("draco_wasm_wrapper.js","text")),e.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(e).then(s=>{const i=s[0];t||(this.decoderConfig.wasmBinary=s[1]);const n=m0.toString(),r=["/* draco decoder */",i,"","/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([r]))}),this.decoderPending}_getWorker(t,e){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const i=new Worker(this.workerSourceURL);i._callbacks={},i._taskCosts={},i._taskLoad=0,i.postMessage({type:"init",decoderConfig:this.decoderConfig}),i.onmessage=function(n){const r=n.data;switch(r.type){case"decode":i._callbacks[r.id].resolve(r);break;case"error":i._callbacks[r.id].reject(r);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+r.type+'"')}},this.workerPool.push(i)}else this.workerPool.sort(function(i,n){return i._taskLoad>n._taskLoad?-1:1});const s=this.workerPool[this.workerPool.length-1];return s._taskCosts[t]=e,s._taskLoad+=e,s})}_releaseTask(t,e){t._taskLoad-=t._taskCosts[e],delete t._callbacks[e],delete t._taskCosts[e]}debug(){console.log("Task load: ",this.workerPool.map(t=>t._taskLoad))}dispose(){for(let t=0;t<this.workerPool.length;++t)this.workerPool[t].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}}function m0(){let o,t;onmessage=function(r){const a=r.data;switch(a.type){case"init":o=a.decoderConfig,t=new Promise(function(h){o.onModuleLoaded=function(A){h({draco:A})},DracoDecoderModule(o)});break;case"decode":const c=a.buffer,l=a.taskConfig;t.then(h=>{const A=h.draco,u=new A.Decoder;try{const d=e(A,u,new Int8Array(c),l),f=d.attributes.map(g=>g.array.buffer);d.index&&f.push(d.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:d},f)}catch(d){console.error(d),self.postMessage({type:"error",id:a.id,error:d.message})}finally{A.destroy(u)}});break}};function e(r,a,c,l){const h=l.attributeIDs,A=l.attributeTypes;let u,d;const f=a.GetEncodedGeometryType(c);if(f===r.TRIANGULAR_MESH)u=new r.Mesh,d=a.DecodeArrayToMesh(c,c.byteLength,u);else if(f===r.POINT_CLOUD)u=new r.PointCloud,d=a.DecodeArrayToPointCloud(c,c.byteLength,u);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!d.ok()||u.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+d.error_msg());const g={index:null,attributes:[]};for(const m in h){const E=self[A[m]];let p,I;if(l.useUniqueIDs)I=h[m],p=a.GetAttributeByUniqueId(u,I);else{if(I=a.GetAttributeId(u,r[h[m]]),I===-1)continue;p=a.GetAttribute(u,I)}const C=i(r,a,u,m,E,p);m==="color"&&(C.vertexColorSpace=l.vertexColorSpace),g.attributes.push(C)}return f===r.TRIANGULAR_MESH&&(g.index=s(r,a,u)),r.destroy(u),g}function s(r,a,c){const h=c.num_faces()*3,A=h*4,u=r._malloc(A);a.GetTrianglesUInt32Array(c,A,u);const d=new Uint32Array(r.HEAPF32.buffer,u,h).slice();return r._free(u),{array:d,itemSize:1}}function i(r,a,c,l,h,A){const u=c.num_points(),d=A.num_components(),f=n(r,h),g=d*h.BYTES_PER_ELEMENT,m=Math.ceil(g/4)*4,E=m/h.BYTES_PER_ELEMENT,p=u*g,I=u*m,C=r._malloc(p);a.GetAttributeDataArrayForAllPoints(c,A,f,p,C);const S=new h(r.HEAPF32.buffer,C,p/h.BYTES_PER_ELEMENT);let v;if(g===m)v=S.slice();else{v=new h(I/h.BYTES_PER_ELEMENT);let T=0;for(let x=0,L=S.length;x<L;x++){for(let B=0;B<d;B++)v[T+B]=S[x*d+B];T+=E}}return r._free(C),{name:l,count:u,itemSize:d,array:v,stride:E}}function n(r,a){switch(a){case Float32Array:return r.DT_FLOAT32;case Int8Array:return r.DT_INT8;case Int16Array:return r.DT_INT16;case Int32Array:return r.DT_INT32;case Uint8Array:return r.DT_UINT8;case Uint16Array:return r.DT_UINT16;case Uint32Array:return r.DT_UINT32}}}var p0="data:image/png;base64,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",E0="data:image/png;base64,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",I0="data:image/png;base64,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";qe.prototype.raycast=f0;var $i=null,y0=new IA,C0=class{constructor(){this.loader=new Rl,this.playerRadius=45,this.playerHeight=180,this.isFirstPerson=!1,this.boundingBoxMinY=0,this.displayPlayer=!1,this.displayCollider=!1,this.displayVisualizer=!1,this.collider=null,this.visualizer=null,this.person=null,this.playerIsOnGround=!1,this.isupdate=!0,this.isFlying=!1,this.fwdPressed=!1,this.bkdPressed=!1,this.lftPressed=!1,this.rgtPressed=!1,this.spacePressed=!1,this.ctPressed=!1,this.shiftPressed=!1,this.prevJoyState={dirX:0,dirY:0,shift:!1},this.nippleModule=null,this.joystickManager=null,this.joystickZoneEl=null,this.lookAreaEl=null,this.jumpBtnEl=null,this.flyBtnEl=null,this.viewBtnEl=null,this.lookPointerId=null,this.isLookDown=!1,this.lastTouchX=0,this.lastTouchY=0,this._camCollisionLerp=.18,this._camEpsilon=.35,this._minCamDistance=1,this._maxCamDistance=4.4,this.orginMaxCamDistance=4.4,this.playerVelocity=new U,this.upVector=new U(0,1,0),this.tempVector=new U,this.tempVector2=new U,this.tempBox=new Xt,this.tempMat=new ie,this.tempSegment=new ne,this.recheckAnimTimer=null,this.camDir=new U,this.moveDir=new U,this.targetQuat=new fA,this.targetMat=new ie,this.rotationSpeed=10,this.DIR_FWD=new U(0,0,-1),this.DIR_BKD=new U(0,0,1),this.DIR_LFT=new U(-1,0,0),this.DIR_RGT=new U(1,0,0),this.DIR_UP=new U(0,1,0),this._personToCam=new U,this._originTmp=new U,this._raycaster=new So(new U,new U(0,-1,0)),this._raycasterPersonToCam=new So(new U,new U),this._boundOnKeydown=async o=>{switch(o.ctrlKey&&(o.code==="KeyW"||o.code==="KeyA"||o.code==="KeyS"||o.code==="KeyD")&&o.preventDefault(),o.code){case"KeyW":this.fwdPressed=!0,this.setAnimationByPressed();break;case"KeyS":this.bkdPressed=!0,this.setAnimationByPressed();break;case"KeyD":this.rgtPressed=!0,this.setAnimationByPressed();break;case"KeyA":this.lftPressed=!0,this.setAnimationByPressed();break;case"ShiftLeft":this.shiftPressed=!0,this.setAnimationByPressed(),this.controls.mouseButtons={LEFT:2,MIDDLE:1,RIGHT:0};break;case"Space":if(this.spacePressed=!0,!this.playerIsOnGround||this.isFlying)return;const t=this.personActions?.get("jumping");if(t&&this.actionState===t)return;this.playPersonAnimationByName("jumping"),this.playerVelocity.y=this.jumpHeight,this.playerIsOnGround=!1;break;case"ControlLeft":this.ctPressed=!0;break;case"KeyV":this.changeView();break;case"KeyF":this.isFlying=!this.isFlying,this.setAnimationByPressed(),!this.isFlying&&!this.playerIsOnGround&&this.playPersonAnimationByName("jumping");break}},this._boundOnKeyup=o=>{switch(o.code){case"KeyW":this.fwdPressed=!1,this.setAnimationByPressed();break;case"KeyS":this.bkdPressed=!1,this.setAnimationByPressed();break;case"KeyD":this.rgtPressed=!1,this.setAnimationByPressed();break;case"KeyA":this.lftPressed=!1,this.setAnimationByPressed();break;case"ShiftLeft":this.shiftPressed=!1,this.setAnimationByPressed(),this.controls.mouseButtons={LEFT:0,MIDDLE:1,RIGHT:2};break;case"Space":this.spacePressed=!1;break;case"ControlLeft":this.ctPressed=!1;break}},this.setAnimationByPressed=()=>{if(this._maxCamDistance=this.orginMaxCamDistance,this.isFlying){if(!this.fwdPressed){this.playPersonAnimationByName("flyidle");return}this.playPersonAnimationByName("flying"),this._maxCamDistance=this.orginMaxCamDistance*2;return}if(this.playerIsOnGround){if(!this.fwdPressed&&!this.bkdPressed&&!this.lftPressed&&!this.rgtPressed){this.playPersonAnimationByName("idle");return}if(this.fwdPressed){this.shiftPressed?this.playPersonAnimationByName("running"):this.playPersonAnimationByName("walking");return}if(!this.isFirstPerson&&(this.lftPressed||this.rgtPressed||this.bkdPressed)){this.shiftPressed?this.playPersonAnimationByName("running"):this.playPersonAnimationByName("walking");return}if(this.lftPressed){this.playPersonAnimationByName("left_walking");return}if(this.rgtPressed){this.playPersonAnimationByName("right_walking");return}if(this.bkdPressed){this.playPersonAnimationByName("walking_backward");return}}this.recheckAnimTimer!==null&&clearTimeout(this.recheckAnimTimer),this.recheckAnimTimer=setTimeout(()=>{this.setAnimationByPressed(),this.recheckAnimTimer=null},200)},this._mouseMove=o=>{document.pointerLockElement===document.body&&this.setToward(o.movementX,o.movementY,1e-4)},this._mouseClick=o=>{this.setPointerLock()},this.onPointerDown=o=>{o.pointerType==="touch"&&(this.isLookDown=!0,this.lookPointerId=o.pointerId,this.lastTouchX=o.clientX,this.lastTouchY=o.clientY,this.lookAreaEl?.setPointerCapture&&this.lookAreaEl.setPointerCapture(o.pointerId),o.preventDefault())},this.onPointerMove=o=>{if(!this.isLookDown||o.pointerId!==this.lookPointerId)return;const t=o.clientX-this.lastTouchX,e=o.clientY-this.lastTouchY;this.lastTouchX=o.clientX,this.lastTouchY=o.clientY,this.setInput({lookDeltaX:t,lookDeltaY:e}),o.preventDefault()},this.onPointerUp=o=>{o.pointerId===this.lookPointerId&&(this.isLookDown=!1,this.lookPointerId=null,this.lookAreaEl?.releasePointerCapture&&this.lookAreaEl.releasePointerCapture(o.pointerId))},this._raycaster.firstHitOnly=!0,this._raycasterPersonToCam.firstHitOnly=!0}async init(o,t){this.scene=o.scene,this.camera=o.camera,this.camera.rotation.order="YXZ",this.controls=o.controls,this.playerModel=o.playerModel,this.initPos=o.initPos?o.initPos:new U(0,0,0),this.intDirection=o.intDirection?o.intDirection:new U(0,0,-1),this.mouseSensity=o.mouseSensity?o.mouseSensity:5;const e=this.playerModel.scale;this.visualizeDepth=0*e,this.gravity=o.playerModel.gravity?o.playerModel.gravity*e:-2400*e,this.jumpHeight=o.playerModel.jumpHeight?o.playerModel.jumpHeight*e:800*e,this.originPlayerSpeed=o.playerModel.speed?o.playerModel.speed*e:400*e,this.playerSpeed=this.originPlayerSpeed,this.playerModel.rotateY=o.playerModel.rotateY?o.playerModel.rotateY:0,this._camCollisionLerp=.18,this._camEpsilon=35*e,this._minCamDistance=o.minCamDistance?o.minCamDistance*e:100*e,this._maxCamDistance=o.maxCamDistance?o.maxCamDistance*e:440*e,this.orginMaxCamDistance=this._maxCamDistance,this.thirdMouseMode=o.thirdMouseMode??1;function s(){return navigator.maxTouchPoints&&navigator.maxTouchPoints>0||"ontouchstart"in window||/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)}this.isShowMobileControls=(o.isShowMobileControls??!0)&&s(),this.isShowMobileControls&&this.initMobileControls(),await this.createBVH(o.colliderMeshUrl),this.createPlayer(),await this.loadPersonGLB(),this.isFirstPerson&&this.person&&this.person.add(this.camera),this.onAllEvent(),this.setCameraPos(),this.setControls(),t&&t()}changeView(){if(this.isFirstPerson=!this.isFirstPerson,this.isFirstPerson)this.player.attach(this.camera),this.camera.position.set(0,40*this.playerModel.scale,30*this.playerModel.scale),this.camera.rotation.set(0,Math.PI,0),this.setPointerLock();else{this.scene.attach(this.camera);const o=this.player.position.clone(),t=new U(0,0,-1).applyQuaternion(this.player.quaternion),e=Math.atan2(t.z,t.x),s=new U(Math.cos(e)*400*this.playerModel.scale,200*this.playerModel.scale,Math.sin(e)*400*this.playerModel.scale);this.camera.position.copy(o).add(s),this.controls.target.copy(o),this.setPointerLock()}}setPointerLock(){((this.thirdMouseMode==0||this.thirdMouseMode==1)&&!this.isFirstPerson||this.isFirstPerson)&&document.body.requestPointerLock()}setCameraPos(){if(this.isFirstPerson)this.camera.position.set(0,40*this.playerModel.scale,30*this.playerModel.scale);else{const o=this.player.position.clone(),t=new U(0,0,-1).applyQuaternion(this.player.quaternion),e=Math.atan2(t.z,t.x),s=new U(Math.cos(e)*400*this.playerModel.scale,-100*this.playerModel.scale,Math.sin(e)*400*this.playerModel.scale);this.camera.position.copy(o).add(s)}this.camera.updateProjectionMatrix()}setControls(){this.thirdMouseMode==0||this.thirdMouseMode==1?this.controls.enabled=!1:this.controls.enabled=!0,this.controls.rotateSpeed=this.mouseSensity*.05,this.controls.maxPolarAngle=Math.PI*(300/360)}resetControls(){this.controls&&(this.controls.enabled=!0,this.controls.enablePan=!0,this.controls.maxPolarAngle=Math.PI/2,this.controls.rotateSpeed=1,this.controls.enableZoom=!0,this.controls.mouseButtons={LEFT:0,MIDDLE:1,RIGHT:2})}async initLoader(){const o=new Eh;o.setDecoderPath("https://unpkg.com/three@0.180.0/examples/jsm/libs/draco/gltf/"),o.setDecoderConfig({type:"js"}),this.loader.setDRACOLoader(o)}async loadPersonGLB(){try{const o=await this.loader.loadAsync(this.playerModel.url);this.person=o.scene;const t=this.playerModel.scale,e=this.playerHeight*t;this.person.scale.set(t,t,t),this.person.position.set(0,-e*.75,0),this.person.traverse(r=>{r.isMesh&&(r.castShadow=!0,r.receiveShadow=!0)}),this.player.add(this.person),this.reset(),this.personMixer=new gA(this.person);const s=o.animations??[];this.personActions=new Map;const i=r=>s.find(a=>a.name===r),n=[[this.playerModel.idleAnim,"idle"],[this.playerModel.walkAnim,"walking"],[this.playerModel.leftWalkAnim||this.playerModel.walkAnim,"left_walking"],[this.playerModel.rightWalkAnim||this.playerModel.walkAnim,"right_walking"],[this.playerModel.backwardAnim||this.playerModel.walkAnim,"walking_backward"],[this.playerModel.jumpAnim,"jumping"],[this.playerModel.runAnim,"running"],[this.playerModel.flyIdleAnim||this.playerModel.idleAnim,"flyidle"],[this.playerModel.flyAnim||this.playerModel.idleAnim,"flying"]];for(const[r,a]of n){const c=i(r);if(!c)continue;const l=this.personMixer.clipAction(c);a==="jumping"?(l.setLoop(mA,1),l.clampWhenFinished=!0,l.setEffectiveTimeScale(1.2)):(l.setLoop(pA,1/0),l.clampWhenFinished=!1,l.setEffectiveTimeScale(1)),l.enabled=!0,l.setEffectiveWeight(0),this.personActions.set(a,l)}this.idleAction=this.personActions.get("idle"),this.walkAction=this.personActions.get("walking"),this.leftWalkAction=this.personActions.get("left_walking"),this.rightWalkAction=this.personActions.get("right_walking"),this.backwardAction=this.personActions.get("walking_backward"),this.jumpAction=this.personActions.get("jumping"),this.runAction=this.personActions.get("running"),this.flyidleAction=this.personActions.get("flyidle"),this.flyAction=this.personActions.get("flying"),this.idleAction.setEffectiveWeight(1),this.idleAction.play(),this.actionState=this.idleAction,this.personMixer.addEventListener("finished",r=>{if(r.action===this.jumpAction){if(this.fwdPressed){this.shiftPressed?this.playPersonAnimationByName("running"):this.playPersonAnimationByName("walking");return}if(this.bkdPressed){this.playPersonAnimationByName("walking_backward");return}if(this.rgtPressed||this.lftPressed){this.playPersonAnimationByName("walking");return}this.playPersonAnimationByName("idle")}})}catch{}}playPersonAnimationByName(o,t=.18){if(!this.personActions||this.ctPressed)return;const e=this.personActions.get(o);if(!e||this.actionState===e)return;const s=this.actionState;e.reset(),e.setEffectiveWeight(1),e.play(),s&&s!==e&&s.fadeOut(t),e.fadeIn(t),this.actionState=e}createPlayer(){const o=new EA({color:new Ll(1,0,0),shadowSide:El,depthTest:!1});o.transparent=!0,o.opacity=this.displayPlayer?.5:0,o.wireframe=!0,o.depthWrite=!1;const t=this.playerRadius*this.playerModel.scale,e=this.playerHeight*this.playerModel.scale;this.player=new qe(new fo(t*2,e,t*2,1,75),o),this.player.geometry.translate(0,-e*.25,0),this.player.capsuleInfo={radius:t,segment:new ne(new U,new U(0,-e*.5,0))},this.player.name="capsule",this.scene.add(this.player),this.reset(),this.player.rotateY(this.playerModel.rotateY??0)}getAngleWithYAxis(o){const t={x:0,y:1,z:0},e=o.x*t.x+o.y*t.y+o.z*t.z,s=Math.sqrt(o.x*o.x+o.y*o.y+o.z*o.z),n=e/(s*1);return Math.acos(n)}async update(o=y0.getDelta()){if(!this.isupdate||!this.player||!this.collider)return;o=Math.min(o,1/30),this.isFlying||this.player.position.addScaledVector(this.playerVelocity,o),this.updateMixers(o),this.camera.getWorldDirection(this.camDir);let t=Math.atan2(this.camDir.z,this.camDir.x)+Math.PI/2;t=2*Math.PI-t,this.moveDir.set(0,0,0),this.fwdPressed&&this.moveDir.add(this.DIR_FWD),this.bkdPressed&&this.moveDir.add(this.DIR_BKD),this.lftPressed&&this.moveDir.add(this.DIR_LFT),this.rgtPressed&&this.moveDir.add(this.DIR_RGT),this.isFlying&&(this.fwdPressed?this.moveDir.y=this.camDir.y:this.moveDir.y=0,this.spacePressed&&this.moveDir.add(this.DIR_UP)),this.isFlying&&this.fwdPressed?this.playerSpeed=this.shiftPressed?this.originPlayerSpeed*12:this.originPlayerSpeed*7:this.playerSpeed=this.shiftPressed?this.originPlayerSpeed*2:this.originPlayerSpeed,this.moveDir.normalize().applyAxisAngle(this.upVector,t),this.player.position.addScaledVector(this.moveDir,this.playerSpeed*o);let e=1/0;this._originTmp.set(this.player.position.x,this.player.position.y,this.player.position.z),this._raycaster.ray.origin.copy(this._originTmp);const s=this._raycaster.intersectObject(this.collider,!1);if(s.length>0){e=this.player.position.y-s[0].point.y;const l=s[0].normal,h=this.getAngleWithYAxis(l)*180/Math.PI,A=this.playerHeight*this.playerModel.scale*.9,u=this.playerHeight*this.playerModel.scale*.75,d=this.playerHeight*this.playerModel.scale*.7;this.isFlying||(e>A?(this.playerVelocity.y+=o*this.gravity,this.player.position.addScaledVector(this.playerVelocity,o),this.playerIsOnGround=!1):e>u&&e<A?h>=0&&h<5?(this.playerVelocity.y+=o*this.gravity,this.player.position.addScaledVector(this.playerVelocity,o),this.playerIsOnGround=!0):(this.playerVelocity.set(0,0,0),this.playerIsOnGround=!0):e>d&&e<u?(this.playerVelocity.set(0,0,0),this.playerIsOnGround=!0):e<d&&(this.playerVelocity.set(0,0,0),this.player.position.set(this.player.position.x,s[0].point.y+u,this.player.position.z),this.playerIsOnGround=!0))}this.player.updateMatrixWorld();const i=this.player.capsuleInfo;this.tempBox.makeEmpty(),this.tempMat.copy(this.collider.matrixWorld).invert(),this.tempSegment.copy(i.segment),this.tempSegment.start.applyMatrix4(this.player.matrixWorld).applyMatrix4(this.tempMat),this.tempSegment.end.applyMatrix4(this.player.matrixWorld).applyMatrix4(this.tempMat),this.tempBox.expandByPoint(this.tempSegment.start),this.tempBox.expandByPoint(this.tempSegment.end),this.tempBox.expandByScalar(i.radius),this.collider?.geometry?.boundsTree?.shapecast({intersectsBounds:l=>l.intersectsBox(this.tempBox),intersectsTriangle:l=>{const h=this.tempVector,A=this.tempVector2,u=l.closestPointToSegment(this.tempSegment,h,A);if(u<i.radius){const d=i.radius-u,f=A.sub(h).normalize();this.tempSegment.start.addScaledVector(f,d),this.tempSegment.end.addScaledVector(f,d)}}});const r=this.tempVector.copy(this.tempSegment.start).applyMatrix4(this.collider.matrixWorld),a=this.tempVector2.subVectors(r,this.player.position),c=Math.max(0,a.length()-1e-5);if(a.normalize().multiplyScalar(c),this.player.position.add(a),!this.isFirstPerson&&!this.isFlying){this.camDir.y=0,this.camDir.normalize(),this.camDir.negate(),this.moveDir.normalize(),this.moveDir.negate();let l;if(this.thirdMouseMode==0||this.thirdMouseMode==2){this.moveDir.lengthSq()>0?l=this.player.position.clone().add(this.moveDir):l=this.player.position.clone().add(this.camDir),this.targetMat.lookAt(this.player.position,l,this.player.up),this.targetQuat.setFromRotationMatrix(this.targetMat);const h=Math.min(1,this.rotationSpeed*o);this.player.quaternion.slerp(this.targetQuat,h)}if((this.thirdMouseMode==1||this.thirdMouseMode==3)&&this.moveDir.lengthSq()>0){l=this.player.position.clone().add(this.moveDir),this.targetMat.lookAt(this.player.position,l,this.player.up),this.targetQuat.setFromRotationMatrix(this.targetMat);const h=Math.min(1,this.rotationSpeed*o);this.player.quaternion.slerp(this.targetQuat,h)}}if(this.isFlying){this.camDir.y=0,this.camDir.normalize(),this.camDir.negate(),this.moveDir.normalize(),this.moveDir.negate();const l=this.player.position.clone().add(this.fwdPressed?this.moveDir:this.camDir);this.targetMat.lookAt(this.player.position,l,this.player.up),this.targetQuat.setFromRotationMatrix(this.targetMat);const h=Math.min(1,this.rotationSpeed*o);this.player.quaternion.slerp(this.targetQuat,h)}if(!this.isFirstPerson){const l=this.player.position.clone();l.y+=30*this.playerModel.scale,this.camera.position.sub(this.controls.target),this.controls.target.copy(l),this.camera.position.add(l),this.controls.update(),this._personToCam.subVectors(this.camera.position,this.player.position);const h=this.player.position.clone().add(new U(0,0,0)),A=this._personToCam.clone().normalize(),u=this._personToCam.length();this._raycasterPersonToCam.set(h,A),this._raycasterPersonToCam.far=u;const d=this._raycasterPersonToCam.intersectObject(this.collider,!1);if(d.length>0){const f=d[0],g=Math.max(f.distance-this._camEpsilon,this._minCamDistance),m=h.clone().add(A.clone().multiplyScalar(g));this.camera.position.lerp(m,this._camCollisionLerp)}else{this._raycasterPersonToCam.far=this._maxCamDistance;const f=this._raycasterPersonToCam.intersectObject(this.collider,!1);let g=this._maxCamDistance;f.length&&(g=f[0].distance-this._camEpsilon);const m=h.clone().add(A.clone().multiplyScalar(g));this.camera.position.lerp(m,this._camCollisionLerp)}}if(this.player.position.y<this.boundingBoxMinY-1){this._originTmp.set(this.player.position.x,1e4,this.player.position.z),this._raycaster.ray.origin.copy(this._originTmp);const l=this._raycaster.intersectObject(this.collider,!1);l.length>0?(console.log("bug"),this.reset(new U(this.player.position.x,l[0].point.y+5,this.player.position.z))):(console.log(""),this.reset(new U(this.player.position.x,this.player.position.y+15,this.player.position.z)))}}reset(o){this.player&&(this.playerVelocity.set(0,0,0),this.player.position.copy(o||this.initPos))}destroy(){this.offAllEvent(),this.player&&(this.player.remove(this.camera),this.scene.remove(this.player)),this.player=null,this.person&&(this.scene.remove(this.person),this.person=null),this.resetControls(),this.visualizer&&(this.scene.remove(this.visualizer),this.visualizer=null),this.collider&&(this.scene.remove(this.collider),this.collider=null),this.destroyMobileControls(),$i=null}onAllEvent(){this.isupdate=!0,this.setPointerLock(),window.addEventListener("keydown",this._boundOnKeydown),window.addEventListener("keyup",this._boundOnKeyup),window.addEventListener("mousemove",this._mouseMove),window.addEventListener("click",this._mouseClick)}offAllEvent(){this.isupdate=!1,document.exitPointerLock(),window.removeEventListener("keydown",this._boundOnKeydown),window.removeEventListener("keyup",this._boundOnKeyup),window.removeEventListener("mousemove",this._mouseMove),window.removeEventListener("click",this._mouseClick)}getPosition(){return this.player.position}updateMixers(o){this.personMixer&&this.personMixer.update(o)}async createBVH(o=""){await this.initLoader();const t=i=>{if(!i.attributes.position)return null;if(i.attributes.normal||i.computeVertexNormals(),!i.attributes.uv){const n=i.attributes.position.count,r=new Float32Array(n*2);i.setAttribute("uv",new ke(r,2))}return i},e=[];if(o==""){if(this.collider&&(this.scene.remove(this.collider),this.collider=null),this.scene.traverse(a=>{const c=a;if(c?.isMesh&&c.geometry&&a.name!=="capsule")try{let l=c.geometry.clone();l.applyMatrix4(c.matrixWorld),l.index&&(l=l.toNonIndexed());const h=t(l);h&&e.push(h)}catch(l){console.warn("",c,l)}}),!e.length)return;const i=new Map,n=new Set;for(const a of e)for(const c of Object.keys(a.attributes)){const l=a.attributes[c],h=l.array.constructor,A=l.itemSize;if(!i.has(c))i.set(c,{itemSize:A,arrayCtor:h,examples:1});else{const u=i.get(c);u.itemSize!==A||u.arrayCtor!==h?n.add(c):u.examples++}}if(n.size){for(const a of e)for(const c of Array.from(n))a.attributes[c]&&a.deleteAttribute(c);for(const a of n)i.delete(a)}const r=Array.from(i.keys());for(const a of e){const c=a.attributes.position.count;for(const l of r)if(!a.attributes[l]){const h=i.get(l),A=c*h.itemSize,u=new h.arrayCtor(A);a.setAttribute(l,new ke(u,h.itemSize))}}}else{const n=(await this.loader.loadAsync(o,c=>{})).scene.children[0];n.name="BVH";let r=n.geometry.clone();r.applyMatrix4(n.matrixWorld),r.index&&(r=r.toNonIndexed());const a=t(r);a&&e.push(a)}const s=yA(e,!1);if(!s){console.error("");return}s.boundsTree=new Zs(s,{maxDepth:100}),this.collider=new qe(s,new yl({opacity:.5,transparent:!0,wireframe:!0})),this.displayCollider&&this.scene.add(this.collider),this.displayVisualizer&&(this.visualizer&&this.scene.remove(this.visualizer),this.visualizer=new d0(this.collider,this.visualizeDepth),this.scene.add(this.visualizer)),this.boundingBoxMinY=this.collider.geometry.boundingBox.min.y}setToward(o,t,e){if(this.isFirstPerson){const s=-o*e*this.mouseSensity,i=-t*e*this.mouseSensity;this.player.rotateY(s),this.camera.rotation.x=CA.clamp(this.camera.rotation.x+i,-1.1,1.4)}else{const s=this.mouseSensity,i=-o*e*s,n=-t*e*s,r=this.player.position.clone(),a=this.camera.position.distanceTo(r),c=this.camera.position.clone().sub(r);let l=Math.atan2(c.x,c.z),h=Math.acos(c.y/a);l+=i,h+=n,h=Math.max(.1,Math.min(Math.PI-.1,h));const A=a*Math.sin(h)*Math.sin(l),u=a*Math.cos(h),d=a*Math.sin(h)*Math.cos(l);this.camera.position.set(r.x+A,r.y+u,r.z+d),this.camera.lookAt(r)}}setInput(o){if(typeof o.moveX=="number"&&(this.lftPressed=o.moveX==-1,this.rgtPressed=o.moveX==1,this.setAnimationByPressed()),typeof o.moveY=="number"&&(this.fwdPressed=o.moveY==1,this.bkdPressed=o.moveY==-1,this.setAnimationByPressed()),typeof o.lookDeltaX=="number"&&typeof o.lookDeltaY=="number"&&this.setToward(o.lookDeltaX,o.lookDeltaY,.002),typeof o.jump=="boolean")if(o.jump){if(this.spacePressed=!0,!this.playerIsOnGround||this.isFlying)return;this.playPersonAnimationByName("jumping"),this.playerVelocity.y=this.jumpHeight,this.playerIsOnGround=!1}else this.spacePressed=!1;typeof o.shift=="boolean"&&(this.shiftPressed=o.shift),o.toggleView&&this.changeView(),o.toggleFly&&(this.isFlying=!this.isFlying,this.setAnimationByPressed(),!this.isFlying&&!this.playerIsOnGround&&this.playPersonAnimationByName("jumping"))}async initMobileControls(){this.controls.maxPolarAngle=Math.PI*(300/360),this.controls.touches={ONE:null,TWO:null},this.nippleModule=await Ap(()=>import("./index-Dl0pyd0J.js"),[]);const o=this.nippleModule?.default,t=120,e=document.body;this.joystickZoneEl=document.createElement("div"),this.joystickZoneEl.id="joy-zone",Object.assign(this.joystickZoneEl.style,{position:"absolute",left:"16px",bottom:"16px",width:`${t+40}px`,height:`${t+40}px`,touchAction:"none",zIndex:"999",pointerEvents:"auto",WebkitUserSelect:"none",userSelect:"none"}),e.appendChild(this.joystickZoneEl),["touchstart","touchmove","touchend","touchcancel"].forEach(i=>{this.joystickZoneEl?.addEventListener(i,n=>{n.preventDefault()},{passive:!1})}),this.joystickManager=o.create({zone:this.joystickZoneEl,mode:"static",position:{left:`${(t+40)/2}px`,bottom:`${(t+40)/2}px`},color:"#ffffff",size:t,multitouch:!0,maxNumberOfNipples:1}),this.joystickManager.on("move",(i,n)=>{if(!n)return;const r=n.vector?.x??0,a=n.vector?.y??0,c=n.distance??0,l=.5,h=r>l?1:r<-l?-1:0,A=a>l?1:a<-l?-1:0,u=t/2,d=c>=u,f=this.prevJoyState||{dirX:0,dirY:0,shift:!1};h===f.dirX&&A===f.dirY&&d===f.shift||(this.prevJoyState={dirX:h,dirY:A,shift:d},this.setInput({moveX:h,moveY:A,shift:d}))}),this.joystickManager.on("end",()=>{const i=this.prevJoyState||{dirX:0,dirY:0,shift:!1};(i.dirX!==0||i.dirY!==0||i.shift!==!1)&&(this.prevJoyState={dirX:0,dirY:0,shift:!1},this.setInput({moveX:0,moveY:0,shift:!1}))}),this.lookAreaEl=document.createElement("div"),Object.assign(this.lookAreaEl.style,{position:"absolute",right:"0",bottom:"0",width:"50%",height:"100%",zIndex:"998",touchAction:"none",WebkitUserSelect:"none",userSelect:"none"}),e.appendChild(this.lookAreaEl),["touchstart","touchmove","touchend","touchcancel"].forEach(i=>{this.lookAreaEl?.addEventListener(i,n=>{n.preventDefault()},{passive:!1})}),this.lookAreaEl.addEventListener("pointerdown",this.onPointerDown,{passive:!1}),this.lookAreaEl.addEventListener("pointermove",this.onPointerMove,{passive:!1}),this.lookAreaEl.addEventListener("pointerup",this.onPointerUp,{passive:!1}),this.lookAreaEl.addEventListener("pointercancel",this.onPointerUp,{passive:!1});const s=(i,n,r)=>{const a=document.createElement("button"),c={position:"absolute",right:`${i}px`,bottom:`${n}px`,width:"56px",height:"56px",zIndex:"1000",borderRadius:"50%",border:"2px solid black",background:"rgba(0,0,0)",padding:"20px",opacity:"0.95",touchAction:"none",fontSize:"14px",userSelect:"none",overflow:"hidden",boxSizing:"border-box",backgroundColor:"transparent",backgroundRepeat:"no-repeat, no-repeat",backgroundPosition:"center center, center center",backgroundSize:"100% 100%, 80% 80%"};if(r){const l="rgba(0,0,0,0.5)";c.backgroundImage=`linear-gradient(${l}, ${l}), url("${r}")`}return Object.assign(a.style,c),e.appendChild(a),["touchstart","touchend","touchcancel"].forEach(l=>{a.addEventListener(l,h=>{h.preventDefault()},{passive:!1})}),a};this.jumpBtnEl=s(14,14,E0),this.jumpBtnEl.addEventListener("touchstart",i=>{i.preventDefault(),this.setInput({jump:!0})},{passive:!1}),this.jumpBtnEl.addEventListener("touchend",i=>{i.preventDefault(),this.setInput({jump:!1})},{passive:!1}),this.jumpBtnEl.addEventListener("touchcancel",i=>{i.preventDefault(),this.setInput({jump:!1})},{passive:!1}),this.flyBtnEl=s(14,94,p0),this.flyBtnEl.addEventListener("touchstart",i=>{i.preventDefault(),this.setInput({toggleFly:!0})},{passive:!1}),this.viewBtnEl=s(14,214,I0),this.viewBtnEl.addEventListener("touchstart",i=>{i.preventDefault(),this.setInput({toggleView:!0})},{passive:!1})}destroyMobileControls(){try{this.joystickManager&&this.joystickManager.destroy&&(this.joystickManager.destroy(),this.joystickManager=null),this.joystickZoneEl?.parentElement&&(this.joystickZoneEl.parentElement.removeChild(this.joystickZoneEl),this.joystickZoneEl=null),this.lookAreaEl?.parentElement&&(this.lookAreaEl.parentElement.removeChild(this.lookAreaEl),this.lookAreaEl=null),this.jumpBtnEl?.parentElement&&(this.jumpBtnEl.parentElement.removeChild(this.jumpBtnEl),this.jumpBtnEl=null),this.flyBtnEl?.parentElement&&(this.flyBtnEl.parentElement.removeChild(this.flyBtnEl),this.flyBtnEl=null),this.viewBtnEl?.parentElement&&(this.viewBtnEl.parentElement.removeChild(this.viewBtnEl),this.viewBtnEl=null),this.lookAreaEl?.removeEventListener("pointerdown",this.onPointerDown),this.lookAreaEl?.removeEventListener("pointermove",this.onPointerMove),this.lookAreaEl?.removeEventListener("pointerup",this.onPointerUp),this.lookAreaEl?.removeEventListener("pointercancel",this.onPointerUp)}catch(o){console.warn("",o)}}};function S0(){$i||($i=new C0);const o=$i;return{init:(t,e)=>o.init(t,e),changeView:()=>o.changeView(),reset:t=>o.reset(t),update:t=>o.update(t),destroy:()=>o.destroy(),setInput:t=>o.setInput(t),getposition:()=>o.getPosition()}}var Vs=function(){var o=0,t=document.createElement("div");t.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",t.addEventListener("click",function(h){h.preventDefault(),s(++o%t.children.length)},!1);function e(h){return t.appendChild(h.dom),h}function s(h){for(var A=0;A<t.children.length;A++)t.children[A].style.display=A===h?"block":"none";o=h}var i=(performance||Date).now(),n=i,r=0,a=e(new Vs.Panel("FPS","#0ff","#002")),c=e(new Vs.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var l=e(new Vs.Panel("MB","#f08","#201"));return s(0),{REVISION:16,dom:t,addPanel:e,showPanel:s,begin:function(){i=(performance||Date).now()},end:function(){r++;var h=(performance||Date).now();if(c.update(h-i,200),h>=n+1e3&&(a.update(r*1e3/(h-n),100),n=h,r=0,l)){var A=performance.memory;l.update(A.usedJSHeapSize/1048576,A.jsHeapSizeLimit/1048576)}return h},update:function(){i=this.end()},domElement:t,setMode:s}};Vs.Panel=function(o,t,e){var s=1/0,i=0,n=Math.round,r=n(window.devicePixelRatio||1),a=80*r,c=48*r,l=3*r,h=2*r,A=3*r,u=15*r,d=74*r,f=30*r,g=document.createElement("canvas");g.width=a,g.height=c,g.style.cssText="width:80px;height:48px";var m=g.getContext("2d");return m.font="bold "+9*r+"px Helvetica,Arial,sans-serif",m.textBaseline="top",m.fillStyle=e,m.fillRect(0,0,a,c),m.fillStyle=t,m.fillText(o,l,h),m.fillRect(A,u,d,f),m.fillStyle=e,m.globalAlpha=.9,m.fillRect(A,u,d,f),{dom:g,update:function(E,p){s=Math.min(s,E),i=Math.max(i,E),m.fillStyle=e,m.globalAlpha=1,m.fillRect(0,0,a,u),m.fillStyle=t,m.fillText(n(E)+" "+o+" ("+n(s)+"-"+n(i)+")",l,h),m.drawImage(g,A+r,u,d-r,f,A,u,d-r,f),m.fillRect(A+d-r,u,r,f),m.fillStyle=e,m.globalAlpha=.9,m.fillRect(A+d-r,u,r,n((1-E/p)*f))}}};class T0{constructor(t=4){this.pool=t,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0,this.workerCreator=null}_initWorker(t){if(!this.workers[t]){const e=this.workerCreator();e.addEventListener("message",this._onMessage.bind(this,t)),this.workers[t]=e}}_getIdleWorker(){for(let t=0;t<this.pool;t++)if(!(this.workerStatus&1<<t))return t;return-1}_onMessage(t,e){const s=this.workersResolve[t];if(s&&s(e),this.queue.length){const{resolve:i,msg:n,transfer:r}=this.queue.shift();this.workersResolve[t]=i,this.workers[t].postMessage(n,r)}else this.workerStatus^=1<<t}setWorkerCreator(t){this.workerCreator=t}setWorkerLimit(t){this.pool=t}postMessage(t,e){return new Promise(s=>{const i=this._getIdleWorker();i!==-1?(this._initWorker(i),this.workerStatus|=1<<i,this.workersResolve[i]=s,this.workers[i].postMessage(t,e)):this.queue.push({resolve:s,msg:t,transfer:e})})}dispose(){this.workers.forEach(t=>t.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const B0=0,dl=2,x0=1,fl=2,v0=0,L0=1,D0=10,R0=0,Ih=9,yh=15,Ch=16,Sh=22,Th=37,Bh=43,xh=76,vh=83,Lh=97,Dh=100,Rh=103,bh=109,wh=122,kh=123,_h=131,Ph=132,Fh=133,Qh=134,Mh=137,Oh=138,Uh=139,Nh=140,Gh=141,Kh=142,$h=145,Hh=146,Vh=148,Yh=152,Pr=153,b0=154,Fr=155,w0=156,qh=157,Wh=158,Jh=165,jh=166,Xh=1000054e3,zh=1000054001,Zh=1000054004,tA=1000054005,go=1000066e3,eA=1000066004;class Ps{constructor(t,e,s,i){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(t.buffer,t.byteOffset+e,s),this._littleEndian=i,this._offset=0}_nextUint8(){const t=this._dataView.getUint8(this._offset);return this._offset+=1,t}_nextUint16(){const t=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,t}_nextUint32(){const t=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,t}_nextUint64(){const t=this._dataView.getUint32(this._offset,this._littleEndian)+4294967296*this._dataView.getUint32(this._offset+4,this._littleEndian);return this._offset+=8,t}_nextInt32(){const t=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,t}_nextUint8Array(t){const e=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,t);return this._offset+=t,e}_skip(t){return this._offset+=t,this}_scan(t,e=0){const s=this._offset;let i=0;for(;this._dataView.getUint8(this._offset)!==e&&i<t;)i++,this._offset++;return i<t&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+s,i)}}const kt=[171,75,84,88,32,50,48,187,13,10,26,10];function gl(o){return new TextDecoder().decode(o)}function k0(o){const t=new Uint8Array(o.buffer,o.byteOffset,kt.length);if(t[0]!==kt[0]||t[1]!==kt[1]||t[2]!==kt[2]||t[3]!==kt[3]||t[4]!==kt[4]||t[5]!==kt[5]||t[6]!==kt[6]||t[7]!==kt[7]||t[8]!==kt[8]||t[9]!==kt[9]||t[10]!==kt[10]||t[11]!==kt[11])throw new Error("Missing KTX 2.0 identifier.");const e={vkFormat:0,typeSize:1,pixelWidth:0,pixelHeight:0,pixelDepth:0,layerCount:0,faceCount:1,levelCount:0,supercompressionScheme:0,levels:[],dataFormatDescriptor:[{vendorId:0,descriptorType:0,versionNumber:2,colorModel:0,colorPrimaries:1,transferFunction:2,flags:0,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],keyValue:{},globalData:null},s=17*Uint32Array.BYTES_PER_ELEMENT,i=new Ps(o,kt.length,s,!0);e.vkFormat=i._nextUint32(),e.typeSize=i._nextUint32(),e.pixelWidth=i._nextUint32(),e.pixelHeight=i._nextUint32(),e.pixelDepth=i._nextUint32(),e.layerCount=i._nextUint32(),e.faceCount=i._nextUint32(),e.levelCount=i._nextUint32(),e.supercompressionScheme=i._nextUint32();const n=i._nextUint32(),r=i._nextUint32(),a=i._nextUint32(),c=i._nextUint32(),l=i._nextUint64(),h=i._nextUint64(),A=3*Math.max(e.levelCount,1)*8,u=new Ps(o,kt.length+s,A,!0);for(let M=0,O=Math.max(e.levelCount,1);M<O;M++)e.levels.push({levelData:new Uint8Array(o.buffer,o.byteOffset+u._nextUint64(),u._nextUint64()),uncompressedByteLength:u._nextUint64()});const d=new Ps(o,n,r,!0);d._skip(4);const f=d._nextUint16(),g=d._nextUint16(),m=d._nextUint16(),E=d._nextUint16(),p={vendorId:f,descriptorType:g,versionNumber:m,colorModel:d._nextUint8(),colorPrimaries:d._nextUint8(),transferFunction:d._nextUint8(),flags:d._nextUint8(),texelBlockDimension:[d._nextUint8(),d._nextUint8(),d._nextUint8(),d._nextUint8()],bytesPlane:[d._nextUint8(),d._nextUint8(),d._nextUint8(),d._nextUint8(),d._nextUint8(),d._nextUint8(),d._nextUint8(),d._nextUint8()],samples:[]},I=(E/4-6)/4;for(let M=0;M<I;M++){const O={bitOffset:d._nextUint16(),bitLength:d._nextUint8(),channelType:d._nextUint8(),samplePosition:[d._nextUint8(),d._nextUint8(),d._nextUint8(),d._nextUint8()],sampleLower:Number.NEGATIVE_INFINITY,sampleUpper:Number.POSITIVE_INFINITY};64&O.channelType?(O.sampleLower=d._nextInt32(),O.sampleUpper=d._nextInt32()):(O.sampleLower=d._nextUint32(),O.sampleUpper=d._nextUint32()),p.samples[M]=O}e.dataFormatDescriptor.length=0,e.dataFormatDescriptor.push(p);const C=new Ps(o,a,c,!0);for(;C._offset<c;){const M=C._nextUint32(),O=C._scan(M),q=gl(O);if(e.keyValue[q]=C._nextUint8Array(M-O.byteLength-1),q.match(/^ktx/i)){const tt=gl(e.keyValue[q]);e.keyValue[q]=tt.substring(0,tt.lastIndexOf("\0"))}C._skip(M%4?4-M%4:0)}if(h<=0)return e;const S=new Ps(o,l,h,!0),v=S._nextUint16(),T=S._nextUint16(),x=S._nextUint32(),L=S._nextUint32(),B=S._nextUint32(),D=S._nextUint32(),R=[];for(let M=0,O=Math.max(e.levelCount,1);M<O;M++)R.push({imageFlags:S._nextUint32(),rgbSliceByteOffset:S._nextUint32(),rgbSliceByteLength:S._nextUint32(),alphaSliceByteOffset:S._nextUint32(),alphaSliceByteLength:S._nextUint32()});const k=l+S._offset,_=k+x,Q=_+L,F=Q+B,G=new Uint8Array(o.buffer,o.byteOffset+k,x),N=new Uint8Array(o.buffer,o.byteOffset+_,L),$=new Uint8Array(o.buffer,o.byteOffset+Q,B),Y=new Uint8Array(o.buffer,o.byteOffset+F,D);return e.globalData={endpointCount:v,selectorCount:T,imageDescs:R,endpointsData:G,selectorsData:N,tablesData:$,extendedData:Y},e}let Wn,Ie,Qr;const Jn={env:{emscripten_notify_memory_growth:function(o){Qr=new Uint8Array(Ie.exports.memory.buffer)}}};class _0{init(){return Wn||(Wn=typeof fetch<"u"?fetch("data:application/wasm;base64,"+ml).then(t=>t.arrayBuffer()).then(t=>WebAssembly.instantiate(t,Jn)).then(this._init):WebAssembly.instantiate(Buffer.from(ml,"base64"),Jn).then(this._init),Wn)}_init(t){Ie=t.instance,Jn.env.emscripten_notify_memory_growth(0)}decode(t,e=0){if(!Ie)throw new Error("ZSTDDecoder: Await .init() before decoding.");const s=t.byteLength,i=Ie.exports.malloc(s);Qr.set(t,i),e=e||Number(Ie.exports.ZSTD_findDecompressedSize(i,s));const n=Ie.exports.malloc(e),r=Ie.exports.ZSTD_decompress(n,e,i,s),a=Qr.slice(n,n+r);return Ie.exports.free(i),Ie.exports.free(n),a}}const ml="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IAMNACAEQQNxBEADQCACRQ0FIAAgAkF/aiICaiIDIAEgAmotAAA6AAAgA0EDcQ0ACwsgAkEDTQ0AA0AgACACQXxqIgJqIAEgAmooAgA2AgAgAkEDSw0ACwsgAkUNAgNAIAAgAkF/aiICaiABIAJqLQAAOgAAIAINAAsMAgsgAkEDTQ0AIAIhBANAIAMgASgCADYCACABQQRqIQEgA0EEaiEDIARBfGoiBEEDSw0ACyACQQNxIQILIAJFDQADQCADIAEtAAA6AAAgA0EBaiEDIAFBAWohASACQX9qIgINAAsLIAAL8wICAn8BfgJAIAJFDQAgACACaiIDQX9qIAE6AAAgACABOgAAIAJBA0kNACADQX5qIAE6AAAgACABOgABIANBfWogAToAACAAIAE6AAIgAkEHSQ0AIANBfGogAToAACAAIAE6AAMgAkEJSQ0AIABBACAAa0EDcSIEaiIDIAFB/wFxQYGChAhsIgE2AgAgAyACIARrQXxxIgRqIgJBfGogATYCACAEQQlJDQAgAyABNgIIIAMgATYCBCACQXhqIAE2AgAgAkF0aiABNgIAIARBGUkNACADIAE2AhggAyABNgIUIAMgATYCECADIAE2AgwgAkFwaiABNgIAIAJBbGogATYCACACQWhqIAE2AgAgAkFkaiABNgIAIAQgA0EEcUEYciIEayICQSBJDQAgAa0iBUIghiAFhCEFIAMgBGohAQNAIAEgBTcDGCABIAU3AxAgASAFNwMIIAEgBTcDACABQSBqIQEgAkFgaiICQR9LDQALCyAACy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAIajYCACADCy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAFajYCACADCx8AIAAgASACKAIEEAg2AgAgARAEGiAAIAJBCGo2AgQLCAAgAGdBH3MLugUBDX8jAEEQayIKJAACfyAEQQNNBEAgCkEANgIMIApBDGogAyAEEAsaIAAgASACIApBDGpBBBAVIgBBbCAAEAMbIAAgACAESxsMAQsgAEEAIAEoAgBBAXRBAmoQECENQVQgAygAACIGQQ9xIgBBCksNABogAiAAQQVqNgIAIAMgBGoiAkF8aiEMIAJBeWohDiACQXtqIRAgAEEGaiELQQQh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ASIDNgLE4AEgACgCvOABIQQgACABNgK84AEgACABIAJqNgK44AEgACABIAQgA2tqNgLA4AELpgEBAX8gACAAKALs4QEQFjYCyOABIABCADcD+OABIABCADcDuOABIABBwOABakIANwMAIABBqNAAaiIBQYyAgOAANgIAIABBADYCmOIBIABCADcDiOEBIABCAzcDgOEBIABBrNABakHgEikCADcCACAAQbTQAWpB6BIoAgA2AgAgACABNgIMIAAgAEGYIGo2AgggACAAQaAwajYCBCAAIABBEGo2AgALYQEBf0G4fyEDAkAgAUEDSQ0AIAIgABAhIgFBA3YiADYCCCACIAFBAXE2AgQgAiABQQF2QQNxIgM2AgACQCADQX9qIgFBAksNAAJAIAFBAWsOAgEAAgtBbA8LIAAhAwsgAwsMACAAIAEgAkEAEC4LiAQCA38CfiADEBYhBCAAQQBBKBAQIQAgBCACSwRAIAQPCyABRQRAQX8PCwJAAkAgA0EBRg0AIAEoAAAiBkGo6r5pRg0AQXYhAyAGQXBxQdDUtMIBRw0BQQghAyACQQhJDQEgAEEAQSgQECEAIAEoAAQhASAAQQE2AhQgACABrTcDAEEADwsgASACIAMQLyIDIAJLDQAgACADNgIYQXIhAyABIARqIgVBf2otAAAiAkEIcQ0AIAJBIHEiBkUEQEFwIQMgBS0AACIFQacBSw0BIAVBB3GtQgEgBUEDdkEKaq2GIgdCA4h+IAd8IQggBEEBaiEECyACQQZ2IQMgAkECdiEFAkAgAkEDcUF/aiICQQJLBEBBACECDAELAkACQAJAIAJBAWsOAgECAAsgASAEai0AACECIARBAWohBAwCCyABIARqLwAAIQIgBEECaiEEDAELIAEgBGooAAAhAiAEQQRqIQQLIAVBAXEhBQJ+AkACQAJAIANBf2oiA0ECTQRAIANBAWsOAgIDAQtCfyAGRQ0DGiABIARqMQAADAMLIAEgBGovAACtQoACfAwCCyABIARqKAAArQwBCyABIARqKQAACyEHIAAgBTYCICAAIAI2AhwgACAHNwMAQQAhAyAAQQA2AhQgACAHIAggBhsiBzcDCCAAIAdCgIAIIAdCgIAIVBs+AhALIAMLWwEBf0G4fyEDIAIQFiICIAFNBH8gACACakF/ai0AACIAQQNxQQJ0QaAeaigC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C0Egak8NAQsgByAHKQNoNwMQIAcgBykDYDcDCCAEIA0gB0EIaiAHQdwAaiAPIA4gESAQEB4hCwwBCyACIARqIQggBCAKEAcgAkERTwRAIARBEGohAgNAIAIgCkEQaiIKEAcgAkEQaiICIAhJDQALCyAIIAlrIQIgByATNgJcIAkgCCAOa0sEQCAJIAggEWtLBEBBbCELDAILIBAgAiAOayICaiIKIANqIBBNBEAgCCAKIAMQDxoMAgsgCCAKQQAgAmsQDyEIIAcgAiADaiIDNgJkIAggAmshCCAOIQILIAlBEE8EQCADIAhqIQMDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALDAELAkAgCUEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgCUECdCIDQcAeaigCAGoiAhAXIAIgA0HgHmooAgBrIQIgBygCZCEDDAELIAggAhAMCyADQQlJDQAgAyAIaiEDIAhBCGoiCCACQQhqIgJrQQ9MBEADQCAIIAIQDCACQQhqIQIgCEEIaiIIIANJDQAMAgALAAsDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALCyAHQRhqEAQaIAsgDCALEAMiAhshDCAEIAQgC2ogAhshBCAFQX9qIgUNAAsgDBADDQFBbCEMIAdBGGoQBEECSQ0BQQAhCANAIAhBA0cEQCAAIAhBAnQiAmpBrNABaiACIAdqKAJENgIAIAhBAWohCAwBCwsgBygCXCEIC0G6fyEMIA8gCGsiACANIARrSw0AIAQEfyAEIAggABALIABqBUEACyABayEMCyAHQfAAaiQAIAwLkRcCFn8FfiMAQdABayIHJAAgByAAKALw4QEiCDYCvAEgASACaiESIAggACgCgOIBaiETAkACQCAFRQRAIAEhAwwBCyAAKALE4AEhESAAKALA4AEhFSAAKAK84AEhDyAAQQE2AozhAUEAIQgDQCAIQQNHBEAgByAIQQJ0IgJqIAAgAmpBrNABaigCADYCVCAIQQFqIQgMAQsLIAcgETYCZCAHIA82AmAgByABIA9rNgJoQWwhECAHQShqIAMgBBAGEAMNASAFQQQgBUEESBshFyAHQTxqIAdBKGogACgCABATIAdBxABqIAdBKGogACgCCBATIAdBzABqIAdB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IAdB0AFqJAAgEAslACAAQgA3AgAgAEEAOwEIIABBADoACyAAIAE2AgwgACACOgAKC7QFAQN/IwBBMGsiBCQAIABB/wFqIgVBfWohBgJAIAMvAQIEQCAEQRhqIAEgAhAGIgIQAw0BIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahASOgAAIAMgBEEIaiAEQRhqEBI6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0FIAEgBEEQaiAEQRhqEBI6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBSABIARBCGogBEEYahASOgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEjoAACABIAJqIABrIQIMAwsgAyAEQRBqIARBGGoQEjoAAiADIARBCGogBEEYahASOgADIANBBGohAwwAAAsACyAEQRhqIAEgAhAGIgIQAw0AIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahAROgAAIAMgBEEIaiAEQRhqEBE6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0EIAEgBEEQaiAEQRhqEBE6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBCABIARBCGogBEEYahAROgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEToAACABIAJqIABrIQIMAgsgAyAEQRBqIARBGGoQEToAAiADIARBCGogBEEYahAROgADIANBBGohAwwAAAsACyAEQTBqJAAgAgtpAQF/An8CQAJAIAJBB00NACABKAAAQbfIwuF+Rw0AIAAgASgABDYCmOIBQWIgAEEQaiABIAIQPiIDEAMNAhogAEKBgICAEDcDiOEBIAAgASADaiACIANrECoMAQsgACABIAIQKgtBAAsLrQMBBn8jAEGAAWsiAyQAQWIhCAJAIAJBCUkNACAAQZjQAGogAUEIaiIEIAJBeGogAEGY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wOABCwutAgIEfwF+IwBBQGoiBCQAAkACQCACQQhJDQAgASgAAEFwcUHQ1LTCAUcNACABIAIQIiEBIABCADcDCCAAQQA2AgQgACABNgIADAELIARBGGogASACEC0iAxADBEAgACADEBoMAQsgAwRAIABBuH8QGgwBCyACIAQoAjAiA2shAiABIANqIQMDQAJAIAAgAyACIARBCGoQLCIFEAMEfyAFBSACIAVBA2oiBU8NAUG4fwsQGgwCCyAGQQFqIQYgAiAFayECIAMgBWohAyAEKAIMRQ0ACyAEKAI4BEAgAkEDTQRAIABBuH8QGgwCCyADQQRqIQMLIAQoAighAiAEKQMYIQcgAEEANgIEIAAgAyABazYCACAAIAIgBmytIAcgB0J/URs3AwgLIARBQGskAAslAQF/IwBBEGsiAiQAIAIgACABEFEgAigCACEAIAJBEGokACAAC30BBH8jAEGQBGsiBCQAIARB/wE2AggCQCAEQRBqIARBCGogBEEMaiABIAIQFSIGEAMEQCAGIQUMAQtBVCEFIAQoAgwiB0EGSw0AIAMgBEEQaiAEKAIIIAcQQSIFEAMNACAAIAEgBmogAiAGayADEDwhBQsgBEGQBGokACAFC4cBAgJ/An5BABAWIQMCQANAIAEgA08EQAJAIAAoAABBcHFB0NS0wgFGBEAgACABECIiAhADRQ0BQn4PCyAAIAEQVSIEQn1WDQMgBCAFfCIFIARUIQJCfiEEIAINAyAAIAEQUiICEAMNAwsgASACayEBIAAgAmohAAwBCwtCfiAFIAEbIQQLIAQLPwIBfwF+IwBBMGsiAiQAAn5CfiACQQhqIAAgARAtDQAaQgAgAigCHEEBRg0AGiACKQMICyEDIAJBMGokACADC40BAQJ/IwBBMGsiASQAAkAgAEUNACAAKAKI4gENACABIABB/OEBaigCADYCKCABIAApAvThATcDICAAEDAgACgCqOIBIQIgASABKAIoNgIYIAEgASkDIDcDECACIAFBEGoQGyAAQQA2AqjiASABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALKgECfyMAQRBrIgAkACAAQQA2AgggAEIANwMAIAAQWCEBIABBEGokACABC4cBAQN/IwBBEGsiAiQAAkAgACgCAEUgACgCBEVzDQAgAiAAKAIINgIIIAIgACkCADcDAAJ/IAIoAgAiAQRAIAIoAghBqOMJIAERBQAMAQtBqOMJECgLIgFFDQAgASAAKQIANwL04QEgAUH84QFqIAAoAgg2AgAgARBZIAEhAwsgAkEQaiQAIAMLywEBAn8jAEEgayIBJAAgAEGBgIDAADYCtOIBIABBADYCiOIBIABBADYC7OEBIABCADcDkOIBIABBADYCpOMJIABBADYC3OIBIABCADcCzOIBIABBADYCvOIBIABBADYCxOABIABCADcCnOIBIABBpOIBakIANwIAIABBrOIBakEANgIAIAFCADcCECABQgA3AhggASABKQMYNwMIIAEgASkDEDcDACABKAIIQQh2QQFxIQIgAEEANgLg4gEgACACNgKM4gEgAUEgaiQAC3YBA38jAEEwayIBJAAgAARAIAEgAEHE0AFqIgIoAgA2AiggASAAKQK80AE3AyAgACgCACEDIAEgAigCADYCGCABIAApArzQATcDECADIAFBEGoQGyABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALzAEBAX8gACABKAK00AE2ApjiASAAIAEoAgQiAjYCwOABIAAgAjYCvOABIAAgAiABKAIIaiICNgK44AEgACACNgLE4AEgASgCuNABBEAgAEKBgICAEDcDiOEBIAAgAUGk0ABqNgIMIAAgAUGUIGo2AgggACABQZwwajYCBCAAIAFBDGo2AgAgAEGs0AFqIAFBqNABaigCADYCACAAQbDQAWogAUGs0AFqKAIANgIAIABBtNABaiABQbDQAWooAgA2AgAPCyAAQgA3A4jhAQs7ACACRQRAQbp/DwsgBEUEQEFsDwsgAiAEEGAEQCAAIAEgAiADIAQgBRBhDwsgACABIAIgAyAEIAUQZQtGAQF/IwBBEGsiBSQAIAVBCGogBBAOAn8gBS0ACQRAIAAgASACIAMgBBAyDAELIAAgASACIAMgBBA0CyEAIAVBEGokACAACzQAIAAgAyAEIAUQNiIFEAMEQCAFDwsgBSAESQR/IAEgAiADIAVqIAQgBWsgABA1BUG4fwsLRgEBfyMAQRBrIgUkACAFQQhqIAQQDgJ/IAUtAAkEQCAAIAEgAiADIAQQYgwBCyAAIAEgAiADIAQQNQshACAFQRBqJAAgAAtZAQF/QQ8hAiABIABJBEAgAUEE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",P0="display-p3",F0="display-p3-linear";({...Dl.spaces[Us]});const jn=new WeakMap;let Xn=0,zn;class Wt extends xl{constructor(t){super(t),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new T0,this.workerSourceURL="",this.workerConfig=null,typeof MSC_TRANSCODER<"u"&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(t){return this.transcoderPath=t,this}setWorkerLimit(t){return this.workerPool.setWorkerLimit(t),this}async detectSupportAsync(t){return console.warn('KTX2Loader: "detectSupportAsync()" has been deprecated. Use "detectSupport()" and "await renderer.init();" when creating the renderer.'),await t.init(),this.detectSupport(t)}detectSupport(t){return t.isWebGPURenderer===!0?this.workerConfig={astcSupported:t.hasFeature("texture-compression-astc"),astcHDRSupported:!1,etc1Supported:t.hasFeature("texture-compression-etc1"),etc2Supported:t.hasFeature("texture-compression-etc2"),dxtSupported:t.hasFeature("texture-compression-s3tc"),bptcSupported:t.hasFeature("texture-compression-bc"),pvrtcSupported:t.hasFeature("texture-compression-pvrtc")}:(this.workerConfig={astcSupported:t.extensions.has("WEBGL_compressed_texture_astc"),astcHDRSupported:t.extensions.has("WEBGL_compressed_texture_astc")&&t.extensions.get("WEBGL_compressed_texture_astc").getSupportedProfiles().includes("hdr"),etc1Supported:t.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:t.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:t.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:t.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:t.extensions.has("WEBGL_compressed_texture_pvrtc")||t.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},typeof navigator<"u"&&navigator.platform.indexOf("Linux")>=0&&navigator.userAgent.indexOf("Firefox")>=0&&this.workerConfig.astcSupported&&this.workerConfig.etc2Supported&&this.workerConfig.bptcSupported&&this.workerConfig.dxtSupported&&(this.workerConfig.astcSupported=!1,this.workerConfig.etc2Supported=!1)),this}init(){if(!this.transcoderPending){const t=new Os(this.manager);t.setPath(this.transcoderPath),t.setWithCredentials(this.withCredentials);const e=t.loadAsync("basis_transcoder.js"),s=new Os(this.manager);s.setPath(this.transcoderPath),s.setResponseType("arraybuffer"),s.setWithCredentials(this.withCredentials);const i=s.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([e,i]).then(([n,r])=>{const a=Wt.BasisWorker.toString(),c=["/* constants */","let _EngineFormat = "+JSON.stringify(Wt.EngineFormat),"let _EngineType = "+JSON.stringify(Wt.EngineType),"let _TranscoderFormat = "+JSON.stringify(Wt.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(Wt.BasisFormat),"/* basis_transcoder.js */",n,"/* worker */",a.substring(a.indexOf("{")+1,a.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([c])),this.transcoderBinary=r,this.workerPool.setWorkerCreator(()=>{const l=new Worker(this.workerSourceURL),h=this.transcoderBinary.slice(0);return l.postMessage({type:"init",config:this.workerConfig,transcoderBinary:h},[h]),l})}),Xn>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),Xn++}return this.transcoderPending}load(t,e,s,i){if(this.workerConfig===null)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const n=new Os(this.manager);n.setPath(this.path),n.setCrossOrigin(this.crossOrigin),n.setWithCredentials(this.withCredentials),n.setRequestHeader(this.requestHeader),n.setResponseType("arraybuffer"),n.load(t,r=>{this.parse(r,e,i)},s,i)}parse(t,e,s){if(this.workerConfig===null)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");if(jn.has(t))return jn.get(t).promise.then(e).catch(s);this._createTexture(t).then(i=>e?e(i):null).catch(s)}_createTextureFrom(t,e){const{type:s,error:i,data:{faces:n,width:r,height:a,format:c,type:l,dfdFlags:h}}=t;if(s==="error")return Promise.reject(i);let A;if(e.faceCount===6)A=new SA(n,c,l);else{const u=n[0].mipmaps;A=e.layerCount>1?new TA(u,r,a,e.layerCount,c,l):new bl(u,r,a,c,l)}return A.minFilter=n[0].mipmaps.length===1?Hi:wl,A.magFilter=Hi,A.generateMipmaps=!1,A.needsUpdate=!0,A.colorSpace=sA(e),A.premultiplyAlpha=!!(h&x0),A}async _createTexture(t,e={}){const s=k0(new Uint8Array(t)),i=s.vkFormat===go&&s.dataFormatDescriptor[0].colorModel===167;if(!(s.vkFormat===R0||i&&!this.workerConfig.astcHDRSupported))return M0(s);const r=e,a=this.init().then(()=>this.workerPool.postMessage({type:"transcode",buffer:t,taskConfig:r},[t])).then(c=>this._createTextureFrom(c.data,s));return jn.set(t,{promise:a}),a}dispose(){this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),Xn--}}Wt.BasisFormat={ETC1S:0,UASTC:1,UASTC_HDR:2};Wt.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16,BC6H:22,RGB_HALF:24,RGBA_HALF:25};Wt.EngineFormat={RGBAFormat:ds,RGBA_ASTC_4x4_Format:ki,RGB_BPTC_UNSIGNED_Format:OA,RGBA_BPTC_Format:sr,RGBA_ETC2_EAC_Format:_l,RGBA_PVRTC_4BPPV1_Format:er,RGBA_S3TC_DXT5_Format:MA,RGB_ETC1_Format:QA,RGB_ETC2_Format:kl,RGB_PVRTC_4BPPV1_Format:FA,RGBA_S3TC_DXT1_Format:ir};Wt.EngineType={UnsignedByteType:et,HalfFloatType:Ve,FloatType:Ns};Wt.BasisWorker=function(){let o,t,e;const s=_EngineFormat,i=_EngineType,n=_TranscoderFormat,r=_BasisFormat;self.addEventListener("message",function(f){const g=f.data;switch(g.type){case"init":o=g.config,a(g.transcoderBinary);break;case"transcode":t.then(()=>{try{const{faces:m,buffers:E,width:p,height:I,hasAlpha:C,format:S,type:v,dfdFlags:T}=c(g.buffer);self.postMessage({type:"transcode",id:g.id,data:{faces:m,width:p,height:I,hasAlpha:C,format:S,type:v,dfdFlags:T}},E)}catch(m){console.error(m),self.postMessage({type:"error",id:g.id,error:m.message})}});break}});function a(f){t=new Promise(g=>{e={wasmBinary:f,onRuntimeInitialized:g},BASIS(e)}).then(()=>{e.initializeBasis(),e.KTX2File===void 0&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")})}function c(f){const g=new e.KTX2File(new Uint8Array(f));function m(){g.close(),g.delete()}if(!g.isValid())throw m(),new Error("THREE.KTX2Loader:	Invalid or unsupported .ktx2 file");let E;if(g.isUASTC())E=r.UASTC;else if(g.isETC1S())E=r.ETC1S;else if(g.isHDR())E=r.UASTC_HDR;else throw new Error("THREE.KTX2Loader: Unknown Basis encoding");const p=g.getWidth(),I=g.getHeight(),C=g.getLayers()||1,S=g.getLevels(),v=g.getFaces(),T=g.getHasAlpha(),x=g.getDFDFlags(),{transcoderFormat:L,engineFormat:B,engineType:D}=A(E,p,I,T);if(!p||!I||!S)throw m(),new Error("THREE.KTX2Loader:	Invalid texture");if(!g.startTranscoding())throw m(),new Error("THREE.KTX2Loader: .startTranscoding failed");const R=[],k=[];for(let _=0;_<v;_++){const Q=[];for(let F=0;F<S;F++){const G=[];let N,$;for(let M=0;M<C;M++){const O=g.getImageLevelInfo(F,M,_);_===0&&F===0&&M===0&&(O.origWidth%4!==0||O.origHeight%4!==0)&&console.warn("THREE.KTX2Loader: ETC1S and UASTC textures should use multiple-of-four dimensions."),S>1?(N=O.origWidth,$=O.origHeight):(N=O.width,$=O.height);let q=new Uint8Array(g.getImageTranscodedSizeInBytes(F,M,0,L));const tt=g.transcodeImage(q,F,M,_,L,0,-1,-1);if(D===i.HalfFloatType&&(q=new Uint16Array(q.buffer,q.byteOffset,q.byteLength/Uint16Array.BYTES_PER_ELEMENT)),!tt)throw m(),new Error("THREE.KTX2Loader: .transcodeImage failed.");G.push(q)}const Y=d(G);Q.push({data:Y,width:N,height:$}),k.push(Y.buffer)}R.push({mipmaps:Q,width:p,height:I,format:B,type:D})}return m(),{faces:R,buffers:k,width:p,height:I,hasAlpha:T,dfdFlags:x,format:B,type:D}}const l=[{if:"astcSupported",basisFormat:[r.UASTC],transcoderFormat:[n.ASTC_4x4,n.ASTC_4x4],engineFormat:[s.RGBA_ASTC_4x4_Format,s.RGBA_ASTC_4x4_Format],engineType:[i.UnsignedByteType],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[r.ETC1S,r.UASTC],transcoderFormat:[n.BC7_M5,n.BC7_M5],engineFormat:[s.RGBA_BPTC_Format,s.RGBA_BPTC_Format],engineType:[i.UnsignedByteType],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[r.ETC1S,r.UASTC],transcoderFormat:[n.BC1,n.BC3],engineFormat:[s.RGBA_S3TC_DXT1_Format,s.RGBA_S3TC_DXT5_Format],engineType:[i.UnsignedByteType],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[r.ETC1S,r.UASTC],transcoderFormat:[n.ETC1,n.ETC2],engineFormat:[s.RGB_ETC2_Format,s.RGBA_ETC2_EAC_Format],engineType:[i.UnsignedByteType],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[r.ETC1S,r.UASTC],transcoderFormat:[n.ETC1],engineFormat:[s.RGB_ETC1_Format],engineType:[i.UnsignedByteType],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[r.ETC1S,r.UASTC],transcoderFormat:[n.PVRTC1_4_RGB,n.PVRTC1_4_RGBA],engineFormat:[s.RGB_PVRTC_4BPPV1_Format,s.RGBA_PVRTC_4BPPV1_Format],engineType:[i.UnsignedByteType],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0},{if:"bptcSupported",basisFormat:[r.UASTC_HDR],transcoderFormat:[n.BC6H],engineFormat:[s.RGB_BPTC_UNSIGNED_Format],engineType:[i.HalfFloatType],priorityHDR:1,needsPowerOfTwo:!1},{basisFormat:[r.ETC1S,r.UASTC],transcoderFormat:[n.RGBA32,n.RGBA32],engineFormat:[s.RGBAFormat,s.RGBAFormat],engineType:[i.UnsignedByteType,i.UnsignedByteType],priorityETC1S:100,priorityUASTC:100,needsPowerOfTwo:!1},{basisFormat:[r.UASTC_HDR],transcoderFormat:[n.RGBA_HALF],engineFormat:[s.RGBAFormat],engineType:[i.HalfFloatType],priorityHDR:100,needsPowerOfTwo:!1}],h={[r.ETC1S]:l.filter(f=>f.basisFormat.includes(r.ETC1S)).sort((f,g)=>f.priorityETC1S-g.priorityETC1S),[r.UASTC]:l.filter(f=>f.basisFormat.includes(r.UASTC)).sort((f,g)=>f.priorityUASTC-g.priorityUASTC),[r.UASTC_HDR]:l.filter(f=>f.basisFormat.includes(r.UASTC_HDR)).sort((f,g)=>f.priorityHDR-g.priorityHDR)};function A(f,g,m,E){const p=h[f];for(let I=0;I<p.length;I++){const C=p[I];if(C.if&&!o[C.if]||!C.basisFormat.includes(f)||E&&C.transcoderFormat.length<2||C.needsPowerOfTwo&&!(u(g)&&u(m)))continue;const S=C.transcoderFormat[E?1:0],v=C.engineFormat[E?1:0],T=C.engineType[0];return{transcoderFormat:S,engineFormat:v,engineType:T}}throw new Error("THREE.KTX2Loader: Failed to identify transcoding target.")}function u(f){return f<=2?!0:(f&f-1)===0&&f!==0}function d(f){if(f.length===1)return f[0];let g=0;for(let p=0;p<f.length;p++){const I=f[p];g+=I.byteLength}const m=new Uint8Array(g);let E=0;for(let p=0;p<f.length;p++){const I=f[p];m.set(I,E),E+=I.byteLength}return m}};const Q0=new Set([ds,nr,Qs,Fs]),Zn={[bh]:ds,[Rh]:Qs,[Dh]:Fs,[Lh]:ds,[vh]:Qs,[xh]:Fs,[Bh]:ds,[Th]:ds,[Sh]:Qs,[Ch]:Qs,[yh]:Fs,[Ih]:Fs,[kh]:nr,[wh]:nr,[Yh]:_l,[Vh]:kl,[Pr]:wA,[b0]:bA,[Fr]:RA,[w0]:DA,[go]:ki,[Wh]:ki,[qh]:ki,[eA]:An,[jh]:An,[Jh]:An,[Qh]:ir,[Fh]:ir,[Ph]:vo,[_h]:vo,[Oh]:xo,[Mh]:xo,[Nh]:LA,[Uh]:vA,[Kh]:xA,[Gh]:BA,[Hh]:sr,[$h]:sr,[tA]:er,[zh]:er,[Zh]:Bo,[Xh]:Bo},cs={[bh]:Ns,[Rh]:Ns,[Dh]:Ns,[Lh]:Ve,[vh]:Ve,[xh]:Ve,[Bh]:et,[Th]:et,[Sh]:et,[Ch]:et,[yh]:et,[Ih]:et,[kh]:Fl,[wh]:Pl,[Yh]:et,[Vh]:et,[Pr]:et,[Pr]:et,[Fr]:et,[Fr]:et,[go]:Ve,[Wh]:et,[qh]:et,[eA]:Ve,[jh]:et,[Jh]:et,[Qh]:et,[Fh]:et,[Ph]:et,[_h]:et,[Oh]:et,[Mh]:et,[Nh]:et,[Uh]:et,[Kh]:et,[Gh]:et,[Hh]:et,[$h]:et,[tA]:et,[zh]:et,[Zh]:et,[Xh]:et};async function M0(o){const{vkFormat:t}=o;if(Zn[t]===void 0)throw new Error("THREE.KTX2Loader: Unsupported vkFormat: "+t);cs[t]===void 0&&console.warn('THREE.KTX2Loader: Missing ".type" for vkFormat: '+t);let e;o.supercompressionScheme===dl&&(zn||(zn=new Promise(async r=>{const a=new _0;await a.init(),r(a)})),e=await zn);const s=[];for(let r=0;r<o.levels.length;r++){const a=Math.max(1,o.pixelWidth>>r),c=Math.max(1,o.pixelHeight>>r),l=o.pixelDepth?Math.max(1,o.pixelDepth>>r):0,h=o.levels[r];let A;if(o.supercompressionScheme===B0)A=h.levelData;else if(o.supercompressionScheme===dl)A=e.decode(h.levelData,h.uncompressedByteLength);else throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");let u;cs[t]===Ns?u=new Float32Array(A.buffer,A.byteOffset,A.byteLength/Float32Array.BYTES_PER_ELEMENT):cs[t]===Ve?u=new Uint16Array(A.buffer,A.byteOffset,A.byteLength/Uint16Array.BYTES_PER_ELEMENT):cs[t]===Fl||cs[t]===Pl?u=new Uint32Array(A.buffer,A.byteOffset,A.byteLength/Uint32Array.BYTES_PER_ELEMENT):u=A,s.push({data:u,width:a,height:c,depth:l})}const i=o.levelCount===0||s.length>1;let n;if(Q0.has(Zn[t]))n=o.pixelDepth===0?new kA(s[0].data,o.pixelWidth,o.pixelHeight):new _A(s[0].data,o.pixelWidth,o.pixelHeight,o.pixelDepth),n.minFilter=i?PA:Lo,n.magFilter=Lo,n.generateMipmaps=o.levelCount===0;else{if(o.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");n=new bl(s,o.pixelWidth,o.pixelHeight),n.minFilter=i?wl:Hi,n.magFilter=Hi}return n.mipmaps=s,n.type=cs[t],n.format=Zn[t],n.colorSpace=sA(o),n.needsUpdate=!0,Promise.resolve(n)}function sA(o){const t=o.dataFormatDescriptor[0];return t.colorPrimaries===L0?t.transferFunction===fl?Us:vl:t.colorPrimaries===D0?t.transferFunction===fl?P0:F0:t.colorPrimaries===v0?To:(console.warn(`THREE.KTX2Loader: Unsupported color primaries, "${t.colorPrimaries}"`),To)}const O0=UA({__name:"cinema",setup(o){const t=eu(),e=S0();let s;const i=new Rl,n=new NA,r=new Vs;let a,c,l,h;const A=new U(.034,3.5,-7.14);let u=null,d=!1;GA(async()=>{u=t.value,c=new KA({antialias:!0});const g=Math.min(window.devicePixelRatio||1,2);c.setPixelRatio(g),c.setSize(u.clientWidth,u.clientHeight,!1),c.toneMapping=$A,c.toneMappingExposure=.6,c.shadowMap.enabled=!0,c.domElement.style.display="block",u.appendChild(c.domElement);const m=r.dom;m.style.position="absolute",m.style.top="0",m.style.right="0",m.style.left="auto",u.appendChild(m),a=new HA(70,u.clientWidth/u.clientHeight,.05,200),a.rotation.order="YXZ",a.position.copy(A),a.lookAt(A.x,A.y,A.z+1),l=new VA(a,c.domElement),l.enableDamping=!0,l.maxDistance=2e3,l.dampingFactor=.1,l.rotateSpeed=1,l.maxPolarAngle=Math.PI/2,l.target.set(A.x,A.y,A.z+1);const E=16777215,p=.6,I=new YA(E,p);I.position.set(-.13,2.51,2.27),I.target.position.set(0,1,0),I.castShadow=!0,I.shadow.camera.top=10,I.shadow.camera.bottom=-10,I.shadow.camera.left=-10,I.shadow.camera.right=10,I.shadow.mapSize.width=1024,I.shadow.mapSize.height=1024,I.shadow.camera.near=0,I.shadow.camera.far=10,I.shadow.bias=-3e-4,n.add(I);const C=new qA(16777215,3);if(n.add(C),h=document.createElement("video"),h.muted=!0,h.playsInline=!0,h.autoplay=!0,he.isSupported()){const L=new he;L.attachMedia(h),L.on(he.Events.MEDIA_ATTACHED,()=>{L.loadSource("https://test-streams.mux.dev/tos_ismc/main.m3u8")})}try{await h.play(),console.log("")}catch(L){console.warn("",L)}const S=new WA(h);s=await JA({scene:n,renderer:c,videoTexture:S,projCamPosition:[.034,3.5,-7.14],projCamParams:{fov:13.2,aspect:2.09,near:.01,far:100},orientationParams:{azimuthDeg:91,elevationDeg:-6,rollDeg:0},projBias:.001,isShowHelper:!1});const v=new Eh;v.setDecoderPath("https://unpkg.com/three@0.180.0/examples/jsm/libs/draco/"),i.setDRACOLoader(v);const T=new Wt;T.setTranscoderPath("https://unpkg.com/three@0.180.0/examples/jsm/libs/basis/"),T.detectSupport(c),i.setKTX2Loader(T),await i.loadAsync("model/cinemamovie_theater_interior.glb").then(L=>{const B=L.scene;B.position.set(69.41,.6,24.9),B.traverse(D=>{D.isMesh&&(D.castShadow=!0,D.receiveShadow=!0,s.addTargetMesh(D))}),n.add(B)}),c.render(n,a),d=!0,e.init({scene:n,camera:a,controls:l,playerModel:{url:"model/person.glb",scale:.005,idleAnim:"idle",walkAnim:"walk",runAnim:"run",jumpAnim:"jump",flyAnim:"flying",flyIdleAnim:"flyidle"},initPos:new U(-.11310870589738897,2.614062115741385,1.2878521164121084),minCamDistance:50,maxCamDistance:300,thirdMouseMode:1}),f(),window.addEventListener("resize",f),c.setAnimationLoop(x);function x(){d?e.update():l.update(),c.render(n,a),s&&s.update(),r?.update()}});const f=()=>{a.aspect=window.innerWidth/window.innerHeight,a.updateProjectionMatrix(),c.setSize(window.innerWidth,window.innerHeight),c.setPixelRatio(window.devicePixelRatio),console.log("resize")};return jA(()=>{try{e.destroy?.(),c&&(c.setAnimationLoop(null),u&&(c.domElement&&c.domElement.parentElement===u&&u.removeChild(c.domElement),r?.dom&&r.dom.parentElement===u&&u.removeChild(r.dom)),c.dispose()),l?.dispose(),n.traverse(g=>{if(g){if(g.material)try{Array.isArray(g.material)?g.material.forEach(m=>m&&m.dispose&&m.dispose()):g.material.dispose()}catch{}if(g.geometry)try{g.geometry.dispose()}catch{}}});try{h.pause(),h.src=""}catch{}window.removeEventListener("resize",f),console.log("")}catch(g){console.error("",g)}}),(g,m)=>(XA(),zA(tu,null,[ft("div",{class:"container",id:"container",ref_key:"cont",ref:t},null,512),m[0]||(m[0]=ZA('<div class="model-credit" data-v-77047b7f> <a href="https://sketchfab.com/3d-models/cinemamovie-theater-interior-dcaf6cdebcad4f03879c24186da257ee" target="_blank" rel="noopener noreferrer" data-v-77047b7f> Sketchfab </a><br data-v-77047b7f> <a href="https://test-streams.mux.dev/tos_ismc/main.m3u8" target="_blank" rel="noopener noreferrer" data-v-77047b7f> hls </a><br data-v-77047b7f> <a href="https://github.com/hh-hang/three-player-controller" target="_blank" rel="noopener noreferrer" data-v-77047b7f> three-player-controller </a></div><a class="source" href="https://github.com/hh-hang/three-video-projection/blob/main/example/src/cinema.vue" target="_blank" rel="noopener noreferrer" data-v-77047b7f><img src="'+su+'" alt="" data-v-77047b7f></a>',2)),m[1]||(m[1]=ft("div",{class:"hud",role:"note","aria-label":""},[ft("div",{class:"row hint-group"},[ft("span",{class:"hint-text"},""),ft("kbd",null,"W"),ft("kbd",null,"A"),ft("kbd",null,"S"),ft("kbd",null,"D")]),ft("div",{class:"row hint-group"},[ft("span",{class:"hint-text"},""),ft("kbd",null,"Shift")]),ft("div",{class:"row hint-group"},[ft("span",{class:"hint-text"},""),ft("kbd",null,"Space")]),ft("div",{class:"row hint-group"},[ft("span",{class:"hint-text"},""),ft("kbd",null,"V")]),ft("div",{class:"row hint-group"},[ft("span",{class:"hint-text"},""),ft("kbd",null,"F")])],-1))],64))}}),U0=iu(O0,[["__scopeId","data-v-77047b7f"]]);nu(U0).mount("#app");
