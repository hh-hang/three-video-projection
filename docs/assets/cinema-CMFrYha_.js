import{B as Ye,M as Me,l as et,m as N,L as lt,n as mc,p as Et,T as Cs,q as rd,D as Ao,R as pc,s as od,t as Sr,u as Wi,v as Ec,w as is,x as fo,y as $t,z as oi,C as go,E as mo,H as po,I as Eo,J as Ic,K as ad,Q as ld,U as yc,X as ln,Y as Gt,Z as It,$ as Cc,a0 as wt,a1 as Br,a2 as Tc,a3 as cd,a4 as xr,a5 as Sc,a6 as zs,a7 as Tt,a8 as hd,a9 as ud,aa as dd,ab as Ad,ac as Io,ad as fd,ae as gd,af as md,ag as Bc,ah as pd,ai as Ed,aj as Id,ak as vr,al as xc,am as Lr,an as yd,ao as Cd,ap as Td,aq as Rn,ar as yo,as as Sd,at as Bd,au as xd,av as vc,aw as vd,ax as Ld,ay as Rd,az as Dd,aA as bd,aB as Lc,aC as ra,aD as oa,aE as aa,aF as la,aG as wd,aH as ca,aI as ha,aJ as ua,aK as _d,aL as kd,aM as Rc,aN as Zs,aO as ei,aP as Co,aQ as Pd,aR as da,aS as Fd,aT as Md,aU as Dc,aV as Qd,aW as Od,aX as at,aY as Ht,aZ as mi,a_ as _s,a$ as Nd,b0 as Ud,b1 as bc,b2 as wc,b3 as Aa,b4 as fa,b5 as Rr,b6 as Dr,b7 as Gd,b8 as Hd,b9 as Kd,ba as $d,bb as ga,bc as ma,bd as br,be as Dn,bf as ji,bg as Vd,bh as Yd,bi as qd,bj as Wd,bk as _c,bl as kc,bm as wr,bn as js,bo as Js,bp as Bs,bq as se,br as Pc,bs as Fc,bt as jd,bu as Jd,bv as Xd,bw as pa,bx as zd,by as Zd,bz as eA,bA as tA,d as sA,G as iA,S as nA,b as bn,o as rA,W as oA,bB as aA,a as lA,O as cA,bC as hA,A as uA,bD as dA,V as AA,c as fA,e as gA,f as Ea,g as Ia,h as fe,bE as mA,bF as pA,F as EA,r as ya,_ as IA,j as yA,k as CA}from"./_plugin-vue_export-helper-BEONqA_y.js";const K=Number.isFinite||function(o){return typeof o=="number"&&isFinite(o)},TA=Number.isSafeInteger||function(o){return typeof o=="number"&&Math.abs(o)<=SA},SA=Number.MAX_SAFE_INTEGER||9007199254740991;let q=(function(o){return o.NETWORK_ERROR="networkError",o.MEDIA_ERROR="mediaError",o.KEY_SYSTEM_ERROR="keySystemError",o.MUX_ERROR="muxError",o.OTHER_ERROR="otherError",o})({}),k=(function(o){return o.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",o.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",o.KEY_SYSTEM_NO_SESSION="keySystemNoSession",o.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",o.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",o.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",o.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",o.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",o.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",o.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",o.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",o.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",o.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",o.MANIFEST_LOAD_ERROR="manifestLoadError",o.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",o.MANIFEST_PARSING_ERROR="manifestParsingError",o.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",o.LEVEL_EMPTY_ERROR="levelEmptyError",o.LEVEL_LOAD_ERROR="levelLoadError",o.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",o.LEVEL_PARSING_ERROR="levelParsingError",o.LEVEL_SWITCH_ERROR="levelSwitchError",o.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",o.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",o.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",o.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",o.FRAG_LOAD_ERROR="fragLoadError",o.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",o.FRAG_DECRYPT_ERROR="fragDecryptError",o.FRAG_PARSING_ERROR="fragParsingError",o.FRAG_GAP="fragGap",o.REMUX_ALLOC_ERROR="remuxAllocError",o.KEY_LOAD_ERROR="keyLoadError",o.KEY_LOAD_TIMEOUT="keyLoadTimeOut",o.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",o.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",o.BUFFER_APPEND_ERROR="bufferAppendError",o.BUFFER_APPENDING_ERROR="bufferAppendingError",o.BUFFER_STALLED_ERROR="bufferStalledError",o.BUFFER_FULL_ERROR="bufferFullError",o.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",o.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",o.ASSET_LIST_LOAD_ERROR="assetListLoadError",o.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",o.ASSET_LIST_PARSING_ERROR="assetListParsingError",o.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",o.INTERNAL_EXCEPTION="internalException",o.INTERNAL_ABORTED="aborted",o.ATTACH_MEDIA_ERROR="attachMediaError",o.UNKNOWN="unknown",o})({}),y=(function(o){return o.MEDIA_ATTACHING="hlsMediaAttaching",o.MEDIA_ATTACHED="hlsMediaAttached",o.MEDIA_DETACHING="hlsMediaDetaching",o.MEDIA_DETACHED="hlsMediaDetached",o.MEDIA_ENDED="hlsMediaEnded",o.STALL_RESOLVED="hlsStallResolved",o.BUFFER_RESET="hlsBufferReset",o.BUFFER_CODECS="hlsBufferCodecs",o.BUFFER_CREATED="hlsBufferCreated",o.BUFFER_APPENDING="hlsBufferAppending",o.BUFFER_APPENDED="hlsBufferAppended",o.BUFFER_EOS="hlsBufferEos",o.BUFFERED_TO_END="hlsBufferedToEnd",o.BUFFER_FLUSHING="hlsBufferFlushing",o.BUFFER_FLUSHED="hlsBufferFlushed",o.MANIFEST_LOADING="hlsManifestLoading",o.MANIFEST_LOADED="hlsManifestLoaded",o.MANIFEST_PARSED="hlsManifestParsed",o.LEVEL_SWITCHING="hlsLevelSwitching",o.LEVEL_SWITCHED="hlsLevelSwitched",o.LEVEL_LOADING="hlsLevelLoading",o.LEVEL_LOADED="hlsLevelLoaded",o.LEVEL_UPDATED="hlsLevelUpdated",o.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",o.LEVELS_UPDATED="hlsLevelsUpdated",o.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",o.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",o.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",o.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",o.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",o.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",o.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",o.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",o.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",o.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",o.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",o.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",o.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",o.CUES_PARSED="hlsCuesParsed",o.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",o.INIT_PTS_FOUND="hlsInitPtsFound",o.FRAG_LOADING="hlsFragLoading",o.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",o.FRAG_LOADED="hlsFragLoaded",o.FRAG_DECRYPTED="hlsFragDecrypted",o.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",o.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",o.FRAG_PARSING_METADATA="hlsFragParsingMetadata",o.FRAG_PARSED="hlsFragParsed",o.FRAG_BUFFERED="hlsFragBuffered",o.FRAG_CHANGED="hlsFragChanged",o.FPS_DROP="hlsFpsDrop",o.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",o.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",o.ERROR="hlsError",o.DESTROYING="hlsDestroying",o.KEY_LOADING="hlsKeyLoading",o.KEY_LOADED="hlsKeyLoaded",o.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",o.BACK_BUFFER_REACHED="hlsBackBufferReached",o.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",o.ASSET_LIST_LOADING="hlsAssetListLoading",o.ASSET_LIST_LOADED="hlsAssetListLoaded",o.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",o.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",o.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",o.INTERSTITIAL_STARTED="hlsInterstitialStarted",o.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",o.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",o.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",o.INTERSTITIAL_ENDED="hlsInterstitialEnded",o.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",o.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",o.EVENT_CUE_ENTER="hlsEventCueEnter",o})({});var Z={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},V={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};class as{constructor(e,t=0,s=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=s}sample(e,t){const s=Math.pow(this.alpha_,e);this.estimate_=t*(1-s)+s*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class BA{constructor(e,t,s,i=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=s,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new as(e),this.fast_=new as(t),this.defaultTTFB_=i,this.ttfb_=new as(e)}update(e,t){const{slow_:s,fast_:i,ttfb_:n}=this;s.halfLife!==e&&(this.slow_=new as(e,s.getEstimate(),s.getTotalWeight())),i.halfLife!==t&&(this.fast_=new as(t,i.getEstimate(),i.getTotalWeight())),n.halfLife!==e&&(this.ttfb_=new as(e,n.getEstimate(),n.getTotalWeight()))}sample(e,t){e=Math.max(e,this.minDelayMs_);const s=8*t,i=e/1e3,n=s/i;this.fast_.sample(i,n),this.slow_.sample(i,n)}sampleTTFB(e){const t=e/1e3,s=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(s,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}}function xA(o,e,t){return(e=LA(e))in o?Object.defineProperty(o,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):o[e]=t,o}function oe(){return oe=Object.assign?Object.assign.bind():function(o){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var s in t)({}).hasOwnProperty.call(t,s)&&(o[s]=t[s])}return o},oe.apply(null,arguments)}function Ca(o,e){var t=Object.keys(o);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(o);e&&(s=s.filter(function(i){return Object.getOwnPropertyDescriptor(o,i).enumerable})),t.push.apply(t,s)}return t}function ne(o){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ca(Object(t),!0).forEach(function(s){xA(o,s,t[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(t)):Ca(Object(t)).forEach(function(s){Object.defineProperty(o,s,Object.getOwnPropertyDescriptor(t,s))})}return o}function vA(o,e){if(typeof o!="object"||!o)return o;var t=o[Symbol.toPrimitive];if(t!==void 0){var s=t.call(o,e);if(typeof s!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(o)}function LA(o){var e=vA(o,"string");return typeof e=="symbol"?e:e+""}class st{constructor(e,t){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;const s=`[${e}]:`;this.trace=Qt,this.debug=t.debug.bind(null,s),this.log=t.log.bind(null,s),this.warn=t.warn.bind(null,s),this.info=t.info.bind(null,s),this.error=t.error.bind(null,s)}}const Qt=function(){},RA={trace:Qt,debug:Qt,log:Qt,warn:Qt,info:Qt,error:Qt};function _r(){return oe({},RA)}function DA(o,e){const t=self.console[o];return t?t.bind(self.console,`${e?"["+e+"] ":""}[${o}] >`):Qt}function Ta(o,e,t){return e[o]?e[o].bind(e):DA(o,t)}const kr=_r();function bA(o,e,t){const s=_r();if(typeof console=="object"&&o===!0||typeof o=="object"){const i=["debug","log","info","warn","error"];i.forEach(n=>{s[n]=Ta(n,o,t)});try{s.log(`Debug logs enabled for "${e}" in hls.js version 1.6.15`)}catch{return _r()}i.forEach(n=>{kr[n]=Ta(n,o)})}else oe(kr,s);return s}const re=kr;function Vt(o=!0){return typeof self>"u"?void 0:(o||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function wA(o){return typeof self<"u"&&o===self.ManagedMediaSource}function Mc(o,e){const t=Object.keys(o),s=Object.keys(e),i=t.length,n=s.length;return!i||!n||i===n&&!t.some(r=>s.indexOf(r)===-1)}function Ve(o,e=!1){if(typeof TextDecoder<"u"){const l=new TextDecoder("utf-8").decode(o);if(e){const h=l.indexOf("\0");return h!==-1?l.substring(0,h):l}return l.replace(/\0/g,"")}const t=o.length;let s,i,n,r="",a=0;for(;a<t;){if(s=o[a++],s===0&&e)return r;if(s===0||s===3)continue;switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:r+=String.fromCharCode(s);break;case 12:case 13:i=o[a++],r+=String.fromCharCode((s&31)<<6|i&63);break;case 14:i=o[a++],n=o[a++],r+=String.fromCharCode((s&15)<<12|(i&63)<<6|(n&63)<<0);break}}return r}function Re(o){let e="";for(let t=0;t<o.length;t++){let s=o[t].toString(16);s.length<2&&(s="0"+s),e+=s}return e}function Qc(o){return Uint8Array.from(o.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}function _A(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var wn={exports:{}},Sa;function kA(){return Sa||(Sa=1,(function(o,e){(function(t){var s=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,i=/^(?=([^\/?#]*))\1([^]*)$/,n=/(?:\/|^)\.(?=\/)/g,r=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,a={buildAbsoluteURL:function(c,l,h){if(h=h||{},c=c.trim(),l=l.trim(),!l){if(!h.alwaysNormalize)return c;var u=a.parseURL(c);if(!u)throw new Error("Error trying to parse base URL.");return u.path=a.normalizePath(u.path),a.buildURLFromParts(u)}var d=a.parseURL(l);if(!d)throw new Error("Error trying to parse relative URL.");if(d.scheme)return h.alwaysNormalize?(d.path=a.normalizePath(d.path),a.buildURLFromParts(d)):l;var A=a.parseURL(c);if(!A)throw new Error("Error trying to parse base URL.");if(!A.netLoc&&A.path&&A.path[0]!=="/"){var f=i.exec(A.path);A.netLoc=f[1],A.path=f[2]}A.netLoc&&!A.path&&(A.path="/");var g={scheme:A.scheme,netLoc:d.netLoc,path:null,params:d.params,query:d.query,fragment:d.fragment};if(!d.netLoc&&(g.netLoc=A.netLoc,d.path[0]!=="/"))if(!d.path)g.path=A.path,d.params||(g.params=A.params,d.query||(g.query=A.query));else{var m=A.path,E=m.substring(0,m.lastIndexOf("/")+1)+d.path;g.path=a.normalizePath(E)}return g.path===null&&(g.path=h.alwaysNormalize?a.normalizePath(d.path):d.path),a.buildURLFromParts(g)},parseURL:function(c){var l=s.exec(c);return l?{scheme:l[1]||"",netLoc:l[2]||"",path:l[3]||"",params:l[4]||"",query:l[5]||"",fragment:l[6]||""}:null},normalizePath:function(c){for(c=c.split("").reverse().join("").replace(n,"");c.length!==(c=c.replace(r,"")).length;);return c.split("").reverse().join("")},buildURLFromParts:function(c){return c.scheme+c.netLoc+c.path+c.params+c.query+c.fragment}};o.exports=a})()})(wn)),wn.exports}var To=kA();class So{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var ae={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class Oc{constructor(e){this._byteRange=null,this._url=null,this._stats=null,this._streams=null,this.base=void 0,this.relurl=void 0,typeof e=="string"&&(e={url:e}),this.base=e,FA(this,"stats")}setByteRange(e,t){const s=e.split("@",2);let i;s.length===1?i=t?.byteRangeEndOffset||0:i=parseInt(s[1]),this._byteRange=[i,parseInt(s[0])+i]}get baseurl(){return this.base.url}get byteRange(){return this._byteRange===null?[]:this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get elementaryStreams(){return this._streams===null&&(this._streams={[ae.AUDIO]:null,[ae.VIDEO]:null,[ae.AUDIOVIDEO]:null}),this._streams}set elementaryStreams(e){this._streams=e}get hasStats(){return this._stats!==null}get hasStreams(){return this._streams!==null}get stats(){return this._stats===null&&(this._stats=new So),this._stats}set stats(e){this._stats=e}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=To.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[ae.AUDIO]=null,e[ae.VIDEO]=null,e[ae.AUDIOVIDEO]=null}}function ge(o){return o.sn!=="initSegment"}class _n extends Oc{constructor(e,t){super(t),this._decryptdata=null,this._programDateTime=null,this._ref=null,this._bitrate=void 0,this.rawProgramDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.playlistOffset=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get byteLength(){if(this.hasStats){const e=this.stats.total;if(e)return e}if(this.byteRange.length){const e=this.byteRange[0],t=this.byteRange[1];if(K(e)&&K(t))return t-e}return null}get bitrate(){return this.byteLength?this.byteLength*8/this.duration:this._bitrate?this._bitrate:null}set bitrate(e){this._bitrate=e}get decryptdata(){var e;const{levelkeys:t}=this;if(!t||t.NONE)return null;if(t.identity)this._decryptdata||(this._decryptdata=t.identity.getDecryptData(this.sn));else if(!((e=this._decryptdata)!=null&&e.keyId)){const s=Object.keys(t);if(s.length===1){const i=this._decryptdata=t[s[0]]||null;i&&(this._decryptdata=i.getDecryptData(this.sn,t))}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null)return null;const e=K(this.duration)?this.duration:0;return this.programDateTime+e*1e3}get encrypted(){var e;if((e=this._decryptdata)!=null&&e.encrypted)return!0;if(this.levelkeys){var t;const s=Object.keys(this.levelkeys),i=s.length;if(i>1||i===1&&(t=this.levelkeys[s[0]])!=null&&t.encrypted)return!0}return!1}get programDateTime(){return this._programDateTime===null&&this.rawProgramDateTime&&(this.programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime}set programDateTime(e){if(!K(e)){this._programDateTime=this.rawProgramDateTime=null;return}this._programDateTime=e}get ref(){return ge(this)?(this._ref||(this._ref={base:this.base,start:this.start,duration:this.duration,sn:this.sn,programDateTime:this.programDateTime}),this._ref):null}addStart(e){this.setStart(this.start+e)}setStart(e){this.start=e,this._ref&&(this._ref.start=e)}setDuration(e){this.duration=e,this._ref&&(this._ref.duration=e)}setKeyFormat(e){const t=this.levelkeys;if(t){var s;const i=t[e];i&&!((s=this._decryptdata)!=null&&s.keyId)&&(this._decryptdata=i.getDecryptData(this.sn,t))}}abortRequests(){var e,t;(e=this.loader)==null||e.abort(),(t=this.keyLoader)==null||t.abort()}setElementaryStreamInfo(e,t,s,i,n,r=!1){const{elementaryStreams:a}=this,c=a[e];if(!c){a[e]={startPTS:t,endPTS:s,startDTS:i,endDTS:n,partial:r};return}c.startPTS=Math.min(c.startPTS,t),c.endPTS=Math.max(c.endPTS,s),c.startDTS=Math.min(c.startDTS,i),c.endDTS=Math.max(c.endDTS,n)}}class PA extends Oc{constructor(e,t,s,i,n){super(s),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=i;const r=e.enumeratedString("BYTERANGE");r&&this.setByteRange(r,n),n&&(this.fragOffset=n.fragOffset+n.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}function Nc(o,e){const t=Object.getPrototypeOf(o);if(t){const s=Object.getOwnPropertyDescriptor(t,e);return s||Nc(t,e)}}function FA(o,e){const t=Nc(o,e);t&&(t.enumerable=!0,Object.defineProperty(o,e,t))}const Ba=Math.pow(2,32)-1,MA=[].push,Uc={video:1,audio:2,id3:3,text:4};function Ee(o){return String.fromCharCode.apply(null,o)}function Gc(o,e){const t=o[e]<<8|o[e+1];return t<0?65536+t:t}function W(o,e){const t=Hc(o,e);return t<0?4294967296+t:t}function xa(o,e){let t=W(o,e);return t*=Math.pow(2,32),t+=W(o,e+4),t}function Hc(o,e){return o[e]<<24|o[e+1]<<16|o[e+2]<<8|o[e+3]}function QA(o){const e=o.byteLength;for(let t=0;t<e;){const s=W(o,t);if(s>8&&o[t+4]===109&&o[t+5]===111&&o[t+6]===111&&o[t+7]===102)return!0;t=s>1?t+s:e}return!1}function z(o,e){const t=[];if(!e.length)return t;const s=o.byteLength;for(let i=0;i<s;){const n=W(o,i),r=Ee(o.subarray(i+4,i+8)),a=n>1?i+n:s;if(r===e[0])if(e.length===1)t.push(o.subarray(i+8,a));else{const c=z(o.subarray(i+8,a),e.slice(1));c.length&&MA.apply(t,c)}i=a}return t}function OA(o){const e=[],t=o[0];let s=8;const i=W(o,s);s+=4;let n=0,r=0;t===0?(n=W(o,s),r=W(o,s+4),s+=8):(n=xa(o,s),r=xa(o,s+8),s+=16),s+=2;let a=o.length+r;const c=Gc(o,s);s+=2;for(let l=0;l<c;l++){let h=s;const u=W(o,h);h+=4;const d=u&2147483647;if((u&2147483648)>>>31===1)return re.warn("SIDX has hierarchical references (not supported)"),null;const f=W(o,h);h+=4,e.push({referenceSize:d,subsegmentDuration:f,info:{duration:f/i,start:a,end:a+d-1}}),a+=d,h+=4,s=h}return{earliestPresentationTime:n,timescale:i,version:t,referencesCount:c,references:e}}function Kc(o){const e=[],t=z(o,["moov","trak"]);for(let i=0;i<t.length;i++){const n=t[i],r=z(n,["tkhd"])[0];if(r){let a=r[0];const c=W(r,a===0?12:20),l=z(n,["mdia","mdhd"])[0];if(l){a=l[0];const h=W(l,a===0?12:20),u=z(n,["mdia","hdlr"])[0];if(u){const d=Ee(u.subarray(8,12)),A={soun:ae.AUDIO,vide:ae.VIDEO}[d],f=z(n,["mdia","minf","stbl","stsd"])[0],g=NA(f);A?(e[c]={timescale:h,type:A,stsd:g},e[A]=ne({timescale:h,id:c},g)):e[c]={timescale:h,type:d,stsd:g}}}}}return z(o,["moov","mvex","trex"]).forEach(i=>{const n=W(i,4),r=e[n];r&&(r.default={duration:W(i,12),flags:W(i,20)})}),e}function NA(o){const e=o.subarray(8),t=e.subarray(86),s=Ee(e.subarray(4,8));let i=s,n;const r=s==="enca"||s==="encv";if(r){const l=z(e,[s])[0].subarray(s==="enca"?28:78);z(l,["sinf"]).forEach(u=>{const d=z(u,["schm"])[0];if(d){const A=Ee(d.subarray(4,8));if(A==="cbcs"||A==="cenc"){const f=z(u,["frma"])[0];f&&(i=Ee(f))}}})}const a=i;switch(i){case"avc1":case"avc2":case"avc3":case"avc4":{const c=z(t,["avcC"])[0];c&&c.length>3&&(i+="."+Ei(c[1])+Ei(c[2])+Ei(c[3]),n=pi(a==="avc1"?"dva1":"dvav",t));break}case"mp4a":{const c=z(e,[s])[0],l=z(c.subarray(28),["esds"])[0];if(l&&l.length>7){let h=4;if(l[h++]!==3)break;h=kn(l,h),h+=2;const u=l[h++];if(u&128&&(h+=2),u&64&&(h+=l[h++]),l[h++]!==4)break;h=kn(l,h);const d=l[h++];if(d===64)i+="."+Ei(d);else break;if(h+=12,l[h++]!==5)break;h=kn(l,h);const A=l[h++];let f=(A&248)>>3;f===31&&(f+=1+((A&7)<<3)+((l[h]&224)>>5)),i+="."+f}break}case"hvc1":case"hev1":{const c=z(t,["hvcC"])[0];if(c&&c.length>12){const l=c[1],h=["","A","B","C"][l>>6],u=l&31,d=W(c,2),A=(l&32)>>5?"H":"L",f=c[12],g=c.subarray(6,12);i+="."+h+u,i+="."+UA(d).toString(16).toUpperCase(),i+="."+A+f;let m="";for(let E=g.length;E--;){const p=g[E];(p||m)&&(m="."+p.toString(16).toUpperCase()+m)}i+=m}n=pi(a=="hev1"?"dvhe":"dvh1",t);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":{i=pi(i,t)||i;break}case"vp09":{const c=z(t,["vpcC"])[0];if(c&&c.length>6){const l=c[4],h=c[5],u=c[6]>>4&15;i+="."+dt(l)+"."+dt(h)+"."+dt(u)}break}case"av01":{const c=z(t,["av1C"])[0];if(c&&c.length>2){const l=c[1]>>>5,h=c[1]&31,u=c[2]>>>7?"H":"M",d=(c[2]&64)>>6,A=(c[2]&32)>>5,f=l===2&&d?A?12:10:d?10:8,g=(c[2]&16)>>4,m=(c[2]&8)>>3,E=(c[2]&4)>>2,p=c[2]&3;i+="."+l+"."+dt(h)+u+"."+dt(f)+"."+g+"."+m+E+p+"."+dt(1)+"."+dt(1)+"."+dt(1)+"."+0,n=pi("dav1",t)}break}}return{codec:i,encrypted:r,supplemental:n}}function pi(o,e){const t=z(e,["dvvC"]),s=t.length?t[0]:z(e,["dvcC"])[0];if(s){const i=s[2]>>1&127,n=s[2]<<5&32|s[3]>>3&31;return o+"."+dt(i)+"."+dt(n)}}function UA(o){let e=0;for(let t=0;t<32;t++)e|=(o>>t&1)<<31-t;return e>>>0}function kn(o,e){const t=e+5;for(;o[e++]&128&&e<t;);return e}function Ei(o){return("0"+o.toString(16).toUpperCase()).slice(-2)}function dt(o){return(o<10?"0":"")+o}function GA(o,e){if(!o||!e)return;const t=e.keyId;t&&e.isCommonEncryption&&$c(o,(s,i)=>{const n=s.subarray(8,24);n.some(r=>r!==0)||(re.log(`[eme] Patching keyId in 'enc${i?"a":"v"}>sinf>>tenc' box: ${Re(n)} -> ${Re(t)}`),s.set(t,8))})}function HA(o){const e=[];return $c(o,t=>e.push(t.subarray(8,24))),e}function $c(o,e){z(o,["moov","trak"]).forEach(s=>{const i=z(s,["mdia","minf","stbl","stsd"])[0];if(!i)return;const n=i.subarray(8);let r=z(n,["enca"]);const a=r.length>0;a||(r=z(n,["encv"])),r.forEach(c=>{const l=a?c.subarray(28):c.subarray(78);z(l,["sinf"]).forEach(u=>{const d=Vc(u);d&&e(d,a)})})})}function Vc(o){const e=z(o,["schm"])[0];if(e){const t=Ee(e.subarray(4,8));if(t==="cbcs"||t==="cenc"){const s=z(o,["schi","tenc"])[0];if(s)return s}}}function KA(o,e,t){const s={},i=z(o,["moof","traf"]);for(let n=0;n<i.length;n++){const r=i[n],a=z(r,["tfhd"])[0],c=W(a,4),l=e[c];if(!l)continue;s[c]||(s[c]={start:NaN,duration:0,sampleCount:0,timescale:l.timescale,type:l.type});const h=s[c],u=z(r,["tfdt"])[0];if(u){const I=u[0];let C=W(u,4);I===1&&(C===Ba?t.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"):(C*=Ba+1,C+=W(u,8))),K(C)&&(!K(h.start)||C<h.start)&&(h.start=C)}const d=l.default,A=W(a,0)|d?.flags;let f=d?.duration||0;A&8&&(A&2?f=W(a,12):f=W(a,8));const g=z(r,["trun"]);let m=h.start||0,E=0,p=f;for(let I=0;I<g.length;I++){const C=g[I],T=W(C,4),L=h.sampleCount;h.sampleCount+=T;const S=C[3]&1,x=C[3]&4,v=C[2]&1,B=C[2]&2,R=C[2]&4,D=C[2]&8;let b=8,w=T;for(S&&(b+=4),x&&T&&(!(C[b+1]&1)&&h.keyFrameIndex===void 0&&(h.keyFrameIndex=L),b+=4,v?(p=W(C,b),b+=4):p=f,B&&(b+=4),D&&(b+=4),m+=p,E+=p,w--);w--;)v?(p=W(C,b),b+=4):p=f,B&&(b+=4),R&&(C[b+1]&1||h.keyFrameIndex===void 0&&(h.keyFrameIndex=h.sampleCount-(w+1),h.keyFrameStart=m),b+=4),D&&(b+=4),m+=p,E+=p;!E&&f&&(E+=f*T)}h.duration+=E}if(!Object.keys(s).some(n=>s[n].duration)){let n=1/0,r=0;const a=z(o,["sidx"]);for(let c=0;c<a.length;c++){const l=OA(a[c]);if(l!=null&&l.references){n=Math.min(n,l.earliestPresentationTime/l.timescale);const h=l.references.reduce((u,d)=>u+d.info.duration||0,0);r=Math.max(r,h+l.earliestPresentationTime/l.timescale)}}r&&K(r)&&Object.keys(s).forEach(c=>{s[c].duration||(s[c].duration=r*s[c].timescale-s[c].start)})}return s}function $A(o){const e={valid:null,remainder:null},t=z(o,["moof"]);if(t.length<2)return e.remainder=o,e;const s=t[t.length-1];return e.valid=o.slice(0,s.byteOffset-8),e.remainder=o.slice(s.byteOffset-8),e}function tt(o,e){const t=new Uint8Array(o.length+e.length);return t.set(o),t.set(e,o.length),t}function va(o,e){const t=[],s=e.samples,i=e.timescale,n=e.id;let r=!1;return z(s,["moof"]).map(c=>{const l=c.byteOffset-8;z(c,["traf"]).map(u=>{const d=z(u,["tfdt"]).map(A=>{const f=A[0];let g=W(A,4);return f===1&&(g*=Math.pow(2,32),g+=W(A,8)),g/i})[0];return d!==void 0&&(o=d),z(u,["tfhd"]).map(A=>{const f=W(A,4),g=W(A,0)&16777215,m=(g&1)!==0,E=(g&2)!==0,p=(g&8)!==0;let I=0;const C=(g&16)!==0;let T=0;const L=(g&32)!==0;let S=8;f===n&&(m&&(S+=8),E&&(S+=4),p&&(I=W(A,S),S+=4),C&&(T=W(A,S),S+=4),L&&(S+=4),e.type==="video"&&(r=Cn(e.codec)),z(u,["trun"]).map(x=>{const v=x[0],B=W(x,0)&16777215,R=(B&1)!==0;let D=0;const b=(B&4)!==0,w=(B&256)!==0;let F=0;const P=(B&512)!==0;let G=0;const U=(B&1024)!==0,H=(B&2048)!==0;let $=0;const O=W(x,4);let Q=8;R&&(D=W(x,Q),Q+=4),b&&(Q+=4);let Y=D+l;for(let X=0;X<O;X++){if(w?(F=W(x,Q),Q+=4):F=I,P?(G=W(x,Q),Q+=4):G=T,U&&(Q+=4),H&&(v===0?$=W(x,Q):$=Hc(x,Q),Q+=4),e.type===ae.VIDEO){let j=0;for(;j<G;){const ee=W(s,Y);if(Y+=4,VA(r,s[Y])){const Te=s.subarray(Y,Y+ee);Bo(Te,r?2:1,o+$/i,t)}Y+=ee,j+=ee+4}}o+=F/i}}))})})}),t}function Cn(o){if(!o)return!1;const e=o.substring(0,4);return e==="hvc1"||e==="hev1"||e==="dvh1"||e==="dvhe"}function VA(o,e){if(o){const t=e>>1&63;return t===39||t===40}else return(e&31)===6}function Bo(o,e,t,s){const i=Yc(o);let n=0;n+=e;let r=0,a=0,c=0;for(;n<i.length;){r=0;do{if(n>=i.length)break;c=i[n++],r+=c}while(c===255);a=0;do{if(n>=i.length)break;c=i[n++],a+=c}while(c===255);const l=i.length-n;let h=n;if(a<l)n+=a;else if(a>l){re.error(`Malformed SEI payload. ${a} is too small, only ${l} bytes left to parse.`);break}if(r===4){if(i[h++]===181){const d=Gc(i,h);if(h+=2,d===49){const A=W(i,h);if(h+=4,A===1195456820){const f=i[h++];if(f===3){const g=i[h++],m=31&g,E=64&g,p=E?2+m*3:0,I=new Uint8Array(p);if(E){I[0]=g;for(let C=1;C<p;C++)I[C]=i[h++]}s.push({type:f,payloadType:r,pts:t,bytes:I})}}}}}else if(r===5&&a>16){const u=[];for(let f=0;f<16;f++){const g=i[h++].toString(16);u.push(g.length==1?"0"+g:g),(f===3||f===5||f===7||f===9)&&u.push("-")}const d=a-16,A=new Uint8Array(d);for(let f=0;f<d;f++)A[f]=i[h++];s.push({payloadType:r,pts:t,uuid:u.join(""),userData:Ve(A),userDataBytes:A})}}}function Yc(o){const e=o.byteLength,t=[];let s=1;for(;s<e-2;)o[s]===0&&o[s+1]===0&&o[s+2]===3?(t.push(s+2),s+=2):s++;if(t.length===0)return o;const i=e-t.length,n=new Uint8Array(i);let r=0;for(s=0;s<i;r++,s++)r===t[0]&&(r++,t.shift()),n[s]=o[r];return n}function YA(o){const e=o[0];let t="",s="",i=0,n=0,r=0,a=0,c=0,l=0;if(e===0){for(;Ee(o.subarray(l,l+1))!=="\0";)t+=Ee(o.subarray(l,l+1)),l+=1;for(t+=Ee(o.subarray(l,l+1)),l+=1;Ee(o.subarray(l,l+1))!=="\0";)s+=Ee(o.subarray(l,l+1)),l+=1;s+=Ee(o.subarray(l,l+1)),l+=1,i=W(o,12),n=W(o,16),a=W(o,20),c=W(o,24),l=28}else if(e===1){l+=4,i=W(o,l),l+=4;const u=W(o,l);l+=4;const d=W(o,l);for(l+=4,r=2**32*u+d,TA(r)||(r=Number.MAX_SAFE_INTEGER,re.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),a=W(o,l),l+=4,c=W(o,l),l+=4;Ee(o.subarray(l,l+1))!=="\0";)t+=Ee(o.subarray(l,l+1)),l+=1;for(t+=Ee(o.subarray(l,l+1)),l+=1;Ee(o.subarray(l,l+1))!=="\0";)s+=Ee(o.subarray(l,l+1)),l+=1;s+=Ee(o.subarray(l,l+1)),l+=1}const h=o.subarray(l,o.byteLength);return{schemeIdUri:t,value:s,timeScale:i,presentationTime:r,presentationTimeDelta:n,eventDuration:a,id:c,payload:h}}function qA(o,...e){const t=e.length;let s=8,i=t;for(;i--;)s+=e[i].byteLength;const n=new Uint8Array(s);for(n[0]=s>>24&255,n[1]=s>>16&255,n[2]=s>>8&255,n[3]=s&255,n.set(o,4),i=0,s=8;i<t;i++)n.set(e[i],s),s+=e[i].byteLength;return n}function WA(o,e,t){if(o.byteLength!==16)throw new RangeError("Invalid system id");let s,i;s=0,i=new Uint8Array;let n;s>0?(n=new Uint8Array(4),e.length>0&&new DataView(n.buffer).setUint32(0,e.length,!1)):n=new Uint8Array;const r=new Uint8Array(4);return t.byteLength>0&&new DataView(r.buffer).setUint32(0,t.byteLength,!1),qA([112,115,115,104],new Uint8Array([s,0,0,0]),o,n,i,r,t)}function jA(o){const e=[];if(o instanceof ArrayBuffer){const t=o.byteLength;let s=0;for(;s+32<t;){const i=new DataView(o,s),n=JA(i);e.push(n),s+=n.size}}return e}function JA(o){const e=o.getUint32(0),t=o.byteOffset,s=o.byteLength;if(s<e)return{offset:t,size:s};if(o.getUint32(4)!==1886614376)return{offset:t,size:e};const n=o.getUint32(8)>>>24;if(n!==0&&n!==1)return{offset:t,size:e};const r=o.buffer,a=Re(new Uint8Array(r,t+12,16));let c=null,l=null,h=0;if(n===0)h=28;else{const d=o.getUint32(28);if(!d||s<32+d*16)return{offset:t,size:e};c=[];for(let A=0;A<d;A++)c.push(new Uint8Array(r,t+32+A*16,16));h=32+d*16}if(!h)return{offset:t,size:e};const u=o.getUint32(h);return e-32<u?{offset:t,size:e}:(l=new Uint8Array(r,t+h+4,u),{version:n,systemId:a,kids:c,data:l,offset:t,size:e})}const qc=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),ks={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function xo(o,e){const t=ks[e];return!!t&&!!t[o.slice(0,4)]}function ai(o,e,t=!0){return!o.split(",").some(s=>!vo(s,e,t))}function vo(o,e,t=!0){var s;const i=Vt(t);return(s=i?.isTypeSupported(li(o,e)))!=null?s:!1}function li(o,e){return`${e}/mp4;codecs=${o}`}function La(o){if(o){const e=o.substring(0,4);return ks.video[e]}return 2}function cn(o){const e=qc();return o.split(",").reduce((t,s)=>{const n=e&&Cn(s)?9:ks.video[s];return n?(n*2+t)/(t?3:2):(ks.audio[s]+t)/(t?2:1)},0)}const Pn={};function XA(o,e=!0){if(Pn[o])return Pn[o];const t={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[o];for(let i=0;i<t.length;i++){var s;if(vo(t[i],"audio",e))return Pn[o]=t[i],t[i];if(t[i]==="mp3"&&(s=Vt(e))!=null&&s.isTypeSupported("audio/mpeg"))return""}return o}const zA=/flac|opus|mp4a\.40\.34/i;function hn(o,e=!0){return o.replace(zA,t=>XA(t.toLowerCase(),e))}function ZA(o,e){const t=[];if(o){const s=o.split(",");for(let i=0;i<s.length;i++)xo(s[i],"video")||t.push(s[i])}return e&&t.push(e),t.join(",")}function Ji(o,e){if(o&&(o.length>4||["ac-3","ec-3","alac","fLaC","Opus"].indexOf(o)!==-1)&&(Ra(o,"audio")||Ra(o,"video")))return o;if(e){const t=e.split(",");if(t.length>1){if(o){for(let s=t.length;s--;)if(t[s].substring(0,4)===o.substring(0,4))return t[s]}return t[0]}}return e||o}function Ra(o,e){return xo(o,e)&&vo(o,e)}function ef(o){const e=o.split(",");for(let t=0;t<e.length;t++){const s=e[t].split(".");s.length>2&&s[0]==="avc1"&&(e[t]=`avc1.${parseInt(s[1]).toString(16)}${("000"+parseInt(s[2]).toString(16)).slice(-4)}`)}return e.join(",")}function tf(o){if(o.startsWith("av01.")){const e=o.split("."),t=["0","111","01","01","01","0"];for(let s=e.length;s>4&&s<10;s++)e[s]=t[s-4];return e.join(".")}return o}function Da(o){const e=Vt(o)||{isTypeSupported:()=>!1};return{mpeg:e.isTypeSupported("audio/mpeg"),mp3:e.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:e.isTypeSupported('audio/mp4; codecs="ac-3"')}}function Pr(o){return o.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}const sf={supported:!0,powerEfficient:!0,smooth:!0},nf={supported:!1,smooth:!1,powerEfficient:!1},Wc={supported:!0,configurations:[],decodingInfoResults:[sf]};function jc(o,e){return{supported:!1,configurations:e,decodingInfoResults:[nf],error:o}}function rf(o,e,t,s,i,n){const r=o.videoCodec,a=o.audioCodec?o.audioGroups:null,c=n?.audioCodec,l=n?.channels,h=l?parseInt(l):c?1/0:2;let u=null;if(a!=null&&a.length)try{a.length===1&&a[0]?u=e.groups[a[0]].channels:u=a.reduce((d,A)=>{if(A){const f=e.groups[A];if(!f)throw new Error(`Audio track group ${A} not found`);Object.keys(f.channels).forEach(g=>{d[g]=(d[g]||0)+f.channels[g]})}return d},{2:0})}catch{return!0}return r!==void 0&&(r.split(",").some(d=>Cn(d))||o.width>1920&&o.height>1088||o.height>1920&&o.width>1088||o.frameRate>Math.max(s,30)||o.videoRange!=="SDR"&&o.videoRange!==t||o.bitrate>Math.max(i,8e6))||!!u&&K(h)&&Object.keys(u).some(d=>parseInt(d)>h)}function Jc(o,e,t,s={}){const i=o.videoCodec;if(!i&&!o.audioCodec||!t)return Promise.resolve(Wc);const n=[],r=of(o),a=r.length,c=af(o,e,a>0),l=c.length;for(let h=a||1*l||1;h--;){const u={type:"media-source"};if(a&&(u.video=r[h%a]),l){u.audio=c[h%l];const d=u.audio.bitrate;u.video&&d&&(u.video.bitrate-=d)}n.push(u)}if(i){const h=navigator.userAgent;if(i.split(",").some(u=>Cn(u))&&qc())return Promise.resolve(jc(new Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent string: (${h})`),n))}return Promise.all(n.map(h=>{const u=cf(h);return s[u]||(s[u]=t.decodingInfo(h))})).then(h=>({supported:!h.some(u=>!u.supported),configurations:n,decodingInfoResults:h})).catch(h=>({supported:!1,configurations:n,decodingInfoResults:[],error:h}))}function of(o){var e;const t=(e=o.videoCodec)==null?void 0:e.split(","),s=Xc(o),i=o.width||640,n=o.height||480,r=o.frameRate||30,a=o.videoRange.toLowerCase();return t?t.map(c=>{const l={contentType:li(tf(c),"video"),width:i,height:n,bitrate:s,framerate:r};return a!=="sdr"&&(l.transferFunction=a),l}):[]}function af(o,e,t){var s;const i=(s=o.audioCodec)==null?void 0:s.split(","),n=Xc(o);return i&&o.audioGroups?o.audioGroups.reduce((r,a)=>{var c;const l=a?(c=e.groups[a])==null?void 0:c.tracks:null;return l?l.reduce((h,u)=>{if(u.groupId===a){const d=parseFloat(u.channels||"");i.forEach(A=>{const f={contentType:li(A,"audio"),bitrate:t?lf(A,n):n};d&&(f.channels=""+d),h.push(f)})}return h},r):r},[]):[]}function lf(o,e){if(e<=1)return 1;let t=128e3;return o==="ec-3"?t=768e3:o==="ac-3"&&(t=64e4),Math.min(e/2,t)}function Xc(o){return Math.ceil(Math.max(o.bitrate*.9,o.averageBitrate)/1e3)*1e3||1}function cf(o){let e="";const{audio:t,video:s}=o;if(s){const i=Pr(s.contentType);e+=`${i}_r${s.height}x${s.width}f${Math.ceil(s.framerate)}${s.transferFunction||"sd"}_${Math.ceil(s.bitrate/1e5)}`}if(t){const i=Pr(t.contentType);e+=`${s?"_":""}${i}_c${t.channels}`}return e}const Fr=["NONE","TYPE-0","TYPE-1",null];function hf(o){return Fr.indexOf(o)>-1}const un=["SDR","PQ","HLG"];function uf(o){return!!o&&un.indexOf(o)>-1}var Xi={No:"",Yes:"YES",v2:"v2"};function ba(o){const{canSkipUntil:e,canSkipDateRanges:t,age:s}=o,i=s<e/2;return e&&i?t?Xi.v2:Xi.Yes:Xi.No}class wa{constructor(e,t,s){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=s}addDirectives(e){const t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class ci{constructor(e){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(s=>!!s).map(s=>s.substring(0,4)).join(","),"supplemental"in e){var t;this.supplemental=e.supplemental;const s=(t=e.supplemental)==null?void 0:t.videoCodec;s&&s!==e.videoCodec&&(this.codecSet+=`,${s.substring(0,4)}`)}this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return _a(this._audioGroups,e)}hasSubtitleGroup(e){return _a(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t){if(e==="audio"){let s=this._audioGroups;s||(s=this._audioGroups=[]),s.indexOf(t)===-1&&s.push(t)}else if(e==="text"){let s=this._subtitleGroups;s||(s=this._subtitleGroups=[]),s.indexOf(t)===-1&&s.push(t)}}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return(e=this.audioGroups)==null?void 0:e[0]}get textGroupId(){var e;return(e=this.subtitleGroups)==null?void 0:e[0]}addFallback(){}}function _a(o,e){return!e||!o?!1:o.indexOf(e)!==-1}function df(){if(typeof matchMedia=="function"){const o=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(o.media!==e.media)return o.matches===!0}return!1}function Af(o,e){let t=!1,s=[];if(o&&(t=o!=="SDR",s=[o]),e){s=e.allowedVideoRanges||un.slice(0);const i=s.join("")!=="SDR"&&!e.videoCodec;t=e.preferHDR!==void 0?e.preferHDR:i&&df(),t||(s=["SDR"])}return{preferHDR:t,allowedVideoRanges:s}}const ff=o=>{const e=new WeakSet;return(t,s)=>{if(o&&(s=o(t,s)),typeof s=="object"&&s!==null){if(e.has(s))return;e.add(s)}return s}},le=(o,e)=>JSON.stringify(o,ff(e));function gf(o,e,t,s,i){const n=Object.keys(o),r=s?.channels,a=s?.audioCodec,c=i?.videoCodec,l=r&&parseInt(r)===2;let h=!1,u=!1,d=1/0,A=1/0,f=1/0,g=1/0,m=0,E=[];const{preferHDR:p,allowedVideoRanges:I}=Af(e,i);for(let x=n.length;x--;){const v=o[n[x]];h||(h=v.channels[2]>0),d=Math.min(d,v.minHeight),A=Math.min(A,v.minFramerate),f=Math.min(f,v.minBitrate),I.filter(R=>v.videoRanges[R]>0).length>0&&(u=!0)}d=K(d)?d:0,A=K(A)?A:0;const C=Math.max(1080,d),T=Math.max(30,A);f=K(f)?f:t,t=Math.max(f,t),u||(e=void 0);const L=n.length>1;return{codecSet:n.reduce((x,v)=>{const B=o[v];if(v===x)return x;if(E=u?I.filter(R=>B.videoRanges[R]>0):[],L){if(B.minBitrate>t)return ht(v,`min bitrate of ${B.minBitrate} > current estimate of ${t}`),x;if(!B.hasDefaultAudio)return ht(v,"no renditions with default or auto-select sound found"),x;if(a&&v.indexOf(a.substring(0,4))%5!==0)return ht(v,`audio codec preference "${a}" not found`),x;if(r&&!l){if(!B.channels[r])return ht(v,`no renditions with ${r} channel sound found (channels options: ${Object.keys(B.channels)})`),x}else if((!a||l)&&h&&B.channels[2]===0)return ht(v,"no renditions with stereo sound found"),x;if(B.minHeight>C)return ht(v,`min resolution of ${B.minHeight} > maximum of ${C}`),x;if(B.minFramerate>T)return ht(v,`min framerate of ${B.minFramerate} > maximum of ${T}`),x;if(!E.some(R=>B.videoRanges[R]>0))return ht(v,`no variants with VIDEO-RANGE of ${le(E)} found`),x;if(c&&v.indexOf(c.substring(0,4))%5!==0)return ht(v,`video codec preference "${c}" not found`),x;if(B.maxScore<m)return ht(v,`max score of ${B.maxScore} < selected max of ${m}`),x}return x&&(cn(v)>=cn(x)||B.fragmentError>o[x].fragmentError)?x:(g=B.minIndex,m=B.maxScore,v)},void 0),videoRanges:E,preferHDR:p,minFramerate:A,minBitrate:f,minIndex:g}}function ht(o,e){re.log(`[abr] start candidates with "${o}" ignored because ${e}`)}function zc(o){return o.reduce((e,t)=>{let s=e.groups[t.groupId];s||(s=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),s.tracks.push(t);const i=t.channels||"2";return s.channels[i]=(s.channels[i]||0)+1,s.hasDefault=s.hasDefault||t.default,s.hasAutoSelect=s.hasAutoSelect||t.autoselect,s.hasDefault&&(e.hasDefaultAudio=!0),s.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function mf(o,e,t,s){return o.slice(t,s+1).reduce((i,n,r)=>{if(!n.codecSet)return i;const a=n.audioGroups;let c=i[n.codecSet];c||(i[n.codecSet]=c={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:r,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!a,fragmentError:0}),c.minBitrate=Math.min(c.minBitrate,n.bitrate);const l=Math.min(n.height,n.width);return c.minHeight=Math.min(c.minHeight,l),c.minFramerate=Math.min(c.minFramerate,n.frameRate),c.minIndex=Math.min(c.minIndex,r),c.maxScore=Math.max(c.maxScore,n.score),c.fragmentError+=n.fragmentError,c.videoRanges[n.videoRange]=(c.videoRanges[n.videoRange]||0)+1,a&&a.forEach(h=>{if(!h)return;const u=e.groups[h];u&&(c.hasDefaultAudio=c.hasDefaultAudio||e.hasDefaultAudio?u.hasDefault:u.hasAutoSelect||!e.hasDefaultAudio&&!e.hasAutoSelectAudio,Object.keys(u.channels).forEach(d=>{c.channels[d]=(c.channels[d]||0)+u.channels[d]}))}),i},{})}function ka(o){if(!o)return o;const{lang:e,assocLang:t,characteristics:s,channels:i,audioCodec:n}=o;return{lang:e,assocLang:t,characteristics:s,channels:i,audioCodec:n}}function mt(o,e,t){if("attrs"in o){const s=e.indexOf(o);if(s!==-1)return s}for(let s=0;s<e.length;s++){const i=e[s];if(ns(o,i,t))return s}return-1}function ns(o,e,t){const{groupId:s,name:i,lang:n,assocLang:r,default:a}=o,c=o.forced;return(s===void 0||e.groupId===s)&&(i===void 0||e.name===i)&&(n===void 0||pf(n,e.lang))&&(n===void 0||e.assocLang===r)&&(a===void 0||e.default===a)&&(c===void 0||e.forced===c)&&(!("characteristics"in o)||Ef(o.characteristics||"",e.characteristics))&&(t===void 0||t(o,e))}function pf(o,e="--"){return o.length===e.length?o===e:o.startsWith(e)||e.startsWith(o)}function Ef(o,e=""){const t=o.split(","),s=e.split(",");return t.length===s.length&&!t.some(i=>s.indexOf(i)===-1)}function ss(o,e){const{audioCodec:t,channels:s}=o;return(t===void 0||(e.audioCodec||"").substring(0,4)===t.substring(0,4))&&(s===void 0||s===(e.channels||"2"))}function If(o,e,t,s,i){const n=e[s],a=e.reduce((d,A,f)=>{const g=A.uri;return(d[g]||(d[g]=[])).push(f),d},{})[n.uri];a.length>1&&(s=Math.max.apply(Math,a));const c=n.videoRange,l=n.frameRate,h=n.codecSet.substring(0,4),u=Pa(e,s,d=>{if(d.videoRange!==c||d.frameRate!==l||d.codecSet.substring(0,4)!==h)return!1;const A=d.audioGroups,f=t.filter(g=>!A||A.indexOf(g.groupId)!==-1);return mt(o,f,i)>-1});return u>-1?u:Pa(e,s,d=>{const A=d.audioGroups,f=t.filter(g=>!A||A.indexOf(g.groupId)!==-1);return mt(o,f,i)>-1})}function Pa(o,e,t){for(let s=e;s>-1;s--)if(t(o[s]))return s;for(let s=e+1;s<o.length;s++)if(t(o[s]))return s;return-1}function dn(o,e){var t;return!!o&&o!==((t=e.loadLevelObj)==null?void 0:t.uri)}class yf extends st{constructor(e){super("abr",e.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.supportedCache={},this.bwEstimator=void 0,this._abandonRulesCheck=t=>{var s;const{fragCurrent:i,partCurrent:n,hls:r}=this,{autoLevelEnabled:a,media:c}=r;if(!i||!c)return;const l=performance.now(),h=n?n.stats:i.stats,u=n?n.duration:i.duration,d=l-h.loading.start,A=r.minAutoLevel,f=i.level,g=this._nextAutoLevel;if(h.aborted||h.loaded&&h.loaded===h.total||f<=A){this.clearTimer(),this._nextAutoLevel=-1;return}if(!a)return;const m=g>-1&&g!==f,E=!!t||m;if(!E&&(c.paused||!c.playbackRate||!c.readyState))return;const p=r.mainForwardBufferInfo;if(!E&&p===null)return;const I=this.bwEstimator.getEstimateTTFB(),C=Math.abs(c.playbackRate);if(d<=Math.max(I,1e3*(u/(C*2))))return;const T=p?p.len/C:0,L=h.loading.first?h.loading.first-h.loading.start:-1,S=h.loaded&&L>-1,x=this.getBwEstimate(),v=r.levels,B=v[f],R=Math.max(h.loaded,Math.round(u*(i.bitrate||B.averageBitrate)/8));let D=S?d-L:d;D<1&&S&&(D=Math.min(d,h.loaded*8/x));const b=S?h.loaded*1e3/D:0,w=I/1e3,F=b?(R-h.loaded)/b:R*8/x+w;if(F<=T)return;const P=b?b*8:x,G=((s=t?.details||this.hls.latestLevelDetails)==null?void 0:s.live)===!0,U=this.hls.config.abrBandWidthUpFactor;let H=Number.POSITIVE_INFINITY,$;for($=f-1;$>A;$--){const X=v[$].maxBitrate,j=!v[$].details||G;if(H=this.getTimeToLoadFrag(w,P,u*X,j),H<Math.min(T,u+w))break}if(H>=F||H>u*10)return;S?this.bwEstimator.sample(d-Math.min(I,L),h.loaded):this.bwEstimator.sampleTTFB(d);const O=v[$].maxBitrate;this.getBwEstimate()*U>O&&this.resetEstimator(O);const Q=this.findBestLevel(O,A,$,0,T,1,1);Q>-1&&($=Q),this.warn(`Fragment ${i.sn}${n?" part "+n.index:""} of level ${f} is loading too slowly;
      Fragment duration: ${i.duration.toFixed(3)}
      Time to underbuffer: ${T.toFixed(3)} s
      Estimated load time for current fragment: ${F.toFixed(3)} s
      Estimated load time for down switch fragment: ${H.toFixed(3)} s
      TTFB estimate: ${L|0} ms
      Current BW estimate: ${K(x)?x|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${$} @ ${O|0} bps`),r.nextLoadLevel=r.nextAutoLevel=$,this.clearTimer();const Y=()=>{if(this.clearTimer(),this.fragCurrent===i&&this.hls.loadLevel===$&&$>0){const X=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${$>0?"and switching down":""}
      Fragment duration: ${i.duration.toFixed(3)} s
      Time to underbuffer: ${X.toFixed(3)} s`),i.abortRequests(),this.fragCurrent=this.partCurrent=null,$>A){let j=this.findBestLevel(this.hls.levels[A].bitrate,A,$,0,X,1,1);j===-1&&(j=A),this.hls.nextLoadLevel=this.hls.nextAutoLevel=j,this.resetEstimator(this.hls.levels[j].bitrate)}}};m||F>H*2?Y():this.timer=self.setInterval(Y,H*1e3),r.trigger(y.FRAG_LOAD_EMERGENCY_ABORTED,{frag:i,part:n,stats:h})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(this.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new BA(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.FRAG_LOADING,this.onFragLoading,this),e.on(y.FRAG_LOADED,this.onFragLoaded,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this),e.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(y.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.FRAG_LOADING,this.onFragLoading,this),e.off(y.FRAG_LOADED,this.onFragLoaded,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this),e.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(y.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(y.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=this.supportedCache=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.supportedCache={},this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const s=t.frag;if(!this.ignoreFragment(s)){if(!s.bitrateTest){var i;this.fragCurrent=s,this.partCurrent=(i=t.part)!=null?i:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case k.BUFFER_ADD_CODEC_ERROR:case k.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case k.FRAG_LOAD_TIMEOUT:{const s=t.frag,{fragCurrent:i,partCurrent:n}=this;if(s&&i&&s.sn===i.sn&&s.level===i.level){const r=performance.now(),a=n?n.stats:s.stats,c=r-a.loading.start,l=a.loading.first?a.loading.first-a.loading.start:-1;if(a.loaded&&l>-1){const u=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(c-Math.min(u,l),a.loaded)}else this.bwEstimator.sampleTTFB(c)}break}}}getTimeToLoadFrag(e,t,s,i){const n=e+s/t,r=i?e+this.lastLevelLoadSec:0;return n+r}onLevelLoaded(e,t){const s=this.hls.config,{loading:i}=t.stats,n=i.end-i.first;K(n)&&(this.lastLevelLoadSec=n/1e3),t.details.live?this.bwEstimator.update(s.abrEwmaSlowLive,s.abrEwmaFastLive):this.bwEstimator.update(s.abrEwmaSlowVoD,s.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(t.levelInfo)}onFragLoaded(e,{frag:t,part:s}){const i=s?s.stats:t.stats;if(t.type===V.MAIN&&this.bwEstimator.sampleTTFB(i.loading.first-i.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const n=s?s.duration:t.duration,r=this.hls.levels[t.level],a=(r.loaded?r.loaded.bytes:0)+i.loaded,c=(r.loaded?r.loaded.duration:0)+n;r.loaded={bytes:a,duration:c},r.realBitrate=Math.round(8*a/c)}if(t.bitrateTest){const n={stats:i,frag:t,part:s,id:t.type};this.onFragBuffered(y.FRAG_BUFFERED,n),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:s,part:i}=t,n=i!=null&&i.stats.loaded?i.stats:s.stats;if(n.aborted||this.ignoreFragment(s))return;const r=n.parsing.end-n.loading.start-Math.min(n.loading.first-n.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(r,n.loaded),n.bwEstimate=this.getBwEstimate(),s.bitrateTest?this.bitrateTestDelay=r/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==V.MAIN||e.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,s=this.getBwEstimate(),i=this.hls.config.maxStarvationDelay,n=this.findBestLevel(s,t,e,0,i,1,1);if(n>-1)return n;const r=this.hls.firstLevel,a=Math.min(Math.max(r,t),e);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${r} clamped to ${a}`),a}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,s=this.bwEstimator.canEstimate(),i=this.lastLoadedFragLevel>-1;if(e!==-1&&(!s||!i||this.nextAutoLevelKey===this.getAutoLevelKey()))return e;const n=s&&i?this.getNextABRAutoLevel():this.firstAutoLevel;if(e!==-1){const r=this.hls.levels;if(r.length>Math.max(e,n)&&r[e].loadError<=r[n].loadError)return e}return this._nextAutoLevel=n,this.nextAutoLevelKey=this.getAutoLevelKey(),n}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:s}=this;if(s.levels.length<=1)return s.loadLevel;const{maxAutoLevel:i,config:n,minAutoLevel:r}=s,a=t?t.duration:e?e.duration:0,c=this.getBwEstimate(),l=this.getStarvationDelay();let h=n.abrBandWidthFactor,u=n.abrBandWidthUpFactor;if(l){const m=this.findBestLevel(c,r,i,l,0,h,u);if(m>=0)return this.rebufferNotice=-1,m}let d=a?Math.min(a,n.maxStarvationDelay):n.maxStarvationDelay;if(!l){const m=this.bitrateTestDelay;m&&(d=(a?Math.min(a,n.maxLoadingDelay):n.maxLoadingDelay)-m,this.info(`bitrate test took ${Math.round(1e3*m)}ms, set first fragment max fetchDuration to ${Math.round(1e3*d)} ms`),h=u=1)}const A=this.findBestLevel(c,r,i,l,d,h,u);if(this.rebufferNotice!==A&&(this.rebufferNotice=A,this.info(`${l?"rebuffering expected":"buffer is empty"}, optimal quality level ${A}`)),A>-1)return A;const f=s.levels[r],g=s.loadLevelObj;return g&&f?.bitrate<g.bitrate?r:s.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const s=t&&t.playbackRate!==0?Math.abs(t.playbackRate):1,i=e.mainForwardBufferInfo;return(i?i.len:0)/s}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,s,i,n,r,a){var c;const l=i+n,h=this.lastLoadedFragLevel,u=h===-1?this.hls.firstLevel:h,{fragCurrent:d,partCurrent:A}=this,{levels:f,allAudioTracks:g,loadLevel:m,config:E}=this.hls;if(f.length===1)return 0;const p=f[u],I=!!((c=this.hls.latestLevelDetails)!=null&&c.live),C=m===-1||h===-1;let T,L="SDR",S=p?.frameRate||0;const{audioPreference:x,videoPreference:v}=E,B=this.audioTracksByGroup||(this.audioTracksByGroup=zc(g));let R=-1;if(C){if(this.firstSelection!==-1)return this.firstSelection;const P=this.codecTiers||(this.codecTiers=mf(f,B,t,s)),G=gf(P,L,e,x,v),{codecSet:U,videoRanges:H,minFramerate:$,minBitrate:O,minIndex:Q,preferHDR:Y}=G;R=Q,T=U,L=Y?H[H.length-1]:H[0],S=$,e=Math.max(e,O),this.log(`picked start tier ${le(G)}`)}else T=p?.codecSet,L=p?.videoRange;const D=A?A.duration:d?d.duration:0,b=this.bwEstimator.getEstimateTTFB()/1e3,w=[];for(let P=s;P>=t;P--){var F;const G=f[P],U=P>u;if(!G)continue;if(E.useMediaCapabilities&&!G.supportedResult&&!G.supportedPromise){const j=navigator.mediaCapabilities;typeof j?.decodingInfo=="function"&&rf(G,B,L,S,e,x)?(G.supportedPromise=Jc(G,B,j,this.supportedCache),G.supportedPromise.then(ee=>{if(!this.hls)return;G.supportedResult=ee;const Te=this.hls.levels,pe=Te.indexOf(G);ee.error?this.warn(`MediaCapabilities decodingInfo error: "${ee.error}" for level ${pe} ${le(ee)}`):ee.supported?ee.decodingInfoResults.some(Oe=>Oe.smooth===!1||Oe.powerEfficient===!1)&&this.log(`MediaCapabilities decodingInfo for level ${pe} not smooth or powerEfficient: ${le(ee)}`):(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${pe} ${le(ee)}`),pe>-1&&Te.length>1&&(this.log(`Removing unsupported level ${pe}`),this.hls.removeLevel(pe),this.hls.loadLevel===-1&&(this.hls.nextLoadLevel=0)))}).catch(ee=>{this.warn(`Error handling MediaCapabilities decodingInfo: ${ee}`)})):G.supportedResult=Wc}if((T&&G.codecSet!==T||L&&G.videoRange!==L||U&&S>G.frameRate||!U&&S>0&&S<G.frameRate||(F=G.supportedResult)!=null&&(F=F.decodingInfoResults)!=null&&F.some(j=>j.smooth===!1))&&(!C||P!==R)){w.push(P);continue}const H=G.details,$=(A?H?.partTarget:H?.averagetargetduration)||D;let O;U?O=a*e:O=r*e;const Q=D&&i>=D*2&&n===0?G.averageBitrate:G.maxBitrate,Y=this.getTimeToLoadFrag(b,O,Q*$,H===void 0);if(O>=Q&&(P===h||G.loadError===0&&G.fragmentError===0)&&(Y<=b||!K(Y)||I&&!this.bitrateTestDelay||Y<l)){const j=this.forcedAutoLevel;return P!==m&&(j===-1||j!==m)&&(w.length&&this.trace(`Skipped level(s) ${w.join(",")} of ${s} max with CODECS and VIDEO-RANGE:"${f[w[0]].codecs}" ${f[w[0]].videoRange}; not compatible with "${T}" ${L}`),this.info(`switch candidate:${u}->${P} adjustedbw(${Math.round(O)})-bitrate=${Math.round(O-Q)} ttfb:${b.toFixed(1)} avgDuration:${$.toFixed(1)} maxFetchDuration:${l.toFixed(1)} fetchDuration:${Y.toFixed(1)} firstSelection:${C} codecSet:${G.codecSet} videoRange:${G.videoRange} hls.loadLevel:${m}`)),C&&(this.firstSelection=P),P}}return-1}set nextAutoLevel(e){const t=this.deriveNextAutoLevel(e);this._nextAutoLevel!==t&&(this.nextAutoLevelKey="",this._nextAutoLevel=t)}deriveNextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:s}=this.hls;return Math.min(Math.max(e,s),t)}}const Zc={search:function(o,e){let t=0,s=o.length-1,i=null,n=null;for(;t<=s;){i=(t+s)/2|0,n=o[i];const r=e(n);if(r>0)t=i+1;else if(r<0)s=i-1;else return n}return null}};function Cf(o,e,t){if(e===null||!Array.isArray(o)||!o.length||!K(e))return null;const s=o[0].programDateTime;if(e<(s||0))return null;const i=o[o.length-1].endProgramDateTime;if(e>=(i||0))return null;for(let n=0;n<o.length;++n){const r=o[n];if(Sf(e,t,r))return r}return null}function rs(o,e,t=0,s=0,i=.005){let n=null;if(o){n=e[1+o.sn-e[0].sn]||null;const a=o.endDTS-t;a>0&&a<15e-7&&(t+=15e-7),n&&o.level!==n.level&&n.end<=o.end&&(n=e[2+o.sn-e[0].sn]||null)}else t===0&&e[0].start===0&&(n=e[0]);if(n&&((!o||o.level===n.level)&&Fa(t,s,n)===0||Tf(n,o,Math.min(i,s))))return n;const r=Zc.search(e,Fa.bind(null,t,s));return r&&(r!==o||!n)?r:n}function Tf(o,e,t){if(e&&e.start===0&&e.level<o.level&&(e.endPTS||0)>0){const s=e.tagList.reduce((i,n)=>(n[0]==="INF"&&(i+=parseFloat(n[1])),i),t);return o.start<=s}return!1}function Fa(o=0,e=0,t){if(t.start<=o&&t.start+t.duration>o)return 0;const s=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0));return t.start+t.duration-s<=o?1:t.start-s>o&&t.start?-1:0}function Sf(o,e,t){const s=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0))*1e3;return(t.endProgramDateTime||0)-s>o}function eh(o,e,t){if(o&&o.startCC<=e&&o.endCC>=e){let s=o.fragments;const{fragmentHint:i}=o;i&&(s=s.concat(i));let n;return Zc.search(s,r=>r.cc<e?1:r.cc>e?-1:(n=r,r.end<=t?1:r.start>t?-1:0)),n||null}return null}function An(o){switch(o.details){case k.FRAG_LOAD_TIMEOUT:case k.KEY_LOAD_TIMEOUT:case k.LEVEL_LOAD_TIMEOUT:case k.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function th(o){return o.details.startsWith("key")}function sh(o){return th(o)&&!!o.frag&&!o.frag.decryptdata}function Ma(o,e){const t=An(e);return o.default[`${t?"timeout":"error"}Retry`]}function Lo(o,e){const t=o.backoff==="linear"?1:Math.pow(2,e);return Math.min(t*o.retryDelayMs,o.maxRetryDelayMs)}function Qa(o){return ne(ne({},o),{errorRetry:null,timeoutRetry:null})}function fn(o,e,t,s){if(!o)return!1;const i=s?.code,n=e<o.maxNumRetry&&(Bf(i)||!!t);return o.shouldRetry?o.shouldRetry(o,e,t,s,n):n}function Bf(o){return Mr(o)||!!o&&(o<400||o>499)}function Mr(o){return o===0&&navigator.onLine===!1}var Le={DoNothing:0,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,RetryRequest:5},He={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,MoveAllAlternatesMatchingKey:4};class xf extends st{constructor(e){super("error-controller",e.logger),this.hls=void 0,this.playlistError=0,this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(y.ERROR,this.onError,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(y.ERROR,this.onError,this),e.off(y.ERROR,this.onErrorOut,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return e?.type===V.MAIN?e.level:this.getVariantIndex()}getVariantIndex(){var e;const t=this.hls,s=t.currentLevel;return(e=t.loadLevelObj)!=null&&e.details||s===-1?t.loadLevel:s}variantHasKey(e,t){if(e){var s;if((s=e.details)!=null&&s.hasKey(t))return!0;const i=e.audioGroups;if(i)return this.hls.allAudioTracks.filter(r=>i.indexOf(r.groupId)>=0).some(r=>{var a;return(a=r.details)==null?void 0:a.hasKey(t)})}return!1}onManifestLoading(){this.playlistError=0}onLevelUpdated(){this.playlistError=0}onError(e,t){var s;if(t.fatal)return;const i=this.hls,n=t.context;switch(t.details){case k.FRAG_LOAD_ERROR:case k.FRAG_LOAD_TIMEOUT:case k.KEY_LOAD_ERROR:case k.KEY_LOAD_TIMEOUT:t.errorAction=this.getFragRetryOrSwitchAction(t);return;case k.FRAG_PARSING_ERROR:if((s=t.frag)!=null&&s.gap){t.errorAction=Ls();return}case k.FRAG_GAP:case k.FRAG_DECRYPT_ERROR:{t.errorAction=this.getFragRetryOrSwitchAction(t),t.errorAction.action=Le.SendAlternateToPenaltyBox;return}case k.LEVEL_EMPTY_ERROR:case k.LEVEL_PARSING_ERROR:{var r;const c=t.parent===V.MAIN?t.level:i.loadLevel;t.details===k.LEVEL_EMPTY_ERROR&&((r=t.context)!=null&&(r=r.levelDetails)!=null&&r.live)?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,c):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,c))}return;case k.LEVEL_LOAD_ERROR:case k.LEVEL_LOAD_TIMEOUT:typeof n?.level=="number"&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,n.level));return;case k.AUDIO_TRACK_LOAD_ERROR:case k.AUDIO_TRACK_LOAD_TIMEOUT:case k.SUBTITLE_LOAD_ERROR:case k.SUBTITLE_TRACK_LOAD_TIMEOUT:if(n){const c=i.loadLevelObj;if(c&&(n.type===Z.AUDIO_TRACK&&c.hasAudioGroup(n.groupId)||n.type===Z.SUBTITLE_TRACK&&c.hasSubtitleGroup(n.groupId))){t.errorAction=this.getPlaylistRetryOrSwitchAction(t,i.loadLevel),t.errorAction.action=Le.SendAlternateToPenaltyBox,t.errorAction.flags=He.MoveAllAlternatesMatchingHost;return}}return;case k.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:t.errorAction={action:Le.SendAlternateToPenaltyBox,flags:He.MoveAllAlternatesMatchingHDCP};return;case k.KEY_SYSTEM_SESSION_UPDATE_FAILED:case k.KEY_SYSTEM_STATUS_INTERNAL_ERROR:case k.KEY_SYSTEM_NO_SESSION:t.errorAction={action:Le.SendAlternateToPenaltyBox,flags:He.MoveAllAlternatesMatchingKey};return;case k.BUFFER_ADD_CODEC_ERROR:case k.REMUX_ALLOC_ERROR:case k.BUFFER_APPEND_ERROR:if(!t.errorAction){var a;t.errorAction=this.getLevelSwitchAction(t,(a=t.level)!=null?a:i.loadLevel)}return;case k.INTERNAL_EXCEPTION:case k.BUFFER_APPENDING_ERROR:case k.BUFFER_FULL_ERROR:case k.LEVEL_SWITCH_ERROR:case k.BUFFER_STALLED_ERROR:case k.BUFFER_SEEK_OVER_HOLE:case k.BUFFER_NUDGE_ON_STALL:t.errorAction=Ls();return}t.type===q.KEY_SYSTEM_ERROR&&(t.levelRetry=!1,t.errorAction=Ls())}getPlaylistRetryOrSwitchAction(e,t){const s=this.hls,i=Ma(s.config.playlistLoadPolicy,e),n=this.playlistError++;if(fn(i,n,An(e),e.response))return{action:Le.RetryRequest,flags:He.None,retryConfig:i,retryCount:n};const a=this.getLevelSwitchAction(e,t);return i&&(a.retryConfig=i,a.retryCount=n),a}getFragRetryOrSwitchAction(e){const t=this.hls,s=this.getVariantLevelIndex(e.frag),i=t.levels[s],{fragLoadPolicy:n,keyLoadPolicy:r}=t.config,a=Ma(th(e)?r:n,e),c=t.levels.reduce((h,u)=>h+u.fragmentError,0);if(i&&(e.details!==k.FRAG_GAP&&i.fragmentError++,!sh(e)&&fn(a,c,An(e),e.response)))return{action:Le.RetryRequest,flags:He.None,retryConfig:a,retryCount:c};const l=this.getLevelSwitchAction(e,s);return a&&(l.retryConfig=a,l.retryCount=c),l}getLevelSwitchAction(e,t){const s=this.hls;t==null&&(t=s.loadLevel);const i=this.hls.levels[t];if(i){var n,r;const l=e.details;i.loadError++,l===k.BUFFER_APPEND_ERROR&&i.fragmentError++;let h=-1;const{levels:u,loadLevel:d,minAutoLevel:A,maxAutoLevel:f}=s;!s.autoLevelEnabled&&!s.config.preserveManualLevelOnError&&(s.loadLevel=-1);const g=(n=e.frag)==null?void 0:n.type,E=(g===V.AUDIO&&l===k.FRAG_PARSING_ERROR||e.sourceBufferName==="audio"&&(l===k.BUFFER_ADD_CODEC_ERROR||l===k.BUFFER_APPEND_ERROR))&&u.some(({audioCodec:L})=>i.audioCodec!==L),I=e.sourceBufferName==="video"&&(l===k.BUFFER_ADD_CODEC_ERROR||l===k.BUFFER_APPEND_ERROR)&&u.some(({codecSet:L,audioCodec:S})=>i.codecSet!==L&&i.audioCodec===S),{type:C,groupId:T}=(r=e.context)!=null?r:{};for(let L=u.length;L--;){const S=(L+d)%u.length;if(S!==d&&S>=A&&S<=f&&u[S].loadError===0){var a,c;const x=u[S];if(l===k.FRAG_GAP&&g===V.MAIN&&e.frag){const v=u[S].details;if(v){const B=rs(e.frag,v.fragments,e.frag.start);if(B!=null&&B.gap)continue}}else{if(C===Z.AUDIO_TRACK&&x.hasAudioGroup(T)||C===Z.SUBTITLE_TRACK&&x.hasSubtitleGroup(T))continue;if(g===V.AUDIO&&(a=i.audioGroups)!=null&&a.some(v=>x.hasAudioGroup(v))||g===V.SUBTITLE&&(c=i.subtitleGroups)!=null&&c.some(v=>x.hasSubtitleGroup(v))||E&&i.audioCodec===x.audioCodec||I&&i.codecSet===x.codecSet||!E&&i.codecSet!==x.codecSet)continue}h=S;break}}if(h>-1&&s.loadLevel!==h)return e.levelRetry=!0,this.playlistError=0,{action:Le.SendAlternateToPenaltyBox,flags:He.None,nextAutoLevel:h}}return{action:Le.SendAlternateToPenaltyBox,flags:He.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var s;switch((s=t.errorAction)==null?void 0:s.action){case Le.DoNothing:break;case Le.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),!t.errorAction.resolved&&t.details!==k.FRAG_GAP?t.fatal=!0:/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break}if(t.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(e){const t=this.hls,s=e.errorAction;if(!s)return;const{flags:i}=s,n=s.nextAutoLevel;switch(i){case He.None:this.switchLevel(e,n);break;case He.MoveAllAlternatesMatchingHDCP:{const c=this.getVariantLevelIndex(e.frag),l=t.levels[c],h=l?.attrs["HDCP-LEVEL"];if(s.hdcpLevel=h,h==="NONE")this.warn("HDCP policy resticted output with HDCP-LEVEL=NONE");else if(h){t.maxHdcpLevel=Fr[Fr.indexOf(h)-1],s.resolved=!0,this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`);break}}case He.MoveAllAlternatesMatchingKey:{const c=e.decryptdata;if(c){const l=this.hls.levels,h=l.length;for(let d=h;d--;)if(this.variantHasKey(l[d],c)){var r,a;this.log(`Banned key found in level ${d} (${l[d].bitrate}bps) or audio group "${(r=l[d].audioGroups)==null?void 0:r.join(",")}" (${(a=e.frag)==null?void 0:a.type} fragment) ${Re(c.keyId||[])}`),l[d].fragmentError++,l[d].loadError++,this.log(`Removing level ${d} with key error (${e.error})`),this.hls.removeLevel(d)}const u=e.frag;if(this.hls.levels.length<h)s.resolved=!0;else if(u&&u.type!==V.MAIN){const d=u.decryptdata;d&&!c.matches(d)&&(s.resolved=!0)}}break}}s.resolved||this.switchLevel(e,n)}switchLevel(e,t){if(t!==void 0&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,e.details===k.BUFFER_ADD_CODEC_ERROR&&e.mimeType&&e.sourceBufferName!=="audiovideo")){const s=Pr(e.mimeType),i=this.hls.levels;for(let n=i.length;n--;)i[n][`${e.sourceBufferName}Codec`]===s&&(this.log(`Removing level ${n} for ${e.details} ("${s}" not supported)`),this.hls.removeLevel(n))}}}function Ls(o){const e={action:Le.DoNothing,flags:He.None};return o&&(e.resolved=!0),e}var Ie={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class vf{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e&&(e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.BUFFER_APPENDED,this.onBufferAppended,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this),e.on(y.FRAG_LOADED,this.onFragLoaded,this))}_unregisterListeners(){const{hls:e}=this;e&&(e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.BUFFER_APPENDED,this.onBufferAppended,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this),e.off(y.FRAG_LOADED,this.onFragLoaded,this))}destroy(){this._unregisterListeners(),this.hls=this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const s=this.activePartLists[t];if(s)for(let i=s.length;i--;){const n=s[i];if(!n)break;if(n.start<=e&&e<=n.end&&n.loaded)return n}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){return this.getFragAtPos(e,t,!0)}getFragAtPos(e,t,s){const{fragments:i}=this,n=Object.keys(i);for(let r=n.length;r--;){const a=i[n[r]];if(a?.body.type===t&&(!s||a.buffered)){const c=a.body;if(c.start<=e&&e<=c.end)return c}}return null}detectEvictedFragments(e,t,s,i,n){this.timeRanges&&(this.timeRanges[e]=t);const r=i?.fragment.sn||-1;Object.keys(this.fragments).forEach(a=>{const c=this.fragments[a];if(!c||r>=c.body.sn)return;if(!c.buffered&&(!c.loaded||n)){c.body.type===s&&this.removeFragment(c.body);return}const l=c.range[e];if(l){if(l.time.length===0){this.removeFragment(c.body);return}l.time.some(h=>{const u=!this.isTimeBuffered(h.startPTS,h.endPTS,t);return u&&this.removeFragment(c.body),u})}})}detectPartialFragments(e){const t=this.timeRanges;if(!t||e.frag.sn==="initSegment")return;const s=e.frag,i=ls(s),n=this.fragments[i];if(!n||n.buffered&&s.gap)return;const r=!s.relurl;Object.keys(t).forEach(a=>{const c=s.elementaryStreams[a];if(!c)return;const l=t[a],h=r||c.partial===!0;n.range[a]=this.getBufferedTimes(s,e.part,h,l)}),n.loaded=null,Object.keys(n.range).length?(this.bufferedEnd(n,s),Ii(n)||this.removeParts(s.sn-1,s.type)):this.removeFragment(n.body)}bufferedEnd(e,t){e.buffered=!0,(e.body.endList=t.endList||e.body.endList)&&(this.endListFragments[e.body.type]=e)}removeParts(e,t){const s=this.activePartLists[t];s&&(this.activePartLists[t]=Oa(s,i=>i.fragment.sn>=e))}fragBuffered(e,t){const s=ls(e);let i=this.fragments[s];!i&&t&&(i=this.fragments[s]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),i&&(i.loaded=null,this.bufferedEnd(i,e))}getBufferedTimes(e,t,s,i){const n={time:[],partial:s},r=e.start,a=e.end,c=e.minEndPTS||a,l=e.maxStartPTS||r;for(let h=0;h<i.length;h++){const u=i.start(h)-this.bufferPadding,d=i.end(h)+this.bufferPadding;if(l>=u&&c<=d){n.time.push({startPTS:Math.max(r,i.start(h)),endPTS:Math.min(a,i.end(h))});break}else if(r<d&&a>u){const A=Math.max(r,i.start(h)),f=Math.min(a,i.end(h));f>A&&(n.partial=!0,n.time.push({startPTS:A,endPTS:f}))}else if(a<=u)break}return n}getPartialFragment(e){let t=null,s,i,n,r=0;const{bufferPadding:a,fragments:c}=this;return Object.keys(c).forEach(l=>{const h=c[l];h&&Ii(h)&&(i=h.body.start-a,n=h.body.end+a,e>=i&&e<=n&&(s=Math.min(e-i,n-e),r<=s&&(t=h.body,r=s)))}),t}isEndListAppended(e){const t=this.endListFragments[e];return t!==void 0&&(t.buffered||Ii(t))}getState(e){const t=ls(e),s=this.fragments[t];return s?s.buffered?Ii(s)?Ie.PARTIAL:Ie.OK:Ie.APPENDING:Ie.NOT_LOADED}isTimeBuffered(e,t,s){let i,n;for(let r=0;r<s.length;r++){if(i=s.start(r)-this.bufferPadding,n=s.end(r)+this.bufferPadding,e>=i&&t<=n)return!0;if(t<=i)return!1}return!1}onManifestLoading(){this.removeAllFragments()}onFragLoaded(e,t){if(t.frag.sn==="initSegment"||t.frag.bitrateTest)return;const s=t.frag,i=t.part?null:t,n=ls(s);this.fragments[n]={body:s,appendedPTS:null,loaded:i,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:s,part:i,timeRanges:n,type:r}=t;if(s.sn==="initSegment")return;const a=s.type;if(i){let l=this.activePartLists[a];l||(this.activePartLists[a]=l=[]),l.push(i)}this.timeRanges=n;const c=n[r];this.detectEvictedFragments(r,c,a,i)}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=ls(e);return!!this.fragments[t]}hasFragments(e){const{fragments:t}=this,s=Object.keys(t);if(!e)return s.length>0;for(let i=s.length;i--;){const n=t[s[i]];if(n?.body.type===e)return!0}return!1}hasParts(e){var t;return!!((t=this.activePartLists[e])!=null&&t.length)}removeFragmentsInRange(e,t,s,i,n){i&&!this.hasGaps||Object.keys(this.fragments).forEach(r=>{const a=this.fragments[r];if(!a)return;const c=a.body;c.type!==s||i&&!c.gap||c.start<t&&c.end>e&&(a.buffered||n)&&this.removeFragment(c)})}removeFragment(e){const t=ls(e);e.clearElementaryStreamInfo();const s=this.activePartLists[e.type];if(s){const i=e.sn;this.activePartLists[e.type]=Oa(s,n=>n.fragment.sn!==i)}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){var e;this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1;const t=(e=this.hls)==null||(e=e.latestLevelDetails)==null?void 0:e.partList;t&&t.forEach(s=>s.clearElementaryStreamInfo())}}function Ii(o){var e,t,s;return o.buffered&&!!(o.body.gap||(e=o.range.video)!=null&&e.partial||(t=o.range.audio)!=null&&t.partial||(s=o.range.audiovideo)!=null&&s.partial)}function ls(o){return`${o.type}_${o.level}_${o.sn}`}function Oa(o,e){return o.filter(t=>{const s=e(t);return s||t.clearElementaryStreamInfo(),s})}var Yt={cbc:0,ctr:1};class Lf{constructor(e,t,s){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=e,this.aesIV=t,this.aesMode=s}decrypt(e,t){switch(this.aesMode){case Yt.cbc:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e);case Yt.ctr:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},t,e);default:throw new Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}}function Rf(o){const e=o.byteLength,t=e&&new DataView(o.buffer).getUint8(e-1);return t?o.slice(0,e-t):o}class Df{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),s=new Uint32Array(4);for(let i=0;i<4;i++)s[i]=t.getUint32(i*4);return s}initTable(){const e=this.sBox,t=this.invSBox,s=this.subMix,i=s[0],n=s[1],r=s[2],a=s[3],c=this.invSubMix,l=c[0],h=c[1],u=c[2],d=c[3],A=new Uint32Array(256);let f=0,g=0,m=0;for(m=0;m<256;m++)m<128?A[m]=m<<1:A[m]=m<<1^283;for(m=0;m<256;m++){let E=g^g<<1^g<<2^g<<3^g<<4;E=E>>>8^E&255^99,e[f]=E,t[E]=f;const p=A[f],I=A[p],C=A[I];let T=A[E]*257^E*16843008;i[f]=T<<24|T>>>8,n[f]=T<<16|T>>>16,r[f]=T<<8|T>>>24,a[f]=T,T=C*16843009^I*65537^p*257^f*16843008,l[E]=T<<24|T>>>8,h[E]=T<<16|T>>>16,u[E]=T<<8|T>>>24,d[E]=T,f?(f=p^A[A[A[C^p]]],g^=A[A[g]]):f=g=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let s=!0,i=0;for(;i<t.length&&s;)s=t[i]===this.key[i],i++;if(s)return;this.key=t;const n=this.keySize=t.length;if(n!==4&&n!==6&&n!==8)throw new Error("Invalid aes key size="+n);const r=this.ksRows=(n+6+1)*4;let a,c;const l=this.keySchedule=new Uint32Array(r),h=this.invKeySchedule=new Uint32Array(r),u=this.sBox,d=this.rcon,A=this.invSubMix,f=A[0],g=A[1],m=A[2],E=A[3];let p,I;for(a=0;a<r;a++){if(a<n){p=l[a]=t[a];continue}I=p,a%n===0?(I=I<<8|I>>>24,I=u[I>>>24]<<24|u[I>>>16&255]<<16|u[I>>>8&255]<<8|u[I&255],I^=d[a/n|0]<<24):n>6&&a%n===4&&(I=u[I>>>24]<<24|u[I>>>16&255]<<16|u[I>>>8&255]<<8|u[I&255]),l[a]=p=(l[a-n]^I)>>>0}for(c=0;c<r;c++)a=r-c,c&3?I=l[a]:I=l[a-4],c<4||a<=4?h[c]=I:h[c]=f[u[I>>>24]]^g[u[I>>>16&255]]^m[u[I>>>8&255]]^E[u[I&255]],h[c]=h[c]>>>0}networkToHostOrderSwap(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24}decrypt(e,t,s){const i=this.keySize+6,n=this.invKeySchedule,r=this.invSBox,a=this.invSubMix,c=a[0],l=a[1],h=a[2],u=a[3],d=this.uint8ArrayToUint32Array_(s);let A=d[0],f=d[1],g=d[2],m=d[3];const E=new Int32Array(e),p=new Int32Array(E.length);let I,C,T,L,S,x,v,B,R,D,b,w,F,P;const G=this.networkToHostOrderSwap;for(;t<E.length;){for(R=G(E[t]),D=G(E[t+1]),b=G(E[t+2]),w=G(E[t+3]),S=R^n[0],x=w^n[1],v=b^n[2],B=D^n[3],F=4,P=1;P<i;P++)I=c[S>>>24]^l[x>>16&255]^h[v>>8&255]^u[B&255]^n[F],C=c[x>>>24]^l[v>>16&255]^h[B>>8&255]^u[S&255]^n[F+1],T=c[v>>>24]^l[B>>16&255]^h[S>>8&255]^u[x&255]^n[F+2],L=c[B>>>24]^l[S>>16&255]^h[x>>8&255]^u[v&255]^n[F+3],S=I,x=C,v=T,B=L,F=F+4;I=r[S>>>24]<<24^r[x>>16&255]<<16^r[v>>8&255]<<8^r[B&255]^n[F],C=r[x>>>24]<<24^r[v>>16&255]<<16^r[B>>8&255]<<8^r[S&255]^n[F+1],T=r[v>>>24]<<24^r[B>>16&255]<<16^r[S>>8&255]<<8^r[x&255]^n[F+2],L=r[B>>>24]<<24^r[S>>16&255]<<16^r[x>>8&255]<<8^r[v&255]^n[F+3],p[t]=G(I^A),p[t+1]=G(L^f),p[t+2]=G(T^g),p[t+3]=G(C^m),A=R,f=D,g=b,m=w,t=t+4}return p.buffer}}class bf{constructor(e,t,s){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=e,this.key=t,this.aesMode=s}expandKey(){const e=wf(this.aesMode);return this.subtle.importKey("raw",this.key,{name:e},!1,["encrypt","decrypt"])}}function wf(o){switch(o){case Yt.cbc:return"AES-CBC";case Yt.ctr:return"AES-CTR";default:throw new Error(`[FastAESKey] invalid aes mode ${o}`)}}const _f=16;class Ro{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const s=self.crypto;s&&(this.subtle=s.subtle||s.webkitSubtle)}catch{}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const s=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?Rf(s):s}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,s,i){return this.useSoftware?new Promise((n,r)=>{const a=ArrayBuffer.isView(e)?e:new Uint8Array(e);this.softwareDecrypt(a,t,s,i);const c=this.flush();c?n(c.buffer):r(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,s,i)}softwareDecrypt(e,t,s,i){const{currentIV:n,currentResult:r,remainderData:a}=this;if(i!==Yt.cbc||t.byteLength!==16)return re.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),a&&(e=tt(a,e),this.remainderData=null);const c=this.getValidChunk(e);if(!c.length)return null;n&&(s=n);let l=this.softwareDecrypter;l||(l=this.softwareDecrypter=new Df),l.expandKey(t);const h=r;return this.currentResult=l.decrypt(c.buffer,0,s),this.currentIV=c.slice(-16).buffer,h||null}webCryptoDecrypt(e,t,s,i){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,s,i));this.key=t,this.fastAesKey=new bf(this.subtle,t,i)}return this.fastAesKey.expandKey().then(n=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new Lf(this.subtle,new Uint8Array(s),i).decrypt(e.buffer,n)):Promise.reject(new Error("web crypto not initialized"))).catch(n=>(re.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${n.name}: ${n.message}`),this.onWebCryptoError(e,t,s,i)))}onWebCryptoError(e,t,s,i){const n=this.enableSoftwareAES;if(n){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,s,i);const r=this.flush();if(r)return r.buffer}throw new Error("WebCrypto"+(n?" and softwareDecrypt":"")+": failed to decrypt data")}getValidChunk(e){let t=e;const s=e.length-e.length%_f;return s!==e.length&&(t=e.slice(0,s),this.remainderData=e.slice(s)),t}logOnce(e){this.logEnabled&&(re.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const Na=Math.pow(2,17);class kf{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const s=e.url;if(!s)return Promise.reject(new Rt({type:q.NETWORK_ERROR,details:k.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error(`Fragment does not have a ${s?"part list":"url"}`),networkDetails:null}));this.abort();const i=this.config,n=i.fLoader,r=i.loader;return new Promise((a,c)=>{if(this.loader&&this.loader.destroy(),e.gap)if(e.tagList.some(f=>f[0]==="GAP")){c(Ga(e));return}else e.gap=!1;const l=this.loader=n?new n(i):new r(i),h=Ua(e);e.loader=l;const u=Qa(i.fragLoadPolicy.default),d={loadPolicy:u,timeout:u.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:e.sn==="initSegment"?1/0:Na};e.stats=l.stats;const A={onSuccess:(f,g,m,E)=>{this.resetLoader(e,l);let p=f.data;m.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(p.slice(0,16)),p=p.slice(16)),a({frag:e,part:null,payload:p,networkDetails:E})},onError:(f,g,m,E)=>{this.resetLoader(e,l),c(new Rt({type:q.NETWORK_ERROR,details:k.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:ne({url:s,data:void 0},f),error:new Error(`HTTP Error ${f.code} ${f.text}`),networkDetails:m,stats:E}))},onAbort:(f,g,m)=>{this.resetLoader(e,l),c(new Rt({type:q.NETWORK_ERROR,details:k.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:m,stats:f}))},onTimeout:(f,g,m)=>{this.resetLoader(e,l),c(new Rt({type:q.NETWORK_ERROR,details:k.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:m,stats:f}))}};t&&(A.onProgress=(f,g,m,E)=>t({frag:e,part:null,payload:m,networkDetails:E})),l.load(h,d,A)})}loadPart(e,t,s){this.abort();const i=this.config,n=i.fLoader,r=i.loader;return new Promise((a,c)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap){c(Ga(e,t));return}const l=this.loader=n?new n(i):new r(i),h=Ua(e,t);e.loader=l;const u=Qa(i.fragLoadPolicy.default),d={loadPolicy:u,timeout:u.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:Na};t.stats=l.stats,l.load(h,d,{onSuccess:(A,f,g,m)=>{this.resetLoader(e,l),this.updateStatsFromPart(e,t);const E={frag:e,part:t,payload:A.data,networkDetails:m};s(E),a(E)},onError:(A,f,g,m)=>{this.resetLoader(e,l),c(new Rt({type:q.NETWORK_ERROR,details:k.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:ne({url:h.url,data:void 0},A),error:new Error(`HTTP Error ${A.code} ${A.text}`),networkDetails:g,stats:m}))},onAbort:(A,f,g)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,l),c(new Rt({type:q.NETWORK_ERROR,details:k.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:g,stats:A}))},onTimeout:(A,f,g)=>{this.resetLoader(e,l),c(new Rt({type:q.NETWORK_ERROR,details:k.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${d.timeout}ms`),networkDetails:g,stats:A}))}})})}updateStatsFromPart(e,t){const s=e.stats,i=t.stats,n=i.total;if(s.loaded+=i.loaded,n){const c=Math.round(e.duration/t.duration),l=Math.min(Math.round(s.loaded/n),c),u=(c-l)*Math.round(s.loaded/l);s.total=s.loaded+u}else s.total=Math.max(s.loaded,s.total);const r=s.loading,a=i.loading;r.start?r.first+=a.first-a.start:(r.start=a.start,r.first=a.first),r.end=a.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function Ua(o,e=null){const t=e||o,s={frag:o,part:e,responseType:"arraybuffer",url:t.url,headers:{},rangeStart:0,rangeEnd:0},i=t.byteRangeStartOffset,n=t.byteRangeEndOffset;if(K(i)&&K(n)){var r;let a=i,c=n;if(o.sn==="initSegment"&&Pf((r=o.decryptdata)==null?void 0:r.method)){const l=n-i;l%16&&(c=n+(16-l%16)),i!==0&&(s.resetIV=!0,a=i-16)}s.rangeStart=a,s.rangeEnd=c}return s}function Ga(o,e){const t=new Error(`GAP ${o.gap?"tag":"attribute"} found`),s={type:q.MEDIA_ERROR,details:k.FRAG_GAP,fatal:!1,frag:o,error:t,networkDetails:null};return e&&(s.part=e),(e||o).stats.aborted=!0,new Rt(s)}function Pf(o){return o==="AES-128"||o==="AES-256"}class Rt extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class ih extends st{constructor(e,t){super(e,t),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}class Do{constructor(e,t,s,i=0,n=-1,r=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=yi(),this.buffering={audio:yi(),video:yi(),audiovideo:yi()},this.level=e,this.sn=t,this.id=s,this.size=i,this.part=n,this.partial=r}}function yi(){return{start:0,executeStart:0,executeEnd:0,end:0}}const Ha={length:0,start:()=>0,end:()=>0};class J{static isBuffered(e,t){if(e){const s=J.getBuffered(e);for(let i=s.length;i--;)if(t>=s.start(i)&&t<=s.end(i))return!0}return!1}static bufferedRanges(e){if(e){const t=J.getBuffered(e);return J.timeRangesToArray(t)}return[]}static timeRangesToArray(e){const t=[];for(let s=0;s<e.length;s++)t.push({start:e.start(s),end:e.end(s)});return t}static bufferInfo(e,t,s){if(e){const i=J.bufferedRanges(e);if(i.length)return J.bufferedInfo(i,t,s)}return{len:0,start:t,end:t,bufferedIndex:-1}}static bufferedInfo(e,t,s){t=Math.max(0,t),e.length>1&&e.sort((h,u)=>h.start-u.start||u.end-h.end);let i=-1,n=[];if(s)for(let h=0;h<e.length;h++){t>=e[h].start&&t<=e[h].end&&(i=h);const u=n.length;if(u){const d=n[u-1].end;e[h].start-d<s?e[h].end>d&&(n[u-1].end=e[h].end):n.push(e[h])}else n.push(e[h])}else n=e;let r=0,a,c=t,l=t;for(let h=0;h<n.length;h++){const u=n[h].start,d=n[h].end;if(i===-1&&t>=u&&t<=d&&(i=h),t+s>=u&&t<d)c=u,l=d,r=l-t;else if(t+s<u){a=u;break}}return{len:r,start:c||0,end:l||0,nextStart:a,buffered:e,bufferedIndex:i}}static getBuffered(e){try{return e.buffered||Ha}catch(t){return re.log("failed to get media.buffered",t),Ha}}}const nh=/\{\$([a-zA-Z0-9-_]+)\}/g;function Ka(o){return nh.test(o)}function Qr(o,e){if(o.variableList!==null||o.hasVariableRefs){const t=o.variableList;return e.replace(nh,s=>{const i=s.substring(2,s.length-1),n=t?.[i];return n===void 0?(o.playlistParsingError||(o.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${i}"`)),s):n})}return e}function $a(o,e,t){let s=o.variableList;s||(o.variableList=s={});let i,n;if("QUERYPARAM"in e){i=e.QUERYPARAM;try{const r=new self.URL(t).searchParams;if(r.has(i))n=r.get(i);else throw new Error(`"${i}" does not match any query parameter in URI: "${t}"`)}catch(r){o.playlistParsingError||(o.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${r.message}`))}}else i=e.NAME,n=e.VALUE;i in s?o.playlistParsingError||(o.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${i}"`)):s[i]=n||""}function Ff(o,e,t){const s=e.IMPORT;if(t&&s in t){let i=o.variableList;i||(o.variableList=i={}),i[s]=t[s]}else o.playlistParsingError||(o.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${s}"`))}const Mf=/^(\d+)x(\d+)$/,Va=/(.+?)=(".*?"|.*?)(?:,|$)/g;class he{constructor(e,t){typeof e=="string"&&(e=he.parseAttrList(e,t)),oe(this,e)}get clientAttrs(){return Object.keys(this).filter(e=>e.substring(0,2)==="X-")}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(t.length&1?"0":"")+t;const s=new Uint8Array(t.length/2);for(let i=0;i<t.length/2;i++)s[i]=parseInt(t.slice(i*2,i*2+2),16);return s}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const s=this[e];return s?parseFloat(s):t}enumeratedString(e){return this[e]}enumeratedStringList(e,t){const s=this[e];return(s?s.split(/[ ,]+/):[]).reduce((i,n)=>(i[n.toLowerCase()]=!0,i),t)}bool(e){return this[e]==="YES"}decimalResolution(e){const t=Mf.exec(this[e]);if(t!==null)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e,t){let s;const i={};for(Va.lastIndex=0;(s=Va.exec(e))!==null;){const r=s[1].trim();let a=s[2];const c=a.indexOf('"')===0&&a.lastIndexOf('"')===a.length-1;let l=!1;if(c)a=a.slice(1,-1);else switch(r){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":l=!0}if(t&&(c||l))a=Qr(t,a);else if(!l&&!c)switch(r){case"CLOSED-CAPTIONS":if(a==="NONE")break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":re.warn(`${e}: attribute ${r} is missing quotes`)}i[r]=a}return i}}const Qf="com.apple.hls.interstitial";function Of(o){return o!=="ID"&&o!=="CLASS"&&o!=="CUE"&&o!=="START-DATE"&&o!=="DURATION"&&o!=="END-DATE"&&o!=="END-ON-NEXT"}function Nf(o){return o==="SCTE35-OUT"||o==="SCTE35-IN"||o==="SCTE35-CMD"}class rh{constructor(e,t,s=0){var i;if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=t?.tagAnchor||null,this.tagOrder=(i=t?.tagOrder)!=null?i:s,t){const n=t.attr;for(const r in n)if(Object.prototype.hasOwnProperty.call(e,r)&&e[r]!==n[r]){re.warn(`DATERANGE tag attribute: "${r}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=r;break}e=oe(new he({}),n,e)}if(this.attr=e,t?(this._startDate=t._startDate,this._cue=t._cue,this._endDate=t._endDate,this._dateAtEnd=t._dateAtEnd):this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const n=t?.endDate||new Date(this.attr["END-DATE"]);K(n.getTime())&&(this._endDate=n)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){const e=this._cue;return e===void 0?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):e}get startTime(){const{tagAnchor:e}=this;return e===null||e.programDateTime===null?(re.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${e}`),NaN):e.start+(this.startDate.getTime()-e.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){const e=this._endDate||this._dateAtEnd;if(e)return e;const t=this.duration;return t!==null?this._dateAtEnd=new Date(this._startDate.getTime()+t*1e3):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(K(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isInterstitial(){return this.class===Qf}get isValid(){return!!this.id&&!this._badValueForSameId&&K(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}const Uf=10;class Gf{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.dateRangeTagCount=0,this.live=!0,this.requestScheduled=-1,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.appliedTimelineOffset=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e){this.advanced=!0,this.updated=!0;return}const t=this.lastPartSn-e.lastPartSn,s=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!s||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||t===0&&s>0,this.updated||this.advanced?this.misses=Math.floor(e.misses*.6):this.misses=e.misses+1}hasKey(e){return this.encryptedFragments.some(t=>{let s=t.decryptdata;return s||(t.setKeyFormat(e.keyFormat),s=t.decryptdata),!!s&&e.matches(s)})}get hasProgramDateTime(){return this.fragments.length?K(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||Uf}get drift(){const e=this.driftEndTime-this.driftStartTime;return e>0?(this.driftEnd-this.driftStart)*1e3/e:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){return this.fragments.length?this.fragments[this.fragments.length-1].end:0}get fragmentStart(){return this.fragments.length?this.fragments[0].start:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].index:-1}get maxPartIndex(){const e=this.partList;if(e){const t=this.lastPartIndex;if(t!==-1){for(let s=e.length;s--;)if(e[s].index>t)return e[s].index;return t}}return 0}get lastPartSn(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}get expired(){if(this.live&&this.age&&this.misses<3){const e=this.partEnd-this.fragmentStart;return this.age>Math.max(e,this.totalduration)+this.levelTargetDuration}return!1}}function gn(o,e){return o.length===e.length?!o.some((t,s)=>t!==e[s]):!1}function Ya(o,e){return!o&&!e?!0:!o||!e?!1:gn(o,e)}function Rs(o){return o==="AES-128"||o==="AES-256"||o==="AES-256-CTR"}function bo(o){switch(o){case"AES-128":case"AES-256":return Yt.cbc;case"AES-256-CTR":return Yt.ctr;default:throw new Error(`invalid full segment method ${o}`)}}function wo(o){return Uint8Array.from(atob(o),e=>e.charCodeAt(0))}function Or(o){return Uint8Array.from(unescape(encodeURIComponent(o)),e=>e.charCodeAt(0))}function Hf(o){const e=Or(o).subarray(0,16),t=new Uint8Array(16);return t.set(e,16-e.length),t}function oh(o){const e=function(s,i,n){const r=s[i];s[i]=s[n],s[n]=r};e(o,0,3),e(o,1,2),e(o,4,5),e(o,6,7)}function ah(o){const e=o.split(":");let t=null;if(e[0]==="data"&&e.length===2){const s=e[1].split(";"),i=s[s.length-1].split(",");if(i.length===2){const n=i[0]==="base64",r=i[1];n?(s.splice(-1,1),t=wo(r)):t=Hf(r)}}return t}const mn=typeof self<"u"?self:void 0;var de={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},De={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function zi(o){switch(o){case De.FAIRPLAY:return de.FAIRPLAY;case De.PLAYREADY:return de.PLAYREADY;case De.WIDEVINE:return de.WIDEVINE;case De.CLEARKEY:return de.CLEARKEY}}function Fn(o){switch(o){case de.FAIRPLAY:return De.FAIRPLAY;case de.PLAYREADY:return De.PLAYREADY;case de.WIDEVINE:return De.WIDEVINE;case de.CLEARKEY:return De.CLEARKEY}}function Xs(o){const{drmSystems:e,widevineLicenseUrl:t}=o,s=e?[de.FAIRPLAY,de.WIDEVINE,de.PLAYREADY,de.CLEARKEY].filter(i=>!!e[i]):[];return!s[de.WIDEVINE]&&t&&s.push(de.WIDEVINE),s}const lh=(function(o){return mn!=null&&(o=mn.navigator)!=null&&o.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null})();function Kf(o,e,t,s){let i;switch(o){case de.FAIRPLAY:i=["cenc","sinf"];break;case de.WIDEVINE:case de.PLAYREADY:i=["cenc"];break;case de.CLEARKEY:i=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${o}`)}return $f(i,e,t,s)}function $f(o,e,t,s){return[{initDataTypes:o,persistentState:s.persistentState||"optional",distinctiveIdentifier:s.distinctiveIdentifier||"optional",sessionTypes:s.sessionTypes||[s.sessionType||"temporary"],audioCapabilities:e.map(n=>({contentType:`audio/mp4; codecs=${n}`,robustness:s.audioRobustness||"",encryptionScheme:s.audioEncryptionScheme||null})),videoCapabilities:t.map(n=>({contentType:`video/mp4; codecs=${n}`,robustness:s.videoRobustness||"",encryptionScheme:s.videoEncryptionScheme||null}))}]}function Vf(o){var e;return!!o&&(o.sessionType==="persistent-license"||!!((e=o.sessionTypes)!=null&&e.some(t=>t==="persistent-license")))}function ch(o){const e=new Uint16Array(o.buffer,o.byteOffset,o.byteLength/2),t=String.fromCharCode.apply(null,Array.from(e)),s=t.substring(t.indexOf("<"),t.length),r=new DOMParser().parseFromString(s,"text/xml").getElementsByTagName("KID")[0];if(r){const a=r.childNodes[0]?r.childNodes[0].nodeValue:r.getAttribute("VALUE");if(a){const c=wo(a).subarray(0,16);return oh(c),c}}return null}let cs={};class Kt{static clearKeyUriToKeyIdMap(){cs={}}static setKeyIdForUri(e,t){cs[e]=t}static addKeyIdForUri(e){const t=Object.keys(cs).length%Number.MAX_SAFE_INTEGER,s=new Uint8Array(16);return new DataView(s.buffer,12,4).setUint32(0,t),cs[e]=s,s}constructor(e,t,s,i=[1],n=null,r){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=s,this.keyFormatVersions=i,this.iv=n,this.encrypted=e?e!=="NONE":!1,this.isCommonEncryption=this.encrypted&&!Rs(e),r!=null&&r.startsWith("0x")&&(this.keyId=new Uint8Array(Qc(r)))}matches(e){return e.uri===this.uri&&e.method===this.method&&e.encrypted===this.encrypted&&e.keyFormat===this.keyFormat&&gn(e.keyFormatVersions,this.keyFormatVersions)&&Ya(e.iv,this.iv)&&Ya(e.keyId,this.keyId)}isSupported(){if(this.method){if(Rs(this.method)||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case De.FAIRPLAY:case De.WIDEVINE:case De.PLAYREADY:case De.CLEARKEY:return["SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(e,t){if(!this.encrypted||!this.uri)return null;if(Rs(this.method)){let n=this.iv;return n||(typeof e!="number"&&(re.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0),n=qf(e)),new Kt(this.method,this.uri,"identity",this.keyFormatVersions,n)}if(this.keyId){const n=cs[this.uri];if(n&&!gn(this.keyId,n)&&Kt.setKeyIdForUri(this.uri,this.keyId),this.pssh)return this}const s=ah(this.uri);if(s)switch(this.keyFormat){case De.WIDEVINE:if(this.pssh=s,!this.keyId){const n=jA(s.buffer);if(n.length){var i;const r=n[0];this.keyId=(i=r.kids)!=null&&i.length?r.kids[0]:null}}this.keyId||(this.keyId=qa(t));break;case De.PLAYREADY:{const n=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=WA(n,null,s),this.keyId=ch(s);break}default:{let n=s.subarray(0,16);if(n.length!==16){const r=new Uint8Array(16);r.set(n,16-n.length),n=r}this.keyId=n;break}}if(!this.keyId||this.keyId.byteLength!==16){let n;n=Yf(t),n||(n=qa(t),n||(n=cs[this.uri])),n&&(this.keyId=n,Kt.setKeyIdForUri(this.uri,n))}return this}}function Yf(o){const e=o?.[De.WIDEVINE];return e?e.keyId:null}function qa(o){const e=o?.[De.PLAYREADY];if(e){const t=ah(e.uri);if(t)return ch(t)}return null}function qf(o){const e=new Uint8Array(16);for(let t=12;t<16;t++)e[t]=o>>8*(15-t)&255;return e}const Wa=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,ja=/#EXT-X-MEDIA:(.*)/g,Wf=/^#EXT(?:INF|-X-TARGETDURATION):/m,Mn=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#.*/.source].join("|"),"g"),jf=new RegExp([/#EXT-X-(PROGRAM-DATE-TIME|BYTERANGE|DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class pt{static findGroup(e,t){for(let s=0;s<e.length;s++){const i=e[s];if(i.id===t)return i}}static resolve(e,t){return To.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return Wf.test(e)}static parseMasterPlaylist(e,t){const s=Ka(e),i={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:s},n=[];if(Wa.lastIndex=0,!e.startsWith("#EXTM3U"))return i.playlistParsingError=new Error("no EXTM3U delimiter"),i;let r;for(;(r=Wa.exec(e))!=null;)if(r[1]){var a;const l=new he(r[1],i),h=Qr(i,r[2]),u={attrs:l,bitrate:l.decimalInteger("BANDWIDTH")||l.decimalInteger("AVERAGE-BANDWIDTH"),name:l.NAME,url:pt.resolve(h,t)},d=l.decimalResolution("RESOLUTION");d&&(u.width=d.width,u.height=d.height),za(l.CODECS,u);const A=l["SUPPLEMENTAL-CODECS"];A&&(u.supplemental={},za(A,u.supplemental)),(a=u.unknownCodecs)!=null&&a.length||n.push(u),i.levels.push(u)}else if(r[3]){const l=r[3],h=r[4];switch(l){case"SESSION-DATA":{const u=new he(h,i),d=u["DATA-ID"];d&&(i.sessionData===null&&(i.sessionData={}),i.sessionData[d]=u);break}case"SESSION-KEY":{const u=Ja(h,t,i);u.encrypted&&u.isSupported()?(i.sessionKeys===null&&(i.sessionKeys=[]),i.sessionKeys.push(u)):re.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${h}"`);break}case"DEFINE":{{const u=new he(h,i);$a(i,u,t)}break}case"CONTENT-STEERING":{const u=new he(h,i);i.contentSteering={uri:pt.resolve(u["SERVER-URI"],t),pathwayId:u["PATHWAY-ID"]||"."};break}case"START":{i.startTimeOffset=Xa(h);break}}}const c=n.length>0&&n.length<i.levels.length;return i.levels=c?n:i.levels,i.levels.length===0&&(i.playlistParsingError=new Error("no levels found in manifest")),i}static parseMasterPlaylistMedia(e,t,s){let i;const n={},r=s.levels,a={AUDIO:r.map(l=>({id:l.attrs.AUDIO,audioCodec:l.audioCodec})),SUBTITLES:r.map(l=>({id:l.attrs.SUBTITLES,textCodec:l.textCodec})),"CLOSED-CAPTIONS":[]};let c=0;for(ja.lastIndex=0;(i=ja.exec(e))!==null;){const l=new he(i[1],s),h=l.TYPE;if(h){const u=a[h],d=n[h]||[];n[h]=d;const A=l.LANGUAGE,f=l["ASSOC-LANGUAGE"],g=l.CHANNELS,m=l.CHARACTERISTICS,E=l["INSTREAM-ID"],p={attrs:l,bitrate:0,id:c++,groupId:l["GROUP-ID"]||"",name:l.NAME||A||"",type:h,default:l.bool("DEFAULT"),autoselect:l.bool("AUTOSELECT"),forced:l.bool("FORCED"),lang:A,url:l.URI?pt.resolve(l.URI,t):""};if(f&&(p.assocLang=f),g&&(p.channels=g),m&&(p.characteristics=m),E&&(p.instreamId=E),u!=null&&u.length){const I=pt.findGroup(u,p.groupId)||u[0];Za(p,I,"audioCodec"),Za(p,I,"textCodec")}d.push(p)}}return n}static parseLevelPlaylist(e,t,s,i,n,r){var a;const c={url:t},l=new Gf(t),h=l.fragments,u=[];let d=null,A=0,f=0,g=0,m=0,E=0,p=null,I=new _n(i,c),C,T,L,S=-1,x=!1,v=null,B;if(Mn.lastIndex=0,l.m3u8=e,l.hasVariableRefs=Ka(e),((a=Mn.exec(e))==null?void 0:a[0])!=="#EXTM3U")return l.playlistParsingError=new Error("Missing format identifier #EXTM3U"),l;for(;(C=Mn.exec(e))!==null;){x&&(x=!1,I=new _n(i,c),I.playlistOffset=g,I.setStart(g),I.sn=A,I.cc=m,E&&(I.bitrate=E),I.level=s,d&&(I.initSegment=d,d.rawProgramDateTime&&(I.rawProgramDateTime=d.rawProgramDateTime,d.rawProgramDateTime=null),v&&(I.setByteRange(v),v=null)));const w=C[1];if(w){I.duration=parseFloat(w);const F=(" "+C[2]).slice(1);I.title=F||null,I.tagList.push(F?["INF",w,F]:["INF",w])}else if(C[3]){if(K(I.duration)){I.playlistOffset=g,I.setStart(g),L&&tl(I,L,l),I.sn=A,I.level=s,I.cc=m,h.push(I);const F=(" "+C[3]).slice(1);I.relurl=Qr(l,F),Nr(I,p,u),p=I,g+=I.duration,A++,f=0,x=!0}}else{if(C=C[0].match(jf),!C){re.warn("No matches on slow regex match for level playlist!");continue}for(T=1;T<C.length&&C[T]===void 0;T++);const F=(" "+C[T]).slice(1),P=(" "+C[T+1]).slice(1),G=C[T+2]?(" "+C[T+2]).slice(1):null;switch(F){case"BYTERANGE":p?I.setByteRange(P,p):I.setByteRange(P);break;case"PROGRAM-DATE-TIME":I.rawProgramDateTime=P,I.tagList.push(["PROGRAM-DATE-TIME",P]),S===-1&&(S=h.length);break;case"PLAYLIST-TYPE":l.type&&Bt(l,F,C),l.type=P.toUpperCase();break;case"MEDIA-SEQUENCE":l.startSN!==0?Bt(l,F,C):h.length>0&&sl(l,F,C),A=l.startSN=parseInt(P);break;case"SKIP":{l.skippedSegments&&Bt(l,F,C);const U=new he(P,l),H=U.decimalInteger("SKIPPED-SEGMENTS");if(K(H)){l.skippedSegments+=H;for(let O=H;O--;)h.push(null);A+=H}const $=U.enumeratedString("RECENTLY-REMOVED-DATERANGES");$&&(l.recentlyRemovedDateranges=(l.recentlyRemovedDateranges||[]).concat($.split("	")));break}case"TARGETDURATION":l.targetduration!==0&&Bt(l,F,C),l.targetduration=Math.max(parseInt(P),1);break;case"VERSION":l.version!==null&&Bt(l,F,C),l.version=parseInt(P);break;case"INDEPENDENT-SEGMENTS":break;case"ENDLIST":l.live||Bt(l,F,C),l.live=!1;break;case"#":(P||G)&&I.tagList.push(G?[P,G]:[P]);break;case"DISCONTINUITY":m++,I.tagList.push(["DIS"]);break;case"GAP":I.gap=!0,I.tagList.push([F]);break;case"BITRATE":I.tagList.push([F,P]),E=parseInt(P)*1e3,K(E)?I.bitrate=E:E=0;break;case"DATERANGE":{const U=new he(P,l),H=new rh(U,l.dateRanges[U.ID],l.dateRangeTagCount);l.dateRangeTagCount++,H.isValid||l.skippedSegments?l.dateRanges[H.id]=H:re.warn(`Ignoring invalid DATERANGE tag: "${P}"`),I.tagList.push(["EXT-X-DATERANGE",P]);break}case"DEFINE":{{const U=new he(P,l);"IMPORT"in U?Ff(l,U,r):$a(l,U,t)}break}case"DISCONTINUITY-SEQUENCE":l.startCC!==0?Bt(l,F,C):h.length>0&&sl(l,F,C),l.startCC=m=parseInt(P);break;case"KEY":{const U=Ja(P,t,l);if(U.isSupported()){if(U.method==="NONE"){L=void 0;break}L||(L={});const H=L[U.keyFormat];H!=null&&H.matches(U)||(H&&(L=oe({},L)),L[U.keyFormat]=U)}else re.warn(`[Keys] Ignoring unsupported EXT-X-KEY tag: "${P}"`);break}case"START":l.startTimeOffset=Xa(P);break;case"MAP":{const U=new he(P,l);if(I.duration){const H=new _n(i,c);el(H,U,s,L),d=H,I.initSegment=d,d.rawProgramDateTime&&!I.rawProgramDateTime&&(I.rawProgramDateTime=d.rawProgramDateTime)}else{const H=I.byteRangeEndOffset;if(H){const $=I.byteRangeStartOffset;v=`${H-$}@${$}`}else v=null;el(I,U,s,L),d=I,x=!0}d.cc=m;break}case"SERVER-CONTROL":{B&&Bt(l,F,C),B=new he(P),l.canBlockReload=B.bool("CAN-BLOCK-RELOAD"),l.canSkipUntil=B.optionalFloat("CAN-SKIP-UNTIL",0),l.canSkipDateRanges=l.canSkipUntil>0&&B.bool("CAN-SKIP-DATERANGES"),l.partHoldBack=B.optionalFloat("PART-HOLD-BACK",0),l.holdBack=B.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{l.partTarget&&Bt(l,F,C);const U=new he(P);l.partTarget=U.decimalFloatingPoint("PART-TARGET");break}case"PART":{let U=l.partList;U||(U=l.partList=[]);const H=f>0?U[U.length-1]:void 0,$=f++,O=new he(P,l),Q=new PA(O,I,c,$,H);U.push(Q),I.duration+=Q.duration;break}case"PRELOAD-HINT":{const U=new he(P,l);l.preloadHint=U;break}case"RENDITION-REPORT":{const U=new he(P,l);l.renditionReports=l.renditionReports||[],l.renditionReports.push(U);break}default:re.warn(`line parsed but not handled: ${C}`);break}}}p&&!p.relurl?(h.pop(),g-=p.duration,l.partList&&(l.fragmentHint=p)):l.partList&&(Nr(I,p,u),I.cc=m,l.fragmentHint=I,L&&tl(I,L,l)),l.targetduration||(l.playlistParsingError=new Error("Missing Target Duration"));const R=h.length,D=h[0],b=h[R-1];if(g+=l.skippedSegments*l.targetduration,g>0&&R&&b){l.averagetargetduration=g/R;const w=b.sn;l.endSN=w!=="initSegment"?w:0,l.live||(b.endList=!0),S>0&&(Xf(h,S),D&&u.unshift(D))}return l.fragmentHint&&(g+=l.fragmentHint.duration),l.totalduration=g,u.length&&l.dateRangeTagCount&&D&&hh(u,l),l.endCC=m,l}}function hh(o,e){let t=o.length;if(!t)if(e.hasProgramDateTime){const a=e.fragments[e.fragments.length-1];o.push(a),t++}else return;const s=o[t-1],i=e.live?1/0:e.totalduration,n=Object.keys(e.dateRanges);for(let a=n.length;a--;){const c=e.dateRanges[n[a]],l=c.startDate.getTime();c.tagAnchor=s.ref;for(let h=t;h--;){var r;if(((r=o[h])==null?void 0:r.sn)<e.startSN)break;const u=Jf(e,l,o,h,i);if(u!==-1){c.tagAnchor=e.fragments[u].ref;break}}}}function Jf(o,e,t,s,i){const n=t[s];if(n){const a=n.programDateTime;if(e>=a||s===0){var r;const c=(((r=t[s+1])==null?void 0:r.start)||i)-n.start;if(e<=a+c*1e3){const l=t[s].sn-o.startSN;if(l<0)return-1;const h=o.fragments;if(h.length>t.length){const d=(t[s+1]||h[h.length-1]).sn-o.startSN;for(let A=d;A>l;A--){const f=h[A].programDateTime;if(e>=f&&e<f+h[A].duration*1e3)return A}}return l}}}return-1}function Ja(o,e,t){var s,i;const n=new he(o,t),r=(s=n.METHOD)!=null?s:"",a=n.URI,c=n.hexadecimalInteger("IV"),l=n.KEYFORMATVERSIONS,h=(i=n.KEYFORMAT)!=null?i:"identity";a&&n.IV&&!c&&re.error(`Invalid IV: ${n.IV}`);const u=a?pt.resolve(a,e):"",d=(l||"1").split("/").map(Number).filter(Number.isFinite);return new Kt(r,u,h,d,c,n.KEYID)}function Xa(o){const t=new he(o).decimalFloatingPoint("TIME-OFFSET");return K(t)?t:null}function za(o,e){let t=(o||"").split(/[ ,]+/).filter(s=>s);["video","audio","text"].forEach(s=>{const i=t.filter(n=>xo(n,s));i.length&&(e[`${s}Codec`]=i.map(n=>n.split("/")[0]).join(","),t=t.filter(n=>i.indexOf(n)===-1))}),e.unknownCodecs=t}function Za(o,e,t){const s=e[t];s&&(o[t]=s)}function Xf(o,e){let t=o[e];for(let s=e;s--;){const i=o[s];if(!i)return;i.programDateTime=t.programDateTime-i.duration*1e3,t=i}}function Nr(o,e,t){o.rawProgramDateTime?t.push(o):e!=null&&e.programDateTime&&(o.programDateTime=e.endProgramDateTime)}function el(o,e,t,s){o.relurl=e.URI,e.BYTERANGE&&o.setByteRange(e.BYTERANGE),o.level=t,o.sn="initSegment",s&&(o.levelkeys=s),o.initSegment=null}function tl(o,e,t){o.levelkeys=e;const{encryptedFragments:s}=t;(!s.length||s[s.length-1].levelkeys!==e)&&Object.keys(e).some(i=>e[i].isCommonEncryption)&&s.push(o)}function Bt(o,e,t){o.playlistParsingError=new Error(`#EXT-X-${e} must not appear more than once (${t[0]})`)}function sl(o,e,t){o.playlistParsingError=new Error(`#EXT-X-${e} must appear before the first Media Segment (${t[0]})`)}function Qn(o,e){const t=e.startPTS;if(K(t)){let s=0,i;e.sn>o.sn?(s=t-o.start,i=o):(s=o.start-t,i=e),i.duration!==s&&i.setDuration(s)}else e.sn>o.sn?o.cc===e.cc&&o.minEndPTS?e.setStart(o.start+(o.minEndPTS-o.start)):e.setStart(o.start+o.duration):e.setStart(Math.max(o.start-e.duration,0))}function uh(o,e,t,s,i,n,r){s-t<=0&&(r.warn("Fragment should have a positive duration",e),s=t+e.duration,n=i+e.duration);let c=t,l=s;const h=e.startPTS,u=e.endPTS;if(K(h)){const E=Math.abs(h-t);o&&E>o.totalduration?r.warn(`media timestamps and playlist times differ by ${E}s for level ${e.level} ${o.url}`):K(e.deltaPTS)?e.deltaPTS=Math.max(E,e.deltaPTS):e.deltaPTS=E,c=Math.max(t,h),t=Math.min(t,h),i=e.startDTS!==void 0?Math.min(i,e.startDTS):i,l=Math.min(s,u),s=Math.max(s,u),n=e.endDTS!==void 0?Math.max(n,e.endDTS):n}const d=t-e.start;e.start!==0&&e.setStart(t),e.setDuration(s-e.start),e.startPTS=t,e.maxStartPTS=c,e.startDTS=i,e.endPTS=s,e.minEndPTS=l,e.endDTS=n;const A=e.sn;if(!o||A<o.startSN||A>o.endSN)return 0;let f;const g=A-o.startSN,m=o.fragments;for(m[g]=e,f=g;f>0;f--)Qn(m[f],m[f-1]);for(f=g;f<m.length-1;f++)Qn(m[f],m[f+1]);return o.fragmentHint&&Qn(m[m.length-1],o.fragmentHint),o.PTSKnown=o.alignedSliding=!0,d}function zf(o,e,t){if(o===e)return;let s=null;const i=o.fragments;for(let h=i.length-1;h>=0;h--){const u=i[h].initSegment;if(u){s=u;break}}o.fragmentHint&&delete o.fragmentHint.endPTS;let n;tg(o,e,(h,u,d,A)=>{if((!e.startCC||e.skippedSegments)&&u.cc!==h.cc){const f=h.cc-u.cc;for(let g=d;g<A.length;g++)A[g].cc+=f;e.endCC=A[A.length-1].cc}K(h.startPTS)&&K(h.endPTS)&&(u.setStart(u.startPTS=h.startPTS),u.startDTS=h.startDTS,u.maxStartPTS=h.maxStartPTS,u.endPTS=h.endPTS,u.endDTS=h.endDTS,u.minEndPTS=h.minEndPTS,u.setDuration(h.endPTS-h.startPTS),u.duration&&(n=u),e.PTSKnown=e.alignedSliding=!0),h.hasStreams&&(u.elementaryStreams=h.elementaryStreams),u.loader=h.loader,h.hasStats&&(u.stats=h.stats),h.initSegment&&(u.initSegment=h.initSegment,s=h.initSegment)});const r=e.fragments,a=e.fragmentHint?r.concat(e.fragmentHint):r;if(s&&a.forEach(h=>{var u;h&&(!h.initSegment||h.initSegment.relurl===((u=s)==null?void 0:u.relurl))&&(h.initSegment=s)}),e.skippedSegments){if(e.deltaUpdateFailed=r.some(h=>!h),e.deltaUpdateFailed){t.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let h=e.skippedSegments;h--;)r.shift();e.startSN=r[0].sn}else{e.canSkipDateRanges&&(e.dateRanges=Zf(o.dateRanges,e,t));const h=o.fragments.filter(u=>u.rawProgramDateTime);if(o.hasProgramDateTime&&!e.hasProgramDateTime)for(let u=1;u<a.length;u++)a[u].programDateTime===null&&Nr(a[u],a[u-1],h);hh(h,e)}e.endCC=r[r.length-1].cc}if(!e.startCC){var c;const h=fh(o,e.startSN-1);e.startCC=(c=h?.cc)!=null?c:r[0].cc}eg(o.partList,e.partList,(h,u)=>{u.elementaryStreams=h.elementaryStreams,u.stats=h.stats}),n?uh(e,n,n.startPTS,n.endPTS,n.startDTS,n.endDTS,t):dh(o,e),r.length&&(e.totalduration=e.edge-r[0].start),e.driftStartTime=o.driftStartTime,e.driftStart=o.driftStart;const l=e.advancedDateTime;if(e.advanced&&l){const h=e.edge;e.driftStart||(e.driftStartTime=l,e.driftStart=h),e.driftEndTime=l,e.driftEnd=h}else e.driftEndTime=o.driftEndTime,e.driftEnd=o.driftEnd,e.advancedDateTime=o.advancedDateTime;e.requestScheduled===-1&&(e.requestScheduled=o.requestScheduled)}function Zf(o,e,t){const{dateRanges:s,recentlyRemovedDateranges:i}=e,n=oe({},o);i&&i.forEach(c=>{delete n[c]});const a=Object.keys(n).length;return a?(Object.keys(s).forEach(c=>{const l=n[c],h=new rh(s[c].attr,l);h.isValid?(n[c]=h,l||(h.tagOrder+=a)):t.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${le(s[c].attr)}"`)}),n):s}function eg(o,e,t){if(o&&e){let s=0;for(let i=0,n=o.length;i<=n;i++){const r=o[i],a=e[i+s];r&&a&&r.index===a.index&&r.fragment.sn===a.fragment.sn?t(r,a):s--}}}function tg(o,e,t){const s=e.skippedSegments,i=Math.max(o.startSN,e.startSN)-e.startSN,n=(o.fragmentHint?1:0)+(s?e.endSN:Math.min(o.endSN,e.endSN))-e.startSN,r=e.startSN-o.startSN,a=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,c=o.fragmentHint?o.fragments.concat(o.fragmentHint):o.fragments;for(let l=i;l<=n;l++){const h=c[r+l];let u=a[l];if(s&&!u&&h&&(u=e.fragments[l]=h),h&&u){t(h,u,l,a);const d=h.relurl,A=u.relurl;if(d&&sg(d,A)){e.playlistParsingError=il(`media sequence mismatch ${u.sn}:`,o,e,h,u);return}else if(h.cc!==u.cc){e.playlistParsingError=il(`discontinuity sequence mismatch (${h.cc}!=${u.cc})`,o,e,h,u);return}}}}function il(o,e,t,s,i){return new Error(`${o} ${i.url}
Playlist starting @${e.startSN}
${e.m3u8}

Playlist starting @${t.startSN}
${t.m3u8}`)}function dh(o,e,t=!0){const s=e.startSN+e.skippedSegments-o.startSN,i=o.fragments,n=s>=0;let r=0;if(n&&s<i.length)r=i[s].start;else if(n&&e.startSN===o.endSN+1)r=o.fragmentEnd;else if(n&&t)r=o.fragmentStart+s*e.levelTargetDuration;else if(!e.skippedSegments&&e.fragmentStart===0)r=o.fragmentStart;else return;Ur(e,r)}function Ur(o,e){if(e){const t=o.fragments;for(let s=o.skippedSegments;s<t.length;s++)t[s].addStart(e);o.fragmentHint&&o.fragmentHint.addStart(e)}}function Ah(o,e=1/0){let t=1e3*o.targetduration;if(o.updated){const s=o.fragments;if(s.length&&t*4>e){const n=s[s.length-1].duration*1e3;n<t&&(t=n)}}else t/=2;return Math.round(t)}function fh(o,e,t){if(!o)return null;let s=o.fragments[e-o.startSN];return s||(s=o.fragmentHint,s&&s.sn===e)?s:e<o.startSN&&t&&t.sn===e?t:null}function nl(o,e,t){return o?gh(o.partList,e,t):null}function gh(o,e,t){if(o)for(let s=o.length;s--;){const i=o[s];if(i.index===t&&i.fragment.sn===e)return i}return null}function mh(o){o.forEach((e,t)=>{var s;(s=e.details)==null||s.fragments.forEach(i=>{i.level=t,i.initSegment&&(i.initSegment.level=t)})})}function sg(o,e){return o!==e&&e?rl(o)!==rl(e):!1}function rl(o){return o.replace(/\?[^?]*$/,"")}function ti(o,e){for(let s=0,i=o.length;s<i;s++){var t;if(((t=o[s])==null?void 0:t.cc)===e)return o[s]}return null}function ig(o,e){return!!(o&&e.startCC<o.endCC&&e.endCC>o.startCC)}function ol(o,e){const t=o.start+e;o.startPTS=t,o.setStart(t),o.endPTS=t+o.duration}function ph(o,e){const t=e.fragments;for(let s=0,i=t.length;s<i;s++)ol(t[s],o);e.fragmentHint&&ol(e.fragmentHint,o),e.alignedSliding=!0}function ng(o,e){o&&(Eh(e,o),e.alignedSliding||pn(e,o),!e.alignedSliding&&!e.skippedSegments&&dh(o,e,!1))}function Eh(o,e){if(!ig(e,o))return;const t=Math.min(e.endCC,o.endCC),s=ti(e.fragments,t),i=ti(o.fragments,t);if(!s||!i)return;re.log(`Aligning playlist at start of dicontinuity sequence ${t}`);const n=s.start-i.start;ph(n,o)}function pn(o,e){if(!o.hasProgramDateTime||!e.hasProgramDateTime)return;const t=o.fragments,s=e.fragments;if(!t.length||!s.length)return;let i,n;const r=Math.min(e.endCC,o.endCC);e.startCC<r&&o.startCC<r&&(i=ti(s,r),n=ti(t,r)),(!i||!n)&&(i=s[Math.floor(s.length/2)],n=ti(t,i.cc)||t[Math.floor(t.length/2)]);const a=i.programDateTime,c=n.programDateTime;if(!a||!c)return;const l=(c-a)/1e3-(n.start-i.start);ph(l,o)}function Pe(o,e,t){Ue(o,e,t),o.addEventListener(e,t)}function Ue(o,e,t){o.removeEventListener(e,t)}const rg={toString:function(o){let e="";const t=o.length;for(let s=0;s<t;s++)e+=`[${o.start(s).toFixed(3)}-${o.end(s).toFixed(3)}]`;return e}},M={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class _o extends ih{constructor(e,t,s,i,n){super(i,e.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=M.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.loadingParts=!1,this.loopSn=void 0,this.onMediaSeeking=()=>{const{config:r,fragCurrent:a,media:c,mediaBuffer:l,state:h}=this,u=c?c.currentTime:0,d=J.bufferInfo(l||c,u,r.maxBufferHole),A=!d.len;if(this.log(`Media seeking to ${K(u)?u.toFixed(3):u}, state: ${h}, ${A?"out of":"in"} buffer`),this.state===M.ENDED)this.resetLoadingState();else if(a){const f=r.maxFragLookUpTolerance,g=a.start-f,m=a.start+a.duration+f;if(A||m<d.start||g>d.end){const E=u>m;(u<g||E)&&(E&&a.loader&&(this.log(`Cancelling fragment load for seek (sn: ${a.sn})`),a.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}if(c){this.fragmentTracker.removeFragmentsInRange(u,1/0,this.playlistType,!0);const f=this.lastCurrentTime;if(u>f&&(this.lastCurrentTime=u),!this.loadingParts){const g=Math.max(d.end,u),m=this.shouldLoadParts(this.getLevelDetails(),g);m&&(this.log(`LL-Part loading ON after seeking to ${u.toFixed(2)} with buffer @${g.toFixed(2)}`),this.loadingParts=m)}}this.hls.hasEnoughToStart||(this.log(`Setting ${A?"startPosition":"nextLoadPosition"} to ${u} for seek without enough to start`),this.nextLoadPosition=u,A&&(this.startPosition=u)),A&&this.state===M.IDLE&&this.tickImmediate()},this.onMediaEnded=()=>{this.log("setting startPosition to 0 because media ended"),this.startPosition=this.lastCurrentTime=0},this.playlistType=n,this.hls=e,this.fragmentLoader=new kf(e.config),this.keyLoader=s,this.fragmentTracker=t,this.config=e.config,this.decrypter=new Ro(e.config)}registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(y.ERROR,this.onError,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){if(this.state===M.STOPPED)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=M.STOPPED}get startPositionValue(){const{nextLoadPosition:e,startPosition:t}=this;return t===-1&&e?e:t}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}get inFlightFrag(){return{frag:this.fragCurrent,state:this.state}}_streamEnded(e,t){if(t.live||!this.media)return!1;const s=e.end||0,i=this.config.timelineOffset||0;if(s<=i)return!1;const n=e.buffered;this.config.maxBufferHole&&n&&n.length>1&&(e=J.bufferedInfo(n,e.start,0));const r=e.nextStart;if(r&&r>i&&r<t.edge||this.media.currentTime<e.start)return!1;const c=t.partList;if(c!=null&&c.length){const h=c[c.length-1];return J.isBuffered(this.media,h.start+h.duration/2)}const l=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(l)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null)return this.levelLastLoaded.details}get timelineOffset(){const e=this.config.timelineOffset;if(e){var t;return((t=this.getLevelDetails())==null?void 0:t.appliedTimelineOffset)||e}return 0}onMediaAttached(e,t){const s=this.media=this.mediaBuffer=t.media;Pe(s,"seeking",this.onMediaSeeking),Pe(s,"ended",this.onMediaEnded);const i=this.config;this.levels&&i.autoStartLoad&&this.state===M.STOPPED&&this.startLoad(i.startPosition)}onMediaDetaching(e,t){const s=!!t.transferMedia,i=this.media;if(i!==null){if(i.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),Ue(i,"seeking",this.onMediaSeeking),Ue(i,"ended",this.onMediaEnded),this.keyLoader&&!s&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,s){this.resetLoadingState(),this.resetTransmuxer();return}this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1}onError(e,t){}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null}onHandlerDestroyed(){this.state=M.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,s){this.startFragRequested=!0,this._loadFragForPlayback(e,t,s)}_loadFragForPlayback(e,t,s){const i=n=>{const r=n.frag;if(this.fragContextChanged(r)){this.warn(`${r.type} sn: ${r.sn}${n.part?" part: "+n.part.index:""} of ${this.fragInfo(r,!1,n.part)}) was dropped during download.`),this.fragmentTracker.removeFragment(r);return}r.stats.chunkCount++,this._handleFragmentLoadProgress(n)};this._doFragLoad(e,t,s,i).then(n=>{if(!n)return;const r=this.state,a=n.frag;if(this.fragContextChanged(a)){(r===M.FRAG_LOADING||!this.fragCurrent&&r===M.PARSING)&&(this.fragmentTracker.removeFragment(a),this.state=M.IDLE);return}"payload"in n&&(this.log(`Loaded ${a.type} sn: ${a.sn} of ${this.playlistLabel()} ${a.level}`),this.hls.trigger(y.FRAG_LOADED,n)),this._handleFragmentLoadComplete(n)}).catch(n=>{this.state===M.STOPPED||this.state===M.ERROR||(this.warn(`Frag error: ${n?.message||n}`),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;const{fragmentTracker:s}=this;if(s.getState(e)===Ie.APPENDING){const n=e.type,r=this.getFwdBufferInfo(this.mediaBuffer,n),a=Math.max(e.duration,r?r.len:this.config.maxBufferLength),c=this.backtrackFragment;((c?e.sn-c.sn:0)===1||this.reduceMaxBufferLength(a,e.duration))&&s.removeFragment(e)}else((t=this.mediaBuffer)==null?void 0:t.buffered.length)===0?s.removeAllFragments():s.hasParts(e.type)&&(s.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),s.getState(e)===Ie.PARTIAL&&s.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}waitForLive(e){const t=e.details;return t?.live&&t.type!=="EVENT"&&(this.levelLastLoaded!==e||t.expired)}flushMainBuffer(e,t,s=null){if(!(e-t))return;const i={startOffset:e,endOffset:t,type:s};this.hls.trigger(y.BUFFER_FLUSHING,i)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(s=>{const i=s?.frag;if(!i||this.fragContextChanged(i)||!this.levels)throw new Error("init load aborted");return s}).then(s=>{const{hls:i}=this,{frag:n,payload:r}=s,a=n.decryptdata;if(r&&r.byteLength>0&&a!=null&&a.key&&a.iv&&Rs(a.method)){const c=self.performance.now();return this.decrypter.decrypt(new Uint8Array(r),a.key.buffer,a.iv.buffer,bo(a.method)).catch(l=>{throw i.trigger(y.ERROR,{type:q.MEDIA_ERROR,details:k.FRAG_DECRYPT_ERROR,fatal:!1,error:l,reason:l.message,frag:n}),l}).then(l=>{const h=self.performance.now();return i.trigger(y.FRAG_DECRYPTED,{frag:n,payload:l,stats:{tstart:c,tdecrypt:h}}),s.payload=l,this.completeInitSegmentLoad(s)})}return this.completeInitSegmentLoad(s)}).catch(s=>{this.state===M.STOPPED||this.state===M.ERROR||(this.warn(s),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const s=e.frag.stats;this.state!==M.STOPPED&&(this.state=M.IDLE),e.frag.data=new Uint8Array(e.payload),s.parsing.start=s.buffering.start=self.performance.now(),s.parsing.end=s.buffering.end=self.performance.now(),this.tick()}unhandledEncryptionError(e,t){var s,i;const n=e.tracks;if(n&&!t.encrypted&&((s=n.audio)!=null&&s.encrypted||(i=n.video)!=null&&i.encrypted)&&(!this.config.emeEnabled||!this.keyLoader.emeController)){const r=this.media,a=new Error(`Encrypted track with no key in ${this.fragInfo(t)} (media ${r?"attached mediaKeys: "+r.mediaKeys:"detached"})`);return this.warn(a.message),!r||r.mediaKeys?!1:(this.hls.trigger(y.ERROR,{type:q.KEY_SYSTEM_ERROR,details:k.KEY_SYSTEM_NO_KEYS,fatal:!1,error:a,frag:t}),this.resetTransmuxer(),!0)}return!1}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){const s=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)} > buffer:${s?rg.toString(J.getBuffered(s)):"(detached)"})`),ge(e)){var i;if(e.type!==V.SUBTITLE){const r=e.elementaryStreams;if(!Object.keys(r).some(a=>!!r[a])){this.state=M.IDLE;return}}const n=(i=this.levels)==null?void 0:i[e.level];n!=null&&n.fragmentError&&(this.log(`Resetting level fragment error count of ${n.fragmentError} on frag buffered`),n.fragmentError=0)}this.state=M.IDLE}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:s,part:i,partsLoaded:n}=e,r=!n||n.length===0||n.some(c=>!c),a=new Do(s.level,s.sn,s.stats.chunkCount+1,0,i?i.index:-1,!r);t.flush(a)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,s=null,i){var n;this.fragCurrent=e;const r=t.details;if(!this.levels||!r)throw new Error(`frag load aborted, missing level${r?"":" detail"}s`);let a=null;if(e.encrypted&&!((n=e.decryptdata)!=null&&n.key)){if(this.log(`Loading key for ${e.sn} of [${r.startSN}-${r.endSN}], ${this.playlistLabel()} ${e.level}`),this.state=M.KEY_LOADING,this.fragCurrent=e,a=this.keyLoader.load(e).then(d=>{if(!this.fragContextChanged(d.frag))return this.hls.trigger(y.KEY_LOADED,d),this.state===M.KEY_LOADING&&(this.state=M.IDLE),d}),this.hls.trigger(y.KEY_LOADING,{frag:e}),this.fragCurrent===null)return this.log("context changed in KEY_LOADING"),Promise.resolve(null)}else e.encrypted||(a=this.keyLoader.loadClear(e,r.encryptedFragments,this.startFragRequested),a&&this.log("[eme] blocking frag load until media-keys acquired"));const c=this.fragPrevious;if(ge(e)&&(!c||e.sn!==c.sn)){const d=this.shouldLoadParts(t.details,e.end);d!==this.loadingParts&&(this.log(`LL-Part loading ${d?"ON":"OFF"} loading sn ${c?.sn}->${e.sn}`),this.loadingParts=d)}if(s=Math.max(e.start,s||0),this.loadingParts&&ge(e)){const d=r.partList;if(d&&i){s>r.fragmentEnd&&r.fragmentHint&&(e=r.fragmentHint);const A=this.getNextPart(d,e,s);if(A>-1){const f=d[A];e=this.fragCurrent=f.fragment,this.log(`Loading ${e.type} sn: ${e.sn} part: ${f.index} (${A}/${d.length-1}) of ${this.fragInfo(e,!1,f)}) cc: ${e.cc} [${r.startSN}-${r.endSN}], target: ${parseFloat(s.toFixed(3))}`),this.nextLoadPosition=f.start+f.duration,this.state=M.FRAG_LOADING;let g;return a?g=a.then(m=>!m||this.fragContextChanged(m.frag)?null:this.doFragPartsLoad(e,f,t,i)).catch(m=>this.handleFragLoadError(m)):g=this.doFragPartsLoad(e,f,t,i).catch(m=>this.handleFragLoadError(m)),this.hls.trigger(y.FRAG_LOADING,{frag:e,part:f,targetBufferTime:s}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):g}else if(!e.url||this.loadedEndOfParts(d,s))return Promise.resolve(null)}}if(ge(e)&&this.loadingParts){var l;this.log(`LL-Part loading OFF after next part miss @${s.toFixed(2)} Check buffer at sn: ${e.sn} loaded parts: ${(l=r.partList)==null?void 0:l.filter(d=>d.loaded).map(d=>`[${d.start}-${d.end}]`)}`),this.loadingParts=!1}else if(!e.url)return Promise.resolve(null);this.log(`Loading ${e.type} sn: ${e.sn} of ${this.fragInfo(e,!1)}) cc: ${e.cc} ${"["+r.startSN+"-"+r.endSN+"]"}, target: ${parseFloat(s.toFixed(3))}`),K(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=M.FRAG_LOADING;const h=this.config.progressive&&e.type!==V.SUBTITLE;let u;return h&&a?u=a.then(d=>!d||this.fragContextChanged(d.frag)?null:this.fragmentLoader.load(e,i)).catch(d=>this.handleFragLoadError(d)):u=Promise.all([this.fragmentLoader.load(e,h?i:void 0),a]).then(([d])=>(!h&&i&&i(d),d)).catch(d=>this.handleFragLoadError(d)),this.hls.trigger(y.FRAG_LOADING,{frag:e,targetBufferTime:s}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):u}doFragPartsLoad(e,t,s,i){return new Promise((n,r)=>{var a;const c=[],l=(a=s.details)==null?void 0:a.partList,h=u=>{this.fragmentLoader.loadPart(e,u,i).then(d=>{c[u.index]=d;const A=d.part;this.hls.trigger(y.FRAG_LOADED,d);const f=nl(s.details,e.sn,u.index+1)||gh(l,e.sn,u.index+1);if(f)h(f);else return n({frag:e,part:A,partsLoaded:c})}).catch(r)};h(t)})}handleFragLoadError(e){if("data"in e){const t=e.data;t.frag&&t.details===k.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):t.frag&&t.type===q.KEY_SYSTEM_ERROR?(t.frag.abortRequests(),this.resetStartWhenNotLoaded(),this.resetFragmentLoading(t.frag)):this.hls.trigger(y.ERROR,t)}else this.hls.trigger(y.ERROR,{type:q.OTHER_ERROR,details:k.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==M.PARSING){!this.fragCurrent&&this.state!==M.STOPPED&&this.state!==M.ERROR&&(this.state=M.IDLE);return}const{frag:s,part:i,level:n}=t,r=self.performance.now();s.stats.parsing.end=r,i&&(i.stats.parsing.end=r);const a=this.getLevelDetails(),l=a&&s.sn>a.endSN||this.shouldLoadParts(a,s.end);l!==this.loadingParts&&(this.log(`LL-Part loading ${l?"ON":"OFF"} after parsing segment ending @${s.end.toFixed(2)}`),this.loadingParts=l),this.updateLevelTiming(s,i,n,e.partial)}shouldLoadParts(e,t){if(this.config.lowLatencyMode){if(!e)return this.loadingParts;if(e.partList){var s;const n=e.partList[0];if(n.fragment.type===V.SUBTITLE)return!1;const r=n.end+(((s=e.fragmentHint)==null?void 0:s.duration)||0);if(t>=r){var i;if((this.hls.hasEnoughToStart?((i=this.media)==null?void 0:i.currentTime)||this.lastCurrentTime:this.getLoadPosition())>n.start-n.fragment.duration)return!0}}}return!1}getCurrentContext(e){const{levels:t,fragCurrent:s}=this,{level:i,sn:n,part:r}=e;if(!(t!=null&&t[i]))return this.warn(`Levels object was unset while buffering fragment ${n} of ${this.playlistLabel()} ${i}. The current chunk will not be buffered.`),null;const a=t[i],c=a.details,l=r>-1?nl(c,n,r):null,h=l?l.fragment:fh(c,n,s);return h?(s&&s!==h&&(h.stats=s.stats),{frag:h,part:l,level:a}):null}bufferFragmentData(e,t,s,i,n){if(this.state!==M.PARSING)return;const{data1:r,data2:a}=e;let c=r;if(a&&(c=tt(r,a)),!c.length)return;const l=this.initPTS[t.cc],h=l?-l.baseTime/l.timescale:void 0,u={type:e.type,frag:t,part:s,chunkMeta:i,offset:h,parent:t.type,data:c};if(this.hls.trigger(y.BUFFER_APPENDING,u),e.dropped&&e.independent&&!s){if(n)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!J.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}const s=t.currentTime,i=J.bufferInfo(t,s,0),n=e.duration,r=Math.min(this.config.maxFragLookUpTolerance*2,n*.25),a=Math.max(Math.min(e.start-r,i.end-r),s+r);e.start-a>r&&this.flushMainBuffer(a,e.start)}getFwdBufferInfo(e,t){var s;const i=this.getLoadPosition();if(!K(i))return null;const r=this.lastCurrentTime>i||(s=this.media)!=null&&s.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(e,i,t,r)}getFwdBufferInfoAtPos(e,t,s,i){const n=J.bufferInfo(e,t,i);if(n.len===0&&n.nextStart!==void 0){const r=this.fragmentTracker.getBufferedFrag(t,s);if(r&&(n.nextStart<=r.end||r.gap)){const a=Math.max(Math.min(n.nextStart,r.end)-t,i);return J.bufferInfo(e,t,a)}}return n}getMaxBufferLength(e){const{config:t}=this;let s;return e?s=Math.max(8*t.maxBufferSize/e,t.maxBufferLength):s=t.maxBufferLength,Math.min(s,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){const s=this.config,i=Math.max(Math.min(e-t,s.maxBufferLength),t),n=Math.max(e-t*3,s.maxMaxBufferLength/2,i);return n>=i?(s.maxMaxBufferLength=n,this.warn(`Reduce max buffer length to ${n}s`),!0):!1}getAppendedFrag(e,t=V.MAIN){const s=this.fragmentTracker?this.fragmentTracker.getAppendedFrag(e,t):null;return s&&"fragment"in s?s.fragment:s}getNextFragment(e,t){const s=t.fragments,i=s.length;if(!i)return null;const{config:n}=this,r=s[0].start,a=n.lowLatencyMode&&!!t.partList;let c=null;if(t.live){const u=n.initialLiveManifestSize;if(i<u)return this.warn(`Not enough fragments to start playback (have: ${i}, need: ${u})`),null;if(!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||e<r){var l;a&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),c=this.getInitialLiveFragment(t);const d=this.hls.startPosition,A=this.hls.liveSyncPosition,f=c?(d!==-1&&d>=r?d:A)||c.start:e;this.log(`Setting startPosition to ${f} to match start frag at live edge. mainStart: ${d} liveSyncPosition: ${A} frag.start: ${(l=c)==null?void 0:l.start}`),this.startPosition=this.nextLoadPosition=f}}else e<=r&&(c=s[0]);if(!c){const u=this.loadingParts?t.partEnd:t.fragmentEnd;c=this.getFragmentAtPosition(e,u,t)}let h=this.filterReplacedPrimary(c,t);if(!h&&c){const u=c.sn-t.startSN;h=this.filterReplacedPrimary(s[u+1]||null,t)}return this.mapToInitFragWhenRequired(h)}isLoopLoading(e,t){const s=this.fragmentTracker.getState(e);return(s===Ie.OK||s===Ie.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,s,i,n){let r=null;if(e.gap&&(r=this.getNextFragment(this.nextLoadPosition,t),r&&!r.gap&&s.nextStart)){const a=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,s.nextStart,i,0);if(a!==null&&s.len+a.len>=n){const c=r.sn;return this.loopSn!==c&&(this.log(`buffer full after gaps in "${i}" playlist starting at sn: ${c}`),this.loopSn=c),null}}return this.loopSn=void 0,r}get primaryPrefetch(){if(al(this.config)){var e;if((e=this.hls.interstitialsManager)==null||(e=e.playingItem)==null?void 0:e.event)return!0}return!1}filterReplacedPrimary(e,t){if(!e)return e;if(al(this.config)&&e.type!==V.SUBTITLE){const s=this.hls.interstitialsManager,i=s?.bufferingItem;if(i){const r=i.event;if(r){if(r.appendInPlace||Math.abs(e.start-i.start)>1||i.start===0)return null}else if(e.end<=i.start&&t?.live===!1||e.start>i.end&&i.nextEvent&&(i.nextEvent.appendInPlace||e.start-i.end>1))return null}const n=s?.playerQueue;if(n)for(let r=n.length;r--;){const a=n[r].interstitial;if(a.appendInPlace&&e.start>=a.startTime&&e.end<=a.resumeTime)return null}}return e}mapToInitFragWhenRequired(e){return e!=null&&e.initSegment&&!e.initSegment.data&&!this.bitrateTest?e.initSegment:e}getNextPart(e,t,s){let i=-1,n=!1,r=!0;for(let a=0,c=e.length;a<c;a++){const l=e[a];if(r=r&&!l.independent,i>-1&&s<l.start)break;const h=l.loaded;h?i=-1:(n||(l.independent||r)&&l.fragment===t)&&(l.fragment!==t&&this.warn(`Need buffer at ${s} but next unloaded part starts at ${l.start}`),i=a),n=h}return i}loadedEndOfParts(e,t){let s;for(let i=e.length;i--;){if(s=e[i],!s.loaded)return!1;if(t>s.start)return!0}return!1}getInitialLiveFragment(e){const t=e.fragments,s=this.fragPrevious;let i=null;if(s){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${s.programDateTime}`),i=Cf(t,s.endProgramDateTime,this.config.maxFragLookUpTolerance)),!i){const n=s.sn+1;if(n>=e.startSN&&n<=e.endSN){const r=t[n-e.startSN];s.cc===r.cc&&(i=r,this.log(`Live playlist, switching playlist, load frag with next SN: ${i.sn}`))}i||(i=eh(e,s.cc,s.end),i&&this.log(`Live playlist, switching playlist, load frag with same CC: ${i.sn}`))}}else{const n=this.hls.liveSyncPosition;n!==null&&(i=this.getFragmentAtPosition(n,this.bitrateTest?e.fragmentEnd:e.edge,e))}return i}getFragmentAtPosition(e,t,s){const{config:i}=this;let{fragPrevious:n}=this,{fragments:r,endSN:a}=s;const{fragmentHint:c}=s,{maxFragLookUpTolerance:l}=i,h=s.partList,u=!!(this.loadingParts&&h!=null&&h.length&&c);u&&!this.bitrateTest&&h[h.length-1].fragment.sn===c.sn&&(r=r.concat(c),a=c.sn);let d;if(e<t){var A;const g=e<this.lastCurrentTime||e>t-l||(A=this.media)!=null&&A.paused||!this.startFragRequested?0:l;d=rs(n,r,e,g)}else d=r[r.length-1];if(d){const f=d.sn-s.startSN,g=this.fragmentTracker.getState(d);if((g===Ie.OK||g===Ie.PARTIAL&&d.gap)&&(n=d),n&&d.sn===n.sn&&(!u||h[0].fragment.sn>d.sn||!s.live)&&d.level===n.level){const E=r[f+1];d.sn<a&&this.fragmentTracker.getState(E)!==Ie.OK?d=E:d=null}}return d}alignPlaylists(e,t,s){const i=e.fragments.length;if(!i)return this.warn("No fragments in live playlist"),0;const n=e.fragmentStart,r=!t,a=e.alignedSliding&&K(n);if(r||!a&&!n){ng(s,e);const c=e.fragmentStart;return this.log(`Live playlist sliding: ${c.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} fragments: ${i}`),c}return n}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)}setStartPosition(e,t){let s=this.startPosition;s<t&&(s=-1);const i=this.timelineOffset;if(s===-1){const n=this.startTimeOffset!==null,r=n?this.startTimeOffset:e.startTimeOffset;r!==null&&K(r)?(s=t+r,r<0&&(s+=e.edge),s=Math.min(Math.max(t,s),t+e.totalduration),this.log(`Setting startPosition to ${s} for start time offset ${r} found in ${n?"multivariant":"media"} playlist`),this.startPosition=s):e.live?(s=this.hls.liveSyncPosition||t,this.log(`Setting startPosition to -1 to start at live edge ${s}`),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=s=0),this.lastCurrentTime=s+i}this.nextLoadPosition=s+i}getLoadPosition(){var e;const{media:t}=this;let s=0;return(e=this.hls)!=null&&e.hasEnoughToStart&&t?s=t.currentTime:this.nextLoadPosition>=0&&(s=this.nextLoadPosition),s}handleFragLoadAborted(e,t){this.transmuxer&&e.type===this.playlistType&&ge(e)&&e.stats.aborted&&(this.log(`Fragment ${e.sn}${t?" part "+t.index:""} of ${this.playlistLabel()} ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==M.FRAG_LOADING_WAITING_RETRY)&&(this.state=M.IDLE)}onFragmentOrKeyLoadError(e,t){var s;if(t.chunkMeta&&!t.frag){const E=this.getCurrentContext(t.chunkMeta);E&&(t.frag=E.frag)}const i=t.frag;if(!i||i.type!==e||!this.levels)return;if(this.fragContextChanged(i)){var n;this.warn(`Frag load error must match current frag to retry ${i.url} > ${(n=this.fragCurrent)==null?void 0:n.url}`);return}const r=t.details===k.FRAG_GAP;r&&this.fragmentTracker.fragBuffered(i,!0);const a=t.errorAction;if(!a){this.state=M.ERROR;return}const{action:c,flags:l,retryCount:h=0,retryConfig:u}=a,d=!!u,A=d&&c===Le.RetryRequest,f=d&&!a.resolved&&l===He.MoveAllAlternatesMatchingHost,g=(s=this.hls.latestLevelDetails)==null?void 0:s.live;if(!A&&f&&ge(i)&&!i.endList&&g&&!sh(t))this.resetFragmentErrors(e),this.treatAsGap(i),a.resolved=!0;else if((A||f)&&h<u.maxNumRetry){var m;const E=Mr((m=t.response)==null?void 0:m.code),p=Lo(u,h);if(this.resetStartWhenNotLoaded(),this.retryDate=self.performance.now()+p,this.state=M.FRAG_LOADING_WAITING_RETRY,a.resolved=!0,E){this.log("Waiting for connection (offline)"),this.retryDate=1/0,t.reason="offline";return}this.warn(`Fragment ${i.sn} of ${e} ${i.level} errored with ${t.details}, retrying loading ${h+1}/${u.maxNumRetry} in ${p}ms`)}else if(u)if(this.resetFragmentErrors(e),h<u.maxNumRetry)!r&&c!==Le.RemoveAlternatePermanently&&(a.resolved=!0);else{this.warn(`${t.details} reached or exceeded max retry (${h})`);return}else c===Le.SendAlternateToPenaltyBox?this.state=M.WAITING_LEVEL:this.state=M.ERROR;this.tickImmediate()}checkRetryDate(){const e=self.performance.now(),t=this.retryDate,s=t===1/0;(!t||e>=t||s&&!Mr(0))&&(s&&this.log("Connection restored (online)"),this.resetStartWhenNotLoaded(),this.state=M.IDLE)}reduceLengthAndFlushBuffer(e){if(this.state===M.PARSING||this.state===M.PARSED){const t=e.frag,s=e.parent,i=this.getFwdBufferInfo(this.mediaBuffer,s),n=i&&i.len>.5;n&&this.reduceMaxBufferLength(i.len,t?.duration||10);const r=!n;return r&&this.warn(`Buffer full error while media.currentTime (${this.getLoadPosition()}) is not buffered, flush ${s} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),r}return!1}resetFragmentErrors(e){e===V.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==M.STOPPED&&(this.state=M.IDLE)}afterBufferFlushed(e,t,s){if(!e)return;const i=J.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,i,s),this.state===M.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==M.STOPPED&&(this.state=M.IDLE)}resetStartWhenNotLoaded(){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;const e=this.levelLastLoaded,t=e?e.details:null;t!=null&&t.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(t,t.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.log(`Loading context changed while buffering sn ${e.sn} of ${this.playlistLabel()} ${e.level===-1?"<removed>":e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,s,i){const n=s.details;if(!n){this.warn("level.details undefined");return}if(!Object.keys(e.elementaryStreams).reduce((c,l)=>{const h=e.elementaryStreams[l];if(h){const u=h.endPTS-h.startPTS;if(u<=0)return this.warn(`Could not parse fragment ${e.sn} ${l} duration reliably (${u})`),c||!1;const d=i?0:uh(n,e,h.startPTS,h.endPTS,h.startDTS,h.endDTS,this);return this.hls.trigger(y.LEVEL_PTS_UPDATED,{details:n,level:s,drift:d,type:l,frag:e,start:h.startPTS,end:h.endPTS}),!0}return c},!1)){var a;const c=((a=this.transmuxer)==null?void 0:a.error)===null;if((s.fragmentError===0||c&&(s.fragmentError<2||e.endList))&&this.treatAsGap(e,s),c){const l=new Error(`Found no media in fragment ${e.sn} of ${this.playlistLabel()} ${e.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(l.message),this.hls.trigger(y.ERROR,{type:q.MEDIA_ERROR,details:k.FRAG_PARSING_ERROR,fatal:!1,error:l,frag:e,reason:`Found no media in msn ${e.sn} of ${this.playlistLabel()} "${s.url}"`}),!this.hls)return;this.resetTransmuxer()}}this.state=M.PARSED,this.log(`Parsed ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)})`),this.hls.trigger(y.FRAG_PARSED,{frag:e,part:t})}playlistLabel(){return this.playlistType===V.MAIN?"level":"track"}fragInfo(e,t=!0,s){var i,n;return`${this.playlistLabel()} ${e.level} (${s?"part":"frag"}:[${((i=t&&!s?e.startPTS:(s||e).start)!=null?i:NaN).toFixed(3)}-${((n=t&&!s?e.endPTS:(s||e).end)!=null?n:NaN).toFixed(3)}]${s&&e.type==="main"?"INDEPENDENT="+(s.independent?"YES":"NO"):""}`}treatAsGap(e,t){t&&t.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)}resetTransmuxer(){var e;(e=this.transmuxer)==null||e.reset()}recoverWorkerError(e){e.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}function al(o){return!!o.interstitialsController&&o.enableInterstitialPlayback!==!1}class Ih{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let s;if(e.length)e.length===1?s=e[0]:s=og(e,t);else return new Uint8Array(0);return this.reset(),s}reset(){this.chunks.length=0,this.dataLength=0}}function og(o,e){const t=new Uint8Array(e);let s=0;for(let i=0;i<o.length;i++){const n=o[i];t.set(n,s),s+=n.length}return t}var On={exports:{}},ll;function ag(){return ll||(ll=1,(function(o){var e=Object.prototype.hasOwnProperty,t="~";function s(){}Object.create&&(s.prototype=Object.create(null),new s().__proto__||(t=!1));function i(c,l,h){this.fn=c,this.context=l,this.once=h||!1}function n(c,l,h,u,d){if(typeof h!="function")throw new TypeError("The listener must be a function");var A=new i(h,u||c,d),f=t?t+l:l;return c._events[f]?c._events[f].fn?c._events[f]=[c._events[f],A]:c._events[f].push(A):(c._events[f]=A,c._eventsCount++),c}function r(c,l){--c._eventsCount===0?c._events=new s:delete c._events[l]}function a(){this._events=new s,this._eventsCount=0}a.prototype.eventNames=function(){var l=[],h,u;if(this._eventsCount===0)return l;for(u in h=this._events)e.call(h,u)&&l.push(t?u.slice(1):u);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(h)):l},a.prototype.listeners=function(l){var h=t?t+l:l,u=this._events[h];if(!u)return[];if(u.fn)return[u.fn];for(var d=0,A=u.length,f=new Array(A);d<A;d++)f[d]=u[d].fn;return f},a.prototype.listenerCount=function(l){var h=t?t+l:l,u=this._events[h];return u?u.fn?1:u.length:0},a.prototype.emit=function(l,h,u,d,A,f){var g=t?t+l:l;if(!this._events[g])return!1;var m=this._events[g],E=arguments.length,p,I;if(m.fn){switch(m.once&&this.removeListener(l,m.fn,void 0,!0),E){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,h),!0;case 3:return m.fn.call(m.context,h,u),!0;case 4:return m.fn.call(m.context,h,u,d),!0;case 5:return m.fn.call(m.context,h,u,d,A),!0;case 6:return m.fn.call(m.context,h,u,d,A,f),!0}for(I=1,p=new Array(E-1);I<E;I++)p[I-1]=arguments[I];m.fn.apply(m.context,p)}else{var C=m.length,T;for(I=0;I<C;I++)switch(m[I].once&&this.removeListener(l,m[I].fn,void 0,!0),E){case 1:m[I].fn.call(m[I].context);break;case 2:m[I].fn.call(m[I].context,h);break;case 3:m[I].fn.call(m[I].context,h,u);break;case 4:m[I].fn.call(m[I].context,h,u,d);break;default:if(!p)for(T=1,p=new Array(E-1);T<E;T++)p[T-1]=arguments[T];m[I].fn.apply(m[I].context,p)}}return!0},a.prototype.on=function(l,h,u){return n(this,l,h,u,!1)},a.prototype.once=function(l,h,u){return n(this,l,h,u,!0)},a.prototype.removeListener=function(l,h,u,d){var A=t?t+l:l;if(!this._events[A])return this;if(!h)return r(this,A),this;var f=this._events[A];if(f.fn)f.fn===h&&(!d||f.once)&&(!u||f.context===u)&&r(this,A);else{for(var g=0,m=[],E=f.length;g<E;g++)(f[g].fn!==h||d&&!f[g].once||u&&f[g].context!==u)&&m.push(f[g]);m.length?this._events[A]=m.length===1?m[0]:m:r(this,A)}return this},a.prototype.removeAllListeners=function(l){var h;return l?(h=t?t+l:l,this._events[h]&&r(this,h)):(this._events=new s,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,o.exports=a})(On)),On.exports}var lg=ag(),ko=_A(lg);const hi="1.6.15",Ps={};function cg(){return typeof __HLS_WORKER_BUNDLE__=="function"}function hg(){const o=Ps[hi];if(o)return o.clientCount++,o;const e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(e),i={worker:new self.Worker(t),objectURL:t,clientCount:1};return Ps[hi]=i,i}function ug(o){const e=Ps[o];if(e)return e.clientCount++,e;const t=new self.URL(o,self.location.href).href,i={worker:new self.Worker(t),scriptURL:t,clientCount:1};return Ps[o]=i,i}function dg(o){const e=Ps[o||hi];if(e&&e.clientCount--===1){const{worker:s,objectURL:i}=e;delete Ps[o||hi],i&&self.URL.revokeObjectURL(i),s.terminate()}}function yh(o,e){return e+10<=o.length&&o[e]===51&&o[e+1]===68&&o[e+2]===73&&o[e+3]<255&&o[e+4]<255&&o[e+6]<128&&o[e+7]<128&&o[e+8]<128&&o[e+9]<128}function Po(o,e){return e+10<=o.length&&o[e]===73&&o[e+1]===68&&o[e+2]===51&&o[e+3]<255&&o[e+4]<255&&o[e+6]<128&&o[e+7]<128&&o[e+8]<128&&o[e+9]<128}function Tn(o,e){let t=0;return t=(o[e]&127)<<21,t|=(o[e+1]&127)<<14,t|=(o[e+2]&127)<<7,t|=o[e+3]&127,t}function ui(o,e){const t=e;let s=0;for(;Po(o,e);){s+=10;const i=Tn(o,e+6);s+=i,yh(o,e+10)&&(s+=10),e+=s}if(s>0)return o.subarray(t,t+s)}function Ag(o,e,t,s){const i=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],n=e[t+2],r=n>>2&15;if(r>12){const A=new Error(`invalid ADTS sampling index:${r}`);o.emit(y.ERROR,y.ERROR,{type:q.MEDIA_ERROR,details:k.FRAG_PARSING_ERROR,fatal:!0,error:A,reason:A.message});return}const a=(n>>6&3)+1,c=e[t+3]>>6&3|(n&1)<<2,l="mp4a.40."+a,h=i[r];let u=r;(a===5||a===29)&&(u-=3);const d=[a<<3|(u&14)>>1,(u&1)<<7|c<<3];return re.log(`manifest codec:${s}, parsed codec:${l}, channels:${c}, rate:${h} (ADTS object type:${a} sampling index:${r})`),{config:d,samplerate:h,channelCount:c,codec:l,parsedCodec:l,manifestCodec:s}}function Ch(o,e){return o[e]===255&&(o[e+1]&246)===240}function Th(o,e){return o[e+1]&1?7:9}function Fo(o,e){return(o[e+3]&3)<<11|o[e+4]<<3|(o[e+5]&224)>>>5}function fg(o,e){return e+5<o.length}function En(o,e){return e+1<o.length&&Ch(o,e)}function gg(o,e){return fg(o,e)&&Ch(o,e)&&Fo(o,e)<=o.length-e}function mg(o,e){if(En(o,e)){const t=Th(o,e);if(e+t>=o.length)return!1;const s=Fo(o,e);if(s<=t)return!1;const i=e+s;return i===o.length||En(o,i)}return!1}function Sh(o,e,t,s,i){if(!o.samplerate){const n=Ag(e,t,s,i);if(!n)return;oe(o,n)}}function Bh(o){return 1024*9e4/o}function pg(o,e){const t=Th(o,e);if(e+t<=o.length){const s=Fo(o,e)-t;if(s>0)return{headerLength:t,frameLength:s}}}function xh(o,e,t,s,i){const n=Bh(o.samplerate),r=s+i*n,a=pg(e,t);let c;if(a){const{frameLength:u,headerLength:d}=a,A=d+u,f=Math.max(0,t+A-e.length);f?(c=new Uint8Array(A-d),c.set(e.subarray(t+d,e.length),0)):c=e.subarray(t+d,t+A);const g={unit:c,pts:r};return f||o.samples.push(g),{sample:g,length:A,missing:f}}const l=e.length-t;return c=new Uint8Array(l),c.set(e.subarray(t,e.length),0),{sample:{unit:c,pts:r},length:l,missing:-1}}function Eg(o,e){return Po(o,e)&&Tn(o,e+6)+10<=o.length-e}function Ig(o){return o instanceof ArrayBuffer?o:o.byteOffset==0&&o.byteLength==o.buffer.byteLength?o.buffer:new Uint8Array(o).buffer}function Nn(o,e=0,t=1/0){return yg(o,e,t,Uint8Array)}function yg(o,e,t,s){const i=Cg(o);let n=1;"BYTES_PER_ELEMENT"in s&&(n=s.BYTES_PER_ELEMENT);const r=Tg(o)?o.byteOffset:0,a=(r+o.byteLength)/n,c=(r+e)/n,l=Math.floor(Math.max(0,Math.min(c,a))),h=Math.floor(Math.min(l+Math.max(t,0),a));return new s(i,l,h-l)}function Cg(o){return o instanceof ArrayBuffer?o:o.buffer}function Tg(o){return o&&o.buffer instanceof ArrayBuffer&&o.byteLength!==void 0&&o.byteOffset!==void 0}function Sg(o){const e={key:o.type,description:"",data:"",mimeType:null,pictureType:null},t=3;if(o.size<2)return;if(o.data[0]!==t){console.log("Ignore frame with unrecognized character encoding");return}const s=o.data.subarray(1).indexOf(0);if(s===-1)return;const i=Ve(Nn(o.data,1,s)),n=o.data[2+s],r=o.data.subarray(3+s).indexOf(0);if(r===-1)return;const a=Ve(Nn(o.data,3+s,r));let c;return i==="-->"?c=Ve(Nn(o.data,4+s+r)):c=Ig(o.data.subarray(4+s+r)),e.mimeType=i,e.pictureType=n,e.description=a,e.data=c,e}function Bg(o){if(o.size<2)return;const e=Ve(o.data,!0),t=new Uint8Array(o.data.subarray(e.length+1));return{key:o.type,info:e,data:t.buffer}}function xg(o){if(o.size<2)return;if(o.type==="TXXX"){let t=1;const s=Ve(o.data.subarray(t),!0);t+=s.length+1;const i=Ve(o.data.subarray(t));return{key:o.type,info:s,data:i}}const e=Ve(o.data.subarray(1));return{key:o.type,info:"",data:e}}function vg(o){if(o.type==="WXXX"){if(o.size<2)return;let t=1;const s=Ve(o.data.subarray(t),!0);t+=s.length+1;const i=Ve(o.data.subarray(t));return{key:o.type,info:s,data:i}}const e=Ve(o.data);return{key:o.type,info:"",data:e}}function Lg(o){return o.type==="PRIV"?Bg(o):o.type[0]==="W"?vg(o):o.type==="APIC"?Sg(o):xg(o)}function Rg(o){const e=String.fromCharCode(o[0],o[1],o[2],o[3]),t=Tn(o,4),s=10;return{type:e,size:t,data:o.subarray(s,s+t)}}const Ci=10,Dg=10;function vh(o){let e=0;const t=[];for(;Po(o,e);){const s=Tn(o,e+6);o[e+5]>>6&1&&(e+=Ci),e+=Ci;const i=e+s;for(;e+Dg<i;){const n=Rg(o.subarray(e)),r=Lg(n);r&&t.push(r),e+=n.size+Ci}yh(o,e)&&(e+=Ci)}return t}function Lh(o){return o&&o.key==="PRIV"&&o.info==="com.apple.streaming.transportStreamTimestamp"}function bg(o){if(o.data.byteLength===8){const e=new Uint8Array(o.data),t=e[3]&1;let s=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return s/=45,t&&(s+=4772185884e-2),Math.round(s)}}function Mo(o){const e=vh(o);for(let t=0;t<e.length;t++){const s=e[t];if(Lh(s))return bg(s)}}let $e=(function(o){return o.audioId3="org.id3",o.dateRange="com.apple.quicktime.HLS",o.emsg="https://aomedia.org/emsg/ID3",o.misbklv="urn:misb:KLV:bin:1910.1",o})({});function ft(o="",e=9e4){return{type:o,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class Qo{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,s,i){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,s){}demux(e,t){this.cachedData&&(e=tt(this.cachedData,e),this.cachedData=null);let s=ui(e,0),i=s?s.length:0,n;const r=this._audioTrack,a=this._id3Track,c=s?Mo(s):void 0,l=e.length;for((this.basePTS===null||this.frameIndex===0&&K(c))&&(this.basePTS=wg(c,t,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),s&&s.length>0&&a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:s,type:$e.audioId3,duration:Number.POSITIVE_INFINITY});i<l;){if(this.canParse(e,i)){const h=this.appendFrame(r,e,i);h?(this.frameIndex++,this.lastPTS=h.sample.pts,i+=h.length,n=i):i=l}else Eg(e,i)?(s=ui(e,i),a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:s,type:$e.audioId3,duration:Number.POSITIVE_INFINITY}),i+=s.length,n=i):i++;if(i===l&&n!==l){const h=e.slice(n);this.cachedData?this.cachedData=tt(this.cachedData,h):this.cachedData=h}}return{audioTrack:r,videoTrack:ft(),id3Track:a,textTrack:ft()}}demuxSampleAes(e,t,s){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:ft(),id3Track:this._id3Track,textTrack:ft()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0}}const wg=(o,e,t)=>{if(K(o))return o*90;const s=t?t.baseTime*9e4/t.timescale:0;return e*9e4+s};let Ti=null;const _g=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],kg=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],Pg=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],Fg=[0,1,1,4];function Rh(o,e,t,s,i){if(t+24>e.length)return;const n=Dh(e,t);if(n&&t+n.frameLength<=e.length){const r=n.samplesPerFrame*9e4/n.sampleRate,a=s+i*r,c={unit:e.subarray(t,t+n.frameLength),pts:a,dts:a};return o.config=[],o.channelCount=n.channelCount,o.samplerate=n.sampleRate,o.samples.push(c),{sample:c,length:n.frameLength,missing:0}}}function Dh(o,e){const t=o[e+1]>>3&3,s=o[e+1]>>1&3,i=o[e+2]>>4&15,n=o[e+2]>>2&3;if(t!==1&&i!==0&&i!==15&&n!==3){const r=o[e+2]>>1&1,a=o[e+3]>>6,c=t===3?3-s:s===3?3:4,l=_g[c*14+i-1]*1e3,u=kg[(t===3?0:t===2?1:2)*3+n],d=a===3?1:2,A=Pg[t][s],f=Fg[s],g=A*8*f,m=Math.floor(A*l/u+r)*f;if(Ti===null){const I=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Ti=I?parseInt(I[1]):0}return Ti&&Ti<=87&&s===2&&l>=224e3&&a===0&&(o[e+3]=o[e+3]|128),{sampleRate:u,channelCount:d,frameLength:m,samplesPerFrame:g}}}function Oo(o,e){return o[e]===255&&(o[e+1]&224)===224&&(o[e+1]&6)!==0}function bh(o,e){return e+1<o.length&&Oo(o,e)}function Mg(o,e){return Oo(o,e)&&4<=o.length-e}function wh(o,e){if(e+1<o.length&&Oo(o,e)){const s=Dh(o,e);let i=4;s!=null&&s.frameLength&&(i=s.frameLength);const n=e+i;return n===o.length||bh(o,n)}return!1}class Qg extends Qo{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,s,i){super.resetInitSegment(e,t,s,i),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:i,inputTimeScale:9e4,dropped:0}}static probe(e,t){if(!e)return!1;const s=ui(e,0);let i=s?.length||0;if(wh(e,i))return!1;for(let n=e.length;i<n;i++)if(mg(e,i))return t.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return gg(e,t)}appendFrame(e,t,s){Sh(e,this.observer,t,s,e.manifestCodec);const i=xh(e,t,s,this.basePTS,this.frameIndex);if(i&&i.missing===0)return i}}const _h=(o,e)=>{let t=0,s=5;e+=s;const i=new Uint32Array(1),n=new Uint32Array(1),r=new Uint8Array(1);for(;s>0;){r[0]=o[e];const a=Math.min(s,8),c=8-a;n[0]=4278190080>>>24+c<<c,i[0]=(r[0]&n[0])>>c,t=t?t<<a|i[0]:i[0],e+=1,s-=a}return t};class Og extends Qo{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,s,i){super.resetInitSegment(e,t,s,i),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:i,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,s){const i=kh(e,t,s,this.basePTS,this.frameIndex);if(i!==-1)return{sample:e.samples[e.samples.length-1],length:i,missing:0}}static probe(e){if(!e)return!1;const t=ui(e,0);if(!t)return!1;const s=t.length;return e[s]===11&&e[s+1]===119&&Mo(t)!==void 0&&_h(e,s)<16}}function kh(o,e,t,s,i){if(t+8>e.length||e[t]!==11||e[t+1]!==119)return-1;const n=e[t+4]>>6;if(n>=3)return-1;const a=[48e3,44100,32e3][n],c=e[t+4]&63,h=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][c*3+n]*2;if(t+h>e.length)return-1;const u=e[t+6]>>5;let d=0;u===2?d+=2:(u&1&&u!==1&&(d+=2),u&4&&(d+=2));const A=(e[t+6]<<8|e[t+7])>>12-d&1,g=[2,1,2,3,3,4,4,5][u]+A,m=e[t+5]>>3,E=e[t+5]&7,p=new Uint8Array([n<<6|m<<1|E>>2,(E&3)<<6|u<<3|A<<2|c>>4,c<<4&224]),I=1536/a*9e4,C=s+i*I,T=e.subarray(t,t+h);return o.config=p,o.channelCount=g,o.samplerate=a,o.samples.push({unit:T,pts:C}),h}class Ng extends Qo{resetInitSegment(e,t,s,i){super.resetInitSegment(e,t,s,i),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:i,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=ui(e,0);let s=t?.length||0;if(t&&e[s]===11&&e[s+1]===119&&Mo(t)!==void 0&&_h(e,s)<=16)return!1;for(let i=e.length;s<i;s++)if(wh(e,s))return re.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return Mg(e,t)}appendFrame(e,t,s){if(this.basePTS!==null)return Rh(e,t,s,this.basePTS,this.frameIndex)}}const Ug=/\/emsg[-/]ID3/i;class Gg{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,s,i){const n=this.videoTrack=ft("video",1),r=this.audioTrack=ft("audio",1),a=this.txtTrack=ft("text",1);if(this.id3Track=ft("id3",1),this.timeOffset=0,!(e!=null&&e.byteLength))return;const c=Kc(e);if(c.video){const{id:l,timescale:h,codec:u,supplemental:d}=c.video;n.id=l,n.timescale=a.timescale=h,n.codec=u,n.supplemental=d}if(c.audio){const{id:l,timescale:h,codec:u}=c.audio;r.id=l,r.timescale=h,r.codec=u}a.id=Uc.text,n.sampleDuration=0,n.duration=r.duration=i}resetContiguity(){this.remainderData=null}static probe(e){return QA(e)}demux(e,t){this.timeOffset=t;let s=e;const i=this.videoTrack,n=this.txtTrack;if(this.config.progressive){this.remainderData&&(s=tt(this.remainderData,e));const a=$A(s);this.remainderData=a.remainder,i.samples=a.valid||new Uint8Array}else i.samples=s;const r=this.extractID3Track(i,t);return n.samples=va(t,i),{videoTrack:i,audioTrack:this.audioTrack,id3Track:r,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,s=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const i=this.extractID3Track(t,this.timeOffset);return s.samples=va(e,t),{videoTrack:t,audioTrack:ft(),id3Track:i,textTrack:ft()}}extractID3Track(e,t){const s=this.id3Track;if(e.samples.length){const i=z(e.samples,["emsg"]);i&&i.forEach(n=>{const r=YA(n);if(Ug.test(r.schemeIdUri)){const a=cl(r,t);let c=r.eventDuration===4294967295?Number.POSITIVE_INFINITY:r.eventDuration/r.timeScale;c<=.001&&(c=Number.POSITIVE_INFINITY);const l=r.payload;s.samples.push({data:l,len:l.byteLength,dts:a,pts:a,type:$e.emsg,duration:c})}else if(this.config.enableEmsgKLVMetadata&&r.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){const a=cl(r,t);s.samples.push({data:r.payload,len:r.payload.byteLength,dts:a,pts:a,type:$e.misbklv,duration:Number.POSITIVE_INFINITY})}})}return s}demuxSampleAes(e,t,s){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0}}function cl(o,e){return K(o.presentationTime)?o.presentationTime/o.timeScale:e+o.presentationTimeDelta/o.timeScale}class Hg{constructor(e,t,s){this.keyData=void 0,this.decrypter=void 0,this.keyData=s,this.decrypter=new Ro(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,Yt.cbc)}decryptAacSample(e,t,s){const i=e[t].unit;if(i.length<=16)return;const n=i.subarray(16,i.length-i.length%16),r=n.buffer.slice(n.byteOffset,n.byteOffset+n.length);this.decryptBuffer(r).then(a=>{const c=new Uint8Array(a);i.set(c,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,s)}).catch(s)}decryptAacSamples(e,t,s){for(;;t++){if(t>=e.length){s();return}if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,s),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=Math.floor((e.length-48)/160)*16+16,s=new Int8Array(t);let i=0;for(let n=32;n<e.length-16;n+=160,i+=16)s.set(e.subarray(n,n+16),i);return s}getAvcDecryptedUnit(e,t){const s=new Uint8Array(t);let i=0;for(let n=32;n<e.length-16;n+=160,i+=16)e.set(s.subarray(i,i+16),n);return e}decryptAvcSample(e,t,s,i,n){const r=Yc(n.data),a=this.getAvcEncryptedData(r);this.decryptBuffer(a.buffer).then(c=>{n.data=this.getAvcDecryptedUnit(r,c),this.decrypter.isSync()||this.decryptAvcSamples(e,t,s+1,i)}).catch(i)}decryptAvcSamples(e,t,s,i){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,s=0){if(t>=e.length){i();return}const n=e[t].units;for(;!(s>=n.length);s++){const r=n[s];if(!(r.data.length<=48||r.type!==1&&r.type!==5)&&(this.decryptAvcSample(e,t,s,i,r),!this.decrypter.isSync()))return}}}}class Ph{constructor(){this.VideoSample=null}createVideoSample(e,t,s){return{key:e,frame:!1,pts:t,dts:s,units:[],length:0}}getLastNalUnit(e){var t;let s=this.VideoSample,i;if((!s||s.units.length===0)&&(s=e[e.length-1]),(t=s)!=null&&t.units){const n=s.units;i=n[n.length-1]}return i}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(e.pts===void 0){const s=t.samples,i=s.length;if(i){const n=s[i-1];e.pts=n.pts,e.dts=n.dts}else{t.dropped++;return}}t.samples.push(e)}}parseNALu(e,t,s){const i=t.byteLength;let n=e.naluState||0;const r=n,a=[];let c=0,l,h,u,d=-1,A=0;for(n===-1&&(d=0,A=this.getNALuType(t,0),n=0,c=1);c<i;){if(l=t[c++],!n){n=l?0:1;continue}if(n===1){n=l?0:2;continue}if(!l)n=3;else if(l===1){if(h=c-n-1,d>=0){const f={data:t.subarray(d,h),type:A};a.push(f)}else{const f=this.getLastNalUnit(e.samples);f&&(r&&c<=4-r&&f.state&&(f.data=f.data.subarray(0,f.data.byteLength-r)),h>0&&(f.data=tt(f.data,t.subarray(0,h)),f.state=0))}c<i?(u=this.getNALuType(t,c),d=c,A=u,n=0):n=-1}else n=0}if(d>=0&&n>=0){const f={data:t.subarray(d,i),type:A,state:n};a.push(f)}if(a.length===0){const f=this.getLastNalUnit(e.samples);f&&(f.data=tt(f.data,t))}return e.naluState=n,a}}class si{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,s=e.byteLength-t,i=new Uint8Array(4),n=Math.min(4,t);if(n===0)throw new Error("no bytes available");i.set(e.subarray(s,s+n)),this.word=new DataView(i.buffer).getUint32(0),this.bitsAvailable=n*8,this.bytesAvailable-=n}skipBits(e){let t;e=Math.min(e,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const s=this.word>>>32-t;if(e>32&&re.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return t=e-t,t>0&&this.bitsAvailable?s<<t|this.readBits(t):s}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if((this.word&2147483648>>>e)!==0)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}class Kg extends Ph{parsePES(e,t,s,i){const n=this.parseNALu(e,s.data,i);let r=this.VideoSample,a,c=!1;s.data=null,r&&n.length&&!e.audFound&&(this.pushAccessUnit(r,e),r=this.VideoSample=this.createVideoSample(!1,s.pts,s.dts)),n.forEach(l=>{var h,u;switch(l.type){case 1:{let g=!1;a=!0;const m=l.data;if(c&&m.length>4){const E=this.readSliceType(m);(E===2||E===4||E===7||E===9)&&(g=!0)}if(g){var d;(d=r)!=null&&d.frame&&!r.key&&(this.pushAccessUnit(r,e),r=this.VideoSample=null)}r||(r=this.VideoSample=this.createVideoSample(!0,s.pts,s.dts)),r.frame=!0,r.key=g;break}case 5:a=!0,(h=r)!=null&&h.frame&&!r.key&&(this.pushAccessUnit(r,e),r=this.VideoSample=null),r||(r=this.VideoSample=this.createVideoSample(!0,s.pts,s.dts)),r.key=!0,r.frame=!0;break;case 6:{a=!0,Bo(l.data,1,s.pts,t.samples);break}case 7:{var A,f;a=!0,c=!0;const g=l.data,m=this.readSPS(g);if(!e.sps||e.width!==m.width||e.height!==m.height||((A=e.pixelRatio)==null?void 0:A[0])!==m.pixelRatio[0]||((f=e.pixelRatio)==null?void 0:f[1])!==m.pixelRatio[1]){e.width=m.width,e.height=m.height,e.pixelRatio=m.pixelRatio,e.sps=[g];const E=g.subarray(1,4);let p="avc1.";for(let I=0;I<3;I++){let C=E[I].toString(16);C.length<2&&(C="0"+C),p+=C}e.codec=p}break}case 8:a=!0,e.pps=[l.data];break;case 9:a=!0,e.audFound=!0,(u=r)!=null&&u.frame&&(this.pushAccessUnit(r,e),r=null),r||(r=this.VideoSample=this.createVideoSample(!1,s.pts,s.dts));break;case 12:a=!0;break;default:a=!1;break}r&&a&&r.units.push(l)}),i&&r&&(this.pushAccessUnit(r,e),this.VideoSample=null)}getNALuType(e,t){return e[t]&31}readSliceType(e){const t=new si(e);return t.readUByte(),t.readUEG(),t.readUEG()}skipScalingList(e,t){let s=8,i=8,n;for(let r=0;r<e;r++)i!==0&&(n=t.readEG(),i=(s+n+256)%256),s=i===0?s:i}readSPS(e){const t=new si(e);let s=0,i=0,n=0,r=0,a,c,l;const h=t.readUByte.bind(t),u=t.readBits.bind(t),d=t.readUEG.bind(t),A=t.readBoolean.bind(t),f=t.skipBits.bind(t),g=t.skipEG.bind(t),m=t.skipUEG.bind(t),E=this.skipScalingList.bind(this);h();const p=h();if(u(5),f(3),h(),m(),p===100||p===110||p===122||p===244||p===44||p===83||p===86||p===118||p===128){const x=d();if(x===3&&f(1),m(),m(),f(1),A())for(c=x!==3?8:12,l=0;l<c;l++)A()&&(l<6?E(16,t):E(64,t))}m();const I=d();if(I===0)d();else if(I===1)for(f(1),g(),g(),a=d(),l=0;l<a;l++)g();m(),f(1);const C=d(),T=d(),L=u(1);L===0&&f(1),f(1),A()&&(s=d(),i=d(),n=d(),r=d());let S=[1,1];if(A()&&A())switch(h()){case 1:S=[1,1];break;case 2:S=[12,11];break;case 3:S=[10,11];break;case 4:S=[16,11];break;case 5:S=[40,33];break;case 6:S=[24,11];break;case 7:S=[20,11];break;case 8:S=[32,11];break;case 9:S=[80,33];break;case 10:S=[18,11];break;case 11:S=[15,11];break;case 12:S=[64,33];break;case 13:S=[160,99];break;case 14:S=[4,3];break;case 15:S=[3,2];break;case 16:S=[2,1];break;case 255:{S=[h()<<8|h(),h()<<8|h()];break}}return{width:Math.ceil((C+1)*16-s*2-i*2),height:(2-L)*(T+1)*16-(L?2:4)*(n+r),pixelRatio:S}}}class $g extends Ph{constructor(...e){super(...e),this.initVPS=null}parsePES(e,t,s,i){const n=this.parseNALu(e,s.data,i);let r=this.VideoSample,a,c=!1;s.data=null,r&&n.length&&!e.audFound&&(this.pushAccessUnit(r,e),r=this.VideoSample=this.createVideoSample(!1,s.pts,s.dts)),n.forEach(l=>{var h,u;switch(l.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:r||(r=this.VideoSample=this.createVideoSample(!1,s.pts,s.dts)),r.frame=!0,a=!0;break;case 16:case 17:case 18:case 21:if(a=!0,c){var d;(d=r)!=null&&d.frame&&!r.key&&(this.pushAccessUnit(r,e),r=this.VideoSample=null)}r||(r=this.VideoSample=this.createVideoSample(!0,s.pts,s.dts)),r.key=!0,r.frame=!0;break;case 19:case 20:a=!0,(h=r)!=null&&h.frame&&!r.key&&(this.pushAccessUnit(r,e),r=this.VideoSample=null),r||(r=this.VideoSample=this.createVideoSample(!0,s.pts,s.dts)),r.key=!0,r.frame=!0;break;case 39:a=!0,Bo(l.data,2,s.pts,t.samples);break;case 32:a=!0,e.vps||(typeof e.params!="object"&&(e.params={}),e.params=oe(e.params,this.readVPS(l.data)),this.initVPS=l.data),e.vps=[l.data];break;case 33:if(a=!0,c=!0,e.vps!==void 0&&e.vps[0]!==this.initVPS&&e.sps!==void 0&&!this.matchSPS(e.sps[0],l.data)&&(this.initVPS=e.vps[0],e.sps=e.pps=void 0),!e.sps){const A=this.readSPS(l.data);e.width=A.width,e.height=A.height,e.pixelRatio=A.pixelRatio,e.codec=A.codecString,e.sps=[],typeof e.params!="object"&&(e.params={});for(const f in A.params)e.params[f]=A.params[f]}this.pushParameterSet(e.sps,l.data,e.vps),r||(r=this.VideoSample=this.createVideoSample(!0,s.pts,s.dts)),r.key=!0;break;case 34:if(a=!0,typeof e.params=="object"){if(!e.pps){e.pps=[];const A=this.readPPS(l.data);for(const f in A)e.params[f]=A[f]}this.pushParameterSet(e.pps,l.data,e.vps)}break;case 35:a=!0,e.audFound=!0,(u=r)!=null&&u.frame&&(this.pushAccessUnit(r,e),r=null),r||(r=this.VideoSample=this.createVideoSample(!1,s.pts,s.dts));break;default:a=!1;break}r&&a&&r.units.push(l)}),i&&r&&(this.pushAccessUnit(r,e),this.VideoSample=null)}pushParameterSet(e,t,s){(s&&s[0]===this.initVPS||!s&&!e.length)&&e.push(t)}getNALuType(e,t){return(e[t]&126)>>>1}ebsp2rbsp(e){const t=new Uint8Array(e.byteLength);let s=0;for(let i=0;i<e.byteLength;i++)i>=2&&e[i]===3&&e[i-1]===0&&e[i-2]===0||(t[s]=e[i],s++);return new Uint8Array(t.buffer,0,s)}pushAccessUnit(e,t){super.pushAccessUnit(e,t),this.initVPS&&(this.initVPS=null)}readVPS(e){const t=new si(e);t.readUByte(),t.readUByte(),t.readBits(4),t.skipBits(2),t.readBits(6);const s=t.readBits(3),i=t.readBoolean();return{numTemporalLayers:s+1,temporalIdNested:i}}readSPS(e){const t=new si(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.readBits(4);const s=t.readBits(3);t.readBoolean();const i=t.readBits(2),n=t.readBoolean(),r=t.readBits(5),a=t.readUByte(),c=t.readUByte(),l=t.readUByte(),h=t.readUByte(),u=t.readUByte(),d=t.readUByte(),A=t.readUByte(),f=t.readUByte(),g=t.readUByte(),m=t.readUByte(),E=t.readUByte(),p=[],I=[];for(let ie=0;ie<s;ie++)p.push(t.readBoolean()),I.push(t.readBoolean());if(s>0)for(let ie=s;ie<8;ie++)t.readBits(2);for(let ie=0;ie<s;ie++)p[ie]&&(t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte()),I[ie]&&t.readUByte();t.readUEG();const C=t.readUEG();C==3&&t.skipBits(1);const T=t.readUEG(),L=t.readUEG(),S=t.readBoolean();let x=0,v=0,B=0,R=0;S&&(x+=t.readUEG(),v+=t.readUEG(),B+=t.readUEG(),R+=t.readUEG());const D=t.readUEG(),b=t.readUEG(),w=t.readUEG(),F=t.readBoolean();for(let ie=F?0:s;ie<=s;ie++)t.skipUEG(),t.skipUEG(),t.skipUEG();if(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.readBoolean()&&t.readBoolean())for(let be=0;be<4;be++)for(let We=0;We<(be===3?2:6);We++)if(!t.readBoolean())t.readUEG();else{const it=Math.min(64,1<<4+(be<<1));be>1&&t.readEG();for(let os=0;os<it;os++)t.readEG()}t.readBoolean(),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.skipUEG(),t.skipUEG(),t.readBoolean());const U=t.readUEG();let H=0;for(let ie=0;ie<U;ie++){let be=!1;if(ie!==0&&(be=t.readBoolean()),be){ie===U&&t.readUEG(),t.readBoolean(),t.readUEG();let We=0;for(let Wt=0;Wt<=H;Wt++){const it=t.readBoolean();let os=!1;it||(os=t.readBoolean()),(it||os)&&We++}H=We}else{const We=t.readUEG(),Wt=t.readUEG();H=We+Wt;for(let it=0;it<We;it++)t.readUEG(),t.readBoolean();for(let it=0;it<Wt;it++)t.readUEG(),t.readBoolean()}}if(t.readBoolean()){const ie=t.readUEG();for(let be=0;be<ie;be++){for(let We=0;We<w+4;We++)t.readBits(1);t.readBits(1)}}let O=0,Q=1,Y=1,X=!0,j=1,ee=0;t.readBoolean(),t.readBoolean();let Te=!1;if(t.readBoolean()){if(t.readBoolean()){const jt=t.readUByte(),ea=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],gi=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];jt>0&&jt<16?(Q=ea[jt-1],Y=gi[jt-1]):jt===255&&(Q=t.readBits(16),Y=t.readBits(16))}if(t.readBoolean()&&t.readBoolean(),t.readBoolean()&&(t.readBits(3),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.readUByte(),t.readUByte())),t.readBoolean()&&(t.readUEG(),t.readUEG()),t.readBoolean(),t.readBoolean(),t.readBoolean(),Te=t.readBoolean(),Te&&(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG()),t.readBoolean()&&(j=t.readBits(32),ee=t.readBits(32),t.readBoolean()&&t.readUEG(),t.readBoolean())){const gi=t.readBoolean(),ta=t.readBoolean();let Ms=!1;(gi||ta)&&(Ms=t.readBoolean(),Ms&&(t.readUByte(),t.readBits(5),t.readBoolean(),t.readBits(5)),t.readBits(4),t.readBits(4),Ms&&t.readBits(4),t.readBits(5),t.readBits(5),t.readBits(5));for(let sa=0;sa<=s;sa++){X=t.readBoolean();const nd=X||t.readBoolean();let ia=!1;nd?t.readEG():ia=t.readBoolean();const na=ia?1:t.readUEG()+1;if(gi)for(let Qs=0;Qs<na;Qs++)t.readUEG(),t.readUEG(),Ms&&(t.readUEG(),t.readUEG()),t.skipBits(1);if(ta)for(let Qs=0;Qs<na;Qs++)t.readUEG(),t.readUEG(),Ms&&(t.readUEG(),t.readUEG()),t.skipBits(1)}}t.readBoolean()&&(t.readBoolean(),t.readBoolean(),t.readBoolean(),O=t.readUEG())}let Oe=T,qe=L;if(S){let ie=1,be=1;C===1?ie=be=2:C==2&&(ie=2),Oe=T-ie*v-ie*x,qe=L-be*R-be*B}const St=i?["A","B","C"][i]:"",Fs=a<<24|c<<16|l<<8|h;let vn=0;for(let ie=0;ie<32;ie++)vn=(vn|(Fs>>ie&1)<<31-ie)>>>0;let Ln=vn.toString(16);return r===1&&Ln==="2"&&(Ln="6"),{codecString:`hvc1.${St}${r}.${Ln}.${n?"H":"L"}${E}.B0`,params:{general_tier_flag:n,general_profile_idc:r,general_profile_space:i,general_profile_compatibility_flags:[a,c,l,h],general_constraint_indicator_flags:[u,d,A,f,g,m],general_level_idc:E,bit_depth:D+8,bit_depth_luma_minus8:D,bit_depth_chroma_minus8:b,min_spatial_segmentation_idc:O,chroma_format_idc:C,frame_rate:{fixed:X,fps:ee/j}},width:Oe,height:qe,pixelRatio:[Q,Y]}}readPPS(e){const t=new si(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.skipUEG(),t.skipUEG(),t.skipBits(2),t.skipBits(3),t.skipBits(2),t.skipUEG(),t.skipUEG(),t.skipEG(),t.skipBits(2),t.readBoolean()&&t.skipUEG(),t.skipEG(),t.skipEG(),t.skipBits(4);const i=t.readBoolean(),n=t.readBoolean();let r=1;return n&&i?r=0:n?r=3:i&&(r=2),{parallelismType:r}}matchSPS(e,t){return String.fromCharCode.apply(null,e).substr(3)===String.fromCharCode.apply(null,t).substr(3)}}const Se=188;class Ot{constructor(e,t,s,i){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=s,this.logger=i,this.videoParser=null}static probe(e,t){const s=Ot.syncOffset(e);return s>0&&t.warn(`MPEG2-TS detected but first sync word found @ offset ${s}`),s!==-1}static syncOffset(e){const t=e.length;let s=Math.min(Se*5,t-Se)+1,i=0;for(;i<s;){let n=!1,r=-1,a=0;for(let c=i;c<t;c+=Se)if(e[c]===71&&(t-c===Se||e[c+Se]===71)){if(a++,r===-1&&(r=c,r!==0&&(s=Math.min(r+Se*99,e.length-Se)+1)),n||(n=Gr(e,c)===0),n&&a>1&&(r===0&&a>2||c+Se>s))return r}else{if(a)return-1;break}i++}return-1}static createTrack(e,t){return{container:e==="video"||e==="audio"?"video/mp2t":void 0,type:e,id:Uc[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e==="audio"?t:void 0}}resetInitSegment(e,t,s,i){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=Ot.createTrack("video"),this._videoTrack.duration=i,this._audioTrack=Ot.createTrack("audio",i),this._id3Track=Ot.createTrack("id3"),this._txtTrack=Ot.createTrack("text"),this._audioTrack.segmentCodec="aac",this.videoParser=null,this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=s}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:s}=this;e&&(e.pesData=null),t&&(t.pesData=null),s&&(s.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,s=!1,i=!1){s||(this.sampleAes=null);let n;const r=this._videoTrack,a=this._audioTrack,c=this._id3Track,l=this._txtTrack;let h=r.pid,u=r.pesData,d=a.pid,A=c.pid,f=a.pesData,g=c.pesData,m=null,E=this.pmtParsed,p=this._pmtId,I=e.length;if(this.remainderData&&(e=tt(this.remainderData,e),I=e.length,this.remainderData=null),I<Se&&!i)return this.remainderData=e,{audioTrack:a,videoTrack:r,id3Track:c,textTrack:l};const C=Math.max(0,Ot.syncOffset(e));I-=(I-C)%Se,I<e.byteLength&&!i&&(this.remainderData=new Uint8Array(e.buffer,I,e.buffer.byteLength-I));let T=0;for(let S=C;S<I;S+=Se)if(e[S]===71){const x=!!(e[S+1]&64),v=Gr(e,S),B=(e[S+3]&48)>>4;let R;if(B>1){if(R=S+5+e[S+4],R===S+Se)continue}else R=S+4;switch(v){case h:x&&(u&&(n=hs(u,this.logger))&&(this.readyVideoParser(r.segmentCodec),this.videoParser!==null&&this.videoParser.parsePES(r,l,n,!1)),u={data:[],size:0}),u&&(u.data.push(e.subarray(R,S+Se)),u.size+=S+Se-R);break;case d:if(x){if(f&&(n=hs(f,this.logger)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,n);break;case"mp3":this.parseMPEGPES(a,n);break;case"ac3":this.parseAC3PES(a,n);break}f={data:[],size:0}}f&&(f.data.push(e.subarray(R,S+Se)),f.size+=S+Se-R);break;case A:x&&(g&&(n=hs(g,this.logger))&&this.parseID3PES(c,n),g={data:[],size:0}),g&&(g.data.push(e.subarray(R,S+Se)),g.size+=S+Se-R);break;case 0:x&&(R+=e[R]+1),p=this._pmtId=Vg(e,R);break;case p:{x&&(R+=e[R]+1);const D=Yg(e,R,this.typeSupported,s,this.observer,this.logger);h=D.videoPid,h>0&&(r.pid=h,r.segmentCodec=D.segmentVideoCodec),d=D.audioPid,d>0&&(a.pid=d,a.segmentCodec=D.segmentAudioCodec),A=D.id3Pid,A>0&&(c.pid=A),m!==null&&!E&&(this.logger.warn(`MPEG-TS PMT found at ${S} after unknown PID '${m}'. Backtracking to sync byte @${C} to parse all TS packets.`),m=null,S=C-188),E=this.pmtParsed=!0;break}case 17:case 8191:break;default:m=v;break}}else T++;T>0&&Hr(this.observer,new Error(`Found ${T} TS packet/s that do not start with 0x47`),void 0,this.logger),r.pesData=u,a.pesData=f,c.pesData=g;const L={audioTrack:a,videoTrack:r,id3Track:c,textTrack:l};return i&&this.extractRemainingSamples(L),L}flush(){const{remainderData:e}=this;this.remainderData=null;let t;return e?t=this.demux(e,-1,!1,!0):t={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:s,id3Track:i,textTrack:n}=e,r=s.pesData,a=t.pesData,c=i.pesData;let l;if(r&&(l=hs(r,this.logger))?(this.readyVideoParser(s.segmentCodec),this.videoParser!==null&&(this.videoParser.parsePES(s,n,l,!0),s.pesData=null)):s.pesData=r,a&&(l=hs(a,this.logger))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,l);break;case"mp3":this.parseMPEGPES(t,l);break;case"ac3":this.parseAC3PES(t,l);break}t.pesData=null}else a!=null&&a.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=a;c&&(l=hs(c,this.logger))?(this.parseID3PES(i,l),i.pesData=null):i.pesData=c}demuxSampleAes(e,t,s){const i=this.demux(e,s,!0,!this.config.progressive),n=this.sampleAes=new Hg(this.observer,this.config,t);return this.decrypt(i,n)}readyVideoParser(e){this.videoParser===null&&(e==="avc"?this.videoParser=new Kg:e==="hevc"&&(this.videoParser=new $g))}decrypt(e,t){return new Promise(s=>{const{audioTrack:i,videoTrack:n}=e;i.samples&&i.segmentCodec==="aac"?t.decryptAacSamples(i.samples,0,()=>{n.samples?t.decryptAvcSamples(n.samples,0,0,()=>{s(e)}):s(e)}):n.samples&&t.decryptAvcSamples(n.samples,0,0,()=>{s(e)})})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0}parseAACPES(e,t){let s=0;const i=this.aacOverFlow;let n=t.data;if(i){this.aacOverFlow=null;const u=i.missing,d=i.sample.unit.byteLength;if(u===-1)n=tt(i.sample.unit,n);else{const A=d-u;i.sample.unit.set(n.subarray(0,u),A),e.samples.push(i.sample),s=i.missing}}let r,a;for(r=s,a=n.length;r<a-1&&!En(n,r);r++);if(r!==s){let u;const d=r<a-1;if(d?u=`AAC PES did not start with ADTS header,offset:${r}`:u="No ADTS header found in AAC PES",Hr(this.observer,new Error(u),d,this.logger),!d)return}Sh(e,this.observer,n,r,this.audioCodec);let c;if(t.pts!==void 0)c=t.pts;else if(i){const u=Bh(e.samplerate);c=i.sample.pts+u}else{this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}let l=0,h;for(;r<a;)if(h=xh(e,n,r,c,l),r+=h.length,h.missing){this.aacOverFlow=h;break}else for(l++;r<a-1&&!En(n,r);r++);}parseMPEGPES(e,t){const s=t.data,i=s.length;let n=0,r=0;const a=t.pts;if(a===void 0){this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;r<i;)if(bh(s,r)){const c=Rh(e,s,r,a,n);if(c)r+=c.length,n++;else break}else r++}parseAC3PES(e,t){{const s=t.data,i=t.pts;if(i===void 0){this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");return}const n=s.length;let r=0,a=0,c;for(;a<n&&(c=kh(e,s,a,i,r++))>0;)a+=c}}parseID3PES(e,t){if(t.pts===void 0){this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const s=oe({},t,{type:this._videoTrack?$e.emsg:$e.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(s)}}function Gr(o,e){return((o[e+1]&31)<<8)+o[e+2]}function Vg(o,e){return(o[e+10]&31)<<8|o[e+11]}function Yg(o,e,t,s,i,n){const r={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},a=(o[e+1]&15)<<8|o[e+2],c=e+3+a-4,l=(o[e+10]&15)<<8|o[e+11];for(e+=12+l;e<c;){const h=Gr(o,e),u=(o[e+3]&15)<<8|o[e+4];switch(o[e]){case 207:if(!s){Un("ADTS AAC",n);break}case 15:r.audioPid===-1&&(r.audioPid=h);break;case 21:r.id3Pid===-1&&(r.id3Pid=h);break;case 219:if(!s){Un("H.264",n);break}case 27:r.videoPid===-1&&(r.videoPid=h);break;case 3:case 4:!t.mpeg&&!t.mp3?n.log("MPEG audio found, not supported in this browser"):r.audioPid===-1&&(r.audioPid=h,r.segmentAudioCodec="mp3");break;case 193:if(!s){Un("AC-3",n);break}case 129:t.ac3?r.audioPid===-1&&(r.audioPid=h,r.segmentAudioCodec="ac3"):n.log("AC-3 audio found, not supported in this browser");break;case 6:if(r.audioPid===-1&&u>0){let d=e+5,A=u;for(;A>2;){o[d]===106&&(t.ac3!==!0?n.log("AC-3 audio found, not supported in this browser for now"):(r.audioPid=h,r.segmentAudioCodec="ac3"));const g=o[d+1]+2;d+=g,A-=g}}break;case 194:case 135:return Hr(i,new Error("Unsupported EC-3 in M2TS found"),void 0,n),r;case 36:r.videoPid===-1&&(r.videoPid=h,r.segmentVideoCodec="hevc",n.log("HEVC in M2TS found"));break}e+=u+5}return r}function Hr(o,e,t,s){s.warn(`parsing error: ${e.message}`),o.emit(y.ERROR,y.ERROR,{type:q.MEDIA_ERROR,details:k.FRAG_PARSING_ERROR,fatal:!1,levelRetry:t,error:e,reason:e.message})}function Un(o,e){e.log(`${o} with AES-128-CBC encryption found in unencrypted stream`)}function hs(o,e){let t=0,s,i,n,r,a;const c=o.data;if(!o||o.size===0)return null;for(;c[0].length<19&&c.length>1;)c[0]=tt(c[0],c[1]),c.splice(1,1);if(s=c[0],(s[0]<<16)+(s[1]<<8)+s[2]===1){if(i=(s[4]<<8)+s[5],i&&i>o.size-6)return null;const h=s[7];h&192&&(r=(s[9]&14)*536870912+(s[10]&255)*4194304+(s[11]&254)*16384+(s[12]&255)*128+(s[13]&254)/2,h&64?(a=(s[14]&14)*536870912+(s[15]&255)*4194304+(s[16]&254)*16384+(s[17]&255)*128+(s[18]&254)/2,r-a>60*9e4&&(e.warn(`${Math.round((r-a)/9e4)}s delta between PTS and DTS, align them`),r=a)):a=r),n=s[8];let u=n+9;if(o.size<=u)return null;o.size-=u;const d=new Uint8Array(o.size);for(let A=0,f=c.length;A<f;A++){s=c[A];let g=s.byteLength;if(u)if(u>g){u-=g;continue}else s=s.subarray(u),g-=u,u=0;d.set(s,t),t+=g}return i&&(i-=n+3),{data:d,pts:r,dts:a,len:i}}return null}class qg{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const kt=Math.pow(2,32)-1;class _{static init(){_.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let e;for(e in _.types)_.types.hasOwnProperty(e)&&(_.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),s=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);_.HDLR_TYPES={video:t,audio:s};const i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),n=new Uint8Array([0,0,0,0,0,0,0,0]);_.STTS=_.STSC=_.STCO=n,_.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),_.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),_.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),_.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const r=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),c=new Uint8Array([0,0,0,1]);_.FTYP=_.box(_.types.ftyp,r,c,r,a),_.DINF=_.box(_.types.dinf,_.box(_.types.dref,i))}static box(e,...t){let s=8,i=t.length;const n=i;for(;i--;)s+=t[i].byteLength;const r=new Uint8Array(s);for(r[0]=s>>24&255,r[1]=s>>16&255,r[2]=s>>8&255,r[3]=s&255,r.set(e,4),i=0,s=8;i<n;i++)r.set(t[i],s),s+=t[i].byteLength;return r}static hdlr(e){return _.box(_.types.hdlr,_.HDLR_TYPES[e])}static mdat(e){return _.box(_.types.mdat,e)}static mdhd(e,t){t*=e;const s=Math.floor(t/(kt+1)),i=Math.floor(t%(kt+1));return _.box(_.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,s>>24,s>>16&255,s>>8&255,s&255,i>>24,i>>16&255,i>>8&255,i&255,85,196,0,0]))}static mdia(e){return _.box(_.types.mdia,_.mdhd(e.timescale||0,e.duration||0),_.hdlr(e.type),_.minf(e))}static mfhd(e){return _.box(_.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}static minf(e){return e.type==="audio"?_.box(_.types.minf,_.box(_.types.smhd,_.SMHD),_.DINF,_.stbl(e)):_.box(_.types.minf,_.box(_.types.vmhd,_.VMHD),_.DINF,_.stbl(e))}static moof(e,t,s){return _.box(_.types.moof,_.mfhd(e),_.traf(s,t))}static moov(e){let t=e.length;const s=[];for(;t--;)s[t]=_.trak(e[t]);return _.box.apply(null,[_.types.moov,_.mvhd(e[0].timescale||0,e[0].duration||0)].concat(s).concat(_.mvex(e)))}static mvex(e){let t=e.length;const s=[];for(;t--;)s[t]=_.trex(e[t]);return _.box.apply(null,[_.types.mvex,...s])}static mvhd(e,t){t*=e;const s=Math.floor(t/(kt+1)),i=Math.floor(t%(kt+1)),n=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,s>>24,s>>16&255,s>>8&255,s&255,i>>24,i>>16&255,i>>8&255,i&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return _.box(_.types.mvhd,n)}static sdtp(e){const t=e.samples||[],s=new Uint8Array(4+t.length);let i,n;for(i=0;i<t.length;i++)n=t[i].flags,s[i+4]=n.dependsOn<<4|n.isDependedOn<<2|n.hasRedundancy;return _.box(_.types.sdtp,s)}static stbl(e){return _.box(_.types.stbl,_.stsd(e),_.box(_.types.stts,_.STTS),_.box(_.types.stsc,_.STSC),_.box(_.types.stsz,_.STSZ),_.box(_.types.stco,_.STCO))}static avc1(e){let t=[],s=[],i,n,r;for(i=0;i<e.sps.length;i++)n=e.sps[i],r=n.byteLength,t.push(r>>>8&255),t.push(r&255),t=t.concat(Array.prototype.slice.call(n));for(i=0;i<e.pps.length;i++)n=e.pps[i],r=n.byteLength,s.push(r>>>8&255),s.push(r&255),s=s.concat(Array.prototype.slice.call(n));const a=_.box(_.types.avcC,new Uint8Array([1,t[3],t[4],t[5],255,224|e.sps.length].concat(t).concat([e.pps.length]).concat(s))),c=e.width,l=e.height,h=e.pixelRatio[0],u=e.pixelRatio[1];return _.box(_.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,c>>8&255,c&255,l>>8&255,l&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,_.box(_.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),_.box(_.types.pasp,new Uint8Array([h>>24,h>>16&255,h>>8&255,h&255,u>>24,u>>16&255,u>>8&255,u&255])))}static esds(e){const t=e.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...t,6,1,2])}static audioStsd(e){const t=e.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount||0,0,16,0,0,0,0,t>>8&255,t&255,0,0])}static mp4a(e){return _.box(_.types.mp4a,_.audioStsd(e),_.box(_.types.esds,_.esds(e)))}static mp3(e){return _.box(_.types[".mp3"],_.audioStsd(e))}static ac3(e){return _.box(_.types["ac-3"],_.audioStsd(e),_.box(_.types.dac3,e.config))}static stsd(e){const{segmentCodec:t}=e;if(e.type==="audio"){if(t==="aac")return _.box(_.types.stsd,_.STSD,_.mp4a(e));if(t==="ac3"&&e.config)return _.box(_.types.stsd,_.STSD,_.ac3(e));if(t==="mp3"&&e.codec==="mp3")return _.box(_.types.stsd,_.STSD,_.mp3(e))}else if(e.pps&&e.sps){if(t==="avc")return _.box(_.types.stsd,_.STSD,_.avc1(e));if(t==="hevc"&&e.vps)return _.box(_.types.stsd,_.STSD,_.hvc1(e))}else throw new Error("video track missing pps or sps");throw new Error(`unsupported ${e.type} segment codec (${t}/${e.codec})`)}static tkhd(e){const t=e.id,s=(e.duration||0)*(e.timescale||0),i=e.width||0,n=e.height||0,r=Math.floor(s/(kt+1)),a=Math.floor(s%(kt+1));return _.box(_.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,a>>24,a>>16&255,a>>8&255,a&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,i>>8&255,i&255,0,0,n>>8&255,n&255,0,0]))}static traf(e,t){const s=_.sdtp(e),i=e.id,n=Math.floor(t/(kt+1)),r=Math.floor(t%(kt+1));return _.box(_.types.traf,_.box(_.types.tfhd,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,i&255])),_.box(_.types.tfdt,new Uint8Array([1,0,0,0,n>>24,n>>16&255,n>>8&255,n&255,r>>24,r>>16&255,r>>8&255,r&255])),_.trun(e,s.length+16+20+8+16+8+8),s)}static trak(e){return e.duration=e.duration||4294967295,_.box(_.types.trak,_.tkhd(e),_.mdia(e))}static trex(e){const t=e.id;return _.box(_.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const s=e.samples||[],i=s.length,n=12+16*i,r=new Uint8Array(n);let a,c,l,h,u,d;for(t+=8+n,r.set([e.type==="video"?1:0,0,15,1,i>>>24&255,i>>>16&255,i>>>8&255,i&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255],0),a=0;a<i;a++)c=s[a],l=c.duration,h=c.size,u=c.flags,d=c.cts,r.set([l>>>24&255,l>>>16&255,l>>>8&255,l&255,h>>>24&255,h>>>16&255,h>>>8&255,h&255,u.isLeading<<2|u.dependsOn,u.isDependedOn<<6|u.hasRedundancy<<4|u.paddingValue<<1|u.isNonSync,u.degradPrio&61440,u.degradPrio&15,d>>>24&255,d>>>16&255,d>>>8&255,d&255],12+16*a);return _.box(_.types.trun,r)}static initSegment(e){_.types||_.init();const t=_.moov(e);return tt(_.FTYP,t)}static hvc1(e){const t=e.params,s=[e.vps,e.sps,e.pps],i=4,n=new Uint8Array([1,t.general_profile_space<<6|(t.general_tier_flag?32:0)|t.general_profile_idc,t.general_profile_compatibility_flags[0],t.general_profile_compatibility_flags[1],t.general_profile_compatibility_flags[2],t.general_profile_compatibility_flags[3],t.general_constraint_indicator_flags[0],t.general_constraint_indicator_flags[1],t.general_constraint_indicator_flags[2],t.general_constraint_indicator_flags[3],t.general_constraint_indicator_flags[4],t.general_constraint_indicator_flags[5],t.general_level_idc,240|t.min_spatial_segmentation_idc>>8,255&t.min_spatial_segmentation_idc,252|t.parallelismType,252|t.chroma_format_idc,248|t.bit_depth_luma_minus8,248|t.bit_depth_chroma_minus8,0,parseInt(t.frame_rate.fps),i-1|t.temporal_id_nested<<2|t.num_temporal_layers<<3|(t.frame_rate.fixed?64:0),s.length]);let r=n.length;for(let f=0;f<s.length;f+=1){r+=3;for(let g=0;g<s[f].length;g+=1)r+=2+s[f][g].length}const a=new Uint8Array(r);a.set(n,0),r=n.length;const c=s.length-1;for(let f=0;f<s.length;f+=1){a.set(new Uint8Array([32+f|(f===c?128:0),0,s[f].length]),r),r+=3;for(let g=0;g<s[f].length;g+=1)a.set(new Uint8Array([s[f][g].length>>8,s[f][g].length&255]),r),r+=2,a.set(s[f][g],r),r+=s[f][g].length}const l=_.box(_.types.hvcC,a),h=e.width,u=e.height,d=e.pixelRatio[0],A=e.pixelRatio[1];return _.box(_.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,h>>8&255,h&255,u>>8&255,u&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l,_.box(_.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),_.box(_.types.pasp,new Uint8Array([d>>24,d>>16&255,d>>8&255,d&255,A>>24,A>>16&255,A>>8&255,A&255])))}}_.types=void 0;_.HDLR_TYPES=void 0;_.STTS=void 0;_.STSC=void 0;_.STCO=void 0;_.STSZ=void 0;_.VMHD=void 0;_.SMHD=void 0;_.STSD=void 0;_.FTYP=void 0;_.DINF=void 0;const Fh=9e4;function No(o,e,t=1,s=!1){const i=o*e*t;return s?Math.round(i):i}function Wg(o,e,t=1,s=!1){return No(o,e,1/t,s)}function Os(o,e=!1){return No(o,1e3,1/Fh,e)}function jg(o,e=1){return No(o,Fh,1/e)}function hl(o){const{baseTime:e,timescale:t,trackId:s}=o;return`${e/t} (${e}/${t}) trackId: ${s}`}const Jg=10*1e3,Xg=1024,zg=1152,Zg=1536;let us=null,Gn=null;function ul(o,e,t,s){return{duration:e,size:t,cts:s,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:o?2:1,isNonSync:o?0:1}}}class Zi extends st{constructor(e,t,s,i){if(super("mp4-remuxer",i),this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextVideoTs=null,this.nextAudioTs=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=s,this.ISGenerated=!1,us===null){const r=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);us=r?parseInt(r[1]):0}if(Gn===null){const n=navigator.userAgent.match(/Safari\/(\d+)/i);Gn=n?parseInt(n[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){const t=this._initPTS;(!t||!e||e.trackId!==t.trackId||e.baseTime!==t.baseTime||e.timescale!==t.timescale)&&this.log(`Reset initPTS: ${t&&hl(t)} > ${e&&hl(e)}`),this._initPTS=this._initDTS=e}resetNextTimestamp(){this.log("reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){this.log("ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const s=e[0].pts,i=e.reduce((n,r)=>{let a=r.pts,c=a-n;return c<-4294967296&&(t=!0,a=Ke(a,s),c=a-n),c>0?n:a},s);return t&&this.debug("PTS rollover detected"),i}remux(e,t,s,i,n,r,a,c){let l,h,u,d,A,f,g=n,m=n;const E=e.pid>-1,p=t.pid>-1,I=t.samples.length,C=e.samples.length>0,T=a&&I>0||I>1;if((!E||C)&&(!p||T)||this.ISGenerated||a){if(this.ISGenerated){var S,x,v,B;const w=this.videoTrackConfig;(w&&(t.width!==w.width||t.height!==w.height||((S=t.pixelRatio)==null?void 0:S[0])!==((x=w.pixelRatio)==null?void 0:x[0])||((v=t.pixelRatio)==null?void 0:v[1])!==((B=w.pixelRatio)==null?void 0:B[1]))||!w&&T||this.nextAudioTs===null&&C)&&this.resetInitSegment()}this.ISGenerated||(u=this.generateIS(e,t,n,r));const R=this.isVideoContiguous;let D=-1,b;if(T&&(D=em(t.samples),!R&&this.config.forceKeyFrameOnDiscontinuity))if(f=!0,D>0){this.warn(`Dropped ${D} out of ${I} video samples due to a missing keyframe`);const w=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(D),t.dropped+=D,m+=(t.samples[0].pts-w)/t.inputTimeScale,b=m}else D===-1&&(this.warn(`No keyframe found out of ${I} video samples`),f=!1);if(this.ISGenerated){if(C&&T){const w=this.getVideoStartPts(t.samples),P=(Ke(e.samples[0].pts,w)-w)/t.inputTimeScale;g+=Math.max(0,P),m+=Math.max(0,-P)}if(C){if(e.samplerate||(this.warn("regenerate InitSegment as audio detected"),u=this.generateIS(e,t,n,r)),h=this.remuxAudio(e,g,this.isAudioContiguous,r,p||T||c===V.AUDIO?m:void 0),T){const w=h?h.endPTS-h.startPTS:0;t.inputTimeScale||(this.warn("regenerate InitSegment as video detected"),u=this.generateIS(e,t,n,r)),l=this.remuxVideo(t,m,R,w)}}else T&&(l=this.remuxVideo(t,m,R,0));l&&(l.firstKeyFrame=D,l.independent=D!==-1,l.firstKeyFramePTS=b)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(s.samples.length&&(A=Mh(s,n,this._initPTS,this._initDTS)),i.samples.length&&(d=Qh(i,n,this._initPTS))),{audio:h,video:l,initSegment:u,independent:f,text:d,id3:A}}computeInitPts(e,t,s,i){const n=Math.round(s*t);let r=Ke(e,n);if(r<n+t)for(this.log(`Adjusting PTS for rollover in timeline near ${(n-r)/t} ${i}`);r<n+t;)r+=8589934592;return r-n}generateIS(e,t,s,i){const n=e.samples,r=t.samples,a=this.typeSupported,c={},l=this._initPTS;let h=!l||i,u="audio/mp4",d,A,f,g=-1;if(h&&(d=A=1/0),e.config&&n.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":a.mpeg?(u="audio/mpeg",e.codec=""):a.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3";break}c.audio={id:"audio",container:u,codec:e.codec,initSegment:e.segmentCodec==="mp3"&&a.mpeg?new Uint8Array(0):_.initSegment([e]),metadata:{channelCount:e.channelCount}},h&&(g=e.id,f=e.inputTimeScale,!l||f!==l.timescale?d=A=this.computeInitPts(n[0].pts,f,s,"audio"):h=!1)}if(t.sps&&t.pps&&r.length){if(t.timescale=t.inputTimeScale,c.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:_.initSegment([t]),metadata:{width:t.width,height:t.height}},h)if(g=t.id,f=t.inputTimeScale,!l||f!==l.timescale){const m=this.getVideoStartPts(r),E=Ke(r[0].dts,m),p=this.computeInitPts(E,f,s,"video"),I=this.computeInitPts(m,f,s,"video");A=Math.min(A,p),d=Math.min(d,I)}else h=!1;this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(c).length)return this.ISGenerated=!0,h?(l&&this.warn(`Timestamps at playlist time: ${i?"":"~"}${s} ${d/f} != initPTS: ${l.baseTime/l.timescale} (${l.baseTime}/${l.timescale}) trackId: ${l.trackId}`),this.log(`Found initPTS at playlist time: ${s} offset: ${d/f} (${d}/${f}) trackId: ${g}`),this._initPTS={baseTime:d,timescale:f,trackId:g},this._initDTS={baseTime:A,timescale:f,trackId:g}):d=f=void 0,{tracks:c,initPTS:d,timescale:f,trackId:g}}remuxVideo(e,t,s,i){const n=e.inputTimeScale,r=e.samples,a=[],c=r.length,l=this._initPTS,h=l.baseTime*n/l.timescale;let u=this.nextVideoTs,d=8,A=this.videoSampleDuration,f,g,m=Number.POSITIVE_INFINITY,E=Number.NEGATIVE_INFINITY,p=!1;if(!s||u===null){const O=h+t*n,Q=r[0].pts-Ke(r[0].dts,r[0].pts);us&&u!==null&&Math.abs(O-Q-(u+h))<15e3?s=!0:u=O-Q-h}const I=u+h;for(let O=0;O<c;O++){const Q=r[O];Q.pts=Ke(Q.pts,I),Q.dts=Ke(Q.dts,I),Q.dts<r[O>0?O-1:O].dts&&(p=!0)}p&&r.sort(function(O,Q){const Y=O.dts-Q.dts,X=O.pts-Q.pts;return Y||X}),f=r[0].dts,g=r[r.length-1].dts;const C=g-f,T=C?Math.round(C/(c-1)):A||e.inputTimeScale/30;if(s){const O=f-I,Q=O>T,Y=O<-1;if((Q||Y)&&(Q?this.warn(`${(e.segmentCodec||"").toUpperCase()}: ${Os(O,!0)} ms (${O}dts) hole between fragments detected at ${t.toFixed(3)}`):this.warn(`${(e.segmentCodec||"").toUpperCase()}: ${Os(-O,!0)} ms (${O}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!Y||I>=r[0].pts||us)){f=I;const X=r[0].pts-O;if(Q)r[0].dts=f,r[0].pts=X;else{let j=!0;for(let ee=0;ee<r.length&&!(r[ee].dts>X&&j);ee++){const Te=r[ee].pts;if(r[ee].dts-=O,r[ee].pts-=O,ee<r.length-1){const pe=r[ee+1].pts,Oe=r[ee].pts,qe=pe<=Oe,St=pe<=Te;j=qe==St}}}this.log(`Video: Initial PTS/DTS adjusted: ${Os(X,!0)}/${Os(f,!0)}, delta: ${Os(O,!0)} ms`)}}f=Math.max(0,f);let L=0,S=0,x=f;for(let O=0;O<c;O++){const Q=r[O],Y=Q.units,X=Y.length;let j=0;for(let ee=0;ee<X;ee++)j+=Y[ee].data.length;S+=j,L+=X,Q.length=j,Q.dts<x?(Q.dts=x,x+=T/4|0||1):x=Q.dts,m=Math.min(Q.pts,m),E=Math.max(Q.pts,E)}g=r[c-1].dts;const v=S+4*L+8;let B;try{B=new Uint8Array(v)}catch(O){this.observer.emit(y.ERROR,y.ERROR,{type:q.MUX_ERROR,details:k.REMUX_ALLOC_ERROR,fatal:!1,error:O,bytes:v,reason:`fail allocating video mdat ${v}`});return}const R=new DataView(B.buffer);R.setUint32(0,v),B.set(_.types.mdat,4);let D=!1,b=Number.POSITIVE_INFINITY,w=Number.POSITIVE_INFINITY,F=Number.NEGATIVE_INFINITY,P=Number.NEGATIVE_INFINITY;for(let O=0;O<c;O++){const Q=r[O],Y=Q.units;let X=0;for(let Te=0,pe=Y.length;Te<pe;Te++){const Oe=Y[Te],qe=Oe.data,St=Oe.data.byteLength;R.setUint32(d,St),d+=4,B.set(qe,d),d+=St,X+=4+St}let j;if(O<c-1)A=r[O+1].dts-Q.dts,j=r[O+1].pts-Q.pts;else{const Te=this.config,pe=O>0?Q.dts-r[O-1].dts:T;if(j=O>0?Q.pts-r[O-1].pts:T,Te.stretchShortVideoTrack&&this.nextAudioTs!==null){const Oe=Math.floor(Te.maxBufferHole*n),qe=(i?m+i*n:this.nextAudioTs+h)-Q.pts;qe>Oe?(A=qe-pe,A<0?A=pe:D=!0,this.log(`It is approximately ${qe/90} ms to the next segment; using duration ${A/90} ms for the last video frame.`)):A=pe}else A=pe}const ee=Math.round(Q.pts-Q.dts);b=Math.min(b,A),F=Math.max(F,A),w=Math.min(w,j),P=Math.max(P,j),a.push(ul(Q.key,A,X,ee))}if(a.length){if(us){if(us<70){const O=a[0].flags;O.dependsOn=2,O.isNonSync=0}}else if(Gn&&P-w<F-b&&T/F<.025&&a[0].cts===0){this.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let O=f;for(let Q=0,Y=a.length;Q<Y;Q++){const X=O+a[Q].duration,j=O+a[Q].cts;if(Q<Y-1){const ee=X+a[Q+1].cts;a[Q].duration=ee-j}else a[Q].duration=Q?a[Q-1].duration:T;a[Q].cts=0,O=X}}}A=D||!A?T:A;const G=g+A;this.nextVideoTs=u=G-h,this.videoSampleDuration=A,this.isVideoContiguous=!0;const $={data1:_.moof(e.sequenceNumber++,f,oe(e,{samples:a})),data2:B,startPTS:(m-h)/n,endPTS:(E+A-h)/n,startDTS:(f-h)/n,endDTS:u/n,type:"video",hasAudio:!1,hasVideo:!0,nb:a.length,dropped:e.dropped};return e.samples=[],e.dropped=0,$}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return zg;case"ac3":return Zg;default:return Xg}}remuxAudio(e,t,s,i,n){const r=e.inputTimeScale,a=e.samplerate?e.samplerate:r,c=r/a,l=this.getSamplesPerFrame(e),h=l*c,u=this._initPTS,d=e.segmentCodec==="mp3"&&this.typeSupported.mpeg,A=[],f=n!==void 0;let g=e.samples,m=d?0:8,E=this.nextAudioTs||-1;const p=u.baseTime*r/u.timescale,I=p+t*r;if(this.isAudioContiguous=s=s||g.length&&E>0&&(i&&Math.abs(I-(E+p))<9e3||Math.abs(Ke(g[0].pts,I)-(E+p))<20*h),g.forEach(function(P){P.pts=Ke(P.pts,I)}),!s||E<0){const P=g.length;if(g=g.filter(G=>G.pts>=0),P!==g.length&&this.warn(`Removed ${g.length-P} of ${P} samples (initPTS ${p} / ${r})`),!g.length)return;n===0?E=0:i&&!f?E=Math.max(0,I-p):E=g[0].pts-p}if(e.segmentCodec==="aac"){const P=this.config.maxAudioFramesDrift;for(let G=0,U=E+p;G<g.length;G++){const H=g[G],$=H.pts,O=$-U,Q=Math.abs(1e3*O/r);if(O<=-P*h&&f)G===0&&(this.warn(`Audio frame @ ${($/r).toFixed(3)}s overlaps marker by ${Math.round(1e3*O/r)} ms.`),this.nextAudioTs=E=$-p,U=$);else if(O>=P*h&&Q<Jg&&f){let Y=Math.round(O/h);for(U=$-Y*h;U<0&&Y&&h;)Y--,U+=h;G===0&&(this.nextAudioTs=E=U-p),this.warn(`Injecting ${Y} audio frames @ ${((U-p)/r).toFixed(3)}s due to ${Math.round(1e3*O/r)} ms gap.`);for(let X=0;X<Y;X++){let j=qg.getSilentFrame(e.parsedCodec||e.manifestCodec||e.codec,e.channelCount);j||(this.log("Unable to get silent frame for given audio codec; duplicating last frame instead."),j=H.unit.subarray()),g.splice(G,0,{unit:j,pts:U}),U+=h,G++}}H.pts=U,U+=h}}let C=null,T=null,L,S=0,x=g.length;for(;x--;)S+=g[x].unit.byteLength;for(let P=0,G=g.length;P<G;P++){const U=g[P],H=U.unit;let $=U.pts;if(T!==null){const Q=A[P-1];Q.duration=Math.round(($-T)/c)}else if(s&&e.segmentCodec==="aac"&&($=E+p),C=$,S>0){S+=m;try{L=new Uint8Array(S)}catch(Q){this.observer.emit(y.ERROR,y.ERROR,{type:q.MUX_ERROR,details:k.REMUX_ALLOC_ERROR,fatal:!1,error:Q,bytes:S,reason:`fail allocating audio mdat ${S}`});return}d||(new DataView(L.buffer).setUint32(0,S),L.set(_.types.mdat,4))}else return;L.set(H,m);const O=H.byteLength;m+=O,A.push(ul(!0,l,O,0)),T=$}const v=A.length;if(!v)return;const B=A[A.length-1];E=T-p,this.nextAudioTs=E+c*B.duration;const R=d?new Uint8Array(0):_.moof(e.sequenceNumber++,C/c,oe({},e,{samples:A}));e.samples=[];const D=(C-p)/r,b=this.nextAudioTs/r,F={data1:R,data2:L,startPTS:D,endPTS:b,startDTS:D,endDTS:b,type:"audio",hasAudio:!0,hasVideo:!1,nb:v};return this.isAudioContiguous=!0,F}}function Ke(o,e){let t;if(e===null)return o;for(e<o?t=-8589934592:t=8589934592;Math.abs(o-e)>4294967296;)o+=t;return o}function em(o){for(let e=0;e<o.length;e++)if(o[e].key)return e;return-1}function Mh(o,e,t,s){const i=o.samples.length;if(!i)return;const n=o.inputTimeScale;for(let a=0;a<i;a++){const c=o.samples[a];c.pts=Ke(c.pts-t.baseTime*n/t.timescale,e*n)/n,c.dts=Ke(c.dts-s.baseTime*n/s.timescale,e*n)/n}const r=o.samples;return o.samples=[],{samples:r}}function Qh(o,e,t){const s=o.samples.length;if(!s)return;const i=o.inputTimeScale;for(let r=0;r<s;r++){const a=o.samples[r];a.pts=Ke(a.pts-t.baseTime*i/t.timescale,e*i)/i}o.samples.sort((r,a)=>r.pts-a.pts);const n=o.samples;return o.samples=[],{samples:n}}class tm extends st{constructor(e,t,s,i){super("passthrough-remuxer",i),this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.isVideoContiguous=!1}destroy(){}resetTimeStamp(e){this.lastEndTime=null;const t=this.initPTS;t&&e&&t.baseTime===e.baseTime&&t.timescale===e.timescale||(this.initPTS=e)}resetNextTimestamp(){this.isVideoContiguous=!1,this.lastEndTime=null}resetInitSegment(e,t,s,i){this.audioCodec=t,this.videoCodec=s,this.generateInitSegment(e,i),this.emitInitSegment=!0}generateInitSegment(e,t){let{audioCodec:s,videoCodec:i}=this;if(!(e!=null&&e.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const{audio:n,video:r}=this.initData=Kc(e);if(t)GA(e,t);else{const c=n||r;c!=null&&c.encrypted&&this.warn(`Init segment with encrypted track with has no key ("${c.codec}")!`)}n&&(s=dl(n,ae.AUDIO,this)),r&&(i=dl(r,ae.VIDEO,this));const a={};n&&r?a.audiovideo={container:"video/mp4",codec:s+","+i,supplemental:r.supplemental,encrypted:r.encrypted,initSegment:e,id:"main"}:n?a.audio={container:"audio/mp4",codec:s,encrypted:n.encrypted,initSegment:e,id:"audio"}:r?a.video={container:"video/mp4",codec:i,supplemental:r.supplemental,encrypted:r.encrypted,initSegment:e,id:"main"}:this.warn("initSegment does not contain moov or trak boxes."),this.initTracks=a}remux(e,t,s,i,n,r){var a,c;let{initPTS:l,lastEndTime:h}=this;const u={audio:void 0,video:void 0,text:i,id3:s,initSegment:void 0};K(h)||(h=this.lastEndTime=n||0);const d=t.samples;if(!d.length)return u;const A={initPTS:void 0,timescale:void 0,trackId:void 0};let f=this.initData;if((a=f)!=null&&a.length||(this.generateInitSegment(d),f=this.initData),!((c=f)!=null&&c.length))return this.warn("Failed to generate initSegment."),u;this.emitInitSegment&&(A.tracks=this.initTracks,this.emitInitSegment=!1);const g=KA(d,f,this),m=f.audio?g[f.audio.id]:null,E=f.video?g[f.video.id]:null,p=Si(E,1/0),I=Si(m,1/0),C=Si(E,0,!0),T=Si(m,0,!0);let L=n,S=0;const x=m&&(!E||!l&&I<p||l&&l.trackId===f.audio.id),v=x?m:E;if(v){const U=v.timescale,H=v.start-n*U,$=x?f.audio.id:f.video.id;L=v.start/U,S=x?T-I:C-p,(r||!l)&&(sm(l,L,n,S)||U!==l.timescale)&&(l&&this.warn(`Timestamps at playlist time: ${r?"":"~"}${n} ${H/U} != initPTS: ${l.baseTime/l.timescale} (${l.baseTime}/${l.timescale}) trackId: ${l.trackId}`),this.log(`Found initPTS at playlist time: ${n} offset: ${L-n} (${H}/${U}) trackId: ${$}`),l=null,A.initPTS=H,A.timescale=U,A.trackId=$)}else this.warn(`No audio or video samples found for initPTS at playlist time: ${n}`);l?(A.initPTS=l.baseTime,A.timescale=l.timescale,A.trackId=l.trackId):((!A.timescale||A.trackId===void 0||A.initPTS===void 0)&&(this.warn("Could not set initPTS"),A.initPTS=L,A.timescale=1,A.trackId=-1),this.initPTS=l={baseTime:A.initPTS,timescale:A.timescale,trackId:A.trackId});const B=L-l.baseTime/l.timescale,R=B+S;S>0?this.lastEndTime=R:(this.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const D=!!f.audio,b=!!f.video;let w="";D&&(w+="audio"),b&&(w+="video");const F=(f.audio?f.audio.encrypted:!1)||(f.video?f.video.encrypted:!1),P={data1:d,startPTS:B,startDTS:B,endPTS:R,endDTS:R,type:w,hasAudio:D,hasVideo:b,nb:1,dropped:0,encrypted:F};u.audio=D&&!b?P:void 0,u.video=b?P:void 0;const G=E?.sampleCount;if(G){const U=E.keyFrameIndex,H=U!==-1;P.nb=G,P.dropped=U===0||this.isVideoContiguous?0:H?U:G,P.independent=H,P.firstKeyFrame=U,H&&E.keyFrameStart&&(P.firstKeyFramePTS=(E.keyFrameStart-l.baseTime)/l.timescale),this.isVideoContiguous||(u.independent=H),this.isVideoContiguous||(this.isVideoContiguous=H),P.dropped&&this.warn(`fmp4 does not start with IDR: firstIDR ${U}/${G} dropped: ${P.dropped} start: ${P.firstKeyFramePTS||"NA"}`)}return u.initSegment=A,u.id3=Mh(s,n,l,l),i.samples.length&&(u.text=Qh(i,n,l)),u}}function Si(o,e,t=!1){return o?.start!==void 0?(o.start+(t?o.duration:0))/o.timescale:e}function sm(o,e,t,s){if(o===null)return!0;const i=Math.max(s,1),n=e-o.baseTime/o.timescale;return Math.abs(n-t)>i}function dl(o,e,t){const s=o.codec;return s&&s.length>4?s:e===ae.AUDIO?s==="ec-3"||s==="ac-3"||s==="alac"?s:s==="fLaC"||s==="Opus"?hn(s,!1):(t.warn(`Unhandled audio codec "${s}" in mp4 MAP`),s||"mp4a"):(t.warn(`Unhandled video codec "${s}" in mp4 MAP`),s||"avc1")}let Dt;try{Dt=self.performance.now.bind(self.performance)}catch{Dt=Date.now}const en=[{demux:Gg,remux:tm},{demux:Ot,remux:Zi},{demux:Qg,remux:Zi},{demux:Ng,remux:Zi}];en.splice(2,0,{demux:Og,remux:Zi});class Al{constructor(e,t,s,i,n,r){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=s,this.id=n,this.logger=r}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,s,i){const n=s.transmuxing;n.executeStart=Dt();let r=new Uint8Array(e);const{currentTransmuxState:a,transmuxConfig:c}=this;i&&(this.currentTransmuxState=i);const{contiguous:l,discontinuity:h,trackSwitch:u,accurateTimeOffset:d,timeOffset:A,initSegmentChange:f}=i||a,{audioCodec:g,videoCodec:m,defaultInitPts:E,duration:p,initSegmentData:I}=c,C=im(r,t);if(C&&Rs(C.method)){const x=this.getDecrypter(),v=bo(C.method);if(x.isSync()){let B=x.softwareDecrypt(r,C.key.buffer,C.iv.buffer,v);if(s.part>-1){const D=x.flush();B=D&&D.buffer}if(!B)return n.executeEnd=Dt(),Hn(s);r=new Uint8Array(B)}else return this.asyncResult=!0,this.decryptionPromise=x.webCryptoDecrypt(r,C.key.buffer,C.iv.buffer,v).then(B=>{const R=this.push(B,null,s);return this.decryptionPromise=null,R}),this.decryptionPromise}const T=this.needsProbing(h,u);if(T){const x=this.configureTransmuxer(r);if(x)return this.logger.warn(`[transmuxer] ${x.message}`),this.observer.emit(y.ERROR,y.ERROR,{type:q.MEDIA_ERROR,details:k.FRAG_PARSING_ERROR,fatal:!1,error:x,reason:x.message}),n.executeEnd=Dt(),Hn(s)}(h||u||f||T)&&this.resetInitSegment(I,g,m,p,t),(h||f||T)&&this.resetInitialTimestamp(E),l||this.resetContiguity();const L=this.transmux(r,C,A,d,s);this.asyncResult=di(L);const S=this.currentTransmuxState;return S.contiguous=!0,S.discontinuity=!1,S.trackSwitch=!1,n.executeEnd=Dt(),L}flush(e){const t=e.transmuxing;t.executeStart=Dt();const{decrypter:s,currentTransmuxState:i,decryptionPromise:n}=this;if(n)return this.asyncResult=!0,n.then(()=>this.flush(e));const r=[],{timeOffset:a}=i;if(s){const u=s.flush();u&&r.push(this.push(u.buffer,null,e))}const{demuxer:c,remuxer:l}=this;if(!c||!l){t.executeEnd=Dt();const u=[Hn(e)];return this.asyncResult?Promise.resolve(u):u}const h=c.flush(a);return di(h)?(this.asyncResult=!0,h.then(u=>(this.flushRemux(r,u,e),r))):(this.flushRemux(r,h,e),this.asyncResult?Promise.resolve(r):r)}flushRemux(e,t,s){const{audioTrack:i,videoTrack:n,id3Track:r,textTrack:a}=t,{accurateTimeOffset:c,timeOffset:l}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${s.sn}${s.part>-1?" part: "+s.part:""} of ${this.id===V.MAIN?"level":"track"} ${s.level}`);const h=this.remuxer.remux(i,n,r,a,l,c,!0,this.id);e.push({remuxResult:h,chunkMeta:s}),s.transmuxing.executeEnd=Dt()}resetInitialTimestamp(e){const{demuxer:t,remuxer:s}=this;!t||!s||(t.resetTimeStamp(e),s.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;!e||!t||(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,s,i,n){const{demuxer:r,remuxer:a}=this;!r||!a||(r.resetInitSegment(e,t,s,i),a.resetInitSegment(e,t,s,n))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,s,i,n){let r;return t&&t.method==="SAMPLE-AES"?r=this.transmuxSampleAes(e,t,s,i,n):r=this.transmuxUnencrypted(e,s,i,n),r}transmuxUnencrypted(e,t,s,i){const{audioTrack:n,videoTrack:r,id3Track:a,textTrack:c}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(n,r,a,c,t,s,!1,this.id),chunkMeta:i}}transmuxSampleAes(e,t,s,i,n){return this.demuxer.demuxSampleAes(e,t,s).then(r=>({remuxResult:this.remuxer.remux(r.audioTrack,r.videoTrack,r.id3Track,r.textTrack,s,i,!1,this.id),chunkMeta:n}))}configureTransmuxer(e){const{config:t,observer:s,typeSupported:i}=this;let n;for(let u=0,d=en.length;u<d;u++){var r;if((r=en[u].demux)!=null&&r.probe(e,this.logger)){n=en[u];break}}if(!n)return new Error("Failed to find demuxer by probing fragment data");const a=this.demuxer,c=this.remuxer,l=n.remux,h=n.demux;(!c||!(c instanceof l))&&(this.remuxer=new l(s,t,i,this.logger)),(!a||!(a instanceof h))&&(this.demuxer=new h(s,t,i,this.logger),this.probe=h.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new Ro(this.config)),e}}function im(o,e){let t=null;return o.byteLength>0&&e?.key!=null&&e.iv!==null&&e.method!=null&&(t=e),t}const Hn=o=>({remuxResult:{},chunkMeta:o});function di(o){return"then"in o&&o.then instanceof Function}class nm{constructor(e,t,s,i,n){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=s,this.duration=i,this.defaultInitPts=n||null}}class rm{constructor(e,t,s,i,n,r){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=s,this.trackSwitch=i,this.timeOffset=n,this.initSegmentChange=r}}let fl=0;class Oh{constructor(e,t,s,i){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=fl++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=c=>{const l=c.data,h=this.hls;if(!(!h||!(l!=null&&l.event)||l.instanceNo!==this.instanceNo))switch(l.event){case"init":{var u;const d=(u=this.workerContext)==null?void 0:u.objectURL;d&&self.URL.revokeObjectURL(d);break}case"transmuxComplete":{this.handleTransmuxComplete(l.data);break}case"flush":{this.onFlush(l.data);break}case"workerLog":{h.logger[l.data.logType]&&h.logger[l.data.logType](l.data.message);break}default:{l.data=l.data||{},l.data.frag=this.frag,l.data.part=this.part,l.data.id=this.id,h.trigger(l.event,l.data);break}}},this.onWorkerError=c=>{if(!this.hls)return;const l=new Error(`${c.message}  (${c.filename}:${c.lineno})`);this.hls.config.enableWorker=!1,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(y.ERROR,{type:q.OTHER_ERROR,details:k.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:l})};const n=e.config;this.hls=e,this.id=t,this.useWorker=!!n.enableWorker,this.onTransmuxComplete=s,this.onFlush=i;const r=(c,l)=>{l=l||{},l.frag=this.frag||void 0,c===y.ERROR&&(l=l,l.parent=this.id,l.part=this.part,this.error=l.error),this.hls.trigger(c,l)};this.observer=new ko,this.observer.on(y.FRAG_DECRYPTED,r),this.observer.on(y.ERROR,r);const a=Da(n.preferManagedMediaSource);if(this.useWorker&&typeof Worker<"u"){const c=this.hls.logger;if(n.workerPath||cg()){try{n.workerPath?(c.log(`loading Web Worker ${n.workerPath} for "${t}"`),this.workerContext=ug(n.workerPath)):(c.log(`injecting Web Worker for "${t}"`),this.workerContext=hg());const{worker:h}=this.workerContext;h.addEventListener("message",this.onWorkerMessage),h.addEventListener("error",this.onWorkerError),h.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:a,id:t,config:le(n)})}catch(h){c.warn(`Error setting up "${t}" Web Worker, fallback to inline`,h),this.terminateWorker(),this.error=null,this.transmuxer=new Al(this.observer,a,n,"",t,e.logger)}return}}this.transmuxer=new Al(this.observer,a,n,"",t,e.logger)}reset(){if(this.frag=null,this.part=null,this.workerContext){const e=this.instanceNo;this.instanceNo=fl++;const t=this.hls.config,s=Da(t.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:e,typeSupported:s,id:this.id,config:le(t)})}}terminateWorker(){if(this.workerContext){const{worker:e}=this.workerContext;this.workerContext=null,e.removeEventListener("message",this.onWorkerMessage),e.removeEventListener("error",this.onWorkerError),dg(this.hls.config.workerPath)}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{const t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null}push(e,t,s,i,n,r,a,c,l,h){var u,d;l.transmuxing.start=self.performance.now();const{instanceNo:A,transmuxer:f}=this,g=r?r.start:n.start,m=n.decryptdata,E=this.frag,p=!(E&&n.cc===E.cc),I=!(E&&l.level===E.level),C=E?l.sn-E.sn:-1,T=this.part?l.part-this.part.index:-1,L=C===0&&l.id>1&&l.id===E?.stats.chunkCount,S=!I&&(C===1||C===0&&(T===1||L&&T<=0)),x=self.performance.now();(I||C||n.stats.parsing.start===0)&&(n.stats.parsing.start=x),r&&(T||!S)&&(r.stats.parsing.start=x);const v=!(E&&((u=n.initSegment)==null?void 0:u.url)===((d=E.initSegment)==null?void 0:d.url)),B=new rm(p,S,c,I,g,v);if(!S||p||v){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${n.type} sn: ${l.sn}${l.part>-1?" part: "+l.part:""} ${this.id===V.MAIN?"level":"track"}: ${l.level} id: ${l.id}
        discontinuity: ${p}
        trackSwitch: ${I}
        contiguous: ${S}
        accurateTimeOffset: ${c}
        timeOffset: ${g}
        initSegmentChange: ${v}`);const R=new nm(s,i,t,a,h);this.configureTransmuxer(R)}if(this.frag=n,this.part=r,this.workerContext)this.workerContext.worker.postMessage({instanceNo:A,cmd:"demux",data:e,decryptdata:m,chunkMeta:l,state:B},e instanceof ArrayBuffer?[e]:[]);else if(f){const R=f.push(e,m,l,B);di(R)?R.then(D=>{this.handleTransmuxComplete(D)}).catch(D=>{this.transmuxerError(D,l,"transmuxer-interface push error")}):this.handleTransmuxComplete(R)}}flush(e){e.transmuxing.start=self.performance.now();const{instanceNo:t,transmuxer:s}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:t,cmd:"flush",chunkMeta:e});else if(s){const i=s.flush(e);di(i)?i.then(n=>{this.handleFlushResult(n,e)}).catch(n=>{this.transmuxerError(n,e,"transmuxer-interface flush error")}):this.handleFlushResult(i,e)}}transmuxerError(e,t,s){this.hls&&(this.error=e,this.hls.trigger(y.ERROR,{type:q.MEDIA_ERROR,details:k.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:e,err:e,reason:s}))}handleFlushResult(e,t){e.forEach(s=>{this.handleTransmuxComplete(s)}),this.onFlush(t)}configureTransmuxer(e){const{instanceNo:t,transmuxer:s}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:t,cmd:"configure",config:e}):s&&s.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}const gl=100;class om extends _o{constructor(e,t,s){super(e,t,s,"audio-stream-controller",V.AUDIO),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=!1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem()}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(y.BUFFER_RESET,this.onBufferReset,this),e.on(y.BUFFER_CREATED,this.onBufferCreated,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(y.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(y.FRAG_LOADING,this.onFragLoading,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){const{hls:e}=this;e&&(super.unregisterListeners(),e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(y.BUFFER_RESET,this.onBufferReset,this),e.off(y.BUFFER_CREATED,this.onBufferCreated,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(y.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(y.FRAG_LOADING,this.onFragLoading,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this))}onInitPtsFound(e,{frag:t,id:s,initPTS:i,timescale:n,trackId:r}){if(s===V.MAIN){const a=t.cc,c=this.fragCurrent;if(this.initPTS[a]={baseTime:i,timescale:n,trackId:r},this.log(`InitPTS for cc: ${a} found from main: ${i/n} (${i}/${n}) trackId: ${r}`),this.mainAnchor=t,this.state===M.WAITING_INIT_PTS){const l=this.waitingData;(!l&&!this.loadingParts||l&&l.frag.cc!==a)&&this.syncWithAnchor(t,l?.frag)}else!this.hls.hasEnoughToStart&&c&&c.cc!==a?(c.abortRequests(),this.syncWithAnchor(t,c)):this.state===M.IDLE&&this.tick()}}getLoadPosition(){return!this.startFragRequested&&this.nextLoadPosition>=0?this.nextLoadPosition:super.getLoadPosition()}syncWithAnchor(e,t){var s;const i=((s=this.mainFragLoading)==null?void 0:s.frag)||null;if(t&&i?.cc===t.cc)return;const n=(i||e).cc,r=this.getLevelDetails(),a=this.getLoadPosition(),c=eh(r,n,a);c&&(this.log(`Syncing with main frag at ${c.start} cc ${c.cc}`),this.startFragRequested=!1,this.nextLoadPosition=c.start,this.resetLoadingState(),this.state===M.IDLE&&this.doTickIdle())}startLoad(e,t){if(!this.levels){this.startPosition=e,this.state=M.STOPPED;return}const s=this.lastCurrentTime;this.stopLoad(),this.setInterval(gl),s>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @${s.toFixed(3)}`),e=s,this.state=M.IDLE):this.state=M.WAITING_TRACK,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}doTick(){switch(this.state){case M.IDLE:this.doTickIdle();break;case M.WAITING_TRACK:{const{levels:e,trackId:t}=this,s=e?.[t],i=s?.details;if(i&&!this.waitForLive(s)){if(this.waitForCdnTuneIn(i))break;this.state=M.WAITING_INIT_PTS}break}case M.FRAG_LOADING_WAITING_RETRY:{this.checkRetryDate();break}case M.WAITING_INIT_PTS:{const e=this.waitingData;if(e){const{frag:t,part:s,cache:i,complete:n}=e,r=this.mainAnchor;if(this.initPTS[t.cc]!==void 0){this.waitingData=null,this.state=M.FRAG_LOADING;const a=i.flush().buffer,c={frag:t,part:s,payload:a,networkDetails:null};this._handleFragmentLoadProgress(c),n&&super._handleFragmentLoadComplete(c)}else r&&r.cc!==e.frag.cc&&this.syncWithAnchor(r,e.frag)}else this.state=M.IDLE}}this.onTickEnd()}resetLoadingState(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null),super.resetLoadingState()}onTickEnd(){const{media:e}=this;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){var e;const{hls:t,levels:s,media:i,trackId:n}=this,r=t.config;if(!this.buffering||!i&&!this.primaryPrefetch&&(this.startFragRequested||!r.startFragPrefetch)||!(s!=null&&s[n]))return;const a=s[n],c=a.details;if(!c||this.waitForLive(a)||this.waitForCdnTuneIn(c)){this.state=M.WAITING_TRACK,this.startFragRequested=!1;return}const l=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&l&&(this.bufferFlushed=!1,this.afterBufferFlushed(l,ae.AUDIO,V.AUDIO));const h=this.getFwdBufferInfo(l,V.AUDIO);if(h===null)return;if(!this.switchingTrack&&this._streamEnded(h,c)){t.trigger(y.BUFFER_EOS,{type:"audio"}),this.state=M.ENDED;return}const u=h.len,d=t.maxBufferLength,A=c.fragments,f=A[0].start,g=this.getLoadPosition(),m=this.flushing?g:h.end;if(this.switchingTrack&&i){const I=g;c.PTSKnown&&I<f&&(h.end>f||h.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),i.currentTime=f+.05)}if(u>=d&&!this.switchingTrack&&m<A[A.length-1].start)return;let E=this.getNextFragment(m,c);if(E&&this.isLoopLoading(E,m)&&(E=this.getNextFragmentLoopLoading(E,c,h,V.MAIN,d)),!E){this.bufferFlushed=!0;return}let p=((e=this.mainFragLoading)==null?void 0:e.frag)||null;if(!this.audioOnly&&this.startFragRequested&&p&&ge(E)&&!E.endList&&(!c.live||!this.loadingParts&&m<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(p)===Ie.OK&&(this.mainFragLoading=p=null),p&&ge(p))){if(E.start>p.end){const C=this.fragmentTracker.getFragAtPos(m,V.MAIN);C&&C.end>p.end&&(p=C,this.mainFragLoading={frag:C,targetBufferTime:null})}if(E.start>p.end)return}this.loadFragment(E,a,m)}onMediaDetaching(e,t){this.bufferFlushed=this.flushing=!1,super.onMediaDetaching(e,t)}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(s=>new ci(s))}onAudioTrackSwitching(e,t){const s=!!t.url;this.trackId=t.id;const{fragCurrent:i}=this;i&&(i.abortRequests(),this.removeUnbufferedFrags(i.start)),this.resetLoadingState(),s?(this.switchingTrack=t,this.flushAudioIfNeeded(t),this.state!==M.STOPPED&&(this.setInterval(gl),this.state=M.IDLE,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=t,this.clearInterval())}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1}onLevelLoaded(e,t){this.mainDetails=t.details;const s=this.cachedTrackLoadedData;s&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(y.AUDIO_TRACK_LOADED,s))}onAudioTrackLoaded(e,t){var s;const{levels:i}=this,{details:n,id:r,groupId:a,track:c}=t;if(!i){this.warn(`Audio tracks reset while loading track ${r} "${c.name}" of "${a}"`);return}const l=this.mainDetails;if(!l||n.endCC>l.endCC||l.expired){this.cachedTrackLoadedData=t,this.state!==M.STOPPED&&(this.state=M.WAITING_TRACK);return}this.cachedTrackLoadedData=null,this.log(`Audio track ${r} "${c.name}" of "${a}" loaded [${n.startSN},${n.endSN}]${n.lastPartSn?`[part-${n.lastPartSn}-${n.lastPartIndex}]`:""},duration:${n.totalduration}`);const h=i[r];let u=0;if(n.live||(s=h.details)!=null&&s.live){if(this.checkLiveUpdate(n),n.deltaUpdateFailed)return;if(h.details){var d;u=this.alignPlaylists(n,h.details,(d=this.levelLastLoaded)==null?void 0:d.details)}n.alignedSliding||(Eh(n,l),n.alignedSliding||pn(n,l),u=n.fragmentStart)}h.details=n,this.levelLastLoaded=h,this.startFragRequested||this.setStartPosition(l,u),this.hls.trigger(y.AUDIO_TRACK_UPDATED,{details:n,id:r,groupId:t.groupId}),this.state===M.WAITING_TRACK&&!this.waitForCdnTuneIn(n)&&(this.state=M.IDLE),this.tick()}_handleFragmentLoadProgress(e){var t;const s=e.frag,{part:i,payload:n}=e,{config:r,trackId:a,levels:c}=this;if(!c){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${s.sn} of level ${s.level} will not be buffered`);return}const l=c[a];if(!l){this.warn("Audio track is undefined on fragment load progress");return}const h=l.details;if(!h){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(s.start);return}const u=r.defaultAudioCodec||l.audioCodec||"mp4a.40.2";let d=this.transmuxer;d||(d=this.transmuxer=new Oh(this.hls,V.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const A=this.initPTS[s.cc],f=(t=s.initSegment)==null?void 0:t.data;if(A!==void 0){const m=i?i.index:-1,E=m!==-1,p=new Do(s.level,s.sn,s.stats.chunkCount,n.byteLength,m,E);d.push(n,f,u,"",s,i,h.totalduration,!1,p,A)}else{this.log(`Unknown video PTS for cc ${s.cc}, waiting for video PTS before demuxing audio frag ${s.sn} of [${h.startSN} ,${h.endSN}],track ${a}`);const{cache:g}=this.waitingData=this.waitingData||{frag:s,part:i,cache:new Ih,complete:!1};g.push(new Uint8Array(n)),this.state!==M.STOPPED&&(this.state=M.WAITING_INIT_PTS)}}_handleFragmentLoadComplete(e){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=null}onBufferCreated(e,t){this.bufferFlushed=this.flushing=!1;const s=t.tracks.audio;s&&(this.mediaBuffer=s.buffer||null)}onFragLoading(e,t){!this.audioOnly&&t.frag.type===V.MAIN&&ge(t.frag)&&(this.mainFragLoading=t,this.state===M.IDLE&&this.tick())}onFragBuffered(e,t){const{frag:s,part:i}=t;if(s.type!==V.AUDIO){!this.audioOnly&&s.type===V.MAIN&&!s.elementaryStreams.video&&!s.elementaryStreams.audiovideo&&(this.audioOnly=!0,this.mainFragLoading=null);return}if(this.fragContextChanged(s)){this.warn(`Fragment ${s.sn}${i?" p: "+i.index:""} of level ${s.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(ge(s)){this.fragPrevious=s;const n=this.switchingTrack;n&&(this.bufferedTrack=n,this.switchingTrack=null,this.hls.trigger(y.AUDIO_TRACK_SWITCHED,ne({},n)))}this.fragBufferedComplete(s,i),this.media&&this.tick()}onError(e,t){var s;if(t.fatal){this.state=M.ERROR;return}switch(t.details){case k.FRAG_GAP:case k.FRAG_PARSING_ERROR:case k.FRAG_DECRYPT_ERROR:case k.FRAG_LOAD_ERROR:case k.FRAG_LOAD_TIMEOUT:case k.KEY_LOAD_ERROR:case k.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(V.AUDIO,t);break;case k.AUDIO_TRACK_LOAD_ERROR:case k.AUDIO_TRACK_LOAD_TIMEOUT:case k.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===M.WAITING_TRACK&&((s=t.context)==null?void 0:s.type)===Z.AUDIO_TRACK&&(this.state=M.IDLE);break;case k.BUFFER_ADD_CODEC_ERROR:case k.BUFFER_APPEND_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)||this.resetLoadingState();break;case k.BUFFER_FULL_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case k.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onBufferFlushing(e,{type:t}){t!==ae.VIDEO&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==ae.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===M.ENDED&&(this.state=M.IDLE);const s=this.mediaBuffer||this.media;s&&(this.afterBufferFlushed(s,t,V.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const s="audio",{hls:i}=this,{remuxResult:n,chunkMeta:r}=e,a=this.getCurrentContext(r);if(!a){this.resetWhenMissingContext(r);return}const{frag:c,part:l,level:h}=a,{details:u}=h,{audio:d,text:A,id3:f,initSegment:g}=n;if(this.fragContextChanged(c)||!u){this.fragmentTracker.removeFragment(c);return}if(this.state=M.PARSING,this.switchingTrack&&d&&this.completeAudioSwitch(this.switchingTrack),g!=null&&g.tracks){const m=c.initSegment||c;if(this.unhandledEncryptionError(g,c))return;this._bufferInitSegment(h,g.tracks,m,r),i.trigger(y.FRAG_PARSING_INIT_SEGMENT,{frag:m,id:s,tracks:g.tracks})}if(d){const{startPTS:m,endPTS:E,startDTS:p,endDTS:I}=d;l&&(l.elementaryStreams[ae.AUDIO]={startPTS:m,endPTS:E,startDTS:p,endDTS:I}),c.setElementaryStreamInfo(ae.AUDIO,m,E,p,I),this.bufferFragmentData(d,c,l,r)}if(f!=null&&(t=f.samples)!=null&&t.length){const m=oe({id:s,frag:c,details:u},f);i.trigger(y.FRAG_PARSING_METADATA,m)}if(A){const m=oe({id:s,frag:c,details:u},A);i.trigger(y.FRAG_PARSING_USERDATA,m)}}_bufferInitSegment(e,t,s,i){if(this.state!==M.PARSING||(t.video&&delete t.video,t.audiovideo&&delete t.audiovideo,!t.audio))return;const n=t.audio;n.id=V.AUDIO;const r=e.audioCodec;this.log(`Init audio buffer, container:${n.container}, codecs[level/parsed]=[${r}/${n.codec}]`),r&&r.split(",").length===1&&(n.levelCodec=r),this.hls.trigger(y.BUFFER_CODECS,t);const a=n.initSegment;if(a!=null&&a.byteLength){const c={type:"audio",frag:s,part:null,chunkMeta:i,parent:s.type,data:a};this.hls.trigger(y.BUFFER_APPENDING,c)}this.tickImmediate()}loadFragment(e,t,s){const i=this.fragmentTracker.getState(e);if(this.switchingTrack||i===Ie.NOT_LOADED||i===Ie.PARTIAL){var n;if(!ge(e))this._loadInitSegment(e,t);else if((n=t.details)!=null&&n.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=M.WAITING_INIT_PTS;const r=this.mainDetails;r&&r.fragmentStart!==t.details.fragmentStart&&pn(t.details,r)}else super.loadFragment(e,t,s)}else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){const{name:t,lang:s,assocLang:i,characteristics:n,audioCodec:r,channels:a}=this.bufferedTrack;ns({name:t,lang:s,assocLang:i,characteristics:n,audioCodec:r,channels:a},e,ss)||(dn(e.url,this.hls)?(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=e)}}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(y.AUDIO_TRACK_SWITCHED,ne({},e))}}class Uo extends st{constructor(e,t){super(t,e.logger),this.hls=void 0,this.canLoad=!1,this.timer=-1,this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t,s){const i=t?.renditionReports;if(i){let n=-1;for(let r=0;r<i.length;r++){const a=i[r];let c;try{c=new self.URL(a.URI,t.url).href}catch(l){this.warn(`Could not construct new URL for Rendition Report: ${l}`),c=a.URI||""}if(c===e){n=r;break}else c===e.substring(0,c.length)&&(n=r)}if(n!==-1){const r=i[n],a=parseInt(r["LAST-MSN"])||t.lastPartSn;let c=parseInt(r["LAST-PART"])||t.lastPartIndex;if(this.hls.config.lowLatencyMode){const h=Math.min(t.age-t.partTarget,t.targetduration);c>=0&&h>t.partTarget&&(c+=1)}const l=s&&ba(s);return new wa(a,c>=0?c:void 0,l)}}}loadPlaylist(e){this.clearTimer()}loadingPlaylist(e,t){this.clearTimer()}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}getUrlWithDirectives(e,t){if(t)try{return t.addDirectives(e)}catch(s){this.warn(`Could not construct new URL with HLS Delivery Directives: ${s}`)}return e}playlistLoaded(e,t,s){const{details:i,stats:n}=t,r=self.performance.now(),a=n.loading.first?Math.max(0,r-n.loading.first):0;i.advancedDateTime=Date.now()-a;const c=this.hls.config.timelineOffset;if(c!==i.appliedTimelineOffset){const h=Math.max(c||0,0);i.appliedTimelineOffset=h,i.fragments.forEach(u=>{u.setStart(u.playlistOffset+h)})}if(i.live||s!=null&&s.live){const h="levelInfo"in t?t.levelInfo:t.track;if(i.reloaded(s),s&&i.fragments.length>0){zf(s,i,this);const p=i.playlistParsingError;if(p){this.warn(p);const I=this.hls;if(!I.config.ignorePlaylistParsingErrors){var l;const{networkDetails:C}=t;I.trigger(y.ERROR,{type:q.NETWORK_ERROR,details:k.LEVEL_PARSING_ERROR,fatal:!1,url:i.url,error:p,reason:p.message,level:t.level||void 0,parent:(l=i.fragments[0])==null?void 0:l.type,networkDetails:C,stats:n});return}i.playlistParsingError=null}}i.requestScheduled===-1&&(i.requestScheduled=n.loading.start);const u=this.hls.mainForwardBufferInfo,d=u?u.end-u.len:0,A=(i.edge-d)*1e3,f=Ah(i,A);if(i.requestScheduled+f<r?i.requestScheduled=r:i.requestScheduled+=f,this.log(`live playlist ${e} ${i.advanced?"REFRESHED "+i.lastPartSn+"-"+i.lastPartIndex:i.updated?"UPDATED":"MISSED"}`),!this.canLoad||!i.live)return;let g,m,E;if(i.canBlockReload&&i.endSN&&i.advanced){const p=this.hls.config.lowLatencyMode,I=i.lastPartSn,C=i.endSN,T=i.lastPartIndex,L=T!==-1,S=I===C;L?S?(m=C+1,E=p?0:T):(m=I,E=p?T+1:i.maxPartIndex):m=C+1;const x=i.age,v=x+i.ageHeader;let B=Math.min(v-i.partTarget,i.targetduration*1.5);if(B>0){if(v>i.targetduration*3)this.log(`Playlist last advanced ${x.toFixed(2)}s ago. Omitting segment and part directives.`),m=void 0,E=void 0;else if(s!=null&&s.tuneInGoal&&v-i.partTarget>s.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${s.tuneInGoal} to: ${B} with playlist age: ${i.age}`),B=0;else{const R=Math.floor(B/i.targetduration);if(m+=R,E!==void 0){const D=Math.round(B%i.targetduration/i.partTarget);E+=D}this.log(`CDN Tune-in age: ${i.ageHeader}s last advanced ${x.toFixed(2)}s goal: ${B} skip sn ${R} to part ${E}`)}i.tuneInGoal=B}if(g=this.getDeliveryDirectives(i,t.deliveryDirectives,m,E),p||!S){i.requestScheduled=r,this.loadingPlaylist(h,g);return}}else(i.canBlockReload||i.canSkipUntil)&&(g=this.getDeliveryDirectives(i,t.deliveryDirectives,m,E));g&&m!==void 0&&i.canBlockReload&&(i.requestScheduled=n.loading.first+Math.max(f-a*2,f/2)),this.scheduleLoading(h,g,i)}else this.clearTimer()}scheduleLoading(e,t,s){const i=s||e.details;if(!i){this.loadingPlaylist(e,t);return}const n=self.performance.now(),r=i.requestScheduled;if(n>=r){this.loadingPlaylist(e,t);return}const a=r-n;this.log(`reload live playlist ${e.name||e.bitrate+"bps"} in ${Math.round(a)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(e,t),a)}getDeliveryDirectives(e,t,s,i){let n=ba(e);return t!=null&&t.skip&&e.deltaUpdateFailed&&(s=t.msn,i=t.part,n=Xi.No),new wa(s,i,n)}checkRetry(e){const t=e.details,s=An(e),i=e.errorAction,{action:n,retryCount:r=0,retryConfig:a}=i||{},c=!!i&&!!a&&(n===Le.RetryRequest||!i.resolved&&n===Le.SendAlternateToPenaltyBox);if(c){var l;if(r>=a.maxNumRetry)return!1;if(s&&(l=e.context)!=null&&l.deliveryDirectives)this.warn(`Retrying playlist loading ${r+1}/${a.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const h=Lo(a,r);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),h),this.warn(`Retrying playlist loading ${r+1}/${a.maxNumRetry} after "${t}" in ${h}ms`)}e.levelRetry=!0,i.resolved=!0}return c}}function Nh(o,e){if(o.length!==e.length)return!1;for(let t=0;t<o.length;t++)if(!Ai(o[t].attrs,e[t].attrs))return!1;return!0}function Ai(o,e,t){const s=o["STABLE-RENDITION-ID"];return s&&!t?s===e["STABLE-RENDITION-ID"]:!(t||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(i=>o[i]!==e[i])}function Kr(o,e){return e.label.toLowerCase()===o.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(o.lang||"").toLowerCase())}class am extends Uo{constructor(e){super(e,"audio-track-controller"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.LEVEL_LOADING,this.onLevelLoading,this),e.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.LEVEL_LOADING,this.onLevelLoading,this),e.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(y.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(y.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:s,groupId:i,details:n}=t,r=this.tracksInGroup[s];if(!r||r.groupId!==i){this.warn(`Audio track with id:${s} and group:${i} not found in active group ${r?.groupId}`);return}const a=r.details;r.details=t.details,this.log(`Audio track ${s} "${r.name}" lang:${r.lang} group:${i} loaded [${n.startSN}-${n.endSN}]`),s===this.trackId&&this.playlistLoaded(s,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const s=t.audioGroups||null,i=this.groupIds;let n=this.currentTrack;if(!s||i?.length!==s?.length||s!=null&&s.some(a=>i?.indexOf(a)===-1)){this.groupIds=s,this.trackId=-1,this.currentTrack=null;const a=this.tracks.filter(d=>!s||s.indexOf(d.groupId)!==-1);if(a.length)this.selectDefaultTrack&&!a.some(d=>d.default)&&(this.selectDefaultTrack=!1),a.forEach((d,A)=>{d.id=A});else if(!n&&!this.tracksInGroup.length)return;this.tracksInGroup=a;const c=this.hls.config.audioPreference;if(!n&&c){const d=mt(c,a,ss);if(d>-1)n=a[d];else{const A=mt(c,this.tracks);n=this.tracks[A]}}let l=this.findTrackId(n);l===-1&&n&&(l=this.findTrackId(null));const h={audioTracks:a};this.log(`Updating audio tracks, ${a.length} track(s) found in group(s): ${s?.join(",")}`),this.hls.trigger(y.AUDIO_TRACKS_UPDATED,h);const u=this.trackId;if(l!==-1&&u===-1)this.setAudioTrack(l);else if(a.length&&u===-1){var r;const d=new Error(`No audio track selected for current audio group-ID(s): ${(r=this.groupIds)==null?void 0:r.join(",")} track count: ${a.length}`);this.warn(d.message),this.hls.trigger(y.ERROR,{type:q.MEDIA_ERROR,details:k.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:d})}}}onError(e,t){t.fatal||!t.context||t.context.type===Z.AUDIO_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const s=this.allAudioTracks;if(this.selectDefaultTrack=!1,s.length){const i=this.currentTrack;if(i&&ns(e,i,ss))return i;const n=mt(e,this.tracksInGroup,ss);if(n>-1){const r=this.tracksInGroup[n];return this.setAudioTrack(n),r}else if(i){let r=t.loadLevel;r===-1&&(r=t.firstAutoLevel);const a=If(e,t.levels,s,r,ss);if(a===-1)return null;t.nextLoadLevel=a}if(e.channels||e.audioCodec){const r=mt(e,s);if(r>-1)return s[r]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length){this.warn(`Invalid audio track id: ${e}`);return}this.selectDefaultTrack=!1;const s=this.currentTrack,i=t[e],n=i.details&&!i.details.live;if(e===this.trackId&&i===s&&n||(this.log(`Switching to audio-track ${e} "${i.name}" lang:${i.lang} group:${i.groupId} channels:${i.channels}`),this.trackId=e,this.currentTrack=i,this.hls.trigger(y.AUDIO_TRACK_SWITCHING,ne({},i)),n))return;const r=this.switchParams(i.url,s?.details,i.details);this.loadPlaylist(r)}findTrackId(e){const t=this.tracksInGroup;for(let s=0;s<t.length;s++){const i=t[s];if(!(this.selectDefaultTrack&&!i.default)&&(!e||ns(e,i,ss)))return s}if(e){const{name:s,lang:i,assocLang:n,characteristics:r,audioCodec:a,channels:c}=e;for(let l=0;l<t.length;l++){const h=t[l];if(ns({name:s,lang:i,assocLang:n,characteristics:r,audioCodec:a,channels:c},h,ss))return l}for(let l=0;l<t.length;l++){const h=t[l];if(Ai(e.attrs,h.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return l}for(let l=0;l<t.length;l++){const h=t[l];if(Ai(e.attrs,h.attrs,["LANGUAGE"]))return l}}return-1}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;this.shouldLoadPlaylist(t)&&dn(t.url,this.hls)&&this.scheduleLoading(t,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const s=e.id,i=e.groupId,n=this.getUrlWithDirectives(e.url,t),r=e.details,a=r?.age;this.log(`Loading audio-track ${s} "${e.name}" lang:${e.lang} group:${i}${t?.msn!==void 0?" at sn "+t.msn+" part "+t.part:""}${a&&r.live?" age "+a.toFixed(1)+(r.type&&" "+r.type||""):""} ${n}`),this.hls.trigger(y.AUDIO_TRACK_LOADING,{url:n,id:s,groupId:i,deliveryDirectives:t||null,track:e})}}class lm{constructor(e){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=e}destroy(){this.tracks=this.queues=null}append(e,t,s){if(this.queues===null||this.tracks===null)return;const i=this.queues[t];i.push(e),i.length===1&&!s&&this.executeNext(t)}appendBlocker(e){return new Promise(t=>{const s={label:"async-blocker",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.append(s,e)})}prependBlocker(e){return new Promise(t=>{if(this.queues){const s={label:"async-blocker-prepend",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.queues[e].unshift(s)}})}removeBlockers(){this.queues!==null&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(e=>{var t;const s=(t=e[0])==null?void 0:t.label;(s==="async-blocker"||s==="async-blocker-prepend")&&(e[0].execute(),e.splice(0,1))})}unblockAudio(e){if(this.queues===null)return;this.queues.audio[0]===e&&this.shiftAndExecuteNext("audio")}executeNext(e){if(this.queues===null||this.tracks===null)return;const t=this.queues[e];if(t.length){const i=t[0];try{i.execute()}catch(n){var s;if(i.onError(n),this.queues===null||this.tracks===null)return;const r=(s=this.tracks[e])==null?void 0:s.buffer;r!=null&&r.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues!==null&&(this.queues[e].shift(),this.executeNext(e))}current(e){var t;return((t=this.queues)==null?void 0:t[e][0])||null}toString(){const{queues:e,tracks:t}=this;return e===null||t===null?"<destroyed>":`
${this.list("video")}
${this.list("audio")}
${this.list("audiovideo")}}`}list(e){var t,s;return(t=this.queues)!=null&&t[e]||(s=this.tracks)!=null&&s[e]?`${e}: (${this.listSbInfo(e)}) ${this.listOps(e)}`:""}listSbInfo(e){var t;const s=(t=this.tracks)==null?void 0:t[e],i=s?.buffer;return i?`SourceBuffer${i.updating?" updating":""}${s.ended?" ended":""}${s.ending?" ending":""}`:"none"}listOps(e){var t;return((t=this.queues)==null?void 0:t[e].map(s=>s.label).join(", "))||""}}const ml=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,Uh="HlsJsTrackRemovedError";class cm extends Error{constructor(e){super(e),this.name=Uh}}class hm extends st{constructor(e,t){super("buffer-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=s=>{var i;this.hls&&((i=this.mediaSource)==null?void 0:i.readyState)==="open"&&this.hls.pauseBuffering()},this._onStartStreaming=s=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=s=>{const{media:i,mediaSource:n}=this;s&&this.log("Media source opened"),!(!i||!n)&&(n.removeEventListener("sourceopen",this._onMediaSourceOpen),i.removeEventListener("emptied",this._onMediaEmptied),this.updateDuration(),this.hls.trigger(y.MEDIA_ATTACHED,{media:i,mediaSource:n}),this.mediaSource!==null&&this.checkPendingTracks())},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:s,_objectUrl:i}=this;s!==i&&this.error(`Media element src was set while attaching MediaSource (${i} > ${s})`)},this.hls=e,this.fragmentTracker=t,this.appendSource=wA(Vt(e.config.preferManagedMediaSource)),this.initTracks(),this.registerListeners()}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null}registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.BUFFER_RESET,this.onBufferReset,this),e.on(y.BUFFER_APPENDING,this.onBufferAppending,this),e.on(y.BUFFER_CODECS,this.onBufferCodecs,this),e.on(y.BUFFER_EOS,this.onBufferEos,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(y.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(y.FRAG_PARSED,this.onFragParsed,this),e.on(y.FRAG_CHANGED,this.onFragChanged,this),e.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.BUFFER_RESET,this.onBufferReset,this),e.off(y.BUFFER_APPENDING,this.onBufferAppending,this),e.off(y.BUFFER_CODECS,this.onBufferCodecs,this),e.off(y.BUFFER_EOS,this.onBufferEos,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(y.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(y.FRAG_PARSED,this.onFragParsed,this),e.off(y.FRAG_CHANGED,this.onFragChanged,this),e.off(y.ERROR,this.onError,this)}transferMedia(){const{media:e,mediaSource:t}=this;if(!e)return null;const s={};if(this.operationQueue){const n=this.isUpdating();n||this.operationQueue.removeBlockers();const r=this.isQueued();(n||r)&&this.warn(`Transfering MediaSource with${r?" operations in queue":""}${n?" updating SourceBuffer(s)":""} ${this.operationQueue}`),this.operationQueue.destroy()}const i=this.transferData;return!this.sourceBufferCount&&i&&i.mediaSource===t?oe(s,i.tracks):this.sourceBuffers.forEach(n=>{const[r]=n;r&&(s[r]=oe({},this.tracks[r]),this.removeBuffer(r)),n[0]=n[1]=null}),{media:e,mediaSource:t,tracks:s}}initTracks(){const e={};this.sourceBuffers=[[null,null],[null,null]],this.tracks=e,this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){var s;let i=2;(t.audio&&!t.video||!t.altAudio)&&(i=1),this.bufferCodecEventsTotal=i,this.log(`${i} bufferCodec event(s) expected.`),(s=this.transferData)!=null&&s.mediaSource&&this.sourceBufferCount&&i&&this.bufferCreated()}onMediaAttaching(e,t){const s=this.media=t.media;this.transferData=this.overrides=void 0;const i=Vt(this.appendSource);if(i){const n=!!t.mediaSource;(n||t.overrides)&&(this.transferData=t,this.overrides=t.overrides);const r=this.mediaSource=t.mediaSource||new i;if(this.assignMediaSource(r),n)this._objectUrl=s.src,this.attachTransferred();else{const a=this._objectUrl=self.URL.createObjectURL(r);if(this.appendSource)try{s.removeAttribute("src");const c=self.ManagedMediaSource;s.disableRemotePlayback=s.disableRemotePlayback||c&&r instanceof c,pl(s),um(s,a),s.load()}catch{s.src=a}else s.src=a}s.addEventListener("emptied",this._onMediaEmptied)}}assignMediaSource(e){var t,s;this.log(`${((t=this.transferData)==null?void 0:t.mediaSource)===e?"transferred":"created"} media source: ${(s=e.constructor)==null?void 0:s.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming))}attachTransferred(){const e=this.media,t=this.transferData;if(!t||!e)return;const s=this.tracks,i=t.tracks,n=i?Object.keys(i):null,r=n?n.length:0,a=()=>{Promise.resolve().then(()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen()})};if(i&&n&&r){if(!this.tracksReady){this.hls.config.startFragPrefetch=!0,this.log("attachTransferred: waiting for SourceBuffer track info");return}if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})
required tracks: ${le(s,(c,l)=>c==="initSegment"?void 0:l)};
transfer tracks: ${le(i,(c,l)=>c==="initSegment"?void 0:l)}}`),!Mc(i,s)){t.mediaSource=null,t.tracks=void 0;const c=e.currentTime,l=this.details,h=Math.max(c,l?.fragments[0].start||0);if(h-c>1){this.log(`attachTransferred: waiting for playback to reach new tracks start time ${c} -> ${h}`);return}this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(i)}"->"${Object.keys(s)}") start time: ${h} currentTime: ${c}`),this.onMediaDetaching(y.MEDIA_DETACHING,{}),this.onMediaAttaching(y.MEDIA_ATTACHING,t),e.currentTime=h;return}this.transferData=void 0,n.forEach(c=>{const l=c,h=i[l];if(h){const u=h.buffer;if(u){const d=this.fragmentTracker,A=h.id;if(d.hasFragments(A)||d.hasParts(A)){const m=J.getBuffered(u);d.detectEvictedFragments(l,m,A,null,!0)}const f=Kn(l),g=[l,u];this.sourceBuffers[f]=g,u.updating&&this.operationQueue&&this.operationQueue.prependBlocker(l),this.trackSourceBuffer(l,h)}}}),a(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),a()}get mediaSourceOpenOrEnded(){var e;const t=(e=this.mediaSource)==null?void 0:e.readyState;return t==="open"||t==="ended"}onMediaDetaching(e,t){const s=!!t.transferMedia;this.transferData=this.overrides=void 0;const{media:i,mediaSource:n,_objectUrl:r}=this;if(n){if(this.log(`media source ${s?"transferring":"detaching"}`),s)this.sourceBuffers.forEach(([a])=>{a&&this.removeBuffer(a)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){const a=n.readyState==="open";try{const c=n.sourceBuffers;for(let l=c.length;l--;)a&&c[l].abort(),n.removeSourceBuffer(c[l]);a&&n.endOfStream()}catch(c){this.warn(`onMediaDetaching: ${c.message} while calling endOfStream`)}}this.sourceBufferCount&&this.onBufferReset()}n.removeEventListener("sourceopen",this._onMediaSourceOpen),n.removeEventListener("sourceended",this._onMediaSourceEnded),n.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(n.removeEventListener("startstreaming",this._onStartStreaming),n.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}i&&(i.removeEventListener("emptied",this._onMediaEmptied),s||(r&&self.URL.revokeObjectURL(r),this.mediaSrc===r?(i.removeAttribute("src"),this.appendSource&&pl(i),i.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(y.MEDIA_DETACHED,t)}onBufferReset(){this.sourceBuffers.forEach(([e])=>{e&&this.resetBuffer(e)}),this.initTracks()}resetBuffer(e){var t;const s=(t=this.tracks[e])==null?void 0:t.buffer;if(this.removeBuffer(e),s)try{var i;(i=this.mediaSource)!=null&&i.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(s)}catch(n){this.warn(`onBufferReset ${e}`,n)}delete this.tracks[e]}removeBuffer(e){this.removeBufferListeners(e),this.sourceBuffers[Kn(e)]=[null,null];const t=this.tracks[e];t&&(t.buffer=void 0)}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new lm(this.tracks)}onBufferCodecs(e,t){var s;const i=this.tracks,n=Object.keys(t);this.log(`BUFFER_CODECS: "${n}" (current SB count ${this.sourceBufferCount})`);const r="audiovideo"in t&&(i.audio||i.video)||i.audiovideo&&("audio"in t||"video"in t),a=!r&&this.sourceBufferCount&&this.media&&n.some(c=>!i[c]);if(r||a){this.warn(`Unsupported transition between "${Object.keys(i)}" and "${n}" SourceBuffers`);return}n.forEach(c=>{var l,h;const u=t[c],{id:d,codec:A,levelCodec:f,container:g,metadata:m,supplemental:E}=u;let p=i[c];const I=(l=this.transferData)==null||(l=l.tracks)==null?void 0:l[c],C=I!=null&&I.buffer?I:p,T=C?.pendingCodec||C?.codec,L=C?.levelCodec;p||(p=i[c]={buffer:void 0,listeners:[],codec:A,supplemental:E,container:g,levelCodec:f,metadata:m,id:d});const S=Ji(T,L),x=S?.replace(ml,"$1");let v=Ji(A,f);const B=(h=v)==null?void 0:h.replace(ml,"$1");v&&S&&x!==B&&(c.slice(0,5)==="audio"&&(v=hn(v,this.appendSource)),this.log(`switching codec ${T} to ${v}`),v!==(p.pendingCodec||p.codec)&&(p.pendingCodec=v),p.container=g,this.appendChangeType(c,g,v))}),(this.tracksReady||this.sourceBufferCount)&&(t.tracks=this.sourceBufferTracks),!this.sourceBufferCount&&(this.bufferCodecEventsTotal>1&&!this.tracks.video&&!t.video&&((s=t.audio)==null?void 0:s.id)==="main"&&(this.log("Main audio-only"),this.bufferCodecEventsTotal=1),this.mediaSourceOpenOrEnded&&this.checkPendingTracks())}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((e,t)=>{const s=this.tracks[t];return e[t]={id:s.id,container:s.container,codec:s.codec,levelCodec:s.levelCodec},e},{})}appendChangeType(e,t,s){const i=`${t};codecs=${s}`,n={label:`change-type=${i}`,execute:()=>{const r=this.tracks[e];if(r){const a=r.buffer;a!=null&&a.changeType&&(this.log(`changing ${e} sourceBuffer type to ${i}`),a.changeType(i),r.codec=s,r.container=t)}this.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:r=>{this.warn(`Failed to change ${e} SourceBuffer type`,r)}};this.append(n,e,this.isPending(this.tracks[e]))}blockAudio(e){var t;const s=e.start,i=s+e.duration*.05;if(((t=this.fragmentTracker.getAppendedFrag(s,V.MAIN))==null?void 0:t.gap)===!0)return;const r={label:"block-audio",execute:()=>{var a;const c=this.tracks.video;(this.lastVideoAppendEnd>i||c!=null&&c.buffer&&J.isBuffered(c.buffer,i)||((a=this.fragmentTracker.getAppendedFrag(i,V.MAIN))==null?void 0:a.gap)===!0)&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext("audio"))},onStart:()=>{},onComplete:()=>{},onError:a=>{this.warn("Error executing block-audio operation",a)}};this.blockedAudioAppend={op:r,frag:e},this.append(r,"audio",!0)}unblockAudio(){const{blockedAudioAppend:e,operationQueue:t}=this;e&&t&&(this.blockedAudioAppend=null,t.unblockAudio(e.op))}onBufferAppending(e,t){const{tracks:s}=this,{data:i,type:n,parent:r,frag:a,part:c,chunkMeta:l,offset:h}=t,u=l.buffering[n],{sn:d,cc:A}=a,f=self.performance.now();u.start=f;const g=a.stats.buffering,m=c?c.stats.buffering:null;g.start===0&&(g.start=f),m&&m.start===0&&(m.start=f);const E=s.audio;let p=!1;n==="audio"&&E?.container==="audio/mpeg"&&(p=!this.lastMpegAudioChunk||l.id===1||this.lastMpegAudioChunk.sn!==l.sn,this.lastMpegAudioChunk=l);const I=s.video,C=I?.buffer;if(C&&d!=="initSegment"){const S=c||a,x=this.blockedAudioAppend;if(n==="audio"&&r!=="main"&&!this.blockedAudioAppend&&!(I.ending||I.ended)){const B=S.start+S.duration*.05,R=C.buffered,D=this.currentOp("video");!R.length&&!D?this.blockAudio(S):!D&&!J.isBuffered(C,B)&&this.lastVideoAppendEnd<B&&this.blockAudio(S)}else if(n==="video"){const v=S.end;if(x){const B=x.frag.start;(v>B||v<this.lastVideoAppendEnd||J.isBuffered(C,B))&&this.unblockAudio()}this.lastVideoAppendEnd=v}}const T=(c||a).start,L={label:`append-${n}`,execute:()=>{var S;u.executeStart=self.performance.now();const x=(S=this.tracks[n])==null?void 0:S.buffer;x&&(p?this.updateTimestampOffset(x,T,.1,n,d,A):h!==void 0&&K(h)&&this.updateTimestampOffset(x,h,1e-6,n,d,A)),this.appendExecutor(i,n)},onStart:()=>{},onComplete:()=>{const S=self.performance.now();u.executeEnd=u.end=S,g.first===0&&(g.first=S),m&&m.first===0&&(m.first=S);const x={};this.sourceBuffers.forEach(([v,B])=>{v&&(x[v]=J.getBuffered(B))}),this.appendErrors[n]=0,n==="audio"||n==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(y.BUFFER_APPENDED,{type:n,frag:a,part:c,chunkMeta:l,parent:a.type,timeRanges:x})},onError:S=>{var x;const v={type:q.MEDIA_ERROR,parent:a.type,details:k.BUFFER_APPEND_ERROR,sourceBufferName:n,frag:a,part:c,chunkMeta:l,error:S,err:S,fatal:!1},B=(x=this.media)==null?void 0:x.error;if(S.code===DOMException.QUOTA_EXCEEDED_ERR||S.name=="QuotaExceededError"||"quota"in S)v.details=k.BUFFER_FULL_ERROR;else if(S.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!B)v.errorAction=Ls(!0);else if(S.name===Uh&&this.sourceBufferCount===0)v.errorAction=Ls(!0);else{const R=++this.appendErrors[n];this.warn(`Failed ${R}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${n}" sourceBuffer (${B||"no media error"})`),(R>=this.hls.config.appendErrorMaxRetry||B)&&(v.fatal=!0)}this.hls.trigger(y.ERROR,v)}};this.log(`queuing "${n}" append sn: ${d}${c?" p: "+c.index:""} of ${a.type===V.MAIN?"level":"track"} ${a.level} cc: ${A}`),this.append(L,n,this.isPending(this.tracks[n]))}getFlushOp(e,t,s){return this.log(`queuing "${e}" remove ${t}-${s}`),{label:"remove",execute:()=>{this.removeExecutor(e,t,s)},onStart:()=>{},onComplete:()=>{this.hls.trigger(y.BUFFER_FLUSHED,{type:e})},onError:i=>{this.warn(`Failed to remove ${t}-${s} from "${e}" SourceBuffer`,i)}}}onBufferFlushing(e,t){const{type:s,startOffset:i,endOffset:n}=t;s?this.append(this.getFlushOp(s,i,n),s):this.sourceBuffers.forEach(([r])=>{r&&this.append(this.getFlushOp(r,i,n),r)})}onFragParsed(e,t){const{frag:s,part:i}=t,n=[],r=i?i.elementaryStreams:s.elementaryStreams;r[ae.AUDIOVIDEO]?n.push("audiovideo"):(r[ae.AUDIO]&&n.push("audio"),r[ae.VIDEO]&&n.push("video"));const a=()=>{const c=self.performance.now();s.stats.buffering.end=c,i&&(i.stats.buffering.end=c);const l=i?i.stats:s.stats;this.hls.trigger(y.FRAG_BUFFERED,{frag:s,part:i,stats:l,id:s.type})};n.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${s.type} level: ${s.level} sn: ${s.sn}`),this.blockBuffers(a,n).catch(c=>{this.warn(`Fragment buffered callback ${c}`),this.stepOperationQueue(this.sourceBufferTypes)})}onFragChanged(e,t){this.trimBuffers()}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{if(e){const t=this.tracks[e];if(t)return!t.ended||t.ending}return!1})}onBufferEos(e,t){var s;this.sourceBuffers.forEach(([r])=>{if(r){const a=this.tracks[r];(!t.type||t.type===r)&&(a.ending=!0,a.ended||(a.ended=!0,this.log(`${r} buffer reached EOS`)))}});const i=((s=this.overrides)==null?void 0:s.endOfStream)!==!1;this.sourceBufferCount>0&&!this.sourceBuffers.some(([r])=>{var a;return r&&!((a=this.tracks[r])!=null&&a.ended)})?i?(this.log("Queueing EOS"),this.blockUntilOpen(()=>{this.tracksEnded();const{mediaSource:r}=this;if(!r||r.readyState!=="open"){r&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${r.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),r.endOfStream(),this.hls.trigger(y.BUFFERED_TO_END,void 0)})):(this.tracksEnded(),this.hls.trigger(y.BUFFERED_TO_END,void 0)):t.type==="video"&&this.unblockAudio()}tracksEnded(){this.sourceBuffers.forEach(([e])=>{if(e!==null){const t=this.tracks[e];t&&(t.ending=!1)}})}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.updateDuration())}updateDuration(){this.blockUntilOpen(()=>{const e=this.getDurationAndRange();e&&this.updateMediaSource(e)})}onError(e,t){if(t.details===k.BUFFER_APPEND_ERROR&&t.frag){var s;const i=(s=t.errorAction)==null?void 0:s.nextAutoLevel;K(i)&&i!==t.frag.level&&this.resetAppendErrors()}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0}}trimBuffers(){const{hls:e,details:t,media:s}=this;if(!s||t===null||!this.sourceBufferCount)return;const i=e.config,n=s.currentTime,r=t.levelTargetDuration,a=t.live&&i.liveBackBufferLength!==null?i.liveBackBufferLength:i.backBufferLength;if(K(a)&&a>=0){const l=Math.max(a,r),h=Math.floor(n/r)*r-l;this.flushBackBuffer(n,r,h)}const c=i.frontBufferFlushThreshold;if(K(c)&&c>0){const l=Math.max(i.maxBufferLength,c),h=Math.max(l,r),u=Math.floor(n/r)*r+h;this.flushFrontBuffer(n,r,u)}}flushBackBuffer(e,t,s){this.sourceBuffers.forEach(([i,n])=>{if(n){const a=J.getBuffered(n);if(a.length>0&&s>a.start(0)){var r;this.hls.trigger(y.BACK_BUFFER_REACHED,{bufferEnd:s});const c=this.tracks[i];if((r=this.details)!=null&&r.live)this.hls.trigger(y.LIVE_BACK_BUFFER_REACHED,{bufferEnd:s});else if(c!=null&&c.ended){this.log(`Cannot flush ${i} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(y.BUFFER_FLUSHING,{startOffset:0,endOffset:s,type:i})}}})}flushFrontBuffer(e,t,s){this.sourceBuffers.forEach(([i,n])=>{if(n){const r=J.getBuffered(n),a=r.length;if(a<2)return;const c=r.start(a-1),l=r.end(a-1);if(s>c||e>=c&&e<=l)return;this.hls.trigger(y.BUFFER_FLUSHING,{startOffset:c,endOffset:1/0,type:i})}})}getDurationAndRange(){var e;const{details:t,mediaSource:s}=this;if(!t||!this.media||s?.readyState!=="open")return null;const i=t.edge;if(t.live&&this.hls.config.liveDurationInfinity){if(t.fragments.length&&s.setLiveSeekableRange){const l=Math.max(0,t.fragmentStart),h=Math.max(l,i);return{duration:1/0,start:l,end:h}}return{duration:1/0}}const n=(e=this.overrides)==null?void 0:e.duration;if(n)return K(n)?{duration:n}:null;const r=this.media.duration,a=K(s.duration)?s.duration:0;return i>a&&i>r||!K(r)?{duration:i}:null}updateMediaSource({duration:e,start:t,end:s}){const i=this.mediaSource;!this.media||!i||i.readyState!=="open"||(i.duration!==e&&(K(e)&&this.log(`Updating MediaSource duration to ${e.toFixed(3)}`),i.duration=e),t!==void 0&&s!==void 0&&(this.log(`MediaSource duration is set to ${i.duration}. Setting seekable range to ${t}-${s}.`),i.setLiveSeekableRange(t,s)))}get tracksReady(){const e=this.pendingTrackCount;return e>0&&(e>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){const{bufferCodecEventsTotal:e,pendingTrackCount:t,tracks:s}=this;if(this.log(`checkPendingTracks (pending: ${t} codec events expected: ${e}) ${le(s)}`),this.tracksReady){var i;const n=(i=this.transferData)==null?void 0:i.tracks;n&&Object.keys(n).length?this.attachTransferred():this.createSourceBuffers()}}bufferCreated(){if(this.sourceBufferCount){const e={};this.sourceBuffers.forEach(([t,s])=>{if(t){const i=this.tracks[t];e[t]={buffer:s,container:i.container,codec:i.codec,supplemental:i.supplemental,levelCodec:i.levelCodec,id:i.id,metadata:i.metadata}}}),this.hls.trigger(y.BUFFER_CREATED,{tracks:e}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([t])=>{this.executeNext(t)})}else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(y.ERROR,{type:q.MEDIA_ERROR,details:k.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}createSourceBuffers(){const{tracks:e,sourceBuffers:t,mediaSource:s}=this;if(!s)throw new Error("createSourceBuffers called when mediaSource was null");for(const n in e){const r=n,a=e[r];if(this.isPending(a)){const c=this.getTrackCodec(a,r),l=`${a.container};codecs=${c}`;a.codec=c,this.log(`creating sourceBuffer(${l})${this.currentOp(r)?" Queued":""} ${le(a)}`);try{const h=s.addSourceBuffer(l),u=Kn(r),d=[r,h];t[u]=d,a.buffer=h}catch(h){var i;this.error(`error while trying to add sourceBuffer: ${h.message}`),this.shiftAndExecuteNext(r),(i=this.operationQueue)==null||i.removeBlockers(),delete this.tracks[r],this.hls.trigger(y.ERROR,{type:q.MEDIA_ERROR,details:k.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:h,sourceBufferName:r,mimeType:l,parent:a.id});return}this.trackSourceBuffer(r,a)}}this.bufferCreated()}getTrackCodec(e,t){const s=e.supplemental;let i=e.codec;s&&(t==="video"||t==="audiovideo")&&ai(s,"video")&&(i=ZA(i,s));const n=Ji(i,e.levelCodec);return n?t.slice(0,5)==="audio"?hn(n,this.appendSource):n:""}trackSourceBuffer(e,t){const s=t.buffer;if(!s)return;const i=this.getTrackCodec(t,e);this.tracks[e]={buffer:s,codec:i,container:t.container,levelCodec:t.levelCodec,supplemental:t.supplemental,metadata:t.metadata,id:t.id,listeners:[]},this.removeBufferListeners(e),this.addBufferListener(e,"updatestart",this.onSBUpdateStart),this.addBufferListener(e,"updateend",this.onSBUpdateEnd),this.addBufferListener(e,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(e,"bufferedchange",(n,r)=>{const a=r.removedRanges;a!=null&&a.length&&this.hls.trigger(y.BUFFER_FLUSHED,{type:n})})}get mediaSrc(){var e,t;const s=((e=this.media)==null||(t=e.querySelector)==null?void 0:t.call(e,"source"))||this.media;return s?.src}onSBUpdateStart(e){const t=this.currentOp(e);t&&t.onStart()}onSBUpdateEnd(e){var t;if(((t=this.mediaSource)==null?void 0:t.readyState)==="closed"){this.resetBuffer(e);return}const s=this.currentOp(e);s&&(s.onComplete(),this.shiftAndExecuteNext(e))}onSBUpdateError(e,t){var s;const i=new Error(`${e} SourceBuffer error. MediaSource readyState: ${(s=this.mediaSource)==null?void 0:s.readyState}`);this.error(`${i}`,t),this.hls.trigger(y.ERROR,{type:q.MEDIA_ERROR,details:k.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:i,fatal:!1});const n=this.currentOp(e);n&&n.onError(i)}updateTimestampOffset(e,t,s,i,n,r){const a=t-e.timestampOffset;Math.abs(a)>=s&&(this.log(`Updating ${i} SourceBuffer timestampOffset to ${t} (sn: ${n} cc: ${r})`),e.timestampOffset=t)}removeExecutor(e,t,s){const{media:i,mediaSource:n}=this,r=this.tracks[e],a=r?.buffer;if(!i||!n||!a){this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),this.shiftAndExecuteNext(e);return}const c=K(i.duration)?i.duration:1/0,l=K(n.duration)?n.duration:1/0,h=Math.max(0,t),u=Math.min(s,c,l);u>h&&(!r.ending||r.ended)?(r.ended=!1,this.log(`Removing [${h},${u}] from the ${e} SourceBuffer`),a.remove(h,u)):this.shiftAndExecuteNext(e)}appendExecutor(e,t){const s=this.tracks[t],i=s?.buffer;if(!i)throw new cm(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);s.ending=!1,s.ended=!1,i.appendBuffer(e)}blockUntilOpen(e){if(this.isUpdating()||this.isQueued())this.blockBuffers(e).catch(t=>{this.warn(`SourceBuffer blocked callback ${t}`),this.stepOperationQueue(this.sourceBufferTypes)});else try{e()}catch(t){this.warn(`Callback run without blocking ${this.operationQueue} ${t}`)}}isUpdating(){return this.sourceBuffers.some(([e,t])=>e&&t.updating)}isQueued(){return this.sourceBuffers.some(([e])=>e&&!!this.currentOp(e))}isPending(e){return!!e&&!e.buffer}blockBuffers(e,t=this.sourceBufferTypes){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);const{operationQueue:s}=this,i=t.map(r=>this.appendBlocker(r));return t.length>1&&this.blockedAudioAppend&&this.unblockAudio(),Promise.all(i).then(r=>{s===this.operationQueue&&(e(),this.stepOperationQueue(this.sourceBufferTypes))})}stepOperationQueue(e){e.forEach(t=>{var s;const i=(s=this.tracks[t])==null?void 0:s.buffer;!i||i.updating||this.shiftAndExecuteNext(t)})}append(e,t,s){this.operationQueue&&this.operationQueue.append(e,t,s)}appendBlocker(e){if(this.operationQueue)return this.operationQueue.appendBlocker(e)}currentOp(e){return this.operationQueue?this.operationQueue.current(e):null}executeNext(e){e&&this.operationQueue&&this.operationQueue.executeNext(e)}shiftAndExecuteNext(e){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(e)}get pendingTrackCount(){return Object.keys(this.tracks).reduce((e,t)=>e+(this.isPending(this.tracks[t])?1:0),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((e,[t])=>e+(t?1:0),0)}get sourceBufferTypes(){return this.sourceBuffers.map(([e])=>e).filter(e=>!!e)}addBufferListener(e,t,s){const i=this.tracks[e];if(!i)return;const n=i.buffer;if(!n)return;const r=s.bind(this,e);i.listeners.push({event:t,listener:r}),n.addEventListener(t,r)}removeBufferListeners(e){const t=this.tracks[e];if(!t)return;const s=t.buffer;s&&(t.listeners.forEach(i=>{s.removeEventListener(i.event,i.listener)}),t.listeners.length=0)}}function pl(o){const e=o.querySelectorAll("source");[].slice.call(e).forEach(t=>{o.removeChild(t)})}function um(o,e){const t=self.document.createElement("source");t.type="video/mp4",t.src=e,o.appendChild(t)}function Kn(o){return o==="audio"?1:0}class Go{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(y.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(y.BUFFER_CODECS,this.onBufferCodecs,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(y.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(y.BUFFER_CODECS,this.onBufferCodecs,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const s=this.hls.levels[t.droppedLevel];this.isLevelAllowed(s)&&this.restrictedLevels.push({bitrate:s.bitrate,height:s.height,width:s.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const s=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,s.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&K(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping(),this.media=null}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const e=this.hls.levels;if(e.length){const t=this.hls,s=this.getMaxLevel(e.length-1);s!==this.autoLevelCapping&&t.logger.log(`Setting autoLevelCapping to ${s}: ${e[s].height}p@${e[s].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=s,t.autoLevelEnabled&&t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const s=t.filter((i,n)=>this.isLevelAllowed(i)&&n<=e);return this.clientRect=null,Go.getMaxLevelByMediaSize(s,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const s=e.getBoundingClientRect();t.width=s.width,t.height=s.height,!t.width&&!t.height&&(t.width=s.right-s.left||e.width||0,t.height=s.bottom-s.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch{}return Math.min(e,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(e){return!this.restrictedLevels.some(s=>e.bitrate===s.bitrate&&e.width===s.width&&e.height===s.height)}static getMaxLevelByMediaSize(e,t,s){if(!(e!=null&&e.length))return-1;const i=(a,c)=>c?a.width!==c.width||a.height!==c.height:!0;let n=e.length-1;const r=Math.max(t,s);for(let a=0;a<e.length;a+=1){const c=e[a];if((c.width>=r||c.height>=r)&&i(c,e[a+1])){n=a;break}}return n}}const dm={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},Ne=dm,Am={HLS:"h"},fm=Am;class yt{constructor(e,t){Array.isArray(e)&&(e=e.map(s=>s instanceof yt?s:new yt(s))),this.value=e,this.params=t}}const gm="Dict";function mm(o){return Array.isArray(o)?JSON.stringify(o):o instanceof Map?"Map{}":o instanceof Set?"Set{}":typeof o=="object"?JSON.stringify(o):String(o)}function pm(o,e,t,s){return new Error(`failed to ${o} "${mm(e)}" as ${t}`,{cause:s})}function Ct(o,e,t){return pm("serialize",o,e,t)}class Gh{constructor(e){this.description=e}}const El="Bare Item",Em="Boolean";function Im(o){if(typeof o!="boolean")throw Ct(o,Em);return o?"?1":"?0"}function ym(o){return btoa(String.fromCharCode(...o))}const Cm="Byte Sequence";function Tm(o){if(ArrayBuffer.isView(o)===!1)throw Ct(o,Cm);return`:${ym(o)}:`}const Sm="Integer";function Bm(o){return o<-999999999999999||999999999999999<o}function Hh(o){if(Bm(o))throw Ct(o,Sm);return o.toString()}function xm(o){return`@${Hh(o.getTime()/1e3)}`}function Kh(o,e){if(o<0)return-Kh(-o,e);const t=Math.pow(10,e);if(Math.abs(o*t%1-.5)<Number.EPSILON){const i=Math.floor(o*t);return(i%2===0?i:i+1)/t}else return Math.round(o*t)/t}const vm="Decimal";function Lm(o){const e=Kh(o,3);if(Math.floor(Math.abs(e)).toString().length>12)throw Ct(o,vm);const t=e.toString();return t.includes(".")?t:`${t}.0`}const Rm="String",Dm=/[\x00-\x1f\x7f]+/;function bm(o){if(Dm.test(o))throw Ct(o,Rm);return`"${o.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function wm(o){return o.description||o.toString().slice(7,-1)}const _m="Token";function Il(o){const e=wm(o);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e)===!1)throw Ct(e,_m);return e}function $r(o){switch(typeof o){case"number":if(!K(o))throw Ct(o,El);return Number.isInteger(o)?Hh(o):Lm(o);case"string":return bm(o);case"symbol":return Il(o);case"boolean":return Im(o);case"object":if(o instanceof Date)return xm(o);if(o instanceof Uint8Array)return Tm(o);if(o instanceof Gh)return Il(o);default:throw Ct(o,El)}}const km="Key";function Vr(o){if(/^[a-z*][a-z0-9\-_.*]*$/.test(o)===!1)throw Ct(o,km);return o}function Ho(o){return o==null?"":Object.entries(o).map(([e,t])=>t===!0?`;${Vr(e)}`:`;${Vr(e)}=${$r(t)}`).join("")}function $h(o){return o instanceof yt?`${$r(o.value)}${Ho(o.params)}`:$r(o)}function Pm(o){return`(${o.value.map($h).join(" ")})${Ho(o.params)}`}function Fm(o,e={whitespace:!0}){if(typeof o!="object"||o==null)throw Ct(o,gm);const t=o instanceof Map?o.entries():Object.entries(o),s=e?.whitespace?" ":"";return Array.from(t).map(([i,n])=>{n instanceof yt||(n=new yt(n));let r=Vr(i);return n.value===!0?r+=Ho(n.params):(r+="=",Array.isArray(n.value)?r+=Pm(n):r+=$h(n)),r}).join(`,${s}`)}function Vh(o,e){return Fm(o,e)}const ut="CMCD-Object",Ae="CMCD-Request",Jt="CMCD-Session",Pt="CMCD-Status",Mm={br:ut,ab:ut,d:ut,ot:ut,tb:ut,tpb:ut,lb:ut,tab:ut,lab:ut,url:ut,pb:Ae,bl:Ae,tbl:Ae,dl:Ae,ltc:Ae,mtp:Ae,nor:Ae,nrr:Ae,rc:Ae,sn:Ae,sta:Ae,su:Ae,ttfb:Ae,ttfbb:Ae,ttlb:Ae,cmsdd:Ae,cmsds:Ae,smrt:Ae,df:Ae,cs:Ae,ts:Ae,cid:Jt,pr:Jt,sf:Jt,sid:Jt,st:Jt,v:Jt,msd:Jt,bs:Pt,bsd:Pt,cdn:Pt,rtp:Pt,bg:Pt,pt:Pt,ec:Pt,e:Pt},Qm={REQUEST:Ae};function Om(o){return Object.keys(o).reduce((e,t)=>{var s;return(s=o[t])===null||s===void 0||s.forEach(i=>e[i]=t),e},{})}function Nm(o,e){const t={};if(!o)return t;const s=Object.keys(o),i=e?Om(e):{};return s.reduce((n,r)=>{var a;const c=Mm[r]||i[r]||Qm.REQUEST,l=(a=n[c])!==null&&a!==void 0?a:n[c]={};return l[r]=o[r],n},t)}function Um(o){return["ot","sf","st","e","sta"].includes(o)}function Gm(o){return typeof o=="number"?K(o):o!=null&&o!==""&&o!==!1}const Yh="event";function Hm(o,e){const t=new URL(o),s=new URL(e);if(t.origin!==s.origin)return o;const i=t.pathname.split("/").slice(1),n=s.pathname.split("/").slice(1,-1);for(;i[0]===n[0];)i.shift(),n.shift();for(;n.length;)n.shift(),i.unshift("..");return i.join("/")+t.search+t.hash}const tn=o=>Math.round(o),Yr=(o,e)=>Array.isArray(o)?o.map(t=>Yr(t,e)):o instanceof yt&&typeof o.value=="string"?new yt(Yr(o.value,e),o.params):(e.baseUrl&&(o=Hm(o,e.baseUrl)),e.version===1?encodeURIComponent(o):o),Bi=o=>tn(o/100)*100,Km=(o,e)=>{let t=o;return e.version>=2&&(o instanceof yt&&typeof o.value=="string"?t=new yt([o]):typeof o=="string"&&(t=[o])),Yr(t,e)},$m={br:tn,d:tn,bl:Bi,dl:Bi,mtp:Bi,nor:Km,rtp:Bi,tb:tn},qh="request",Wh="response",Ko=["ab","bg","bl","br","bs","bsd","cdn","cid","cs","df","ec","lab","lb","ltc","msd","mtp","pb","pr","pt","sf","sid","sn","st","sta","tab","tb","tbl","tpb","ts","v"],Vm=["e"],Ym=/^[a-zA-Z0-9-.]+-[a-zA-Z0-9-.]+$/;function Sn(o){return Ym.test(o)}function qm(o){return Ko.includes(o)||Vm.includes(o)||Sn(o)}const jh=["d","dl","nor","ot","rtp","su"];function Wm(o){return Ko.includes(o)||jh.includes(o)||Sn(o)}const jm=["cmsdd","cmsds","rc","smrt","ttfb","ttfbb","ttlb","url"];function Jm(o){return Ko.includes(o)||jh.includes(o)||jm.includes(o)||Sn(o)}const Xm=["bl","br","bs","cid","d","dl","mtp","nor","nrr","ot","pr","rtp","sf","sid","st","su","tb","v"];function zm(o){return Xm.includes(o)||Sn(o)}const Zm={[Wh]:Jm,[Yh]:qm,[qh]:Wm};function Jh(o,e={}){const t={};if(o==null||typeof o!="object")return t;const s=e.version||o.v||1,i=e.reportingMode||qh,n=s===1?zm:Zm[i];let r=Object.keys(o).filter(n);const a=e.filter;typeof a=="function"&&(r=r.filter(a));const c=i===Wh||i===Yh;c&&!r.includes("ts")&&r.push("ts"),s>1&&!r.includes("v")&&r.push("v");const l=oe({},$m,e.formatters),h={version:s,reportingMode:i,baseUrl:e.baseUrl};return r.sort().forEach(u=>{let d=o[u];const A=l[u];if(typeof A=="function"&&(d=A(d,h)),u==="v"){if(s===1)return;d=s}u=="pr"&&d===1||(c&&u==="ts"&&!K(d)&&(d=Date.now()),Gm(d)&&(Um(u)&&typeof d=="string"&&(d=new Gh(d)),t[u]=d))}),t}function ep(o,e={}){const t={};if(!o)return t;const s=Jh(o,e),i=Nm(s,e?.customHeaderMap);return Object.entries(i).reduce((n,[r,a])=>{const c=Vh(a,{whitespace:!1});return c&&(n[r]=c),n},t)}function tp(o,e,t){return oe(o,ep(e,t))}const sp="CMCD";function ip(o,e={}){return o?Vh(Jh(o,e),{whitespace:!1}):""}function np(o,e={}){if(!o)return"";const t=ip(o,e);return encodeURIComponent(t)}function rp(o,e={}){if(!o)return"";const t=np(o,e);return`${sp}=${t}`}const yl=/CMCD=[^&#]+/;function op(o,e,t){const s=rp(e,t);if(!s)return o;if(yl.test(o))return o.replace(yl,s);const i=o.includes("?")?"&":"?";return`${o}${i}${s}`}class ap{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=i=>{try{this.apply(i,{ot:Ne.MANIFEST,su:!this.initialized})}catch(n){this.hls.logger.warn("Could not generate manifest CMCD data.",n)}},this.applyFragmentData=i=>{try{const{frag:n,part:r}=i,a=this.hls.levels[n.level],c=this.getObjectType(n),l={d:(r||n).duration*1e3,ot:c};(c===Ne.VIDEO||c===Ne.AUDIO||c==Ne.MUXED)&&(l.br=a.bitrate/1e3,l.tb=this.getTopBandwidth(c)/1e3,l.bl=this.getBufferLength(c));const h=r?this.getNextPart(r):this.getNextFrag(n);h!=null&&h.url&&h.url!==n.url&&(l.nor=h.url),this.apply(i,l)}catch(n){this.hls.logger.warn("Could not generate segment CMCD data.",n)}},this.hls=e;const t=this.config=e.config,{cmcd:s}=t;s!=null&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=s.sessionId||e.sessionId,this.cid=s.contentId,this.useHeaders=s.useHeaders===!0,this.includeKeys=s.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHED,this.onMediaDetached,this),e.on(y.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHED,this.onMediaDetached,this),e.off(y.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var s,i;this.audioBuffer=(s=t.tracks.audio)==null?void 0:s.buffer,this.videoBuffer=(i=t.tracks.video)==null?void 0:i.buffer}createData(){var e;return{v:1,sf:fm.HLS,sid:this.sid,cid:this.cid,pr:(e=this.media)==null?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){oe(t,this.createData());const s=t.ot===Ne.INIT||t.ot===Ne.VIDEO||t.ot===Ne.MUXED;this.starved&&s&&(t.bs=!0,t.su=!0,this.starved=!1),t.su==null&&(t.su=this.buffering);const{includeKeys:i}=this;i&&(t=Object.keys(t).reduce((r,a)=>(i.includes(a)&&(r[a]=t[a]),r),{}));const n={baseUrl:e.url};this.useHeaders?(e.headers||(e.headers={}),tp(e.headers,t,n)):e.url=op(e.url,t,n)}getNextFrag(e){var t;const s=(t=this.hls.levels[e.level])==null?void 0:t.details;if(s){const i=e.sn-s.startSN;return s.fragments[i+1]}}getNextPart(e){var t;const{index:s,fragment:i}=e,n=(t=this.hls.levels[i.level])==null||(t=t.details)==null?void 0:t.partList;if(n){const{sn:r}=i;for(let a=n.length-1;a>=0;a--){const c=n[a];if(c.index===s&&c.fragment.sn===r)return n[a+1]}}}getObjectType(e){const{type:t}=e;if(t==="subtitle")return Ne.TIMED_TEXT;if(e.sn==="initSegment")return Ne.INIT;if(t==="audio")return Ne.AUDIO;if(t==="main")return this.hls.audioTracks.length?Ne.VIDEO:Ne.MUXED}getTopBandwidth(e){let t=0,s;const i=this.hls;if(e===Ne.AUDIO)s=i.audioTracks;else{const n=i.maxAutoLevel,r=n>-1?n+1:i.levels.length;s=i.levels.slice(0,r)}return s.forEach(n=>{n.bitrate>t&&(t=n.bitrate)}),t>0?t:NaN}getBufferLength(e){const t=this.media,s=e===Ne.AUDIO?this.audioBuffer:this.videoBuffer;return!s||!t?NaN:J.bufferInfo(s,t.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,s=e||this.config.loader;return class{constructor(n){this.loader=void 0,this.loader=new s(n)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(n,r,a){t(n),this.loader.load(n,r,a)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,s=e||this.config.loader;return class{constructor(n){this.loader=void 0,this.loader=new s(n)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(n,r,a){t(n),this.loader.load(n,r,a)}}}}const lp=3e5;class cp extends st{constructor(e){super("content-steering",e.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.ERROR,this.onError,this))}pathways(){return(this.levels||[]).reduce((e,t)=>(e.indexOf(t.pathwayId)===-1&&e.push(t.pathwayId),e),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(e){this.updatePathwayPriority(e)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=this.timeToLoad*1e3-(performance.now()-this.updated);if(e>0){this.scheduleRefresh(this.uri,e);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(s=>s!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:s}=t;s!==null&&(this.pathwayId=s.pathwayId,this.uri=s.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:s}=t;if(s?.action===Le.SendAlternateToPenaltyBox&&s.flags===He.MoveAllAlternatesMatchingHost){const i=this.levels;let n=this._pathwayPriority,r=this.pathwayId;if(t.context){const{groupId:a,pathwayId:c,type:l}=t.context;a&&i?r=this.getPathwayForGroupId(a,l,r):c&&(r=c)}r in this.penalizedPathways||(this.penalizedPathways[r]=performance.now()),!n&&i&&(n=this.pathways()),n&&n.length>1&&(this.updatePathwayPriority(n),s.resolved=this.pathwayId!==r),t.details===k.BUFFER_APPEND_ERROR&&!t.fatal?s.resolved=!0:s.resolved||this.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${r} levels: ${i&&i.length} priorities: ${le(n)} penalized: ${le(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(t.length===0){const s=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${s}"`),t=this.getLevelsForPathway(s),this.pathwayId=s}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return this.levels===null?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){this._pathwayPriority=e;let t;const s=this.penalizedPathways,i=performance.now();Object.keys(s).forEach(n=>{i-s[n]>lp&&delete s[n]});for(let n=0;n<e.length;n++){const r=e[n];if(r in s)continue;if(r===this.pathwayId)return;const a=this.hls.nextLoadLevel,c=this.hls.levels[a];if(t=this.getLevelsForPathway(r),t.length>0){this.log(`Setting Pathway to "${r}"`),this.pathwayId=r,mh(t),this.hls.trigger(y.LEVELS_UPDATED,{levels:t});const l=this.hls.levels[a];c&&l&&this.levels&&(l.attrs["STABLE-VARIANT-ID"]!==c.attrs["STABLE-VARIANT-ID"]&&l.bitrate!==c.bitrate&&this.log(`Unstable Pathways change from bitrate ${c.bitrate} to ${l.bitrate}`),this.hls.nextLoadLevel=a);break}}}getPathwayForGroupId(e,t,s){const i=this.getLevelsForPathway(s).concat(this.levels||[]);for(let n=0;n<i.length;n++)if(t===Z.AUDIO_TRACK&&i[n].hasAudioGroup(e)||t===Z.SUBTITLE_TRACK&&i[n].hasSubtitleGroup(e))return i[n].pathwayId;return s}clonePathways(e){const t=this.levels;if(!t)return;const s={},i={};e.forEach(n=>{const{ID:r,"BASE-ID":a,"URI-REPLACEMENT":c}=n;if(t.some(h=>h.pathwayId===r))return;const l=this.getLevelsForPathway(a).map(h=>{const u=new he(h.attrs);u["PATHWAY-ID"]=r;const d=u.AUDIO&&`${u.AUDIO}_clone_${r}`,A=u.SUBTITLES&&`${u.SUBTITLES}_clone_${r}`;d&&(s[u.AUDIO]=d,u.AUDIO=d),A&&(i[u.SUBTITLES]=A,u.SUBTITLES=A);const f=Xh(h.uri,u["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",c),g=new ci({attrs:u,audioCodec:h.audioCodec,bitrate:h.bitrate,height:h.height,name:h.name,url:f,videoCodec:h.videoCodec,width:h.width});if(h.audioGroups)for(let m=1;m<h.audioGroups.length;m++)g.addGroupId("audio",`${h.audioGroups[m]}_clone_${r}`);if(h.subtitleGroups)for(let m=1;m<h.subtitleGroups.length;m++)g.addGroupId("text",`${h.subtitleGroups[m]}_clone_${r}`);return g});t.push(...l),Cl(this.audioTracks,s,c,r),Cl(this.subtitleTracks,i,c,r)})}loadSteeringManifest(e){const t=this.hls.config,s=t.loader;this.loader&&this.loader.destroy(),this.loader=new s(t);let i;try{i=new self.URL(e)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${e}`);return}if(i.protocol!=="data:"){const h=(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate)|0;i.searchParams.set("_HLS_pathway",this.pathwayId),i.searchParams.set("_HLS_throughput",""+h)}const n={responseType:"json",url:i.href},r=t.steeringManifestLoadPolicy.default,a=r.errorRetry||r.timeoutRetry||{},c={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(h,u,d,A)=>{this.log(`Loaded steering manifest: "${i}"`);const f=h.data;if(f?.VERSION!==1){this.log(`Steering VERSION ${f.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=f.TTL;const{"RELOAD-URI":g,"PATHWAY-CLONES":m,"PATHWAY-PRIORITY":E}=f;if(g)try{this.uri=new self.URL(g,i).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${g}`);return}this.scheduleRefresh(this.uri||d.url),m&&this.clonePathways(m);const p={steeringManifest:f,url:i.toString()};this.hls.trigger(y.STEERING_MANIFEST_LOADED,p),E&&this.updatePathwayPriority(E)},onError:(h,u,d,A)=>{if(this.log(`Error loading steering manifest: ${h.code} ${h.text} (${u.url})`),this.stopLoad(),h.code===410){this.enabled=!1,this.log(`Steering manifest ${u.url} no longer available`);return}let f=this.timeToLoad*1e3;if(h.code===429){const g=this.loader;if(typeof g?.getResponseHeader=="function"){const m=g.getResponseHeader("Retry-After");m&&(f=parseFloat(m)*1e3)}this.log(`Steering manifest ${u.url} rate limited`);return}this.scheduleRefresh(this.uri||u.url,f)},onTimeout:(h,u,d)=>{this.log(`Timeout loading steering manifest (${u.url})`),this.scheduleRefresh(this.uri||u.url)}};this.log(`Requesting steering manifest: ${i}`),this.loader.load(n,c,l)}scheduleRefresh(e,t=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var s;const i=(s=this.hls)==null?void 0:s.media;if(i&&!i.ended){this.loadSteeringManifest(e);return}this.scheduleRefresh(e,this.timeToLoad*1e3)},t)}}function Cl(o,e,t,s){o&&Object.keys(e).forEach(i=>{const n=o.filter(r=>r.groupId===i).map(r=>{const a=oe({},r);return a.details=void 0,a.attrs=new he(a.attrs),a.url=a.attrs.URI=Xh(r.url,r.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",t),a.groupId=a.attrs["GROUP-ID"]=e[i],a.attrs["PATHWAY-ID"]=s,a});o.push(...n)})}function Xh(o,e,t,s){const{HOST:i,PARAMS:n,[t]:r}=s;let a;e&&(a=r?.[e],a&&(o=a));const c=new self.URL(o);return i&&!a&&(c.host=i),n&&Object.keys(n).sort().forEach(l=>{l&&c.searchParams.set(l,n[l])}),c.href}class Ds extends st{constructor(e){super("eme",e.logger),this.hls=void 0,this.config=void 0,this.media=null,this.mediaResolved=void 0,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.mediaKeys=null,this.setMediaKeysQueue=Ds.CDMCleanupPromise?[Ds.CDMCleanupPromise]:[],this.bannedKeyIds={},this.onMediaEncrypted=t=>{const{initDataType:s,initData:i}=t,n=`"${t.type}" event: init data type: "${s}"`;if(this.debug(n),i!==null){if(!this.keyFormatPromise){let r=Object.keys(this.keySystemAccessPromises);r.length||(r=Xs(this.config));const a=r.map(Fn).filter(c=>!!c);this.keyFormatPromise=this.getKeyFormatPromise(a)}this.keyFormatPromise.then(r=>{const a=zi(r);if(s!=="sinf"||a!==de.FAIRPLAY){this.log(`Ignoring "${t.type}" event with init data type: "${s}" for selected key-system ${a}`);return}let c;try{const A=Ee(new Uint8Array(i)),f=wo(JSON.parse(A).sinf),g=Vc(f);if(!g)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");c=new Uint8Array(g.subarray(8,24))}catch(A){this.warn(`${n} Failed to parse sinf: ${A}`);return}const l=Re(c),{keyIdToKeySessionPromise:h,mediaKeySessions:u}=this;let d=h[l];for(let A=0;A<u.length;A++){const f=u[A],g=f.decryptdata;if(!g.keyId)continue;const m=Re(g.keyId);if(gn(c,g.keyId)||g.uri.replace(/-/g,"").indexOf(l)!==-1){if(d=h[m],!d)continue;if(g.pssh)break;delete h[m],g.pssh=new Uint8Array(i),g.keyId=c,d=h[l]=d.then(()=>this.generateRequestWithPreferredKeySession(f,s,i,"encrypted-event-key-match")),d.catch(E=>this.handleError(E));break}}d||this.handleError(new Error(`Key ID ${l} not encountered in playlist. Key-system sessions ${u.length}.`))}).catch(r=>this.handleError(r))}},this.onWaitingForKey=t=>{this.log(`"${t.type}" event`)},this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.onDestroying(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null}registerListeners(){this.hls.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(y.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.on(y.DESTROYING,this.onDestroying,this)}unregisterListeners(){this.hls.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(y.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(y.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.off(y.DESTROYING,this.onDestroying,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:s}=this.config,i=t?.[e];if(i)return i.licenseUrl;if(e===de.WIDEVINE&&s)return s}getLicenseServerUrlOrThrow(e){const t=this.getLicenseServerUrl(e);if(t===void 0)throw new Error(`no license server URL configured for key-system "${e}"`);return t}getServerCertificateUrl(e){const{drmSystems:t}=this.config,s=t?.[e];if(s)return s.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,s=(r,a,c)=>!!r&&c.indexOf(r)===a,i=t.map(r=>r.audioCodec).filter(s),n=t.map(r=>r.videoCodec).filter(s);return i.length+n.length===0&&n.push("avc1.42e01e"),new Promise((r,a)=>{const c=l=>{const h=l.shift();this.getMediaKeysPromise(h,i,n).then(u=>r({keySystem:h,mediaKeys:u})).catch(u=>{l.length?c(l):u instanceof Ge?a(u):a(new Ge({type:q.KEY_SYSTEM_ERROR,details:k.KEY_SYSTEM_NO_ACCESS,error:u,fatal:!0},u.message))})};c(e)})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:s}=this.config;if(typeof s!="function"){let i=`Configured requestMediaKeySystemAccess is not a function ${s}`;return lh===null&&self.location.protocol==="http:"&&(i=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(i))}return s(e,t)}getMediaKeysPromise(e,t,s){var i;const n=Kf(e,t,s,this.config.drmSystemOptions||{});let r=this.keySystemAccessPromises[e],a=(i=r)==null?void 0:i.keySystemAccess;if(!a){this.log(`Requesting encrypted media "${e}" key-system access with config: ${le(n)}`),a=this.requestMediaKeySystemAccess(e,n);const c=r=this.keySystemAccessPromises[e]={keySystemAccess:a};return a.catch(l=>{this.log(`Failed to obtain access to key-system "${e}": ${l}`)}),a.then(l=>{this.log(`Access for key-system "${l.keySystem}" obtained`);const h=this.fetchServerCertificate(e);this.log(`Create media-keys for "${e}"`);const u=c.mediaKeys=l.createMediaKeys().then(d=>(this.log(`Media-keys created for "${e}"`),c.hasMediaKeys=!0,h.then(A=>A?this.setMediaKeysServerCertificate(d,e,A):d)));return u.catch(d=>{this.error(`Failed to create media-keys for "${e}"}: ${d}`)}),u})}return a.then(()=>r.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:s}){this.log(`Creating key-system session "${t}" keyId: ${Re(e.keyId||[])} keyUri: ${e.uri}`);const i=s.createSession(),n={decryptdata:e,keySystem:t,mediaKeys:s,mediaKeysSession:i,keyStatus:"status-pending"};return this.mediaKeySessions.push(n),n}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const s=this.createMediaKeySessionContext(e),i=xi(t),n="cenc";this.keyIdToKeySessionPromise[i]=this.generateRequestWithPreferredKeySession(s,n,t.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}updateKeySession(e,t){const s=e.mediaKeysSession;return this.log(`Updating key-session "${s.sessionId}" for keyId ${Re(e.decryptdata.keyId||[])}
      } (data length: ${t.byteLength})`),s.update(t)}getSelectedKeySystemFormats(){return Object.keys(this.keySystemAccessPromises).map(e=>({keySystem:e,hasMediaKeys:this.keySystemAccessPromises[e].hasMediaKeys})).filter(({hasMediaKeys:e})=>!!e).map(({keySystem:e})=>Fn(e)).filter(e=>!!e)}getKeySystemAccess(e){return this.getKeySystemSelectionPromise(e).then(({keySystem:t,mediaKeys:s})=>this.attemptSetMediaKeys(t,s))}selectKeySystem(e){return new Promise((t,s)=>{this.getKeySystemSelectionPromise(e).then(({keySystem:i})=>{const n=Fn(i);n?t(n):s(new Error(`Unable to find format for key-system "${i}"`))}).catch(s)})}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){const t=Xs(this.config),s=e.map(zi).filter(i=>!!i&&t.indexOf(i)!==-1);return this.selectKeySystem(s)}getKeyStatus(e){const{mediaKeySessions:t}=this;for(let s=0;s<t.length;s++){const i=hp(e,t[s]);if(i)return i}}loadKey(e){const t=e.keyInfo.decryptdata,s=xi(t),i=this.bannedKeyIds[s];if(i||this.getKeyStatus(t)==="internal-error"){const a=Tl(i||"internal-error",t);return this.handleError(a,e.frag),Promise.reject(a)}const n=`(keyId: ${s} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${n}`);const r=this.keyIdToKeySessionPromise[s];if(!r){const a=this.getKeySystemForKeyPromise(t).then(({keySystem:c,mediaKeys:l})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${n}`),this.attemptSetMediaKeys(c,l).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:c,mediaKeys:l,decryptdata:t}))))).then(c=>{const l="cenc",h=t.pssh?t.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(c,l,h,"playlist-key")});return a.catch(c=>this.handleError(c,e.frag)),this.keyIdToKeySessionPromise[s]=a,a}return r.catch(a=>{if(a instanceof Ge){const c=ne({},a.data);this.getKeyStatus(t)==="internal-error"&&(c.decryptdata=t);const l=new Ge(c,a.message);this.handleError(l,e.frag)}}),r}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e,t){if(this.hls)if(e instanceof Ge){t&&(e.data.frag=t);const s=e.data.decryptdata;this.error(`${e.message}${s?` (${Re(s.keyId||[])})`:""}`),this.hls.trigger(y.ERROR,e.data)}else this.error(e.message),this.hls.trigger(y.ERROR,{type:q.KEY_SYSTEM_ERROR,details:k.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0})}getKeySystemForKeyPromise(e){const t=xi(e),s=this.keyIdToKeySessionPromise[t];if(!s){const i=zi(e.keyFormat),n=i?[i]:Xs(this.config);return this.attemptKeySystemAccess(n)}return s}getKeySystemSelectionPromise(e){if(e.length||(e=Xs(this.config)),e.length===0)throw new Ge({type:q.KEY_SYSTEM_ERROR,details:k.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${le({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}attemptSetMediaKeys(e,t){if(this.mediaResolved=void 0,this.mediaKeys===t)return Promise.resolve();const s=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const i=Promise.all(s).then(()=>this.media?this.media.setMediaKeys(t):new Promise((n,r)=>{this.mediaResolved=()=>{if(this.mediaResolved=void 0,!this.media)return r(new Error("Attempted to set mediaKeys without media element attached"));this.mediaKeys=t,this.media.setMediaKeys(t).then(n).catch(r)}}));return this.mediaKeys=t,this.setMediaKeysQueue.push(i),i.then(()=>{this.log(`Media-keys set for "${e}"`),s.push(i),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(n=>s.indexOf(n)===-1)})}generateRequestWithPreferredKeySession(e,t,s,i){var n;const r=(n=this.config.drmSystems)==null||(n=n[e.keySystem])==null?void 0:n.generateRequest;if(r)try{const f=r.call(this.hls,t,s,e);if(!f)throw new Error("Invalid response from configured generateRequest filter");t=f.initDataType,s=f.initData?f.initData:null,e.decryptdata.pssh=s?new Uint8Array(s):null}catch(f){if(this.warn(f.message),this.hls&&this.hls.config.debug)throw f}if(s===null)return this.log(`Skipping key-session request for "${i}" (no initData)`),Promise.resolve(e);const a=xi(e.decryptdata),c=e.decryptdata.uri;this.log(`Generating key-session request for "${i}" keyId: ${a} URI: ${c} (init data type: ${t} length: ${s.byteLength})`);const l=new ko,h=e._onmessage=f=>{const g=e.mediaKeysSession;if(!g){l.emit("error",new Error("invalid state"));return}const{messageType:m,message:E}=f;this.log(`"${m}" message event for session "${g.sessionId}" message size: ${E.byteLength}`),m==="license-request"||m==="license-renewal"?this.renewLicense(e,E).catch(p=>{l.eventNames().length?l.emit("error",p):this.handleError(p)}):m==="license-release"?e.keySystem===de.FAIRPLAY&&this.updateKeySession(e,Or("acknowledged")).then(()=>this.removeSession(e)).catch(p=>this.handleError(p)):this.warn(`unhandled media key message type "${m}"`)},u=(f,g)=>{g.keyStatus=f;let m;f.startsWith("usable")?l.emit("resolved"):f==="internal-error"||f==="output-restricted"||f==="output-downscaled"?m=Tl(f,g.decryptdata):f==="expired"?m=new Error(`key expired (keyId: ${a})`):f==="released"?m=new Error("key released"):f==="status-pending"||this.warn(`unhandled key status change "${f}" (keyId: ${a})`),m&&(l.eventNames().length?l.emit("error",m):this.handleError(m))},d=e._onkeystatuseschange=f=>{if(!e.mediaKeysSession){l.emit("error",new Error("invalid state"));return}const m=this.getKeyStatuses(e);if(!Object.keys(m).some(C=>m[C]!=="status-pending"))return;if(m[a]==="expired"){this.log(`Expired key ${le(m)} in key-session "${e.mediaKeysSession.sessionId}"`),this.renewKeySession(e);return}let p=m[a];if(p)u(p,e);else{var I;e.keyStatusTimeouts||(e.keyStatusTimeouts={}),(I=e.keyStatusTimeouts)[a]||(I[a]=self.setTimeout(()=>{if(!e.mediaKeysSession||!this.mediaKeys)return;const T=this.getKeyStatus(e.decryptdata);if(T&&T!=="status-pending")return this.log(`No status for keyId ${a} in key-session "${e.mediaKeysSession.sessionId}". Using session key-status ${T} from other session.`),u(T,e);this.log(`key status for ${a} in key-session "${e.mediaKeysSession.sessionId}" timed out after 1000ms`),p="internal-error",u(p,e)},1e3)),this.log(`No status for keyId ${a} (${le(m)}).`)}};Pe(e.mediaKeysSession,"message",h),Pe(e.mediaKeysSession,"keystatuseschange",d);const A=new Promise((f,g)=>{l.on("error",g),l.on("resolved",f)});return e.mediaKeysSession.generateRequest(t,s).then(()=>{this.log(`Request generated for key-session "${e.mediaKeysSession.sessionId}" keyId: ${a} URI: ${c}`)}).catch(f=>{throw new Ge({type:q.KEY_SYSTEM_ERROR,details:k.KEY_SYSTEM_NO_SESSION,error:f,decryptdata:e.decryptdata,fatal:!1},`Error generating key-session request: ${f}`)}).then(()=>A).catch(f=>(l.removeAllListeners(),this.removeSession(e).then(()=>{throw f}))).then(()=>(l.removeAllListeners(),e))}getKeyStatuses(e){const t={};return e.mediaKeysSession.keyStatuses.forEach((s,i)=>{if(typeof i=="string"&&typeof s=="object"){const a=i;i=s,s=a}const n="buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i);if(e.keySystem===de.PLAYREADY&&n.length===16){const a=Re(n);t[a]=s,oh(n)}const r=Re(n);s==="internal-error"&&(this.bannedKeyIds[r]=s),this.log(`key status change "${s}" for keyStatuses keyId: ${r} key-session "${e.mediaKeysSession.sessionId}"`),t[r]=s}),t}fetchServerCertificate(e){const t=this.config,s=t.loader,i=new s(t),n=this.getServerCertificateUrl(e);return n?(this.log(`Fetching server certificate for "${e}"`),new Promise((r,a)=>{const c={responseType:"arraybuffer",url:n},l=t.certLoadPolicy.default,h={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:(d,A,f,g)=>{r(d.data)},onError:(d,A,f,g)=>{a(new Ge({type:q.KEY_SYSTEM_ERROR,details:k.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:f,response:ne({url:c.url,data:void 0},d)},`"${e}" certificate request failed (${n}). Status: ${d.code} (${d.text})`))},onTimeout:(d,A,f)=>{a(new Ge({type:q.KEY_SYSTEM_ERROR,details:k.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:f,response:{url:c.url,data:void 0}},`"${e}" certificate request timed out (${n})`))},onAbort:(d,A,f)=>{a(new Error("aborted"))}};i.load(c,h,u)})):Promise.resolve()}setMediaKeysServerCertificate(e,t,s){return new Promise((i,n)=>{e.setServerCertificate(s).then(r=>{this.log(`setServerCertificate ${r?"success":"not supported by CDM"} (${s.byteLength}) on "${t}"`),i(e)}).catch(r=>{n(new Ge({type:q.KEY_SYSTEM_ERROR,details:k.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:r,fatal:!0},r.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(s=>this.updateKeySession(e,new Uint8Array(s)).catch(i=>{throw new Ge({type:q.KEY_SYSTEM_ERROR,details:k.KEY_SYSTEM_SESSION_UPDATE_FAILED,decryptdata:e.decryptdata,error:i,fatal:!1},i.message)}))}unpackPlayReadyKeyMessage(e,t){const s=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!s.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const i=new DOMParser().parseFromString(s,"application/xml"),n=i.querySelectorAll("HttpHeader");if(n.length>0){let h;for(let u=0,d=n.length;u<d;u++){var r,a;h=n[u];const A=(r=h.querySelector("name"))==null?void 0:r.textContent,f=(a=h.querySelector("value"))==null?void 0:a.textContent;A&&f&&e.setRequestHeader(A,f)}}const c=i.querySelector("Challenge"),l=c?.textContent;if(!l)throw new Error("Cannot find <Challenge> in key message");return Or(atob(l))}setupLicenseXHR(e,t,s,i){const n=this.config.licenseXhrSetup;return n?Promise.resolve().then(()=>{if(!s.decryptdata)throw new Error("Key removed");return n.call(this.hls,e,t,s,i)}).catch(r=>{if(!s.decryptdata)throw r;return e.open("POST",t,!0),n.call(this.hls,e,t,s,i)}).then(r=>(e.readyState||e.open("POST",t,!0),{xhr:e,licenseChallenge:r||i})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:i}))}requestLicense(e,t){const s=this.config.keyLoadPolicy.default;return new Promise((i,n)=>{const r=this.getLicenseServerUrlOrThrow(e.keySystem);this.log(`Sending license request to URL: ${r}`);const a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return n(new Error("invalid state"));if(a.readyState===4)if(a.status===200){this._requestLicenseFailureCount=0;let c=a.response;this.log(`License received ${c instanceof ArrayBuffer?c.byteLength:c}`);const l=this.config.licenseResponseCallback;if(l)try{c=l.call(this.hls,a,r,e)}catch(h){this.error(h)}i(c)}else{const c=s.errorRetry,l=c?c.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>l||a.status>=400&&a.status<500)n(new Ge({type:q.KEY_SYSTEM_ERROR,details:k.KEY_SYSTEM_LICENSE_REQUEST_FAILED,decryptdata:e.decryptdata,fatal:!0,networkDetails:a,response:{url:r,data:void 0,code:a.status,text:a.statusText}},`License Request XHR failed (${r}). Status: ${a.status} (${a.statusText})`));else{const h=l-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${h} attempts left`),this.requestLicense(e,t).then(i,n)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=a,this.setupLicenseXHR(a,r,e,t).then(({xhr:c,licenseChallenge:l})=>{e.keySystem==de.PLAYREADY&&(l=this.unpackPlayReadyKeyMessage(c,l)),c.send(l)}).catch(n)})}onDestroying(){this.unregisterListeners(),this._clear()}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const s=t.media;this.media=s,Pe(s,"encrypted",this.onMediaEncrypted),Pe(s,"waitingforkey",this.onWaitingForKey);const i=this.mediaResolved;i?i():this.mediaKeys=s.mediaKeys}onMediaDetached(){const e=this.media;e&&(Ue(e,"encrypted",this.onMediaEncrypted),Ue(e,"waitingforkey",this.onWaitingForKey),this.media=null,this.mediaKeys=null)}_clear(){var e;this._requestLicenseFailureCount=0,this.keyIdToKeySessionPromise={},this.bannedKeyIds={};const t=this.mediaResolved;if(t&&t(),!this.mediaKeys&&!this.mediaKeySessions.length)return;const s=this.media,i=this.mediaKeySessions.slice();this.mediaKeySessions=[],this.mediaKeys=null,Kt.clearKeyUriToKeyIdMap();const n=i.length;Ds.CDMCleanupPromise=Promise.all(i.map(r=>this.removeSession(r)).concat((s==null||(e=s.setMediaKeys(null))==null?void 0:e.catch(r=>{this.log(`Could not clear media keys: ${r}`),this.hls&&this.hls.trigger(y.ERROR,{type:q.OTHER_ERROR,details:k.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:new Error(`Could not clear media keys: ${r}`)})}))||Promise.resolve())).catch(r=>{this.log(`Could not close sessions and clear media keys: ${r}`),this.hls&&this.hls.trigger(y.ERROR,{type:q.OTHER_ERROR,details:k.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close sessions and clear media keys: ${r}`)})}).then(()=>{n&&this.log("finished closing key sessions and clearing media keys")})}onManifestLoading(){this._clear()}onManifestLoaded(e,{sessionKeys:t}){if(!(!t||!this.config.emeEnabled)&&!this.keyFormatPromise){const s=t.reduce((i,n)=>(i.indexOf(n.keyFormat)===-1&&i.push(n.keyFormat),i),[]);this.log(`Selecting key-system from session-keys ${s.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(s)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:s,decryptdata:i}=e;if(t){this.log(`Remove licenses and keys and close session "${t.sessionId}" keyId: ${Re(i?.keyId||[])}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),s&&s.readyState!==XMLHttpRequest.DONE&&s.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const n=this.mediaKeySessions.indexOf(e);n>-1&&this.mediaKeySessions.splice(n,1);const{keyStatusTimeouts:r}=e;r&&Object.keys(r).forEach(l=>self.clearTimeout(r[l]));const{drmSystemOptions:a}=this.config;return(Vf(a)?new Promise((l,h)=>{self.setTimeout(()=>h(new Error("MediaKeySession.remove() timeout")),8e3),t.remove().then(l).catch(h)}):Promise.resolve()).catch(l=>{this.log(`Could not remove session: ${l}`),this.hls&&this.hls.trigger(y.ERROR,{type:q.OTHER_ERROR,details:k.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:new Error(`Could not remove session: ${l}`)})}).then(()=>t.close()).catch(l=>{this.log(`Could not close session: ${l}`),this.hls&&this.hls.trigger(y.ERROR,{type:q.OTHER_ERROR,details:k.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close session: ${l}`)})})}return Promise.resolve()}}Ds.CDMCleanupPromise=void 0;function xi(o){if(!o)throw new Error("Could not read keyId of undefined decryptdata");if(o.keyId===null)throw new Error("keyId is null");return Re(o.keyId)}function hp(o,e){if(o.keyId&&e.mediaKeysSession.keyStatuses.has(o.keyId))return e.mediaKeysSession.keyStatuses.get(o.keyId);if(o.matches(e.decryptdata))return e.keyStatus}class Ge extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}function Tl(o,e){const t=o==="output-restricted",s=t?k.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:k.KEY_SYSTEM_STATUS_INTERNAL_ERROR;return new Ge({type:q.KEY_SYSTEM_ERROR,details:s,fatal:!1,decryptdata:e},t?"HDCP level output restricted":`key status changed to "${o}"`)}class up{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(y.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListeners(){this.hls.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(y.MEDIA_DETACHING,this.onMediaDetaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const s=this.hls.config;if(s.capLevelOnFPSDrop){const i=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=i,i&&typeof i.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),s.fpsDroppedMonitoringPeriod)}}onMediaDetaching(){this.media=null}checkFPS(e,t,s){const i=performance.now();if(t){if(this.lastTime){const n=i-this.lastTime,r=s-this.lastDroppedFrames,a=t-this.lastDecodedFrames,c=1e3*r/n,l=this.hls;if(l.trigger(y.FPS_DROP,{currentDropped:r,currentDecoded:a,totalDroppedFrames:s}),c>0&&r>l.config.fpsDroppedMonitoringThreshold*a){let h=l.currentLevel;l.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+h),h>0&&(l.autoLevelCapping===-1||l.autoLevelCapping>=h)&&(h=h-1,l.trigger(y.FPS_DROP_LEVEL_CAPPING,{level:h,droppedLevel:l.currentLevel}),l.autoLevelCapping=h,this.streamController.nextLevelSwitch())}}this.lastTime=i,this.lastDroppedFrames=s,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}function zh(o,e){let t;try{t=new Event("addtrack")}catch{t=document.createEvent("Event"),t.initEvent("addtrack",!1,!1)}t.track=o,e.dispatchEvent(t)}function Zh(o,e){const t=o.mode;if(t==="disabled"&&(o.mode="hidden"),o.cues&&!o.cues.getCueById(e.id))try{if(o.addCue(e),!o.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(s){re.debug(`[texttrack-utils]: ${s}`);try{const i=new self.TextTrackCue(e.startTime,e.endTime,e.text);i.id=e.id,o.addCue(i)}catch(i){re.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${i}`)}}t==="disabled"&&(o.mode=t)}function xs(o,e){const t=o.mode;if(t==="disabled"&&(o.mode="hidden"),o.cues)for(let s=o.cues.length;s--;)e&&o.cues[s].removeEventListener("enter",e),o.removeCue(o.cues[s]);t==="disabled"&&(o.mode=t)}function qr(o,e,t,s){const i=o.mode;if(i==="disabled"&&(o.mode="hidden"),o.cues&&o.cues.length>0){const n=Ap(o.cues,e,t);for(let r=0;r<n.length;r++)(!s||s(n[r]))&&o.removeCue(n[r])}i==="disabled"&&(o.mode=i)}function dp(o,e){if(e<=o[0].startTime)return 0;const t=o.length-1;if(e>o[t].endTime)return-1;let s=0,i=t,n;for(;s<=i;)if(n=Math.floor((i+s)/2),e<o[n].startTime)i=n-1;else if(e>o[n].startTime&&s<t)s=n+1;else return n;return o[s].startTime-e<e-o[i].startTime?s:i}function Ap(o,e,t){const s=[],i=dp(o,e);if(i>-1)for(let n=i,r=o.length;n<r;n++){const a=o[n];if(a.startTime>=e&&a.endTime<=t)s.push(a);else if(a.startTime>t)return s}return s}function sn(o){const e=[];for(let t=0;t<o.length;t++){const s=o[t];(s.kind==="subtitles"||s.kind==="captions")&&s.label&&e.push(o[t])}return e}class fp extends Uo{constructor(e){super(e,"subtitle-track-controller"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=null;const s=sn(this.media.textTracks);for(let n=0;n<s.length;n++)if(s[n].mode==="hidden")t=s[n];else if(s[n].mode==="showing"){t=s[n];break}const i=this.findTrackForTextTrack(t);this.subtitleTrack!==i&&this.setSubtitleTrack(i)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.LEVEL_LOADING,this.onLevelLoading,this),e.on(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(y.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.LEVEL_LOADING,this.onLevelLoading,this),e.off(y.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(y.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(e,t){const s=this.media;if(!s)return;const i=!!t.transferMedia;if(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||s.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,i)return;sn(s.textTracks).forEach(r=>{xs(r)})}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:s,groupId:i,details:n}=t,r=this.tracksInGroup[s];if(!r||r.groupId!==i){this.warn(`Subtitle track with id:${s} and group:${i} not found in active group ${r?.groupId}`);return}const a=r.details;r.details=t.details,this.log(`Subtitle track ${s} "${r.name}" lang:${r.lang} group:${i} loaded [${n.startSN}-${n.endSN}]`),s===this.trackId&&this.playlistLoaded(s,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const s=t.subtitleGroups||null,i=this.groupIds;let n=this.currentTrack;if(!s||i?.length!==s?.length||s!=null&&s.some(r=>i?.indexOf(r)===-1)){this.groupIds=s,this.trackId=-1,this.currentTrack=null;const r=this.tracks.filter(h=>!s||s.indexOf(h.groupId)!==-1);if(r.length)this.selectDefaultTrack&&!r.some(h=>h.default)&&(this.selectDefaultTrack=!1),r.forEach((h,u)=>{h.id=u});else if(!n&&!this.tracksInGroup.length)return;this.tracksInGroup=r;const a=this.hls.config.subtitlePreference;if(!n&&a){this.selectDefaultTrack=!1;const h=mt(a,r);if(h>-1)n=r[h];else{const u=mt(a,this.tracks);n=this.tracks[u]}}let c=this.findTrackId(n);c===-1&&n&&(c=this.findTrackId(null));const l={subtitleTracks:r};this.log(`Updating subtitle tracks, ${r.length} track(s) found in "${s?.join(",")}" group-id`),this.hls.trigger(y.SUBTITLE_TRACKS_UPDATED,l),c!==-1&&this.trackId===-1&&this.setSubtitleTrack(c)}}findTrackId(e){const t=this.tracksInGroup,s=this.selectDefaultTrack;for(let i=0;i<t.length;i++){const n=t[i];if(!(s&&!n.default||!s&&!e)&&(!e||ns(n,e)))return i}if(e){for(let i=0;i<t.length;i++){const n=t[i];if(Ai(e.attrs,n.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return i}for(let i=0;i<t.length;i++){const n=t[i];if(Ai(e.attrs,n.attrs,["LANGUAGE"]))return i}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let s=0;s<t.length;s++){const i=t[s];if(Kr(i,e))return s}}return-1}onError(e,t){t.fatal||!t.context||t.context.type===Z.SUBTITLE_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){if(e.id===-1)return this.setSubtitleTrack(-1),null;const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const s=this.currentTrack;if(s&&ns(e,s))return s;const i=mt(e,this.tracksInGroup);if(i>-1){const n=this.tracksInGroup[i];return this.setSubtitleTrack(i),n}else{if(s)return null;{const n=mt(e,t);if(n>-1)return t[n]}}}}return null}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const s=e.id,i=e.groupId,n=this.getUrlWithDirectives(e.url,t),r=e.details,a=r?.age;this.log(`Loading subtitle ${s} "${e.name}" lang:${e.lang} group:${i}${t?.msn!==void 0?" at sn "+t.msn+" part "+t.part:""}${a&&r.live?" age "+a.toFixed(1)+(r.type&&" "+r.type||""):""} ${n}`),this.hls.trigger(y.SUBTITLE_TRACK_LOADING,{url:n,id:s,groupId:i,deliveryDirectives:t||null,track:e})}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=sn(e.textTracks),s=this.currentTrack;let i;if(s&&(i=t.filter(n=>Kr(s,n))[0],i||this.warn(`Unable to find subtitle TextTrack with name "${s.name}" and language "${s.lang}"`)),[].slice.call(t).forEach(n=>{n.mode!=="disabled"&&n!==i&&(n.mode="disabled")}),i){const n=this.subtitleDisplay?"showing":"hidden";i.mode!==n&&(i.mode=n)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(e<-1||e>=t.length||!K(e)){this.warn(`Invalid subtitle track id: ${e}`);return}this.selectDefaultTrack=!1;const s=this.currentTrack,i=t[e]||null;if(this.trackId=e,this.currentTrack=i,this.toggleTrackModes(),!i){this.hls.trigger(y.SUBTITLE_TRACK_SWITCH,{id:e});return}const n=!!i.details&&!i.details.live;if(e===this.trackId&&i===s&&n)return;this.log(`Switching to subtitle-track ${e}`+(i?` "${i.name}" lang:${i.lang} group:${i.groupId}`:""));const{id:r,groupId:a="",name:c,type:l,url:h}=i;this.hls.trigger(y.SUBTITLE_TRACK_SWITCH,{id:r,groupId:a,name:c,type:l,url:h});const u=this.switchParams(i.url,s?.details,i.details);this.loadPlaylist(u)}}function gp(){try{return crypto.randomUUID()}catch{try{const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch{let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,i=>{const n=(t+Math.random()*16)%16|0;return t=Math.floor(t/16),(i=="x"?n:n&3|8).toString(16)})}}}function ii(o){let e=5381,t=o.length;for(;t;)e=e*33^o.charCodeAt(--t);return(e>>>0).toString()}const bs=.025;let In=(function(o){return o[o.Point=0]="Point",o[o.Range=1]="Range",o})({});function mp(o,e,t){return`${o.identifier}-${t+1}-${ii(e)}`}class pp{constructor(e,t){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=t,this.dateRange=e,this.setDateRange(e)}setDateRange(e){this.dateRange=e,this.resumeOffset=e.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=e.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=e.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=e.attr.enumeratedStringList("X-SNAP",this.snapOptions)}reset(){var e;this.appendInPlaceStarted=!1,(e=this.assetListLoader)==null||e.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)}isAssetPastPlayoutLimit(e){var t;if(e>0&&e>=this.assetList.length)return!0;const s=this.playoutLimit;return e<=0||isNaN(s)?!1:s===0?!0:(((t=this.assetList[e])==null?void 0:t.startOffset)||0)>s}findAssetIndex(e){return this.assetList.indexOf(e)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){const e=this.dateRange.startTime;if(this.snapOptions.out){const t=this.dateRange.tagAnchor;if(t)return $n(e,t)}return e}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(this.startTime===0||this.snapOptions.out)return!0;const e=this.dateRange.tagAnchor;if(e){const t=this.dateRange.startTime,s=$n(t,e);return t-s<.1}return!1}get resumptionOffset(){const e=this.resumeOffset,t=K(e)?e:this.duration;return this.cumulativeDuration+t}get resumeTime(){const e=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){const t=this.resumeAnchor;if(t)return $n(e,t)}return e}get appendInPlace(){return this.appendInPlaceStarted?!0:this.appendInPlaceDisabled?!1:!!(!this.cue.once&&!this.cue.pre&&this.startIsAligned&&(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<bs))}set appendInPlace(e){if(this.appendInPlaceStarted){this.resetOnResume=!e;return}this.appendInPlaceDisabled=!e}get timelineStart(){return this._timelineStart!==null?this._timelineStart:this.startTime}set timelineStart(e){this._timelineStart=e}get duration(){const e=this.playoutLimit;let t;return this._duration!==null?t=this._duration:this.dateRange.duration?t=this.dateRange.duration:t=this.dateRange.plannedDuration||0,!isNaN(e)&&e<t&&(t=e),t}set duration(e){this._duration=e}get cue(){return this.dateRange.cue}get timelineOccupancy(){return this.dateRange.attr["X-TIMELINE-OCCUPIES"]==="RANGE"?In.Range:In.Point}get supplementsPrimary(){return this.dateRange.attr["X-TIMELINE-STYLE"]==="PRIMARY"}get contentMayVary(){return this.dateRange.attr["X-CONTENT-MAY-VARY"]!=="NO"}get assetUrl(){return this.dateRange.attr["X-ASSET-URI"]}get assetListUrl(){return this.dateRange.attr["X-ASSET-LIST"]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||this.assetListResponse!==null}toString(){return Ep(this)}}function $n(o,e){return o-e.start<e.duration/2&&!(Math.abs(o-(e.start+e.duration))<bs)?e.start:e.start+e.duration}function eu(o,e,t){const s=new self.URL(o,t);return s.protocol!=="data:"&&s.searchParams.set("_HLS_primary_id",e),s}function Vn(o,e){for(;(t=o.assetList[++e])!=null&&t.error;)var t;return e}function Ep(o){return`["${o.identifier}" ${o.cue.pre?"<pre>":o.cue.post?"<post>":""}${o.timelineStart.toFixed(2)}-${o.resumeTime.toFixed(2)}]`}function Ts(o){const e=o.timelineStart,t=o.duration||0;return`["${o.identifier}" ${e.toFixed(2)}-${(e+t).toFixed(2)}]`}class Ip{constructor(e,t,s,i){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{this.reachedPlayout(this.currentTime)&&this.hls&&this.hls.trigger(y.PLAYOUT_LIMIT_REACHED,{})};const n=this.hls=new e(t);this.interstitial=s,this.assetItem=i;const r=()=>{this.hasDetails=!0};n.once(y.LEVEL_LOADED,r),n.once(y.AUDIO_TRACK_LOADED,r),n.once(y.SUBTITLE_TRACK_LOADED,r),n.on(y.MEDIA_ATTACHING,(a,{media:c})=>{this.removeMediaListeners(),this.mediaAttached=c,this.interstitial.playoutLimit&&(c.addEventListener("timeupdate",this.checkPlayout),this.appendInPlace&&n.on(y.BUFFER_APPENDED,()=>{const h=this.bufferedEnd;this.reachedPlayout(h)&&(this._bufferedEosTime=h,n.trigger(y.BUFFERED_TO_END,void 0))}))})}get appendInPlace(){return this.interstitial.appendInPlace}loadSource(){const e=this.hls;if(e)if(e.url)e.levels.length&&!e.started&&e.startLoad(-1,!0);else{let t=this.assetItem.uri;try{t=eu(t,e.config.primarySessionId||"").href}catch{}e.loadSource(t)}}bufferedInPlaceToEnd(e){var t;if(!this.appendInPlace)return!1;if((t=this.hls)!=null&&t.bufferedToEnd)return!0;if(!e)return!1;const s=Math.min(this._bufferedEosTime||1/0,this.duration),i=this.timelineOffset,n=J.bufferInfo(e,i,0);return this.getAssetTime(n.end)>=s-.02}reachedPlayout(e){const s=this.interstitial.playoutLimit;return this.startOffset+e>=s}get destroyed(){var e;return!((e=this.hls)!=null&&e.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){var e;return((e=this.hls)==null?void 0:e.media)||null}get bufferedEnd(){const e=this.media||this.mediaAttached;if(!e)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;const t=J.bufferInfo(e,e.currentTime,.001);return this.getAssetTime(t.end)}get currentTime(){const e=this.media||this.mediaAttached;return e?this.getAssetTime(e.currentTime):this._currentTime||0}get duration(){const e=this.assetItem.duration;if(!e)return 0;const t=this.interstitial.playoutLimit;if(t){const s=t-this.startOffset;if(s>0&&s<e)return s}return e}get remaining(){const e=this.duration;return e?Math.max(0,e-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){var e;return((e=this.hls)==null?void 0:e.config.timelineOffset)||0}set timelineOffset(e){const t=this.timelineOffset;if(e!==t){const s=e-t;if(Math.abs(s)>1/9e4&&this.hls){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=e}}}getAssetTime(e){const t=this.timelineOffset,s=this.duration;return Math.min(Math.max(0,e-t),s)}removeMediaListeners(){const e=this.mediaAttached;e&&(this._currentTime=e.currentTime,this.bufferSnapShot(),e.removeEventListener("timeupdate",this.checkPlayout))}bufferSnapShot(){if(this.mediaAttached){var e;(e=this.hls)!=null&&e.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd)}}destroy(){this.removeMediaListeners(),this.hls&&this.hls.destroy(),this.hls=null,this.tracks=this.mediaAttached=this.checkPlayout=null}attachMedia(e){var t;this.loadSource(),(t=this.hls)==null||t.attachMedia(e)}detachMedia(){var e;this.removeMediaListeners(),this.mediaAttached=null,(e=this.hls)==null||e.detachMedia()}resumeBuffering(){var e;(e=this.hls)==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.hls)==null||e.pauseBuffering()}transferMedia(){var e;return this.bufferSnapShot(),((e=this.hls)==null?void 0:e.transferMedia())||null}resetDetails(){const e=this.hls;if(e&&this.hasDetails){e.stopLoad();const t=s=>delete s.details;e.levels.forEach(t),e.allAudioTracks.forEach(t),e.allSubtitleTracks.forEach(t),this.hasDetails=!1}}on(e,t,s){var i;(i=this.hls)==null||i.on(e,t)}once(e,t,s){var i;(i=this.hls)==null||i.once(e,t)}off(e,t,s){var i;(i=this.hls)==null||i.off(e,t)}toString(){var e;return`HlsAssetPlayer: ${Ts(this.assetItem)} ${(e=this.hls)==null?void 0:e.sessionId} ${this.appendInPlace?"append-in-place":""}`}}const Sl=.033;class yp extends st{constructor(e,t){super("interstitials-sched",t),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=e}destroy(){this.reset(),this.onScheduleUpdate=null}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(e=>e.reset()),this.events=this.items=null}resetErrorsInRange(e,t){return this.events?this.events.reduce((s,i)=>e<=i.startOffset&&t>i.startOffset?(delete i.error,s+1):s,0):0}get duration(){const e=this.items;return e?e[e.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(e){return e&&this.eventMap[e]||null}hasEvent(e){return e in this.eventMap}findItemIndex(e,t){if(e.event)return this.findEventIndex(e.event.identifier);let s=-1;e.nextEvent?s=this.findEventIndex(e.nextEvent.identifier)-1:e.previousEvent&&(s=this.findEventIndex(e.previousEvent.identifier)+1);const i=this.items;if(i)for(i[s]||(t===void 0&&(t=e.start),s=this.findItemIndexAtTime(t));s>=0&&(n=i[s])!=null&&n.event;){var n;s--}return s}findItemIndexAtTime(e,t){const s=this.items;if(s)for(let i=0;i<s.length;i++){let n=s[i];if(t&&t!=="primary"&&(n=n[t]),e===n.start||e>n.start&&e<n.end)return i}return-1}findJumpRestrictedIndex(e,t){const s=this.items;if(s)for(let i=e;i<=t&&s[i];i++){const n=s[i].event;if(n!=null&&n.restrictions.jump&&!n.appendInPlace)return i}return-1}findEventIndex(e){const t=this.items;if(t)for(let i=t.length;i--;){var s;if(((s=t[i].event)==null?void 0:s.identifier)===e)return i}return-1}findAssetIndex(e,t){const s=e.assetList,i=s.length;if(i>1)for(let n=0;n<i;n++){const r=s[n];if(!r.error){const a=r.timelineStart;if(t===a||t>a&&(t<a+(r.duration||0)||n===i-1))return n}}return 0}get assetIdAtEnd(){var e;const t=(e=this.items)==null||(e=e[this.length-1])==null?void 0:e.event;if(t){const s=t.assetList,i=s[s.length-1];if(i)return i.identifier}return null}parseInterstitialDateRanges(e,t){const s=e.main.details,{dateRanges:i}=s,n=this.events,r=this.parseDateRanges(i,{url:s.url},t),a=Object.keys(i),c=n?n.filter(l=>!a.includes(l.identifier)):[];r.length&&r.sort((l,h)=>{const u=l.cue.pre,d=l.cue.post,A=h.cue.pre,f=h.cue.post;if(u&&!A)return-1;if(A&&!u||d&&!f)return 1;if(f&&!d)return-1;if(!u&&!A&&!d&&!f){const g=l.startTime,m=h.startTime;if(g!==m)return g-m}return l.dateRange.tagOrder-h.dateRange.tagOrder}),this.events=r,c.forEach(l=>{this.removeEvent(l)}),this.updateSchedule(e,c)}updateSchedule(e,t=[],s=!1){const i=this.events||[];if(i.length||t.length||this.length<2){const n=this.items,r=this.parseSchedule(i,e);(s||t.length||n?.length!==r.length||r.some((c,l)=>Math.abs(c.playout.start-n[l].playout.start)>.005||Math.abs(c.playout.end-n[l].playout.end)>.005))&&(this.items=r,this.onScheduleUpdate(t,n))}}parseDateRanges(e,t,s){const i=[],n=Object.keys(e);for(let r=0;r<n.length;r++){const a=n[r],c=e[a];if(c.isInterstitial){let l=this.eventMap[a];l?l.setDateRange(c):(l=new pp(c,t),this.eventMap[a]=l,s===!1&&(l.appendInPlace=s)),i.push(l)}}return i}parseSchedule(e,t){const s=[],i=t.main.details,n=i.live?1/0:i.edge;let r=0;if(e=e.filter(c=>!c.error&&!(c.cue.once&&c.hasPlayed)),e.length){this.resolveOffsets(e,t);let c=0,l=0;if(e.forEach((h,u)=>{const d=h.cue.pre,A=h.cue.post,f=e[u-1]||null,g=h.appendInPlace,m=A?n:h.startOffset,E=h.duration,p=h.timelineOccupancy===In.Range?E:0,I=h.resumptionOffset,C=f?.startTime===m,T=m+h.cumulativeDuration;let L=g?T+E:m+I;if(d||!A&&m<=0){const x=l;l+=p,h.timelineStart=T;const v=r;r+=E,s.push({event:h,start:T,end:L,playout:{start:v,end:r},integrated:{start:x,end:l}})}else if(m<=n){if(!C){const B=m-c;if(B>Sl){const R=c,D=l;l+=B;const b=r;r+=B;const w={previousEvent:e[u-1]||null,nextEvent:h,start:R,end:R+B,playout:{start:b,end:r},integrated:{start:D,end:l}};s.push(w)}else B>0&&f&&(f.cumulativeDuration+=B,s[s.length-1].end=m)}A&&(L=T),h.timelineStart=T;const x=l;l+=p;const v=r;r+=E,s.push({event:h,start:T,end:L,playout:{start:v,end:r},integrated:{start:x,end:l}})}else return;const S=h.resumeTime;A||S>n?c=n:c=S}),c<n){var a;const h=c,u=l,d=n-c;l+=d;const A=r;r+=d,s.push({previousEvent:((a=s[s.length-1])==null?void 0:a.event)||null,nextEvent:null,start:c,end:h+d,playout:{start:A,end:r},integrated:{start:u,end:l}})}this.setDurations(n,r,l)}else s.push({previousEvent:null,nextEvent:null,start:0,end:n,playout:{start:0,end:n},integrated:{start:0,end:n}}),this.setDurations(n,n,n);return s}setDurations(e,t,s){this.durations={primary:e,playout:t,integrated:s}}resolveOffsets(e,t){const s=t.main.details,i=s.live?1/0:s.edge;let n=0,r=-1;e.forEach((a,c)=>{const l=a.cue.pre,h=a.cue.post,u=l?0:h?i:a.startTime;this.updateAssetDurations(a),r===u?a.cumulativeDuration=n:(n=0,r=u),!h&&a.snapOptions.in&&(a.resumeAnchor=rs(null,s.fragments,a.startOffset+a.resumptionOffset,0,0)||void 0),a.appendInPlace&&!a.appendInPlaceStarted&&(this.primaryCanResumeInPlaceAt(a,t)||(a.appendInPlace=!1)),!a.appendInPlace&&c+1<e.length&&e[c+1].startTime-e[c].resumeTime<Sl&&(e[c+1].appendInPlace=!1,e[c+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${a}`));const A=K(a.resumeOffset)?a.resumeOffset:a.duration;n+=A})}primaryCanResumeInPlaceAt(e,t){const s=e.resumeTime,i=e.startTime+e.resumptionOffset;return Math.abs(s-i)>bs?(this.log(`"${e.identifier}" resumption ${s} not aligned with estimated timeline end ${i}`),!1):!Object.keys(t).some(r=>{const a=t[r].details,c=a.edge;if(s>=c)return this.log(`"${e.identifier}" resumption ${s} past ${r} playlist end ${c}`),!1;const l=rs(null,a.fragments,s);if(!l)return this.log(`"${e.identifier}" resumption ${s} does not align with any fragments in ${r} playlist (${a.fragStart}-${a.fragmentEnd})`),!0;const h=r==="audio"?.175:0;return Math.abs(l.start-s)<bs+h||Math.abs(l.end-s)<bs+h?!1:(this.log(`"${e.identifier}" resumption ${s} not aligned with ${r} fragment bounds (${l.start}-${l.end} sn: ${l.sn} cc: ${l.cc})`),!0)})}updateAssetDurations(e){if(!e.assetListLoaded)return;const t=e.timelineStart;let s=0,i=!1,n=!1;for(let r=0;r<e.assetList.length;r++){const a=e.assetList[r],c=t+s;a.startOffset=s,a.timelineStart=c,i||(i=a.duration===null),n||(n=!!a.error);const l=a.error?0:a.duration||0;s+=l}i&&!n?e.duration=Math.max(s,e.duration):e.duration=s}removeEvent(e){e.reset(),delete this.eventMap[e.identifier]}}function nt(o){return`[${o.event?'"'+o.event.identifier+'"':"primary"}: ${o.start.toFixed(2)}-${o.end.toFixed(2)}]`}class Cp{constructor(e){this.hls=void 0,this.hls=e}destroy(){this.hls=null}loadAssetList(e,t){const s=e.assetListUrl;let i;try{i=eu(s,this.hls.sessionId,e.baseUrl)}catch(d){const A=this.assignAssetListError(e,k.ASSET_LIST_LOAD_ERROR,d,s);this.hls.trigger(y.ERROR,A);return}t&&i.protocol!=="data:"&&i.searchParams.set("_HLS_start_offset",""+t);const n=this.hls.config,r=n.loader,a=new r(n),c={responseType:"json",url:i.href},l=n.interstitialAssetListLoadPolicy.default,h={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:(d,A,f,g)=>{const m=d.data,E=m?.ASSETS;if(!Array.isArray(E)){const p=this.assignAssetListError(e,k.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),f.url,A,g);this.hls.trigger(y.ERROR,p);return}e.assetListResponse=m,this.hls.trigger(y.ASSET_LIST_LOADED,{event:e,assetListResponse:m,networkDetails:g})},onError:(d,A,f,g)=>{const m=this.assignAssetListError(e,k.ASSET_LIST_LOAD_ERROR,new Error(`Error loading X-ASSET-LIST: HTTP status ${d.code} ${d.text} (${A.url})`),A.url,g,f);this.hls.trigger(y.ERROR,m)},onTimeout:(d,A,f)=>{const g=this.assignAssetListError(e,k.ASSET_LIST_LOAD_TIMEOUT,new Error(`Timeout loading X-ASSET-LIST (${A.url})`),A.url,d,f);this.hls.trigger(y.ERROR,g)}};return a.load(c,h,u),this.hls.trigger(y.ASSET_LIST_LOADING,{event:e}),a}assignAssetListError(e,t,s,i,n,r){return e.error=s,{type:q.NETWORK_ERROR,details:t,fatal:!1,interstitial:e,url:i,error:s,networkDetails:r,stats:n}}}function Bl(o){var e;o==null||(e=o.play())==null||e.catch(()=>{})}function vi(o,e){return`[${o}] Advancing timeline position to ${e}`}class Tp extends st{constructor(e,t){super("interstitials",e.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=!1,this.onPlay=()=>{this.shouldPlay=!0},this.onPause=()=>{this.shouldPlay=!1},this.onSeeking=()=>{const s=this.currentTime;if(s===void 0||this.playbackDisabled||!this.schedule)return;const i=s-this.timelinePos;if(Math.abs(i)<1/7056e5)return;const r=i<=-.01;this.timelinePos=s,this.bufferedPos=s;const a=this.playingItem;if(!a){this.checkBuffer();return}if(r&&this.schedule.resetErrorsInRange(s,s-i)&&this.updateSchedule(!0),this.checkBuffer(),r&&s<a.start||s>=a.end){var c;const A=this.findItemIndex(a);let f=this.schedule.findItemIndexAtTime(s);if(f===-1&&(f=A+(r?-1:1),this.log(`seeked ${r?"back ":""}to position not covered by schedule ${s} (resolving from ${A} to ${f})`)),!this.isInterstitial(a)&&(c=this.media)!=null&&c.paused&&(this.shouldPlay=!1),!r&&f>A){const g=this.schedule.findJumpRestrictedIndex(A+1,f);if(g>A){this.setSchedulePosition(g);return}}this.setSchedulePosition(f);return}const l=this.playingAsset;if(!l){if(this.playingLastItem&&this.isInterstitial(a)){const A=a.event.assetList[0];A&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(s,A))}return}const h=l.timelineStart,u=l.duration||0;if(r&&s<h||s>=h+u){var d;(d=a.event)!=null&&d.appendInPlace&&(this.clearAssetPlayers(a.event,a),this.flushFrontBuffer(s)),this.setScheduleToAssetAtTime(s,l)}},this.onTimeupdate=()=>{const s=this.currentTime;if(s===void 0||this.playbackDisabled)return;if(s>this.timelinePos)this.timelinePos=s,s>this.bufferedPos&&this.checkBuffer();else return;const i=this.playingItem;if(!i||this.playingLastItem)return;if(s>=i.end){this.timelinePos=i.end;const a=this.findItemIndex(i);this.setSchedulePosition(a+1)}const n=this.playingAsset;if(!n)return;const r=n.timelineStart+(n.duration||0);s>=r&&this.setScheduleToAssetAtTime(s,n)},this.onScheduleUpdate=(s,i)=>{const n=this.schedule;if(!n)return;const r=this.playingItem,a=n.events||[],c=n.items||[],l=n.durations,h=s.map(g=>g.identifier),u=!!(a.length||h.length);(u||i)&&this.log(`INTERSTITIALS_UPDATED (${a.length}): ${a}
Schedule: ${c.map(g=>nt(g))} pos: ${this.timelinePos}`),h.length&&this.log(`Removed events ${h}`);let d=null,A=null;r&&(d=this.updateItem(r,this.timelinePos),this.itemsMatch(r,d)?this.playingItem=d:this.waitingItem=this.endedItem=null),this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);const f=this.bufferingItem;if(f&&(A=this.updateItem(f,this.bufferedPos),this.itemsMatch(f,A)?this.bufferingItem=A:f.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(f.event,null))),s.forEach(g=>{g.assetList.forEach(m=>{this.clearAssetPlayer(m.identifier,null)})}),this.playerQueue.forEach(g=>{if(g.interstitial.appendInPlace){const m=g.assetItem.timelineStart,E=g.timelineOffset-m;if(E)try{g.timelineOffset=m}catch(p){Math.abs(E)>bs&&this.warn(`${p} ("${g.assetId}" ${g.timelineOffset}->${m})`)}}}),u||i){if(this.hls.trigger(y.INTERSTITIALS_UPDATED,{events:a.slice(0),schedule:c.slice(0),durations:l,removedIds:h}),this.isInterstitial(r)&&h.includes(r.event.identifier)){this.warn(`Interstitial "${r.event.identifier}" removed while playing`),this.primaryFallback(r.event);return}r&&this.trimInPlace(d,r),f&&A!==d&&this.trimInPlace(A,f),this.checkBuffer()}},this.hls=e,this.HlsPlayerClass=t,this.assetListLoader=new Cp(e),this.schedule=new yp(this.onScheduleUpdate,e.logger),this.registerListeners()}registerListeners(){const e=this.hls;e&&(e.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(y.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.on(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(y.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.on(y.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.on(y.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.on(y.BUFFER_APPENDED,this.onBufferAppended,this),e.on(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(y.BUFFERED_TO_END,this.onBufferedToEnd,this),e.on(y.MEDIA_ENDED,this.onMediaEnded,this),e.on(y.ERROR,this.onError,this),e.on(y.DESTROYING,this.onDestroying,this))}unregisterListeners(){const e=this.hls;e&&(e.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(y.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.off(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(y.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.off(y.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.off(y.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.off(y.BUFFER_CODECS,this.onBufferCodecs,this),e.off(y.BUFFER_APPENDED,this.onBufferAppended,this),e.off(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(y.BUFFERED_TO_END,this.onBufferedToEnd,this),e.off(y.MEDIA_ENDED,this.onMediaEnded,this),e.off(y.ERROR,this.onError,this),e.off(y.DESTROYING,this.onDestroying,this))}startLoad(){this.resumeBuffering()}stopLoad(){this.pauseBuffering()}resumeBuffering(){var e;(e=this.getBufferingPlayer())==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.getBufferingPlayer())==null||e.pauseBuffering()}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.schedule=this.manager=null,this.hls=this.HlsPlayerClass=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null}onDestroying(){const e=this.primaryMedia||this.media;e&&this.removeMediaListeners(e)}removeMediaListeners(e){Ue(e,"play",this.onPlay),Ue(e,"pause",this.onPause),Ue(e,"seeking",this.onSeeking),Ue(e,"timeupdate",this.onTimeupdate)}onMediaAttaching(e,t){const s=this.media=t.media;Pe(s,"seeking",this.onSeeking),Pe(s,"timeupdate",this.onTimeupdate),Pe(s,"play",this.onPlay),Pe(s,"pause",this.onPause)}onMediaAttached(e,t){const s=this.effectivePlayingItem,i=this.detachedData;if(this.detachedData=null,s===null)this.checkStart();else if(!i){this.clearScheduleState();const n=this.findItemIndex(s);this.setSchedulePosition(n)}}clearScheduleState(){this.log("clear schedule state"),this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null}onMediaDetaching(e,t){const s=!!t.transferMedia,i=this.media;if(this.media=null,!s&&(i&&this.removeMediaListeners(i),this.detachedData)){const n=this.getBufferingPlayer();n&&(this.log(`Removing schedule state for detachedData and ${n}`),this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,n.detachMedia()),this.shouldPlay=!1}}get interstitialsManager(){if(!this.hls)return null;if(this.manager)return this.manager;const e=this,t=()=>e.bufferingItem||e.waitingItem,s=u=>u&&e.getAssetPlayer(u.identifier),i=(u,d,A,f,g)=>{if(u){let m=u[d].start;const E=u.event;if(E){if(d==="playout"||E.timelineOccupancy!==In.Point){const p=s(A);p?.interstitial===E&&(m+=p.assetItem.startOffset+p[g])}}else{const p=f==="bufferedPos"?r():e[f];m+=p-u.start}return m}return 0},n=(u,d)=>{var A;if(u!==0&&d!=="primary"&&(A=e.schedule)!=null&&A.length){var f;const g=e.schedule.findItemIndexAtTime(u),m=(f=e.schedule.items)==null?void 0:f[g];if(m){const E=m[d].start-m.start;return u+E}}return u},r=()=>{const u=e.bufferedPos;return u===Number.MAX_VALUE?a("primary"):Math.max(u,0)},a=u=>{var d,A;return(d=e.primaryDetails)!=null&&d.live?e.primaryDetails.edge:((A=e.schedule)==null?void 0:A.durations[u])||0},c=(u,d)=>{var A,f;const g=e.effectivePlayingItem;if(g!=null&&(A=g.event)!=null&&A.restrictions.skip||!e.schedule)return;e.log(`seek to ${u} "${d}"`);const m=e.effectivePlayingItem,E=e.schedule.findItemIndexAtTime(u,d),p=(f=e.schedule.items)==null?void 0:f[E],I=e.getBufferingPlayer(),C=I?.interstitial,T=C?.appendInPlace,L=m&&e.itemsMatch(m,p);if(m&&(T||L)){const S=s(e.playingAsset),x=S?.media||e.primaryMedia;if(x){const v=d==="primary"?x.currentTime:i(m,d,e.playingAsset,"timelinePos","currentTime"),B=u-v,R=(T?v:x.currentTime)+B;if(R>=0&&(!S||T||R<=S.duration)){x.currentTime=R;return}}}if(p){let S=u;if(d!=="primary"){const v=p[d].start,B=u-v;S=p.start+B}const x=!e.isInterstitial(p);if((!e.isInterstitial(m)||m.event.appendInPlace)&&(x||p.event.appendInPlace)){const v=e.media||(T?I?.media:null);v&&(v.currentTime=S)}else if(m){const v=e.findItemIndex(m);if(E>v){const R=e.schedule.findJumpRestrictedIndex(v+1,E);if(R>v){e.setSchedulePosition(R);return}}let B=0;if(x)e.timelinePos=S,e.checkBuffer();else{const R=p.event.assetList,D=u-(p[d]||p).start;for(let b=R.length;b--;){const w=R[b];if(w.duration&&D>=w.startOffset&&D<w.startOffset+w.duration){B=b;break}}}e.setSchedulePosition(E,B)}}},l=()=>{const u=e.effectivePlayingItem;if(e.isInterstitial(u))return u;const d=t();return e.isInterstitial(d)?d:null},h={get bufferedEnd(){const u=t(),d=e.bufferingItem;if(d&&d===u){var A;return i(d,"playout",e.bufferingAsset,"bufferedPos","bufferedEnd")-d.playout.start||((A=e.bufferingAsset)==null?void 0:A.startOffset)||0}return 0},get currentTime(){const u=l(),d=e.effectivePlayingItem;return d&&d===u?i(d,"playout",e.effectivePlayingAsset,"timelinePos","currentTime")-d.playout.start:0},set currentTime(u){const d=l(),A=e.effectivePlayingItem;A&&A===d&&c(u+A.playout.start,"playout")},get duration(){const u=l();return u?u.playout.end-u.playout.start:0},get assetPlayers(){var u;const d=(u=l())==null?void 0:u.event.assetList;return d?d.map(A=>e.getAssetPlayer(A.identifier)):[]},get playingIndex(){var u;const d=(u=l())==null?void 0:u.event;return d&&e.effectivePlayingAsset?d.findAssetIndex(e.effectivePlayingAsset):-1},get scheduleItem(){return l()}};return this.manager={get events(){var u;return((u=e.schedule)==null||(u=u.events)==null?void 0:u.slice(0))||[]},get schedule(){var u;return((u=e.schedule)==null||(u=u.items)==null?void 0:u.slice(0))||[]},get interstitialPlayer(){return l()?h:null},get playerQueue(){return e.playerQueue.slice(0)},get bufferingAsset(){return e.bufferingAsset},get bufferingItem(){return t()},get bufferingIndex(){const u=t();return e.findItemIndex(u)},get playingAsset(){return e.effectivePlayingAsset},get playingItem(){return e.effectivePlayingItem},get playingIndex(){const u=e.effectivePlayingItem;return e.findItemIndex(u)},primary:{get bufferedEnd(){return r()},get currentTime(){const u=e.timelinePos;return u>0?u:0},set currentTime(u){c(u,"primary")},get duration(){return a("primary")},get seekableStart(){var u;return((u=e.primaryDetails)==null?void 0:u.fragmentStart)||0}},integrated:{get bufferedEnd(){return i(t(),"integrated",e.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return i(e.effectivePlayingItem,"integrated",e.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(u){c(u,"integrated")},get duration(){return a("integrated")},get seekableStart(){var u;return n(((u=e.primaryDetails)==null?void 0:u.fragmentStart)||0,"integrated")}},skip:()=>{const u=e.effectivePlayingItem,d=u?.event;if(d&&!d.restrictions.skip){const A=e.findItemIndex(u);if(d.appendInPlace){const f=u.playout.start+u.event.duration;c(f+.001,"playout")}else e.advanceAfterAssetEnded(d,A,1/0)}}}}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){var e;const t=this.playingItem,s=(e=this.schedule)==null?void 0:e.items;return!this.playbackStarted||!t||!s?!1:this.findItemIndex(t)===s.length-1}get playbackStarted(){return this.effectivePlayingItem!==null}get currentTime(){var e,t;if(this.mediaSelection===null)return;const s=this.waitingItem||this.playingItem;if(this.isInterstitial(s)&&!s.event.appendInPlace)return;let i=this.media;!i&&(e=this.bufferingItem)!=null&&(e=e.event)!=null&&e.appendInPlace&&(i=this.primaryMedia);const n=(t=i)==null?void 0:t.currentTime;if(!(n===void 0||!K(n)))return n}get primaryMedia(){var e;return this.media||((e=this.detachedData)==null?void 0:e.media)||null}isInterstitial(e){return!!(e!=null&&e.event)}retreiveMediaSource(e,t){const s=this.getAssetPlayer(e);s&&this.transferMediaFromPlayer(s,t)}transferMediaFromPlayer(e,t){const s=e.interstitial.appendInPlace,i=e.media;if(s&&i===this.primaryMedia){if(this.bufferingAsset=null,(!t||this.isInterstitial(t)&&!t.event.appendInPlace)&&t&&i){this.detachedData={media:i};return}const n=e.transferMedia();this.log(`transfer MediaSource from ${e} ${le(n)}`),this.detachedData=n}else t&&i&&(this.shouldPlay||(this.shouldPlay=!i.paused))}transferMediaTo(e,t){var s,i;if(e.media===t)return;let n=null;const r=this.hls,a=e!==r,c=a&&e.interstitial.appendInPlace,l=(s=this.detachedData)==null?void 0:s.mediaSource;let h;if(r.media)c&&(n=r.transferMedia(),this.detachedData=n),h="Primary";else if(l){const f=this.getBufferingPlayer();f?(n=f.transferMedia(),h=`${f}`):h="detached MediaSource"}else h="detached media";if(!n){if(l)n=this.detachedData,this.log(`using detachedData: MediaSource ${le(n)}`);else if(!this.detachedData||r.media===t){const f=this.playerQueue;f.length>1&&f.forEach(g=>{if(a&&g.interstitial.appendInPlace!==c){const m=g.interstitial;this.clearInterstitial(g.interstitial,null),m.appendInPlace=!1,m.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${m}`)}}),this.hls.detachMedia(),this.detachedData={media:t}}}const u=n&&"mediaSource"in n&&((i=n.mediaSource)==null?void 0:i.readyState)!=="closed",d=u&&n?n:t;this.log(`${u?"transfering MediaSource":"attaching media"} to ${a?e:"Primary"} from ${h} (media.currentTime: ${t.currentTime})`);const A=this.schedule;if(d===n&&A){const f=a&&e.assetId===A.assetIdAtEnd;d.overrides={duration:A.duration,endOfStream:!a||f,cueRemoval:!a}}e.attachMedia(d)}onInterstitialCueEnter(){this.onTimeupdate()}checkStart(){const e=this.schedule,t=e?.events;if(!t||this.playbackDisabled||!this.media)return;this.bufferedPos===-1&&(this.bufferedPos=0);const s=this.timelinePos,i=this.effectivePlayingItem;if(s===-1){const n=this.hls.startPosition;if(this.log(vi("checkStart",n)),this.timelinePos=n,t.length&&t[0].cue.pre){const r=e.findEventIndex(t[0].identifier);this.setSchedulePosition(r)}else if(n>=0||!this.primaryLive){const r=this.timelinePos=n>0?n:0,a=e.findItemIndexAtTime(r);this.setSchedulePosition(a)}}else if(i&&!this.playingItem){const n=e.findItemIndex(i);this.setSchedulePosition(n)}}advanceAssetBuffering(e,t){const s=e.event,i=s.findAssetIndex(t),n=Vn(s,i);if(!s.isAssetPastPlayoutLimit(n))this.bufferedToEvent(e,n);else if(this.schedule){var r;const a=(r=this.schedule.items)==null?void 0:r[this.findItemIndex(e)+1];a&&this.bufferedToItem(a)}}advanceAfterAssetEnded(e,t,s){const i=Vn(e,s);if(e.isAssetPastPlayoutLimit(i)){if(this.schedule){const n=this.schedule.items;if(n){const r=t+1,a=n.length;if(r>=a){this.setSchedulePosition(-1);return}const c=e.resumeTime;this.timelinePos<c&&(this.log(vi("advanceAfterAssetEnded",c)),this.timelinePos=c,e.appendInPlace&&this.advanceInPlace(c),this.checkBuffer(this.bufferedPos<c)),this.setSchedulePosition(r)}}}else{if(e.appendInPlace){const n=e.assetList[i];n&&this.advanceInPlace(n.timelineStart)}this.setSchedulePosition(t,i)}}setScheduleToAssetAtTime(e,t){const s=this.schedule;if(!s)return;const i=t.parentIdentifier,n=s.getEvent(i);if(n){const r=s.findEventIndex(i),a=s.findAssetIndex(n,e);this.advanceAfterAssetEnded(n,r,a-1)}}setSchedulePosition(e,t){var s;const i=(s=this.schedule)==null?void 0:s.items;if(!i||this.playbackDisabled)return;const n=e>=0?i[e]:null;this.log(`setSchedulePosition ${e}, ${t} (${n&&nt(n)}) pos: ${this.timelinePos}`);const r=this.waitingItem||this.playingItem,a=this.playingLastItem;if(this.isInterstitial(r)){const h=r.event,u=this.playingAsset,d=u?.identifier,A=d?this.getAssetPlayer(d):null;if(A&&d&&(!this.eventItemsMatch(r,n)||t!==void 0&&d!==h.assetList[t].identifier)){var c;const f=h.findAssetIndex(u);if(this.log(`INTERSTITIAL_ASSET_ENDED ${f+1}/${h.assetList.length} ${Ts(u)}`),this.endedAsset=u,this.playingAsset=null,this.hls.trigger(y.INTERSTITIAL_ASSET_ENDED,{asset:u,assetListIndex:f,event:h,schedule:i.slice(0),scheduleIndex:e,player:A}),r!==this.playingItem){this.itemsMatch(r,this.playingItem)&&!this.playingAsset&&this.advanceAfterAssetEnded(h,this.findItemIndex(this.playingItem),f);return}this.retreiveMediaSource(d,n),A.media&&!((c=this.detachedData)!=null&&c.mediaSource)&&A.detachMedia()}if(!this.eventItemsMatch(r,n)&&(this.endedItem=r,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${h} ${nt(r)}`),h.hasPlayed=!0,this.hls.trigger(y.INTERSTITIAL_ENDED,{event:h,schedule:i.slice(0),scheduleIndex:e}),h.cue.once)){var l;this.updateSchedule();const f=(l=this.schedule)==null?void 0:l.items;if(n&&f){const g=this.findItemIndex(n);this.advanceSchedule(g,f,t,r,a)}return}}this.advanceSchedule(e,i,t,r,a)}advanceSchedule(e,t,s,i,n){const r=this.schedule;if(!r)return;const a=t[e]||null,c=this.primaryMedia,l=this.playerQueue;if(l.length&&l.forEach(h=>{const u=h.interstitial,d=r.findEventIndex(u.identifier);(d<e||d>e+1)&&this.clearInterstitial(u,a)}),this.isInterstitial(a)){this.timelinePos=Math.min(Math.max(this.timelinePos,a.start),a.end);const h=a.event;if(s===void 0){s=r.findAssetIndex(h,this.timelinePos);const f=Vn(h,s-1);if(h.isAssetPastPlayoutLimit(f)||h.appendInPlace&&this.timelinePos===a.end){this.advanceAfterAssetEnded(h,e,s);return}s=f}const u=this.waitingItem;this.assetsBuffered(a,c)||this.setBufferingItem(a);let d=this.preloadAssets(h,s);if(this.eventItemsMatch(a,u||i)||(this.waitingItem=a,this.log(`INTERSTITIAL_STARTED ${nt(a)} ${h.appendInPlace?"append in place":""}`),this.hls.trigger(y.INTERSTITIAL_STARTED,{event:h,schedule:t.slice(0),scheduleIndex:e})),!h.assetListLoaded){this.log(`Waiting for ASSET-LIST to complete loading ${h}`);return}if(h.assetListLoader&&(h.assetListLoader.destroy(),h.assetListLoader=void 0),!c){this.log(`Waiting for attachMedia to start Interstitial ${h}`);return}this.waitingItem=this.endedItem=null,this.playingItem=a;const A=h.assetList[s];if(!A){this.advanceAfterAssetEnded(h,e,s||0);return}if(d||(d=this.getAssetPlayer(A.identifier)),d===null||d.destroyed){const f=h.assetList.length;this.warn(`asset ${s+1}/${f} player destroyed ${h}`),d=this.createAssetPlayer(h,A,s),d.loadSource()}if(!this.eventItemsMatch(a,this.bufferingItem)&&h.appendInPlace&&this.isAssetBuffered(A))return;this.startAssetPlayer(d,s,t,e,c),this.shouldPlay&&Bl(d.media)}else a?(this.resumePrimary(a,e,i),this.shouldPlay&&Bl(this.hls.media)):n&&this.isInterstitial(i)&&(this.endedItem=null,this.playingItem=i,i.event.appendInPlace||this.attachPrimary(r.durations.primary,null))}get playbackDisabled(){return this.hls.config.enableInterstitialPlayback===!1}get primaryDetails(){var e;return(e=this.mediaSelection)==null?void 0:e.main.details}get primaryLive(){var e;return!!((e=this.primaryDetails)!=null&&e.live)}resumePrimary(e,t,s){var i,n;if(this.playingItem=e,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(e),this.log(`resuming ${nt(e)}`),!((i=this.detachedData)!=null&&i.mediaSource)){let a=this.timelinePos;(a<e.start||a>=e.end)&&(a=this.getPrimaryResumption(e,t),this.log(vi("resumePrimary",a)),this.timelinePos=a),this.attachPrimary(a,e)}if(!s)return;const r=(n=this.schedule)==null?void 0:n.items;r&&(this.log(`INTERSTITIALS_PRIMARY_RESUMED ${nt(e)}`),this.hls.trigger(y.INTERSTITIALS_PRIMARY_RESUMED,{schedule:r.slice(0),scheduleIndex:t}),this.checkBuffer())}getPrimaryResumption(e,t){const s=e.start;if(this.primaryLive){const i=this.primaryDetails;if(t===0)return this.hls.startPosition;if(i&&(s<i.fragmentStart||s>i.edge))return this.hls.liveSyncPosition||-1}return s}isAssetBuffered(e){const t=this.getAssetPlayer(e.identifier);return t!=null&&t.hls?t.hls.bufferedToEnd:J.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=e.timelineStart+(e.duration||0)}attachPrimary(e,t,s){t?this.setBufferingItem(t):this.bufferingItem=this.playingItem,this.bufferingAsset=null;const i=this.primaryMedia;if(!i)return;const n=this.hls;n.media?this.checkBuffer():(this.transferMediaTo(n,i),s&&this.startLoadingPrimaryAt(e,s)),s||(this.log(vi("attachPrimary",e)),this.timelinePos=e,this.startLoadingPrimaryAt(e,s))}startLoadingPrimaryAt(e,t){var s;const i=this.hls;!i.loadingEnabled||!i.media||Math.abs((((s=i.mainForwardBufferInfo)==null?void 0:s.start)||i.media.currentTime)-e)>.5?i.startLoad(e,t):i.bufferingEnabled||i.resumeBuffering()}onManifestLoading(){var e;this.stopLoad(),(e=this.schedule)==null||e.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(y.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(y.BUFFER_CODECS,this.onBufferCodecs,this)}onLevelUpdated(e,t){if(t.level===-1||!this.schedule)return;const s=this.hls.levels[t.level];if(!s.details)return;const i=ne(ne({},this.mediaSelection||this.altSelection),{},{main:s});this.mediaSelection=i,this.schedule.parseInterstitialDateRanges(i,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}onAudioTrackUpdated(e,t){const s=this.hls.audioTracks[t.id],i=this.mediaSelection;if(!i){this.altSelection=ne(ne({},this.altSelection),{},{audio:s});return}const n=ne(ne({},i),{},{audio:s});this.mediaSelection=n}onSubtitleTrackUpdated(e,t){const s=this.hls.subtitleTracks[t.id],i=this.mediaSelection;if(!i){this.altSelection=ne(ne({},this.altSelection),{},{subtitles:s});return}const n=ne(ne({},i),{},{subtitles:s});this.mediaSelection=n}onAudioTrackSwitching(e,t){const s=ka(t);this.playerQueue.forEach(({hls:i})=>i&&(i.setAudioOption(t)||i.setAudioOption(s)))}onSubtitleTrackSwitch(e,t){const s=ka(t);this.playerQueue.forEach(({hls:i})=>i&&(i.setSubtitleOption(t)||t.id!==-1&&i.setSubtitleOption(s)))}onBufferCodecs(e,t){const s=t.tracks;s&&(this.requiredTracks=s)}onBufferAppended(e,t){this.checkBuffer()}onBufferFlushed(e,t){const s=this.playingItem;if(s&&!this.itemsMatch(s,this.bufferingItem)&&!this.isInterstitial(s)){const i=this.timelinePos;this.bufferedPos=i,this.checkBuffer()}}onBufferedToEnd(e){if(!this.schedule)return;const t=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&t){for(let i=0;i<t.length;i++){const n=t[i];if(n.cue.post){var s;const r=this.schedule.findEventIndex(n.identifier),a=(s=this.schedule.items)==null?void 0:s[r];this.isInterstitial(a)&&this.eventItemsMatch(a,this.bufferingItem)&&this.bufferedToItem(a,0);break}}this.bufferedPos=Number.MAX_VALUE}}onMediaEnded(e){const t=this.playingItem;if(!this.playingLastItem&&t){const s=this.findItemIndex(t);this.setSchedulePosition(s+1)}else this.shouldPlay=!1}updateItem(e,t){var s;const i=(s=this.schedule)==null?void 0:s.items;if(e&&i){const n=this.findItemIndex(e,t);return i[n]||null}return null}trimInPlace(e,t){if(this.isInterstitial(e)&&e.event.appendInPlace&&t.end-e.end>.25){e.event.assetList.forEach((n,r)=>{e.event.isAssetPastPlayoutLimit(r)&&this.clearAssetPlayer(n.identifier,null)});const s=e.end+.25,i=J.bufferInfo(this.primaryMedia,s,0);(i.end>s||(i.nextStart||0)>s)&&(this.log(`trim buffered interstitial ${nt(e)} (was ${nt(t)})`),this.attachPrimary(s,null,!0),this.flushFrontBuffer(s))}}itemsMatch(e,t){return!!t&&(e===t||e.event&&t.event&&this.eventItemsMatch(e,t)||!e.event&&!t.event&&this.findItemIndex(e)===this.findItemIndex(t))}eventItemsMatch(e,t){var s;return!!t&&(e===t||e.event.identifier===((s=t.event)==null?void 0:s.identifier))}findItemIndex(e,t){return e&&this.schedule?this.schedule.findItemIndex(e,t):-1}updateSchedule(e=!1){var t;const s=this.mediaSelection;s&&((t=this.schedule)==null||t.updateSchedule(s,[],e))}checkBuffer(e){var t;const s=(t=this.schedule)==null?void 0:t.items;if(!s)return;const i=J.bufferInfo(this.primaryMedia,this.timelinePos,0);e&&(this.bufferedPos=this.timelinePos),e||(e=i.len<1),this.updateBufferedPos(i.end,s,e)}updateBufferedPos(e,t,s){const i=this.schedule,n=this.bufferingItem;if(this.bufferedPos>e||!i)return;if(t.length===1&&this.itemsMatch(t[0],n)){this.bufferedPos=e;return}const r=this.playingItem,a=this.findItemIndex(r);let c=i.findItemIndexAtTime(e);if(this.bufferedPos<e){var l;const h=this.findItemIndex(n),u=Math.min(h+1,t.length-1),d=t[u];if((c===-1&&n&&e>=n.end||(l=d.event)!=null&&l.appendInPlace&&e+.01>=d.start)&&(c=u),this.isInterstitial(n)){const A=n.event;if(u-a>1&&A.appendInPlace===!1||A.assetList.length===0&&A.assetListLoader)return}if(this.bufferedPos=e,c>h&&c>a)this.bufferedToItem(d);else{const A=this.primaryDetails;this.primaryLive&&A&&e>A.edge-A.targetduration&&d.start<A.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(d)&&this.preloadAssets(d.event,0)}}else s&&r&&!this.itemsMatch(r,n)&&(c===a?this.bufferedToItem(r):c===a+1&&this.bufferedToItem(t[c]))}assetsBuffered(e,t){return e.event.assetList.length===0?!1:!e.event.assetList.some(i=>{const n=this.getAssetPlayer(i.identifier);return!(n!=null&&n.bufferedInPlaceToEnd(t))})}setBufferingItem(e){const t=this.bufferingItem,s=this.schedule;if(!this.itemsMatch(e,t)&&s){const{items:i,events:n}=s;if(!i||!n)return t;const r=this.isInterstitial(e),a=this.getBufferingPlayer();this.bufferingItem=e,this.bufferedPos=Math.max(e.start,Math.min(e.end,this.timelinePos));const c=a?a.remaining:t?t.end-this.timelinePos:0;if(this.log(`INTERSTITIALS_BUFFERED_TO_BOUNDARY ${nt(e)}`+(t?` (${c.toFixed(2)} remaining)`:"")),!this.playbackDisabled)if(r){const l=s.findAssetIndex(e.event,this.bufferedPos);e.event.assetList.forEach((h,u)=>{const d=this.getAssetPlayer(h.identifier);d&&(u===l&&d.loadSource(),d.resumeBuffering())})}else this.hls.resumeBuffering(),this.playerQueue.forEach(l=>l.pauseBuffering());this.hls.trigger(y.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:n.slice(0),schedule:i.slice(0),bufferingIndex:this.findItemIndex(e),playingIndex:this.findItemIndex(this.playingItem)})}else this.bufferingItem!==e&&(this.bufferingItem=e);return t}bufferedToItem(e,t=0){const s=this.setBufferingItem(e);if(!this.playbackDisabled){if(this.isInterstitial(e))this.bufferedToEvent(e,t);else if(s!==null){this.bufferingAsset=null;const i=this.detachedData;i?i.mediaSource?this.attachPrimary(e.start,e,!0):this.preloadPrimary(e):this.preloadPrimary(e)}}}preloadPrimary(e){const t=this.findItemIndex(e),s=this.getPrimaryResumption(e,t);this.startLoadingPrimaryAt(s)}bufferedToEvent(e,t){const s=e.event,i=s.assetList.length===0&&!s.assetListLoader,n=s.cue.once;if(i||!n){const r=this.preloadAssets(s,t);if(r!=null&&r.interstitial.appendInPlace){const a=this.primaryMedia;a&&this.bufferAssetPlayer(r,a)}}}preloadAssets(e,t){const s=e.assetUrl,i=e.assetList.length,n=i===0&&!e.assetListLoader,r=e.cue.once;if(n){const c=e.timelineStart;if(e.appendInPlace){var a;const d=this.playingItem;!this.isInterstitial(d)&&(d==null||(a=d.nextEvent)==null?void 0:a.identifier)===e.identifier&&this.flushFrontBuffer(c+.25)}let l,h=0;if(!this.playingItem&&this.primaryLive&&(h=this.hls.startPosition,h===-1&&(h=this.hls.liveSyncPosition||0)),h&&!(e.cue.pre||e.cue.post)){const d=h-c;d>0&&(l=Math.round(d*1e3)/1e3)}if(this.log(`Load interstitial asset ${t+1}/${s?1:i} ${e}${l?` live-start: ${h} start-offset: ${l}`:""}`),s)return this.createAsset(e,0,0,c,e.duration,s);const u=this.assetListLoader.loadAssetList(e,l);u&&(e.assetListLoader=u)}else if(!r&&i){for(let l=t;l<i;l++){const h=e.assetList[l],u=this.getAssetPlayerQueueIndex(h.identifier);(u===-1||this.playerQueue[u].destroyed)&&!h.error&&this.createAssetPlayer(e,h,l)}const c=e.assetList[t];if(c){const l=this.getAssetPlayer(c.identifier);return l&&l.loadSource(),l}}return null}flushFrontBuffer(e){const t=this.requiredTracks;if(!t)return;this.log(`Removing front buffer starting at ${e}`),Object.keys(t).forEach(i=>{this.hls.trigger(y.BUFFER_FLUSHING,{startOffset:e,endOffset:1/0,type:i})})}getAssetPlayerQueueIndex(e){const t=this.playerQueue;for(let s=0;s<t.length;s++)if(e===t[s].assetId)return s;return-1}getAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);return this.playerQueue[t]||null}getBufferingPlayer(){const{playerQueue:e,primaryMedia:t}=this;if(t){for(let s=0;s<e.length;s++)if(e[s].media===t)return e[s]}return null}createAsset(e,t,s,i,n,r){const a={parentIdentifier:e.identifier,identifier:mp(e,r,t),duration:n,startOffset:s,timelineStart:i,uri:r};return this.createAssetPlayer(e,a,t)}createAssetPlayer(e,t,s){const i=this.hls,n=i.userConfig;let r=n.videoPreference;const a=i.loadLevelObj||i.levels[i.currentLevel];(r||a)&&(r=oe({},r),a.videoCodec&&(r.videoCodec=a.videoCodec),a.videoRange&&(r.allowedVideoRanges=[a.videoRange]));const c=i.audioTracks[i.audioTrack],l=i.subtitleTracks[i.subtitleTrack];let h=0;if(this.primaryLive||e.appendInPlace){const C=this.timelinePos-t.timelineStart;if(C>1){const T=t.duration;T&&C<T&&(h=C)}}const u=t.identifier,d=ne(ne({},n),{},{maxMaxBufferLength:Math.min(180,i.config.maxMaxBufferLength),autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:i.sessionId,assetPlayerId:u,abrEwmaDefaultEstimate:i.bandwidthEstimate,interstitialsController:void 0,startPosition:h,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:r,audioPreference:c||n.audioPreference,subtitlePreference:l||n.subtitlePreference});e.appendInPlace&&(e.appendInPlaceStarted=!0,t.timelineStart&&(d.timelineOffset=t.timelineStart));const A=d.cmcd;A!=null&&A.sessionId&&A.contentId&&(d.cmcd=oe({},A,{contentId:ii(t.uri)})),this.getAssetPlayer(u)&&this.warn(`Duplicate date range identifier ${e} and asset ${u}`);const f=new Ip(this.HlsPlayerClass,d,e,t);this.playerQueue.push(f),e.assetList[s]=t;let g=!0;const m=C=>{if(C.live){var T;const x=new Error(`Interstitials MUST be VOD assets ${e}`),v={fatal:!0,type:q.OTHER_ERROR,details:k.INTERSTITIAL_ASSET_ITEM_ERROR,error:x},B=((T=this.schedule)==null?void 0:T.findEventIndex(e.identifier))||-1;this.handleAssetItemError(v,e,B,s,x.message);return}const L=C.edge-C.fragmentStart,S=t.duration;(g||S===null||L>S)&&(g=!1,this.log(`Interstitial asset "${u}" duration change ${S} > ${L}`),t.duration=L,this.updateSchedule())};f.on(y.LEVEL_UPDATED,(C,{details:T})=>m(T)),f.on(y.LEVEL_PTS_UPDATED,(C,{details:T})=>m(T)),f.on(y.EVENT_CUE_ENTER,()=>this.onInterstitialCueEnter());const E=(C,T)=>{const L=this.getAssetPlayer(u);if(L&&T.tracks){L.off(y.BUFFER_CODECS,E),L.tracks=T.tracks;const S=this.primaryMedia;this.bufferingAsset===L.assetItem&&S&&!L.media&&this.bufferAssetPlayer(L,S)}};f.on(y.BUFFER_CODECS,E);const p=()=>{var C;const T=this.getAssetPlayer(u);if(this.log(`buffered to end of asset ${T}`),!T||!this.schedule)return;const L=this.schedule.findEventIndex(e.identifier),S=(C=this.schedule.items)==null?void 0:C[L];this.isInterstitial(S)&&this.advanceAssetBuffering(S,t)};f.on(y.BUFFERED_TO_END,p);const I=C=>()=>{if(!this.getAssetPlayer(u)||!this.schedule)return;this.shouldPlay=!0;const L=this.schedule.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,L,C)};return f.once(y.MEDIA_ENDED,I(s)),f.once(y.PLAYOUT_LIMIT_REACHED,I(1/0)),f.on(y.ERROR,(C,T)=>{if(!this.schedule)return;const L=this.getAssetPlayer(u);if(T.details===k.BUFFER_STALLED_ERROR){if(L!=null&&L.appendInPlace){this.handleInPlaceStall(e);return}this.onTimeupdate(),this.checkBuffer(!0);return}this.handleAssetItemError(T,e,this.schedule.findEventIndex(e.identifier),s,`Asset player error ${T.error} ${e}`)}),f.on(y.DESTROYING,()=>{if(!this.getAssetPlayer(u)||!this.schedule)return;const T=new Error(`Asset player destroyed unexpectedly ${u}`),L={fatal:!0,type:q.OTHER_ERROR,details:k.INTERSTITIAL_ASSET_ITEM_ERROR,error:T};this.handleAssetItemError(L,e,this.schedule.findEventIndex(e.identifier),s,T.message)}),this.log(`INTERSTITIAL_ASSET_PLAYER_CREATED ${Ts(t)}`),this.hls.trigger(y.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:t,assetListIndex:s,event:e,player:f}),f}clearInterstitial(e,t){this.clearAssetPlayers(e,t),e.reset()}clearAssetPlayers(e,t){e.assetList.forEach(s=>{this.clearAssetPlayer(s.identifier,t)})}resetAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);if(t!==-1){this.log(`reset asset player "${e}" after error`);const s=this.playerQueue[t];this.transferMediaFromPlayer(s,null),s.resetDetails()}}clearAssetPlayer(e,t){const s=this.getAssetPlayerQueueIndex(e);if(s!==-1){const i=this.playerQueue[s];this.log(`clear ${i} toSegment: ${t&&nt(t)}`),this.transferMediaFromPlayer(i,t),this.playerQueue.splice(s,1),i.destroy()}}emptyPlayerQueue(){let e;for(;e=this.playerQueue.pop();)e.destroy();this.playerQueue=[]}startAssetPlayer(e,t,s,i,n){const{interstitial:r,assetItem:a,assetId:c}=e,l=r.assetList.length,h=this.playingAsset;this.endedAsset=null,this.playingAsset=a,(!h||h.identifier!==c)&&(h&&(this.clearAssetPlayer(h.identifier,s[i]),delete h.error),this.log(`INTERSTITIAL_ASSET_STARTED ${t+1}/${l} ${Ts(a)}`),this.hls.trigger(y.INTERSTITIAL_ASSET_STARTED,{asset:a,assetListIndex:t,event:r,schedule:s.slice(0),scheduleIndex:i,player:e})),this.bufferAssetPlayer(e,n)}bufferAssetPlayer(e,t){var s,i;if(!this.schedule)return;const{interstitial:n,assetItem:r}=e,a=this.schedule.findEventIndex(n.identifier),c=(s=this.schedule.items)==null?void 0:s[a];if(!c)return;e.loadSource(),this.setBufferingItem(c),this.bufferingAsset=r;const l=this.getBufferingPlayer();if(l===e)return;const h=n.appendInPlace;if(h&&l?.interstitial.appendInPlace===!1)return;const u=l?.tracks||((i=this.detachedData)==null?void 0:i.tracks)||this.requiredTracks;if(h&&r!==this.playingAsset){if(!e.tracks){this.log(`Waiting for track info before buffering ${e}`);return}if(u&&!Mc(u,e.tracks)){const d=new Error(`Asset ${Ts(r)} SourceBuffer tracks ('${Object.keys(e.tracks)}') are not compatible with primary content tracks ('${Object.keys(u)}')`),A={fatal:!0,type:q.OTHER_ERROR,details:k.INTERSTITIAL_ASSET_ITEM_ERROR,error:d},f=n.findAssetIndex(r);this.handleAssetItemError(A,n,a,f,d.message);return}}this.transferMediaTo(e,t)}handleInPlaceStall(e){const t=this.schedule,s=this.primaryMedia;if(!t||!s)return;const i=s.currentTime,n=t.findAssetIndex(e,i),r=e.assetList[n];if(r){const a=this.getAssetPlayer(r.identifier);if(a){const c=a.currentTime||i-r.timelineStart,l=a.duration-c;if(this.warn(`Stalled at ${c} of ${c+l} in ${a} ${e} (media.currentTime: ${i})`),c&&(l/s.playbackRate<.5||a.bufferedInPlaceToEnd(s))&&a.hls){const h=t.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,h,n)}}}}advanceInPlace(e){const t=this.primaryMedia;t&&t.currentTime<e&&(t.currentTime=e)}handleAssetItemError(e,t,s,i,n){if(e.details===k.BUFFER_STALLED_ERROR)return;const r=t.assetList[i]||null;if(this.warn(`INTERSTITIAL_ASSET_ERROR ${r&&Ts(r)} ${e.error}`),!this.schedule)return;const a=r?.identifier||"",c=this.getAssetPlayerQueueIndex(a),l=this.playerQueue[c]||null,h=this.schedule.items,u=oe({},e,{fatal:!1,errorAction:Ls(!0),asset:r,assetListIndex:i,event:t,schedule:h,scheduleIndex:s,player:l});if(this.hls.trigger(y.INTERSTITIAL_ASSET_ERROR,u),!e.fatal)return;const d=this.playingAsset,A=this.bufferingAsset,f=new Error(n);if(r&&(this.clearAssetPlayer(a,null),r.error=f),!t.assetList.some(g=>!g.error))t.error=f;else for(let g=i;g<t.assetList.length;g++)this.resetAssetPlayer(t.assetList[g].identifier);this.updateSchedule(!0),t.error?this.primaryFallback(t):d&&d.identifier===a?this.advanceAfterAssetEnded(t,s,i):A&&A.identifier===a&&this.isInterstitial(this.bufferingItem)&&this.advanceAssetBuffering(this.bufferingItem,A)}primaryFallback(e){const t=e.timelineStart,s=this.effectivePlayingItem;let i=this.timelinePos;if(s){this.log(`Fallback to primary from event "${e.identifier}" start: ${t} pos: ${i} playing: ${nt(s)} error: ${e.error}`),i===-1&&(i=this.hls.startPosition);const r=this.updateItem(s,i);this.itemsMatch(s,r)&&this.clearInterstitial(e,null),e.appendInPlace&&(this.attachPrimary(t,null),this.flushFrontBuffer(t))}else if(i===-1){this.checkStart();return}if(!this.schedule)return;const n=this.schedule.findItemIndexAtTime(i);this.setSchedulePosition(n)}onAssetListLoaded(e,t){var s,i;const n=t.event,r=n.identifier,a=t.assetListResponse.ASSETS;if(!((s=this.schedule)!=null&&s.hasEvent(r)))return;const c=n.timelineStart,l=n.duration;let h=0;a.forEach((g,m)=>{const E=parseFloat(g.DURATION);this.createAsset(n,m,h,c+h,E,g.URI),h+=E}),n.duration=h,this.log(`Loaded asset-list with duration: ${h} (was: ${l}) ${n}`);const u=this.waitingItem,d=u?.event.identifier===r;this.updateSchedule();const A=(i=this.bufferingItem)==null?void 0:i.event;if(d){var f;const g=this.schedule.findEventIndex(r),m=(f=this.schedule.items)==null?void 0:f[g];if(m){if(!this.playingItem&&this.timelinePos>m.end&&this.schedule.findItemIndexAtTime(this.timelinePos)!==g){n.error=new Error(`Interstitial ${a.length?"no longer within playback range":"asset-list is empty"} ${this.timelinePos} ${n}`),this.log(n.error.message),this.updateSchedule(!0),this.primaryFallback(n);return}this.setBufferingItem(m)}this.setSchedulePosition(g)}else if(A?.identifier===r){const g=n.assetList[0];if(g){const m=this.getAssetPlayer(g.identifier);if(A.appendInPlace){const E=this.primaryMedia;m&&E&&this.bufferAssetPlayer(m,E)}else m&&m.loadSource()}}}onError(e,t){if(this.schedule)switch(t.details){case k.ASSET_LIST_PARSING_ERROR:case k.ASSET_LIST_LOAD_ERROR:case k.ASSET_LIST_LOAD_TIMEOUT:{const s=t.interstitial;s&&(this.updateSchedule(!0),this.primaryFallback(s));break}case k.BUFFER_STALLED_ERROR:{const s=this.endedItem||this.waitingItem||this.playingItem;if(this.isInterstitial(s)&&s.event.appendInPlace){this.handleInPlaceStall(s.event);return}this.log(`Primary player stall @${this.timelinePos} bufferedPos: ${this.bufferedPos}`),this.onTimeupdate(),this.checkBuffer(!0);break}}}}const xl=500;class Sp extends _o{constructor(e,t,s){super(e,t,s,"subtitle-stream-controller",V.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(y.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(y.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(y.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(y.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(e,t){this.stopLoad(),this.state=M.IDLE,this.setInterval(xl),this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null}onMediaDetaching(e,t){this.tracksBuffered=[],super.onMediaDetaching(e,t)}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:s,success:i}=t;if(this.fragContextChanged(s)||(ge(s)&&(this.fragPrevious=s),this.state=M.IDLE),!i)return;const n=this.tracksBuffered[this.currentTrackId];if(!n)return;let r;const a=s.start;for(let l=0;l<n.length;l++)if(a>=n[l].start&&a<=n[l].end){r=n[l];break}const c=s.start+s.duration;r?r.end=c:(r={start:a,end:c},n.push(r)),this.fragmentTracker.fragBuffered(s),this.fragBufferedComplete(s,null),this.media&&this.tick()}onBufferFlushing(e,t){const{startOffset:s,endOffset:i}=t;if(s===0&&i!==Number.POSITIVE_INFINITY){const n=i-1;if(n<=0)return;t.endOffsetSubtitles=Math.max(0,n),this.tracksBuffered.forEach(r=>{for(let a=0;a<r.length;){if(r[a].end<=n){r.shift();continue}else if(r[a].start<n)r[a].start=n;else break;a++}}),this.fragmentTracker.removeFragmentsInRange(s,n,V.SUBTITLE)}}onError(e,t){const s=t.frag;s?.type===V.SUBTITLE&&(t.details===k.FRAG_GAP&&this.fragmentTracker.fragBuffered(s,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==M.STOPPED&&(this.state=M.IDLE))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){if(this.levels&&Nh(this.levels,t)){this.levels=t.map(s=>new ci(s));return}this.tracksBuffered=[],this.levels=t.map(s=>{const i=new ci(s);return this.tracksBuffered[i.id]=[],i}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,V.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(e,t){var s;if(this.currentTrackId=t.id,!((s=this.levels)!=null&&s.length)||this.currentTrackId===-1){this.clearInterval();return}const i=this.levels[this.currentTrackId];i!=null&&i.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,i&&this.state!==M.STOPPED&&this.setInterval(xl)}onSubtitleTrackLoaded(e,t){var s;const{currentTrackId:i,levels:n}=this,{details:r,id:a}=t;if(!n){this.warn(`Subtitle tracks were reset while loading level ${a}`);return}const c=n[a];if(a>=n.length||!c)return;this.log(`Subtitle track ${a} loaded [${r.startSN},${r.endSN}]${r.lastPartSn?`[part-${r.lastPartSn}-${r.lastPartIndex}]`:""},duration:${r.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let l=0;if(r.live||(s=c.details)!=null&&s.live){if(r.deltaUpdateFailed)return;const u=this.mainDetails;if(!u){this.startFragRequested=!1;return}const d=u.fragments[0];if(!c.details)r.hasProgramDateTime&&u.hasProgramDateTime?(pn(r,u),l=r.fragmentStart):d&&(l=d.start,Ur(r,l));else{var h;l=this.alignPlaylists(r,c.details,(h=this.levelLastLoaded)==null?void 0:h.details),l===0&&d&&(l=d.start,Ur(r,l))}u&&!this.startFragRequested&&this.setStartPosition(u,l)}c.details=r,this.levelLastLoaded=c,a===i&&(this.hls.trigger(y.SUBTITLE_TRACK_UPDATED,{details:r,id:a,groupId:t.groupId}),this.tick(),r.live&&!this.fragCurrent&&this.media&&this.state===M.IDLE&&(rs(null,r.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),c.details=void 0)))}_handleFragmentLoadComplete(e){const{frag:t,payload:s}=e,i=t.decryptdata,n=this.hls;if(!this.fragContextChanged(t)&&s&&s.byteLength>0&&i!=null&&i.key&&i.iv&&Rs(i.method)){const r=performance.now();this.decrypter.decrypt(new Uint8Array(s),i.key.buffer,i.iv.buffer,bo(i.method)).catch(a=>{throw n.trigger(y.ERROR,{type:q.MEDIA_ERROR,details:k.FRAG_DECRYPT_ERROR,fatal:!1,error:a,reason:a.message,frag:t}),a}).then(a=>{const c=performance.now();n.trigger(y.FRAG_DECRYPTED,{frag:t,payload:a,stats:{tstart:r,tdecrypt:c}})}).catch(a=>{this.warn(`${a.name}: ${a.message}`),this.state=M.IDLE})}}doTick(){if(!this.media){this.state=M.IDLE;return}if(this.state===M.IDLE){const{currentTrackId:e,levels:t}=this,s=t?.[e];if(!s||!t.length||!s.details||this.waitForLive(s))return;const{config:i}=this,n=this.getLoadPosition(),r=J.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],n,i.maxBufferHole),{end:a,len:c}=r,l=s.details,h=this.hls.maxBufferLength+l.levelTargetDuration;if(c>h)return;const u=l.fragments,d=u.length,A=l.edge;let f=null;const g=this.fragPrevious;if(a<A){const p=i.maxFragLookUpTolerance,I=a>A-p?0:p;f=rs(g,u,Math.max(u[0].start,a),I),!f&&g&&g.start<u[0].start&&(f=u[0])}else f=u[d-1];if(f=this.filterReplacedPrimary(f,s.details),!f)return;const m=f.sn-l.startSN,E=u[m-1];if(E&&E.cc===f.cc&&this.fragmentTracker.getState(E)===Ie.NOT_LOADED&&(f=E),this.fragmentTracker.getState(f)===Ie.NOT_LOADED){const p=this.mapToInitFragWhenRequired(f);p&&this.loadFragment(p,s,a)}}}loadFragment(e,t,s){ge(e)?super.loadFragment(e,t,s):this._loadInitSegment(e,t)}get mediaBufferTimeRanges(){return new Bp(this.tracksBuffered[this.currentTrackId]||[])}}class Bp{constructor(e){this.buffered=void 0;const t=(s,i,n)=>{if(i=i>>>0,i>n-1)throw new DOMException(`Failed to execute '${s}' on 'TimeRanges': The index provided (${i}) is greater than the maximum bound (${n})`);return e[i][s]};this.buffered={get length(){return e.length},end(s){return t("end",s,e.length)},start(s){return t("start",s,e.length)}}}}const xp={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},tu=o=>String.fromCharCode(xp[o]||o),ot=15,xt=100,vp={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},Lp={17:2,18:4,21:6,22:8,23:10,19:13,20:15},Rp={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},Dp={25:2,26:4,29:6,30:8,31:10,27:13,28:15},bp=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class wp{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const s=typeof t=="function"?t():t;re.log(`${this.time} [${e}] ${s}`)}}}const Xt=function(e){const t=[];for(let s=0;s<e.length;s++)t.push(e[s].toString(16));return t};class su{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let s=0;s<t.length;s++){const i=t[s];e.hasOwnProperty(i)&&(this[i]=e[i])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class _p{constructor(){this.uchar=" ",this.penState=new su}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class kp{constructor(e){this.chars=[],this.pos=0,this.currPenState=new su,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<xt;t++)this.chars.push(new _p);this.logger=e}equals(e){for(let t=0;t<xt;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<xt;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<xt;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>xt&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=xt)}moveCursor(e){const t=this.pos+e;if(e>1)for(let s=this.pos+1;s<t+1;s++)this.chars[s].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=tu(e);if(this.pos>=xt){this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1)}clearFromPos(e){let t;for(t=e;t<xt;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let s=0;s<xt;s++){const i=this.chars[s].uchar;i!==" "&&(t=!1),e.push(i)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class Yn{constructor(e){this.rows=[],this.currRow=ot-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<ot;t++)this.rows.push(new kp(e));this.logger=e}reset(){for(let e=0;e<ot;e++)this.rows[e].clear();this.currRow=ot-1}equals(e){let t=!0;for(let s=0;s<ot;s++)if(!this.rows[s].equals(e.rows[s])){t=!1;break}return t}copy(e){for(let t=0;t<ot;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<ot;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+le(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let a=0;a<ot;a++)this.rows[a].clear();const n=this.currRow+1-this.nrRollUpRows,r=this.lastOutputScreen;if(r){const a=r.rows[n].cueStartTime,c=this.logger.time;if(a!==null&&c!==null&&a<c)for(let l=0;l<this.nrRollUpRows;l++)this.rows[t-this.nrRollUpRows+l+1].copy(r.rows[n+l])}}this.currRow=t;const s=this.rows[this.currRow];if(e.indent!==null){const n=e.indent,r=Math.max(n-1,0);s.setCursor(e.indent),e.color=s.chars[r].penState.foreground}const i={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(i)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+le(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let s="",i=-1;for(let n=0;n<ot;n++){const r=this.rows[n].getTextString();r&&(i=n+1,e?t.push("Row "+i+": '"+r+"'"):t.push(r.trim()))}return t.length>0&&(e?s="["+t.join(" | ")+"]":s=t.join(`
`)),s}getTextAndFormat(){return this.rows}}class vl{constructor(e,t,s){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new Yn(s),this.nonDisplayedMemory=new Yn(s),this.lastOutputScreen=new Yn(s),this.currRollUpRow=this.displayedMemory.rows[ot-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=s}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[ot-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let s=0;s<e.length;s++)this.writeScreen.insertChar(e[s]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2===1,t.italics=e>=46,t.italics)t.foreground="white";else{const s=Math.floor(e/2)-16,i=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=i[s]}this.logger.log(2,"MIDROW: "+le(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class Ll{constructor(e,t,s){this.channels=void 0,this.currentChannel=0,this.cmdHistory=Fp(),this.logger=void 0;const i=this.logger=new wp;this.channels=[null,new vl(e,t,i),new vl(e+1,s,i)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){this.logger.time=e;for(let s=0;s<t.length;s+=2){const i=t[s]&127,n=t[s+1]&127;let r=!1,a=null;if(i===0&&n===0)continue;this.logger.log(3,()=>"["+Xt([t[s],t[s+1]])+"] -> ("+Xt([i,n])+")");const c=this.cmdHistory;if(i>=16&&i<=31){if(Pp(i,n,c)){Li(null,null,c),this.logger.log(3,()=>"Repeated command ("+Xt([i,n])+") is dropped");continue}Li(i,n,this.cmdHistory),r=this.parseCmd(i,n),r||(r=this.parseMidrow(i,n)),r||(r=this.parsePAC(i,n)),r||(r=this.parseBackgroundAttributes(i,n))}else Li(null,null,c);if(!r&&(a=this.parseChars(i,n),a)){const h=this.currentChannel;h&&h>0?this.channels[h].insertChars(a):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!r&&!a&&this.logger.log(2,()=>"Couldn't parse cleaned data "+Xt([i,n])+" orig: "+Xt([t[s],t[s+1]]))}}parseCmd(e,t){const s=(e===20||e===28||e===21||e===29)&&t>=32&&t<=47,i=(e===23||e===31)&&t>=33&&t<=35;if(!(s||i))return!1;const n=e===20||e===21||e===23?1:2,r=this.channels[n];return e===20||e===21||e===28||e===29?t===32?r.ccRCL():t===33?r.ccBS():t===34?r.ccAOF():t===35?r.ccAON():t===36?r.ccDER():t===37?r.ccRU(2):t===38?r.ccRU(3):t===39?r.ccRU(4):t===40?r.ccFON():t===41?r.ccRDC():t===42?r.ccTR():t===43?r.ccRTD():t===44?r.ccEDM():t===45?r.ccCR():t===46?r.ccENM():t===47&&r.ccEOC():r.ccTO(t-32),this.currentChannel=n,!0}parseMidrow(e,t){let s=0;if((e===17||e===25)&&t>=32&&t<=47){if(e===17?s=1:s=2,s!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const i=this.channels[s];return i?(i.ccMIDROW(t),this.logger.log(3,()=>"MIDROW ("+Xt([e,t])+")"),!0):!1}return!1}parsePAC(e,t){let s;const i=(e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127,n=(e===16||e===24)&&t>=64&&t<=95;if(!(i||n))return!1;const r=e<=23?1:2;t>=64&&t<=95?s=r===1?vp[e]:Rp[e]:s=r===1?Lp[e]:Dp[e];const a=this.channels[r];return a?(a.setPAC(this.interpretPAC(s,t)),this.currentChannel=r,!0):!1}interpretPAC(e,t){let s;const i={color:null,italics:!1,indent:null,underline:!1,row:e};return t>95?s=t-96:s=t-64,i.underline=(s&1)===1,s<=13?i.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(s/2)]:s<=15?(i.italics=!0,i.color="white"):i.indent=Math.floor((s-16)/2)*4,i}parseChars(e,t){let s,i=null,n=null;if(e>=25?(s=2,n=e-8):(s=1,n=e),n>=17&&n<=19){let r;n===17?r=t+80:n===18?r=t+112:r=t+144,this.logger.log(2,()=>"Special char '"+tu(r)+"' in channel "+s),i=[r]}else e>=32&&e<=127&&(i=t===0?[e]:[e,t]);return i&&this.logger.log(3,()=>"Char codes =  "+Xt(i).join(",")),i}parseBackgroundAttributes(e,t){const s=(e===16||e===24)&&t>=32&&t<=47,i=(e===23||e===31)&&t>=45&&t<=47;if(!(s||i))return!1;let n;const r={};e===16||e===24?(n=Math.floor((t-32)/2),r.background=bp[n],t%2===1&&(r.background=r.background+"_semi")):t===45?r.background="transparent":(r.foreground="black",t===47&&(r.underline=!0));const a=e<=23?1:2;return this.channels[a].setBkgData(r),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}Li(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const s=this.channels[t];s&&s.cueSplitAtTime(e)}}}function Li(o,e,t){t.a=o,t.b=e}function Pp(o,e,t){return t.a===o&&t.b===e}function Fp(){return{a:null,b:null}}var $o=(function(){if(mn!=null&&mn.VTTCue)return self.VTTCue;const o=["","lr","rl"],e=["start","middle","end","left","right"];function t(a,c){if(typeof c!="string"||!Array.isArray(a))return!1;const l=c.toLowerCase();return~a.indexOf(l)?l:!1}function s(a){return t(o,a)}function i(a){return t(e,a)}function n(a,...c){let l=1;for(;l<arguments.length;l++){const h=arguments[l];for(const u in h)a[u]=h[u]}return a}function r(a,c,l){const h=this,u={enumerable:!0};h.hasBeenReset=!1;let d="",A=!1,f=a,g=c,m=l,E=null,p="",I=!0,C="auto",T="start",L=50,S="middle",x=50,v="middle";Object.defineProperty(h,"id",n({},u,{get:function(){return d},set:function(B){d=""+B}})),Object.defineProperty(h,"pauseOnExit",n({},u,{get:function(){return A},set:function(B){A=!!B}})),Object.defineProperty(h,"startTime",n({},u,{get:function(){return f},set:function(B){if(typeof B!="number")throw new TypeError("Start time must be set to a number.");f=B,this.hasBeenReset=!0}})),Object.defineProperty(h,"endTime",n({},u,{get:function(){return g},set:function(B){if(typeof B!="number")throw new TypeError("End time must be set to a number.");g=B,this.hasBeenReset=!0}})),Object.defineProperty(h,"text",n({},u,{get:function(){return m},set:function(B){m=""+B,this.hasBeenReset=!0}})),Object.defineProperty(h,"region",n({},u,{get:function(){return E},set:function(B){E=B,this.hasBeenReset=!0}})),Object.defineProperty(h,"vertical",n({},u,{get:function(){return p},set:function(B){const R=s(B);if(R===!1)throw new SyntaxError("An invalid or illegal string was specified.");p=R,this.hasBeenReset=!0}})),Object.defineProperty(h,"snapToLines",n({},u,{get:function(){return I},set:function(B){I=!!B,this.hasBeenReset=!0}})),Object.defineProperty(h,"line",n({},u,{get:function(){return C},set:function(B){if(typeof B!="number"&&B!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");C=B,this.hasBeenReset=!0}})),Object.defineProperty(h,"lineAlign",n({},u,{get:function(){return T},set:function(B){const R=i(B);if(!R)throw new SyntaxError("An invalid or illegal string was specified.");T=R,this.hasBeenReset=!0}})),Object.defineProperty(h,"position",n({},u,{get:function(){return L},set:function(B){if(B<0||B>100)throw new Error("Position must be between 0 and 100.");L=B,this.hasBeenReset=!0}})),Object.defineProperty(h,"positionAlign",n({},u,{get:function(){return S},set:function(B){const R=i(B);if(!R)throw new SyntaxError("An invalid or illegal string was specified.");S=R,this.hasBeenReset=!0}})),Object.defineProperty(h,"size",n({},u,{get:function(){return x},set:function(B){if(B<0||B>100)throw new Error("Size must be between 0 and 100.");x=B,this.hasBeenReset=!0}})),Object.defineProperty(h,"align",n({},u,{get:function(){return v},set:function(B){const R=i(B);if(!R)throw new SyntaxError("An invalid or illegal string was specified.");v=R,this.hasBeenReset=!0}})),h.displayState=void 0}return r.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},r})();class Mp{decode(e,t){if(!e)return"";if(typeof e!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function iu(o){function e(s,i,n,r){return(s|0)*3600+(i|0)*60+(n|0)+parseFloat(r||0)}const t=o.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return t?parseFloat(t[2])>59?e(t[2],t[3],0,t[4]):e(t[1],t[2],t[3],t[4]):null}class Qp{constructor(){this.values=Object.create(null)}set(e,t){!this.get(e)&&t!==""&&(this.values[e]=t)}get(e,t,s){return s?this.has(e)?this.values[e]:t[s]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,s){for(let i=0;i<s.length;++i)if(t===s[i]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const s=parseFloat(t);if(s>=0&&s<=100)return this.set(e,s),!0}return!1}}function nu(o,e,t,s){const i=s?o.split(s):[o];for(const n in i){if(typeof i[n]!="string")continue;const r=i[n].split(t);if(r.length!==2)continue;const a=r[0],c=r[1];e(a,c)}}const Wr=new $o(0,0,""),Ri=Wr.align==="middle"?"middle":"center";function Op(o,e,t){const s=o;function i(){const a=iu(o);if(a===null)throw new Error("Malformed timestamp: "+s);return o=o.replace(/^[^\sa-zA-Z-]+/,""),a}function n(a,c){const l=new Qp;nu(a,function(d,A){let f;switch(d){case"region":for(let g=t.length-1;g>=0;g--)if(t[g].id===A){l.set(d,t[g].region);break}break;case"vertical":l.alt(d,A,["rl","lr"]);break;case"line":f=A.split(","),l.integer(d,f[0]),l.percent(d,f[0])&&l.set("snapToLines",!1),l.alt(d,f[0],["auto"]),f.length===2&&l.alt("lineAlign",f[1],["start",Ri,"end"]);break;case"position":f=A.split(","),l.percent(d,f[0]),f.length===2&&l.alt("positionAlign",f[1],["start",Ri,"end","line-left","line-right","auto"]);break;case"size":l.percent(d,A);break;case"align":l.alt(d,A,["start",Ri,"end","left","right"]);break}},/:/,/\s/),c.region=l.get("region",null),c.vertical=l.get("vertical","");let h=l.get("line","auto");h==="auto"&&Wr.line===-1&&(h=-1),c.line=h,c.lineAlign=l.get("lineAlign","start"),c.snapToLines=l.get("snapToLines",!0),c.size=l.get("size",100),c.align=l.get("align",Ri);let u=l.get("position","auto");u==="auto"&&Wr.position===50&&(u=c.align==="start"||c.align==="left"?0:c.align==="end"||c.align==="right"?100:50),c.position=u}function r(){o=o.replace(/^\s+/,"")}if(r(),e.startTime=i(),r(),o.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+s);o=o.slice(3),r(),e.endTime=i(),r(),n(o,e)}function ru(o){return o.replace(/<br(?: \/)?>/gi,`
`)}class Np{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new Mp,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));function s(){let n=t.buffer,r=0;for(n=ru(n);r<n.length&&n[r]!=="\r"&&n[r]!==`
`;)++r;const a=n.slice(0,r);return n[r]==="\r"&&++r,n[r]===`
`&&++r,t.buffer=n.slice(r),a}function i(n){nu(n,function(r,a){},/:/)}try{let n="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;n=s();const a=n.match(/^()?WEBVTT([ \t].*)?$/);if(!(a!=null&&a[0]))throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let r=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(r?r=!1:n=s(),t.state){case"HEADER":/:/.test(n)?i(n):n||(t.state="ID");continue;case"NOTE":n||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(n)){t.state="NOTE";break}if(!n)continue;if(t.cue=new $o(0,0,""),t.state="CUE",n.indexOf("-->")===-1){t.cue.id=n;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{Op(n,t.cue,t.regionList)}catch{t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const a=n.indexOf("-->")!==-1;if(!n||a&&(r=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=n}continue;case"BADCUE":n||(t.state="ID")}}}catch{t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||e.state==="HEADER")&&(e.buffer+=`

`,e.parse()),e.state==="INITIAL"||e.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const Up=/\r\n|\n\r|\n|\r/g,qn=function(e,t,s=0){return e.slice(s,s+t.length)===t},Gp=function(e){let t=parseInt(e.slice(-3));const s=parseInt(e.slice(-6,-4)),i=parseInt(e.slice(-9,-7)),n=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!K(t)||!K(s)||!K(i)||!K(n))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*s,t+=60*1e3*i,t+=3600*1e3*n,t};function Vo(o,e,t){return ii(o.toString())+ii(e.toString())+ii(t)}const Hp=function(e,t,s){let i=e[t],n=e[i.prevCC];if(!n||!n.new&&i.new){e.ccOffset=e.presentationOffset=i.start,i.new=!1;return}for(;(r=n)!=null&&r.new;){var r;e.ccOffset+=i.start-n.start,i.new=!1,i=n,n=e[i.prevCC]}e.presentationOffset=s};function Kp(o,e,t,s,i,n,r){const a=new Np,c=Ve(new Uint8Array(o)).trim().replace(Up,`
`).split(`
`),l=[],h=e?jg(e.baseTime,e.timescale):0;let u="00:00.000",d=0,A=0,f,g=!0;a.oncue=function(m){const E=t[s];let p=t.ccOffset;const I=(d-h)/9e4;if(E!=null&&E.new&&(A!==void 0?p=t.ccOffset=E.start:Hp(t,s,I)),I){if(!e){f=new Error("Missing initPTS for VTT MPEGTS");return}p=I-t.presentationOffset}const C=m.endTime-m.startTime,T=Ke((m.startTime+p-A)*9e4,i*9e4)/9e4;m.startTime=Math.max(T,0),m.endTime=Math.max(T+C,0);const L=m.text.trim();m.text=decodeURIComponent(encodeURIComponent(L)),m.id||(m.id=Vo(m.startTime,m.endTime,L)),m.endTime>0&&l.push(m)},a.onparsingerror=function(m){f=m},a.onflush=function(){if(f){r(f);return}n(l)},c.forEach(m=>{if(g)if(qn(m,"X-TIMESTAMP-MAP=")){g=!1,m.slice(16).split(",").forEach(E=>{qn(E,"LOCAL:")?u=E.slice(6):qn(E,"MPEGTS:")&&(d=parseInt(E.slice(7)))});try{A=Gp(u)/1e3}catch(E){f=E}return}else m===""&&(g=!1);a.parse(m+`
`)}),a.flush()}const Wn="stpp.ttml.im1t",ou=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,au=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,$p={left:"start",center:"center",right:"end",start:"start",end:"end"};function Rl(o,e,t,s){const i=z(new Uint8Array(o),["mdat"]);if(i.length===0){s(new Error("Could not parse IMSC1 mdat"));return}const n=i.map(a=>Ve(a)),r=Wg(e.baseTime,1,e.timescale);try{n.forEach(a=>t(Vp(a,r)))}catch(a){s(a)}}function Vp(o,e){const i=new DOMParser().parseFromString(o,"text/xml").getElementsByTagName("tt")[0];if(!i)throw new Error("Invalid ttml");const n={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},r=Object.keys(n).reduce((u,d)=>(u[d]=i.getAttribute(`ttp:${d}`)||n[d],u),{}),a=i.getAttribute("xml:space")!=="preserve",c=Dl(jn(i,"styling","style")),l=Dl(jn(i,"layout","region")),h=jn(i,"body","[begin]");return[].map.call(h,u=>{const d=lu(u,a);if(!d||!u.hasAttribute("begin"))return null;const A=Xn(u.getAttribute("begin"),r),f=Xn(u.getAttribute("dur"),r);let g=Xn(u.getAttribute("end"),r);if(A===null)throw bl(u);if(g===null){if(f===null)throw bl(u);g=A+f}const m=new $o(A-e,g-e,d);m.id=Vo(m.startTime,m.endTime,m.text);const E=l[u.getAttribute("region")],p=c[u.getAttribute("style")],I=Yp(E,p,c),{textAlign:C}=I;if(C){const T=$p[C];T&&(m.lineAlign=T),m.align=C}return oe(m,I),m}).filter(u=>u!==null)}function jn(o,e,t){const s=o.getElementsByTagName(e)[0];return s?[].slice.call(s.querySelectorAll(t)):[]}function Dl(o){return o.reduce((e,t)=>{const s=t.getAttribute("xml:id");return s&&(e[s]=t),e},{})}function lu(o,e){return[].slice.call(o.childNodes).reduce((t,s,i)=>{var n;return s.nodeName==="br"&&i?t+`
`:(n=s.childNodes)!=null&&n.length?lu(s,e):e?t+s.textContent.trim().replace(/\s+/g," "):t+s.textContent},"")}function Yp(o,e,t){const s="http://www.w3.org/ns/ttml#styling";let i=null;const n=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],r=o!=null&&o.hasAttribute("style")?o.getAttribute("style"):null;return r&&t.hasOwnProperty(r)&&(i=t[r]),n.reduce((a,c)=>{const l=Jn(e,s,c)||Jn(o,s,c)||Jn(i,s,c);return l&&(a[c]=l),a},{})}function Jn(o,e,t){return o&&o.hasAttributeNS(e,t)?o.getAttributeNS(e,t):null}function bl(o){return new Error(`Could not parse ttml timestamp ${o}`)}function Xn(o,e){if(!o)return null;let t=iu(o);return t===null&&(ou.test(o)?t=qp(o,e):au.test(o)&&(t=Wp(o,e))),t}function qp(o,e){const t=ou.exec(o),s=(t[4]|0)+(t[5]|0)/e.subFrameRate;return(t[1]|0)*3600+(t[2]|0)*60+(t[3]|0)+s/e.frameRate}function Wp(o,e){const t=au.exec(o),s=Number(t[1]);switch(t[2]){case"h":return s*3600;case"m":return s*60;case"ms":return s*1e3;case"f":return s/e.frameRate;case"t":return s/e.tickRate}return s}class Di{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,s){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=s,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}class jp{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=_l(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(y.FRAG_LOADING,this.onFragLoading,this),e.on(y.FRAG_LOADED,this.onFragLoaded,this),e.on(y.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(y.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(y.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(y.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(y.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(y.FRAG_LOADING,this.onFragLoading,this),e.off(y.FRAG_LOADED,this.onFragLoaded,this),e.off(y.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(y.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(y.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(y.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){const e=new Di(this,"textTrack1"),t=new Di(this,"textTrack2"),s=new Di(this,"textTrack3"),i=new Di(this,"textTrack4");this.cea608Parser1=new Ll(1,e,t),this.cea608Parser2=new Ll(3,s,i)}addCues(e,t,s,i,n){let r=!1;for(let a=n.length;a--;){const c=n[a],l=Jp(c[0],c[1],t,s);if(l>=0&&(c[0]=Math.min(c[0],t),c[1]=Math.max(c[1],s),r=!0,l/(s-t)>.5))return}if(r||n.push([t,s]),this.config.renderTextTracksNatively){const a=this.captionsTracks[e];this.Cues.newCue(a,t,s,i)}else{const a=this.Cues.newCue(null,t,s,i);this.hls.trigger(y.CUES_PARSED,{type:"captions",cues:a,track:e})}}onInitPtsFound(e,{frag:t,id:s,initPTS:i,timescale:n,trackId:r}){const{unparsedVttFrags:a}=this;s===V.MAIN&&(this.initPTS[t.cc]={baseTime:i,timescale:n,trackId:r}),a.length&&(this.unparsedVttFrags=[],a.forEach(c=>{this.initPTS[c.frag.cc]?this.onFragLoaded(y.FRAG_LOADED,c):this.hls.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:c.frag,error:new Error("Subtitle discontinuity domain does not match main")})}))}getExistingTrack(e,t){const{media:s}=this;if(s)for(let i=0;i<s.textTracks.length;i++){const n=s.textTracks[i];if(wl(n,{name:e,lang:t,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return n}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:s,media:i}=this,{label:n,languageCode:r}=t[e],a=this.getExistingTrack(n,r);if(a)s[e]=a,xs(s[e]),zh(s[e],i);else{const c=this.createTextTrack("captions",n,r);c&&(c[e]=!0,s[e]=c)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const s=t.label,i={_id:e,label:s,kind:"captions",default:t.media?!!t.media.default:!1,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=i,this.hls.trigger(y.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[i]})}createTextTrack(e,t,s){const i=this.media;if(i)return i.addTextTrack(e,t,s)}onMediaAttaching(e,t){this.media=t.media,t.mediaSource||this._cleanTracks()}onMediaDetaching(e,t){const s=!!t.transferMedia;if(this.media=null,s)return;const{captionsTracks:i}=this;Object.keys(i).forEach(n=>{xs(i[n]),delete i[n]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=_l(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let s=0;s<t.length;s++)xs(t[s])}onSubtitleTracksUpdated(e,t){const s=t.subtitleTracks||[],i=s.some(n=>n.textCodec===Wn);if(this.config.enableWebVTT||i&&this.config.enableIMSC1){if(Nh(this.tracks,s)){this.tracks=s;return}if(this.textTracks=[],this.tracks=s,this.config.renderTextTracksNatively){const r=this.media,a=r?sn(r.textTracks):null;if(this.tracks.forEach((c,l)=>{let h;if(a){let u=null;for(let d=0;d<a.length;d++)if(a[d]&&wl(a[d],c)){u=a[d],a[d]=null;break}u&&(h=u)}if(h)xs(h);else{const u=cu(c);h=this.createTextTrack(u,c.name,c.lang),h&&(h.mode="disabled")}h&&this.textTracks.push(h)}),a!=null&&a.length){const c=a.filter(l=>l!==null).map(l=>l.label);c.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${c.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const r=this.tracks.map(a=>({label:a.name,kind:a.type.toLowerCase(),default:a.default,subtitleTrack:a}));this.hls.trigger(y.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:r})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(s=>{const i=/(?:CC|SERVICE)([1-4])/.exec(s.instreamId);if(!i)return;const n=`textTrack${i[1]}`,r=this.captionsProperties[n];r&&(r.label=s.name,s.lang&&(r.languageCode=s.lang),r.media=s)})}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return t?.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){if(this.enabled&&t.frag.type===V.MAIN){var s,i;const{cea608Parser1:n,cea608Parser2:r,lastSn:a}=this,{cc:c,sn:l}=t.frag,h=(s=(i=t.part)==null?void 0:i.index)!=null?s:-1;n&&r&&(l!==a+1||l===a&&h!==this.lastPartIndex+1||c!==this.lastCc)&&(n.reset(),r.reset()),this.lastCc=c,this.lastSn=l,this.lastPartIndex=h}}onFragLoaded(e,t){const{frag:s,payload:i}=t;if(s.type===V.SUBTITLE)if(i.byteLength){const n=s.decryptdata,r="stats"in t;if(n==null||!n.encrypted||r){const a=this.tracks[s.level],c=this.vttCCs;c[s.cc]||(c[s.cc]={start:s.start,prevCC:this.prevCC,new:!0},this.prevCC=s.cc),a&&a.textCodec===Wn?this._parseIMSC1(s,i):this._parseVTTs(t)}}else this.hls.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:s,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const s=this.hls;Rl(t,this.initPTS[e.cc],i=>{this._appendCues(i,e.level),s.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},i=>{s.logger.log(`Failed to parse IMSC1: ${i}`),s.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:i})})}_parseVTTs(e){var t;const{frag:s,payload:i}=e,{initPTS:n,unparsedVttFrags:r}=this,a=n.length-1;if(!n[s.cc]&&a===-1){r.push(e);return}const c=this.hls,l=(t=s.initSegment)!=null&&t.data?tt(s.initSegment.data,new Uint8Array(i)).buffer:i;Kp(l,this.initPTS[s.cc],this.vttCCs,s.cc,s.start,h=>{this._appendCues(h,s.level),c.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:s})},h=>{const u=h.message==="Missing initPTS for VTT MPEGTS";u?r.push(e):this._fallbackToIMSC1(s,i),c.logger.log(`Failed to parse VTT cue: ${h}`),!(u&&a>s.cc)&&c.trigger(y.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:s,error:h})})}_fallbackToIMSC1(e,t){const s=this.tracks[e.level];s.textCodec||Rl(t,this.initPTS[e.cc],()=>{s.textCodec=Wn,this._parseIMSC1(e,t)},()=>{s.textCodec="wvtt"})}_appendCues(e,t){const s=this.hls;if(this.config.renderTextTracksNatively){const i=this.textTracks[t];if(!i||i.mode==="disabled")return;e.forEach(n=>Zh(i,n))}else{const i=this.tracks[t];if(!i)return;const n=i.default?"default":"subtitles"+t;s.trigger(y.CUES_PARSED,{type:"subtitles",cues:e,track:n})}}onFragDecrypted(e,t){const{frag:s}=t;s.type===V.SUBTITLE&&this.onFragLoaded(y.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){if(!this.enabled||!this.config.enableCEA708Captions)return;const{frag:s,samples:i}=t;if(!(s.type===V.MAIN&&this.closedCaptionsForLevel(s)==="NONE"))for(let n=0;n<i.length;n++){const r=i[n].bytes;if(r){this.cea608Parser1||this.initCea608Parsers();const a=this.extractCea608Data(r);this.cea608Parser1.addData(i[n].pts,a[0]),this.cea608Parser2.addData(i[n].pts,a[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:s,endOffsetSubtitles:i,type:n}){const{media:r}=this;if(!(!r||r.currentTime<s)){if(!n||n==="video"){const{captionsTracks:a}=this;Object.keys(a).forEach(c=>qr(a[c],t,s))}if(this.config.renderTextTracksNatively&&t===0&&i!==void 0){const{textTracks:a}=this;Object.keys(a).forEach(c=>qr(a[c],t,i))}}}extractCea608Data(e){const t=[[],[]],s=e[0]&31;let i=2;for(let n=0;n<s;n++){const r=e[i++],a=127&e[i++],c=127&e[i++];if(a===0&&c===0)continue;if((4&r)!==0){const h=3&r;(h===0||h===1)&&(t[h].push(a),t[h].push(c))}}return t}}function cu(o){return o.characteristics&&/transcribes-spoken-dialog/gi.test(o.characteristics)&&/describes-music-and-sound/gi.test(o.characteristics)?"captions":"subtitles"}function wl(o,e){return!!o&&o.kind===cu(e)&&Kr(e,o)}function Jp(o,e,t,s){return Math.min(e,s)-Math.max(o,t)}function _l(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}const Xp=/\s/,zp={newCue(o,e,t,s){const i=[];let n,r,a,c,l;const h=self.VTTCue||self.TextTrackCue;for(let d=0;d<s.rows.length;d++)if(n=s.rows[d],a=!0,c=0,l="",!n.isEmpty()){var u;for(let g=0;g<n.chars.length;g++)Xp.test(n.chars[g].uchar)&&a?c++:(l+=n.chars[g].uchar,a=!1);n.cueStartTime=e,e===t&&(t+=1e-4),c>=16?c--:c++;const A=ru(l.trim()),f=Vo(e,t,A);o!=null&&(u=o.cues)!=null&&u.getCueById(f)||(r=new h(e,t,A),r.id=f,r.line=d+1,r.align="left",r.position=10+Math.min(80,Math.floor(c*8/32)*10),i.push(r))}return o&&i.length&&(i.sort((d,A)=>d.line==="auto"||A.line==="auto"?0:d.line>8&&A.line>8?A.line-d.line:d.line-A.line),i.forEach(d=>Zh(o,d))),i}};function Zp(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}const e0=/(\d+)-(\d+)\/(\d+)/;class kl{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||n0,this.controller=new self.AbortController,this.stats=new So}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,s){const i=this.stats;if(i.loading.start)throw new Error("Loader can only be used once.");i.loading.start=self.performance.now();const n=t0(e,this.controller.signal),r=e.responseType==="arraybuffer",a=r?"byteLength":"length",{maxTimeToFirstByteMs:c,maxLoadTimeMs:l}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=s,this.request=this.fetchSetup(e,n),self.clearTimeout(this.requestTimeout),t.timeout=c&&K(c)?c:l,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(i,e,this.response))},t.timeout),(di(this.request)?this.request.then(self.fetch):self.fetch(this.request)).then(u=>{var d;this.response=this.loader=u;const A=Math.max(self.performance.now(),i.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=l,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(i,e,this.response))},l-(A-i.loading.start)),!u.ok){const{status:g,statusText:m}=u;throw new r0(m||"fetch, bad network response",g,u)}i.loading.first=A,i.total=i0(u.headers)||i.total;const f=(d=this.callbacks)==null?void 0:d.onProgress;return f&&K(t.highWaterMark)?this.loadProgressively(u,i,e,t.highWaterMark,f):r?u.arrayBuffer():e.responseType==="json"?u.json():u.text()}).then(u=>{var d,A;const f=this.response;if(!f)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),i.loading.end=Math.max(self.performance.now(),i.loading.first);const g=u[a];g&&(i.loaded=i.total=g);const m={url:f.url,data:u,code:f.status},E=(d=this.callbacks)==null?void 0:d.onProgress;E&&!K(t.highWaterMark)&&E(i,e,u,f),(A=this.callbacks)==null||A.onSuccess(m,i,e,f)}).catch(u=>{var d;if(self.clearTimeout(this.requestTimeout),i.aborted)return;const A=u&&u.code||0,f=u?u.message:null;(d=this.callbacks)==null||d.onError({code:A,text:f},e,u?u.details:null,i)})}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,s,i=0,n){const r=new Ih,a=e.body.getReader(),c=()=>a.read().then(l=>{if(l.done)return r.dataLength&&n(t,s,r.flush().buffer,e),Promise.resolve(new ArrayBuffer(0));const h=l.value,u=h.length;return t.loaded+=u,u<i||r.dataLength?(r.push(h),r.dataLength>=i&&n(t,s,r.flush().buffer,e)):n(t,s,h.buffer,e),c()}).catch(()=>Promise.reject());return c()}}function t0(o,e){const t={method:"GET",mode:"cors",credentials:"same-origin",signal:e,headers:new self.Headers(oe({},o.headers))};return o.rangeEnd&&t.headers.set("Range","bytes="+o.rangeStart+"-"+String(o.rangeEnd-1)),t}function s0(o){const e=e0.exec(o);if(e)return parseInt(e[2])-parseInt(e[1])+1}function i0(o){const e=o.get("Content-Range");if(e){const s=s0(e);if(K(s))return s}const t=o.get("Content-Length");if(t)return parseInt(t)}function n0(o,e){return new self.Request(o.url,e)}class r0 extends Error{constructor(e,t,s){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=s}}const o0=/^age:\s*[\d.]+\s*$/im;class hu{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new So,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,s){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=s,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const s=this.loader=new self.XMLHttpRequest,i=this.stats;i.loading.first=0,i.loaded=0,i.aborted=!1;const n=this.xhrSetup;n?Promise.resolve().then(()=>{if(!(this.loader!==s||this.stats.aborted))return n(s,t.url)}).catch(r=>{if(!(this.loader!==s||this.stats.aborted))return s.open("GET",t.url,!0),n(s,t.url)}).then(()=>{this.loader!==s||this.stats.aborted||this.openAndSendXhr(s,t,e)}).catch(r=>{var a;(a=this.callbacks)==null||a.onError({code:s.status,text:r.message},t,s,i)}):this.openAndSendXhr(s,t,e)}openAndSendXhr(e,t,s){e.readyState||e.open("GET",t.url,!0);const i=t.headers,{maxTimeToFirstByteMs:n,maxLoadTimeMs:r}=s.loadPolicy;if(i)for(const a in i)e.setRequestHeader(a,i[a]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),s.timeout=n&&K(n)?n:r,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),s.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:s}=this;if(!e||!t)return;const i=t.readyState,n=this.config;if(!s.aborted&&i>=2&&(s.loading.first===0&&(s.loading.first=Math.max(self.performance.now(),s.loading.start),n.timeout!==n.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),n.timeout=n.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),n.loadPolicy.maxLoadTimeMs-(s.loading.first-s.loading.start)))),i===4)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const l=t.status,h=t.responseType==="text"?t.responseText:null;if(l>=200&&l<300){const f=h??t.response;if(f!=null){var r,a;s.loading.end=Math.max(self.performance.now(),s.loading.first);const g=t.responseType==="arraybuffer"?f.byteLength:f.length;s.loaded=s.total=g,s.bwEstimate=s.total*8e3/(s.loading.end-s.loading.first);const m=(r=this.callbacks)==null?void 0:r.onProgress;m&&m(s,e,f,t);const E={url:t.responseURL,data:f,code:l};(a=this.callbacks)==null||a.onSuccess(E,s,e,t);return}}const u=n.loadPolicy.errorRetry,d=s.retry,A={url:e.url,data:void 0,code:l};if(fn(u,d,!1,A))this.retry(u);else{var c;re.error(`${l} while loading ${e.url}`),(c=this.callbacks)==null||c.onError({code:l,text:t.statusText},e,t,s)}}}loadtimeout(){if(!this.config)return;const e=this.config.loadPolicy.timeoutRetry,t=this.stats.retry;if(fn(e,t,!0))this.retry(e);else{var s;re.warn(`timeout while loading ${(s=this.context)==null?void 0:s.url}`);const i=this.callbacks;i&&(this.abortInternal(),i.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:s}=this;this.retryDelay=Lo(e,s.retry),s.retry++,re.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${t?.url}, retrying ${s.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&o0.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}const a0={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},l0=ne(ne({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,startOnSegmentBoundary:!1,maxBufferSize:60*1e3*1e3,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncMode:"edge",liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:hu,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:yf,bufferController:hm,capLevelController:Go,errorController:xf,fpsController:up,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:lh,requireKeySystemAccessOnStart:!1,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,preserveManualLevelOnError:!1,certLoadPolicy:{default:a0},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},c0()),{},{subtitleStreamController:Sp,subtitleTrackController:fp,timelineController:jp,audioStreamController:om,audioTrackController:am,emeController:Ds,cmcdController:ap,contentSteeringController:cp,interstitialsController:Tp});function c0(){return{cueHandler:zp,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function h0(o,e,t){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(e.liveMaxLatencyDurationCount!==void 0&&(e.liveSyncDurationCount===void 0||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(e.liveMaxLatencyDuration!==void 0&&(e.liveSyncDuration===void 0||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const s=jr(o),i=["manifest","level","frag"],n=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return i.forEach(r=>{const a=`${r==="level"?"playlist":r}LoadPolicy`,c=e[a]===void 0,l=[];n.forEach(h=>{const u=`${r}Loading${h}`,d=e[u];if(d!==void 0&&c){l.push(u);const A=s[a].default;switch(e[a]={default:A},h){case"TimeOut":A.maxLoadTimeMs=d,A.maxTimeToFirstByteMs=d;break;case"MaxRetry":A.errorRetry.maxNumRetry=d,A.timeoutRetry.maxNumRetry=d;break;case"RetryDelay":A.errorRetry.retryDelayMs=d,A.timeoutRetry.retryDelayMs=d;break;case"MaxRetryTimeout":A.errorRetry.maxRetryDelayMs=d,A.timeoutRetry.maxRetryDelayMs=d;break}}}),l.length&&t.warn(`hls.js config: "${l.join('", "')}" setting(s) are deprecated, use "${a}": ${le(e[a])}`)}),ne(ne({},s),e)}function jr(o){return o&&typeof o=="object"?Array.isArray(o)?o.map(jr):Object.keys(o).reduce((e,t)=>(e[t]=jr(o[t]),e),{}):o}function u0(o,e){const t=o.loader;t!==kl&&t!==hu?(e.log("[config]: Custom loader detected, cannot enable progressive streaming"),o.progressive=!1):Zp()&&(o.loader=kl,o.progressive=!0,o.enableSoftwareAES=!0,e.log("[config]: Progressive streaming enabled, using FetchLoader"))}const nn=2,d0=.1,A0=.05,f0=100;class g0 extends ih{constructor(e,t){super("gap-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.media=null,this.mediaSource=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.buffered={},this.lastCurrentTime=0,this.ended=0,this.waiting=0,this.onMediaPlaying=()=>{this.ended=0,this.waiting=0},this.onMediaWaiting=()=>{var s;(s=this.media)!=null&&s.seeking||(this.waiting=self.performance.now(),this.tick())},this.onMediaEnded=()=>{if(this.hls){var s;this.ended=((s=this.media)==null?void 0:s.currentTime)||1,this.hls.trigger(y.MEDIA_ENDED,{stalled:!1})}},this.hls=e,this.fragmentTracker=t,this.registerListeners()}registerListeners(){const{hls:e}=this;e&&(e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.BUFFER_APPENDED,this.onBufferAppended,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.BUFFER_APPENDED,this.onBufferAppended,this))}destroy(){super.destroy(),this.unregisterListeners(),this.media=this.hls=this.fragmentTracker=null,this.mediaSource=void 0}onMediaAttached(e,t){this.setInterval(f0),this.mediaSource=t.mediaSource;const s=this.media=t.media;Pe(s,"playing",this.onMediaPlaying),Pe(s,"waiting",this.onMediaWaiting),Pe(s,"ended",this.onMediaEnded)}onMediaDetaching(e,t){this.clearInterval();const{media:s}=this;s&&(Ue(s,"playing",this.onMediaPlaying),Ue(s,"waiting",this.onMediaWaiting),Ue(s,"ended",this.onMediaEnded),this.media=null),this.mediaSource=void 0}onBufferAppended(e,t){this.buffered=t.timeRanges}get hasBuffered(){return Object.keys(this.buffered).length>0}tick(){var e;if(!((e=this.media)!=null&&e.readyState)||!this.hasBuffered)return;const t=this.media.currentTime;this.poll(t,this.lastCurrentTime),this.lastCurrentTime=t}poll(e,t){var s,i;const n=(s=this.hls)==null?void 0:s.config;if(!n)return;const r=this.media;if(!r)return;const{seeking:a}=r,c=this.seeking&&!a,l=!this.seeking&&a,h=r.paused&&!a||r.ended||r.playbackRate===0;if(this.seeking=a,e!==t){t&&(this.ended=0),this.moved=!0,a||(this.nudgeRetry=0,n.nudgeOnVideoHole&&!h&&e>t&&this.nudgeOnVideoHole(e,t)),this.waiting===0&&this.stallResolved(e);return}if(l||c){c&&this.stallResolved(e);return}if(h){this.nudgeRetry=0,this.stallResolved(e),!this.ended&&r.ended&&this.hls&&(this.ended=e||1,this.hls.trigger(y.MEDIA_ENDED,{stalled:!1}));return}if(!J.getBuffered(r).length){this.nudgeRetry=0;return}const u=J.bufferInfo(r,e,0),d=u.nextStart||0,A=this.fragmentTracker;if(a&&A&&this.hls){const L=Pl(this.hls.inFlightFragments,e),S=u.len>nn,x=!d||L||d-e>nn&&!A.getPartialFragment(e);if(S||x)return;this.moved=!1}const f=(i=this.hls)==null?void 0:i.latestLevelDetails;if(!this.moved&&this.stalled!==null&&A){if(!(u.len>0)&&!d)return;const S=Math.max(d,u.start||0)-e,v=!!(f!=null&&f.live)?f.targetduration*2:nn,B=bi(e,A);if(S>0&&(S<=v||B)){r.paused||this._trySkipBufferHole(B);return}}const g=n.detectStallWithCurrentTimeMs,m=self.performance.now(),E=this.waiting;let p=this.stalled;if(p===null)if(E>0&&m-E<g)p=this.stalled=E;else{this.stalled=m;return}const I=m-p;if(!a&&(I>=g||E)&&this.hls){var C;if(((C=this.mediaSource)==null?void 0:C.readyState)==="ended"&&!(f!=null&&f.live)&&Math.abs(e-(f?.edge||0))<1){if(this.ended)return;this.ended=e||1,this.hls.trigger(y.MEDIA_ENDED,{stalled:!0});return}if(this._reportStall(u),!this.media||!this.hls)return}const T=J.bufferInfo(r,e,n.maxBufferHole);this._tryFixBufferStall(T,I,e)}stallResolved(e){const t=this.stalled;if(t&&this.hls&&(this.stalled=null,this.stallReported)){const s=self.performance.now()-t;this.log(`playback not stuck anymore @${e}, after ${Math.round(s)}ms`),this.stallReported=!1,this.waiting=0,this.hls.trigger(y.STALL_RESOLVED,{})}}nudgeOnVideoHole(e,t){var s;const i=this.buffered.video;if(this.hls&&this.media&&this.fragmentTracker&&(s=this.buffered.audio)!=null&&s.length&&i&&i.length>1&&e>i.end(0)){const n=J.bufferedInfo(J.timeRangesToArray(this.buffered.audio),e,0);if(n.len>1&&t>=n.start){const r=J.timeRangesToArray(i),a=J.bufferedInfo(r,t,0).bufferedIndex;if(a>-1&&a<r.length-1){const c=J.bufferedInfo(r,e,0).bufferedIndex,l=r[a].end,h=r[a+1].start;if((c===-1||c>a)&&h-l<1&&e-l<2){const u=new Error(`nudging playhead to flush pipeline after video hole. currentTime: ${e} hole: ${l} -> ${h} buffered index: ${c}`);this.warn(u.message),this.media.currentTime+=1e-6;let d=bi(e,this.fragmentTracker);d&&"fragment"in d?d=d.fragment:d||(d=void 0);const A=J.bufferInfo(this.media,e,0);this.hls.trigger(y.ERROR,{type:q.MEDIA_ERROR,details:k.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:u,reason:u.message,frag:d,buffer:A.len,bufferInfo:A})}}}}}_tryFixBufferStall(e,t,s){var i,n;const{fragmentTracker:r,media:a}=this,c=(i=this.hls)==null?void 0:i.config;if(!a||!r||!c)return;const l=(n=this.hls)==null?void 0:n.latestLevelDetails,h=bi(s,r);if((h||l!=null&&l.live&&s<l.fragmentStart)&&(this._trySkipBufferHole(h)||!this.media))return;const u=e.buffered,d=this.adjacentTraversal(e,s);(u&&u.length>1&&e.len>c.maxBufferHole||e.nextStart&&(e.nextStart-s<c.maxBufferHole||d))&&(t>c.highBufferWatchdogPeriod*1e3||this.waiting)&&(this.warn("Trying to nudge playhead over buffer-hole"),this._tryNudgeBuffer(e))}adjacentTraversal(e,t){const s=this.fragmentTracker,i=e.nextStart;if(s&&i){const n=s.getFragAtPos(t,V.MAIN),r=s.getFragAtPos(i,V.MAIN);if(n&&r)return r.sn-n.sn<2}return!1}_reportStall(e){const{hls:t,media:s,stallReported:i,stalled:n}=this;if(!i&&n!==null&&s&&t){this.stallReported=!0;const r=new Error(`Playback stalling at @${s.currentTime} due to low buffer (${le(e)})`);this.warn(r.message),t.trigger(y.ERROR,{type:q.MEDIA_ERROR,details:k.BUFFER_STALLED_ERROR,fatal:!1,error:r,buffer:e.len,bufferInfo:e,stalled:{start:n}})}}_trySkipBufferHole(e){var t;const{fragmentTracker:s,media:i}=this,n=(t=this.hls)==null?void 0:t.config;if(!i||!s||!n)return 0;const r=i.currentTime,a=J.bufferInfo(i,r,0),c=r<a.start?a.start:a.nextStart;if(c&&this.hls){const h=a.len<=n.maxBufferHole,u=a.len>0&&a.len<1&&i.readyState<3,d=c-r;if(d>0&&(h||u)){if(d>n.maxBufferHole){let f=!1;if(r===0){const g=s.getAppendedFrag(0,V.MAIN);g&&c<g.end&&(f=!0)}if(!f&&e){var l;if(!((l=this.hls.loadLevelObj)!=null&&l.details)||Pl(this.hls.inFlightFragments,c))return 0;let m=!1,E=e.end;for(;E<c;){const p=bi(E,s);if(p)E+=p.duration;else{m=!0;break}}if(m)return 0}}const A=Math.max(c+A0,r+d0);if(this.warn(`skipping hole, adjusting currentTime from ${r} to ${A}`),this.moved=!0,i.currentTime=A,!(e!=null&&e.gap)){const f=new Error(`fragment loaded with buffer holes, seeking from ${r} to ${A}`),g={type:q.MEDIA_ERROR,details:k.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:f,reason:f.message,buffer:a.len,bufferInfo:a};e&&("fragment"in e?g.part=e:g.frag=e),this.hls.trigger(y.ERROR,g)}return A}}return 0}_tryNudgeBuffer(e){const{hls:t,media:s,nudgeRetry:i}=this,n=t?.config;if(!s||!n)return 0;const r=s.currentTime;if(this.nudgeRetry++,i<n.nudgeMaxRetry){const a=r+(i+1)*n.nudgeOffset,c=new Error(`Nudging 'currentTime' from ${r} to ${a}`);this.warn(c.message),s.currentTime=a,t.trigger(y.ERROR,{type:q.MEDIA_ERROR,details:k.BUFFER_NUDGE_ON_STALL,error:c,fatal:!1,buffer:e.len,bufferInfo:e})}else{const a=new Error(`Playhead still not moving while enough data buffered @${r} after ${n.nudgeMaxRetry} nudges`);this.error(a.message),t.trigger(y.ERROR,{type:q.MEDIA_ERROR,details:k.BUFFER_STALLED_ERROR,error:a,fatal:!0,buffer:e.len,bufferInfo:e})}}}function Pl(o,e){const t=Fl(o.main);if(t&&t.start<=e)return t;const s=Fl(o.audio);return s&&s.start<=e?s:null}function Fl(o){if(!o)return null;switch(o.state){case M.IDLE:case M.STOPPED:case M.ENDED:case M.ERROR:return null}return o.frag}function bi(o,e){return e.getAppendedFrag(o,V.MAIN)||e.getPartialFragment(o)}const m0=.25;function Jr(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function zn(o,e,t,s,i){let n=new o(e,t,"");try{n.value=s,i&&(n.type=i)}catch{n=new o(e,t,le(i?ne({type:i},s):s))}return n}const wi=(()=>{const o=Jr();try{o&&new o(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();class p0{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.removeCues=!0,this.assetCue=void 0,this.onEventCueEnter=()=>{this.hls&&this.hls.trigger(y.EVENT_CUE_ENTER,{})},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=this.onEventCueEnter=null}_registerListeners(){const{hls:e}=this;e&&(e.on(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(y.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(y.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this))}_unregisterListeners(){const{hls:e}=this;e&&(e.off(y.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(y.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(y.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(y.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this))}onMediaAttaching(e,t){var s;this.media=t.media,((s=t.overrides)==null?void 0:s.cueRemoval)===!1&&(this.removeCues=!1)}onMediaAttached(){var e;const t=(e=this.hls)==null?void 0:e.latestLevelDetails;t&&this.updateDateRangeCues(t)}onMediaDetaching(e,t){this.media=null,!t.transferMedia&&(this.id3Track&&(this.removeCues&&xs(this.id3Track,this.onEventCueEnter),this.id3Track=null),this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const s=e[t];if(s.kind==="metadata"&&s.label==="id3")return zh(s,this.media),s}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media||!this.hls)return;const{enableEmsgMetadataCues:s,enableID3MetadataCues:i}=this.hls.config;if(!s&&!i)return;const{samples:n}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const r=Jr();if(r)for(let a=0;a<n.length;a++){const c=n[a].type;if(c===$e.emsg&&!s||!i)continue;const l=vh(n[a].data),h=n[a].pts;let u=h+n[a].duration;u>wi&&(u=wi),u-h<=0&&(u=h+m0);for(let A=0;A<l.length;A++){const f=l[A];if(!Lh(f)){this.updateId3CueEnds(h,c);const g=zn(r,h,u,f,c);g&&this.id3Track.addCue(g)}}}}updateId3CueEnds(e,t){var s;const i=(s=this.id3Track)==null?void 0:s.cues;if(i)for(let n=i.length;n--;){const r=i[n];r.type===t&&r.startTime<e&&r.endTime===wi&&(r.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:s,type:i}){const{id3Track:n,hls:r}=this;if(!r)return;const{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:c}}=r;if(n&&(a||c)){let l;i==="audio"?l=h=>h.type===$e.audioId3&&c:i==="video"?l=h=>h.type===$e.emsg&&a:l=h=>h.type===$e.audioId3&&c||h.type===$e.emsg&&a,qr(n,t,s,l)}}onLevelUpdated(e,{details:t}){this.updateDateRangeCues(t,!0)}onLevelPtsUpdated(e,t){Math.abs(t.drift)>.01&&this.updateDateRangeCues(t.details)}updateDateRangeCues(e,t){if(!this.hls||!this.media)return;const{assetPlayerId:s,timelineOffset:i,enableDateRangeMetadataCues:n,interstitialsController:r}=this.hls.config;if(!n)return;const a=Jr();if(s&&i&&!r){const{fragmentStart:g,fragmentEnd:m}=e;let E=this.assetCue;E?(E.startTime=g,E.endTime=m):a&&(E=this.assetCue=zn(a,g,m,{assetPlayerId:this.hls.config.assetPlayerId},"hlsjs.interstitial.asset"),E&&(E.id=s,this.id3Track||(this.id3Track=this.createTrack(this.media)),this.id3Track.addCue(E),E.addEventListener("enter",this.onEventCueEnter)))}if(!e.hasProgramDateTime)return;const{id3Track:c}=this,{dateRanges:l}=e,h=Object.keys(l);let u=this.dateRangeCuesAppended;if(c&&t){var d;if((d=c.cues)!=null&&d.length){const g=Object.keys(u).filter(m=>!h.includes(m));for(let m=g.length;m--;){var A;const E=g[m],p=(A=u[E])==null?void 0:A.cues;delete u[E],p&&Object.keys(p).forEach(I=>{const C=p[I];if(C){C.removeEventListener("enter",this.onEventCueEnter);try{c.removeCue(C)}catch{}}})}}else u=this.dateRangeCuesAppended={}}const f=e.fragments[e.fragments.length-1];if(!(h.length===0||!K(f?.programDateTime))){this.id3Track||(this.id3Track=this.createTrack(this.media));for(let g=0;g<h.length;g++){const m=h[g],E=l[m],p=E.startTime,I=u[m],C=I?.cues||{};let T=I?.durationKnown||!1,L=wi;const{duration:S,endDate:x}=E;if(x&&S!==null)L=p+S,T=!0;else if(E.endOnNext&&!T){const B=h.reduce((R,D)=>{if(D!==E.id){const b=l[D];if(b.class===E.class&&b.startDate>E.startDate&&(!R||E.startDate<R.startDate))return b}return R},null);B&&(L=B.startTime,T=!0)}const v=Object.keys(E.attr);for(let B=0;B<v.length;B++){const R=v[B];if(!Of(R))continue;const D=C[R];if(D)T&&!(I!=null&&I.durationKnown)?D.endTime=L:Math.abs(D.startTime-p)>.01&&(D.startTime=p,D.endTime=L);else if(a){let b=E.attr[R];Nf(R)&&(b=Qc(b));const F=zn(a,p,L,{key:R,data:b},$e.dateRange);F&&(F.id=m,this.id3Track.addCue(F),C[R]=F,r&&(R==="X-ASSET-LIST"||R==="X-ASSET-URL")&&F.addEventListener("enter",this.onEventCueEnter))}}u[m]={cues:C,dateRange:E,durationKnown:T}}}}}class E0{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.currentTime=0,this.stallCount=0,this._latency=null,this._targetLatencyUpdated=!1,this.onTimeupdate=()=>{const{media:t}=this,s=this.levelDetails;if(!t||!s)return;this.currentTime=t.currentTime;const i=this.computeLatency();if(i===null)return;this._latency=i;const{lowLatencyMode:n,maxLiveSyncPlaybackRate:r}=this.config;if(!n||r===1||!s.live)return;const a=this.targetLatency;if(a===null)return;const c=i-a,l=Math.min(this.maxLatency,a+s.targetduration);if(c<l&&c>.05&&this.forwardBufferLength>1){const u=Math.min(2,Math.max(1,r)),d=Math.round(2/(1+Math.exp(-.75*c-this.edgeStalled))*20)/20,A=Math.min(u,Math.max(1,d));this.changeMediaPlaybackRate(t,A)}else t.playbackRate!==1&&t.playbackRate!==0&&this.changeMediaPlaybackRate(t,1)},this.hls=e,this.config=e.config,this.registerListeners()}get levelDetails(){var e;return((e=this.hls)==null?void 0:e.latestLevelDetails)||null}get latency(){return this._latency||0}get maxLatency(){const{config:e}=this;if(e.liveMaxLatencyDuration!==void 0)return e.liveMaxLatencyDuration;const t=this.levelDetails;return t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const e=this.levelDetails;if(e===null||this.hls===null)return null;const{holdBack:t,partHoldBack:s,targetduration:i}=e,{liveSyncDuration:n,liveSyncDurationCount:r,lowLatencyMode:a}=this.config,c=this.hls.userConfig;let l=a&&s||t;(this._targetLatencyUpdated||c.liveSyncDuration||c.liveSyncDurationCount||l===0)&&(l=n!==void 0?n:r*i);const h=i;return l+Math.min(this.stallCount*this.config.liveSyncOnStallIncrease,h)}set targetLatency(e){this.stallCount=0,this.config.liveSyncDuration=e,this._targetLatencyUpdated=!0}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency;if(e===null||t===null)return null;const s=this.levelDetails;if(s===null)return null;const i=s.edge,n=e-t-this.edgeStalled,r=i-s.totalduration,a=i-(this.config.lowLatencyMode&&s.partTarget||s.targetduration);return Math.min(Math.max(r,n),a)}get drift(){const e=this.levelDetails;return e===null?1:e.drift}get edgeStalled(){const e=this.levelDetails;if(e===null)return 0;const t=(this.config.lowLatencyMode&&e.partTarget||e.targetduration)*3;return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e}=this,t=this.levelDetails;if(!e||!t)return 0;const s=e.buffered.length;return(s?e.buffered.end(s-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.hls=null}registerListeners(){const{hls:e}=this;e&&(e.on(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(y.ERROR,this.onError,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(y.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(y.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(y.ERROR,this.onError,this))}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.onTimeupdate)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.onTimeupdate),this.media=null)}onManifestLoading(){this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){t.advanced&&this.onTimeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.onTimeupdate)}onError(e,t){var s;t.details===k.BUFFER_STALLED_ERROR&&(this.stallCount++,this.hls&&(s=this.levelDetails)!=null&&s.live&&this.hls.logger.warn("[latency-controller]: Stall detected, adjusting target latency"))}changeMediaPlaybackRate(e,t){var s,i;e.playbackRate!==t&&((s=this.hls)==null||s.logger.debug(`[latency-controller]: latency=${this.latency.toFixed(3)}, targetLatency=${(i=this.targetLatency)==null?void 0:i.toFixed(3)}, forwardBufferLength=${this.forwardBufferLength.toFixed(3)}: adjusting playback rate from ${e.playbackRate} to ${t}`),e.playbackRate=t)}estimateLiveEdge(){const e=this.levelDetails;return e===null?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return e===null?null:e-this.currentTime}}class I0 extends Uo{constructor(e,t){super(e,"level-controller"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this),e.on(y.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this),e.off(y.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(t=>{t.loadError=0,t.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const s=this.hls.config.preferManagedMediaSource,i=[],n={},r={};let a=!1,c=!1,l=!1;t.levels.forEach(h=>{const u=h.attrs;let{audioCodec:d,videoCodec:A}=h;d&&(h.audioCodec=d=hn(d,s)||void 0),A&&(A=h.videoCodec=ef(A));const{width:f,height:g,unknownCodecs:m}=h,E=m?.length||0;if(a||(a=!!(f&&g)),c||(c=!!A),l||(l=!!d),E||d&&!this.isAudioSupported(d)||A&&!this.isVideoSupported(A)){this.log(`Some or all CODECS not supported "${u.CODECS}"`);return}const{CODECS:p,"FRAME-RATE":I,"HDCP-LEVEL":C,"PATHWAY-ID":T,RESOLUTION:L,"VIDEO-RANGE":S}=u,v=`${`${T||"."}-`}${h.bitrate}-${L}-${I}-${p}-${S}-${C}`;if(n[v])if(n[v].uri!==h.url&&!h.attrs["PATHWAY-ID"]){const B=r[v]+=1;h.attrs["PATHWAY-ID"]=new Array(B+1).join(".");const R=this.createLevel(h);n[v]=R,i.push(R)}else n[v].addGroupId("audio",u.AUDIO),n[v].addGroupId("text",u.SUBTITLES);else{const B=this.createLevel(h);n[v]=B,r[v]=1,i.push(B)}}),this.filterAndSortMediaOptions(i,t,a,c,l)}createLevel(e){const t=new ci(e),s=e.supplemental;if(s!=null&&s.videoCodec&&!this.isVideoSupported(s.videoCodec)){const i=new Error(`SUPPLEMENTAL-CODECS not supported "${s.videoCodec}"`);this.log(i.message),t.supportedResult=jc(i,[])}return t}isAudioSupported(e){return ai(e,"audio",this.hls.config.preferManagedMediaSource)}isVideoSupported(e){return ai(e,"video",this.hls.config.preferManagedMediaSource)}filterAndSortMediaOptions(e,t,s,i,n){var r;let a=[],c=[],l=e;const h=((r=t.stats)==null?void 0:r.parsing)||{};if((s||i)&&n&&(l=l.filter(({videoCodec:p,videoRange:I,width:C,height:T})=>(!!p||!!(C&&T))&&uf(I))),l.length===0){Promise.resolve().then(()=>{if(this.hls){let p="no level with compatible codecs found in manifest",I=p;t.levels.length&&(I=`one or more CODECS in variant not supported: ${le(t.levels.map(T=>T.attrs.CODECS).filter((T,L,S)=>S.indexOf(T)===L))}`,this.warn(I),p+=` (${I})`);const C=new Error(p);this.hls.trigger(y.ERROR,{type:q.MEDIA_ERROR,details:k.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:C,reason:I})}}),h.end=performance.now();return}t.audioTracks&&(a=t.audioTracks.filter(p=>!p.audioCodec||this.isAudioSupported(p.audioCodec)),Ml(a)),t.subtitles&&(c=t.subtitles,Ml(c));const u=l.slice(0);l.sort((p,I)=>{if(p.attrs["HDCP-LEVEL"]!==I.attrs["HDCP-LEVEL"])return(p.attrs["HDCP-LEVEL"]||"")>(I.attrs["HDCP-LEVEL"]||"")?1:-1;if(s&&p.height!==I.height)return p.height-I.height;if(p.frameRate!==I.frameRate)return p.frameRate-I.frameRate;if(p.videoRange!==I.videoRange)return un.indexOf(p.videoRange)-un.indexOf(I.videoRange);if(p.videoCodec!==I.videoCodec){const C=La(p.videoCodec),T=La(I.videoCodec);if(C!==T)return T-C}if(p.uri===I.uri&&p.codecSet!==I.codecSet){const C=cn(p.codecSet),T=cn(I.codecSet);if(C!==T)return T-C}return p.averageBitrate!==I.averageBitrate?p.averageBitrate-I.averageBitrate:0});let d=u[0];if(this.steering&&(l=this.steering.filterParsedLevels(l),l.length!==u.length)){for(let p=0;p<u.length;p++)if(u[p].pathwayId===l[0].pathwayId){d=u[p];break}}this._levels=l;for(let p=0;p<l.length;p++)if(l[p]===d){var A;this._firstLevel=p;const I=d.bitrate,C=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${l.length} level(s) found, first bitrate: ${I}`),((A=this.hls.userConfig)==null?void 0:A.abrEwmaDefaultEstimate)===void 0){const T=Math.min(I,this.hls.config.abrEwmaDefaultEstimateMax);T>C&&C===this.hls.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=T)}break}const f=n&&!i,g=this.hls.config,m=!!(g.audioStreamController&&g.audioTrackController),E={levels:l,audioTracks:a,subtitleTracks:c,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:n,video:i,altAudio:m&&!f&&a.some(p=>!!p.url)};h.end=performance.now(),this.hls.trigger(y.MANIFEST_PARSED,E)}get levels(){return this._levels.length===0?null:this._levels}get loadLevelObj(){return this.currentLevel}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(t.length===0)return;if(e<0||e>=t.length){const h=new Error("invalid level idx"),u=e<0;if(this.hls.trigger(y.ERROR,{type:q.OTHER_ERROR,details:k.LEVEL_SWITCH_ERROR,level:e,fatal:u,error:h,reason:h.message}),u)return;e=Math.min(e,t.length-1)}const s=this.currentLevelIndex,i=this.currentLevel,n=i?i.attrs["PATHWAY-ID"]:void 0,r=t[e],a=r.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=r,s===e&&i&&n===a)return;this.log(`Switching to level ${e} (${r.height?r.height+"p ":""}${r.videoRange?r.videoRange+" ":""}${r.codecSet?r.codecSet+" ":""}@${r.bitrate})${a?" with Pathway "+a:""} from level ${s}${n?" with Pathway "+n:""}`);const c={level:e,attrs:r.attrs,details:r.details,bitrate:r.bitrate,averageBitrate:r.averageBitrate,maxBitrate:r.maxBitrate,realBitrate:r.realBitrate,width:r.width,height:r.height,codecSet:r.codecSet,audioCodec:r.audioCodec,videoCodec:r.videoCodec,audioGroups:r.audioGroups,subtitleGroups:r.subtitleGroups,loaded:r.loaded,loadError:r.loadError,fragmentError:r.fragmentError,name:r.name,id:r.id,uri:r.uri,url:r.url,urlId:0,audioGroupIds:r.audioGroupIds,textGroupIds:r.textGroupIds};this.hls.trigger(y.LEVEL_SWITCHING,c);const l=r.details;if(!l||l.live){const h=this.switchParams(r.uri,i?.details,l);this.loadPlaylist(h)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,this._startLevel===void 0&&(this._startLevel=e),e!==-1&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(this._startLevel===void 0){const e=this.hls.config.startLevel;return e!==void 0?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}get pathways(){return this.steering?this.steering.pathways():[]}get pathwayPriority(){return this.steering?this.steering.pathwayPriority:null}set pathwayPriority(e){if(this.steering){const t=this.steering.pathways(),s=e.filter(i=>t.indexOf(i)!==-1);if(e.length<1){this.warn(`pathwayPriority ${e} should contain at least one pathway from list: ${t}`);return}this.steering.pathwayPriority=s}}onError(e,t){t.fatal||!t.context||t.context.type===Z.LEVEL&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(t!==void 0&&t.type===V.MAIN){const s=t.elementaryStreams;if(!Object.keys(s).some(n=>!!s[n]))return;const i=this._levels[t.level];i!=null&&i.loadError&&(this.log(`Resetting level error count of ${i.loadError} on frag buffered`),i.loadError=0)}}onLevelLoaded(e,t){var s;const{level:i,details:n}=t,r=t.levelInfo;if(!r){var a;this.warn(`Invalid level index ${i}`),(a=t.deliveryDirectives)!=null&&a.skip&&(n.deltaUpdateFailed=!0);return}if(r===this.currentLevel||t.withoutMultiVariant){r.fragmentError===0&&(r.loadError=0);let c=r.details;c===t.details&&c.advanced&&(c=void 0),this.playlistLoaded(i,t,c)}else(s=t.deliveryDirectives)!=null&&s.skip&&(n.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentLevel)&&this.scheduleLoading(this.currentLevel,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const s=this.getUrlWithDirectives(e.uri,t),i=this.currentLevelIndex,n=e.attrs["PATHWAY-ID"],r=e.details,a=r?.age;this.log(`Loading level index ${i}${t?.msn!==void 0?" at sn "+t.msn+" part "+t.part:""}${n?" Pathway "+n:""}${a&&r.live?" age "+a.toFixed(1)+(r.type&&" "+r.type||""):""} ${s}`),this.hls.trigger(y.LEVEL_LOADING,{url:s,level:i,levelInfo:e,pathwayId:e.attrs["PATHWAY-ID"],id:0,deliveryDirectives:t||null})}get nextLoadLevel(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;if(this._levels.length===1)return;const s=this._levels.filter((n,r)=>r!==e?!0:(this.steering&&this.steering.removeLevel(n),n===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,n.details&&n.details.fragments.forEach(a=>a.level=-1)),!1));mh(s),this._levels=s,this.currentLevelIndex>-1&&(t=this.currentLevel)!=null&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.manualLevelIndex>-1&&(this.manualLevelIndex=this.currentLevelIndex);const i=s.length-1;this._firstLevel=Math.min(this._firstLevel,i),this._startLevel&&(this._startLevel=Math.min(this._startLevel,i)),this.hls.trigger(y.LEVELS_UPDATED,{levels:s})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:s}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(y.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:s}))}}function Ml(o){const e={};o.forEach(t=>{const s=t.groupId||"";t.id=e[s]=e[s]||0,e[s]++})}function uu(){return self.SourceBuffer||self.WebKitSourceBuffer}function du(){if(!Vt())return!1;const e=uu();return!e||e.prototype&&typeof e.prototype.appendBuffer=="function"&&typeof e.prototype.remove=="function"}function y0(){if(!du())return!1;const o=Vt();return typeof o?.isTypeSupported=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(e=>o.isTypeSupported(li(e,"video")))||["mp4a.40.2","fLaC"].some(e=>o.isTypeSupported(li(e,"audio"))))}function C0(){var o;const e=uu();return typeof(e==null||(o=e.prototype)==null?void 0:o.changeType)=="function"}const T0=100;class S0 extends _o{constructor(e,t,s){super(e,t,s,"stream-controller",V.MAIN),this.audioCodecSwap=!1,this.level=-1,this._forceStartLoad=!1,this._hasEnoughToStart=!1,this.altAudio=0,this.audioOnly=!1,this.fragPlaying=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this.onMediaPlaying=()=>{this.tick()},this.onMediaSeeked=()=>{const i=this.media,n=i?i.currentTime:null;if(n===null||!K(n)||(this.log(`Media seeked to ${n.toFixed(3)}`),!this.getBufferedFrag(n)))return;const r=this.getFwdBufferInfoAtPos(i,n,V.MAIN,0);if(r===null||r.len===0){this.warn(`Main forward buffer length at ${n} on "seeked" event ${r?r.len:"empty"})`);return}this.tick()},this.registerListeners()}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(y.MANIFEST_PARSED,this.onManifestParsed,this),e.on(y.LEVEL_LOADING,this.onLevelLoading,this),e.on(y.LEVEL_LOADED,this.onLevelLoaded,this),e.on(y.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(y.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(y.BUFFER_CREATED,this.onBufferCreated,this),e.on(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(y.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(y.MANIFEST_PARSED,this.onManifestParsed,this),e.off(y.LEVEL_LOADED,this.onLevelLoaded,this),e.off(y.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(y.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(y.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(y.BUFFER_CREATED,this.onBufferCreated,this),e.off(y.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(y.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this.onMediaPlaying=this.onMediaSeeked=null,this.unregisterListeners(),super.onHandlerDestroying()}startLoad(e,t){if(this.levels){const{lastCurrentTime:s,hls:i}=this;if(this.stopLoad(),this.setInterval(T0),this.level=-1,!this.startFragRequested){let n=i.startLevel;n===-1&&(i.config.testBandwidth&&this.levels.length>1?(n=0,this.bitrateTest=!0):n=i.firstAutoLevel),i.nextLoadLevel=n,this.level=i.loadLevel,this._hasEnoughToStart=!!t}s>0&&e===-1&&!t&&(this.log(`Override startPosition with lastCurrentTime @${s.toFixed(3)}`),e=s),this.state=M.IDLE,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}else this._forceStartLoad=!0,this.state=M.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case M.WAITING_LEVEL:{const{levels:e,level:t}=this,s=e?.[t],i=s?.details;if(i&&(!i.live||this.levelLastLoaded===s&&!this.waitForLive(s))){if(this.waitForCdnTuneIn(i))break;this.state=M.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=M.IDLE;break}break}case M.FRAG_LOADING_WAITING_RETRY:this.checkRetryDate();break}this.state===M.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){var e;super.onTickEnd(),(e=this.media)!=null&&e.readyState&&this.media.seeking===!1&&(this.lastCurrentTime=this.media.currentTime),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:s,media:i}=this;if(t===null||!i&&!this.primaryPrefetch&&(this.startFragRequested||!e.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;const n=this.buffering?e.nextLoadLevel:e.loadLevel;if(!(s!=null&&s[n]))return;const r=s[n],a=this.getMainFwdBufferInfo();if(a===null)return;const c=this.getLevelDetails();if(c&&this._streamEnded(a,c)){const g={};this.altAudio===2&&(g.type="video"),this.hls.trigger(y.BUFFER_EOS,g),this.state=M.ENDED;return}if(!this.buffering)return;e.loadLevel!==n&&e.manualLevel===-1&&this.log(`Adapting to level ${n} from level ${this.level}`),this.level=e.nextLoadLevel=n;const l=r.details;if(!l||this.state===M.WAITING_LEVEL||this.waitForLive(r)){this.level=n,this.state=M.WAITING_LEVEL,this.startFragRequested=!1;return}const h=a.len,u=this.getMaxBufferLength(r.maxBitrate);if(h>=u)return;this.backtrackFragment&&this.backtrackFragment.start>a.end&&(this.backtrackFragment=null);const d=this.backtrackFragment?this.backtrackFragment.start:a.end;let A=this.getNextFragment(d,l);if(this.couldBacktrack&&!this.fragPrevious&&A&&ge(A)&&this.fragmentTracker.getState(A)!==Ie.OK){var f;const m=((f=this.backtrackFragment)!=null?f:A).sn-l.startSN,E=l.fragments[m-1];E&&A.cc===E.cc&&(A=E,this.fragmentTracker.removeFragment(E))}else this.backtrackFragment&&a.len&&(this.backtrackFragment=null);if(A&&this.isLoopLoading(A,d)){if(!A.gap){const m=this.audioOnly&&!this.altAudio?ae.AUDIO:ae.VIDEO,E=(m===ae.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;E&&this.afterBufferFlushed(E,m,V.MAIN)}A=this.getNextFragmentLoopLoading(A,l,a,V.MAIN,u)}A&&(A.initSegment&&!A.initSegment.data&&!this.bitrateTest&&(A=A.initSegment),this.loadFragment(A,r,d))}loadFragment(e,t,s){const i=this.fragmentTracker.getState(e);i===Ie.NOT_LOADED||i===Ie.PARTIAL?ge(e)?this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):super.loadFragment(e,t,s):this._loadInitSegment(e,t):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,V.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(t!=null&&t.readyState){let s;const i=this.getAppendedFrag(t.currentTime);i&&i.start>1&&this.flushMainBuffer(0,i.start-1);const n=this.getLevelDetails();if(n!=null&&n.live){const a=this.getMainFwdBufferInfo();if(!a||a.len<n.targetduration*2)return}if(!t.paused&&e){const a=this.hls.nextLoadLevel,c=e[a],l=this.fragLastKbps;l&&this.fragCurrent?s=this.fragCurrent.duration*c.maxBitrate/(1e3*l)+1:s=0}else s=0;const r=this.getBufferedFrag(t.currentTime+s);if(r){const a=this.followingBufferedFrag(r);if(a){this.abortCurrentFrag();const c=a.maxStartPTS?a.maxStartPTS:a.start,l=a.duration,h=Math.max(r.end,c+Math.min(Math.max(l-this.config.maxFragLookUpTolerance,l*(this.couldBacktrack?.5:.125)),l*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(h,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case M.KEY_LOADING:case M.FRAG_LOADING:case M.FRAG_LOADING_WAITING_RETRY:case M.PARSING:case M.PARSED:this.state=M.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio===2?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const s=t.media;Pe(s,"playing",this.onMediaPlaying),Pe(s,"seeked",this.onMediaSeeked)}onMediaDetaching(e,t){const{media:s}=this;s&&(Ue(s,"playing",this.onMediaPlaying),Ue(s,"seeked",this.onMediaSeeked)),this.videoBuffer=null,this.fragPlaying=null,super.onMediaDetaching(e,t),!t.transferMedia&&(this._hasEnoughToStart=!1)}onManifestLoading(){super.onManifestLoading(),this.log("Trigger BUFFER_RESET"),this.hls.trigger(y.BUFFER_RESET,void 0),this.couldBacktrack=!1,this.fragLastKbps=0,this.fragPlaying=this.backtrackFragment=null,this.altAudio=0,this.audioOnly=!1}onManifestParsed(e,t){let s=!1,i=!1;for(let n=0;n<t.levels.length;n++){const r=t.levels[n].audioCodec;r&&(s=s||r.indexOf("mp4a.40.2")!==-1,i=i||r.indexOf("mp4a.40.5")!==-1)}this.audioCodecSwitch=s&&i&&!C0(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:s}=this;if(!s||this.state!==M.IDLE)return;const i=t.levelInfo;(!i.details||i.details.live&&(this.levelLastLoaded!==i||i.details.expired)||this.waitForCdnTuneIn(i.details))&&(this.state=M.WAITING_LEVEL)}onLevelLoaded(e,t){var s;const{levels:i,startFragRequested:n}=this,r=t.level,a=t.details,c=a.totalduration;if(!i){this.warn(`Levels were reset while loading level ${r}`);return}this.log(`Level ${r} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""}, cc [${a.startCC}, ${a.endCC}] duration:${c}`);const l=t.levelInfo,h=this.fragCurrent;h&&(this.state===M.FRAG_LOADING||this.state===M.FRAG_LOADING_WAITING_RETRY)&&h.level!==t.level&&h.loader&&this.abortCurrentFrag();let u=0;if(a.live||(s=l.details)!=null&&s.live){var d;if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;u=this.alignPlaylists(a,l.details,(d=this.levelLastLoaded)==null?void 0:d.details)}if(l.details=a,this.levelLastLoaded=l,n||this.setStartPosition(a,u),this.hls.trigger(y.LEVEL_UPDATED,{details:a,level:r}),this.state===M.WAITING_LEVEL){if(this.waitForCdnTuneIn(a))return;this.state=M.IDLE}n&&a.live&&this.synchronizeToLiveEdge(a),this.tick()}synchronizeToLiveEdge(e){const{config:t,media:s}=this;if(!s)return;const i=this.hls.liveSyncPosition,n=this.getLoadPosition(),r=e.fragmentStart,a=e.edge,c=n>=r-t.maxFragLookUpTolerance&&n<=a;if(i!==null&&s.duration>i&&(n<i||!c)){const h=t.liveMaxLatencyDuration!==void 0?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;if((!c&&s.readyState<4||n<a-h)&&(this._hasEnoughToStart||(this.nextLoadPosition=i),s.readyState))if(this.warn(`Playback: ${n.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${i.toFixed(3)}`),this.config.liveSyncMode==="buffered"){var l;const u=J.bufferInfo(s,i,0);if(!((l=u.buffered)!=null&&l.length)){s.currentTime=i;return}if(u.start<=n){s.currentTime=i;return}const{nextStart:A}=J.bufferedInfo(u.buffered,n,0);A&&(s.currentTime=A)}else s.currentTime=i}}_handleFragmentLoadProgress(e){var t;const s=e.frag,{part:i,payload:n}=e,{levels:r}=this;if(!r){this.warn(`Levels were reset while fragment load was in progress. Fragment ${s.sn} of level ${s.level} will not be buffered`);return}const a=r[s.level];if(!a){this.warn(`Level ${s.level} not found on progress`);return}const c=a.details;if(!c){this.warn(`Dropping fragment ${s.sn} of level ${s.level} after level details were reset`),this.fragmentTracker.removeFragment(s);return}const l=a.videoCodec,h=c.PTSKnown||!c.live,u=(t=s.initSegment)==null?void 0:t.data,d=this._getAudioCodec(a),A=this.transmuxer=this.transmuxer||new Oh(this.hls,V.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),f=i?i.index:-1,g=f!==-1,m=new Do(s.level,s.sn,s.stats.chunkCount,n.byteLength,f,g),E=this.initPTS[s.cc];A.push(n,u,d,l,s,i,c.totalduration,h,m,E)}onAudioTrackSwitching(e,t){const s=this.hls,i=this.altAudio!==0;if(dn(t.url,s))this.altAudio=1;else{if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const r=this.fragCurrent;r&&(this.log("Switching to main audio track, cancel main fragment load"),r.abortRequests(),this.fragmentTracker.removeFragment(r)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();if(i){this.altAudio=0,this.fragmentTracker.removeAllFragments(),s.once(y.BUFFER_FLUSHED,()=>{this.hls&&this.hls.trigger(y.AUDIO_TRACK_SWITCHED,t)}),s.trigger(y.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null});return}s.trigger(y.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const s=dn(t.url,this.hls);if(s){const i=this.videoBuffer;i&&this.mediaBuffer!==i&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=i)}this.altAudio=s?2:0,this.tick()}onBufferCreated(e,t){const s=t.tracks;let i,n,r=!1;for(const a in s){const c=s[a];if(c.id==="main"){if(n=a,i=c,a==="video"){const l=s[a];l&&(this.videoBuffer=l.buffer)}}else r=!0}r&&i?(this.log(`Alternate track found, use ${n}.buffered to schedule main fragment loading`),this.mediaBuffer=i.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:s,part:i}=t,n=s.type===V.MAIN;if(n){if(this.fragContextChanged(s)){this.warn(`Fragment ${s.sn}${i?" p: "+i.index:""} of level ${s.level} finished buffering, but was aborted. state: ${this.state}`),this.state===M.PARSED&&(this.state=M.IDLE);return}const a=i?i.stats:s.stats;this.fragLastKbps=Math.round(8*a.total/(a.buffering.end-a.loading.first)),ge(s)&&(this.fragPrevious=s),this.fragBufferedComplete(s,i)}const r=this.media;r&&(!this._hasEnoughToStart&&J.getBuffered(r).length&&(this._hasEnoughToStart=!0,this.seekToStartPos()),n&&this.tick())}get hasEnoughToStart(){return this._hasEnoughToStart}onError(e,t){var s;if(t.fatal){this.state=M.ERROR;return}switch(t.details){case k.FRAG_GAP:case k.FRAG_PARSING_ERROR:case k.FRAG_DECRYPT_ERROR:case k.FRAG_LOAD_ERROR:case k.FRAG_LOAD_TIMEOUT:case k.KEY_LOAD_ERROR:case k.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(V.MAIN,t);break;case k.LEVEL_LOAD_ERROR:case k.LEVEL_LOAD_TIMEOUT:case k.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===M.WAITING_LEVEL&&((s=t.context)==null?void 0:s.type)===Z.LEVEL&&(this.state=M.IDLE);break;case k.BUFFER_ADD_CODEC_ERROR:case k.BUFFER_APPEND_ERROR:if(t.parent!=="main")return;this.reduceLengthAndFlushBuffer(t)&&this.resetLoadingState();break;case k.BUFFER_FULL_ERROR:if(t.parent!=="main")return;this.reduceLengthAndFlushBuffer(t)&&(!this.config.interstitialsController&&this.config.assetPlayerId?this._hasEnoughToStart=!0:this.flushMainBuffer(0,Number.POSITIVE_INFINITY));break;case k.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onFragLoadEmergencyAborted(){this.state=M.IDLE,this._hasEnoughToStart||(this.startFragRequested=!1,this.nextLoadPosition=this.lastCurrentTime),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==ae.AUDIO||!this.altAudio){const s=(t===ae.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;s&&(this.afterBufferFlushed(s,t,V.MAIN),this.tick())}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level,this.level===-1&&this.resetWhenMissingContext(this.fragCurrent)),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let s=this.startPosition;if(s>=0&&t<s){if(e.seeking){this.log(`could not seek to ${s}, already seeking at ${t}`);return}const i=this.timelineOffset;i&&s&&(s+=i);const n=this.getLevelDetails(),r=J.getBuffered(e),a=r.length?r.start(0):0,c=a-s,l=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);(this.config.startOnSegmentBoundary||c>0&&(c<l||this.loadingParts&&c<2*(n?.partTarget||0)))&&(this.log(`adjusting start position by ${c} to match buffer start`),s+=c,this.startPosition=s),t<s&&(this.log(`seek to target start position ${s} from current time ${t} buffer start ${a}`),e.currentTime=s)}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t.indexOf("mp4a.40.5")!==-1?t="mp4a.40.2":t="mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then(s=>{const{hls:i}=this,n=s?.frag;if(!n||this.fragContextChanged(n))return;t.fragmentError=0,this.state=M.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const r=n.stats;r.parsing.start=r.parsing.end=r.buffering.start=r.buffering.end=self.performance.now(),i.trigger(y.FRAG_LOADED,s),n.bitrateTest=!1}).catch(s=>{this.state===M.STOPPED||this.state===M.ERROR||(this.warn(s),this.resetFragmentLoading(e))})}_handleTransmuxComplete(e){const t=this.playlistType,{hls:s}=this,{remuxResult:i,chunkMeta:n}=e,r=this.getCurrentContext(n);if(!r){this.resetWhenMissingContext(n);return}const{frag:a,part:c,level:l}=r,{video:h,text:u,id3:d,initSegment:A}=i,{details:f}=l,g=this.altAudio?void 0:i.audio;if(this.fragContextChanged(a)){this.fragmentTracker.removeFragment(a);return}if(this.state=M.PARSING,A){const m=A.tracks;if(m){const C=a.initSegment||a;if(this.unhandledEncryptionError(A,a))return;this._bufferInitSegment(l,m,C,n),s.trigger(y.FRAG_PARSING_INIT_SEGMENT,{frag:C,id:t,tracks:m})}const E=A.initPTS,p=A.timescale,I=this.initPTS[a.cc];if(K(E)&&(!I||I.baseTime!==E||I.timescale!==p)){const C=A.trackId;this.initPTS[a.cc]={baseTime:E,timescale:p,trackId:C},s.trigger(y.INIT_PTS_FOUND,{frag:a,id:t,initPTS:E,timescale:p,trackId:C})}}if(h&&f){g&&h.type==="audiovideo"&&this.logMuxedErr(a);const m=f.fragments[a.sn-1-f.startSN],E=a.sn===f.startSN,p=!m||a.cc>m.cc;if(i.independent!==!1){const{startPTS:I,endPTS:C,startDTS:T,endDTS:L}=h;if(c)c.elementaryStreams[h.type]={startPTS:I,endPTS:C,startDTS:T,endDTS:L};else if(h.firstKeyFrame&&h.independent&&n.id===1&&!p&&(this.couldBacktrack=!0),h.dropped&&h.independent){const S=this.getMainFwdBufferInfo(),x=(S?S.end:this.getLoadPosition())+this.config.maxBufferHole,v=h.firstKeyFramePTS?h.firstKeyFramePTS:I;if(!E&&x<v-this.config.maxBufferHole&&!p){this.backtrack(a);return}else p&&(a.gap=!0);a.setElementaryStreamInfo(h.type,a.start,C,a.start,L,!0)}else E&&I-(f.appliedTimelineOffset||0)>nn&&(a.gap=!0);a.setElementaryStreamInfo(h.type,I,C,T,L),this.backtrackFragment&&(this.backtrackFragment=a),this.bufferFragmentData(h,a,c,n,E||p)}else if(E||p)a.gap=!0;else{this.backtrack(a);return}}if(g){const{startPTS:m,endPTS:E,startDTS:p,endDTS:I}=g;c&&(c.elementaryStreams[ae.AUDIO]={startPTS:m,endPTS:E,startDTS:p,endDTS:I}),a.setElementaryStreamInfo(ae.AUDIO,m,E,p,I),this.bufferFragmentData(g,a,c,n)}if(f&&d!=null&&d.samples.length){const m={id:t,frag:a,details:f,samples:d.samples};s.trigger(y.FRAG_PARSING_METADATA,m)}if(f&&u){const m={id:t,frag:a,details:f,samples:u.samples};s.trigger(y.FRAG_PARSING_USERDATA,m)}}logMuxedErr(e){this.warn(`${ge(e)?"Media":"Init"} segment with muxed audiovideo where only video expected: ${e.url}`)}_bufferInitSegment(e,t,s,i){if(this.state!==M.PARSING)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&(delete t.audio,t.audiovideo&&this.logMuxedErr(s));const{audio:n,video:r,audiovideo:a}=t;if(n){const l=e.audioCodec;let h=Ji(n.codec,l);h==="mp4a"&&(h="mp4a.40.5");const u=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){h&&(h.indexOf("mp4a.40.5")!==-1?h="mp4a.40.2":h="mp4a.40.5");const d=n.metadata;d&&"channelCount"in d&&(d.channelCount||1)!==1&&u.indexOf("firefox")===-1&&(h="mp4a.40.5")}h&&h.indexOf("mp4a.40.5")!==-1&&u.indexOf("android")!==-1&&n.container!=="audio/mpeg"&&(h="mp4a.40.2",this.log(`Android: force audio codec to ${h}`)),l&&l!==h&&this.log(`Swapping manifest audio codec "${l}" for "${h}"`),n.levelCodec=h,n.id=V.MAIN,this.log(`Init audio buffer, container:${n.container}, codecs[selected/level/parsed]=[${h||""}/${l||""}/${n.codec}]`),delete t.audiovideo}if(r){r.levelCodec=e.videoCodec,r.id=V.MAIN;const l=r.codec;if(l?.length===4)switch(l){case"hvc1":case"hev1":r.codec="hvc1.1.6.L120.90";break;case"av01":r.codec="av01.0.04M.08";break;case"avc1":r.codec="avc1.42e01e";break}this.log(`Init video buffer, container:${r.container}, codecs[level/parsed]=[${e.videoCodec||""}/${l}]${r.codec!==l?" parsed-corrected="+r.codec:""}${r.supplemental?" supplemental="+r.supplemental:""}`),delete t.audiovideo}a&&(this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${e.codecs}/${a.codec}]`),delete t.video,delete t.audio);const c=Object.keys(t);if(c.length){if(this.hls.trigger(y.BUFFER_CODECS,t),!this.hls)return;c.forEach(l=>{const u=t[l].initSegment;u!=null&&u.byteLength&&this.hls.trigger(y.BUFFER_APPENDING,{type:l,data:u,frag:s,part:null,chunkMeta:i,parent:s.type})})}this.tickImmediate()}getMainFwdBufferInfo(){const e=this.mediaBuffer&&this.altAudio===2?this.mediaBuffer:this.media;return this.getFwdBufferInfo(e,V.MAIN)}get maxBufferLength(){const{levels:e,level:t}=this,s=e?.[t];return s?this.getMaxBufferLength(s.maxBitrate):this.config.maxBufferLength}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=M.IDLE}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&e.seeking===!1){const s=e.currentTime;if(J.isBuffered(e,s)?t=this.getAppendedFrag(s):J.isBuffered(e,s+.1)&&(t=this.getAppendedFrag(s+.1)),t){this.backtrackFragment=null;const i=this.fragPlaying,n=t.level;(!i||t.sn!==i.sn||i.level!==n)&&(this.fragPlaying=t,this.hls.trigger(y.FRAG_CHANGED,{frag:t}),(!i||i.level!==n)&&this.hls.trigger(y.LEVEL_SWITCHED,{level:n}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){var e;if(this.fragPlaying)return this.fragPlaying;const t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;return K(t)?this.getAppendedFrag(t):null}get currentProgramDateTime(){var e;const t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;if(K(t)){const s=this.getLevelDetails(),i=this.currentFrag||(s?rs(null,s.fragments,t):null);if(i){const n=i.programDateTime;if(n!==null){const r=n+(t-i.start)*1e3;return new Date(r)}}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class B0 extends st{constructor(e,t){super("key-loader",t),this.config=void 0,this.keyIdToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const s in this.keyIdToKeyInfo){const i=this.keyIdToKeyInfo[s].loader;if(i){var t;if(e&&e!==((t=i.context)==null?void 0:t.frag.type))return;i.abort()}}}detach(){for(const e in this.keyIdToKeyInfo){const t=this.keyIdToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyIdToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyIdToKeyInfo){const t=this.keyIdToKeyInfo[e].loader;t&&t.destroy()}this.keyIdToKeyInfo={}}createKeyLoadError(e,t=k.KEY_LOAD_ERROR,s,i,n){return new Rt({type:q.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:n,error:s,networkDetails:i})}loadClear(e,t,s){if(this.emeController&&this.config.emeEnabled&&!this.emeController.getSelectedKeySystemFormats().length){if(t.length)for(let i=0,n=t.length;i<n;i++){const r=t[i];if(e.cc<=r.cc&&(!ge(e)||!ge(r)||e.sn<r.sn)||!s&&i==n-1)return this.emeController.selectKeySystemFormat(r).then(a=>{if(!this.emeController)return;r.setKeyFormat(a);const c=zi(a);if(c)return this.emeController.getKeySystemAccess([c])})}if(this.config.requireKeySystemAccessOnStart){const i=Xs(this.config);if(i.length)return this.emeController.getKeySystemAccess(i)}}return null}load(e){return!e.decryptdata&&e.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(e).then(t=>this.loadInternal(e,t)):this.loadInternal(e)}loadInternal(e,t){var s,i;t&&e.setKeyFormat(t);const n=e.decryptdata;if(!n){const l=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:`Missing decryption data on fragment in onKeyLoading (emeEnabled with controller: ${this.emeController&&this.config.emeEnabled})`);return Promise.reject(this.createKeyLoadError(e,k.KEY_LOAD_ERROR,l))}const r=n.uri;if(!r)return Promise.reject(this.createKeyLoadError(e,k.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${r}"`)));const a=Zn(n);let c=this.keyIdToKeyInfo[a];if((s=c)!=null&&s.decryptdata.key)return n.key=c.decryptdata.key,Promise.resolve({frag:e,keyInfo:c});if(this.emeController&&(i=c)!=null&&i.keyLoadPromise)switch(this.emeController.getKeyStatus(c.decryptdata)){case"usable":case"usable-in-future":return c.keyLoadPromise.then(h=>{const{keyInfo:u}=h;return n.key=u.decryptdata.key,{frag:e,keyInfo:u}})}switch(this.log(`${this.keyIdToKeyInfo[a]?"Rel":"L"}oading${n.keyId?" keyId: "+Re(n.keyId):""} URI: ${n.uri} from ${e.type} ${e.level}`),c=this.keyIdToKeyInfo[a]={decryptdata:n,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},n.method){case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return n.keyFormat==="identity"?this.loadKeyHTTP(c,e):this.loadKeyEME(c,e);case"AES-128":case"AES-256":case"AES-256-CTR":return this.loadKeyHTTP(c,e);default:return Promise.reject(this.createKeyLoadError(e,k.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${n.method}"`)))}}loadKeyEME(e,t){const s={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){var i;if(!e.decryptdata.keyId&&(i=t.initSegment)!=null&&i.data){const r=HA(t.initSegment.data);if(r.length){let a=r[0];a.some(c=>c!==0)?(this.log(`Using keyId found in init segment ${Re(a)}`),Kt.setKeyIdForUri(e.decryptdata.uri,a)):(a=Kt.addKeyIdForUri(e.decryptdata.uri),this.log(`Generating keyId to patch media ${Re(a)}`)),e.decryptdata.keyId=a}}if(!e.decryptdata.keyId&&!ge(t))return Promise.resolve(s);const n=this.emeController.loadKey(s);return(e.keyLoadPromise=n.then(r=>(e.mediaKeySessionContext=r,s))).catch(r=>{throw e.keyLoadPromise=null,"data"in r&&(r.data.frag=t),r})}return Promise.resolve(s)}loadKeyHTTP(e,t){const s=this.config,i=s.loader,n=new i(s);return t.keyLoader=e.loader=n,e.keyLoadPromise=new Promise((r,a)=>{const c={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},l=s.keyLoadPolicy.default,h={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:(d,A,f,g)=>{const{frag:m,keyInfo:E}=f,p=Zn(E.decryptdata);if(!m.decryptdata||E!==this.keyIdToKeyInfo[p])return a(this.createKeyLoadError(m,k.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),g));E.decryptdata.key=m.decryptdata.key=new Uint8Array(d.data),m.keyLoader=null,E.loader=null,r({frag:m,keyInfo:E})},onError:(d,A,f,g)=>{this.resetLoader(A),a(this.createKeyLoadError(t,k.KEY_LOAD_ERROR,new Error(`HTTP Error ${d.code} loading key ${d.text}`),f,ne({url:c.url,data:void 0},d)))},onTimeout:(d,A,f)=>{this.resetLoader(A),a(this.createKeyLoadError(t,k.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),f))},onAbort:(d,A,f)=>{this.resetLoader(A),a(this.createKeyLoadError(t,k.INTERNAL_ABORTED,new Error("key loading aborted"),f))}};n.load(c,h,u)})}resetLoader(e){const{frag:t,keyInfo:s,url:i}=e,n=s.loader;t.keyLoader===n&&(t.keyLoader=null,s.loader=null);const r=Zn(s.decryptdata)||i;delete this.keyIdToKeyInfo[r],n&&n.destroy()}}function Zn(o){if(o.keyFormat!==De.FAIRPLAY){const e=o.keyId;if(e)return Re(e)}return o.uri}function Ql(o){const{type:e}=o;switch(e){case Z.AUDIO_TRACK:return V.AUDIO;case Z.SUBTITLE_TRACK:return V.SUBTITLE;default:return V.MAIN}}function er(o,e){let t=o.url;return(t===void 0||t.indexOf("data:")===0)&&(t=e.url),t}class x0{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.onManifestLoaded=this.checkAutostartLoad,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(y.MANIFEST_LOADING,this.onManifestLoading,this),e.on(y.LEVEL_LOADING,this.onLevelLoading,this),e.on(y.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(y.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.on(y.LEVELS_UPDATED,this.onLevelsUpdated,this)}unregisterListeners(){const{hls:e}=this;e.off(y.MANIFEST_LOADING,this.onManifestLoading,this),e.off(y.LEVEL_LOADING,this.onLevelLoading,this),e.off(y.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(y.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.off(y.LEVELS_UPDATED,this.onLevelsUpdated,this)}createInternalLoader(e){const t=this.hls.config,s=t.pLoader,i=t.loader,n=s||i,r=new n(t);return this.loaders[e.type]=r,r}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:s}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:Z.MANIFEST,url:s,deliveryDirectives:null,levelOrTrack:null})}onLevelLoading(e,t){const{id:s,level:i,pathwayId:n,url:r,deliveryDirectives:a,levelInfo:c}=t;this.load({id:s,level:i,pathwayId:n,responseType:"text",type:Z.LEVEL,url:r,deliveryDirectives:a,levelOrTrack:c})}onAudioTrackLoading(e,t){const{id:s,groupId:i,url:n,deliveryDirectives:r,track:a}=t;this.load({id:s,groupId:i,level:null,responseType:"text",type:Z.AUDIO_TRACK,url:n,deliveryDirectives:r,levelOrTrack:a})}onSubtitleTrackLoading(e,t){const{id:s,groupId:i,url:n,deliveryDirectives:r,track:a}=t;this.load({id:s,groupId:i,level:null,responseType:"text",type:Z.SUBTITLE_TRACK,url:n,deliveryDirectives:r,levelOrTrack:a})}onLevelsUpdated(e,t){const s=this.loaders[Z.LEVEL];if(s){const i=s.context;i&&!t.levels.some(n=>n===i.levelOrTrack)&&(s.abort(),delete this.loaders[Z.LEVEL])}}load(e){var t;const s=this.hls.config;let i=this.getInternalLoader(e);if(i){const l=this.hls.logger,h=i.context;if(h&&h.levelOrTrack===e.levelOrTrack&&(h.url===e.url||h.deliveryDirectives&&!e.deliveryDirectives)){h.url===e.url?l.log(`[playlist-loader]: ignore ${e.url} ongoing request`):l.log(`[playlist-loader]: ignore ${e.url} in favor of ${h.url}`);return}l.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),i.abort()}let n;if(e.type===Z.MANIFEST?n=s.manifestLoadPolicy.default:n=oe({},s.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),i=this.createInternalLoader(e),K((t=e.deliveryDirectives)==null?void 0:t.part)){let l;if(e.type===Z.LEVEL&&e.level!==null?l=this.hls.levels[e.level].details:e.type===Z.AUDIO_TRACK&&e.id!==null?l=this.hls.audioTracks[e.id].details:e.type===Z.SUBTITLE_TRACK&&e.id!==null&&(l=this.hls.subtitleTracks[e.id].details),l){const h=l.partTarget,u=l.targetduration;if(h&&u){const d=Math.max(h*3,u*.8)*1e3;n=oe({},n,{maxTimeToFirstByteMs:Math.min(d,n.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(d,n.maxTimeToFirstByteMs)})}}}const r=n.errorRetry||n.timeoutRetry||{},a={loadPolicy:n,timeout:n.maxLoadTimeMs,maxRetry:r.maxNumRetry||0,retryDelay:r.retryDelayMs||0,maxRetryDelay:r.maxRetryDelayMs||0},c={onSuccess:(l,h,u,d)=>{const A=this.getInternalLoader(u);this.resetInternalLoader(u.type);const f=l.data;h.parsing.start=performance.now(),pt.isMediaPlaylist(f)||u.type!==Z.MANIFEST?this.handleTrackOrLevelPlaylist(l,h,u,d||null,A):this.handleMasterPlaylist(l,h,u,d)},onError:(l,h,u,d)=>{this.handleNetworkError(h,u,!1,l,d)},onTimeout:(l,h,u)=>{this.handleNetworkError(h,u,!0,void 0,l)}};i.load(e,a,c)}checkAutostartLoad(){if(!this.hls)return;const{config:{autoStartLoad:e,startPosition:t},forceStartLoad:s}=this.hls;(e||s)&&(this.hls.logger.log(`${e?"auto":"force"} startLoad with configured startPosition ${t}`),this.hls.startLoad(t))}handleMasterPlaylist(e,t,s,i){const n=this.hls,r=e.data,a=er(e,s),c=pt.parseMasterPlaylist(r,a);if(c.playlistParsingError){t.parsing.end=performance.now(),this.handleManifestParsingError(e,s,c.playlistParsingError,i,t);return}const{contentSteering:l,levels:h,sessionData:u,sessionKeys:d,startTimeOffset:A,variableList:f}=c;this.variableList=f,h.forEach(p=>{const{unknownCodecs:I}=p;if(I){const{preferManagedMediaSource:C}=this.hls.config;let{audioCodec:T,videoCodec:L}=p;for(let S=I.length;S--;){const x=I[S];ai(x,"audio",C)?(p.audioCodec=T=T?`${T},${x}`:x,ks.audio[T.substring(0,4)]=2,I.splice(S,1)):ai(x,"video",C)&&(p.videoCodec=L=L?`${L},${x}`:x,ks.video[L.substring(0,4)]=2,I.splice(S,1))}}});const{AUDIO:g=[],SUBTITLES:m,"CLOSED-CAPTIONS":E}=pt.parseMasterPlaylistMedia(r,a,c);g.length&&!g.some(I=>!I.url)&&h[0].audioCodec&&!h[0].attrs.AUDIO&&(this.hls.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),g.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new he({}),bitrate:0,url:""})),n.trigger(y.MANIFEST_LOADED,{levels:h,audioTracks:g,subtitles:m,captions:E,contentSteering:l,url:a,stats:t,networkDetails:i,sessionData:u,sessionKeys:d,startTimeOffset:A,variableList:f})}handleTrackOrLevelPlaylist(e,t,s,i,n){const r=this.hls,{id:a,level:c,type:l}=s,h=er(e,s),u=K(c)?c:K(a)?a:0,d=Ql(s),A=pt.parseLevelPlaylist(e.data,h,u,d,0,this.variableList);if(l===Z.MANIFEST){const f={attrs:new he({}),bitrate:0,details:A,name:"",url:h};A.requestScheduled=t.loading.start+Ah(A,0),r.trigger(y.MANIFEST_LOADED,{levels:[f],audioTracks:[],url:h,stats:t,networkDetails:i,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),s.levelDetails=A,this.handlePlaylistLoaded(A,e,t,s,i,n)}handleManifestParsingError(e,t,s,i,n){this.hls.trigger(y.ERROR,{type:q.NETWORK_ERROR,details:k.MANIFEST_PARSING_ERROR,fatal:t.type===Z.MANIFEST,url:e.url,err:s,error:s,reason:s.message,response:e,context:t,networkDetails:i,stats:n})}handleNetworkError(e,t,s=!1,i,n){let r=`A network ${s?"timeout":"error"+(i?" (status "+i.code+")":"")} occurred while loading ${e.type}`;e.type===Z.LEVEL?r+=`: ${e.level} id: ${e.id}`:(e.type===Z.AUDIO_TRACK||e.type===Z.SUBTITLE_TRACK)&&(r+=` id: ${e.id} group-id: "${e.groupId}"`);const a=new Error(r);this.hls.logger.warn(`[playlist-loader]: ${r}`);let c=k.UNKNOWN,l=!1;const h=this.getInternalLoader(e);switch(e.type){case Z.MANIFEST:c=s?k.MANIFEST_LOAD_TIMEOUT:k.MANIFEST_LOAD_ERROR,l=!0;break;case Z.LEVEL:c=s?k.LEVEL_LOAD_TIMEOUT:k.LEVEL_LOAD_ERROR,l=!1;break;case Z.AUDIO_TRACK:c=s?k.AUDIO_TRACK_LOAD_TIMEOUT:k.AUDIO_TRACK_LOAD_ERROR,l=!1;break;case Z.SUBTITLE_TRACK:c=s?k.SUBTITLE_TRACK_LOAD_TIMEOUT:k.SUBTITLE_LOAD_ERROR,l=!1;break}h&&this.resetInternalLoader(e.type);const u={type:q.NETWORK_ERROR,details:c,fatal:l,url:e.url,loader:h,context:e,error:a,networkDetails:t,stats:n};if(i){const d=t?.url||e.url;u.response=ne({url:d,data:void 0},i)}this.hls.trigger(y.ERROR,u)}handlePlaylistLoaded(e,t,s,i,n,r){const a=this.hls,{type:c,level:l,levelOrTrack:h,id:u,groupId:d,deliveryDirectives:A}=i,f=er(t,i),g=Ql(i);let m=typeof i.level=="number"&&g===V.MAIN?l:void 0;const E=e.playlistParsingError;if(E){if(this.hls.logger.warn(`${E} ${e.url}`),!a.config.ignorePlaylistParsingErrors){a.trigger(y.ERROR,{type:q.NETWORK_ERROR,details:k.LEVEL_PARSING_ERROR,fatal:!1,url:f,error:E,reason:E.message,response:t,context:i,level:m,parent:g,networkDetails:n,stats:s});return}e.playlistParsingError=null}if(!e.fragments.length){const p=e.playlistParsingError=new Error("No Segments found in Playlist");a.trigger(y.ERROR,{type:q.NETWORK_ERROR,details:k.LEVEL_EMPTY_ERROR,fatal:!1,url:f,error:p,reason:p.message,response:t,context:i,level:m,parent:g,networkDetails:n,stats:s});return}switch(e.live&&r&&(r.getCacheAge&&(e.ageHeader=r.getCacheAge()||0),(!r.getCacheAge||isNaN(e.ageHeader))&&(e.ageHeader=0)),c){case Z.MANIFEST:case Z.LEVEL:if(m){if(!h)m=0;else if(h!==a.levels[m]){const p=a.levels.indexOf(h);p>-1&&(m=p)}}a.trigger(y.LEVEL_LOADED,{details:e,levelInfo:h||a.levels[0],level:m||0,id:u||0,stats:s,networkDetails:n,deliveryDirectives:A,withoutMultiVariant:c===Z.MANIFEST});break;case Z.AUDIO_TRACK:a.trigger(y.AUDIO_TRACK_LOADED,{details:e,track:h,id:u||0,groupId:d||"",stats:s,networkDetails:n,deliveryDirectives:A});break;case Z.SUBTITLE_TRACK:a.trigger(y.SUBTITLE_TRACK_LOADED,{details:e,track:h,id:u||0,groupId:d||"",stats:s,networkDetails:n,deliveryDirectives:A});break}}}class gt{static get version(){return hi}static isMSESupported(){return du()}static isSupported(){return y0()}static getMediaSource(){return Vt()}static get Events(){return y}static get MetadataSchema(){return $e}static get ErrorTypes(){return q}static get ErrorDetails(){return k}static get DefaultConfig(){return gt.defaultConfig?gt.defaultConfig:l0}static set DefaultConfig(e){gt.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.logger=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new ko,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioStreamController=void 0,this.subtititleStreamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.interstitialsController=void 0,this.gapController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this._url=null,this._sessionId=void 0,this.triggeringException=void 0,this.started=!1;const t=this.logger=bA(e.debug||!1,"Hls instance",e.assetPlayerId),s=this.config=h0(gt.DefaultConfig,e,t);this.userConfig=e,s.progressive&&u0(s,t);const{abrController:i,bufferController:n,capLevelController:r,errorController:a,fpsController:c}=s,l=new a(this),h=this.abrController=new i(this),u=new vf(this),d=s.interstitialsController,A=d?this.interstitialsController=new d(this,gt):null,f=this.bufferController=new n(this,u),g=this.capLevelController=new r(this),m=new c(this),E=new x0(this),p=s.contentSteeringController,I=p?new p(this):null,C=this.levelController=new I0(this,I),T=new p0(this),L=new B0(this.config,this.logger),S=this.streamController=new S0(this,u,L),x=this.gapController=new g0(this,u);g.setStreamController(S),m.setStreamController(S);const v=[E,C,S];A&&v.splice(1,0,A),I&&v.splice(1,0,I),this.networkControllers=v;const B=[h,f,x,g,m,T,u];this.audioTrackController=this.createController(s.audioTrackController,v);const R=s.audioStreamController;R&&v.push(this.audioStreamController=new R(this,u,L)),this.subtitleTrackController=this.createController(s.subtitleTrackController,v);const D=s.subtitleStreamController;D&&v.push(this.subtititleStreamController=new D(this,u,L)),this.createController(s.timelineController,B),L.emeController=this.emeController=this.createController(s.emeController,B),this.cmcdController=this.createController(s.cmcdController,B),this.latencyController=this.createController(E0,B),this.coreComponents=B,v.push(l);const b=l.onErrorOut;typeof b=="function"&&this.on(y.ERROR,b,l),this.on(y.MANIFEST_LOADED,E.onManifestLoaded,E)}createController(e,t){if(e){const s=new e(this);return t&&t.push(s),s}return null}on(e,t,s=this){this._emitter.on(e,t,s)}once(e,t,s=this){this._emitter.once(e,t,s)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,s=this,i){this._emitter.off(e,t,s,i)}listeners(e){return this._emitter.listeners(e)}emit(e,t,s){return this._emitter.emit(e,t,s)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(s){if(this.logger.error("An internal error happened while handling event "+e+'. Error message: "'+s.message+'". Here is a stacktrace:',s),!this.triggeringException){this.triggeringException=!0;const i=e===y.ERROR;this.trigger(y.ERROR,{type:q.OTHER_ERROR,details:k.INTERNAL_EXCEPTION,fatal:i,event:e,error:s}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){this.logger.log("destroy"),this.trigger(y.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this._url=null,this.networkControllers.forEach(t=>t.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(t=>t.destroy()),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){if(!e||"media"in e&&!e.media){const n=new Error(`attachMedia failed: invalid argument (${e})`);this.trigger(y.ERROR,{type:q.OTHER_ERROR,details:k.ATTACH_MEDIA_ERROR,fatal:!0,error:n});return}this.logger.log("attachMedia"),this._media&&(this.logger.warn("media must be detached before attaching"),this.detachMedia());const t="media"in e,s=t?e.media:e,i=t?e:{media:s};this._media=s,this.trigger(y.MEDIA_ATTACHING,i)}detachMedia(){this.logger.log("detachMedia"),this.trigger(y.MEDIA_DETACHING,{}),this._media=null}transferMedia(){this._media=null;const e=this.bufferController.transferMedia();return this.trigger(y.MEDIA_DETACHING,{transferMedia:e}),e}loadSource(e){this.stopLoad();const t=this.media,s=this._url,i=this._url=To.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.logger.log(`loadSource:${i}`),t&&s&&(s!==i||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(y.MANIFEST_LOADING,{url:e})}get url(){return this._url}get hasEnoughToStart(){return this.streamController.hasEnoughToStart}get startPosition(){return this.streamController.startPositionValue}startLoad(e=-1,t){this.logger.log(`startLoad(${e+(t?", <skip seek to start>":"")})`),this.started=!0,this.resumeBuffering();for(let s=0;s<this.networkControllers.length&&(this.networkControllers[s].startLoad(e,t),!(!this.started||!this.networkControllers));s++);}stopLoad(){this.logger.log("stopLoad"),this.started=!1;for(let e=0;e<this.networkControllers.length&&(this.networkControllers[e].stopLoad(),!(this.started||!this.networkControllers));e++);}get loadingEnabled(){return this.started}get bufferingEnabled(){return this.streamController.bufferingEnabled}resumeBuffering(){this.bufferingEnabled||(this.logger.log("resume buffering"),this.networkControllers.forEach(e=>{e.resumeBuffering&&e.resumeBuffering()}))}pauseBuffering(){this.bufferingEnabled&&(this.logger.log("pause buffering"),this.networkControllers.forEach(e=>{e.pauseBuffering&&e.pauseBuffering()}))}get inFlightFragments(){const e={[V.MAIN]:this.streamController.inFlightFrag};return this.audioStreamController&&(e[V.AUDIO]=this.audioStreamController.inFlightFrag),this.subtititleStreamController&&(e[V.SUBTITLE]=this.subtititleStreamController.inFlightFrag),e}swapAudioCodec(){this.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){this.logger.log("recoverMediaError");const e=this._media,t=e?.currentTime;this.detachMedia(),e&&(this.attachMedia(e),t&&this.startLoad(t))}removeLevel(e){this.levelController.removeLevel(e)}get sessionId(){let e=this._sessionId;return e||(e=this._sessionId=gp()),e}get levels(){const e=this.levelController.levels;return e||[]}get latestLevelDetails(){return this.streamController.getLevelDetails()||null}get loadLevelObj(){return this.levelController.loadLevelObj}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){this.logger.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){this.logger.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){this.logger.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){this.logger.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return e===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){this.logger.log(`set startLevel:${e}`),e!==-1&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get abrEwmaDefaultEstimate(){const{bwEstimator:e}=this.abrController;return e?e.defaultEstimate:NaN}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(this.logger.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){hf(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const s=e.length;for(let i=0;i<s;i++)if(e[i].maxBitrate>=t)return i;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:s}=this;let i;if(t===-1&&e!=null&&e.length?i=e.length-1:i=t,s)for(let n=i;n--;){const r=e[n].attrs["HDCP-LEVEL"];if(r&&r<=s)return n}return i}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get maxBufferLength(){return this.streamController.maxBufferLength}setAudioOption(e){var t;return((t=this.audioTrackController)==null?void 0:t.setAudioOption(e))||null}setSubtitleOption(e){var t;return((t=this.subtitleTrackController)==null?void 0:t.setSubtitleOption(e))||null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return e?e.subtitleDisplay:!1}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}set targetLatency(e){this.latencyController.targetLatency=e}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}get pathways(){return this.levelController.pathways}get pathwayPriority(){return this.levelController.pathwayPriority}set pathwayPriority(e){this.levelController.pathwayPriority=e}get bufferedToEnd(){var e;return!!((e=this.bufferController)!=null&&e.bufferedToEnd)}get interstitialsManager(){var e;return((e=this.interstitialsController)==null?void 0:e.interstitialsManager)||null}getMediaDecodingInfo(e,t=this.allAudioTracks){const s=zc(t);return Jc(e,s,navigator.mediaCapabilities)}}gt.defaultConfig=void 0;const v0="modulepreload",L0=function(o){return"/three-video-projection/"+o},Ol={},R0=function(e,t,s){let i=Promise.resolve();if(t&&t.length>0){let c=function(l){return Promise.all(l.map(h=>Promise.resolve(h).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),a=r?.nonce||r?.getAttribute("nonce");i=c(t.map(l=>{if(l=L0(l),l in Ol)return;Ol[l]=!0;const h=l.endsWith(".css"),u=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${u}`))return;const d=document.createElement("link");if(d.rel=h?"stylesheet":v0,h||(d.as="script"),d.crossOrigin="",d.href=l,a&&d.setAttribute("nonce",a),document.head.appendChild(d),h)return new Promise((A,f)=>{d.addEventListener("load",A),d.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${l}`)))})}))}function n(r){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=r,window.dispatchEvent(a),!a.defaultPrevented)throw r}return i.then(r=>{for(const a of r||[])a.status==="rejected"&&n(a.reason);return e().catch(n)})},Au=0,D0=1,b0=2,Nl=2,tr=1.25,Ul=1,we=32,ye=we/4,fu=65535,rn=Math.pow(2,-24),Yo=Symbol("SKIP_GENERATION"),gu={strategy:Au,maxDepth:40,maxLeafSize:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null,[Yo]:!1};function ue(o,e,t){return t.min.x=e[o],t.min.y=e[o+1],t.min.z=e[o+2],t.max.x=e[o+3],t.max.y=e[o+4],t.max.z=e[o+5],t}function Gl(o){let e=-1,t=-1/0;for(let s=0;s<3;s++){const i=o[s+3]-o[s];i>t&&(t=i,e=s)}return e}function Hl(o,e){e.set(o)}function Kl(o,e,t){let s,i;for(let n=0;n<3;n++){const r=n+3;s=o[n],i=e[n],t[n]=s<i?s:i,s=o[r],i=e[r],t[r]=s>i?s:i}}function _i(o,e,t){for(let s=0;s<3;s++){const i=e[o+2*s],n=e[o+2*s+1],r=i-n,a=i+n;r<t[s]&&(t[s]=r),a>t[s+3]&&(t[s+3]=a)}}function Ns(o){const e=o[3]-o[0],t=o[4]-o[1],s=o[5]-o[2];return 2*(e*t+t*s+s*e)}function Ce(o,e){return e[o+15]===fu}function _e(o,e){return e[o+6]}function Fe(o,e){return e[o+14]}function Be(o){return o+ye}function xe(o,e){const t=e[o+6];return o+t*ye}function qo(o,e){return e[o+7]}function sr(o,e,t,s,i){let n=1/0,r=1/0,a=1/0,c=-1/0,l=-1/0,h=-1/0,u=1/0,d=1/0,A=1/0,f=-1/0,g=-1/0,m=-1/0;const E=o.offset||0;for(let p=(e-E)*6,I=(e+t-E)*6;p<I;p+=6){const C=o[p+0],T=o[p+1],L=C-T,S=C+T;L<n&&(n=L),S>c&&(c=S),C<u&&(u=C),C>f&&(f=C);const x=o[p+2],v=o[p+3],B=x-v,R=x+v;B<r&&(r=B),R>l&&(l=R),x<d&&(d=x),x>g&&(g=x);const D=o[p+4],b=o[p+5],w=D-b,F=D+b;w<a&&(a=w),F>h&&(h=F),D<A&&(A=D),D>m&&(m=D)}s[0]=n,s[1]=r,s[2]=a,s[3]=c,s[4]=l,s[5]=h,i[0]=u,i[1]=d,i[2]=A,i[3]=f,i[4]=g,i[5]=m}const vt=32,w0=(o,e)=>o.candidate-e.candidate,Ft=new Array(vt).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),ki=new Float32Array(6);function _0(o,e,t,s,i,n){let r=-1,a=0;if(n===Au)r=Gl(e),r!==-1&&(a=(e[r]+e[r+3])/2);else if(n===D0)r=Gl(o),r!==-1&&(a=k0(t,s,i,r));else if(n===b0){const c=Ns(o);let l=tr*i;const h=t.offset||0,u=(s-h)*6,d=(s+i-h)*6;for(let A=0;A<3;A++){const f=e[A],E=(e[A+3]-f)/vt;if(i<vt/4){const p=[...Ft];p.length=i;let I=0;for(let T=u;T<d;T+=6,I++){const L=p[I];L.candidate=t[T+2*A],L.count=0;const{bounds:S,leftCacheBounds:x,rightCacheBounds:v}=L;for(let B=0;B<3;B++)v[B]=1/0,v[B+3]=-1/0,x[B]=1/0,x[B+3]=-1/0,S[B]=1/0,S[B+3]=-1/0;_i(T,t,S)}p.sort(w0);let C=i;for(let T=0;T<C;T++){const L=p[T];for(;T+1<C&&p[T+1].candidate===L.candidate;)p.splice(T+1,1),C--}for(let T=u;T<d;T+=6){const L=t[T+2*A];for(let S=0;S<C;S++){const x=p[S];L>=x.candidate?_i(T,t,x.rightCacheBounds):(_i(T,t,x.leftCacheBounds),x.count++)}}for(let T=0;T<C;T++){const L=p[T],S=L.count,x=i-L.count,v=L.leftCacheBounds,B=L.rightCacheBounds;let R=0;S!==0&&(R=Ns(v)/c);let D=0;x!==0&&(D=Ns(B)/c);const b=Ul+tr*(R*S+D*x);b<l&&(r=A,l=b,a=L.candidate)}}else{for(let C=0;C<vt;C++){const T=Ft[C];T.count=0,T.candidate=f+E+C*E;const L=T.bounds;for(let S=0;S<3;S++)L[S]=1/0,L[S+3]=-1/0}for(let C=u;C<d;C+=6){let S=~~((t[C+2*A]-f)/E);S>=vt&&(S=vt-1);const x=Ft[S];x.count++,_i(C,t,x.bounds)}const p=Ft[vt-1];Hl(p.bounds,p.rightCacheBounds);for(let C=vt-2;C>=0;C--){const T=Ft[C],L=Ft[C+1];Kl(T.bounds,L.rightCacheBounds,T.rightCacheBounds)}let I=0;for(let C=0;C<vt-1;C++){const T=Ft[C],L=T.count,S=T.bounds,v=Ft[C+1].rightCacheBounds;L!==0&&(I===0?Hl(S,ki):Kl(S,ki,ki)),I+=L;let B=0,R=0;I!==0&&(B=Ns(ki)/c);const D=i-I;D!==0&&(R=Ns(v)/c);const b=Ul+tr*(B*I+R*D);b<l&&(r=A,l=b,a=T.candidate)}}}}else console.warn(`BVH: Invalid build strategy value ${n} used.`);return{axis:r,pos:a}}function k0(o,e,t,s){let i=0;const n=o.offset;for(let r=e,a=e+t;r<a;r++)i+=o[(r-n)*6+s*2];return i/t}class ir{constructor(){this.boundingData=new Float32Array(6)}}function P0(o,e,t,s,i,n){let r=s,a=s+i-1;const c=n.pos,l=n.axis*2,h=t.offset||0;for(;;){for(;r<=a&&t[(r-h)*6+l]<c;)r++;for(;r<=a&&t[(a-h)*6+l]>=c;)a--;if(r<a){for(let u=0;u<e;u++){let d=o[r*e+u];o[r*e+u]=o[a*e+u],o[a*e+u]=d}for(let u=0;u<6;u++){const d=r-h,A=a-h,f=t[d*6+u];t[d*6+u]=t[A*6+u],t[A*6+u]=f}r++,a--}else return r}}let mu,on,Xr,pu;const F0=Math.pow(2,32);function zr(o){return"count"in o?1:1+zr(o.left)+zr(o.right)}function M0(o,e,t){return mu=new Float32Array(t),on=new Uint32Array(t),Xr=new Uint16Array(t),pu=new Uint8Array(t),Zr(o,e)}function Zr(o,e){const t=o/4,s=o/2,i="count"in e,n=e.boundingData;for(let r=0;r<6;r++)mu[t+r]=n[r];if(i)return e.buffer?(pu.set(new Uint8Array(e.buffer),o),o+e.buffer.byteLength):(on[t+6]=e.offset,Xr[s+14]=e.count,Xr[s+15]=fu,o+we);{const{left:r,right:a,splitAxis:c}=e,l=o+we;let h=Zr(l,r);const u=o/we,A=h/we-u;if(A>F0)throw new Error("MeshBVH: Cannot store relative child node offset greater than 32 bits.");return on[t+6]=A,on[t+7]=c,Zr(h,a)}}function Q0(o,e,t,s,i){const{maxDepth:n,verbose:r,maxLeafSize:a,strategy:c,onProgress:l}=i,h=o.primitiveBuffer,u=o.primitiveBufferStride,d=new Float32Array(6);let A=!1;const f=new ir;return sr(e,t,s,f.boundingData,d),m(f,t,s,d),f;function g(E){l&&l(E/s)}function m(E,p,I,C=null,T=0){if(!A&&T>=n&&(A=!0,r&&console.warn(`BVH: Max depth of ${n} reached when generating BVH. Consider increasing maxDepth.`)),I<=a||T>=n)return g(p+I),E.offset=p,E.count=I,E;const L=_0(E.boundingData,C,e,p,I,c);if(L.axis===-1)return g(p+I),E.offset=p,E.count=I,E;const S=P0(h,u,e,p,I,L);if(S===p||S===p+I)g(p+I),E.offset=p,E.count=I;else{E.splitAxis=L.axis;const x=new ir,v=p,B=S-p;E.left=x,sr(e,v,B,x.boundingData,d),m(x,v,B,d,T+1);const R=new ir,D=S,b=I-B;E.right=R,sr(e,D,b,R.boundingData,d),m(R,D,b,d,T+1)}return E}}function O0(o,e){const t=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,s=o.getRootRanges(e.range),i=s[0],n=s[s.length-1],r={offset:i.offset,count:n.offset+n.count-i.offset},a=new Float32Array(6*r.count);a.offset=r.offset,o.computePrimitiveBounds(r.offset,r.count,a),o._roots=s.map(c=>{const l=Q0(o,a,c.offset,c.count,e),h=zr(l),u=new t(we*h);return M0(0,l,u),u})}class Wo{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return e.length===0?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}class N0{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const e=[];let t=null;this.setBuffer=s=>{t&&e.push(t),t=s,this.float32Array=new Float32Array(s),this.uint16Array=new Uint16Array(s),this.uint32Array=new Uint32Array(s)},this.clearBuffer=()=>{t=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,e.length!==0&&this.setBuffer(e.pop())}}}const ce=new N0;let Ut,vs;const ds=[],Pi=new Wo(()=>new Ye);function U0(o,e,t,s,i,n){Ut=Pi.getPrimitive(),vs=Pi.getPrimitive(),ds.push(Ut,vs),ce.setBuffer(o._roots[e]);const r=eo(0,o.geometry,t,s,i,n);ce.clearBuffer(),Pi.releasePrimitive(Ut),Pi.releasePrimitive(vs),ds.pop(),ds.pop();const a=ds.length;return a>0&&(vs=ds[a-1],Ut=ds[a-2]),r}function eo(o,e,t,s,i=null,n=0,r=0){const{float32Array:a,uint16Array:c,uint32Array:l}=ce;let h=o*2;if(Ce(h,c)){const d=_e(o,l),A=Fe(h,c);return ue(o,a,Ut),s(d,A,!1,r,n+o/ye,Ut)}else{let B=function(D){const{uint16Array:b,uint32Array:w}=ce;let F=D*2;for(;!Ce(F,b);)D=Be(D),F=D*2;return _e(D,w)},R=function(D){const{uint16Array:b,uint32Array:w}=ce;let F=D*2;for(;!Ce(F,b);)D=xe(D,w),F=D*2;return _e(D,w)+Fe(F,b)};const d=Be(o),A=xe(o,l);let f=d,g=A,m,E,p,I;if(i&&(p=Ut,I=vs,ue(f,a,p),ue(g,a,I),m=i(p),E=i(I),E<m)){f=A,g=d;const D=m;m=E,E=D,p=I}p||(p=Ut,ue(f,a,p));const C=Ce(f*2,c),T=t(p,C,m,r+1,n+f/ye);let L;if(T===Nl){const D=B(f),w=R(f)-D;L=s(D,w,!0,r+1,n+f/ye,p)}else L=T&&eo(f,e,t,s,i,n,r+1);if(L)return!0;I=vs,ue(g,a,I);const S=Ce(g*2,c),x=t(I,S,E,r+1,n+g/ye);let v;if(x===Nl){const D=B(g),w=R(g)-D;v=s(D,w,!0,r+1,n+g/ye,I)}else v=x&&eo(g,e,t,s,i,n,r+1);return!!v}}const ni=new ce.constructor,yn=new ce.constructor,Nt=new Wo(()=>new Ye),As=new Ye,fs=new Ye,nr=new Ye,rr=new Ye;let or=!1;function G0(o,e,t,s){if(or)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");or=!0;const i=o._roots,n=e._roots;let r,a=0,c=0;const l=new Me().copy(t).invert();for(let h=0,u=i.length;h<u;h++){ni.setBuffer(i[h]),c=0;const d=Nt.getPrimitive();ue(0,ni.float32Array,d),d.applyMatrix4(l);for(let A=0,f=n.length;A<f&&(yn.setBuffer(n[A]),r=rt(0,0,t,l,s,a,c,0,0,d),yn.clearBuffer(),c+=n[A].byteLength/we,!r);A++);if(Nt.releasePrimitive(d),ni.clearBuffer(),a+=i[h].byteLength/we,r)break}return or=!1,r}function rt(o,e,t,s,i,n=0,r=0,a=0,c=0,l=null,h=!1){let u,d;h?(u=yn,d=ni):(u=ni,d=yn);const A=u.float32Array,f=u.uint32Array,g=u.uint16Array,m=d.float32Array,E=d.uint32Array,p=d.uint16Array,I=o*2,C=e*2,T=Ce(I,g),L=Ce(C,p);let S=!1;if(L&&T)h?S=i(_e(e,E),Fe(e*2,p),_e(o,f),Fe(o*2,g),c,r+e/ye,a,n+o/ye):S=i(_e(o,f),Fe(o*2,g),_e(e,E),Fe(e*2,p),a,n+o/ye,c,r+e/ye);else if(L){const x=Nt.getPrimitive();ue(e,m,x),x.applyMatrix4(t);const v=Be(o),B=xe(o,f);ue(v,A,As),ue(B,A,fs);const R=x.intersectsBox(As),D=x.intersectsBox(fs);S=R&&rt(e,v,s,t,i,r,n,c,a+1,x,!h)||D&&rt(e,B,s,t,i,r,n,c,a+1,x,!h),Nt.releasePrimitive(x)}else{const x=Be(e),v=xe(e,E);ue(x,m,nr),ue(v,m,rr);const B=l.intersectsBox(nr),R=l.intersectsBox(rr);if(B&&R)S=rt(o,x,t,s,i,n,r,a,c+1,l,h)||rt(o,v,t,s,i,n,r,a,c+1,l,h);else if(B)if(T)S=rt(o,x,t,s,i,n,r,a,c+1,l,h);else{const D=Nt.getPrimitive();D.copy(nr).applyMatrix4(t);const b=Be(o),w=xe(o,f);ue(b,A,As),ue(w,A,fs);const F=D.intersectsBox(As),P=D.intersectsBox(fs);S=F&&rt(x,b,s,t,i,r,n,c,a+1,D,!h)||P&&rt(x,w,s,t,i,r,n,c,a+1,D,!h),Nt.releasePrimitive(D)}else if(R)if(T)S=rt(o,v,t,s,i,n,r,a,c+1,l,h);else{const D=Nt.getPrimitive();D.copy(rr).applyMatrix4(t);const b=Be(o),w=xe(o,f);ue(b,A,As),ue(w,A,fs);const F=D.intersectsBox(As),P=D.intersectsBox(fs);S=F&&rt(v,b,s,t,i,r,n,c,a+1,D,!h)||P&&rt(v,w,s,t,i,r,n,c,a+1,D,!h),Nt.releasePrimitive(D)}}return S}const $l=new Ye,gs=new Float32Array(6);class H0{constructor(){this._roots=null,this.primitiveBuffer=null,this.primitiveBufferStride=null}init(e){e={...gu,...e},O0(this,e)}getRootRanges(){throw new Error("BVH: getRootRanges() not implemented")}writePrimitiveBounds(){throw new Error("BVH: writePrimitiveBounds() not implemented")}writePrimitiveRangeBounds(e,t,s,i){let n=1/0,r=1/0,a=1/0,c=-1/0,l=-1/0,h=-1/0;for(let u=e,d=e+t;u<d;u++){this.writePrimitiveBounds(u,gs,0);const[A,f,g,m,E,p]=gs;A<n&&(n=A),m>c&&(c=m),f<r&&(r=f),E>l&&(l=E),g<a&&(a=g),p>h&&(h=p)}return s[i+0]=n,s[i+1]=r,s[i+2]=a,s[i+3]=c,s[i+4]=l,s[i+5]=h,s}computePrimitiveBounds(e,t,s){const i=s.offset||0;for(let n=e,r=e+t;n<r;n++){this.writePrimitiveBounds(n,gs,0);const[a,c,l,h,u,d]=gs,A=(a+h)/2,f=(c+u)/2,g=(l+d)/2,m=(h-a)/2,E=(u-c)/2,p=(d-l)/2,I=(n-i)*6;s[I+0]=A,s[I+1]=m+(Math.abs(A)+m)*rn,s[I+2]=f,s[I+3]=E+(Math.abs(f)+E)*rn,s[I+4]=g,s[I+5]=p+(Math.abs(g)+p)*rn}return s}shiftPrimitiveOffsets(e){const t=this._indirectBuffer;if(t)for(let s=0,i=t.length;s<i;s++)t[s]+=e;else{const s=this._roots;for(let i=0;i<s.length;i++){const n=s[i],r=new Uint32Array(n),a=new Uint16Array(n),c=n.byteLength/we;for(let l=0;l<c;l++){const h=ye*l,u=2*h;Ce(u,a)&&(r[h+6]+=e)}}}}traverse(e,t=0){const s=this._roots[t],i=new Uint32Array(s),n=new Uint16Array(s);r(0);function r(a,c=0){const l=a*2,h=Ce(l,n);if(h){const u=i[a+6],d=n[l+14];e(c,h,new Float32Array(s,a*4,6),u,d)}else{const u=Be(a),d=xe(a,i),A=qo(a,i);e(c,h,new Float32Array(s,a*4,6),A)||(r(u,c+1),r(d,c+1))}}}refit(){const e=this._roots;for(let t=0,s=e.length;t<s;t++){const i=e[t],n=new Uint32Array(i),r=new Uint16Array(i),a=new Float32Array(i),c=i.byteLength/we;for(let l=c-1;l>=0;l--){const h=l*ye,u=h*2;if(Ce(u,r)){const A=_e(h,n),f=Fe(u,r);this.writePrimitiveRangeBounds(A,f,gs,0),a.set(gs,h)}else{const A=Be(h),f=xe(h,n);for(let g=0;g<3;g++){const m=a[A+g],E=a[A+g+3],p=a[f+g],I=a[f+g+3];a[h+g]=m<p?m:p,a[h+g+3]=E>I?E:I}}}}}getBoundingBox(e){return e.makeEmpty(),this._roots.forEach(s=>{ue(0,new Float32Array(s),$l),e.union($l)}),e}shapecast(e){let{boundsTraverseOrder:t,intersectsBounds:s,intersectsRange:i,intersectsPrimitive:n,scratchPrimitive:r,iterate:a}=e;if(i&&n){const u=i;i=(d,A,f,g,m)=>u(d,A,f,g,m)?!0:a(d,A,this,n,f,g,r)}else i||(n?i=(u,d,A,f)=>a(u,d,this,n,A,f,r):i=(u,d,A)=>A);let c=!1,l=0;const h=this._roots;for(let u=0,d=h.length;u<d;u++){const A=h[u];if(c=U0(this,u,s,i,t,l),c)break;l+=A.byteLength/we}return c}bvhcast(e,t,s){let{intersectsRanges:i}=s;return G0(this,e,t,i)}}function K0(){return typeof SharedArrayBuffer<"u"}function jo(o){return o.index?o.index.count:o.attributes.position.count}function Bn(o){return jo(o)/3}function $0(o,e=ArrayBuffer){return o>65535?new Uint32Array(new e(4*o)):new Uint16Array(new e(2*o))}function V0(o,e){if(!o.index){const t=o.attributes.position.count,s=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,i=$0(t,s);o.setIndex(new et(i,1));for(let n=0;n<t;n++)i[n]=n}}function Y0(o,e,t){const s=jo(o)/t,i=e||o.drawRange,n=i.start/t,r=(i.start+i.count)/t,a=Math.max(0,n),c=Math.min(s,r)-a;return{offset:Math.floor(a),count:Math.floor(c)}}function q0(o,e){return o.groups.map(t=>({offset:t.start/e,count:t.count/e}))}function Vl(o,e,t){const s=Y0(o,e,t),i=q0(o,t);if(!i.length)return[s];const n=[],r=s.offset,a=s.offset+s.count,c=jo(o)/t,l=[];for(const d of i){const{offset:A,count:f}=d,g=A,m=isFinite(f)?f:c-A,E=A+m;g<a&&E>r&&(l.push({pos:Math.max(r,g),isStart:!0}),l.push({pos:Math.min(a,E),isStart:!1}))}l.sort((d,A)=>d.pos!==A.pos?d.pos-A.pos:d.type==="end"?-1:1);let h=0,u=null;for(const d of l){const A=d.pos;h!==0&&A!==u&&n.push({offset:u,count:A-u}),h+=d.isStart?1:-1,u=A}return n}function W0(o,e){const t=o[o.length-1],s=t.offset+t.count>2**16,i=o.reduce((l,h)=>l+h.count,0),n=s?4:2,r=e?new SharedArrayBuffer(i*n):new ArrayBuffer(i*n),a=s?new Uint32Array(r):new Uint16Array(r);let c=0;for(let l=0;l<o.length;l++){const{offset:h,count:u}=o[l];for(let d=0;d<u;d++)a[c+d]=h+d;c+=u}return a}class j0 extends H0{get indirect(){return!!this._indirectBuffer}get primitiveStride(){return null}get primitiveBufferStride(){return this.indirect?1:this.primitiveStride}set primitiveBufferStride(e){}get primitiveBuffer(){return this.indirect?this._indirectBuffer:this.geometry.index.array}set primitiveBuffer(e){}constructor(e,t={}){if(e.isBufferGeometry){if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("BVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("BVH: Only BufferGeometries are supported.");if(t.useSharedArrayBuffer&&!K0())throw new Error("BVH: SharedArrayBuffer is not available.");super(),this.geometry=e,this.resolvePrimitiveIndex=t.indirect?s=>this._indirectBuffer[s]:s=>s,this.primitiveBuffer=null,this.primitiveBufferStride=null,this._indirectBuffer=null,t={...gu,...t},t[Yo]||this.init(t)}init(e){const{geometry:t,primitiveStride:s}=this;if(e.indirect){const i=Vl(t,e.range,s),n=W0(i,e.useSharedArrayBuffer);this._indirectBuffer=n}else V0(t,e);super.init(e),!t.boundingBox&&e.setBoundingBox&&(t.boundingBox=this.getBoundingBox(new Ye))}getRootRanges(e){return this.indirect?[{offset:0,count:this._indirectBuffer.length}]:Vl(this.geometry,e,this.primitiveStride)}raycastObject3D(){throw new Error("BVH: raycastObject3D() not implemented")}}class _t{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let s=1/0,i=-1/0;for(let n=0,r=e.length;n<r;n++){const c=e[n][t];s=c<s?c:s,i=c>i?c:i}this.min=s,this.max=i}setFromPoints(e,t){let s=1/0,i=-1/0;for(let n=0,r=t.length;n<r;n++){const a=t[n],c=e.dot(a);s=c<s?c:s,i=c>i?c:i}this.min=s,this.max=i}isSeparated(e){return this.min>e.max||e.min>this.max}}_t.prototype.setFromBox=(function(){const o=new N;return function(t,s){const i=s.min,n=s.max;let r=1/0,a=-1/0;for(let c=0;c<=1;c++)for(let l=0;l<=1;l++)for(let h=0;h<=1;h++){o.x=i.x*c+n.x*(1-c),o.y=i.y*l+n.y*(1-l),o.z=i.z*h+n.z*(1-h);const u=t.dot(o);r=Math.min(u,r),a=Math.max(u,a)}this.min=r,this.max=a}})();const J0=(function(){const o=new N,e=new N,t=new N;return function(i,n,r){const a=i.start,c=o,l=n.start,h=e;t.subVectors(a,l),o.subVectors(i.end,i.start),e.subVectors(n.end,n.start);const u=t.dot(h),d=h.dot(c),A=h.dot(h),f=t.dot(c),m=c.dot(c)*A-d*d;let E,p;m!==0?E=(u*d-f*A)/m:E=0,p=(u+E*d)/A,r.x=E,r.y=p}})(),Jo=(function(){const o=new Et,e=new N,t=new N;return function(i,n,r,a){J0(i,n,o);let c=o.x,l=o.y;if(c>=0&&c<=1&&l>=0&&l<=1){i.at(c,r),n.at(l,a);return}else if(c>=0&&c<=1){l<0?n.at(0,a):n.at(1,a),i.closestPointToPoint(a,!0,r);return}else if(l>=0&&l<=1){c<0?i.at(0,r):i.at(1,r),n.closestPointToPoint(r,!0,a);return}else{let h;c<0?h=i.start:h=i.end;let u;l<0?u=n.start:u=n.end;const d=e,A=t;if(i.closestPointToPoint(u,!0,e),n.closestPointToPoint(h,!0,t),d.distanceToSquared(u)<=A.distanceToSquared(h)){r.copy(d),a.copy(u);return}else{r.copy(h),a.copy(A);return}}}})(),X0=(function(){const o=new N,e=new N,t=new mc,s=new lt;return function(n,r){const{radius:a,center:c}=n,{a:l,b:h,c:u}=r;if(s.start=l,s.end=h,s.closestPointToPoint(c,!0,o).distanceTo(c)<=a||(s.start=l,s.end=u,s.closestPointToPoint(c,!0,o).distanceTo(c)<=a)||(s.start=h,s.end=u,s.closestPointToPoint(c,!0,o).distanceTo(c)<=a))return!0;const g=r.getPlane(t);if(Math.abs(g.distanceToPoint(c))<=a){const E=g.projectPoint(c,e);if(r.containsPoint(E))return!0}return!1}})(),z0=["x","y","z"],bt=1e-15,Yl=bt*bt;function je(o){return Math.abs(o)<bt}class ct extends Cs{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new N),this.satBounds=new Array(4).fill().map(()=>new _t),this.points=[this.a,this.b,this.c],this.plane=new mc,this.isDegenerateIntoSegment=!1,this.isDegenerateIntoPoint=!1,this.degenerateSegment=new lt,this.needsUpdate=!0}intersectsSphere(e){return X0(e,this)}update(){const e=this.a,t=this.b,s=this.c,i=this.points,n=this.satAxes,r=this.satBounds,a=n[0],c=r[0];this.getNormal(a),c.setFromPoints(a,i);const l=n[1],h=r[1];l.subVectors(e,t),h.setFromPoints(l,i);const u=n[2],d=r[2];u.subVectors(t,s),d.setFromPoints(u,i);const A=n[3],f=r[3];A.subVectors(s,e),f.setFromPoints(A,i);const g=l.length(),m=u.length(),E=A.length();this.isDegenerateIntoPoint=!1,this.isDegenerateIntoSegment=!1,g<bt?m<bt||E<bt?this.isDegenerateIntoPoint=!0:(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(e),this.degenerateSegment.end.copy(s)):m<bt?E<bt?this.isDegenerateIntoPoint=!0:(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(t),this.degenerateSegment.end.copy(e)):E<bt&&(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(s),this.degenerateSegment.end.copy(t)),this.plane.setFromNormalAndCoplanarPoint(a,e),this.needsUpdate=!1}}ct.prototype.closestPointToSegment=(function(){const o=new N,e=new N,t=new lt;return function(i,n=null,r=null){const{start:a,end:c}=i,l=this.points;let h,u=1/0;for(let d=0;d<3;d++){const A=(d+1)%3;t.start.copy(l[d]),t.end.copy(l[A]),Jo(t,i,o,e),h=o.distanceToSquared(e),h<u&&(u=h,n&&n.copy(o),r&&r.copy(e))}return this.closestPointToPoint(a,o),h=a.distanceToSquared(o),h<u&&(u=h,n&&n.copy(o),r&&r.copy(a)),this.closestPointToPoint(c,o),h=c.distanceToSquared(o),h<u&&(u=h,n&&n.copy(o),r&&r.copy(c)),Math.sqrt(u)}})();ct.prototype.intersectsTriangle=(function(){const o=new ct,e=new _t,t=new _t,s=new N,i=new N,n=new N,r=new N,a=new lt,c=new lt,l=new N,h=new Et,u=new Et;function d(I,C,T,L){const S=s;!I.isDegenerateIntoPoint&&!I.isDegenerateIntoSegment?S.copy(I.plane.normal):S.copy(C.plane.normal);const x=I.satBounds,v=I.satAxes;for(let D=1;D<4;D++){const b=x[D],w=v[D];if(e.setFromPoints(w,C.points),b.isSeparated(e)||(r.copy(S).cross(w),e.setFromPoints(r,I.points),t.setFromPoints(r,C.points),e.isSeparated(t)))return!1}const B=C.satBounds,R=C.satAxes;for(let D=1;D<4;D++){const b=B[D],w=R[D];if(e.setFromPoints(w,I.points),b.isSeparated(e)||(r.crossVectors(S,w),e.setFromPoints(r,I.points),t.setFromPoints(r,C.points),e.isSeparated(t)))return!1}return T&&(L||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),T.start.set(0,0,0),T.end.set(0,0,0)),!0}function A(I,C,T,L,S,x,v,B,R,D,b){let w=v/(v-B);D.x=L+(S-L)*w,b.start.subVectors(C,I).multiplyScalar(w).add(I),w=v/(v-R),D.y=L+(x-L)*w,b.end.subVectors(T,I).multiplyScalar(w).add(I)}function f(I,C,T,L,S,x,v,B,R,D,b){if(S>0)A(I.c,I.a,I.b,L,C,T,R,v,B,D,b);else if(x>0)A(I.b,I.a,I.c,T,C,L,B,v,R,D,b);else if(B*R>0||v!=0)A(I.a,I.b,I.c,C,T,L,v,B,R,D,b);else if(B!=0)A(I.b,I.a,I.c,T,C,L,B,v,R,D,b);else if(R!=0)A(I.c,I.a,I.b,L,C,T,R,v,B,D,b);else return!0;return!1}function g(I,C,T,L){const S=C.degenerateSegment,x=I.plane.distanceToPoint(S.start),v=I.plane.distanceToPoint(S.end);return je(x)?je(v)?d(I,C,T,L):(T&&(T.start.copy(S.start),T.end.copy(S.start)),I.containsPoint(S.start)):je(v)?(T&&(T.start.copy(S.end),T.end.copy(S.end)),I.containsPoint(S.end)):I.plane.intersectLine(S,s)!=null?(T&&(T.start.copy(s),T.end.copy(s)),I.containsPoint(s)):!1}function m(I,C,T){const L=C.a;return je(I.plane.distanceToPoint(L))&&I.containsPoint(L)?(T&&(T.start.copy(L),T.end.copy(L)),!0):!1}function E(I,C,T){const L=I.degenerateSegment,S=C.a;return L.closestPointToPoint(S,!0,s),S.distanceToSquared(s)<Yl?(T&&(T.start.copy(S),T.end.copy(S)),!0):!1}function p(I,C,T,L){if(I.isDegenerateIntoSegment)if(C.isDegenerateIntoSegment){const S=I.degenerateSegment,x=C.degenerateSegment,v=i,B=n;S.delta(v),x.delta(B);const R=s.subVectors(x.start,S.start),D=v.x*B.y-v.y*B.x;if(je(D))return!1;const b=(R.x*B.y-R.y*B.x)/D,w=-(v.x*R.y-v.y*R.x)/D;if(b<0||b>1||w<0||w>1)return!1;const F=S.start.z+v.z*b,P=x.start.z+B.z*w;return je(F-P)?(T&&(T.start.copy(S.start).addScaledVector(v,b),T.end.copy(S.start).addScaledVector(v,b)),!0):!1}else return C.isDegenerateIntoPoint?E(I,C,T):g(C,I,T,L);else{if(I.isDegenerateIntoPoint)return C.isDegenerateIntoPoint?C.a.distanceToSquared(I.a)<Yl?(T&&(T.start.copy(I.a),T.end.copy(I.a)),!0):!1:C.isDegenerateIntoSegment?E(C,I,T):m(C,I,T);if(C.isDegenerateIntoPoint)return m(I,C,T);if(C.isDegenerateIntoSegment)return g(I,C,T,L)}}return function(C,T=null,L=!1){this.needsUpdate&&this.update(),C.isExtendedTriangle?C.needsUpdate&&C.update():(o.copy(C),o.update(),C=o);const S=p(this,C,T,L);if(S!==void 0)return S;const x=this.plane,v=C.plane;let B=v.distanceToPoint(this.a),R=v.distanceToPoint(this.b),D=v.distanceToPoint(this.c);je(B)&&(B=0),je(R)&&(R=0),je(D)&&(D=0);const b=B*R,w=B*D;if(b>0&&w>0)return!1;let F=x.distanceToPoint(C.a),P=x.distanceToPoint(C.b),G=x.distanceToPoint(C.c);je(F)&&(F=0),je(P)&&(P=0),je(G)&&(G=0);const U=F*P,H=F*G;if(U>0&&H>0)return!1;i.copy(x.normal),n.copy(v.normal);const $=i.cross(n);let O=0,Q=Math.abs($.x);const Y=Math.abs($.y);Y>Q&&(Q=Y,O=1),Math.abs($.z)>Q&&(O=2);const j=z0[O],ee=this.a[j],Te=this.b[j],pe=this.c[j],Oe=C.a[j],qe=C.b[j],St=C.c[j];if(f(this,ee,Te,pe,b,w,B,R,D,h,a))return d(this,C,T,L);if(f(C,Oe,qe,St,U,H,F,P,G,u,c))return d(this,C,T,L);if(h.y<h.x){const Fs=h.y;h.y=h.x,h.x=Fs,l.copy(a.start),a.start.copy(a.end),a.end.copy(l)}if(u.y<u.x){const Fs=u.y;u.y=u.x,u.x=Fs,l.copy(c.start),c.start.copy(c.end),c.end.copy(l)}return h.y<u.x||u.y<h.x?!1:(T&&(u.x>h.x?T.start.copy(c.start):T.start.copy(a.start),u.y<h.y?T.end.copy(c.end):T.end.copy(a.end)),!0)}})();ct.prototype.distanceToPoint=(function(){const o=new N;return function(t){return this.closestPointToPoint(t,o),t.distanceTo(o)}})();ct.prototype.distanceToTriangle=(function(){const o=new N,e=new N,t=["a","b","c"],s=new lt,i=new lt;return function(r,a=null,c=null){const l=a||c?s:null;if(this.intersectsTriangle(r,l))return(a||c)&&(a&&l.getCenter(a),c&&l.getCenter(c)),0;let h=1/0;for(let u=0;u<3;u++){let d;const A=t[u],f=r[A];this.closestPointToPoint(f,o),d=f.distanceToSquared(o),d<h&&(h=d,a&&a.copy(o),c&&c.copy(f));const g=this[A];r.closestPointToPoint(g,o),d=g.distanceToSquared(o),d<h&&(h=d,a&&a.copy(g),c&&c.copy(o))}for(let u=0;u<3;u++){const d=t[u],A=t[(u+1)%3];s.set(this[d],this[A]);for(let f=0;f<3;f++){const g=t[f],m=t[(f+1)%3];i.set(r[g],r[m]),Jo(s,i,o,e);const E=o.distanceToSquared(e);E<h&&(h=E,a&&a.copy(o),c&&c.copy(e))}}return Math.sqrt(h)}})();class Qe{constructor(e,t,s){this.isOrientedBox=!0,this.min=new N,this.max=new N,this.matrix=new Me,this.invMatrix=new Me,this.points=new Array(8).fill().map(()=>new N),this.satAxes=new Array(3).fill().map(()=>new N),this.satBounds=new Array(3).fill().map(()=>new _t),this.alignedSatBounds=new Array(3).fill().map(()=>new _t),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),s&&this.matrix.copy(s)}set(e,t,s){this.min.copy(e),this.max.copy(t),this.matrix.copy(s),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}Qe.prototype.update=(function(){return function(){const e=this.matrix,t=this.min,s=this.max,i=this.points;for(let l=0;l<=1;l++)for(let h=0;h<=1;h++)for(let u=0;u<=1;u++){const d=1*l|2*h|4*u,A=i[d];A.x=l?s.x:t.x,A.y=h?s.y:t.y,A.z=u?s.z:t.z,A.applyMatrix4(e)}const n=this.satBounds,r=this.satAxes,a=i[0];for(let l=0;l<3;l++){const h=r[l],u=n[l],d=1<<l,A=i[d];h.subVectors(a,A),u.setFromPoints(h,i)}const c=this.alignedSatBounds;c[0].setFromPointsField(i,"x"),c[1].setFromPointsField(i,"y"),c[2].setFromPointsField(i,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}})();Qe.prototype.intersectsBox=(function(){const o=new _t;return function(t){this.needsUpdate&&this.update();const s=t.min,i=t.max,n=this.satBounds,r=this.satAxes,a=this.alignedSatBounds;if(o.min=s.x,o.max=i.x,a[0].isSeparated(o)||(o.min=s.y,o.max=i.y,a[1].isSeparated(o))||(o.min=s.z,o.max=i.z,a[2].isSeparated(o)))return!1;for(let c=0;c<3;c++){const l=r[c],h=n[c];if(o.setFromBox(l,t),h.isSeparated(o))return!1}return!0}})();Qe.prototype.intersectsTriangle=(function(){const o=new ct,e=new Array(3),t=new _t,s=new _t,i=new N;return function(r){this.needsUpdate&&this.update(),r.isExtendedTriangle?r.needsUpdate&&r.update():(o.copy(r),o.update(),r=o);const a=this.satBounds,c=this.satAxes;e[0]=r.a,e[1]=r.b,e[2]=r.c;for(let d=0;d<3;d++){const A=a[d],f=c[d];if(t.setFromPoints(f,e),A.isSeparated(t))return!1}const l=r.satBounds,h=r.satAxes,u=this.points;for(let d=0;d<3;d++){const A=l[d],f=h[d];if(t.setFromPoints(f,u),A.isSeparated(t))return!1}for(let d=0;d<3;d++){const A=c[d];for(let f=0;f<4;f++){const g=h[f];if(i.crossVectors(A,g),t.setFromPoints(i,e),s.setFromPoints(i,u),t.isSeparated(s))return!1}}return!0}})();Qe.prototype.closestPointToPoint=(function(){return function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t}})();Qe.prototype.distanceToPoint=(function(){const o=new N;return function(t){return this.closestPointToPoint(t,o),t.distanceTo(o)}})();Qe.prototype.distanceToBox=(function(){const o=["x","y","z"],e=new Array(12).fill().map(()=>new lt),t=new Array(12).fill().map(()=>new lt),s=new N,i=new N;return function(r,a=0,c=null,l=null){if(this.needsUpdate&&this.update(),this.intersectsBox(r))return(c||l)&&(r.getCenter(i),this.closestPointToPoint(i,s),r.closestPointToPoint(s,i),c&&c.copy(s),l&&l.copy(i)),0;const h=a*a,u=r.min,d=r.max,A=this.points;let f=1/0;for(let m=0;m<8;m++){const E=A[m];i.copy(E).clamp(u,d);const p=E.distanceToSquared(i);if(p<f&&(f=p,c&&c.copy(E),l&&l.copy(i),p<h))return Math.sqrt(p)}let g=0;for(let m=0;m<3;m++)for(let E=0;E<=1;E++)for(let p=0;p<=1;p++){const I=(m+1)%3,C=(m+2)%3,T=E<<I|p<<C,L=1<<m|E<<I|p<<C,S=A[T],x=A[L];e[g].set(S,x);const B=o[m],R=o[I],D=o[C],b=t[g],w=b.start,F=b.end;w[B]=u[B],w[R]=E?u[R]:d[R],w[D]=p?u[D]:d[R],F[B]=d[B],F[R]=E?u[R]:d[R],F[D]=p?u[D]:d[R],g++}for(let m=0;m<=1;m++)for(let E=0;E<=1;E++)for(let p=0;p<=1;p++){i.x=m?d.x:u.x,i.y=E?d.y:u.y,i.z=p?d.z:u.z,this.closestPointToPoint(i,s);const I=i.distanceToSquared(s);if(I<f&&(f=I,c&&c.copy(s),l&&l.copy(i),I<h))return Math.sqrt(I)}for(let m=0;m<12;m++){const E=e[m];for(let p=0;p<12;p++){const I=t[p];Jo(E,I,s,i);const C=s.distanceToSquared(i);if(C<f&&(f=C,c&&c.copy(s),l&&l.copy(i),C<h))return Math.sqrt(C)}}return Math.sqrt(f)}})();class Z0 extends Wo{constructor(){super(()=>new ct)}}const Ze=new Z0,Us=new N,ar=new N;function eE(o,e,t={},s=0,i=1/0){const n=s*s,r=i*i;let a=1/0,c=null;if(o.shapecast({boundsTraverseOrder:h=>(Us.copy(e).clamp(h.min,h.max),Us.distanceToSquared(e)),intersectsBounds:(h,u,d)=>d<a&&d<r,intersectsTriangle:(h,u)=>{h.closestPointToPoint(e,Us);const d=e.distanceToSquared(Us);return d<a&&(ar.copy(Us),a=d,c=u),d<n}}),a===1/0)return null;const l=Math.sqrt(a);return t.point?t.point.copy(ar):t.point=ar.clone(),t.distance=l,t.faceIndex=c,t}const Fi=parseInt(pc)>=169,tE=parseInt(pc)<=161,zt=new N,Zt=new N,es=new N,Mi=new Et,Qi=new Et,Oi=new Et,ql=new N,Wl=new N,jl=new N,Gs=new N;function sE(o,e,t,s,i,n,r,a){let c;if(n===rd?c=o.intersectTriangle(s,t,e,!0,i):c=o.intersectTriangle(e,t,s,n!==Ao,i),c===null)return null;const l=o.origin.distanceTo(i);return l<r||l>a?null:{distance:l,point:i.clone()}}function Jl(o,e,t,s,i,n,r,a,c,l,h){zt.fromBufferAttribute(e,n),Zt.fromBufferAttribute(e,r),es.fromBufferAttribute(e,a);const u=sE(o,zt,Zt,es,Gs,c,l,h);if(u){if(s){Mi.fromBufferAttribute(s,n),Qi.fromBufferAttribute(s,r),Oi.fromBufferAttribute(s,a),u.uv=new Et;const A=Cs.getInterpolation(Gs,zt,Zt,es,Mi,Qi,Oi,u.uv);Fi||(u.uv=A)}if(i){Mi.fromBufferAttribute(i,n),Qi.fromBufferAttribute(i,r),Oi.fromBufferAttribute(i,a),u.uv1=new Et;const A=Cs.getInterpolation(Gs,zt,Zt,es,Mi,Qi,Oi,u.uv1);Fi||(u.uv1=A),tE&&(u.uv2=u.uv1)}if(t){ql.fromBufferAttribute(t,n),Wl.fromBufferAttribute(t,r),jl.fromBufferAttribute(t,a),u.normal=new N;const A=Cs.getInterpolation(Gs,zt,Zt,es,ql,Wl,jl,u.normal);u.normal.dot(o.direction)>0&&u.normal.multiplyScalar(-1),Fi||(u.normal=A)}const d={a:n,b:r,c:a,normal:new N,materialIndex:0};if(Cs.getNormal(zt,Zt,es,d.normal),u.face=d,u.faceIndex=n,Fi){const A=new N;Cs.getBarycoord(Gs,zt,Zt,es,A),u.barycoord=A}}return u}function Xl(o){return o&&o.isMaterial?o.side:o}function xn(o,e,t,s,i,n,r){const a=s*3;let c=a+0,l=a+1,h=a+2;const{index:u,groups:d}=o;o.index&&(c=u.getX(c),l=u.getX(l),h=u.getX(h));const{position:A,normal:f,uv:g,uv1:m}=o.attributes;if(Array.isArray(e)){const E=s*3;for(let p=0,I=d.length;p<I;p++){const{start:C,count:T,materialIndex:L}=d[p];if(E>=C&&E<C+T){const S=Xl(e[L]),x=Jl(t,A,f,g,m,c,l,h,S,n,r);if(x)if(x.faceIndex=s,x.face.materialIndex=L,i)i.push(x);else return x}}}else{const E=Xl(e),p=Jl(t,A,f,g,m,c,l,h,E,n,r);if(p)if(p.faceIndex=s,p.face.materialIndex=0,i)i.push(p);else return p}return null}function me(o,e,t,s){const i=o.a,n=o.b,r=o.c;let a=e,c=e+1,l=e+2;t&&(a=t.getX(a),c=t.getX(c),l=t.getX(l)),i.x=s.getX(a),i.y=s.getY(a),i.z=s.getZ(a),n.x=s.getX(c),n.y=s.getY(c),n.z=s.getZ(c),r.x=s.getX(l),r.y=s.getY(l),r.z=s.getZ(l)}function iE(o,e,t,s,i,n,r,a){const{geometry:c,_indirectBuffer:l}=o;for(let h=s,u=s+i;h<u;h++)xn(c,e,t,h,n,r,a)}function nE(o,e,t,s,i,n,r){const{geometry:a,_indirectBuffer:c}=o;let l=1/0,h=null;for(let u=s,d=s+i;u<d;u++){let A;A=xn(a,e,t,u,null,n,r),A&&A.distance<l&&(h=A,l=A.distance)}return h}function rE(o,e,t,s,i,n,r){const{geometry:a}=t,{index:c}=a,l=a.attributes.position;for(let h=o,u=e+o;h<u;h++){let d;if(d=h,me(r,d*3,c,l),r.needsUpdate=!0,s(r,d,i,n))return!0}return!1}function oE(o,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=o.geometry,s=t.index?t.index.array:null,i=t.attributes.position;let n,r,a,c,l=0;const h=o._roots;for(let d=0,A=h.length;d<A;d++)n=h[d],r=new Uint32Array(n),a=new Uint16Array(n),c=new Float32Array(n),u(0,l),l+=n.byteLength;function u(d,A,f=!1){const g=d*2;if(Ce(g,a)){const m=_e(d,r),E=Fe(g,a);let p=1/0,I=1/0,C=1/0,T=-1/0,L=-1/0,S=-1/0;for(let x=3*m,v=3*(m+E);x<v;x++){let B=s[x];const R=i.getX(B),D=i.getY(B),b=i.getZ(B);R<p&&(p=R),R>T&&(T=R),D<I&&(I=D),D>L&&(L=D),b<C&&(C=b),b>S&&(S=b)}return c[d+0]!==p||c[d+1]!==I||c[d+2]!==C||c[d+3]!==T||c[d+4]!==L||c[d+5]!==S?(c[d+0]=p,c[d+1]=I,c[d+2]=C,c[d+3]=T,c[d+4]=L,c[d+5]=S,!0):!1}else{const m=Be(d),E=xe(d,r);let p=f,I=!1,C=!1;if(e){if(!p){const B=m/ye+A/we,R=E/ye+A/we;I=e.has(B),C=e.has(R),p=!I&&!C}}else I=!0,C=!0;const T=p||I,L=p||C;let S=!1;T&&(S=u(m,A,p));let x=!1;L&&(x=u(E,A,p));const v=S||x;if(v)for(let B=0;B<3;B++){const R=m+B,D=E+B,b=c[R],w=c[R+3],F=c[D],P=c[D+3];c[d+B]=b<F?b:F,c[d+B+3]=w>P?w:P}return v}}}function qt(o,e,t,s,i){let n,r,a,c,l,h;const u=1/t.direction.x,d=1/t.direction.y,A=1/t.direction.z,f=t.origin.x,g=t.origin.y,m=t.origin.z;let E=e[o],p=e[o+3],I=e[o+1],C=e[o+3+1],T=e[o+2],L=e[o+3+2];return u>=0?(n=(E-f)*u,r=(p-f)*u):(n=(p-f)*u,r=(E-f)*u),d>=0?(a=(I-g)*d,c=(C-g)*d):(a=(C-g)*d,c=(I-g)*d),n>c||a>r||((a>n||isNaN(n))&&(n=a),(c<r||isNaN(r))&&(r=c),A>=0?(l=(T-m)*A,h=(L-m)*A):(l=(L-m)*A,h=(T-m)*A),n>h||l>r)?!1:((l>n||n!==n)&&(n=l),(h<r||r!==r)&&(r=h),n<=i&&r>=s)}function aE(o,e,t,s,i,n,r,a){const{geometry:c,_indirectBuffer:l}=o;for(let h=s,u=s+i;h<u;h++){let d=l?l[h]:h;xn(c,e,t,d,n,r,a)}}function lE(o,e,t,s,i,n,r){const{geometry:a,_indirectBuffer:c}=o;let l=1/0,h=null;for(let u=s,d=s+i;u<d;u++){let A;A=xn(a,e,t,c?c[u]:u,null,n,r),A&&A.distance<l&&(h=A,l=A.distance)}return h}function cE(o,e,t,s,i,n,r){const{geometry:a}=t,{index:c}=a,l=a.attributes.position;for(let h=o,u=e+o;h<u;h++){let d;if(d=t.resolveTriangleIndex(h),me(r,d*3,c,l),r.needsUpdate=!0,s(r,d,i,n))return!0}return!1}function hE(o,e,t,s,i,n,r){ce.setBuffer(o._roots[e]),to(0,o,t,s,i,n,r),ce.clearBuffer()}function to(o,e,t,s,i,n,r){const{float32Array:a,uint16Array:c,uint32Array:l}=ce,h=o*2;if(Ce(h,c)){const d=_e(o,l),A=Fe(h,c);iE(e,t,s,d,A,i,n,r)}else{const d=Be(o);qt(d,a,s,n,r)&&to(d,e,t,s,i,n,r);const A=xe(o,l);qt(A,a,s,n,r)&&to(A,e,t,s,i,n,r)}}const uE=["x","y","z"];function dE(o,e,t,s,i,n){ce.setBuffer(o._roots[e]);const r=so(0,o,t,s,i,n);return ce.clearBuffer(),r}function so(o,e,t,s,i,n){const{float32Array:r,uint16Array:a,uint32Array:c}=ce;let l=o*2;if(Ce(l,a)){const u=_e(o,c),d=Fe(l,a);return nE(e,t,s,u,d,i,n)}else{const u=qo(o,c),d=uE[u],f=s.direction[d]>=0;let g,m;f?(g=Be(o),m=xe(o,c)):(g=xe(o,c),m=Be(o));const p=qt(g,r,s,i,n)?so(g,e,t,s,i,n):null;if(p){const T=p.point[d];if(f?T<=r[m+u]:T>=r[m+u+3])return p}const C=qt(m,r,s,i,n)?so(m,e,t,s,i,n):null;return p&&C?p.distance<=C.distance?p:C:p||C||null}}const Ni=new Ye,ms=new ct,ps=new ct,Hs=new Me,zl=new Qe,Ui=new Qe;function AE(o,e,t,s){ce.setBuffer(o._roots[e]);const i=io(0,o,t,s);return ce.clearBuffer(),i}function io(o,e,t,s,i=null){const{float32Array:n,uint16Array:r,uint32Array:a}=ce;let c=o*2;if(i===null&&(t.boundingBox||t.computeBoundingBox(),zl.set(t.boundingBox.min,t.boundingBox.max,s),i=zl),Ce(c,r)){const h=e.geometry,u=h.index,d=h.attributes.position,A=t.index,f=t.attributes.position,g=_e(o,a),m=Fe(c,r);if(Hs.copy(s).invert(),t.boundsTree)return ue(o,n,Ui),Ui.matrix.copy(Hs),Ui.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:p=>Ui.intersectsBox(p),intersectsTriangle:p=>{p.a.applyMatrix4(s),p.b.applyMatrix4(s),p.c.applyMatrix4(s),p.needsUpdate=!0;for(let I=g*3,C=(m+g)*3;I<C;I+=3)if(me(ps,I,u,d),ps.needsUpdate=!0,p.intersectsTriangle(ps))return!0;return!1}});{const E=Bn(t);for(let p=g*3,I=(m+g)*3;p<I;p+=3){me(ms,p,u,d),ms.a.applyMatrix4(Hs),ms.b.applyMatrix4(Hs),ms.c.applyMatrix4(Hs),ms.needsUpdate=!0;for(let C=0,T=E*3;C<T;C+=3)if(me(ps,C,A,f),ps.needsUpdate=!0,ms.intersectsTriangle(ps))return!0}}}else{const h=Be(o),u=xe(o,a);return ue(h,n,Ni),!!(i.intersectsBox(Ni)&&io(h,e,t,s,i)||(ue(u,n,Ni),i.intersectsBox(Ni)&&io(u,e,t,s,i)))}}const Gi=new Me,lr=new Qe,Ks=new Qe,fE=new N,gE=new N,mE=new N,pE=new N;function EE(o,e,t,s={},i={},n=0,r=1/0){e.boundingBox||e.computeBoundingBox(),lr.set(e.boundingBox.min,e.boundingBox.max,t),lr.needsUpdate=!0;const a=o.geometry,c=a.attributes.position,l=a.index,h=e.attributes.position,u=e.index,d=Ze.getPrimitive(),A=Ze.getPrimitive();let f=fE,g=gE,m=null,E=null;i&&(m=mE,E=pE);let p=1/0,I=null,C=null;return Gi.copy(t).invert(),Ks.matrix.copy(Gi),o.shapecast({boundsTraverseOrder:T=>lr.distanceToBox(T),intersectsBounds:(T,L,S)=>S<p&&S<r?(L&&(Ks.min.copy(T.min),Ks.max.copy(T.max),Ks.needsUpdate=!0),!0):!1,intersectsRange:(T,L)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:x=>Ks.distanceToBox(x),intersectsBounds:(x,v,B)=>B<p&&B<r,intersectsRange:(x,v)=>{for(let B=x,R=x+v;B<R;B++){me(A,3*B,u,h),A.a.applyMatrix4(t),A.b.applyMatrix4(t),A.c.applyMatrix4(t),A.needsUpdate=!0;for(let D=T,b=T+L;D<b;D++){me(d,3*D,l,c),d.needsUpdate=!0;const w=d.distanceToTriangle(A,f,m);if(w<p&&(g.copy(f),E&&E.copy(m),p=w,I=D,C=B),w<n)return!0}}}});{const S=Bn(e);for(let x=0,v=S;x<v;x++){me(A,3*x,u,h),A.a.applyMatrix4(t),A.b.applyMatrix4(t),A.c.applyMatrix4(t),A.needsUpdate=!0;for(let B=T,R=T+L;B<R;B++){me(d,3*B,l,c),d.needsUpdate=!0;const D=d.distanceToTriangle(A,f,m);if(D<p&&(g.copy(f),E&&E.copy(m),p=D,I=B,C=x),D<n)return!0}}}}}),Ze.releasePrimitive(d),Ze.releasePrimitive(A),p===1/0?null:(s.point?s.point.copy(g):s.point=g.clone(),s.distance=p,s.faceIndex=I,i&&(i.point?i.point.copy(E):i.point=E.clone(),i.point.applyMatrix4(Gi),g.applyMatrix4(Gi),i.distance=g.sub(i.point).length(),i.faceIndex=C),s)}function IE(o,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=o.geometry,s=t.index?t.index.array:null,i=t.attributes.position;let n,r,a,c,l=0;const h=o._roots;for(let d=0,A=h.length;d<A;d++)n=h[d],r=new Uint32Array(n),a=new Uint16Array(n),c=new Float32Array(n),u(0,l),l+=n.byteLength;function u(d,A,f=!1){const g=d*2;if(Ce(g,a)){const m=_e(d,r),E=Fe(g,a);let p=1/0,I=1/0,C=1/0,T=-1/0,L=-1/0,S=-1/0;for(let x=m,v=m+E;x<v;x++){const B=3*o.resolveTriangleIndex(x);for(let R=0;R<3;R++){let D=B+R;D=s?s[D]:D;const b=i.getX(D),w=i.getY(D),F=i.getZ(D);b<p&&(p=b),b>T&&(T=b),w<I&&(I=w),w>L&&(L=w),F<C&&(C=F),F>S&&(S=F)}}return c[d+0]!==p||c[d+1]!==I||c[d+2]!==C||c[d+3]!==T||c[d+4]!==L||c[d+5]!==S?(c[d+0]=p,c[d+1]=I,c[d+2]=C,c[d+3]=T,c[d+4]=L,c[d+5]=S,!0):!1}else{const m=Be(d),E=xe(d,r);let p=f,I=!1,C=!1;if(e){if(!p){const B=m/ye+A/we,R=E/ye+A/we;I=e.has(B),C=e.has(R),p=!I&&!C}}else I=!0,C=!0;const T=p||I,L=p||C;let S=!1;T&&(S=u(m,A,p));let x=!1;L&&(x=u(E,A,p));const v=S||x;if(v)for(let B=0;B<3;B++){const R=m+B,D=E+B,b=c[R],w=c[R+3],F=c[D],P=c[D+3];c[d+B]=b<F?b:F,c[d+B+3]=w>P?w:P}return v}}}function yE(o,e,t,s,i,n,r){ce.setBuffer(o._roots[e]),no(0,o,t,s,i,n,r),ce.clearBuffer()}function no(o,e,t,s,i,n,r){const{float32Array:a,uint16Array:c,uint32Array:l}=ce,h=o*2;if(Ce(h,c)){const d=_e(o,l),A=Fe(h,c);aE(e,t,s,d,A,i,n,r)}else{const d=Be(o);qt(d,a,s,n,r)&&no(d,e,t,s,i,n,r);const A=xe(o,l);qt(A,a,s,n,r)&&no(A,e,t,s,i,n,r)}}const CE=["x","y","z"];function TE(o,e,t,s,i,n){ce.setBuffer(o._roots[e]);const r=ro(0,o,t,s,i,n);return ce.clearBuffer(),r}function ro(o,e,t,s,i,n){const{float32Array:r,uint16Array:a,uint32Array:c}=ce;let l=o*2;if(Ce(l,a)){const u=_e(o,c),d=Fe(l,a);return lE(e,t,s,u,d,i,n)}else{const u=qo(o,c),d=CE[u],f=s.direction[d]>=0;let g,m;f?(g=Be(o),m=xe(o,c)):(g=xe(o,c),m=Be(o));const p=qt(g,r,s,i,n)?ro(g,e,t,s,i,n):null;if(p){const T=p.point[d];if(f?T<=r[m+u]:T>=r[m+u+3])return p}const C=qt(m,r,s,i,n)?ro(m,e,t,s,i,n):null;return p&&C?p.distance<=C.distance?p:C:p||C||null}}const Hi=new Ye,Es=new ct,Is=new ct,$s=new Me,Zl=new Qe,Ki=new Qe;function SE(o,e,t,s){ce.setBuffer(o._roots[e]);const i=oo(0,o,t,s);return ce.clearBuffer(),i}function oo(o,e,t,s,i=null){const{float32Array:n,uint16Array:r,uint32Array:a}=ce;let c=o*2;if(i===null&&(t.boundingBox||t.computeBoundingBox(),Zl.set(t.boundingBox.min,t.boundingBox.max,s),i=Zl),Ce(c,r)){const h=e.geometry,u=h.index,d=h.attributes.position,A=t.index,f=t.attributes.position,g=_e(o,a),m=Fe(c,r);if($s.copy(s).invert(),t.boundsTree)return ue(o,n,Ki),Ki.matrix.copy($s),Ki.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:p=>Ki.intersectsBox(p),intersectsTriangle:p=>{p.a.applyMatrix4(s),p.b.applyMatrix4(s),p.c.applyMatrix4(s),p.needsUpdate=!0;for(let I=g,C=m+g;I<C;I++)if(me(Is,3*e.resolveTriangleIndex(I),u,d),Is.needsUpdate=!0,p.intersectsTriangle(Is))return!0;return!1}});{const E=Bn(t);for(let p=g,I=m+g;p<I;p++){const C=e.resolveTriangleIndex(p);me(Es,3*C,u,d),Es.a.applyMatrix4($s),Es.b.applyMatrix4($s),Es.c.applyMatrix4($s),Es.needsUpdate=!0;for(let T=0,L=E*3;T<L;T+=3)if(me(Is,T,A,f),Is.needsUpdate=!0,Es.intersectsTriangle(Is))return!0}}}else{const h=Be(o),u=xe(o,a);return ue(h,n,Hi),!!(i.intersectsBox(Hi)&&oo(h,e,t,s,i)||(ue(u,n,Hi),i.intersectsBox(Hi)&&oo(u,e,t,s,i)))}}const $i=new Me,cr=new Qe,Vs=new Qe,BE=new N,xE=new N,vE=new N,LE=new N;function RE(o,e,t,s={},i={},n=0,r=1/0){e.boundingBox||e.computeBoundingBox(),cr.set(e.boundingBox.min,e.boundingBox.max,t),cr.needsUpdate=!0;const a=o.geometry,c=a.attributes.position,l=a.index,h=e.attributes.position,u=e.index,d=Ze.getPrimitive(),A=Ze.getPrimitive();let f=BE,g=xE,m=null,E=null;i&&(m=vE,E=LE);let p=1/0,I=null,C=null;return $i.copy(t).invert(),Vs.matrix.copy($i),o.shapecast({boundsTraverseOrder:T=>cr.distanceToBox(T),intersectsBounds:(T,L,S)=>S<p&&S<r?(L&&(Vs.min.copy(T.min),Vs.max.copy(T.max),Vs.needsUpdate=!0),!0):!1,intersectsRange:(T,L)=>{if(e.boundsTree){const S=e.boundsTree;return S.shapecast({boundsTraverseOrder:x=>Vs.distanceToBox(x),intersectsBounds:(x,v,B)=>B<p&&B<r,intersectsRange:(x,v)=>{for(let B=x,R=x+v;B<R;B++){const D=S.resolveTriangleIndex(B);me(A,3*D,u,h),A.a.applyMatrix4(t),A.b.applyMatrix4(t),A.c.applyMatrix4(t),A.needsUpdate=!0;for(let b=T,w=T+L;b<w;b++){const F=o.resolveTriangleIndex(b);me(d,3*F,l,c),d.needsUpdate=!0;const P=d.distanceToTriangle(A,f,m);if(P<p&&(g.copy(f),E&&E.copy(m),p=P,I=b,C=B),P<n)return!0}}}})}else{const S=Bn(e);for(let x=0,v=S;x<v;x++){me(A,3*x,u,h),A.a.applyMatrix4(t),A.b.applyMatrix4(t),A.c.applyMatrix4(t),A.needsUpdate=!0;for(let B=T,R=T+L;B<R;B++){const D=o.resolveTriangleIndex(B);me(d,3*D,l,c),d.needsUpdate=!0;const b=d.distanceToTriangle(A,f,m);if(b<p&&(g.copy(f),E&&E.copy(m),p=b,I=B,C=x),b<n)return!0}}}}}),Ze.releasePrimitive(d),Ze.releasePrimitive(A),p===1/0?null:(s.point?s.point.copy(g):s.point=g.clone(),s.distance=p,s.faceIndex=I,i&&(i.point?i.point.copy(E):i.point=E.clone(),i.point.applyMatrix4($i),g.applyMatrix4($i),i.distance=g.sub(i.point).length(),i.faceIndex=C),s)}function ec(o,e,t){return o===null?null:(o.point.applyMatrix4(e.matrixWorld),o.distance=o.point.distanceTo(t.ray.origin),o.object=e,o)}const Vi=new Qe,Yi=new od,tc=new N,sc=new Me,ic=new N,hr=["getX","getY","getZ"];class fi extends j0{static serialize(e,t={}){t={cloneBuffers:!0,...t};const s=e.geometry,i=e._roots,n=e._indirectBuffer,r=s.getIndex(),a={version:1,roots:null,index:null,indirectBuffer:null};return t.cloneBuffers?(a.roots=i.map(c=>c.slice()),a.index=r?r.array.slice():null,a.indirectBuffer=n?n.slice():null):(a.roots=i,a.index=r?r.array:null,a.indirectBuffer=n),a}static deserialize(e,t,s={}){s={setIndex:!0,indirect:!!e.indirectBuffer,...s};const{index:i,roots:n,indirectBuffer:r}=e;e.version||(console.warn("MeshBVH.deserialize: Serialization format has been changed and will be fixed up. It is recommended to regenerate any stored serialized data."),c(n));const a=new fi(t,{...s,[Yo]:!0});if(a._roots=n,a._indirectBuffer=r||null,s.setIndex){const l=t.getIndex();if(l===null){const h=new et(e.index,1,!1);t.setIndex(h)}else l.array!==i&&(l.array.set(i),l.needsUpdate=!0)}return a;function c(l){for(let h=0;h<l.length;h++){const u=l[h],d=new Uint32Array(u),A=new Uint16Array(u);for(let f=0,g=u.byteLength/we;f<g;f++){const m=ye*f,E=2*m;Ce(E,A)||(d[m+6]=d[m+6]/ye-f)}}}}get primitiveStride(){return 3}get resolveTriangleIndex(){return this.resolvePrimitiveIndex}constructor(e,t={}){t.maxLeafTris&&(console.warn('MeshBVH: "maxLeafTris" option has been deprecated. Use maxLeafSize, instead.'),t={...t,maxLeafSize:t.maxLeafTris}),super(e,t)}shiftTriangleOffsets(e){return super.shiftPrimitiveOffsets(e)}writePrimitiveBounds(e,t,s){const i=this.geometry,n=this._indirectBuffer,r=i.attributes.position,a=i.index?i.index.array:null,l=(n?n[e]:e)*3;let h=l+0,u=l+1,d=l+2;a&&(h=a[h],u=a[u],d=a[d]);for(let A=0;A<3;A++){const f=r[hr[A]](h),g=r[hr[A]](u),m=r[hr[A]](d);let E=f;g<E&&(E=g),m<E&&(E=m);let p=f;g>p&&(p=g),m>p&&(p=m),t[s+A]=E,t[s+A+3]=p}return t}computePrimitiveBounds(e,t,s){const i=this.geometry,n=this._indirectBuffer,r=i.attributes.position,a=i.index?i.index.array:null,c=r.normalized;if(e<0||t+e-s.offset>s.length/6)throw new Error("MeshBVH: compute triangle bounds range is invalid.");const l=r.array,h=r.offset||0;let u=3;r.isInterleavedBufferAttribute&&(u=r.data.stride);const d=["getX","getY","getZ"],A=s.offset;for(let f=e,g=e+t;f<g;f++){const E=(n?n[f]:f)*3,p=(f-A)*6;let I=E+0,C=E+1,T=E+2;a&&(I=a[I],C=a[C],T=a[T]),c||(I=I*u+h,C=C*u+h,T=T*u+h);for(let L=0;L<3;L++){let S,x,v;c?(S=r[d[L]](I),x=r[d[L]](C),v=r[d[L]](T)):(S=l[I+L],x=l[C+L],v=l[T+L]);let B=S;x<B&&(B=x),v<B&&(B=v);let R=S;x>R&&(R=x),v>R&&(R=v);const D=(R-B)/2,b=L*2;s[p+b+0]=B+D,s[p+b+1]=D+(Math.abs(B)+D)*rn}}return s}raycastObject3D(e,t,s=[]){const{material:i}=e;if(i===void 0)return;sc.copy(e.matrixWorld).invert(),Yi.copy(t.ray).applyMatrix4(sc),ic.setFromMatrixScale(e.matrixWorld),tc.copy(Yi.direction).multiply(ic);const n=tc.length(),r=t.near/n,a=t.far/n;if(t.firstHitOnly===!0){let c=this.raycastFirst(Yi,i,r,a);c=ec(c,e,t),c&&s.push(c)}else{const c=this.raycast(Yi,i,r,a);for(let l=0,h=c.length;l<h;l++){const u=ec(c[l],e,t);u&&s.push(u)}}return s}refit(e=null){return(this.indirect?IE:oE)(this,e)}raycast(e,t=Sr,s=0,i=1/0){const n=this._roots,r=[],a=this.indirect?yE:hE;for(let c=0,l=n.length;c<l;c++)a(this,c,t,e,r,s,i);return r}raycastFirst(e,t=Sr,s=0,i=1/0){const n=this._roots;let r=null;const a=this.indirect?TE:dE;for(let c=0,l=n.length;c<l;c++){const h=a(this,c,t,e,s,i);h!=null&&(r==null||h.distance<r.distance)&&(r=h)}return r}intersectsGeometry(e,t){let s=!1;const i=this._roots,n=this.indirect?SE:AE;for(let r=0,a=i.length;r<a&&(s=n(this,r,e,t),!s);r++);return s}shapecast(e){const t=Ze.getPrimitive(),s=super.shapecast({...e,intersectsPrimitive:e.intersectsTriangle,scratchPrimitive:t,iterate:this.indirect?cE:rE});return Ze.releasePrimitive(t),s}bvhcast(e,t,s){let{intersectsRanges:i,intersectsTriangles:n}=s;const r=Ze.getPrimitive(),a=this.geometry.index,c=this.geometry.attributes.position,l=this.indirect?f=>{const g=this.resolveTriangleIndex(f);me(r,g*3,a,c)}:f=>{me(r,f*3,a,c)},h=Ze.getPrimitive(),u=e.geometry.index,d=e.geometry.attributes.position,A=e.indirect?f=>{const g=e.resolveTriangleIndex(f);me(h,g*3,u,d)}:f=>{me(h,f*3,u,d)};if(n){if(!(e instanceof fi))throw new Error('MeshBVH: "intersectsTriangles" callback can only be used with another MeshBVH.');const f=(g,m,E,p,I,C,T,L)=>{for(let S=E,x=E+p;S<x;S++){A(S),h.a.applyMatrix4(t),h.b.applyMatrix4(t),h.c.applyMatrix4(t),h.needsUpdate=!0;for(let v=g,B=g+m;v<B;v++)if(l(v),r.needsUpdate=!0,n(r,h,v,S,I,C,T,L))return!0}return!1};if(i){const g=i;i=function(m,E,p,I,C,T,L,S){return g(m,E,p,I,C,T,L,S)?!0:f(m,E,p,I,C,T,L,S)}}else i=f}return super.bvhcast(e,t,{intersectsRanges:i})}intersectsBox(e,t){return Vi.set(e.min,e.max,t),Vi.needsUpdate=!0,this.shapecast({intersectsBounds:s=>Vi.intersectsBox(s),intersectsTriangle:s=>Vi.intersectsTriangle(s)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,s={},i={},n=0,r=1/0){return(this.indirect?RE:EE)(this,e,t,s,i,n,r)}closestPointToPoint(e,t={},s=0,i=1/0){return eE(this,e,t,s,i)}}const nc=new Ye,rc=new Me,ur=new N;class DE extends fo{get isMesh(){return!this.displayEdges}get isLineSegments(){return this.displayEdges}get isLine(){return this.displayEdges}getVertexPosition(...e){return $t.prototype.getVertexPosition.call(this,...e)}constructor(e,t,s=10,i=0){super(),this.material=t,this.geometry=new oi,this.name="BVHRootHelper",this.depth=s,this.displayParents=!1,this.bvh=e,this.displayEdges=!0,this._group=i}raycast(){}update(){const e=this.bvh;this.geometry.dispose(),this.visible=!1,e&&(this.geometry=this.getGeometry(e),this.visible=!0)}getGeometry(e){const t=this._group;let s=null;if(t!==-1)s=this.getBVHBoundPositions(e,t);else{const r=e._roots.map((l,h)=>this.getBVHBoundPositions(e,h)),a=r.reduce((l,h)=>l+h.length,0);s=new Float32Array(a);let c=0;r.forEach(l=>{s.set(l,c),c+=l.length})}const i=this.getBVHBoundIndices(s),n=new oi;return n.setIndex(new et(i,1,!1)),n.setAttribute("position",new et(s,3,!1)),n}getBVHBoundIndices(e){const t=e.length/24;let s,i;this.displayEdges?i=new Uint8Array([0,4,1,5,2,6,3,7,0,2,1,3,4,6,5,7,0,1,2,3,4,5,6,7]):i=new Uint8Array([0,1,2,2,1,3,4,6,5,6,7,5,1,4,5,0,4,1,2,3,6,3,7,6,0,2,4,2,6,4,1,5,3,3,5,7]),e.length>65535?s=new Uint32Array(i.length*t):s=new Uint16Array(i.length*t);const n=i.length;for(let r=0;r<t;r++){const a=r*8,c=r*n;for(let l=0;l<n;l++)s[c+l]=a+i[l]}return s}getBVHBoundPositions(e,t=0,s=null){const i=this.depth-1,n=this.displayParents;let r=0;e.traverse((l,h)=>{if(l>=i||h)return r++,!0;n&&r++},t);let a=0;const c=new Float32Array(24*r);return e.traverse((l,h,u)=>{const d=l>=i||h;if(d||n){ue(0,u,nc);const{min:A,max:f}=nc;for(let g=-1;g<=1;g+=2){const m=g<0?A.x:f.x;for(let E=-1;E<=1;E+=2){const p=E<0?A.y:f.y;for(let I=-1;I<=1;I+=2){const C=I<0?A.z:f.z;ur.set(m,p,C),s&&ur.applyMatrix4(s),ur.toArray(c,a),a+=3}}}return d}},t),c}}class Xo extends Wi{get color(){return this.edgeMaterial.color}get opacity(){return this.edgeMaterial.opacity}set opacity(e){this.edgeMaterial.opacity=e,this.meshMaterial.opacity=e}get objectIndex(){return console.warn('BVHHelper: "objectIndex" has been renamed "instanceId".'),this.instanceId}set objectIndex(e){console.warn('BVHHelper: "objectIndex" has been renamed "instanceId".'),this.instanceId=e}constructor(e=null,t=null,s=10){e instanceof fi&&(s=t||10,t=e,e=null),typeof t=="number"&&(s=t,t=null),super(),this.name="BVHHelper",this.depth=s,this.mesh=e,this.bvh=t,this.displayParents=!1,this.displayEdges=!0,this.instanceId=0,this._roots=[];const i=new Ec({color:65416,transparent:!0,opacity:.3,depthWrite:!1}),n=new is({color:65416,transparent:!0,opacity:.3,depthWrite:!1});n.color=i.color,this.edgeMaterial=i,this.meshMaterial=n,this.update()}update(){const e=this.mesh,t=this.instanceId;let s=this.bvh||e.geometry.boundsTree||null;if(e&&e.isBatchedMesh&&e.boundsTrees&&!s&&t>=0){const n=e._drawInfo[t];n&&(s=e.boundsTrees[n.geometryIndex]||s)}const i=s?s._roots.length:0;for(;this._roots.length>i;){const n=this._roots.pop();n.geometry.dispose(),this.remove(n)}for(let n=0;n<i;n++){const{depth:r,edgeMaterial:a,meshMaterial:c,displayParents:l,displayEdges:h}=this;if(n>=this._roots.length){const d=new DE(s,a,r,n);this.add(d),this._roots.push(d)}const u=this._roots[n];u.bvh=s,u.depth=r,u.displayParents=l,u.displayEdges=h,u.material=h?a:c,u.update()}}updateMatrixWorld(...e){const t=this.mesh,s=this.parent,i=this.instanceId;t!==null&&(t.updateWorldMatrix(!0,!1),s?this.matrix.copy(s.matrixWorld).invert().multiply(t.matrixWorld):this.matrix.copy(t.matrixWorld),(t.isInstancedMesh||t.isBatchedMesh)&&i>=0&&(t.getMatrixAt(i,rc),this.matrix.multiply(rc)),this.matrix.decompose(this.position,this.quaternion,this.scale)),super.updateMatrixWorld(...e)}copy(e){this.depth=e.depth,this.mesh=e.mesh,this.bvh=e.bvh,this.opacity=e.opacity,this.color.copy(e.color)}clone(){return new Xo().copy(this)}dispose(){this.edgeMaterial.dispose(),this.meshMaterial.dispose();const e=this.children;for(let t=0,s=e.length;t<s;t++)e[t].geometry.dispose()}}class bE extends Xo{constructor(...e){console.warn("MeshBVHHelper: Class has been deprecated. Use BVHHelper instead."),super(...e)}}const Ss={Mesh:$t.prototype.raycast,Line:po.prototype.raycast,LineSegments:go.prototype.raycast,LineLoop:mo.prototype.raycast,Points:Eo.prototype.raycast,BatchedMesh:ad.prototype.raycast},ve=new $t,qi=[];function wE(o,e){if(this.isBatchedMesh)_E.call(this,o,e);else{const{geometry:t}=this;if(t.boundsTree)t.boundsTree.raycastObject3D(this,o,e);else{let s;if(this instanceof $t)s=Ss.Mesh;else if(this instanceof go)s=Ss.LineSegments;else if(this instanceof mo)s=Ss.LineLoop;else if(this instanceof po)s=Ss.Line;else if(this instanceof Eo)s=Ss.Points;else throw new Error("BVH: Fallback raycast function not found.");s.call(this,o,e)}}}function _E(o,e){if(this.boundsTrees){const t=this.boundsTrees,s=this._drawInfo||this._instanceInfo,i=this._drawRanges||this._geometryInfo,n=this.matrixWorld;ve.material=this.material,ve.geometry=this.geometry;const r=ve.geometry.boundsTree,a=ve.geometry.drawRange;ve.geometry.boundingSphere===null&&(ve.geometry.boundingSphere=new Ic);for(let c=0,l=s.length;c<l;c++){if(!this.getVisibleAt(c))continue;const h=s[c].geometryIndex;if(ve.geometry.boundsTree=t[h],this.getMatrixAt(c,ve.matrixWorld).premultiply(n),!ve.geometry.boundsTree){this.getBoundingBoxAt(h,ve.geometry.boundingBox),this.getBoundingSphereAt(h,ve.geometry.boundingSphere);const u=i[h];ve.geometry.setDrawRange(u.start,u.count)}ve.raycast(o,qi);for(let u=0,d=qi.length;u<d;u++){const A=qi[u];A.object=this,A.batchId=c,e.push(A)}qi.length=0}ve.geometry.boundsTree=r,ve.geometry.drawRange=a,ve.material=null,ve.geometry=null}else Ss.BatchedMesh.call(this,o,e)}const Ys=new N;function Je(o,e,t,s,i,n){const r=2*Math.PI*i/4,a=Math.max(n-2*i,0),c=Math.PI/4;Ys.copy(e),Ys[s]=0,Ys.normalize();const l=.5*r/(r+a),h=1-Ys.angleTo(o)/c;return Math.sign(Ys[t])===1?h*l:a/(r+a)+l+l*(1-h)}class zo extends ld{constructor(e=1,t=1,s=1,i=2,n=.1){const r=i*2+1;if(n=Math.min(e/2,t/2,s/2,n),super(1,1,1,r,r,r),this.type="RoundedBoxGeometry",this.parameters={width:e,height:t,depth:s,segments:i,radius:n},r===1)return;const a=this.toNonIndexed();this.index=null,this.attributes.position=a.attributes.position,this.attributes.normal=a.attributes.normal,this.attributes.uv=a.attributes.uv;const c=new N,l=new N,h=new N(e,t,s).divideScalar(2).subScalar(n),u=this.attributes.position.array,d=this.attributes.normal.array,A=this.attributes.uv.array,f=u.length/6,g=new N,m=.5/r;for(let E=0,p=0;E<u.length;E+=3,p+=2)switch(c.fromArray(u,E),l.copy(c),l.x-=Math.sign(l.x)*m,l.y-=Math.sign(l.y)*m,l.z-=Math.sign(l.z)*m,l.normalize(),u[E+0]=h.x*Math.sign(c.x)+l.x*n,u[E+1]=h.y*Math.sign(c.y)+l.y*n,u[E+2]=h.z*Math.sign(c.z)+l.z*n,d[E+0]=l.x,d[E+1]=l.y,d[E+2]=l.z,Math.floor(E/f)){case 0:g.set(1,0,0),A[p+0]=Je(g,l,"z","y",n,s),A[p+1]=1-Je(g,l,"y","z",n,t);break;case 1:g.set(-1,0,0),A[p+0]=1-Je(g,l,"z","y",n,s),A[p+1]=1-Je(g,l,"y","z",n,t);break;case 2:g.set(0,1,0),A[p+0]=1-Je(g,l,"x","z",n,e),A[p+1]=Je(g,l,"z","x",n,s);break;case 3:g.set(0,-1,0),A[p+0]=1-Je(g,l,"x","z",n,e),A[p+1]=1-Je(g,l,"z","x",n,s);break;case 4:g.set(0,0,1),A[p+0]=1-Je(g,l,"x","y",n,e),A[p+1]=1-Je(g,l,"y","x",n,t);break;case 5:g.set(0,0,-1),A[p+0]=Je(g,l,"x","y",n,e),A[p+1]=1-Je(g,l,"y","x",n,t);break}}static fromJSON(e){return new zo(e.width,e.height,e.depth,e.segments,e.radius)}}const dr=new WeakMap;let kE=class extends yc{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,s,i){const n=new ln(this.manager);n.setPath(this.path),n.setResponseType("arraybuffer"),n.setRequestHeader(this.requestHeader),n.setWithCredentials(this.withCredentials),n.load(e,r=>{this.parse(r,t,i)},s,i)}parse(e,t,s=()=>{}){this.decodeDracoFile(e,t,null,null,Gt,s).catch(s)}decodeDracoFile(e,t,s,i,n=It,r=()=>{}){const a={attributeIDs:s||this.defaultAttributeIDs,attributeTypes:i||this.defaultAttributeTypes,useUniqueIDs:!!s,vertexColorSpace:n};return this.decodeGeometry(e,a).then(t).catch(r)}decodeGeometry(e,t){const s=JSON.stringify(t);if(dr.has(e)){const c=dr.get(e);if(c.key===s)return c.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let i;const n=this.workerNextTaskID++,r=e.byteLength,a=this._getWorker(n,r).then(c=>(i=c,new Promise((l,h)=>{i._callbacks[n]={resolve:l,reject:h},i.postMessage({type:"decode",id:n,taskConfig:t,buffer:e},[e])}))).then(c=>this._createGeometry(c.geometry));return a.catch(()=>!0).then(()=>{i&&n&&this._releaseTask(i,n)}),dr.set(e,{key:s,promise:a}),a}_createGeometry(e){const t=new oi;e.index&&t.setIndex(new et(e.index.array,1));for(let s=0;s<e.attributes.length;s++){const{name:i,array:n,itemSize:r,stride:a,vertexColorSpace:c}=e.attributes[s];let l;if(r===a)l=new et(n,r);else{const h=new Cc(n,a);l=new Tc(h,r,0)}i==="color"&&(this._assignVertexColorSpace(l,c),l.normalized=!(n instanceof Float32Array)),t.setAttribute(i,l)}return t}_assignVertexColorSpace(e,t){if(t!==Gt)return;const s=new wt;for(let i=0,n=e.count;i<n;i++)s.fromBufferAttribute(e,i),Br.colorSpaceToWorking(s,Gt),e.setXYZ(i,s.r,s.g,s.b)}_loadLibrary(e,t){const s=new ln(this.manager);return s.setPath(this.decoderPath),s.setResponseType(t),s.setWithCredentials(this.withCredentials),new Promise((i,n)=>{s.load(e,i,void 0,n)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(s=>{const i=s[0];e||(this.decoderConfig.wasmBinary=s[1]);const n=PE.toString(),r=["/* draco decoder */",i,"","/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([r]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const i=new Worker(this.workerSourceURL);i._callbacks={},i._taskCosts={},i._taskLoad=0,i.postMessage({type:"init",decoderConfig:this.decoderConfig}),i.onmessage=function(n){const r=n.data;switch(r.type){case"decode":i._callbacks[r.id].resolve(r);break;case"error":i._callbacks[r.id].reject(r);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+r.type+'"')}},this.workerPool.push(i)}else this.workerPool.sort(function(i,n){return i._taskLoad>n._taskLoad?-1:1});const s=this.workerPool[this.workerPool.length-1];return s._taskCosts[e]=t,s._taskLoad+=t,s})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}};function PE(){let o,e;onmessage=function(r){const a=r.data;switch(a.type){case"init":o=a.decoderConfig,e=new Promise(function(h){o.onModuleLoaded=function(u){h({draco:u})},DracoDecoderModule(o)});break;case"decode":const c=a.buffer,l=a.taskConfig;e.then(h=>{const u=h.draco,d=new u.Decoder;try{const A=t(u,d,new Int8Array(c),l),f=A.attributes.map(g=>g.array.buffer);A.index&&f.push(A.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:A},f)}catch(A){console.error(A),self.postMessage({type:"error",id:a.id,error:A.message})}finally{u.destroy(d)}});break}};function t(r,a,c,l){const h=l.attributeIDs,u=l.attributeTypes;let d,A;const f=a.GetEncodedGeometryType(c);if(f===r.TRIANGULAR_MESH)d=new r.Mesh,A=a.DecodeArrayToMesh(c,c.byteLength,d);else if(f===r.POINT_CLOUD)d=new r.PointCloud,A=a.DecodeArrayToPointCloud(c,c.byteLength,d);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!A.ok()||d.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+A.error_msg());const g={index:null,attributes:[]};for(const m in h){const E=self[u[m]];let p,I;if(l.useUniqueIDs)I=h[m],p=a.GetAttributeByUniqueId(d,I);else{if(I=a.GetAttributeId(d,r[h[m]]),I===-1)continue;p=a.GetAttribute(d,I)}const C=i(r,a,d,m,E,p);m==="color"&&(C.vertexColorSpace=l.vertexColorSpace),g.attributes.push(C)}return f===r.TRIANGULAR_MESH&&(g.index=s(r,a,d)),r.destroy(d),g}function s(r,a,c){const h=c.num_faces()*3,u=h*4,d=r._malloc(u);a.GetTrianglesUInt32Array(c,u,d);const A=new Uint32Array(r.HEAPF32.buffer,d,h).slice();return r._free(d),{array:A,itemSize:1}}function i(r,a,c,l,h,u){const d=c.num_points(),A=u.num_components(),f=n(r,h),g=A*h.BYTES_PER_ELEMENT,m=Math.ceil(g/4)*4,E=m/h.BYTES_PER_ELEMENT,p=d*g,I=d*m,C=r._malloc(p);a.GetAttributeDataArrayForAllPoints(c,u,f,p,C);const T=new h(r.HEAPF32.buffer,C,p/h.BYTES_PER_ELEMENT);let L;if(g===m)L=T.slice();else{L=new h(I/h.BYTES_PER_ELEMENT);let S=0;for(let x=0,v=T.length;x<v;x++){for(let B=0;B<A;B++)L[S+B]=T[x*A+B];S+=E}}return r._free(C),{name:l,count:d,itemSize:A,array:L,stride:E}}function n(r,a){switch(a){case Float32Array:return r.DT_FLOAT32;case Int8Array:return r.DT_INT8;case Int16Array:return r.DT_INT16;case Int32Array:return r.DT_INT32;case Uint8Array:return r.DT_UINT8;case Uint16Array:return r.DT_UINT16;case Uint32Array:return r.DT_UINT32}}}function FE(o,e=!1){const t=o[0].index!==null,s=new Set(Object.keys(o[0].attributes)),i=new Set(Object.keys(o[0].morphAttributes)),n={},r={},a=o[0].morphTargetsRelative,c=new oi;let l=0;for(let h=0;h<o.length;++h){const u=o[h];let d=0;if(t!==(u.index!==null))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+h+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const A in u.attributes){if(!s.has(A))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+h+'. All geometries must have compatible attributes; make sure "'+A+'" attribute exists among all geometries, or in none of them.'),null;n[A]===void 0&&(n[A]=[]),n[A].push(u.attributes[A]),d++}if(d!==s.size)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+h+". Make sure all geometries have the same number of attributes."),null;if(a!==u.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+h+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const A in u.morphAttributes){if(!i.has(A))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+h+".  .morphAttributes must be consistent throughout all geometries."),null;r[A]===void 0&&(r[A]=[]),r[A].push(u.morphAttributes[A])}if(e){let A;if(t)A=u.index.count;else if(u.attributes.position!==void 0)A=u.attributes.position.count;else return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+h+". The geometry must have either an index or a position attribute"),null;c.addGroup(l,A,h),l+=A}}if(t){let h=0;const u=[];for(let d=0;d<o.length;++d){const A=o[d].index;for(let f=0;f<A.count;++f)u.push(A.getX(f)+h);h+=o[d].attributes.position.count}c.setIndex(u)}for(const h in n){const u=oc(n[h]);if(!u)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+h+" attribute."),null;c.setAttribute(h,u)}for(const h in r){const u=r[h][0].length;if(u===0)break;c.morphAttributes=c.morphAttributes||{},c.morphAttributes[h]=[];for(let d=0;d<u;++d){const A=[];for(let g=0;g<r[h].length;++g)A.push(r[h][g][d]);const f=oc(A);if(!f)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+h+" morphAttribute."),null;c.morphAttributes[h].push(f)}}return c}function oc(o){let e,t,s,i=-1,n=0;for(let l=0;l<o.length;++l){const h=o[l];if(e===void 0&&(e=h.array.constructor),e!==h.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(t===void 0&&(t=h.itemSize),t!==h.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(s===void 0&&(s=h.normalized),s!==h.normalized)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;if(i===-1&&(i=h.gpuType),i!==h.gpuType)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes."),null;n+=h.count*t}const r=new e(n),a=new et(r,t,s);let c=0;for(let l=0;l<o.length;++l){const h=o[l];if(h.isInterleavedBufferAttribute){const u=c/t;for(let d=0,A=h.count;d<A;d++)for(let f=0;f<t;f++){const g=h.getComponent(d,f);a.setComponent(d+u,f,g)}}else r.set(h.array,c);c+=h.count*t}return i!==void 0&&(a.gpuType=i),a}function ac(o,e){if(e===cd)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),o;if(e===xr||e===Sc){let t=o.getIndex();if(t===null){const r=[],a=o.getAttribute("position");if(a!==void 0){for(let c=0;c<a.count;c++)r.push(c);o.setIndex(r),t=o.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),o}const s=t.count-2,i=[];if(e===xr)for(let r=1;r<=s;r++)i.push(t.getX(0)),i.push(t.getX(r)),i.push(t.getX(r+1));else for(let r=0;r<s;r++)r%2===0?(i.push(t.getX(r)),i.push(t.getX(r+1)),i.push(t.getX(r+2))):(i.push(t.getX(r+2)),i.push(t.getX(r+1)),i.push(t.getX(r)));i.length/3!==s&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const n=o.clone();return n.setIndex(i),n.clearGroups(),n}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),o}class ME extends yc{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new GE(t)}),this.register(function(t){return new HE(t)}),this.register(function(t){return new XE(t)}),this.register(function(t){return new zE(t)}),this.register(function(t){return new ZE(t)}),this.register(function(t){return new $E(t)}),this.register(function(t){return new VE(t)}),this.register(function(t){return new YE(t)}),this.register(function(t){return new qE(t)}),this.register(function(t){return new UE(t)}),this.register(function(t){return new WE(t)}),this.register(function(t){return new KE(t)}),this.register(function(t){return new JE(t)}),this.register(function(t){return new jE(t)}),this.register(function(t){return new OE(t)}),this.register(function(t){return new eI(t)}),this.register(function(t){return new tI(t)})}load(e,t,s,i){const n=this;let r;if(this.resourcePath!=="")r=this.resourcePath;else if(this.path!==""){const l=zs.extractUrlBase(e);r=zs.resolveURL(l,this.path)}else r=zs.extractUrlBase(e);this.manager.itemStart(e);const a=function(l){i?i(l):console.error(l),n.manager.itemError(e),n.manager.itemEnd(e)},c=new ln(this.manager);c.setPath(this.path),c.setResponseType("arraybuffer"),c.setRequestHeader(this.requestHeader),c.setWithCredentials(this.withCredentials),c.load(e,function(l){try{n.parse(l,r,function(h){t(h),n.manager.itemEnd(e)},a)}catch(h){a(h)}},s,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,i){let n;const r={},a={},c=new TextDecoder;if(typeof e=="string")n=JSON.parse(e);else if(e instanceof ArrayBuffer)if(c.decode(new Uint8Array(e,0,4))===Eu){try{r[te.KHR_BINARY_GLTF]=new sI(e)}catch(u){i&&i(u);return}n=JSON.parse(r[te.KHR_BINARY_GLTF].content)}else n=JSON.parse(c.decode(e));else n=e;if(n.asset===void 0||n.asset.version[0]<2){i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const l=new gI(n,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){const u=this.pluginCallbacks[h](l);u.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[u.name]=u,r[u.name]=!0}if(n.extensionsUsed)for(let h=0;h<n.extensionsUsed.length;++h){const u=n.extensionsUsed[h],d=n.extensionsRequired||[];switch(u){case te.KHR_MATERIALS_UNLIT:r[u]=new NE;break;case te.KHR_DRACO_MESH_COMPRESSION:r[u]=new iI(n,this.dracoLoader);break;case te.KHR_TEXTURE_TRANSFORM:r[u]=new nI;break;case te.KHR_MESH_QUANTIZATION:r[u]=new rI;break;default:d.indexOf(u)>=0&&a[u]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+u+'".')}}l.setExtensions(r),l.setPlugins(a),l.parse(s,i)}parseAsync(e,t){const s=this;return new Promise(function(i,n){s.parse(e,t,i,n)})}}function QE(){let o={};return{get:function(e){return o[e]},add:function(e,t){o[e]=t},remove:function(e){delete o[e]},removeAll:function(){o={}}}}const te={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class OE{constructor(e){this.parser=e,this.name=te.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,i=t.length;s<i;s++){const n=t[s];n.extensions&&n.extensions[this.name]&&n.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let i=t.cache.get(s);if(i)return i;const n=t.json,c=((n.extensions&&n.extensions[this.name]||{}).lights||[])[e];let l;const h=new wt(16777215);c.color!==void 0&&h.setRGB(c.color[0],c.color[1],c.color[2],It);const u=c.range!==void 0?c.range:0;switch(c.type){case"directional":l=new dd(h),l.target.position.set(0,0,-1),l.add(l.target);break;case"point":l=new ud(h),l.distance=u;break;case"spot":l=new hd(h),l.distance=u,c.spot=c.spot||{},c.spot.innerConeAngle=c.spot.innerConeAngle!==void 0?c.spot.innerConeAngle:0,c.spot.outerConeAngle=c.spot.outerConeAngle!==void 0?c.spot.outerConeAngle:Math.PI/4,l.angle=c.spot.outerConeAngle,l.penumbra=1-c.spot.innerConeAngle/c.spot.outerConeAngle,l.target.position.set(0,0,-1),l.add(l.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+c.type)}return l.position.set(0,0,0),At(l,c),c.intensity!==void 0&&(l.intensity=c.intensity),l.name=t.createUniqueName(c.name||"light_"+e),i=Promise.resolve(l),t.cache.add(s,i),i}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,n=s.json.nodes[e],a=(n.extensions&&n.extensions[this.name]||{}).light;return a===void 0?null:this._loadLight(a).then(function(c){return s._getNodeRef(t.cache,a,c)})}}class NE{constructor(){this.name=te.KHR_MATERIALS_UNLIT}getMaterialType(){return is}extendParams(e,t,s){const i=[];e.color=new wt(1,1,1),e.opacity=1;const n=t.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){const r=n.baseColorFactor;e.color.setRGB(r[0],r[1],r[2],It),e.opacity=r[3]}n.baseColorTexture!==void 0&&i.push(s.assignTexture(e,"map",n.baseColorTexture,Gt))}return Promise.all(i)}}class UE{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name].emissiveStrength;return n!==void 0&&(t.emissiveIntensity=n),Promise.resolve()}}class GE{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Tt}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];if(r.clearcoatFactor!==void 0&&(t.clearcoat=r.clearcoatFactor),r.clearcoatTexture!==void 0&&n.push(s.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),r.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),r.clearcoatRoughnessTexture!==void 0&&n.push(s.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),r.clearcoatNormalTexture!==void 0&&(n.push(s.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),r.clearcoatNormalTexture.scale!==void 0)){const a=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new Et(a,a)}return Promise.all(n)}}class HE{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_DISPERSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Tt}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name];return t.dispersion=n.dispersion!==void 0?n.dispersion:0,Promise.resolve()}}class KE{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Tt}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];return r.iridescenceFactor!==void 0&&(t.iridescence=r.iridescenceFactor),r.iridescenceTexture!==void 0&&n.push(s.assignTexture(t,"iridescenceMap",r.iridescenceTexture)),r.iridescenceIor!==void 0&&(t.iridescenceIOR=r.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),r.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=r.iridescenceThicknessMinimum),r.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=r.iridescenceThicknessMaximum),r.iridescenceThicknessTexture!==void 0&&n.push(s.assignTexture(t,"iridescenceThicknessMap",r.iridescenceThicknessTexture)),Promise.all(n)}}class $E{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_SHEEN}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Tt}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[];t.sheenColor=new wt(0,0,0),t.sheenRoughness=0,t.sheen=1;const r=i.extensions[this.name];if(r.sheenColorFactor!==void 0){const a=r.sheenColorFactor;t.sheenColor.setRGB(a[0],a[1],a[2],It)}return r.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=r.sheenRoughnessFactor),r.sheenColorTexture!==void 0&&n.push(s.assignTexture(t,"sheenColorMap",r.sheenColorTexture,Gt)),r.sheenRoughnessTexture!==void 0&&n.push(s.assignTexture(t,"sheenRoughnessMap",r.sheenRoughnessTexture)),Promise.all(n)}}class VE{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Tt}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];return r.transmissionFactor!==void 0&&(t.transmission=r.transmissionFactor),r.transmissionTexture!==void 0&&n.push(s.assignTexture(t,"transmissionMap",r.transmissionTexture)),Promise.all(n)}}class YE{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_VOLUME}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Tt}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];t.thickness=r.thicknessFactor!==void 0?r.thicknessFactor:0,r.thicknessTexture!==void 0&&n.push(s.assignTexture(t,"thicknessMap",r.thicknessTexture)),t.attenuationDistance=r.attenuationDistance||1/0;const a=r.attenuationColor||[1,1,1];return t.attenuationColor=new wt().setRGB(a[0],a[1],a[2],It),Promise.all(n)}}class qE{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_IOR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Tt}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name];return t.ior=n.ior!==void 0?n.ior:1.5,Promise.resolve()}}class WE{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_SPECULAR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Tt}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];t.specularIntensity=r.specularFactor!==void 0?r.specularFactor:1,r.specularTexture!==void 0&&n.push(s.assignTexture(t,"specularIntensityMap",r.specularTexture));const a=r.specularColorFactor||[1,1,1];return t.specularColor=new wt().setRGB(a[0],a[1],a[2],It),r.specularColorTexture!==void 0&&n.push(s.assignTexture(t,"specularColorMap",r.specularColorTexture,Gt)),Promise.all(n)}}class jE{constructor(e){this.parser=e,this.name=te.EXT_MATERIALS_BUMP}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Tt}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];return t.bumpScale=r.bumpFactor!==void 0?r.bumpFactor:1,r.bumpTexture!==void 0&&n.push(s.assignTexture(t,"bumpMap",r.bumpTexture)),Promise.all(n)}}class JE{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Tt}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];return r.anisotropyStrength!==void 0&&(t.anisotropy=r.anisotropyStrength),r.anisotropyRotation!==void 0&&(t.anisotropyRotation=r.anisotropyRotation),r.anisotropyTexture!==void 0&&n.push(s.assignTexture(t,"anisotropyMap",r.anisotropyTexture)),Promise.all(n)}}class XE{constructor(e){this.parser=e,this.name=te.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,i=s.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const n=i.extensions[this.name],r=t.options.ktx2Loader;if(!r){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,n.source,r)}}class zE{constructor(e){this.parser=e,this.name=te.EXT_TEXTURE_WEBP}loadTexture(e){const t=this.name,s=this.parser,i=s.json,n=i.textures[e];if(!n.extensions||!n.extensions[t])return null;const r=n.extensions[t],a=i.images[r.source];let c=s.textureLoader;if(a.uri){const l=s.options.manager.getHandler(a.uri);l!==null&&(c=l)}return s.loadTextureImage(e,r.source,c)}}class ZE{constructor(e){this.parser=e,this.name=te.EXT_TEXTURE_AVIF}loadTexture(e){const t=this.name,s=this.parser,i=s.json,n=i.textures[e];if(!n.extensions||!n.extensions[t])return null;const r=n.extensions[t],a=i.images[r.source];let c=s.textureLoader;if(a.uri){const l=s.options.manager.getHandler(a.uri);l!==null&&(c=l)}return s.loadTextureImage(e,r.source,c)}}class eI{constructor(e){this.name=te.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const i=s.extensions[this.name],n=this.parser.getDependency("buffer",i.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then(function(a){const c=i.byteOffset||0,l=i.byteLength||0,h=i.count,u=i.byteStride,d=new Uint8Array(a,c,l);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(h,u,d,i.mode,i.filter).then(function(A){return A.buffer}):r.ready.then(function(){const A=new ArrayBuffer(h*u);return r.decodeGltfBuffer(new Uint8Array(A),h,u,d,i.mode,i.filter),A})})}else return null}}class tI{constructor(e){this.name=te.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||s.mesh===void 0)return null;const i=t.meshes[s.mesh];for(const l of i.primitives)if(l.mode!==Xe.TRIANGLES&&l.mode!==Xe.TRIANGLE_STRIP&&l.mode!==Xe.TRIANGLE_FAN&&l.mode!==void 0)return null;const r=s.extensions[this.name].attributes,a=[],c={};for(const l in r)a.push(this.parser.getDependency("accessor",r[l]).then(h=>(c[l]=h,c[l])));return a.length<1?null:(a.push(this.parser.createNodeMesh(e)),Promise.all(a).then(l=>{const h=l.pop(),u=h.isGroup?h.children:[h],d=l[0].count,A=[];for(const f of u){const g=new Me,m=new N,E=new Io,p=new N(1,1,1),I=new Ad(f.geometry,f.material,d);for(let C=0;C<d;C++)c.TRANSLATION&&m.fromBufferAttribute(c.TRANSLATION,C),c.ROTATION&&E.fromBufferAttribute(c.ROTATION,C),c.SCALE&&p.fromBufferAttribute(c.SCALE,C),I.setMatrixAt(C,g.compose(m,E,p));for(const C in c)if(C==="_COLOR_0"){const T=c[C];I.instanceColor=new fd(T.array,T.itemSize,T.normalized)}else C!=="TRANSLATION"&&C!=="ROTATION"&&C!=="SCALE"&&f.geometry.setAttribute(C,c[C]);fo.prototype.copy.call(I,f),this.parser.assignFinalMaterial(I),A.push(I)}return h.isGroup?(h.clear(),h.add(...A),h):A[0]}))}}const Eu="glTF",qs=12,lc={JSON:1313821514,BIN:5130562};class sI{constructor(e){this.name=te.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,qs),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Eu)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-qs,n=new DataView(e,qs);let r=0;for(;r<i;){const a=n.getUint32(r,!0);r+=4;const c=n.getUint32(r,!0);if(r+=4,c===lc.JSON){const l=new Uint8Array(e,qs+r,a);this.content=s.decode(l)}else if(c===lc.BIN){const l=qs+r;this.body=e.slice(l,l+a)}r+=a}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class iI{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=te.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,i=this.dracoLoader,n=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,a={},c={},l={};for(const h in r){const u=ao[h]||h.toLowerCase();a[u]=r[h]}for(const h in e.attributes){const u=ao[h]||h.toLowerCase();if(r[h]!==void 0){const d=s.accessors[e.attributes[h]],A=ws[d.componentType];l[u]=A.name,c[u]=d.normalized===!0}}return t.getDependency("bufferView",n).then(function(h){return new Promise(function(u,d){i.decodeDracoFile(h,function(A){for(const f in A.attributes){const g=A.attributes[f],m=c[f];m!==void 0&&(g.normalized=m)}u(A)},a,l,It,d)})})}}class nI{constructor(){this.name=te.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class rI{constructor(){this.name=te.KHR_MESH_QUANTIZATION}}class Iu extends wd{constructor(e,t,s,i){super(e,t,s,i)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,i=this.valueSize,n=e*i*3+i;for(let r=0;r!==i;r++)t[r]=s[n+r];return t}interpolate_(e,t,s,i){const n=this.resultBuffer,r=this.sampleValues,a=this.valueSize,c=a*2,l=a*3,h=i-t,u=(s-t)/h,d=u*u,A=d*u,f=e*l,g=f-l,m=-2*A+3*d,E=A-d,p=1-m,I=E-d+u;for(let C=0;C!==a;C++){const T=r[g+C+a],L=r[g+C+c]*h,S=r[f+C+a],x=r[f+C]*h;n[C]=p*T+I*L+m*S+E*x}return n}}const oI=new Io;class aI extends Iu{interpolate_(e,t,s,i){const n=super.interpolate_(e,t,s,i);return oI.fromArray(n).normalize().toArray(n),n}}const Xe={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},ws={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},cc={9728:xc,9729:vr,9984:Id,9985:Ed,9986:pd,9987:Bc},hc={33071:Cd,33648:yd,10497:Lr},Ar={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ao={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Mt={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},lI={CUBICSPLINE:void 0,LINEAR:Lc,STEP:bd},fr={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function cI(o){return o.DefaultMaterial===void 0&&(o.DefaultMaterial=new yo({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Sr})),o.DefaultMaterial}function ts(o,e,t){for(const s in t.extensions)o[s]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[s]=t.extensions[s])}function At(o,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(o.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function hI(o,e,t){let s=!1,i=!1,n=!1;for(let l=0,h=e.length;l<h;l++){const u=e[l];if(u.POSITION!==void 0&&(s=!0),u.NORMAL!==void 0&&(i=!0),u.COLOR_0!==void 0&&(n=!0),s&&i&&n)break}if(!s&&!i&&!n)return Promise.resolve(o);const r=[],a=[],c=[];for(let l=0,h=e.length;l<h;l++){const u=e[l];if(s){const d=u.POSITION!==void 0?t.getDependency("accessor",u.POSITION):o.attributes.position;r.push(d)}if(i){const d=u.NORMAL!==void 0?t.getDependency("accessor",u.NORMAL):o.attributes.normal;a.push(d)}if(n){const d=u.COLOR_0!==void 0?t.getDependency("accessor",u.COLOR_0):o.attributes.color;c.push(d)}}return Promise.all([Promise.all(r),Promise.all(a),Promise.all(c)]).then(function(l){const h=l[0],u=l[1],d=l[2];return s&&(o.morphAttributes.position=h),i&&(o.morphAttributes.normal=u),n&&(o.morphAttributes.color=d),o.morphTargetsRelative=!0,o})}function uI(o,e){if(o.updateMorphTargets(),e.weights!==void 0)for(let t=0,s=e.weights.length;t<s;t++)o.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(o.morphTargetInfluences.length===t.length){o.morphTargetDictionary={};for(let s=0,i=t.length;s<i;s++)o.morphTargetDictionary[t[s]]=s}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function dI(o){let e;const t=o.extensions&&o.extensions[te.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+gr(t.attributes):e=o.indices+":"+gr(o.attributes)+":"+o.mode,o.targets!==void 0)for(let s=0,i=o.targets.length;s<i;s++)e+=":"+gr(o.targets[s]);return e}function gr(o){let e="";const t=Object.keys(o).sort();for(let s=0,i=t.length;s<i;s++)e+=t[s]+":"+o[t[s]]+";";return e}function lo(o){switch(o){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function AI(o){return o.search(/\.jpe?g($|\?)/i)>0||o.search(/^data\:image\/jpeg/)===0?"image/jpeg":o.search(/\.webp($|\?)/i)>0||o.search(/^data\:image\/webp/)===0?"image/webp":o.search(/\.ktx2($|\?)/i)>0||o.search(/^data\:image\/ktx2/)===0?"image/ktx2":"image/png"}const fI=new Me;class gI{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new QE,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,i=-1,n=!1,r=-1;if(typeof navigator<"u"){const a=navigator.userAgent;s=/^((?!chrome|android).)*safari/i.test(a)===!0;const c=a.match(/Version\/(\d+)/);i=s&&c?parseInt(c[1],10):-1,n=a.indexOf("Firefox")>-1,r=n?a.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||s&&i<17||n&&r<98?this.textureLoader=new gd(this.options.manager):this.textureLoader=new md(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new ln(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,i=this.json,n=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(r){return r._markDefs&&r._markDefs()}),Promise.all(this._invokeAll(function(r){return r.beforeRoot&&r.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(r){const a={scene:r[0][i.scene||0],scenes:r[0],animations:r[1],cameras:r[2],asset:i.asset,parser:s,userData:{}};return ts(n,a,i),At(a,i),Promise.all(s._invokeAll(function(c){return c.afterRoot&&c.afterRoot(a)})).then(function(){for(const c of a.scenes)c.updateMatrixWorld();e(a)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let i=0,n=t.length;i<n;i++){const r=t[i].joints;for(let a=0,c=r.length;a<c;a++)e[r[a]].isBone=!0}for(let i=0,n=e.length;i<n;i++){const r=e[i];r.mesh!==void 0&&(this._addNodeRef(this.meshCache,r.mesh),r.skin!==void 0&&(s[r.mesh].isSkinnedMesh=!0)),r.camera!==void 0&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const i=s.clone(),n=(r,a)=>{const c=this.associations.get(r);c!=null&&this.associations.set(a,c);for(const[l,h]of r.children.entries())n(h,a.children[l])};return n(s,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const i=e(t[s]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let i=0;i<t.length;i++){const n=e(t[i]);n&&s.push(n)}return s}getDependency(e,t){const s=e+":"+t;let i=this.cache.get(s);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne(function(n){return n.loadNode&&n.loadNode(t)});break;case"mesh":i=this._invokeOne(function(n){return n.loadMesh&&n.loadMesh(t)});break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne(function(n){return n.loadBufferView&&n.loadBufferView(t)});break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne(function(n){return n.loadMaterial&&n.loadMaterial(t)});break;case"texture":i=this._invokeOne(function(n){return n.loadTexture&&n.loadTexture(t)});break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne(function(n){return n.loadAnimation&&n.loadAnimation(t)});break;case"camera":i=this.loadCamera(t);break;default:if(i=this._invokeOne(function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)}),!i)throw new Error("Unknown type: "+e);break}this.cache.add(s,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,i=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(i.map(function(n,r){return s.getDependency(e,r)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[te.KHR_BINARY_GLTF].body);const i=this.options;return new Promise(function(n,r){s.load(zs.resolveURL(t.uri,i.path),n,void 0,function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(s){const i=t.byteLength||0,n=t.byteOffset||0;return s.slice(n,n+i)})}loadAccessor(e){const t=this,s=this.json,i=this.json.accessors[e];if(i.bufferView===void 0&&i.sparse===void 0){const r=Ar[i.type],a=ws[i.componentType],c=i.normalized===!0,l=new a(i.count*r);return Promise.resolve(new et(l,r,c))}const n=[];return i.bufferView!==void 0?n.push(this.getDependency("bufferView",i.bufferView)):n.push(null),i.sparse!==void 0&&(n.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),n.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(n).then(function(r){const a=r[0],c=Ar[i.type],l=ws[i.componentType],h=l.BYTES_PER_ELEMENT,u=h*c,d=i.byteOffset||0,A=i.bufferView!==void 0?s.bufferViews[i.bufferView].byteStride:void 0,f=i.normalized===!0;let g,m;if(A&&A!==u){const E=Math.floor(d/A),p="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+E+":"+i.count;let I=t.cache.get(p);I||(g=new l(a,E*A,i.count*A/h),I=new Cc(g,A/h),t.cache.add(p,I)),m=new Tc(I,c,d%A/h,f)}else a===null?g=new l(i.count*c):g=new l(a,d,i.count*c),m=new et(g,c,f);if(i.sparse!==void 0){const E=Ar.SCALAR,p=ws[i.sparse.indices.componentType],I=i.sparse.indices.byteOffset||0,C=i.sparse.values.byteOffset||0,T=new p(r[1],I,i.sparse.count*E),L=new l(r[2],C,i.sparse.count*c);a!==null&&(m=new et(m.array.slice(),m.itemSize,m.normalized)),m.normalized=!1;for(let S=0,x=T.length;S<x;S++){const v=T[S];if(m.setX(v,L[S*c]),c>=2&&m.setY(v,L[S*c+1]),c>=3&&m.setZ(v,L[S*c+2]),c>=4&&m.setW(v,L[S*c+3]),c>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}m.normalized=f}return m})}loadTexture(e){const t=this.json,s=this.options,n=t.textures[e].source,r=t.images[n];let a=this.textureLoader;if(r.uri){const c=s.manager.getHandler(r.uri);c!==null&&(a=c)}return this.loadTextureImage(e,n,a)}loadTextureImage(e,t,s){const i=this,n=this.json,r=n.textures[e],a=n.images[t],c=(a.uri||a.bufferView)+":"+r.sampler;if(this.textureCache[c])return this.textureCache[c];const l=this.loadImageSource(t,s).then(function(h){h.flipY=!1,h.name=r.name||a.name||"",h.name===""&&typeof a.uri=="string"&&a.uri.startsWith("data:image/")===!1&&(h.name=a.uri);const d=(n.samplers||{})[r.sampler]||{};return h.magFilter=cc[d.magFilter]||vr,h.minFilter=cc[d.minFilter]||Bc,h.wrapS=hc[d.wrapS]||Lr,h.wrapT=hc[d.wrapT]||Lr,h.generateMipmaps=!h.isCompressedTexture&&h.minFilter!==xc&&h.minFilter!==vr,i.associations.set(h,{textures:e}),h}).catch(function(){return null});return this.textureCache[c]=l,l}loadImageSource(e,t){const s=this,i=this.json,n=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(u=>u.clone());const r=i.images[e],a=self.URL||self.webkitURL;let c=r.uri||"",l=!1;if(r.bufferView!==void 0)c=s.getDependency("bufferView",r.bufferView).then(function(u){l=!0;const d=new Blob([u],{type:r.mimeType});return c=a.createObjectURL(d),c});else if(r.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const h=Promise.resolve(c).then(function(u){return new Promise(function(d,A){let f=d;t.isImageBitmapLoader===!0&&(f=function(g){const m=new ra(g);m.needsUpdate=!0,d(m)}),t.load(zs.resolveURL(u,n.path),f,void 0,A)})}).then(function(u){return l===!0&&a.revokeObjectURL(c),At(u,r),u.userData.mimeType=r.mimeType||AI(r.uri),u}).catch(function(u){throw console.error("THREE.GLTFLoader: Couldn't load texture",c),u});return this.sourceCache[e]=h,h}assignTexture(e,t,s,i){const n=this;return this.getDependency("texture",s.index).then(function(r){if(!r)return null;if(s.texCoord!==void 0&&s.texCoord>0&&(r=r.clone(),r.channel=s.texCoord),n.extensions[te.KHR_TEXTURE_TRANSFORM]){const a=s.extensions!==void 0?s.extensions[te.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const c=n.associations.get(r);r=n.extensions[te.KHR_TEXTURE_TRANSFORM].extendTexture(r,a),n.associations.set(r,c)}}return i!==void 0&&(r.colorSpace=i),e[t]=r,r})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const i=t.attributes.tangent===void 0,n=t.attributes.color!==void 0,r=t.attributes.normal===void 0;if(e.isPoints){const a="PointsMaterial:"+s.uuid;let c=this.cache.get(a);c||(c=new Td,Rn.prototype.copy.call(c,s),c.color.copy(s.color),c.map=s.map,c.sizeAttenuation=!1,this.cache.add(a,c)),s=c}else if(e.isLine){const a="LineBasicMaterial:"+s.uuid;let c=this.cache.get(a);c||(c=new Ec,Rn.prototype.copy.call(c,s),c.color.copy(s.color),c.map=s.map,this.cache.add(a,c)),s=c}if(i||n||r){let a="ClonedMaterial:"+s.uuid+":";i&&(a+="derivative-tangents:"),n&&(a+="vertex-colors:"),r&&(a+="flat-shading:");let c=this.cache.get(a);c||(c=s.clone(),n&&(c.vertexColors=!0),r&&(c.flatShading=!0),i&&(c.normalScale&&(c.normalScale.y*=-1),c.clearcoatNormalScale&&(c.clearcoatNormalScale.y*=-1)),this.cache.add(a,c),this.associations.set(c,this.associations.get(s))),s=c}e.material=s}getMaterialType(){return yo}loadMaterial(e){const t=this,s=this.json,i=this.extensions,n=s.materials[e];let r;const a={},c=n.extensions||{},l=[];if(c[te.KHR_MATERIALS_UNLIT]){const u=i[te.KHR_MATERIALS_UNLIT];r=u.getMaterialType(),l.push(u.extendParams(a,n,t))}else{const u=n.pbrMetallicRoughness||{};if(a.color=new wt(1,1,1),a.opacity=1,Array.isArray(u.baseColorFactor)){const d=u.baseColorFactor;a.color.setRGB(d[0],d[1],d[2],It),a.opacity=d[3]}u.baseColorTexture!==void 0&&l.push(t.assignTexture(a,"map",u.baseColorTexture,Gt)),a.metalness=u.metallicFactor!==void 0?u.metallicFactor:1,a.roughness=u.roughnessFactor!==void 0?u.roughnessFactor:1,u.metallicRoughnessTexture!==void 0&&(l.push(t.assignTexture(a,"metalnessMap",u.metallicRoughnessTexture)),l.push(t.assignTexture(a,"roughnessMap",u.metallicRoughnessTexture))),r=this._invokeOne(function(d){return d.getMaterialType&&d.getMaterialType(e)}),l.push(Promise.all(this._invokeAll(function(d){return d.extendMaterialParams&&d.extendMaterialParams(e,a)})))}n.doubleSided===!0&&(a.side=Ao);const h=n.alphaMode||fr.OPAQUE;if(h===fr.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,h===fr.MASK&&(a.alphaTest=n.alphaCutoff!==void 0?n.alphaCutoff:.5)),n.normalTexture!==void 0&&r!==is&&(l.push(t.assignTexture(a,"normalMap",n.normalTexture)),a.normalScale=new Et(1,1),n.normalTexture.scale!==void 0)){const u=n.normalTexture.scale;a.normalScale.set(u,u)}if(n.occlusionTexture!==void 0&&r!==is&&(l.push(t.assignTexture(a,"aoMap",n.occlusionTexture)),n.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=n.occlusionTexture.strength)),n.emissiveFactor!==void 0&&r!==is){const u=n.emissiveFactor;a.emissive=new wt().setRGB(u[0],u[1],u[2],It)}return n.emissiveTexture!==void 0&&r!==is&&l.push(t.assignTexture(a,"emissiveMap",n.emissiveTexture,Gt)),Promise.all(l).then(function(){const u=new r(a);return n.name&&(u.name=n.name),At(u,n),t.associations.set(u,{materials:e}),n.extensions&&ts(i,u,n),u})}createUniqueName(e){const t=Sd.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,i=this.primitiveCache;function n(a){return s[te.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,t).then(function(c){return uc(c,a,t)})}const r=[];for(let a=0,c=e.length;a<c;a++){const l=e[a],h=dI(l),u=i[h];if(u)r.push(u.promise);else{let d;l.extensions&&l.extensions[te.KHR_DRACO_MESH_COMPRESSION]?d=n(l):d=uc(new oi,l,t),i[h]={primitive:l,promise:d},r.push(d)}}return Promise.all(r)}loadMesh(e){const t=this,s=this.json,i=this.extensions,n=s.meshes[e],r=n.primitives,a=[];for(let c=0,l=r.length;c<l;c++){const h=r[c].material===void 0?cI(this.cache):this.getDependency("material",r[c].material);a.push(h)}return a.push(t.loadGeometries(r)),Promise.all(a).then(function(c){const l=c.slice(0,c.length-1),h=c[c.length-1],u=[];for(let A=0,f=h.length;A<f;A++){const g=h[A],m=r[A];let E;const p=l[A];if(m.mode===Xe.TRIANGLES||m.mode===Xe.TRIANGLE_STRIP||m.mode===Xe.TRIANGLE_FAN||m.mode===void 0)E=n.isSkinnedMesh===!0?new Bd(g,p):new $t(g,p),E.isSkinnedMesh===!0&&E.normalizeSkinWeights(),m.mode===Xe.TRIANGLE_STRIP?E.geometry=ac(E.geometry,Sc):m.mode===Xe.TRIANGLE_FAN&&(E.geometry=ac(E.geometry,xr));else if(m.mode===Xe.LINES)E=new go(g,p);else if(m.mode===Xe.LINE_STRIP)E=new po(g,p);else if(m.mode===Xe.LINE_LOOP)E=new mo(g,p);else if(m.mode===Xe.POINTS)E=new Eo(g,p);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+m.mode);Object.keys(E.geometry.morphAttributes).length>0&&uI(E,n),E.name=t.createUniqueName(n.name||"mesh_"+e),At(E,n),m.extensions&&ts(i,E,m),t.assignFinalMaterial(E),u.push(E)}for(let A=0,f=u.length;A<f;A++)t.associations.set(u[A],{meshes:e,primitives:A});if(u.length===1)return n.extensions&&ts(i,u[0],n),u[0];const d=new Wi;n.extensions&&ts(i,d,n),t.associations.set(d,{meshes:e});for(let A=0,f=u.length;A<f;A++)d.add(u[A]);return d})}loadCamera(e){let t;const s=this.json.cameras[e],i=s[s.type];if(!i){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return s.type==="perspective"?t=new xd(vc.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):s.type==="orthographic"&&(t=new vd(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),At(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s=[];for(let i=0,n=t.joints.length;i<n;i++)s.push(this._loadNodeShallow(t.joints[i]));return t.inverseBindMatrices!==void 0?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(i){const n=i.pop(),r=i,a=[],c=[];for(let l=0,h=r.length;l<h;l++){const u=r[l];if(u){a.push(u);const d=new Me;n!==null&&d.fromArray(n.array,l*16),c.push(d)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[l])}return new Ld(a,c)})}loadAnimation(e){const t=this.json,s=this,i=t.animations[e],n=i.name?i.name:"animation_"+e,r=[],a=[],c=[],l=[],h=[];for(let u=0,d=i.channels.length;u<d;u++){const A=i.channels[u],f=i.samplers[A.sampler],g=A.target,m=g.node,E=i.parameters!==void 0?i.parameters[f.input]:f.input,p=i.parameters!==void 0?i.parameters[f.output]:f.output;g.node!==void 0&&(r.push(this.getDependency("node",m)),a.push(this.getDependency("accessor",E)),c.push(this.getDependency("accessor",p)),l.push(f),h.push(g))}return Promise.all([Promise.all(r),Promise.all(a),Promise.all(c),Promise.all(l),Promise.all(h)]).then(function(u){const d=u[0],A=u[1],f=u[2],g=u[3],m=u[4],E=[];for(let I=0,C=d.length;I<C;I++){const T=d[I],L=A[I],S=f[I],x=g[I],v=m[I];if(T===void 0)continue;T.updateMatrix&&T.updateMatrix();const B=s._createAnimationTracks(T,L,S,x,v);if(B)for(let R=0;R<B.length;R++)E.push(B[R])}const p=new Rd(n,void 0,E);return At(p,i),p})}createNodeMesh(e){const t=this.json,s=this,i=t.nodes[e];return i.mesh===void 0?null:s.getDependency("mesh",i.mesh).then(function(n){const r=s._getNodeRef(s.meshCache,i.mesh,n);return i.weights!==void 0&&r.traverse(function(a){if(a.isMesh)for(let c=0,l=i.weights.length;c<l;c++)a.morphTargetInfluences[c]=i.weights[c]}),r})}loadNode(e){const t=this.json,s=this,i=t.nodes[e],n=s._loadNodeShallow(e),r=[],a=i.children||[];for(let l=0,h=a.length;l<h;l++)r.push(s.getDependency("node",a[l]));const c=i.skin===void 0?Promise.resolve(null):s.getDependency("skin",i.skin);return Promise.all([n,Promise.all(r),c]).then(function(l){const h=l[0],u=l[1],d=l[2];d!==null&&h.traverse(function(A){A.isSkinnedMesh&&A.bind(d,fI)});for(let A=0,f=u.length;A<f;A++)h.add(u[A]);return h})}_loadNodeShallow(e){const t=this.json,s=this.extensions,i=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const n=t.nodes[e],r=n.name?i.createUniqueName(n.name):"",a=[],c=i._invokeOne(function(l){return l.createNodeMesh&&l.createNodeMesh(e)});return c&&a.push(c),n.camera!==void 0&&a.push(i.getDependency("camera",n.camera).then(function(l){return i._getNodeRef(i.cameraCache,n.camera,l)})),i._invokeAll(function(l){return l.createNodeAttachment&&l.createNodeAttachment(e)}).forEach(function(l){a.push(l)}),this.nodeCache[e]=Promise.all(a).then(function(l){let h;if(n.isBone===!0?h=new Dd:l.length>1?h=new Wi:l.length===1?h=l[0]:h=new fo,h!==l[0])for(let u=0,d=l.length;u<d;u++)h.add(l[u]);if(n.name&&(h.userData.name=n.name,h.name=r),At(h,n),n.extensions&&ts(s,h,n),n.matrix!==void 0){const u=new Me;u.fromArray(n.matrix),h.applyMatrix4(u)}else n.translation!==void 0&&h.position.fromArray(n.translation),n.rotation!==void 0&&h.quaternion.fromArray(n.rotation),n.scale!==void 0&&h.scale.fromArray(n.scale);if(!i.associations.has(h))i.associations.set(h,{});else if(n.mesh!==void 0&&i.meshCache.refs[n.mesh]>1){const u=i.associations.get(h);i.associations.set(h,{...u})}return i.associations.get(h).nodes=e,h}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],i=this,n=new Wi;s.name&&(n.name=i.createUniqueName(s.name)),At(n,s),s.extensions&&ts(t,n,s);const r=s.nodes||[],a=[];for(let c=0,l=r.length;c<l;c++)a.push(i.getDependency("node",r[c]));return Promise.all(a).then(function(c){for(let h=0,u=c.length;h<u;h++)n.add(c[h]);const l=h=>{const u=new Map;for(const[d,A]of i.associations)(d instanceof Rn||d instanceof ra)&&u.set(d,A);return h.traverse(d=>{const A=i.associations.get(d);A!=null&&u.set(d,A)}),u};return i.associations=l(n),n})}_createAnimationTracks(e,t,s,i,n){const r=[],a=e.name?e.name:e.uuid,c=[];Mt[n.path]===Mt.weights?e.traverse(function(d){d.morphTargetInfluences&&c.push(d.name?d.name:d.uuid)}):c.push(a);let l;switch(Mt[n.path]){case Mt.weights:l=aa;break;case Mt.rotation:l=la;break;case Mt.translation:case Mt.scale:l=oa;break;default:s.itemSize===1?l=aa:l=oa;break}const h=i.interpolation!==void 0?lI[i.interpolation]:Lc,u=this._getArrayFromAccessor(s);for(let d=0,A=c.length;d<A;d++){const f=new l(c[d]+"."+Mt[n.path],t.array,u,h);i.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(f),r.push(f)}return r}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const s=lo(t.constructor),i=new Float32Array(t.length);for(let n=0,r=t.length;n<r;n++)i[n]=t[n]*s;t=i}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(s){const i=this instanceof la?aI:Iu;return new i(this.times,this.values,this.getValueSize()/3,s)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function mI(o,e,t){const s=e.attributes,i=new Ye;if(s.POSITION!==void 0){const a=t.json.accessors[s.POSITION],c=a.min,l=a.max;if(c!==void 0&&l!==void 0){if(i.set(new N(c[0],c[1],c[2]),new N(l[0],l[1],l[2])),a.normalized){const h=lo(ws[a.componentType]);i.min.multiplyScalar(h),i.max.multiplyScalar(h)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const n=e.targets;if(n!==void 0){const a=new N,c=new N;for(let l=0,h=n.length;l<h;l++){const u=n[l];if(u.POSITION!==void 0){const d=t.json.accessors[u.POSITION],A=d.min,f=d.max;if(A!==void 0&&f!==void 0){if(c.setX(Math.max(Math.abs(A[0]),Math.abs(f[0]))),c.setY(Math.max(Math.abs(A[1]),Math.abs(f[1]))),c.setZ(Math.max(Math.abs(A[2]),Math.abs(f[2]))),d.normalized){const g=lo(ws[d.componentType]);c.multiplyScalar(g)}a.max(c)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(a)}o.boundingBox=i;const r=new Ic;i.getCenter(r.center),r.radius=i.min.distanceTo(i.max)/2,o.boundingSphere=r}function uc(o,e,t){const s=e.attributes,i=[];function n(r,a){return t.getDependency("accessor",r).then(function(c){o.setAttribute(a,c)})}for(const r in s){const a=ao[r]||r.toLowerCase();a in o.attributes||i.push(n(s[r],a))}if(e.indices!==void 0&&!o.index){const r=t.getDependency("accessor",e.indices).then(function(a){o.setIndex(a)});i.push(r)}return Br.workingColorSpace!==It&&"COLOR_0"in s&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Br.workingColorSpace}" not supported.`),At(o,e),mI(o,e,t),Promise.all(i).then(function(){return e.targets!==void 0?hI(o,e.targets,t):o})}var pI="data:image/png;base64,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",EI="data:image/png;base64,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",II="data:image/png;base64,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";$t.prototype.raycast=wE;var an=null,yI=new kd,CI=class{constructor(){this.loader=new ME,this.playerRadius=45,this.playerHeight=180,this.isFirstPerson=!1,this.boundingBoxMinY=0,this.displayPlayer=!1,this.displayCollider=!1,this.displayVisualizer=!1,this.collider=null,this.visualizer=null,this.person=null,this.vehicle=null,this.playerIsOnGround=!1,this.isupdate=!0,this.isFlying=!1,this.fwdPressed=!1,this.bkdPressed=!1,this.lftPressed=!1,this.rgtPressed=!1,this.spacePressed=!1,this.ctPressed=!1,this.shiftPressed=!1,this.prevJoyState={dirX:0,dirY:0,shift:!1},this.nippleModule=null,this.joystickManager=null,this.joystickZoneEl=null,this.lookAreaEl=null,this.jumpBtnEl=null,this.flyBtnEl=null,this.viewBtnEl=null,this.lookPointerId=null,this.isLookDown=!1,this.lastTouchX=0,this.lastTouchY=0,this._camCollisionLerp=.18,this._camEpsilon=.35,this._minCamDistance=1,this._maxCamDistance=4.4,this.orginMaxCamDistance=4.4,this.playerVelocity=new N,this.upVector=new N(0,1,0),this.tempVector=new N,this.tempVector2=new N,this.tempBox=new Ye,this.tempMat=new Me,this.tempSegment=new lt,this.recheckAnimTimer=null,this.camDir=new N,this.moveDir=new N,this.targetQuat=new Io,this.targetMat=new Me,this.rotationSpeed=10,this.DIR_FWD=new N(0,0,-1),this.DIR_BKD=new N(0,0,1),this.DIR_LFT=new N(-1,0,0),this.DIR_RGT=new N(1,0,0),this.DIR_UP=new N(0,1,0),this._personToCam=new N,this._originTmp=new N,this._raycaster=new ca(new N,new N(0,-1,0)),this._raycasterPersonToCam=new ca(new N,new N),this.setAnimationByPressed=()=>{if(this._maxCamDistance=this.orginMaxCamDistance,this.isFlying){if(!this.fwdPressed){this.playPersonAnimationByName("flyidle");return}this.playPersonAnimationByName("flying"),this._maxCamDistance=this.orginMaxCamDistance*2;return}if(this.playerIsOnGround){if(!this.fwdPressed&&!this.bkdPressed&&!this.lftPressed&&!this.rgtPressed){this.playPersonAnimationByName("idle");return}if(this.fwdPressed){this.playPersonAnimationByName(this.shiftPressed?"running":"walking");return}if(!this.isFirstPerson&&(this.lftPressed||this.rgtPressed||this.bkdPressed)){this.playPersonAnimationByName(this.shiftPressed?"running":"walking");return}if(this.lftPressed){this.playPersonAnimationByName("left_walking");return}if(this.rgtPressed){this.playPersonAnimationByName("right_walking");return}if(this.bkdPressed){this.playPersonAnimationByName("walking_backward");return}}this.recheckAnimTimer!==null&&clearTimeout(this.recheckAnimTimer),this.recheckAnimTimer=setTimeout(()=>{this.setAnimationByPressed(),this.recheckAnimTimer=null},200)},this._boundOnKeydown=async o=>{switch(o.ctrlKey&&["KeyW","KeyA","KeyS","KeyD"].includes(o.code)&&o.preventDefault(),o.code){case"KeyW":this.fwdPressed=!0,this.setAnimationByPressed();break;case"KeyS":this.bkdPressed=!0,this.setAnimationByPressed();break;case"KeyD":this.rgtPressed=!0,this.setAnimationByPressed();break;case"KeyA":this.lftPressed=!0,this.setAnimationByPressed();break;case"ShiftLeft":this.shiftPressed=!0,this.setAnimationByPressed(),this.controls.mouseButtons={LEFT:2,MIDDLE:1,RIGHT:0};break;case"Space":if(this.spacePressed=!0,!this.playerIsOnGround||this.isFlying)return;const e=this.personActions?.get("jumping");if(e&&this.actionState===e)return;this.playPersonAnimationByName("jumping"),this.playerVelocity.y=this.jumpHeight,this.playerIsOnGround=!1;break;case"ControlLeft":this.ctPressed=!0;break;case"KeyV":this.changeView();break;case"KeyF":this.isFlying=!this.isFlying,this.setAnimationByPressed(),!this.isFlying&&!this.playerIsOnGround&&this.playPersonAnimationByName("jumping");break;case"KeyE":this.setDrive();break}},this._boundOnKeyup=o=>{switch(o.code){case"KeyW":this.fwdPressed=!1,this.setAnimationByPressed();break;case"KeyS":this.bkdPressed=!1,this.setAnimationByPressed();break;case"KeyD":this.rgtPressed=!1,this.setAnimationByPressed();break;case"KeyA":this.lftPressed=!1,this.setAnimationByPressed();break;case"ShiftLeft":this.shiftPressed=!1,this.setAnimationByPressed(),this.controls.mouseButtons={LEFT:0,MIDDLE:1,RIGHT:2};break;case"Space":this.spacePressed=!1;break;case"ControlLeft":this.ctPressed=!1;break}},this._mouseMove=o=>{document.pointerLockElement===document.body&&this.setToward(o.movementX,o.movementY,1e-4)},this._mouseClick=o=>{this.setPointerLock()},this.onPointerDown=o=>{o.pointerType==="touch"&&(this.isLookDown=!0,this.lookPointerId=o.pointerId,this.lastTouchX=o.clientX,this.lastTouchY=o.clientY,this.lookAreaEl?.setPointerCapture?.(o.pointerId),o.preventDefault())},this.onPointerMove=o=>{if(!this.isLookDown||o.pointerId!==this.lookPointerId)return;const e=o.clientX-this.lastTouchX,t=o.clientY-this.lastTouchY;this.lastTouchX=o.clientX,this.lastTouchY=o.clientY,this.setInput({lookDeltaX:e,lookDeltaY:t}),o.preventDefault()},this.onPointerUp=o=>{o.pointerId===this.lookPointerId&&(this.isLookDown=!1,this.lookPointerId=null,this.lookAreaEl?.releasePointerCapture?.(o.pointerId))},this._raycaster.firstHitOnly=!0,this._raycasterPersonToCam.firstHitOnly=!0}async init(o,e){this.scene=o.scene,this.camera=o.camera,this.camera.rotation.order="YXZ",this.controls=o.controls,this.playerModel=o.playerModel,this.initPos=o.initPos??new N(0,0,0),this.mouseSensity=o.mouseSensity??5;const t=this.playerModel.scale;this.visualizeDepth=0*t,this.gravity=(o.playerModel.gravity??-2400)*t,this.jumpHeight=(o.playerModel.jumpHeight??800)*t,this.originPlayerSpeed=(o.playerModel.speed??400)*t,this.playerSpeed=this.originPlayerSpeed,this.playerModel.rotateY=o.playerModel.rotateY??0,this._camCollisionLerp=.18,this._camEpsilon=35*t,this._minCamDistance=(o.minCamDistance??100)*t,this._maxCamDistance=(o.maxCamDistance??440)*t,this.orginMaxCamDistance=this._maxCamDistance,this.thirdMouseMode=o.thirdMouseMode??1;const s=()=>navigator.maxTouchPoints&&navigator.maxTouchPoints>0||"ontouchstart"in window||/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);this.isShowMobileControls=(o.isShowMobileControls??!0)&&s(),this.isShowMobileControls&&await this.initMobileControls(),await this.createBVH(o.colliderMeshUrl),this.createPlayer(),await this.loadPersonGLB(),this.isFirstPerson&&this.person&&this.person.add(this.camera),this.onAllEvent(),this.setCameraPos(),this.setControls(),e&&e()}async initLoader(){const o=new kE;o.setDecoderPath("https://unpkg.com/three@0.180.0/examples/jsm/libs/draco/gltf/"),o.setDecoderConfig({type:"js"}),this.loader.setDRACOLoader(o)}async loadPersonGLB(){try{const o=await this.loader.loadAsync(this.playerModel.url);this.person=o.scene;const e=this.playerModel.scale,t=this.playerHeight*e;this.person.scale.set(e,e,e),this.person.position.set(0,-t*.75,0),this.person.traverse(r=>{r.isMesh&&(r.castShadow=!0,r.receiveShadow=!0)}),this.player.add(this.person),this.reset(),this.personMixer=new ha(this.person);const s=o.animations??[];this.personActions=new Map;const i=[[this.playerModel.idleAnim,"idle"],[this.playerModel.walkAnim,"walking"],[this.playerModel.leftWalkAnim||this.playerModel.walkAnim,"left_walking"],[this.playerModel.rightWalkAnim||this.playerModel.walkAnim,"right_walking"],[this.playerModel.backwardAnim||this.playerModel.walkAnim,"walking_backward"],[this.playerModel.jumpAnim,"jumping"],[this.playerModel.runAnim,"running"],[this.playerModel.flyIdleAnim||this.playerModel.idleAnim,"flyidle"],[this.playerModel.flyAnim||this.playerModel.idleAnim,"flying"]],n=r=>s.find(a=>a.name===r);for(const[r,a]of i){const c=n(r);if(!c)continue;const l=this.personMixer.clipAction(c);a==="jumping"?(l.setLoop(ua,1),l.clampWhenFinished=!0,l.setEffectiveTimeScale(1.2)):(l.setLoop(_d,1/0),l.clampWhenFinished=!1,l.setEffectiveTimeScale(1)),l.enabled=!0,l.setEffectiveWeight(0),this.personActions.set(a,l)}this.idleAction=this.personActions.get("idle"),this.walkAction=this.personActions.get("walking"),this.leftWalkAction=this.personActions.get("left_walking"),this.rightWalkAction=this.personActions.get("right_walking"),this.backwardAction=this.personActions.get("walking_backward"),this.jumpAction=this.personActions.get("jumping"),this.runAction=this.personActions.get("running"),this.flyidleAction=this.personActions.get("flyidle"),this.flyAction=this.personActions.get("flying"),this.idleAction.setEffectiveWeight(1),this.idleAction.play(),this.actionState=this.idleAction,this.personMixer.addEventListener("finished",r=>{if(r.action===this.jumpAction){if(this.fwdPressed){this.playPersonAnimationByName(this.shiftPressed?"running":"walking");return}if(this.bkdPressed){this.playPersonAnimationByName("walking_backward");return}if(this.rgtPressed||this.lftPressed){this.playPersonAnimationByName("walking");return}this.playPersonAnimationByName("idle")}})}catch(o){console.error(":",o)}}playPersonAnimationByName(o,e=.18){if(!this.personActions||this.ctPressed)return;const t=this.personActions.get(o);if(!t||this.actionState===t)return;const s=this.actionState;t.reset(),t.setEffectiveWeight(1),t.play(),s&&s!==t&&s.fadeOut(e),t.fadeIn(e),this.actionState=t}createPlayer(){const o=new yo({color:new wt(1,0,0),shadowSide:Ao,depthTest:!1,transparent:!0,opacity:this.displayPlayer?.5:0,wireframe:!0,depthWrite:!1}),e=this.playerRadius*this.playerModel.scale,t=this.playerHeight*this.playerModel.scale;this.player=new $t(new zo(e*2,t,e*2,1,75),o),this.player.geometry.translate(0,-t*.25,0),this.player.capsuleInfo={radius:e,segment:new lt(new N,new N(0,-t*.5,0))},this.player.name="capsule",this.scene.add(this.player),this.reset(),this.player.rotateY(this.playerModel.rotateY??0)}async loadVehicleModel(o){try{const{url:e,position:t,scale:s=1}=o,i=await this.loader.loadAsync(e);this.vehicle=i.scene,this.vehicle.scale.set(s,s,s),this.vehicle.position.copy(t),this.vehicle.traverse(c=>{c.isMesh&&(c.castShadow=!0,c.receiveShadow=!0)}),this.scene.add(this.vehicle);const n=i.animations??[];this.vehicleActions=new Map,this.vehicleMixer=new ha(this.vehicle);const r=[[o.animations?.openDoorAnim??"","open_door"],[o.animations?.wheelsTurnAnim??"","wheels_turn"],[o.animations?.turnLeftAnim??"","turn_left"],[o.animations?.turnRightAnim??"","turn_right"]],a=c=>n.find(l=>l.name===c);for(const[c,l]of r){const h=a(c);if(!h)continue;const u=this.vehicleMixer.clipAction(h);u.setLoop(ua,1),u.clampWhenFinished=!0,u.setEffectiveTimeScale(2),u.enabled=!0,u.setEffectiveWeight(0),this.vehicleActions.set(l,u)}console.log("",this.vehicleActions.get("open_door"))}catch(e){console.error(":",e)}}changeView(){if(this.isFirstPerson=!this.isFirstPerson,this.isFirstPerson)this.player.attach(this.camera),this.camera.position.set(0,40*this.playerModel.scale,30*this.playerModel.scale),this.camera.rotation.set(0,Math.PI,0);else{this.scene.attach(this.camera);const o=this.player.position.clone(),e=new N(0,0,-1).applyQuaternion(this.player.quaternion),t=Math.atan2(e.z,e.x),s=new N(Math.cos(t)*400*this.playerModel.scale,200*this.playerModel.scale,Math.sin(t)*400*this.playerModel.scale);this.camera.position.copy(o).add(s),this.controls.target.copy(o)}this.setPointerLock()}setDrive(){this.controllerMode=2,this.person?.attach(this.vehicle)}setPointerLock(){((this.thirdMouseMode===0||this.thirdMouseMode===1)&&!this.isFirstPerson||this.isFirstPerson)&&document.body.requestPointerLock()}setCameraPos(){if(this.isFirstPerson)this.camera.position.set(0,40*this.playerModel.scale,30*this.playerModel.scale);else{const o=this.player.position.clone(),e=new N(0,0,-1).applyQuaternion(this.player.quaternion),t=Math.atan2(e.z,e.x),s=new N(Math.cos(t)*400*this.playerModel.scale,-100*this.playerModel.scale,Math.sin(t)*400*this.playerModel.scale);this.camera.position.copy(o).add(s)}this.camera.updateProjectionMatrix()}setControls(){this.controls.enabled=!(this.thirdMouseMode===0||this.thirdMouseMode===1),this.controls.rotateSpeed=this.mouseSensity*.05,this.controls.maxPolarAngle=Math.PI*(300/360)}resetControls(){this.controls&&(this.controls.enabled=!0,this.controls.enablePan=!0,this.controls.maxPolarAngle=Math.PI/2,this.controls.rotateSpeed=1,this.controls.enableZoom=!0,this.controls.mouseButtons={LEFT:0,MIDDLE:1,RIGHT:2})}setToward(o,e,t){if(this.isFirstPerson){const s=-o*t*this.mouseSensity,i=-e*t*this.mouseSensity;this.player.rotateY(s),this.camera.rotation.x=vc.clamp(this.camera.rotation.x+i,-1.1,1.4)}else{const s=this.mouseSensity,i=-o*t*s,n=-e*t*s,r=this.player.position.clone(),a=this.camera.position.distanceTo(r),c=this.camera.position.clone().sub(r);let l=Math.atan2(c.x,c.z),h=Math.acos(c.y/a);l+=i,h+=n,h=Math.max(.1,Math.min(Math.PI-.1,h));const u=a*Math.sin(h)*Math.sin(l),d=a*Math.cos(h),A=a*Math.sin(h)*Math.cos(l);this.camera.position.set(r.x+u,r.y+d,r.z+A),this.camera.lookAt(r)}}async createBVH(o=""){await this.initLoader();const e=i=>{if(!i.attributes.position)return null;if(i.attributes.normal||i.computeVertexNormals(),!i.attributes.uv){const n=i.attributes.position.count,r=new Float32Array(n*2);i.setAttribute("uv",new et(r,2))}return i},t=[];if(o===""){if(this.collider&&(this.scene.remove(this.collider),this.collider=null),this.scene.traverse(a=>{const c=a;if(c?.isMesh&&c.geometry&&a.name!=="capsule")try{let l=c.geometry.clone();l.applyMatrix4(c.matrixWorld),l.index&&(l=l.toNonIndexed());const h=e(l);h&&t.push(h)}catch(l){console.warn("",c,l)}}),!t.length)return;const i=new Map,n=new Set;for(const a of t)for(const c of Object.keys(a.attributes)){const l=a.attributes[c],h=l.array.constructor,u=l.itemSize;if(!i.has(c))i.set(c,{itemSize:u,arrayCtor:h,examples:1});else{const d=i.get(c);d.itemSize!==u||d.arrayCtor!==h?n.add(c):d.examples++}}if(n.size){for(const a of t)for(const c of Array.from(n))a.attributes[c]&&a.deleteAttribute(c);for(const a of n)i.delete(a)}const r=Array.from(i.keys());for(const a of t){const c=a.attributes.position.count;for(const l of r)if(!a.attributes[l]){const h=i.get(l),u=c*h.itemSize,d=new h.arrayCtor(u);a.setAttribute(l,new et(d,h.itemSize))}}}else{const n=(await this.loader.loadAsync(o)).scene.children[0];n.name="BVH";let r=n.geometry.clone();r.applyMatrix4(n.matrixWorld),r.index&&(r=r.toNonIndexed());const a=e(r);a&&t.push(a)}const s=FE(t,!1);if(!s){console.error("");return}s.boundsTree=new fi(s,{maxDepth:100}),this.collider=new $t(s,new is({opacity:.5,transparent:!0,wireframe:!0})),this.displayCollider&&this.scene.add(this.collider),this.displayVisualizer&&(this.visualizer&&this.scene.remove(this.visualizer),this.visualizer=new bE(this.collider,this.visualizeDepth),this.scene.add(this.visualizer)),this.boundingBoxMinY=this.collider.geometry.boundingBox.min.y}getAngleWithYAxis(o){const e={x:0,y:1,z:0},t=o.x*e.x+o.y*e.y+o.z*e.z,s=Math.sqrt(o.x*o.x+o.y*o.y+o.z*o.z),i=t/s;return Math.acos(i)}async update(o=yI.getDelta()){if(!this.isupdate||!this.player||!this.collider)return;o=Math.min(o,1/30),this.isFlying||this.player.position.addScaledVector(this.playerVelocity,o),this.updateMixers(o),this.camera.getWorldDirection(this.camDir);let e=Math.atan2(this.camDir.z,this.camDir.x)+Math.PI/2;e=2*Math.PI-e,this.moveDir.set(0,0,0),this.fwdPressed&&this.moveDir.add(this.DIR_FWD),this.bkdPressed&&this.moveDir.add(this.DIR_BKD),this.lftPressed&&this.moveDir.add(this.DIR_LFT),this.rgtPressed&&this.moveDir.add(this.DIR_RGT),this.isFlying&&(this.fwdPressed?this.moveDir.y=this.camDir.y:this.moveDir.y=0,this.spacePressed&&this.moveDir.add(this.DIR_UP)),this.isFlying&&this.fwdPressed?this.playerSpeed=this.shiftPressed?this.originPlayerSpeed*12:this.originPlayerSpeed*7:this.playerSpeed=this.shiftPressed?this.originPlayerSpeed*2:this.originPlayerSpeed,this.moveDir.normalize().applyAxisAngle(this.upVector,e),this.player.position.addScaledVector(this.moveDir,this.playerSpeed*o);let t=1/0;this._originTmp.set(this.player.position.x,this.player.position.y,this.player.position.z),this._raycaster.ray.origin.copy(this._originTmp);const s=this._raycaster.intersectObject(this.collider,!1);if(s.length>0){t=this.player.position.y-s[0].point.y;const l=s[0].normal,h=this.getAngleWithYAxis(l)*180/Math.PI,u=this.playerHeight*this.playerModel.scale*.9,d=this.playerHeight*this.playerModel.scale*.75,A=this.playerHeight*this.playerModel.scale*.7;this.isFlying||(t>u?(this.playerVelocity.y+=o*this.gravity,this.player.position.addScaledVector(this.playerVelocity,o),this.playerIsOnGround=!1):t>d&&t<u?h>=0&&h<5?(this.playerVelocity.y+=o*this.gravity,this.player.position.addScaledVector(this.playerVelocity,o),this.playerIsOnGround=!0):this.spacePressed?this.playerVelocity.y+=o*this.gravity:(this.playerVelocity.set(0,0,0),this.playerIsOnGround=!0):t>A&&t<d?(this.playerVelocity.set(0,0,0),this.playerIsOnGround=!0):t<A&&(this.playerVelocity.set(0,0,0),this.player.position.set(this.player.position.x,s[0].point.y+d,this.player.position.z),this.playerIsOnGround=!0))}this.player.updateMatrixWorld();const i=this.player.capsuleInfo;this.tempBox.makeEmpty(),this.tempMat.copy(this.collider.matrixWorld).invert(),this.tempSegment.copy(i.segment),this.tempSegment.start.applyMatrix4(this.player.matrixWorld).applyMatrix4(this.tempMat),this.tempSegment.end.applyMatrix4(this.player.matrixWorld).applyMatrix4(this.tempMat),this.tempBox.expandByPoint(this.tempSegment.start),this.tempBox.expandByPoint(this.tempSegment.end),this.tempBox.expandByScalar(i.radius),this.collider?.geometry?.boundsTree?.shapecast({intersectsBounds:l=>l.intersectsBox(this.tempBox),intersectsTriangle:l=>{const h=this.tempVector,u=this.tempVector2,d=l.closestPointToSegment(this.tempSegment,h,u);if(d<i.radius){const A=i.radius-d,f=u.sub(h).normalize();this.tempSegment.start.addScaledVector(f,A),this.tempSegment.end.addScaledVector(f,A)}}});const r=this.tempVector.copy(this.tempSegment.start).applyMatrix4(this.collider.matrixWorld),a=this.tempVector2.subVectors(r,this.player.position),c=Math.max(0,a.length()-1e-5);if(a.normalize().multiplyScalar(c),this.player.position.add(a),!this.isFirstPerson&&!this.isFlying){this.camDir.y=0,this.camDir.normalize(),this.camDir.negate(),this.moveDir.normalize(),this.moveDir.negate();let l;if(this.thirdMouseMode===0||this.thirdMouseMode===2){this.moveDir.lengthSq()>0?l=this.player.position.clone().add(this.moveDir):l=this.player.position.clone().add(this.camDir),this.targetMat.lookAt(this.player.position,l,this.player.up),this.targetQuat.setFromRotationMatrix(this.targetMat);const h=Math.min(1,this.rotationSpeed*o);this.player.quaternion.slerp(this.targetQuat,h)}if((this.thirdMouseMode===1||this.thirdMouseMode===3)&&this.moveDir.lengthSq()>0){l=this.player.position.clone().add(this.moveDir),this.targetMat.lookAt(this.player.position,l,this.player.up),this.targetQuat.setFromRotationMatrix(this.targetMat);const h=Math.min(1,this.rotationSpeed*o);this.player.quaternion.slerp(this.targetQuat,h)}}if(this.isFlying){this.camDir.y=0,this.camDir.normalize(),this.camDir.negate(),this.moveDir.normalize(),this.moveDir.negate();const l=this.player.position.clone().add(this.fwdPressed?this.moveDir:this.camDir);this.targetMat.lookAt(this.player.position,l,this.player.up),this.targetQuat.setFromRotationMatrix(this.targetMat);const h=Math.min(1,this.rotationSpeed*o);this.player.quaternion.slerp(this.targetQuat,h)}if(!this.isFirstPerson){const l=this.player.position.clone();l.y+=30*this.playerModel.scale,this.camera.position.sub(this.controls.target),this.controls.target.copy(l),this.camera.position.add(l),this.controls.update(),this._personToCam.subVectors(this.camera.position,this.player.position);const h=this.player.position.clone().add(new N(0,0,0)),u=this._personToCam.clone().normalize(),d=this._personToCam.length();this._raycasterPersonToCam.set(h,u),this._raycasterPersonToCam.far=d;const A=this._raycasterPersonToCam.intersectObject(this.collider,!1);if(A.length>0){const f=A[0],g=Math.max(f.distance-this._camEpsilon,this._minCamDistance),m=h.clone().add(u.clone().multiplyScalar(g));this.camera.position.lerp(m,this._camCollisionLerp)}else{this._raycasterPersonToCam.far=this._maxCamDistance;const f=this._raycasterPersonToCam.intersectObject(this.collider,!1);let g=this._maxCamDistance;f.length&&(g=f[0].distance-this._camEpsilon);const m=h.clone().add(u.clone().multiplyScalar(g));this.camera.position.lerp(m,this._camCollisionLerp)}}if(this.player.position.y<this.boundingBoxMinY-1){this._originTmp.set(this.player.position.x,1e4,this.player.position.z),this._raycaster.ray.origin.copy(this._originTmp);const l=this._raycaster.intersectObject(this.collider,!1);l.length>0?(console.log("bug"),this.reset(new N(this.player.position.x,l[0].point.y+5,this.player.position.z))):(console.log(""),this.reset(new N(this.player.position.x,this.player.position.y+15,this.player.position.z)))}}updateMixers(o){this.personMixer&&this.personMixer.update(o),this.vehicleMixer&&this.vehicleMixer.update(o)}reset(o){this.player&&(this.playerVelocity.set(0,0,0),this.player.position.copy(o??this.initPos))}getPosition(){return this.player.position}setInput(o){if(typeof o.moveX=="number"&&(this.lftPressed=o.moveX===-1,this.rgtPressed=o.moveX===1,this.setAnimationByPressed()),typeof o.moveY=="number"&&(this.fwdPressed=o.moveY===1,this.bkdPressed=o.moveY===-1,this.setAnimationByPressed()),typeof o.lookDeltaX=="number"&&typeof o.lookDeltaY=="number"&&this.setToward(o.lookDeltaX,o.lookDeltaY,.002),typeof o.jump=="boolean")if(o.jump){if(this.spacePressed=!0,!this.playerIsOnGround||this.isFlying)return;this.playPersonAnimationByName("jumping"),this.playerVelocity.y=this.jumpHeight,this.playerIsOnGround=!1}else this.spacePressed=!1;typeof o.shift=="boolean"&&(this.shiftPressed=o.shift),o.toggleView&&this.changeView(),o.toggleFly&&(this.isFlying=!this.isFlying,this.setAnimationByPressed(),!this.isFlying&&!this.playerIsOnGround&&this.playPersonAnimationByName("jumping"))}onAllEvent(){this.isupdate=!0,this.setPointerLock(),window.addEventListener("keydown",this._boundOnKeydown),window.addEventListener("keyup",this._boundOnKeyup),window.addEventListener("mousemove",this._mouseMove),window.addEventListener("click",this._mouseClick)}offAllEvent(){this.isupdate=!1,document.exitPointerLock(),window.removeEventListener("keydown",this._boundOnKeydown),window.removeEventListener("keyup",this._boundOnKeyup),window.removeEventListener("mousemove",this._mouseMove),window.removeEventListener("click",this._mouseClick)}async initMobileControls(){this.controls.maxPolarAngle=Math.PI*(300/360),this.controls.touches={ONE:null,TWO:null},this.nippleModule=await R0(()=>import("./index-Dl0pyd0J.js"),[]);const o=this.nippleModule?.default,e=120,t=document.body;this.joystickZoneEl=document.createElement("div"),this.joystickZoneEl.id="joy-zone",Object.assign(this.joystickZoneEl.style,{position:"absolute",left:"16px",bottom:"16px",width:`${e+40}px`,height:`${e+40}px`,touchAction:"none",zIndex:"999",pointerEvents:"auto",WebkitUserSelect:"none",userSelect:"none"}),t.appendChild(this.joystickZoneEl),["touchstart","touchmove","touchend","touchcancel"].forEach(i=>{this.joystickZoneEl?.addEventListener(i,n=>n.preventDefault(),{passive:!1})}),this.joystickManager=o.create({zone:this.joystickZoneEl,mode:"static",position:{left:`${(e+40)/2}px`,bottom:`${(e+40)/2}px`},color:"#ffffff",size:e,multitouch:!0,maxNumberOfNipples:1}),this.joystickManager.on("move",(i,n)=>{if(!n)return;const r=n.vector?.x??0,a=n.vector?.y??0,c=n.distance??0,l=.5,h=r>l?1:r<-l?-1:0,u=a>l?1:a<-l?-1:0,d=e/2,A=c>=d,f=this.prevJoyState||{dirX:0,dirY:0,shift:!1};h===f.dirX&&u===f.dirY&&A===f.shift||(this.prevJoyState={dirX:h,dirY:u,shift:A},this.setInput({moveX:h,moveY:u,shift:A}))}),this.joystickManager.on("end",()=>{const i=this.prevJoyState||{dirX:0,dirY:0,shift:!1};(i.dirX!==0||i.dirY!==0||i.shift!==!1)&&(this.prevJoyState={dirX:0,dirY:0,shift:!1},this.setInput({moveX:0,moveY:0,shift:!1}))}),this.lookAreaEl=document.createElement("div"),Object.assign(this.lookAreaEl.style,{position:"absolute",right:"0",bottom:"0",width:"50%",height:"100%",zIndex:"998",touchAction:"none",WebkitUserSelect:"none",userSelect:"none"}),t.appendChild(this.lookAreaEl),["touchstart","touchmove","touchend","touchcancel"].forEach(i=>{this.lookAreaEl?.addEventListener(i,n=>n.preventDefault(),{passive:!1})}),this.lookAreaEl.addEventListener("pointerdown",this.onPointerDown,{passive:!1}),this.lookAreaEl.addEventListener("pointermove",this.onPointerMove,{passive:!1}),this.lookAreaEl.addEventListener("pointerup",this.onPointerUp,{passive:!1}),this.lookAreaEl.addEventListener("pointercancel",this.onPointerUp,{passive:!1});const s=(i,n,r)=>{const a=document.createElement("button"),c={position:"absolute",right:`${i}px`,bottom:`${n}px`,width:"56px",height:"56px",zIndex:"1000",borderRadius:"50%",border:"2px solid black",background:"rgba(0,0,0)",padding:"20px",opacity:"0.95",touchAction:"none",fontSize:"14px",userSelect:"none",overflow:"hidden",boxSizing:"border-box",backgroundColor:"transparent",backgroundRepeat:"no-repeat, no-repeat",backgroundPosition:"center center, center center",backgroundSize:"100% 100%, 80% 80%"};if(r){const l="rgba(0,0,0,0.5)";c.backgroundImage=`linear-gradient(${l}, ${l}), url("${r}")`}return Object.assign(a.style,c),t.appendChild(a),["touchstart","touchend","touchcancel"].forEach(l=>{a.addEventListener(l,h=>h.preventDefault(),{passive:!1})}),a};this.jumpBtnEl=s(14,14,EI),this.jumpBtnEl.addEventListener("touchstart",i=>{i.preventDefault(),this.setInput({jump:!0})},{passive:!1}),this.jumpBtnEl.addEventListener("touchend",i=>{i.preventDefault(),this.setInput({jump:!1})},{passive:!1}),this.jumpBtnEl.addEventListener("touchcancel",i=>{i.preventDefault(),this.setInput({jump:!1})},{passive:!1}),this.flyBtnEl=s(14,94,pI),this.flyBtnEl.addEventListener("touchstart",i=>{i.preventDefault(),this.setInput({toggleFly:!0})},{passive:!1}),this.viewBtnEl=s(14,214,II),this.viewBtnEl.addEventListener("touchstart",i=>{i.preventDefault(),this.setInput({toggleView:!0})},{passive:!1})}destroyMobileControls(){try{this.joystickManager&&this.joystickManager.destroy&&(this.joystickManager.destroy(),this.joystickManager=null),this.joystickZoneEl?.parentElement&&(this.joystickZoneEl.parentElement.removeChild(this.joystickZoneEl),this.joystickZoneEl=null),this.lookAreaEl?.parentElement&&(this.lookAreaEl.parentElement.removeChild(this.lookAreaEl),this.lookAreaEl=null),this.jumpBtnEl?.parentElement&&(this.jumpBtnEl.parentElement.removeChild(this.jumpBtnEl),this.jumpBtnEl=null),this.flyBtnEl?.parentElement&&(this.flyBtnEl.parentElement.removeChild(this.flyBtnEl),this.flyBtnEl=null),this.viewBtnEl?.parentElement&&(this.viewBtnEl.parentElement.removeChild(this.viewBtnEl),this.viewBtnEl=null),this.lookAreaEl?.removeEventListener("pointerdown",this.onPointerDown),this.lookAreaEl?.removeEventListener("pointermove",this.onPointerMove),this.lookAreaEl?.removeEventListener("pointerup",this.onPointerUp),this.lookAreaEl?.removeEventListener("pointercancel",this.onPointerUp)}catch(o){console.warn("",o)}}destroy(){this.offAllEvent(),this.player&&(this.player.remove(this.camera),this.scene.remove(this.player)),this.player=null,this.person&&(this.scene.remove(this.person),this.person=null),this.resetControls(),this.visualizer&&(this.scene.remove(this.visualizer),this.visualizer=null),this.collider&&(this.scene.remove(this.collider),this.collider=null),this.destroyMobileControls(),an=null}};function TI(){an||(an=new CI);const o=an;return{init:(e,t)=>o.init(e,t),changeView:()=>o.changeView(),reset:e=>o.reset(e),update:e=>o.update(e),destroy:()=>o.destroy(),setInput:e=>o.setInput(e),getposition:()=>o.getPosition(),loadVehicleModel:e=>o.loadVehicleModel(e)}}var ri=function(){var o=0,e=document.createElement("div");e.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",e.addEventListener("click",function(h){h.preventDefault(),s(++o%e.children.length)},!1);function t(h){return e.appendChild(h.dom),h}function s(h){for(var u=0;u<e.children.length;u++)e.children[u].style.display=u===h?"block":"none";o=h}var i=(performance||Date).now(),n=i,r=0,a=t(new ri.Panel("FPS","#0ff","#002")),c=t(new ri.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var l=t(new ri.Panel("MB","#f08","#201"));return s(0),{REVISION:16,dom:e,addPanel:t,showPanel:s,begin:function(){i=(performance||Date).now()},end:function(){r++;var h=(performance||Date).now();if(c.update(h-i,200),h>=n+1e3&&(a.update(r*1e3/(h-n),100),n=h,r=0,l)){var u=performance.memory;l.update(u.usedJSHeapSize/1048576,u.jsHeapSizeLimit/1048576)}return h},update:function(){i=this.end()},domElement:e,setMode:s}};ri.Panel=function(o,e,t){var s=1/0,i=0,n=Math.round,r=n(window.devicePixelRatio||1),a=80*r,c=48*r,l=3*r,h=2*r,u=3*r,d=15*r,A=74*r,f=30*r,g=document.createElement("canvas");g.width=a,g.height=c,g.style.cssText="width:80px;height:48px";var m=g.getContext("2d");return m.font="bold "+9*r+"px Helvetica,Arial,sans-serif",m.textBaseline="top",m.fillStyle=t,m.fillRect(0,0,a,c),m.fillStyle=e,m.fillText(o,l,h),m.fillRect(u,d,A,f),m.fillStyle=t,m.globalAlpha=.9,m.fillRect(u,d,A,f),{dom:g,update:function(E,p){s=Math.min(s,E),i=Math.max(i,E),m.fillStyle=t,m.globalAlpha=1,m.fillRect(0,0,a,d),m.fillStyle=e,m.fillText(n(E)+" "+o+" ("+n(s)+"-"+n(i)+")",l,h),m.drawImage(g,u+r,d,A-r,f,u,d,A-r,f),m.fillRect(u+A-r,d,r,f),m.fillStyle=t,m.globalAlpha=.9,m.fillRect(u+A-r,d,r,n((1-E/p)*f))}}};const mr=new WeakMap;class SI extends Rc{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,s,i){const n=new Zs(this.manager);n.setPath(this.path),n.setResponseType("arraybuffer"),n.setRequestHeader(this.requestHeader),n.setWithCredentials(this.withCredentials),n.load(e,r=>{this.parse(r,t,i)},s,i)}parse(e,t,s=()=>{}){this.decodeDracoFile(e,t,null,null,ei,s).catch(s)}decodeDracoFile(e,t,s,i,n=Co,r=()=>{}){const a={attributeIDs:s||this.defaultAttributeIDs,attributeTypes:i||this.defaultAttributeTypes,useUniqueIDs:!!s,vertexColorSpace:n};return this.decodeGeometry(e,a).then(t).catch(r)}decodeGeometry(e,t){const s=JSON.stringify(t);if(mr.has(e)){const c=mr.get(e);if(c.key===s)return c.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let i;const n=this.workerNextTaskID++,r=e.byteLength,a=this._getWorker(n,r).then(c=>(i=c,new Promise((l,h)=>{i._callbacks[n]={resolve:l,reject:h},i.postMessage({type:"decode",id:n,taskConfig:t,buffer:e},[e])}))).then(c=>this._createGeometry(c.geometry));return a.catch(()=>!0).then(()=>{i&&n&&this._releaseTask(i,n)}),mr.set(e,{key:s,promise:a}),a}_createGeometry(e){const t=new Pd;e.index&&t.setIndex(new da(e.index.array,1));for(let s=0;s<e.attributes.length;s++){const{name:i,array:n,itemSize:r,stride:a,vertexColorSpace:c}=e.attributes[s];let l;if(r===a)l=new da(n,r);else{const h=new Fd(n,a);l=new Qd(h,r,0)}i==="color"&&(this._assignVertexColorSpace(l,c),l.normalized=!(n instanceof Float32Array)),t.setAttribute(i,l)}return t}_assignVertexColorSpace(e,t){if(t!==ei)return;const s=new Md;for(let i=0,n=e.count;i<n;i++)s.fromBufferAttribute(e,i),Dc.colorSpaceToWorking(s,ei),e.setXYZ(i,s.r,s.g,s.b)}_loadLibrary(e,t){const s=new Zs(this.manager);return s.setPath(this.decoderPath),s.setResponseType(t),s.setWithCredentials(this.withCredentials),new Promise((i,n)=>{s.load(e,i,void 0,n)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(s=>{const i=s[0];e||(this.decoderConfig.wasmBinary=s[1]);const n=BI.toString(),r=["/* draco decoder */",i,"","/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([r]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const i=new Worker(this.workerSourceURL);i._callbacks={},i._taskCosts={},i._taskLoad=0,i.postMessage({type:"init",decoderConfig:this.decoderConfig}),i.onmessage=function(n){const r=n.data;switch(r.type){case"decode":i._callbacks[r.id].resolve(r);break;case"error":i._callbacks[r.id].reject(r);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+r.type+'"')}},this.workerPool.push(i)}else this.workerPool.sort(function(i,n){return i._taskLoad>n._taskLoad?-1:1});const s=this.workerPool[this.workerPool.length-1];return s._taskCosts[e]=t,s._taskLoad+=t,s})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}}function BI(){let o,e;onmessage=function(r){const a=r.data;switch(a.type){case"init":o=a.decoderConfig,e=new Promise(function(h){o.onModuleLoaded=function(u){h({draco:u})},DracoDecoderModule(o)});break;case"decode":const c=a.buffer,l=a.taskConfig;e.then(h=>{const u=h.draco,d=new u.Decoder;try{const A=t(u,d,new Int8Array(c),l),f=A.attributes.map(g=>g.array.buffer);A.index&&f.push(A.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:A},f)}catch(A){console.error(A),self.postMessage({type:"error",id:a.id,error:A.message})}finally{u.destroy(d)}});break}};function t(r,a,c,l){const h=l.attributeIDs,u=l.attributeTypes;let d,A;const f=a.GetEncodedGeometryType(c);if(f===r.TRIANGULAR_MESH)d=new r.Mesh,A=a.DecodeArrayToMesh(c,c.byteLength,d);else if(f===r.POINT_CLOUD)d=new r.PointCloud,A=a.DecodeArrayToPointCloud(c,c.byteLength,d);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!A.ok()||d.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+A.error_msg());const g={index:null,attributes:[]};for(const m in h){const E=self[u[m]];let p,I;if(l.useUniqueIDs)I=h[m],p=a.GetAttributeByUniqueId(d,I);else{if(I=a.GetAttributeId(d,r[h[m]]),I===-1)continue;p=a.GetAttribute(d,I)}const C=i(r,a,d,m,E,p);m==="color"&&(C.vertexColorSpace=l.vertexColorSpace),g.attributes.push(C)}return f===r.TRIANGULAR_MESH&&(g.index=s(r,a,d)),r.destroy(d),g}function s(r,a,c){const h=c.num_faces()*3,u=h*4,d=r._malloc(u);a.GetTrianglesUInt32Array(c,u,d);const A=new Uint32Array(r.HEAPF32.buffer,d,h).slice();return r._free(d),{array:A,itemSize:1}}function i(r,a,c,l,h,u){const d=c.num_points(),A=u.num_components(),f=n(r,h),g=A*h.BYTES_PER_ELEMENT,m=Math.ceil(g/4)*4,E=m/h.BYTES_PER_ELEMENT,p=d*g,I=d*m,C=r._malloc(p);a.GetAttributeDataArrayForAllPoints(c,u,f,p,C);const T=new h(r.HEAPF32.buffer,C,p/h.BYTES_PER_ELEMENT);let L;if(g===m)L=T.slice();else{L=new h(I/h.BYTES_PER_ELEMENT);let S=0;for(let x=0,v=T.length;x<v;x++){for(let B=0;B<A;B++)L[S+B]=T[x*A+B];S+=E}}return r._free(C),{name:l,count:d,itemSize:A,array:L,stride:E}}function n(r,a){switch(a){case Float32Array:return r.DT_FLOAT32;case Int8Array:return r.DT_INT8;case Int16Array:return r.DT_INT16;case Int32Array:return r.DT_INT32;case Uint8Array:return r.DT_UINT8;case Uint16Array:return r.DT_UINT16;case Uint32Array:return r.DT_UINT32}}}class xI extends Od{constructor(e){super(e),this.type=at}parse(e){const r=function(x,v){switch(x){case 1:throw new Error("THREE.HDRLoader: Read Error: "+(v||""));case 2:throw new Error("THREE.HDRLoader: Write Error: "+(v||""));case 3:throw new Error("THREE.HDRLoader: Bad File Format: "+(v||""));default:case 4:throw new Error("THREE.HDRLoader: Memory Error: "+(v||""))}},u=function(x,v,B){v=v||1024;let D=x.pos,b=-1,w=0,F="",P=String.fromCharCode.apply(null,new Uint16Array(x.subarray(D,D+128)));for(;0>(b=P.indexOf(`
`))&&w<v&&D<x.byteLength;)F+=P,w+=P.length,D+=128,P+=String.fromCharCode.apply(null,new Uint16Array(x.subarray(D,D+128)));return-1<b?(x.pos+=w+b+1,F+P.slice(0,b)):!1},d=function(x){const v=/^#\?(\S+)/,B=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,R=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,D=/^\s*FORMAT=(\S+)\s*$/,b=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,w={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let F,P;for((x.pos>=x.byteLength||!(F=u(x)))&&r(1,"no header found"),(P=F.match(v))||r(3,"bad initial token"),w.valid|=1,w.programtype=P[1],w.string+=F+`
`;F=u(x),F!==!1;){if(w.string+=F+`
`,F.charAt(0)==="#"){w.comments+=F+`
`;continue}if((P=F.match(B))&&(w.gamma=parseFloat(P[1])),(P=F.match(R))&&(w.exposure=parseFloat(P[1])),(P=F.match(D))&&(w.valid|=2,w.format=P[1]),(P=F.match(b))&&(w.valid|=4,w.height=parseInt(P[1],10),w.width=parseInt(P[2],10)),w.valid&2&&w.valid&4)break}return w.valid&2||r(3,"missing format specifier"),w.valid&4||r(3,"missing image size specifier"),w},A=function(x,v,B){const R=v;if(R<8||R>32767||x[0]!==2||x[1]!==2||x[2]&128)return new Uint8Array(x);R!==(x[2]<<8|x[3])&&r(3,"wrong scanline width");const D=new Uint8Array(4*v*B);D.length||r(4,"unable to allocate buffer space");let b=0,w=0;const F=4*R,P=new Uint8Array(4),G=new Uint8Array(F);let U=B;for(;U>0&&w<x.byteLength;){w+4>x.byteLength&&r(1),P[0]=x[w++],P[1]=x[w++],P[2]=x[w++],P[3]=x[w++],(P[0]!=2||P[1]!=2||(P[2]<<8|P[3])!=R)&&r(3,"bad rgbe scanline format");let H=0,$;for(;H<F&&w<x.byteLength;){$=x[w++];const Q=$>128;if(Q&&($-=128),($===0||H+$>F)&&r(3,"bad scanline data"),Q){const Y=x[w++];for(let X=0;X<$;X++)G[H++]=Y}else G.set(x.subarray(w,w+$),H),H+=$,w+=$}const O=R;for(let Q=0;Q<O;Q++){let Y=0;D[b]=G[Q+Y],Y+=R,D[b+1]=G[Q+Y],Y+=R,D[b+2]=G[Q+Y],Y+=R,D[b+3]=G[Q+Y],b+=4}U--}return D},f=function(x,v,B,R){const D=x[v+3],b=Math.pow(2,D-128)/255;B[R+0]=x[v+0]*b,B[R+1]=x[v+1]*b,B[R+2]=x[v+2]*b,B[R+3]=1},g=function(x,v,B,R){const D=x[v+3],b=Math.pow(2,D-128)/255;B[R+0]=mi.toHalfFloat(Math.min(x[v+0]*b,65504)),B[R+1]=mi.toHalfFloat(Math.min(x[v+1]*b,65504)),B[R+2]=mi.toHalfFloat(Math.min(x[v+2]*b,65504)),B[R+3]=mi.toHalfFloat(1)},m=new Uint8Array(e);m.pos=0;const E=d(m),p=E.width,I=E.height,C=A(m.subarray(m.pos),p,I);let T,L,S;switch(this.type){case Ht:S=C.length/4;const x=new Float32Array(S*4);for(let B=0;B<S;B++)f(C,B*4,x,B*4);T=x,L=Ht;break;case at:S=C.length/4;const v=new Uint16Array(S*4);for(let B=0;B<S;B++)g(C,B*4,v,B*4);T=v,L=at;break;default:throw new Error("THREE.HDRLoader: Unsupported type: "+this.type)}return{width:p,height:I,data:T,header:E.string,gamma:E.gamma,exposure:E.exposure,type:L}}setDataType(e){return this.type=e,this}load(e,t,s,i){function n(r,a){switch(r.type){case Ht:case at:r.colorSpace=Co,r.minFilter=_s,r.magFilter=_s,r.generateMipmaps=!1,r.flipY=!0;break}t&&t(r,a)}return super.load(e,n,s,i)}}class vI{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0,this.workerCreator=null}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const s=this.workersResolve[e];if(s&&s(t),this.queue.length){const{resolve:i,msg:n,transfer:r}=this.queue.shift();this.workersResolve[e]=i,this.workers[e].postMessage(n,r)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise(s=>{const i=this._getIdleWorker();i!==-1?(this._initWorker(i),this.workerStatus|=1<<i,this.workersResolve[i]=s,this.workers[i].postMessage(e,t)):this.queue.push({resolve:s,msg:e,transfer:t})})}dispose(){this.workers.forEach(e=>e.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const LI=0,dc=2,RI=1,Ac=2,DI=0,bI=1,wI=10,_I=0,yu=9,Cu=15,Tu=16,Su=22,Bu=37,xu=43,vu=76,Lu=83,Ru=97,Du=100,bu=103,wu=109,_u=122,ku=123,Pu=131,Fu=132,Mu=133,Qu=134,Ou=137,Nu=138,Uu=139,Gu=140,Hu=141,Ku=142,$u=145,Vu=146,Yu=148,qu=152,co=153,kI=154,ho=155,PI=156,Wu=157,ju=158,Ju=165,Xu=166,zu=1000054e3,Zu=1000054001,ed=1000054004,td=1000054005,Zo=1000066e3,sd=1000066004;class Ws{constructor(e,t,s,i){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,s),this._littleEndian=i,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian)+4294967296*this._dataView.getUint32(this._offset+4,this._littleEndian);return this._offset+=8,e}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,e);return this._offset+=e,t}_skip(e){return this._offset+=e,this}_scan(e,t=0){const s=this._offset;let i=0;for(;this._dataView.getUint8(this._offset)!==t&&i<e;)i++,this._offset++;return i<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+s,i)}}const ke=[171,75,84,88,32,50,48,187,13,10,26,10];function fc(o){return new TextDecoder().decode(o)}function FI(o){const e=new Uint8Array(o.buffer,o.byteOffset,ke.length);if(e[0]!==ke[0]||e[1]!==ke[1]||e[2]!==ke[2]||e[3]!==ke[3]||e[4]!==ke[4]||e[5]!==ke[5]||e[6]!==ke[6]||e[7]!==ke[7]||e[8]!==ke[8]||e[9]!==ke[9]||e[10]!==ke[10]||e[11]!==ke[11])throw new Error("Missing KTX 2.0 identifier.");const t={vkFormat:0,typeSize:1,pixelWidth:0,pixelHeight:0,pixelDepth:0,layerCount:0,faceCount:1,levelCount:0,supercompressionScheme:0,levels:[],dataFormatDescriptor:[{vendorId:0,descriptorType:0,versionNumber:2,colorModel:0,colorPrimaries:1,transferFunction:2,flags:0,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],keyValue:{},globalData:null},s=17*Uint32Array.BYTES_PER_ELEMENT,i=new Ws(o,ke.length,s,!0);t.vkFormat=i._nextUint32(),t.typeSize=i._nextUint32(),t.pixelWidth=i._nextUint32(),t.pixelHeight=i._nextUint32(),t.pixelDepth=i._nextUint32(),t.layerCount=i._nextUint32(),t.faceCount=i._nextUint32(),t.levelCount=i._nextUint32(),t.supercompressionScheme=i._nextUint32();const n=i._nextUint32(),r=i._nextUint32(),a=i._nextUint32(),c=i._nextUint32(),l=i._nextUint64(),h=i._nextUint64(),u=3*Math.max(t.levelCount,1)*8,d=new Ws(o,ke.length+s,u,!0);for(let O=0,Q=Math.max(t.levelCount,1);O<Q;O++)t.levels.push({levelData:new Uint8Array(o.buffer,o.byteOffset+d._nextUint64(),d._nextUint64()),uncompressedByteLength:d._nextUint64()});const A=new Ws(o,n,r,!0);A._skip(4);const f=A._nextUint16(),g=A._nextUint16(),m=A._nextUint16(),E=A._nextUint16(),p={vendorId:f,descriptorType:g,versionNumber:m,colorModel:A._nextUint8(),colorPrimaries:A._nextUint8(),transferFunction:A._nextUint8(),flags:A._nextUint8(),texelBlockDimension:[A._nextUint8(),A._nextUint8(),A._nextUint8(),A._nextUint8()],bytesPlane:[A._nextUint8(),A._nextUint8(),A._nextUint8(),A._nextUint8(),A._nextUint8(),A._nextUint8(),A._nextUint8(),A._nextUint8()],samples:[]},I=(E/4-6)/4;for(let O=0;O<I;O++){const Q={bitOffset:A._nextUint16(),bitLength:A._nextUint8(),channelType:A._nextUint8(),samplePosition:[A._nextUint8(),A._nextUint8(),A._nextUint8(),A._nextUint8()],sampleLower:Number.NEGATIVE_INFINITY,sampleUpper:Number.POSITIVE_INFINITY};64&Q.channelType?(Q.sampleLower=A._nextInt32(),Q.sampleUpper=A._nextInt32()):(Q.sampleLower=A._nextUint32(),Q.sampleUpper=A._nextUint32()),p.samples[O]=Q}t.dataFormatDescriptor.length=0,t.dataFormatDescriptor.push(p);const C=new Ws(o,a,c,!0);for(;C._offset<c;){const O=C._nextUint32(),Q=C._scan(O),Y=fc(Q);if(t.keyValue[Y]=C._nextUint8Array(O-Q.byteLength-1),Y.match(/^ktx/i)){const X=fc(t.keyValue[Y]);t.keyValue[Y]=X.substring(0,X.lastIndexOf("\0"))}C._skip(O%4?4-O%4:0)}if(h<=0)return t;const T=new Ws(o,l,h,!0),L=T._nextUint16(),S=T._nextUint16(),x=T._nextUint32(),v=T._nextUint32(),B=T._nextUint32(),R=T._nextUint32(),D=[];for(let O=0,Q=Math.max(t.levelCount,1);O<Q;O++)D.push({imageFlags:T._nextUint32(),rgbSliceByteOffset:T._nextUint32(),rgbSliceByteLength:T._nextUint32(),alphaSliceByteOffset:T._nextUint32(),alphaSliceByteLength:T._nextUint32()});const b=l+T._offset,w=b+x,F=w+v,P=F+B,G=new Uint8Array(o.buffer,o.byteOffset+b,x),U=new Uint8Array(o.buffer,o.byteOffset+w,v),H=new Uint8Array(o.buffer,o.byteOffset+F,B),$=new Uint8Array(o.buffer,o.byteOffset+P,R);return t.globalData={endpointCount:L,selectorCount:S,imageDescs:D,endpointsData:G,selectorsData:U,tablesData:H,extendedData:$},t}let pr,Lt,uo;const Er={env:{emscripten_notify_memory_growth:function(o){uo=new Uint8Array(Lt.exports.memory.buffer)}}};class MI{init(){return pr||(pr=typeof fetch<"u"?fetch("data:application/wasm;base64,"+gc).then(e=>e.arrayBuffer()).then(e=>WebAssembly.instantiate(e,Er)).then(this._init):WebAssembly.instantiate(Buffer.from(gc,"base64"),Er).then(this._init),pr)}_init(e){Lt=e.instance,Er.env.emscripten_notify_memory_growth(0)}decode(e,t=0){if(!Lt)throw new Error("ZSTDDecoder: Await .init() before decoding.");const s=e.byteLength,i=Lt.exports.malloc(s);uo.set(e,i),t=t||Number(Lt.exports.ZSTD_findDecompressedSize(i,s));const n=Lt.exports.malloc(t),r=Lt.exports.ZSTD_decompress(n,t,i,s),a=uo.slice(n,n+r);return Lt.exports.free(i),Lt.exports.free(n),a}}const gc="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IAMNACAEQQNxBEADQCACRQ0FIAAgAkF/aiICaiIDIAEgAmotAAA6AAAgA0EDcQ0ACwsgAkEDTQ0AA0AgACACQXxqIgJqIAEgAmooAgA2AgAgAkEDSw0ACwsgAkUNAgNAIAAgAkF/aiICaiABIAJqLQAAOgAAIAINAAsMAgsgAkEDTQ0AIAIhBANAIAMgASgCADYCACABQQRqIQEgA0EEaiEDIARBfGoiBEEDSw0ACyACQQNxIQILIAJFDQADQCADIAEtAAA6AAAgA0EBaiEDIAFBAWohASACQX9qIgINAAsLIAAL8wICAn8BfgJAIAJFDQAgACACaiIDQX9qIAE6AAAgACABOgAAIAJBA0kNACADQX5qIAE6AAAgACABOgABIANBfWogAToAACAAIAE6AAIgAkEHSQ0AIANBfGogAToAACAAIAE6AAMgAkEJSQ0AIABBACAAa0EDcSIEaiIDIAFB/wFxQYGChAhsIgE2AgAgAyACIARrQXxxIgRqIgJBfGogATYCACAEQQlJDQAgAyABNgIIIAMgATYCBCACQXhqIAE2AgAgAkF0aiABNgIAIARBGUkNACADIAE2AhggAyABNgIUIAMgATYCECADIAE2AgwgAkFwaiABNgIAIAJBbGogATYCACACQWhqIAE2AgAgAkFkaiABNgIAIAQgA0EEcUEYciIEayICQSBJDQAgAa0iBUIghiAFhCEFIAMgBGohAQNAIAEgBTcDGCABIAU3AxAgASAFNwMIIAEgBTcDACABQSBqIQEgAkFgaiICQR9LDQALCyAACy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAIajYCACADCy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAFajYCACADCx8AIAAgASACKAIEEAg2AgAgARAEGiAAIAJBCGo2AgQLCAAgAGdBH3MLugUBDX8jAEEQayIKJAACfyAEQQNNBEAgCkEANgIMIApBDGogAyAEEAsaIAAgASACIApBDGpBBBAVIgBBbCAAEAMbIAAgACAESxsMAQsgAEEAIAEoAgBBAXRBAmoQECENQVQgAygAACIGQQ9xIgBBCksNABogAiAAQQVqNgIAIAMgBGoiAkF8aiEMIAJBeWohDiACQXtqIRAgAEEGaiELQQQhBSAGQQR2IQRBICAAdCIAQQFyIQkgASgCACEPQQAhAiADIQYCQANAIAlBAkggAiAPS3JFBEAgAiEHAkAgCARAA0AgBEH//wNxQf//A0YEQCAHQRhqIQcgBiAQSQR/IAZBAmoiBigAACAFdgUgBUEQaiEFIARBEHYLIQQMAQsLA0AgBEEDcSIIQQNGBEAgBUECaiEFIARBAnYhBCAHQQNqIQcMAQsLIAcgCGoiByAPSw0EIAVBAmohBQNAIAIgB0kEQCANIAJBAXRqQQA7AQAgAkEBaiECDAELCyAGIA5LQQAgBiAFQQN1aiIHIAxLG0UEQCAHKAAAIAVBB3EiBXYhBAwCCyAEQQJ2IQQLIAYhBwsCfyALQX9qIAQgAEF/anEiBiAAQQF0QX9qIgggCWsiEUkNABogBCAIcSIEQQAgESAEIABIG2shBiALCyEIIA0gAkEBdGogBkF/aiIEOwEAIAlBASAGayAEIAZBAUgbayEJA0AgCSAASARAIABBAXUhACALQX9qIQsMAQsLAn8gByAOS0EAIAcgBSAIaiIFQQN1aiIGIAxLG0UEQCAFQQdxDAELIAUgDCIGIAdrQQN0awshBSACQQFqIQIgBEUhCCAGKAAAIAVBH3F2IQQMAQsLQWwgCUEBRyAFQSBKcg0BGiABIAJBf2o2AgAgBiAFQQdqQQN1aiADawwBC0FQCyEAIApBEGokACAACwkAQQFBBSAAGwsMACAAIAEoAAA2AAALqgMBCn8jAEHwAGsiCiQAIAJBAWohDiAAQQhqIQtBgIAEIAVBf2p0QRB1IQxBACECQQEhBkEBIAV0IglBf2oiDyEIA0AgAiAORkUEQAJAIAEgAkEBdCINai8BACIHQf//A0YEQCALIAhBA3RqIAI2AgQgCEF/aiEIQQEhBwwBCyAGQQAgDCAHQRB0QRB1ShshBgsgCiANaiAHOwEAIAJBAWohAgwBCwsgACAFNgIEIAAgBjYCACAJQQN2IAlBAXZqQQNqIQxBACEAQQAhBkEAIQIDQCAGIA5GBEADQAJAIAAgCUYNACAKIAsgAEEDdGoiASgCBCIGQQF0aiICIAIvAQAiAkEBajsBACABIAUgAhAUayIIOgADIAEgAiAIQf8BcXQgCWs7AQAgASAEIAZBAnQiAmooAgA6AAIgASACIANqKAIANgIEIABBAWohAAwBCwsFIAEgBkEBdGouAQAhDUEAIQcDQCAHIA1ORQRAIAsgAkEDdGogBjYCBANAIAIgDGogD3EiAiAISw0ACyAHQQFqIQcMAQsLIAZBAWohBgwBCwsgCkHwAGokAAsjAEIAIAEQCSAAhUKHla+vmLbem55/fkLj3MqV/M7y9YV/fAsQACAAQn43AwggACABNgIACyQBAX8gAARAIAEoAgQiAgRAIAEoAgggACACEQEADwsgABAmCwsfACAAIAEgAi8BABAINgIAIAEQBBogACACQQRqNgIEC0oBAX9BoCAoAgAiASAAaiIAQX9MBEBBiCBBMDYCAEF/DwsCQCAAPwBBEHRNDQAgABBmDQBBiCBBMDYCAEF/DwtBoCAgADYCACABC9cBAQh/Qbp/IQoCQCACKAIEIgggAigCACIJaiIOIAEgAGtLDQBBbCEKIAkgBCADKAIAIgtrSw0AIAAgCWoiBCACKAIIIgxrIQ0gACABQWBqIg8gCyAJQQAQKSADIAkgC2o2AgACQAJAIAwgBCAFa00EQCANIQUMAQsgDCAEIAZrSw0CIAcgDSAFayIAaiIBIAhqIAdNBEAgBCABIAgQDxoMAgsgBCABQQAgAGsQDyEBIAIgACAIaiIINgIEIAEgAGshBAsgBCAPIAUgCEEBECkLIA4hCgsgCgubAgEBfyMAQYABayINJAAgDSADNgJ8AkAgAkEDSwRAQX8hCQwBCwJAAkACQAJAIAJBAWsOAwADAgELIAZFBEBBuH8hCQwEC0FsIQkgBS0AACICIANLDQMgACAHIAJBAnQiAmooAgAgAiAIaigCABA7IAEgADYCAEEBIQkMAwsgASAJNgIAQQAhCQwCCyAKRQRAQWwhCQwCC0EAIQkgC0UgDEEZSHINAUEIIAR0QQhqIQBBACECA0AgAiAATw0CIAJBQGshAgwAAAsAC0FsIQkgDSANQfwAaiANQfgAaiAFIAYQFSICEAMNACANKAJ4IgMgBEsNACAAIA0gDSgCfCAHIAggAxAYIAEgADYCACACIQkLIA1BgAFqJAAgCQsLACAAIAEgAhALGgsQACAALwAAIAAtAAJBEHRyCy8AAn9BuH8gAUEISQ0AGkFyIAAoAAQiAEF3Sw0AGkG4fyAAQQhqIgAgACABSxsLCwkAIAAgATsAAAsDAAELigYBBX8gACAAKAIAIgVBfnE2AgBBACAAIAVBAXZqQYQgKAIAIgQgAEYbIQECQAJAIAAoAgQiAkUNACACKAIAIgNBAXENACACQQhqIgUgA0EBdkF4aiIDQQggA0EISxtnQR9zQQJ0QYAfaiIDKAIARgRAIAMgAigCDDYCAAsgAigCCCIDBEAgAyACKAIMNgIECyACKAIMIgMEQCADIAIoAgg2AgALIAIgAigCACAAKAIAQX5xajYCAEGEICEAAkACQCABRQ0AIAEgAjYCBCABKAIAIgNBAXENASADQQF2QXhqIgNBCCADQQhLG2dBH3NBAnRBgB9qIgMoAgAgAUEIakYEQCADIAEoAgw2AgALIAEoAggiAwRAIAMgASgCDDYCBAsgASgCDCIDBEAgAyABKAIINgIAQYQgKAIAIQQLIAIgAigCACABKAIAQX5xajYCACABIARGDQAgASABKAIAQQF2akEEaiEACyAAIAI2AgALIAIoAgBBAXZBeGoiAEEIIABBCEsbZ0Efc0ECdEGAH2oiASgCACEAIAEgBTYCACACIAA2AgwgAkEANgIIIABFDQEgACAFNgIADwsCQCABRQ0AIAEoAgAiAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAigCACABQQhqRgRAIAIgASgCDDYCAAsgASgCCCICBEAgAiABKAIMNgIECyABKAIMIgIEQCACIAEoAgg2AgBBhCAoAgAhBAsgACAAKAIAIAEoAgBBfnFqIgI2AgACQCABIARHBEAgASABKAIAQQF2aiAANgIEIAAoAgAhAgwBC0GEICAANgIACyACQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgIoAgAhASACIABBCGoiAjYCACAAIAE2AgwgAEEANgIIIAFFDQEgASACNgIADwsgBUEBdkF4aiIBQQggAUEISxtnQR9zQQJ0QYAfaiICKAIAIQEgAiAAQQhqIgI2AgAgACABNgIMIABBADYCCCABRQ0AIAEgAjYCAAsLDgAgAARAIABBeGoQJQsLgAIBA38CQCAAQQ9qQXhxQYQgKAIAKAIAQQF2ayICEB1Bf0YNAAJAQYQgKAIAIgAoAgAiAUEBcQ0AIAFBAXZBeGoiAUEIIAFBCEsbZ0Efc0ECdEGAH2oiASgCACAAQQhqRgRAIAEgACgCDDYCAAsgACgCCCIBBEAgASAAKAIMNgIECyAAKAIMIgFFDQAgASAAKAIINgIAC0EBIQEgACAAKAIAIAJBAXRqIgI2AgAgAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAygCACECIAMgAEEIaiIDNgIAIAAgAjYCDCAAQQA2AgggAkUNACACIAM2AgALIAELtwIBA38CQAJAIABBASAAGyICEDgiAA0AAkACQEGEICgCACIARQ0AIAAoAgAiA0EBcQ0AIAAgA0EBcjYCACADQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgAgAEEIakYEQCABIAAoAgw2AgALIAAoAggiAQRAIAEgACgCDDYCBAsgACgCDCIBBEAgASAAKAIINgIACyACECchAkEAIQFBhCAoAgAhACACDQEgACAAKAIAQX5xNgIAQQAPCyACQQ9qQXhxIgMQHSICQX9GDQIgAkEHakF4cSIAIAJHBEAgACACaxAdQX9GDQMLAkBBhCAoAgAiAUUEQEGAICAANgIADAELIAAgATYCBAtBhCAgADYCACAAIANBAXRBAXI2AgAMAQsgAEUNAQsgAEEIaiEBCyABC7kDAQJ/IAAgA2ohBQJAIANBB0wEQANAIAAgBU8NAiAAIAItAAA6AAAgAEEBaiEAIAJBAWohAgwAAAsACyAEQQFGBEACQCAAIAJrIgZBB00EQCAAIAItAAA6AAAgACACLQABOgABIAAgAi0AAjoAAiAAIAItAAM6AAMgAEEEaiACIAZBAnQiBkHAHmooAgBqIgIQFyACIAZB4B5qKAIAayECDAELIAAgAhAMCyACQQhqIQIgAEEIaiEACwJAAkACQAJAIAUgAU0EQCAAIANqIQEgBEEBRyAAIAJrQQ9Kcg0BA0AgACACEAwgAkEIaiECIABBCGoiACABSQ0ACwwFCyAAIAFLBEAgACEBDAQLIARBAUcgACACa0EPSnINASAAIQMgAiEEA0AgAyAEEAwgBEEIaiEEIANBCGoiAyABSQ0ACwwCCwNAIAAgAhAHIAJBEGohAiAAQRBqIgAgAUkNAAsMAwsgACEDIAIhBANAIAMgBBAHIARBEGohBCADQRBqIgMgAUkNAAsLIAIgASAAa2ohAgsDQCABIAVPDQEgASACLQAAOgAAIAFBAWohASACQQFqIQIMAAALAAsLQQECfyAAIAAoArjgASIDNgLE4AEgACgCvOABIQQgACABNgK84AEgACABIAJqNgK44AEgACABIAQgA2tqNgLA4AELpgEBAX8gACAAKALs4QEQFjYCyOABIABCADcD+OABIABCADcDuOABIABBwOABakIANwMAIABBqNAAaiIBQYyAgOAANgIAIABBADYCmOIBIABCADcDiOEBIABCAzcDgOEBIABBrNABakHgEikCADcCACAAQbTQAWpB6BIoAgA2AgAgACABNgIMIAAgAEGYIGo2AgggACAAQaAwajYCBCAAIABBEGo2AgALYQEBf0G4fyEDAkAgAUEDSQ0AIAIgABAhIgFBA3YiADYCCCACIAFBAXE2AgQgAiABQQF2QQNxIgM2AgACQCADQX9qIgFBAksNAAJAIAFBAWsOAgEAAgtBbA8LIAAhAwsgAwsMACAAIAEgAkEAEC4LiAQCA38CfiADEBYhBCAAQQBBKBAQIQAgBCACSwRAIAQPCyABRQRAQX8PCwJAAkAgA0EBRg0AIAEoAAAiBkGo6r5pRg0AQXYhAyAGQXBxQdDUtMIBRw0BQQghAyACQQhJDQEgAEEAQSgQECEAIAEoAAQhASAAQQE2AhQgACABrTcDAEEADwsgASACIAMQLyIDIAJLDQAgACADNgIYQXIhAyABIARqIgVBf2otAAAiAkEIcQ0AIAJBIHEiBkUEQEFwIQMgBS0AACIFQacBSw0BIAVBB3GtQgEgBUEDdkEKaq2GIgdCA4h+IAd8IQggBEEBaiEECyACQQZ2IQMgAkECdiEFAkAgAkEDcUF/aiICQQJLBEBBACECDAELAkACQAJAIAJBAWsOAgECAAsgASAEai0AACECIARBAWohBAwCCyABIARqLwAAIQIgBEECaiEEDAELIAEgBGooAAAhAiAEQQRqIQQLIAVBAXEhBQJ+AkACQAJAIANBf2oiA0ECTQRAIANBAWsOAgIDAQtCfyAGRQ0DGiABIARqMQAADAMLIAEgBGovAACtQoACfAwCCyABIARqKAAArQwBCyABIARqKQAACyEHIAAgBTYCICAAIAI2AhwgACAHNwMAQQAhAyAAQQA2AhQgACAHIAggBhsiBzcDCCAAIAdCgIAIIAdCgIAIVBs+AhALIAMLWwEBf0G4fyEDIAIQFiICIAFNBH8gACACakF/ai0AACIAQQNxQQJ0QaAeaigC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C0Egak8NAQsgByAHKQNoNwMQIAcgBykDYDcDCCAEIA0gB0EIaiAHQdwAaiAPIA4gESAQEB4hCwwBCyACIARqIQggBCAKEAcgAkERTwRAIARBEGohAgNAIAIgCkEQaiIKEAcgAkEQaiICIAhJDQALCyAIIAlrIQIgByATNgJcIAkgCCAOa0sEQCAJIAggEWtLBEBBbCELDAILIBAgAiAOayICaiIKIANqIBBNBEAgCCAKIAMQDxoMAgsgCCAKQQAgAmsQDyEIIAcgAiADaiIDNgJkIAggAmshCCAOIQILIAlBEE8EQCADIAhqIQMDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALDAELAkAgCUEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgCUECdCIDQcAeaigCAGoiAhAXIAIgA0HgHmooAgBrIQIgBygCZCEDDAELIAggAhAMCyADQQlJDQAgAyAIaiEDIAhBCGoiCCACQQhqIgJrQQ9MBEADQCAIIAIQDCACQQhqIQIgCEEIaiIIIANJDQAMAgALAAsDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALCyAHQRhqEAQaIAsgDCALEAMiAhshDCAEIAQgC2ogAhshBCAFQX9qIgUNAAsgDBADDQFBbCEMIAdBGGoQBEECSQ0BQQAhCANAIAhBA0cEQCAAIAhBAnQiAmpBrNABaiACIAdqKAJENgIAIAhBAWohCAwBCwsgBygCXCEIC0G6fyEMIA8gCGsiACANIARrSw0AIAQEfyAEIAggABALIABqBUEACyABayEMCyAHQfAAaiQAIAwLkRcCFn8FfiMAQdABayIHJAAgByAAKALw4QEiCDYCvAEgASACaiESIAggACgCgOIBaiETAkACQCAFRQRAIAEhAwwBCyAAKALE4AEhESAAKALA4AEhFSAAKAK84AEhDyAAQQE2AozhAUEAIQgDQCAIQQNHBEAgByAIQQJ0IgJqIAAgAmpBrNABaigCADYCVCAIQQFqIQgMAQsLIAcgETYCZCAHIA82AmAgByABIA9rNgJoQWwhECAHQShqIAMgBBAGEAMNASAFQQQgBUEESBshFyAHQTxqIAdBKGogACgCABATIAdBxABqIAdBKGogACgCCBATIAdBzABqIAdB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IAdB0AFqJAAgEAslACAAQgA3AgAgAEEAOwEIIABBADoACyAAIAE2AgwgACACOgAKC7QFAQN/IwBBMGsiBCQAIABB/wFqIgVBfWohBgJAIAMvAQIEQCAEQRhqIAEgAhAGIgIQAw0BIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahASOgAAIAMgBEEIaiAEQRhqEBI6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0FIAEgBEEQaiAEQRhqEBI6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBSABIARBCGogBEEYahASOgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEjoAACABIAJqIABrIQIMAwsgAyAEQRBqIARBGGoQEjoAAiADIARBCGogBEEYahASOgADIANBBGohAwwAAAsACyAEQRhqIAEgAhAGIgIQAw0AIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahAROgAAIAMgBEEIaiAEQRhqEBE6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0EIAEgBEEQaiAEQRhqEBE6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBCABIARBCGogBEEYahAROgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEToAACABIAJqIABrIQIMAgsgAyAEQRBqIARBGGoQEToAAiADIARBCGogBEEYahAROgADIANBBGohAwwAAAsACyAEQTBqJAAgAgtpAQF/An8CQAJAIAJBB00NACABKAAAQbfIwuF+Rw0AIAAgASgABDYCmOIBQWIgAEEQaiABIAIQPiIDEAMNAhogAEKBgICAEDcDiOEBIAAgASADaiACIANrECoMAQsgACABIAIQKgtBAAsLrQMBBn8jAEGAAWsiAyQAQWIhCAJAIAJBCUkNACAAQZjQAGogAUEIaiIEIAJBeGogAEGY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wOABCwutAgIEfwF+IwBBQGoiBCQAAkACQCACQQhJDQAgASgAAEFwcUHQ1LTCAUcNACABIAIQIiEBIABCADcDCCAAQQA2AgQgACABNgIADAELIARBGGogASACEC0iAxADBEAgACADEBoMAQsgAwRAIABBuH8QGgwBCyACIAQoAjAiA2shAiABIANqIQMDQAJAIAAgAyACIARBCGoQLCIFEAMEfyAFBSACIAVBA2oiBU8NAUG4fwsQGgwCCyAGQQFqIQYgAiAFayECIAMgBWohAyAEKAIMRQ0ACyAEKAI4BEAgAkEDTQRAIABBuH8QGgwCCyADQQRqIQMLIAQoAighAiAEKQMYIQcgAEEANgIEIAAgAyABazYCACAAIAIgBmytIAcgB0J/URs3AwgLIARBQGskAAslAQF/IwBBEGsiAiQAIAIgACABEFEgAigCACEAIAJBEGokACAAC30BBH8jAEGQBGsiBCQAIARB/wE2AggCQCAEQRBqIARBCGogBEEMaiABIAIQFSIGEAMEQCAGIQUMAQtBVCEFIAQoAgwiB0EGSw0AIAMgBEEQaiAEKAIIIAcQQSIFEAMNACAAIAEgBmogAiAGayADEDwhBQsgBEGQBGokACAFC4cBAgJ/An5BABAWIQMCQANAIAEgA08EQAJAIAAoAABBcHFB0NS0wgFGBEAgACABECIiAhADRQ0BQn4PCyAAIAEQVSIEQn1WDQMgBCAFfCIFIARUIQJCfiEEIAINAyAAIAEQUiICEAMNAwsgASACayEBIAAgAmohAAwBCwtCfiAFIAEbIQQLIAQLPwIBfwF+IwBBMGsiAiQAAn5CfiACQQhqIAAgARAtDQAaQgAgAigCHEEBRg0AGiACKQMICyEDIAJBMGokACADC40BAQJ/IwBBMGsiASQAAkAgAEUNACAAKAKI4gENACABIABB/OEBaigCADYCKCABIAApAvThATcDICAAEDAgACgCqOIBIQIgASABKAIoNgIYIAEgASkDIDcDECACIAFBEGoQGyAAQQA2AqjiASABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALKgECfyMAQRBrIgAkACAAQQA2AgggAEIANwMAIAAQWCEBIABBEGokACABC4cBAQN/IwBBEGsiAiQAAkAgACgCAEUgACgCBEVzDQAgAiAAKAIINgIIIAIgACkCADcDAAJ/IAIoAgAiAQRAIAIoAghBqOMJIAERBQAMAQtBqOMJECgLIgFFDQAgASAAKQIANwL04QEgAUH84QFqIAAoAgg2AgAgARBZIAEhAwsgAkEQaiQAIAMLywEBAn8jAEEgayIBJAAgAEGBgIDAADYCtOIBIABBADYCiOIBIABBADYC7OEBIABCADcDkOIBIABBADYCpOMJIABBADYC3OIBIABCADcCzOIBIABBADYCvOIBIABBADYCxOABIABCADcCnOIBIABBpOIBakIANwIAIABBrOIBakEANgIAIAFCADcCECABQgA3AhggASABKQMYNwMIIAEgASkDEDcDACABKAIIQQh2QQFxIQIgAEEANgLg4gEgACACNgKM4gEgAUEgaiQAC3YBA38jAEEwayIBJAAgAARAIAEgAEHE0AFqIgIoAgA2AiggASAAKQK80AE3AyAgACgCACEDIAEgAigCADYCGCABIAApArzQATcDECADIAFBEGoQGyABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALzAEBAX8gACABKAK00AE2ApjiASAAIAEoAgQiAjYCwOABIAAgAjYCvOABIAAgAiABKAIIaiICNgK44AEgACACNgLE4AEgASgCuNABBEAgAEKBgICAEDcDiOEBIAAgAUGk0ABqNgIMIAAgAUGUIGo2AgggACABQZwwajYCBCAAIAFBDGo2AgAgAEGs0AFqIAFBqNABaigCADYCACAAQbDQAWogAUGs0AFqKAIANgIAIABBtNABaiABQbDQAWooAgA2AgAPCyAAQgA3A4jhAQs7ACACRQRAQbp/DwsgBEUEQEFsDwsgAiAEEGAEQCAAIAEgAiADIAQgBRBhDwsgACABIAIgAyAEIAUQZQtGAQF/IwBBEGsiBSQAIAVBCGogBBAOAn8gBS0ACQRAIAAgASACIAMgBBAyDAELIAAgASACIAMgBBA0CyEAIAVBEGokACAACzQAIAAgAyAEIAUQNiIFEAMEQCAFDwsgBSAESQR/IAEgAiADIAVqIAQgBWsgABA1BUG4fwsLRgEBfyMAQRBrIgUkACAFQQhqIAQQDgJ/IAUtAAkEQCAAIAEgAiADIAQQYgwBCyAAIAEgAiADIAQQNQshACAFQRBqJAAgAAtZAQF/QQ8hAiABIABJBEAgAUEEdCAAbiECCyAAQQh2IgEgAkEYbCIAQYwIaigCAGwgAEGICGooAgBqIgJBA3YgAmogAEGACGooAgAgAEGECGooAgAgAWxqSQs3ACAAIAMgBCAFQYAQEDMiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQMgVBuH8LC78DAQN/IwBBIGsiBSQAIAVBCGogAiADEAYiAhADRQRAIAAgAWoiB0F9aiEGIAUgBBAOIARBBGohAiAFLQACIQMDQEEAIAAgBkkgBUEIahAEGwRAIAAgAiAFQQhqIAMQAkECdGoiBC8BADsAACAFQQhqIAQtAAIQASAAIAQtAANqIgQgAiAFQQhqIAMQAkECdGoiAC8BADsAACAFQQhqIAAtAAIQASAEIAAtAANqIQAMAQUgB0F+aiEEA0AgBUEIahAEIAAgBEtyRQRAIAAgAiAFQQhqIAMQAkECdGoiBi8BADsAACAFQQhqIAYtAAIQASAAIAYtAANqIQAMAQsLA0AgACAES0UEQCAAIAIgBUEIaiADEAJBAnRqIgYvAQA7AAAgBUEIaiAGLQACEAEgACAGLQADaiEADAELCwJAIAAgB08NACAAIAIgBUEIaiADEAIiA0ECdGoiAC0AADoAACAALQADQQFGBEAgBUEIaiAALQACEAEMAQsgBSgCDEEfSw0AIAVBCGogAiADQQJ0ai0AAhABIAUoAgxBIUkNACAFQSA2AgwLIAFBbCAFQQhqEAobIQILCwsgBUEgaiQAIAILkgIBBH8jAEFAaiIJJAAgCSADQTQQCyEDAkAgBEECSA0AIAMgBEECdGooAgAhCSADQTxqIAgQIyADQQE6AD8gAyACOgA+QQAhBCADKAI8IQoDQCAEIAlGDQEgACAEQQJ0aiAKNgEAIARBAWohBAwAAAsAC0EAIQkDQCAGIAlGRQRAIAMgBSAJQQF0aiIKLQABIgtBAnRqIgwoAgAhBCADQTxqIAotAABBCHQgCGpB//8DcRAjIANBAjoAPyADIAcgC2siCiACajoAPiAEQQEgASAKa3RqIQogAygCPCELA0AgACAEQQJ0aiALNgEAIARBAWoiBCAKSQ0ACyAMIAo2AgAgCUEBaiEJDAELCyADQUBrJAALowIBCX8jAEHQAGsiCSQAIAlBEGogBUE0EAsaIAcgBmshDyAHIAFrIRADQAJAIAMgCkcEQEEBIAEgByACIApBAXRqIgYtAAEiDGsiCGsiC3QhDSAGLQAAIQ4gCUEQaiAMQQJ0aiIMKAIAIQYgCyAPTwRAIAAgBkECdGogCyAIIAUgCEE0bGogCCAQaiIIQQEgCEEBShsiCCACIAQgCEECdGooAgAiCEEBdGogAyAIayAHIA4QYyAGIA1qIQgMAgsgCUEMaiAOECMgCUEBOgAPIAkgCDoADiAGIA1qIQggCSgCDCELA0AgBiAITw0CIAAgBkECdGogCzYBACAGQQFqIQYMAAALAAsgCUHQAGokAA8LIAwgCDYCACAKQQFqIQoMAAALAAs0ACAAIAMgBCAFEDYiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQNAVBuH8LCyMAIAA/AEEQdGtB//8DakEQdkAAQX9GBEBBAA8LQQAQAEEBCzsBAX8gAgRAA0AgACABIAJBgCAgAkGAIEkbIgMQCyEAIAFBgCBqIQEgAEGAIGohACACIANrIgINAAsLCwYAIAAQAwsLqBUJAEGICAsNAQAAAAEAAAACAAAAAgBBoAgLswYBAAAAAQAAAAIAAAACAAAAJgAAAIIAAAAhBQAASgAAAGcIAAAmAAAAwAEAAIAAAABJBQAASgAAAL4IAAApAAAALAIAAIAAAABJBQAASgAAAL4IAAAvAAAAygIAAIAAAACKBQAASgAAAIQJAAA1AAAAcwMAAIAAAACdBQAASgAAAKAJAAA9AAAAgQMAAIAAAADrBQAASwAAAD4KAABEAAAAngMAAIAAAABNBgAASwAAAKoKAABLAAAAswMAAIAAAADBBgAATQAAAB8NAABNAAAAUwQAAIAAAAAjCAAAUQAAAKYPAABUAAAAmQQAAIAAAABLCQAAVwAAALESAABYAAAA2gQAAIAAAABvCQAAXQAAACMUAABUAAAARQUAAIAAAABUCgAAagAAAIwUAABqAAAArwUAAIAAAAB2CQAAfAAAAE4QAAB8AAAA0gIAAIAAAABjBwAAkQAAAJAHAACSAAAAAAAAAAEAAAABAAAABQAAAA0AAAAdAAAAPQAAAH0AAAD9AAAA/QEAAP0DAAD9BwAA/Q8AAP0fAAD9PwAA/X8AAP3/AAD9/wEA/f8DAP3/BwD9/w8A/f8fAP3/PwD9/38A/f//AP3//wH9//8D/f//B/3//w/9//8f/f//P/3//38AAAAAAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABEAAAASAAAAEwAAABQAAAAVAAAAFgAAABcAAAAYAAAAGQAAABoAAAAbAAAAHAAAAB0AAAAeAAAAHwAAAAMAAAAEAAAABQAAAAYAAAAHAAAACAAAAAkAAAAKAAAACwAAAAwAAAANAAAADgAAAA8AAAAQAAAAEQAAABIAAAATAAAAFAAAABUAAAAWAAAAFwAAABgAAAAZAAAAGgAAABsAAAAcAAAAHQAAAB4AAAAfAAAAIAAAACEAAAAiAAAAIwAAACUAAAAnAAAAKQAAACsAAAAvAAAAMwAAADsAAABDAAAAUwAAAGMAAACDAAAAAwEAAAMCAAADBAAAAwgAAAMQAAADIAAAA0AAAAOAAAADAAEAQeAPC1EBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAEAAAABQAAAAcAAAAIAAAACQAAAAoAAAALAAAADAAAAA0AAAAOAAAADwAAABAAQcQQC4sBAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABIAAAAUAAAAFgAAABgAAAAcAAAAIAAAACgAAAAwAAAAQAAAAIAAAAAAAQAAAAIAAAAEAAAACAAAABAAAAAgAAAAQAAAAIAAAAAAAQBBkBIL5gQBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAAAEAAAAEAAAACAAAAAAAAAABAAEBBgAAAAAAAAQAAAAAEAAABAAAAAAgAAAFAQAAAAAAAAUDAAAAAAAABQQAAAAAAAAFBgAAAAAAAAUHAAAAAAAABQkAAAAAAAAFCgAAAAAAAAUMAAAAAAAABg4AAAAAAAEFEAAAAAAAAQUUAAAAAAABBRYAAAAAAAIFHAAAAAAAAwUgAAAAAAAEBTAAAAAgAAYFQAAAAAAABwWAAAAAAAAIBgABAAAAAAoGAAQAAAAADAYAEAAAIAAABAAAAAAAAAAEAQAAAAAAAAUCAAAAIAAABQQAAAAAAAAFBQAAACAAAAUHAAAAAAAABQgAAAAgAAAFCgAAAAAAAAULAAAAAAAABg0AAAAgAAEFEAAAAAAAAQUSAAAAIAABBRYAAAAAAAIFGAAAACAAAwUgAAAAAAADBSgAAAAAAAYEQAAAABAABgRAAAAAIAAHBYAAAAAAAAkGAAIAAAAACwYACAAAMAAABAAAAAAQAAAEAQAAACAAAAUCAAAAIAAABQMAAAAgAAAFBQAAACAAAAUGAAAAIAAABQgAAAAgAAAFCQAAACAAAAULAAAAIAAABQwAAAAAAAAGDwAAACAAAQUSAAAAIAABBRQAAAAgAAIFGAAAACAAAgUcAAAAIAADBSgAAAAgAAQFMAAAAAAAEAYAAAEAAAAPBgCAAAAAAA4GAEAAAAAADQYAIABBgBcLhwIBAAEBBQAAAAAAAAUAAAAAAAAGBD0AAAAAAAkF/QEAAAAADwX9fwAAAAAVBf3/HwAAAAMFBQAAAAAABwR9AAAAAAAMBf0PAAAAABIF/f8DAAAAFwX9/38AAAAFBR0AAAAAAAgE/QAAAAAADgX9PwAAAAAUBf3/DwAAAAIFAQAAABAABwR9AAAAAAALBf0HAAAAABEF/f8BAAAAFgX9/z8AAAAEBQ0AAAAQAAgE/QAAAAAADQX9HwAAAAATBf3/BwAAAAEFAQAAABAABgQ9AAAAAAAKBf0DAAAAABAF/f8AAAAAHAX9//8PAAAbBf3//wcAABoF/f//AwAAGQX9//8BAAAYBf3//wBBkBkLhgQBAAEBBgAAAAAAAAYDAAAAAAAABAQAAAAgAAAFBQAAAAAAAAUGAAAAAAAABQgAAAAAAAAFCQAAAAAAAAULAAAAAAAABg0AAAAAAAAGEAAAAAAAAAYTAAAAAAAABhYAAAAAAAAGGQAAAAAAAAYcAAAAAAAABh8AAAAAAAAGIgAAAAAAAQYlAAAAAAABBikAAAAAAAIGLwAAAAAAAwY7AAAAAAAEBlMAAAAAAAcGgwAAAAAACQYDAgAAEAAABAQAAAAAAAAEBQAAACAAAAUGAAAAAAAABQcAAAAgAAAFCQAAAAAAAAUKAAAAAAAABgwAAAAAAAAGDwAAAAAAAAYSAAAAAAAABhUAAAAAAAAGGAAAAAAAAAYbAAAAAAAABh4AAAAAAAAGIQAAAAAAAQYjAAAAAAABBicAAAAAAAIGKwAAAAAAAwYzAAAAAAAEBkMAAAAAAAUGYwAAAAAACAYDAQAAIAAABAQAAAAwAAAEBAAAABAAAAQFAAAAIAAABQcAAAAgAAAFCAAAACAAAAUKAAAAIAAABQsAAAAAAAAGDgAAAAAAAAYRAAAAAAAABhQAAAAAAAAGFwAAAAAAAAYaAAAAAAAABh0AAAAAAAAGIAAAAAAAEAYDAAEAAAAPBgOAAAAAAA4GA0AAAAAADQYDIAAAAAAMBgMQAAAAAAsGAwgAAAAACgYDBABBpB0L2QEBAAAAAwAAAAcAAAAPAAAAHwAAAD8AAAB/AAAA/wAAAP8BAAD/AwAA/wcAAP8PAAD/HwAA/z8AAP9/AAD//wAA//8BAP//AwD//wcA//8PAP//HwD//z8A//9/AP///wD///8B////A////wf///8P////H////z////9/AAAAAAEAAAACAAAABAAAAAAAAAACAAAABAAAAAgAAAAAAAAAAQAAAAIAAAABAAAABAAAAAQAAAAEAAAABAAAAAgAAAAIAAAACAAAAAcAAAAIAAAACQAAAAoAAAALAEGgIAsDwBBQ",QI="display-p3",OI="display-p3-linear";({...Dc.spaces[ei]});const Ir=new WeakMap;let yr=0,Cr;class ze extends Rc{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new vI,this.workerSourceURL="",this.workerConfig=null,typeof MSC_TRANSCODER<"u"&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}async detectSupportAsync(e){return console.warn('KTX2Loader: "detectSupportAsync()" has been deprecated. Use "detectSupport()" and "await renderer.init();" when creating the renderer.'),await e.init(),this.detectSupport(e)}detectSupport(e){return e.isWebGPURenderer===!0?this.workerConfig={astcSupported:e.hasFeature("texture-compression-astc"),astcHDRSupported:!1,etc1Supported:e.hasFeature("texture-compression-etc1"),etc2Supported:e.hasFeature("texture-compression-etc2"),dxtSupported:e.hasFeature("texture-compression-s3tc"),bptcSupported:e.hasFeature("texture-compression-bc"),pvrtcSupported:e.hasFeature("texture-compression-pvrtc")}:(this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),astcHDRSupported:e.extensions.has("WEBGL_compressed_texture_astc")&&e.extensions.get("WEBGL_compressed_texture_astc").getSupportedProfiles().includes("hdr"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},typeof navigator<"u"&&navigator.platform.indexOf("Linux")>=0&&navigator.userAgent.indexOf("Firefox")>=0&&this.workerConfig.astcSupported&&this.workerConfig.etc2Supported&&this.workerConfig.bptcSupported&&this.workerConfig.dxtSupported&&(this.workerConfig.astcSupported=!1,this.workerConfig.etc2Supported=!1)),this}init(){if(!this.transcoderPending){const e=new Zs(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);const t=e.loadAsync("basis_transcoder.js"),s=new Zs(this.manager);s.setPath(this.transcoderPath),s.setResponseType("arraybuffer"),s.setWithCredentials(this.withCredentials);const i=s.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([t,i]).then(([n,r])=>{const a=ze.BasisWorker.toString(),c=["/* constants */","let _EngineFormat = "+JSON.stringify(ze.EngineFormat),"let _EngineType = "+JSON.stringify(ze.EngineType),"let _TranscoderFormat = "+JSON.stringify(ze.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(ze.BasisFormat),"/* basis_transcoder.js */",n,"/* worker */",a.substring(a.indexOf("{")+1,a.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([c])),this.transcoderBinary=r,this.workerPool.setWorkerCreator(()=>{const l=new Worker(this.workerSourceURL),h=this.transcoderBinary.slice(0);return l.postMessage({type:"init",config:this.workerConfig,transcoderBinary:h},[h]),l})}),yr>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),yr++}return this.transcoderPending}load(e,t,s,i){if(this.workerConfig===null)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const n=new Zs(this.manager);n.setPath(this.path),n.setCrossOrigin(this.crossOrigin),n.setWithCredentials(this.withCredentials),n.setRequestHeader(this.requestHeader),n.setResponseType("arraybuffer"),n.load(e,r=>{this.parse(r,t,i)},s,i)}parse(e,t,s){if(this.workerConfig===null)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");if(Ir.has(e))return Ir.get(e).promise.then(t).catch(s);this._createTexture(e).then(i=>t?t(i):null).catch(s)}_createTextureFrom(e,t){const{type:s,error:i,data:{faces:n,width:r,height:a,format:c,type:l,dfdFlags:h}}=e;if(s==="error")return Promise.reject(i);let u;if(t.faceCount===6)u=new Nd(n,c,l);else{const d=n[0].mipmaps;u=t.layerCount>1?new Ud(d,r,a,t.layerCount,c,l):new bc(d,r,a,c,l)}return u.minFilter=n[0].mipmaps.length===1?_s:wc,u.magFilter=_s,u.generateMipmaps=!1,u.needsUpdate=!0,u.colorSpace=id(t),u.premultiplyAlpha=!!(h&RI),u}async _createTexture(e,t={}){const s=FI(new Uint8Array(e)),i=s.vkFormat===Zo&&s.dataFormatDescriptor[0].colorModel===167;if(!(s.vkFormat===_I||i&&!this.workerConfig.astcHDRSupported))return UI(s);const r=t,a=this.init().then(()=>this.workerPool.postMessage({type:"transcode",buffer:e,taskConfig:r},[e])).then(c=>this._createTextureFrom(c.data,s));return Ir.set(e,{promise:a}),a}dispose(){this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),yr--}}ze.BasisFormat={ETC1S:0,UASTC:1,UASTC_HDR:2};ze.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16,BC6H:22,RGB_HALF:24,RGBA_HALF:25};ze.EngineFormat={RGBAFormat:Bs,RGBA_ASTC_4x4_Format:ji,RGB_BPTC_UNSIGNED_Format:tA,RGBA_BPTC_Format:Dr,RGBA_ETC2_EAC_Format:kc,RGBA_PVRTC_4BPPV1_Format:Rr,RGBA_S3TC_DXT5_Format:eA,RGB_ETC1_Format:Zd,RGB_ETC2_Format:_c,RGB_PVRTC_4BPPV1_Format:zd,RGBA_S3TC_DXT1_Format:br};ze.EngineType={UnsignedByteType:se,HalfFloatType:at,FloatType:Ht};ze.BasisWorker=function(){let o,e,t;const s=_EngineFormat,i=_EngineType,n=_TranscoderFormat,r=_BasisFormat;self.addEventListener("message",function(f){const g=f.data;switch(g.type){case"init":o=g.config,a(g.transcoderBinary);break;case"transcode":e.then(()=>{try{const{faces:m,buffers:E,width:p,height:I,hasAlpha:C,format:T,type:L,dfdFlags:S}=c(g.buffer);self.postMessage({type:"transcode",id:g.id,data:{faces:m,width:p,height:I,hasAlpha:C,format:T,type:L,dfdFlags:S}},E)}catch(m){console.error(m),self.postMessage({type:"error",id:g.id,error:m.message})}});break}});function a(f){e=new Promise(g=>{t={wasmBinary:f,onRuntimeInitialized:g},BASIS(t)}).then(()=>{t.initializeBasis(),t.KTX2File===void 0&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")})}function c(f){const g=new t.KTX2File(new Uint8Array(f));function m(){g.close(),g.delete()}if(!g.isValid())throw m(),new Error("THREE.KTX2Loader:	Invalid or unsupported .ktx2 file");let E;if(g.isUASTC())E=r.UASTC;else if(g.isETC1S())E=r.ETC1S;else if(g.isHDR())E=r.UASTC_HDR;else throw new Error("THREE.KTX2Loader: Unknown Basis encoding");const p=g.getWidth(),I=g.getHeight(),C=g.getLayers()||1,T=g.getLevels(),L=g.getFaces(),S=g.getHasAlpha(),x=g.getDFDFlags(),{transcoderFormat:v,engineFormat:B,engineType:R}=u(E,p,I,S);if(!p||!I||!T)throw m(),new Error("THREE.KTX2Loader:	Invalid texture");if(!g.startTranscoding())throw m(),new Error("THREE.KTX2Loader: .startTranscoding failed");const D=[],b=[];for(let w=0;w<L;w++){const F=[];for(let P=0;P<T;P++){const G=[];let U,H;for(let O=0;O<C;O++){const Q=g.getImageLevelInfo(P,O,w);w===0&&P===0&&O===0&&(Q.origWidth%4!==0||Q.origHeight%4!==0)&&console.warn("THREE.KTX2Loader: ETC1S and UASTC textures should use multiple-of-four dimensions."),T>1?(U=Q.origWidth,H=Q.origHeight):(U=Q.width,H=Q.height);let Y=new Uint8Array(g.getImageTranscodedSizeInBytes(P,O,0,v));const X=g.transcodeImage(Y,P,O,w,v,0,-1,-1);if(R===i.HalfFloatType&&(Y=new Uint16Array(Y.buffer,Y.byteOffset,Y.byteLength/Uint16Array.BYTES_PER_ELEMENT)),!X)throw m(),new Error("THREE.KTX2Loader: .transcodeImage failed.");G.push(Y)}const $=A(G);F.push({data:$,width:U,height:H}),b.push($.buffer)}D.push({mipmaps:F,width:p,height:I,format:B,type:R})}return m(),{faces:D,buffers:b,width:p,height:I,hasAlpha:S,dfdFlags:x,format:B,type:R}}const l=[{if:"astcSupported",basisFormat:[r.UASTC],transcoderFormat:[n.ASTC_4x4,n.ASTC_4x4],engineFormat:[s.RGBA_ASTC_4x4_Format,s.RGBA_ASTC_4x4_Format],engineType:[i.UnsignedByteType],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[r.ETC1S,r.UASTC],transcoderFormat:[n.BC7_M5,n.BC7_M5],engineFormat:[s.RGBA_BPTC_Format,s.RGBA_BPTC_Format],engineType:[i.UnsignedByteType],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[r.ETC1S,r.UASTC],transcoderFormat:[n.BC1,n.BC3],engineFormat:[s.RGBA_S3TC_DXT1_Format,s.RGBA_S3TC_DXT5_Format],engineType:[i.UnsignedByteType],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[r.ETC1S,r.UASTC],transcoderFormat:[n.ETC1,n.ETC2],engineFormat:[s.RGB_ETC2_Format,s.RGBA_ETC2_EAC_Format],engineType:[i.UnsignedByteType],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[r.ETC1S,r.UASTC],transcoderFormat:[n.ETC1],engineFormat:[s.RGB_ETC1_Format],engineType:[i.UnsignedByteType],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[r.ETC1S,r.UASTC],transcoderFormat:[n.PVRTC1_4_RGB,n.PVRTC1_4_RGBA],engineFormat:[s.RGB_PVRTC_4BPPV1_Format,s.RGBA_PVRTC_4BPPV1_Format],engineType:[i.UnsignedByteType],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0},{if:"bptcSupported",basisFormat:[r.UASTC_HDR],transcoderFormat:[n.BC6H],engineFormat:[s.RGB_BPTC_UNSIGNED_Format],engineType:[i.HalfFloatType],priorityHDR:1,needsPowerOfTwo:!1},{basisFormat:[r.ETC1S,r.UASTC],transcoderFormat:[n.RGBA32,n.RGBA32],engineFormat:[s.RGBAFormat,s.RGBAFormat],engineType:[i.UnsignedByteType,i.UnsignedByteType],priorityETC1S:100,priorityUASTC:100,needsPowerOfTwo:!1},{basisFormat:[r.UASTC_HDR],transcoderFormat:[n.RGBA_HALF],engineFormat:[s.RGBAFormat],engineType:[i.HalfFloatType],priorityHDR:100,needsPowerOfTwo:!1}],h={[r.ETC1S]:l.filter(f=>f.basisFormat.includes(r.ETC1S)).sort((f,g)=>f.priorityETC1S-g.priorityETC1S),[r.UASTC]:l.filter(f=>f.basisFormat.includes(r.UASTC)).sort((f,g)=>f.priorityUASTC-g.priorityUASTC),[r.UASTC_HDR]:l.filter(f=>f.basisFormat.includes(r.UASTC_HDR)).sort((f,g)=>f.priorityHDR-g.priorityHDR)};function u(f,g,m,E){const p=h[f];for(let I=0;I<p.length;I++){const C=p[I];if(C.if&&!o[C.if]||!C.basisFormat.includes(f)||E&&C.transcoderFormat.length<2||C.needsPowerOfTwo&&!(d(g)&&d(m)))continue;const T=C.transcoderFormat[E?1:0],L=C.engineFormat[E?1:0],S=C.engineType[0];return{transcoderFormat:T,engineFormat:L,engineType:S}}throw new Error("THREE.KTX2Loader: Failed to identify transcoding target.")}function d(f){return f<=2?!0:(f&f-1)===0&&f!==0}function A(f){if(f.length===1)return f[0];let g=0;for(let p=0;p<f.length;p++){const I=f[p];g+=I.byteLength}const m=new Uint8Array(g);let E=0;for(let p=0;p<f.length;p++){const I=f[p];m.set(I,E),E+=I.byteLength}return m}};const NI=new Set([Bs,wr,Js,js]),Tr={[wu]:Bs,[bu]:Js,[Du]:js,[Ru]:Bs,[Lu]:Js,[vu]:js,[xu]:Bs,[Bu]:Bs,[Su]:Js,[Tu]:Js,[Cu]:js,[yu]:js,[ku]:wr,[_u]:wr,[qu]:kc,[Yu]:_c,[co]:Wd,[kI]:qd,[ho]:Yd,[PI]:Vd,[Zo]:ji,[ju]:ji,[Wu]:ji,[sd]:Dn,[Xu]:Dn,[Ju]:Dn,[Qu]:br,[Mu]:br,[Fu]:ma,[Pu]:ma,[Nu]:ga,[Ou]:ga,[Gu]:$d,[Uu]:Kd,[Ku]:Hd,[Hu]:Gd,[Vu]:Dr,[$u]:Dr,[td]:Rr,[Zu]:Rr,[ed]:fa,[zu]:fa},ys={[wu]:Ht,[bu]:Ht,[Du]:Ht,[Ru]:at,[Lu]:at,[vu]:at,[xu]:se,[Bu]:se,[Su]:se,[Tu]:se,[Cu]:se,[yu]:se,[ku]:Fc,[_u]:Pc,[qu]:se,[Yu]:se,[co]:se,[co]:se,[ho]:se,[ho]:se,[Zo]:at,[ju]:se,[Wu]:se,[sd]:at,[Xu]:se,[Ju]:se,[Qu]:se,[Mu]:se,[Fu]:se,[Pu]:se,[Nu]:se,[Ou]:se,[Gu]:se,[Uu]:se,[Ku]:se,[Hu]:se,[Vu]:se,[$u]:se,[td]:se,[Zu]:se,[ed]:se,[zu]:se};async function UI(o){const{vkFormat:e}=o;if(Tr[e]===void 0)throw new Error("THREE.KTX2Loader: Unsupported vkFormat: "+e);ys[e]===void 0&&console.warn('THREE.KTX2Loader: Missing ".type" for vkFormat: '+e);let t;o.supercompressionScheme===dc&&(Cr||(Cr=new Promise(async r=>{const a=new MI;await a.init(),r(a)})),t=await Cr);const s=[];for(let r=0;r<o.levels.length;r++){const a=Math.max(1,o.pixelWidth>>r),c=Math.max(1,o.pixelHeight>>r),l=o.pixelDepth?Math.max(1,o.pixelDepth>>r):0,h=o.levels[r];let u;if(o.supercompressionScheme===LI)u=h.levelData;else if(o.supercompressionScheme===dc)u=t.decode(h.levelData,h.uncompressedByteLength);else throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");let d;ys[e]===Ht?d=new Float32Array(u.buffer,u.byteOffset,u.byteLength/Float32Array.BYTES_PER_ELEMENT):ys[e]===at?d=new Uint16Array(u.buffer,u.byteOffset,u.byteLength/Uint16Array.BYTES_PER_ELEMENT):ys[e]===Fc||ys[e]===Pc?d=new Uint32Array(u.buffer,u.byteOffset,u.byteLength/Uint32Array.BYTES_PER_ELEMENT):d=u,s.push({data:d,width:a,height:c,depth:l})}const i=o.levelCount===0||s.length>1;let n;if(NI.has(Tr[e]))n=o.pixelDepth===0?new jd(s[0].data,o.pixelWidth,o.pixelHeight):new Jd(s[0].data,o.pixelWidth,o.pixelHeight,o.pixelDepth),n.minFilter=i?Xd:pa,n.magFilter=pa,n.generateMipmaps=o.levelCount===0;else{if(o.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");n=new bc(s,o.pixelWidth,o.pixelHeight),n.minFilter=i?wc:_s,n.magFilter=_s}return n.mipmaps=s,n.type=ys[e],n.format=Tr[e],n.colorSpace=id(o),n.needsUpdate=!0,Promise.resolve(n)}function id(o){const e=o.dataFormatDescriptor[0];return e.colorPrimaries===bI?e.transferFunction===Ac?ei:Co:e.colorPrimaries===wI?e.transferFunction===Ac?QI:OI:e.colorPrimaries===DI?Aa:(console.warn(`THREE.KTX2Loader: Unsupported color primaries, "${e.colorPrimaries}"`),Aa)}const GI={key:0,class:"play"},HI=sA({__name:"cinema",setup(o){const e=ya(),t=TI();let s;const i=ya(!1),n=new iA,r=new nA,a=new ri;let c,l,h,u;const d=new bn(.034,3.5,-7.14);let A=null,f=!1;rA(async()=>{A=e.value,l=new oA({antialias:!0});const E=Math.min(window.devicePixelRatio||1,2);l.setPixelRatio(E),l.setSize(A.clientWidth,A.clientHeight,!1),l.toneMapping=aA,l.toneMappingExposure=.6,l.shadowMap.enabled=!0,l.domElement.style.display="block",A.appendChild(l.domElement);const p=a.dom;p.style.position="absolute",p.style.top="0",p.style.right="0",p.style.left="auto",A.appendChild(p),c=new lA(70,A.clientWidth/A.clientHeight,.05,1e3),c.rotation.order="YXZ",c.position.copy(d),c.lookAt(d.x,d.y,d.z+1),h=new cA(c,l.domElement),h.enableDamping=!0,h.dampingFactor=.1,h.rotateSpeed=1,h.maxPolarAngle=Math.PI/2,h.target.set(d.x,d.y,d.z+1);const I=16777215,C=.6,T=new hA(I,C);T.position.set(-.13,2.51,2.27),T.target.position.set(0,1,0),T.castShadow=!0,T.shadow.camera.top=10,T.shadow.camera.bottom=-10,T.shadow.camera.left=-10,T.shadow.camera.right=10,T.shadow.mapSize.width=1024,T.shadow.mapSize.height=1024,T.shadow.camera.near=0,T.shadow.camera.far=10,T.shadow.bias=-3e-4,r.add(T);const L=new uA(16777215,3);if(r.add(L),new xI().load("/imgs/1.hdr",b=>{b.mapping=dA,r.background=b}),u=document.createElement("video"),u.muted=!0,u.playsInline=!0,u.autoplay=!0,gt.isSupported()){const b=new gt;b.attachMedia(u),b.on(gt.Events.MEDIA_ATTACHED,()=>{b.loadSource("https://test-streams.mux.dev/tos_ismc/main.m3u8")})}try{await u.play(),console.log("")}catch(b){console.warn("",b)}const S=new AA(u);s=await fA({scene:r,renderer:l,videoTexture:S,projCamPosition:[.034,3.5,-7.14],projCamParams:{fov:13.2,aspect:2.09,near:.01,far:100},orientationParams:{azimuthDeg:91,elevationDeg:-6,rollDeg:0},projBias:1e-4,isShowHelper:!1});const x=new SI;x.setDecoderPath("https://unpkg.com/three@0.180.0/examples/jsm/libs/draco/"),n.setDRACOLoader(x);const v=new ze;v.setTranscoderPath("https://unpkg.com/three@0.180.0/examples/jsm/libs/basis/"),v.detectSupport(l),n.setKTX2Loader(v),await n.loadAsync("model/cinemamovie_theater_interior.glb").then(b=>{const w=b.scene;w.position.set(69.41,.6,24.9),w.traverse(F=>{F.isMesh&&(F.castShadow=!0,F.receiveShadow=!0,s.addTargetMesh(F))}),r.add(w)}),await n.loadAsync("model/futuristic_city.glb").then(b=>{const w=b.scene;w.scale.set(.005,.005,.005),w.position.set(-140.9,-8.75,212.95),w.rotation.y=Math.PI/2,w.traverse(F=>{F.isMesh&&(F.castShadow=!0,F.receiveShadow=!0)}),r.add(w)}),i.value=!0;const B=new bn(-.13,2.5,2.33),R=()=>{const b=t.getposition().distanceTo(B);u.volume=Math.max(0,1-b/10)};m(),window.addEventListener("resize",m),l.setAnimationLoop(D);function D(){f?(t.update(),R()):h.update(),l.render(r,c),s&&s.update(),a?.update()}});const g=()=>{i.value=!1,u.muted=!1,l.render(r,c),f=!0,t.init({scene:r,camera:c,controls:h,playerModel:{url:"model/person.glb",scale:.005,idleAnim:"idle",walkAnim:"walk",runAnim:"run",jumpAnim:"jump",flyAnim:"flying",flyIdleAnim:"flyidle"},initPos:new bn(-.11310870589738897,2.614062115741385,1.2878521164121084),minCamDistance:50,maxCamDistance:300,thirdMouseMode:1})},m=()=>{c.aspect=window.innerWidth/window.innerHeight,c.updateProjectionMatrix(),l.setSize(window.innerWidth,window.innerHeight),l.setPixelRatio(window.devicePixelRatio),console.log("resize")};return gA(()=>{try{t.destroy?.(),l&&(l.setAnimationLoop(null),A&&(l.domElement&&l.domElement.parentElement===A&&A.removeChild(l.domElement),a?.dom&&a.dom.parentElement===A&&A.removeChild(a.dom)),l.dispose()),h?.dispose(),r.traverse(E=>{if(E){if(E.material)try{Array.isArray(E.material)?E.material.forEach(p=>p&&p.dispose&&p.dispose()):E.material.dispose()}catch{}if(E.geometry)try{E.geometry.dispose()}catch{}}});try{u.pause(),u.src=""}catch{}window.removeEventListener("resize",m),console.log("")}catch(E){console.error("",E)}}),(E,p)=>(Ea(),Ia(EA,null,[fe("div",{class:"container",id:"container",ref_key:"cont",ref:e},null,512),p[0]||(p[0]=mA('<div class="model-credit" data-v-11ccde4e> <a href="https://sketchfab.com/3d-models/cinemamovie-theater-interior-dcaf6cdebcad4f03879c24186da257ee" target="_blank" rel="noopener noreferrer" data-v-11ccde4e> Sketchfab </a> <a href="https://sketchfab.com/3d-models/futuristic-city-b4c3c957fad245d580e7a7d1a01c526b" target="_blank" rel="noopener noreferrer" data-v-11ccde4e> Sketchfab </a><br data-v-11ccde4e> <a href="https://github.com/hh-hang/three-player-controller" target="_blank" rel="noopener noreferrer" data-v-11ccde4e> three-player-controller </a></div><a class="source" href="https://github.com/hh-hang/three-video-projection/blob/main/example/src/cinema.vue" target="_blank" rel="noopener noreferrer" data-v-11ccde4e><img src="'+IA+'" alt="" data-v-11ccde4e></a>',2)),p[1]||(p[1]=fe("div",{class:"hud",role:"note","aria-label":""},[fe("div",{class:"row hint-group"},[fe("span",{class:"hint-text"},""),fe("kbd",null,"W"),fe("kbd",null,"A"),fe("kbd",null,"S"),fe("kbd",null,"D")]),fe("div",{class:"row hint-group"},[fe("span",{class:"hint-text"},""),fe("kbd",null,"Shift")]),fe("div",{class:"row hint-group"},[fe("span",{class:"hint-text"},""),fe("kbd",null,"Space")]),fe("div",{class:"row hint-group"},[fe("span",{class:"hint-text"},""),fe("kbd",null,"V")]),fe("div",{class:"row hint-group"},[fe("span",{class:"hint-text"},""),fe("kbd",null,"F")])],-1)),i.value?(Ea(),Ia("div",GI,[fe("button",{class:"play-button",onClick:g},"Start")])):pA("",!0)],64))}}),KI=yA(HI,[["__scopeId","data-v-11ccde4e"]]);CA(KI).mount("#app");
